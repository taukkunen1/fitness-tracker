<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Fitness Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-screen">
<div id="app"></div>

<script>
/*
  Atualiza√ß√£o (Nov/2025):
  - Persist√™ncia refor√ßada (IndexedDB store: users, comparisons, references) + fallback localStorage.
  - Seed de refer√™ncias cient√≠ficas 2020 ‚Üí nov/2025 (import manual via bot√£o).
  - Integra√ß√£o de refer√™ncias: notas/link direto nos cards de Treino e Nutri√ß√£o.
  - Evolu√ß√£o muscular: gr√°fico (Chart.js) com massa (kg) e tamanho (cm), redraw autom√°tico ao salvar m√©tricas.
  - Export CSV da evolu√ß√£o (fun√ß√£o pronta ‚Äî bot√£o pode ser adicionado facilmente).
  - Bot√µes de import/export/limpar refer√™ncias.
*/

const DB_NAME = 'fitness-tracker-db';
const DB_VERSION = 2; // store "references"
const STORE_USERS = 'users';
const STORE_COMPARISONS = 'comparisons';
const STORE_REFERENCES = 'references';

// ---------------- IndexedDB helpers ----------------
function openDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_USERS)) db.createObjectStore(STORE_USERS, { keyPath: 'id' });
            if (!db.objectStoreNames.contains(STORE_COMPARISONS)) db.createObjectStore(STORE_COMPARISONS, { keyPath: 'id' });
            if (!db.objectStoreNames.contains(STORE_REFERENCES)) db.createObjectStore(STORE_REFERENCES, { keyPath: 'id' });
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });
}

async function dbPut(storeName, value) {
    try {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const request = store.put(value);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    } catch (err) { console.error('DB put failed', err); }
}

async function dbGetAll(storeName) {
    try {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            const req = store.getAll();
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    } catch (err) { console.error('DB getAll failed', err); return []; }
}

async function dbDelete(storeName, key) {
    try {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const req = store.delete(key);
            req.onsuccess = () => resolve();
            req.onerror = () => reject(req.error);
        });
    } catch (err) { console.error('DB delete failed', err); }
}

// localStorage fallback
function saveDataLS(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); } catch (err) { console.warn('localStorage save failed', err); } }
function loadDataLS(key) { try { const data = localStorage.getItem(key); return data ? JSON.parse(data) : null; } catch (err) { return null; } }

// ---------------- In-memory state ----------------
let state = {
    activeTab: 'dashboard',
    activeUser: 'pedro',
    users: {},
    comparisons: [],
    references: []
};

// chart instance holder
let muscleChart = null;

// ---------------- Seed users ----------------
const initialUsers = (function(){
    const now = Date.now();
    return {
        pedro: {
            id: 'pedro',
            name: 'Pedro',
            gender: 'male',
            age: 30,
            height: 175,
            workoutHistory: [],
            mealHistory: [],
            bodyMetrics: [{
                id: 'm_pedro_' + now,
                date: new Date().toISOString().split('T')[0],
                weight: 70.65,
                bodyFat: 19.9,
                muscleMass: 28.9,
                visceralFat: 8,
                waterPercent: 55.0,
                waterWeight: parseFloat((70.65 * 0.55).toFixed(2)),
                bmr: Math.round(10 * 70.65 + 6.25 * 175 - 5 * 30 + 5),
                muscleSize: 40,
                bmi: 23.1
            }],
            goals: { weight: 75, bodyFat: 15, muscleMass: 32 }
        },
        valentina: {
            id: 'valentina',
            name: 'Valentina',
            gender: 'female',
            age: 28,
            height: 165,
            workoutHistory: [],
            mealHistory: [],
            bodyMetrics: [{
                id: 'm_valentina_' + (now + 1),
                date: new Date().toISOString().split('T')[0],
                weight: 58.0,
                bodyFat: 25.0,
                muscleMass: 21.0,
                visceralFat: 5,
                waterPercent: 50.0,
                waterWeight: parseFloat((58.0 * 0.5).toFixed(2)),
                bmr: Math.round(10 * 58.0 + 6.25 * 165 - 5 * 28 - 161),
                muscleSize: 36,
                bmi: 21.3
            }],
            goals: { weight: 60, bodyFat: 22, muscleMass: 23 }
        }
    };
})();

// ---------------- Pre-sele√ß√£o de estudos (2020 ‚Üí nov/2025) ----------------
// cada item tem id, authors, year, title, journal, link, tags, summary
const scientificStudiesSeed = [
    { id: 'ref_jhpn_2025', authors: 'Chen W.', year: 2025, title: 'Nutritional interventions in muscle hypertrophy research: a scientometric analysis (1992‚Äì2025)', journal: 'Journal of Health, Population and Nutrition', link: 'https://jhpn.biomedcentral.com/articles/10.1186/s41043-025-01031-w', tags: ['nutrition','hypertrophy','protein','creatine'], summary: 'Mapeamento das interven√ß√µes nutricionais; destaca prote√≠na e creatina.' },
    { id: 'ref_sportsmed_2025', authors: 'Saeterbakken AH et al.', year: 2025, title: 'Task Specificity of Dynamic Resistance Training...', journal: 'Sports Medicine', link: 'https://link.springer.com/article/10.1007/s40279-025-02225-2', tags: ['training','specificity','programming'], summary: 'Especificidade de treino e transfer√™ncia de for√ßa.' },
    { id: 'ref_frontiers_2025', authors: 'Curovic I.', year: 2025, title: 'The role of resistance exercise-induced local metabolic stress...', journal: 'Frontiers in Physiology', link: 'https://www.frontiersin.org/articles/10.3389/fphys.2025.1549609/full', tags: ['training','metabolic-stress','hypertrophy'], summary: 'T√©cnicas que aumentam estresse metab√≥lico (supersets, drops, BFR).' },
    { id: 'ref_nutrients_creatine_2024', authors: 'Wang Z. et al.', year: 2024, title: 'Effects of Creatine Supplementation and Resistance Training...', journal: 'Nutrients', link: 'https://www.mdpi.com/2072-6643/16/21/3665', tags: ['supplement','creatine','strength'], summary: 'Creatina melhora ganhos de for√ßa/hipertrofia.' },
    { id: 'ref_phillips_2022', authors: 'Phillips SM. et al.', year: 2022, title: 'Protein Requirements and Muscle Mass/Strength in Athletes', journal: 'Sports Medicine', link: 'https://doi.org/10.1007/s40279-022-01680-9', tags: ['nutrition','protein','requirements'], summary: 'Faixas recomendadas de prote√≠na (1.6‚Äì2.2 g/kg/d) e distribui√ß√£o.' },
    { id: 'ref_schoenfeld_2023', authors: 'Schoenfeld BJ., Krieger JW.', year: 2023, title: 'The Effect of Protein Timing on Muscle Strength and Hypertrophy', journal: 'JISSN', link: 'https://doi.org/10.1186/s12970-023-00496-7', tags: ['nutrition','protein','timing'], summary: 'Total di√°rio √© chave; timing tem benef√≠cios pr√°ticos.' },
    { id: 'ref_morton_2021', authors: 'Morton RW. et al.', year: 2021, title: 'Resistance Training Volume Enhances Muscle Hypertrophy but Not Strength', journal: 'Medicine & Science in Sports & Exercise', link: 'https://doi.org/10.1249/MSS.0000000000002585', tags: ['training','volume','hypertrophy'], summary: 'Volume semanal correlaciona com hipertrofia.' },
    { id: 'ref_bilsborough_2020', authors: 'Bilsborough SA., Crowe TC.', year: 2020, title: 'Low‚ÄëCarbohydrate Diets and Body Composition', journal: 'Nutrients', link: 'https://www.mdpi.com/2072-6643/12/10/3105', tags: ['nutrition','diet','low-carb'], summary: 'Discuss√£o sobre low-carb em atletas.' },
    { id: 'ref_hector_2020', authors: 'Hector AJ., Phillips SM.', year: 2020, title: 'Metabolic Adaptations to Exercise and Protein Intake', journal: 'Frontiers in Nutrition', link: 'https://doi.org/10.3389/fnut.2020.00019', tags: ['nutrition','metabolism','protein'], summary: 'Adapta√ß√µes metab√≥licas ao exerc√≠cio e prote√≠na.' },
    { id: 'ref_xie_2025', authors: 'Xie Y. et al.', year: 2025, title: 'Comparing exercise modalities during caloric restriction', journal: 'Systematic Review', link: 'https://pubmed.ncbi.nlm.nih.gov/39185113/', tags: ['training','diet','restriction'], summary: 'Combinar RT e aer√≥bico preserva massa magra em d√©ficit.' },
    { id: 'ref_maturitas_2025', authors: 'Various', year: 2025, title: 'RT effects on glycemic control & body composition in older adults with T2D', journal: 'Maturitas', link: 'https://www.maturitas.org/article/S0378-5122(25)00499-2/fulltext', tags: ['training','health','clinical'], summary: 'Benef√≠cios de RT em idosos com diabetes.' },
    { id: 'ref_strongerbyscience', authors: 'Stronger By Science', year: 2024, title: 'Muscle Growth: Master List', journal: 'StrongerByScience', link: 'https://www.strongerbyscience.com/master-list/muscle-growth/', tags: ['review','meta-analysis','hypertrophy'], summary: '√çndice com meta-an√°lises e revis√µes sobre hipertrofia.' },
    { id: 'ref_almeida_2024', authors: 'Almeida NC. et al.', year: 2024, title: 'An√°lise das estrat√©gias de nutri√ß√£o e suplementa√ß√£o na recomposi√ß√£o corporal', journal: 'Revista Fisioterapia em Movimento', link: 'https://revistaft.com.br/analise-das-estrategias-de-nutricao-e-suplmentacao-na-recomposicao-corporal-em-praticantes-de-musculacao/', tags: ['nutrition','supplement','pt'], summary: 'Revis√£o em PT sobre suplementa√ß√£o.' }
];

// ---------------- Marmitas (mantido) ----------------
const livUpMarmitas = [
    { name: 'Frango cremoso, arroz, feij√£o e br√≥colis no vapor', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '' },
    { name: 'Alm√¥ndega de frango, arroz 7 gr√£os', category: 'Baixa caloria at√© 350kcal', size: '300g', kcal: '340', prot: '28', fat: '9' },
    { name: 'Feijoada light', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '' },
    { name: 'Carne louca com pur√™ de mandioquinha', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '' },
    { name: 'Frango grelhado com legumes', category: 'Baixa caloria', size: '300g', kcal: '320', prot: '30', fat: '7' },
    { name: 'Salm√£o com quinoa e vegetais', category: 'Premium', size: '300g', kcal: '480', prot: '34', fat: '20' },
    { name: 'Bife de soja com arroz integral', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '' },
    { name: 'Picadinho de carne com batata doce', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '' },
    { name: 'Omelete de legumes com salada', category: 'Baixa caloria', size: '300g', kcal: '', prot: '', fat: '' },
    { name: 'Peito de peru com couscous marroquino', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '' },
    { name: 'Frango com lim√£o siciliano, arroz jasmim e br√≥colis', category: 'Dia a dia', size: '380g', kcal: '444', prot: '36', fat: '12' },
    { name: 'Saint peter com cebolinha, arroz jasmim e cenoura', category: 'Dia a dia', size: '380g', kcal: '426', prot: '25', fat: '14' },
    { name: 'Falafel, couscous e legumes mediterr√¢neos', category: 'Vegetariano', size: '', kcal: '', prot: '', fat: '' },
    { name: 'Lentilha pomodoro, arroz de jasmim e br√≥colis', category: 'Vegetariano', size: '', kcal: '', prot: '', fat: '' },
    { name: 'Estrogonofe de cogumelo, arroz integral', category: 'Vegetariano', size: '', kcal: '', prot: '', fat: '' },
    { name: 'Iscas de fil√© mignon acebolado', category: 'Premium', size: '', kcal: '', prot: '', fat: '' },
    { name: 'Posta de salm√£o assado', category: 'Premium', size: '', kcal: '', prot: '', fat: '' },
    { name: 'Bolinha low carb de ab√≥bora e carne com chia', category: 'Low Carb', size: '', kcal: '', prot: '', fat: '' },
    { name: 'Frango oriental, arroz com am√™ndoas e legumes', category: 'Performance', size: '580g', kcal: '', prot: '', fat: '' },
    { name: 'Carne mo√≠da, arroz e vegetais', category: 'Performance', size: '580g', kcal: '', prot: '', fat: '' }
];

// ---------------- Utility functions ----------------
function parseNumber(value) {
    if (!value && value !== 0) return 0;
    const n = parseFloat(String(value).replace(/[^\d.-]/g, ''));
    return isNaN(n) ? 0 : n;
}
function getMealNutritionByName(name) {
    const meal = livUpMarmitas.find(m => m.name === name);
    if (!meal) return { kcal: 0, prot: 0, fat: 0 };
    return { kcal: parseNumber(meal.kcal), prot: parseNumber(meal.prot), fat: parseNumber(meal.fat) };
}

// ---------------- Sync state <-> DB ----------------
async function saveAllToDB() {
    try {
        for (const id of Object.keys(state.users)) await dbPut(STORE_USERS, state.users[id]);
        for (const comp of state.comparisons) await dbPut(STORE_COMPARISONS, comp);
        for (const ref of state.references) await dbPut(STORE_REFERENCES, ref);
        saveDataLS('ft_users', state.users);
        saveDataLS('ft_comparisons', state.comparisons);
        saveDataLS('ft_references', state.references);
    } catch (err) {
        console.error('saveAllToDB error', err);
    }
}

async function loadAllFromDB() {
    let users = {};
    let comparisons = [];
    let references = [];
    try {
        const dbUsers = await dbGetAll(STORE_USERS);
        const dbComparisons = await dbGetAll(STORE_COMPARISONS);
        const dbReferences = await dbGetAll(STORE_REFERENCES);
        if (dbUsers && dbUsers.length) dbUsers.forEach(u => users[u.id] = u);
        if (dbComparisons && dbComparisons.length) comparisons = dbComparisons;
        if (dbReferences && dbReferences.length) references = dbReferences;
    } catch (err) {
        console.warn('DB load failed, fallback to localStorage', err);
    }

    // fallback localStorage
    if (Object.keys(users).length === 0) {
        const lsUsers = loadDataLS('ft_users');
        if (lsUsers) users = lsUsers;
    }
    if (!comparisons.length) {
        const lsComparisons = loadDataLS('ft_comparisons');
        if (lsComparisons) comparisons = lsComparisons;
    }
    if (!references.length) {
        const lsRefs = loadDataLS('ft_references');
        if (lsRefs) references = lsRefs;
    }

    // seed users only if none exist (do not overwrite existing data)
    if (Object.keys(users).length === 0) {
        users = initialUsers;
        comparisons = [];
        references = [];
        state.users = users;
        state.comparisons = comparisons;
        state.references = references;
        await saveAllToDB();
    } else {
        state.users = users;
        state.comparisons = comparisons;
        state.references = references;
    }
}

// ---------------- Training programs (same as before) ----------------
const workoutPrograms = {
    male: {
        'Treino A - Push (Empurrar)': {
            exercises: [
                { name: 'Supino Reto', sets: '4', reps: '6-8', rest: '120s', notes: 'For√ßa base' },
                { name: 'Supino Inclinado', sets: '3', reps: '8-12', rest: '90s', notes: 'Peito superior' },
                { name: 'Desenvolvimento', sets: '4', reps: '8-12', rest: '90s', notes: 'Ombros' },
                { name: 'Eleva√ß√£o Lateral', sets: '3', reps: '12-15', rest: '60s', notes: 'Deltoide lateral' },
                { name: 'Tr√≠ceps Testa', sets: '3', reps: '10-12', rest: '60s', notes: 'Massa' },
                { name: 'Tr√≠ceps Corda', sets: '3', reps: '12-15', rest: '60s', notes: 'Defini√ß√£o' }
            ],
            duration: '50-60 min',
            volume: '20 s√©ries'
        },
        'Treino B - Pull (Puxar)': {
            exercises: [
                { name: 'Barra Fixa', sets: '4', reps: '6-10', rest: '120s', notes: 'For√ßa' },
                { name: 'Remada Curvada', sets: '4', reps: '8-12', rest: '90s', notes: 'Espessura' },
                { name: 'Remada Sentado', sets: '3', reps: '10-12', rest: '75s', notes: 'Detalhes' },
                { name: 'Pullover', sets: '3', reps: '12-15', rest: '60s', notes: 'Amplitude' },
                { name: 'Rosca Direta', sets: '3', reps: '8-12', rest: '60s', notes: 'B√≠ceps' },
                { name: 'Rosca Martelo', sets: '3', reps: '10-12', rest: '60s', notes: 'Braquial' }
            ],
            duration: '50-60 min',
            volume: '20 s√©ries'
        },
        'Treino C - Legs (Pernas)': {
            exercises: [
                { name: 'Agachamento', sets: '4', reps: '6-10', rest: '150s', notes: 'Rei dos exerc√≠cios' },
                { name: 'Leg Press', sets: '3', reps: '10-15', rest: '90s', notes: 'Volume' },
                { name: 'Stiff', sets: '4', reps: '8-12', rest: '90s', notes: 'Posterior' },
                { name: 'Extensora', sets: '3', reps: '12-15', rest: '60s', notes: 'Isolamento quad' },
                { name: 'Flexora', sets: '3', reps: '12-15', rest: '60s', notes: 'Posterior isolado' },
                { name: 'Panturrilha', sets: '4', reps: '15-20', rest: '45s', notes: 'Resist√™ncia' }
            ],
            duration: '60-70 min',
            volume: '21 s√©ries'
        }
    },
    female: {
        'Treino A - Inferior Completo': {
            exercises: [
                { name: 'Agachamento', sets: '4', reps: '10-15', rest: '90s', notes: 'Base principal' },
                { name: 'Stiff', sets: '4', reps: '12-15', rest: '75s', notes: 'Posterior' },
                { name: 'Afundo B√∫lgaro', sets: '3', reps: '12-15/lado', rest: '60s', notes: 'Unilateral' },
                { name: 'Abdutora', sets: '4', reps: '15-20', rest: '60s', notes: 'Gl√∫teo m√©dio' },
                { name: 'Flexora', sets: '3', reps: '12-15', rest: '60s', notes: 'Posterior' },
                { name: 'Panturrilha', sets: '4', reps: '15-20', rest: '45s', notes: 'Resist√™ncia' }
            ],
            duration: '55-65 min',
            volume: '22 s√©ries'
        },
        'Treino B - Superior Completo': {
            exercises: [
                { name: 'Supino Reto', sets: '3', reps: '10-12', rest: '90s', notes: 'Peito' },
                { name: 'Remada Curvada', sets: '3', reps: '10-12', rest: '90s', notes: 'Costas' },
                { name: 'Desenvolvimento', sets: '3', reps: '10-12', rest: '75s', notes: 'Ombros' },
                { name: 'Puxada Frente', sets: '3', reps: '10-12', rest: '75s', notes: 'Dorsais' },
                { name: 'Rosca B√≠ceps', sets: '3', reps: '12-15', rest: '60s', notes: 'B√≠ceps' },
                { name: 'Tr√≠ceps Corda', sets: '3', reps: '12-15', rest: '60s', notes: 'Tr√≠ceps' }
            ],
            duration: '50-60 min',
            volume: '18 s√©ries'
        },
        'Treino C - Gl√∫teos √änfase': {
            exercises: [
                { name: 'Hip Thrust', sets: '4', reps: '12-15', rest: '90s', notes: 'Melhor p/ gl√∫teos' },
                { name: 'Leg Press (p√©s altos)', sets: '4', reps: '12-15', rest: '90s', notes: 'Gl√∫teos + quad' },
                { name: 'Extensora', sets: '3', reps: '15-20', rest: '60s', notes: 'Quadr√≠ceps' },
                { name: 'Abdutora', sets: '4', reps: '15-20', rest: '60s', notes: 'Gl√∫teo m√©dio' },
                { name: 'Gl√∫teo 4 Apoios', sets: '3', reps: '15-20/lado', rest: '45s', notes: 'Isolamento' },
                { name: 'Eleva√ß√£o P√©lvica', sets: '3', reps: '15-20', rest: '45s', notes: 'Finaliza√ß√£o' }
            ],
            duration: '50-60 min',
            volume: '21 s√©ries'
        }
    }
};

// ---------------- State helpers & handlers (kept) ----------------
function updateState(newState) { state = { ...state, ...newState }; saveAllToDB(); render(); }
function addOrUpdateUser(user) { state.users[user.id] = user; updateState({ users: state.users }); }
function removeUser(userId) { delete state.users[userId]; dbDelete(STORE_USERS, userId).catch(()=>{}); updateState({ users: state.users }); }
function addComparison(comp) { state.comparisons.push(comp); updateState({ comparisons: state.comparisons }); }

function handleTabChange(tab) { state.activeTab = tab; render(); }
function handleUserChange(userId) { state.activeUser = userId; render(); }

function handleLogWorkout(workoutName) {
    const newLog = { id: Date.now(), date: new Date().toISOString().split('T')[0], time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), workout: workoutName, completed: true };
    const user = state.users[state.activeUser];
    user.workoutHistory.unshift(newLog);
    addOrUpdateUser(user);
    alert('‚úÖ Treino registrado com sucesso! üí™');
}

function handleDeleteWorkout(id) {
    if (!confirm('Deseja realmente deletar este registro de treino?')) return;
    const user = state.users[state.activeUser];
    user.workoutHistory = user.workoutHistory.filter(log => log.id !== id);
    addOrUpdateUser(user);
    alert('‚ùå Treino deletado!');
}

function handleLogMeal(mealName) {
    const newLog = { id: Date.now(), date: new Date().toISOString().split('T')[0], time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), meal: mealName };
    const user = state.users[state.activeUser];
    user.mealHistory.unshift(newLog);
    addOrUpdateUser(user);
    alert('‚úÖ Refei√ß√£o registrada com sucesso! üç≤');
}
function handleDeleteMeal(id) {
    if (!confirm('Deseja realmente deletar este registro de refei√ß√£o?')) return;
    const user = state.users[state.activeUser];
    user.mealHistory = user.mealHistory.filter(m => m.id !== id);
    addOrUpdateUser(user);
    alert('‚ùå Refei√ß√£o deletada!');
}

// BMR (Mifflin-St Jeor)
function calculateBMR(weightKg, heightCm, age, gender) {
    const base = 10 * weightKg + 6.25 * heightCm - 5 * age;
    return Math.round(base + (gender === 'female' ? -161 : 5));
}

function handleAddMetrics(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const weight = parseFloat(formData.get('weight'));
    const heightCm = state.users[state.activeUser].height;
    const age = state.users[state.activeUser].age || 30;
    const gender = state.users[state.activeUser].gender || 'male';
    const waterPercent = parseFloat(formData.get('waterPercent')) || 0;
    const muscleSize = parseFloat(formData.get('muscleSize')) || 0;

    const bmr = calculateBMR(weight, heightCm, age, gender);
    const waterWeight = parseFloat((weight * (waterPercent / 100)).toFixed(2));

    const newMetric = {
        id: Date.now().toString(),
        date: formData.get('date'),
        weight: weight,
        bodyFat: parseFloat(formData.get('bodyFat')),
        muscleMass: parseFloat(formData.get('muscleMass')),
        visceralFat: parseInt(formData.get('visceralFat')),
        waterPercent: waterPercent,
        waterWeight: waterWeight,
        bmr: bmr,
        muscleSize: muscleSize,
        bmi: parseFloat((weight / Math.pow(heightCm / 100, 2)).toFixed(1))
    };

    const user = state.users[state.activeUser];
    user.bodyMetrics.push(newMetric);
    user.bodyMetrics.sort((a, b) => new Date(a.date) - new Date(b.date));
    addOrUpdateUser(user);

    // redraw chart if in evolu√ß√£o (small delay to ensure DOM)
    if (state.activeTab === 'evolucao') setTimeout(() => renderMuscleEvolutionChart(user.bodyMetrics, user.id), 150);

    e.target.reset();
    alert('üìä M√©tricas adicionadas!');
}

function handleDeleteMetric(metricId) {
    if (!confirm('Deseja realmente deletar esta medida?')) return;
    const user = state.users[state.activeUser];
    user.bodyMetrics = user.bodyMetrics.filter(m => m.id !== metricId);
    addOrUpdateUser(user);
    alert('‚ùå Medida deletada!');
}

function handleUpdatePartner(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const partnerId = 'valentina';
    const user = state.users[partnerId];
    if (!user) return;
    user.name = formData.get('name');
    user.age = parseInt(formData.get('age'));
    user.height = parseInt(formData.get('height'));
    addOrUpdateUser(user);
    alert('‚úÖ Dados da Valentina atualizados!');
}

function handleAddProfile() {
    const name = prompt('Nome do novo perfil: (ex: Jo√£o)');
    if (!name) return;
    const gender = prompt('G√™nero (male/female):', 'male') || 'male';
    const age = parseInt(prompt('Idade:', '25')) || 25;
    const height = parseInt(prompt('Altura em cm:', '170')) || 170;
    const idBase = name.trim().toLowerCase().replace(/\s+/g, '_');
    const id = `${idBase}_${Date.now()}`;
    const user = {
        id,
        name,
        gender: gender === 'female' ? 'female' : 'male',
        age,
        height,
        workoutHistory: [],
        mealHistory: [],
        bodyMetrics: [{
            id: 'm_' + Date.now(),
            date: new Date().toISOString().split('T')[0],
            weight: 0,
            bodyFat: 0,
            muscleMass: 0,
            visceralFat: 0,
            waterPercent: 0,
            waterWeight: 0,
            bmr: calculateBMR(0, height, age, gender),
            muscleSize: 0,
            bmi: 0
        }],
        goals: { weight: 0, bodyFat: 0, muscleMass: 0 }
    };
    addOrUpdateUser(user);
    alert('‚úÖ Perfil criado: ' + name);
}

function handleDeleteProfile(userId) {
    if (!confirm('Deseja realmente deletar o perfil e TODOS os registros deste usu√°rio? Esta a√ß√£o n√£o pode ser desfeita.')) return;
    removeUser(userId);
    const ids = Object.keys(state.users);
    if (ids.length) state.activeUser = ids[0];
    else { state.users = initialUsers; state.activeUser = 'pedro'; }
    saveAllToDB();
    alert('‚ùå Perfil deletado!');
    render();
}

function handleNewComparison() {
    const ids = Object.keys(state.users);
    if (ids.length < 2) { alert('Crie pelo menos 2 perfis para comparar.'); return; }
    const userOptions = ids.map((id, idx) => `${idx + 1}: ${state.users[id].name} (${id})`).join('\n');
    const selA = parseInt(prompt('Escolha o n√∫mero do primeiro usu√°rio:\n' + userOptions));
    const selB = parseInt(prompt('Escolha o n√∫mero do segundo usu√°rio:\n' + userOptions));
    if (!selA || !selB || selA === selB) { alert('Sele√ß√£o inv√°lida.'); return; }
    const idA = ids[selA - 1];
    const idB = ids[selB - 1];
    const title = prompt('T√≠tulo da compara√ß√£o (ex: "Semana 1 vs 2")', `Compara√ß√£o ${Date.now()}`) || `Compara√ß√£o ${Date.now()}`;
    const comp = { id: 'comp_' + Date.now(), title, userA: idA, userB: idB, createdAt: new Date().toISOString() };
    addComparison(comp);
    alert('‚úÖ Compara√ß√£o criada!');
    state.activeTab = 'comparacao';
    render();
}

function handleDeleteComparison(compId) {
    if (!confirm('Deseja realmente deletar esta compara√ß√£o?')) return;
    state.comparisons = state.comparisons.filter(c => c.id !== compId);
    dbDelete(STORE_COMPARISONS, compId).catch(()=>{});
    updateState({ comparisons: state.comparisons });
    alert('‚ùå Compara√ß√£o deletada!');
}

// ---------------- References operations ----------------
function importScientificStudiesSeed() {
    const idsExisting = new Set(state.references.map(r => r.id));
    let added = 0;
    scientificStudiesSeed.forEach(ref => {
        if (!idsExisting.has(ref.id)) {
            state.references.push(ref);
            added++;
        }
    });
    if (added > 0) {
        saveAllToDB();
        alert(`‚úÖ Importados ${added} estudos (2020 ‚Üí 2025-11).`);
    } else {
        alert('‚ÑπÔ∏è Estudos j√° importados anteriormente.');
    }
    render();
}

function clearReferences() {
    if (!confirm('Deseja remover todas as refer√™ncias cient√≠ficas salvas localmente?')) return;
    state.references = [];
    // cleanup DB
    dbGetAll(STORE_REFERENCES).then(list => {
        list.forEach(r => dbDelete(STORE_REFERENCES, r.id).catch(()=>{}));
    }).catch(()=>{});
    saveDataLS('ft_references', state.references);
    render();
}

function exportReferencesJSON() {
    const dataStr = JSON.stringify(state.references, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `studies_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// get references by tags
function getReferencesByTags(tags) {
    if (!tags || !tags.length) return [];
    const refs = state.references || [];
    return refs.filter(r => r.tags && r.tags.some(t => tags.includes(t)));
}

function getTopReferencesByTags(tags, limit = 3) {
    const matched = getReferencesByTags(tags);
    matched.sort((a,b) => (b.year||0) - (a.year||0));
    return matched.slice(0, limit);
}

function renderReferenceLinksHTML(refs) {
    if (!refs || !refs.length) return '';
    return `<div class="mt-2 text-sm text-slate-300">Refer√™ncias: ${refs.map(r => `<a href="${r.link}" target="_blank" class="text-blue-300 underline">${r.authors} ${r.year}</a>`).join(' ‚Ä¢ ')}</div>`;
}

function buildReferenceNotesForWorkout(workoutName) {
    const name = (workoutName||'').toLowerCase();
    const tags = ['training'];
    if (name.includes('hip') || name.includes('gl√∫teo') || name.includes('thrust')) tags.push('hypertrophy');
    if (name.includes('agach') || name.includes('leg')) tags.push('volume');
    if (name.includes('supino') || name.includes('press')) tags.push('strength');
    const refs = getTopReferencesByTags(tags);
    if (!refs.length) return '';
    return `Base cient√≠fica: ${refs.slice(0,3).map(r=>`${r.authors} ${r.year}`).join(' ‚Ä¢ ')}. ` + renderReferenceLinksHTML(refs);
}

function buildReferenceNotesForNutrition() {
    const refs = getTopReferencesByTags(['nutrition','protein','creatine','diet']);
    if (!refs.length) return '';
    return `Refer√™ncias: ${refs.slice(0,3).map(r=>`${r.authors} ${r.year}`).join(' ‚Ä¢ ')}. ` + renderReferenceLinksHTML(refs);
}

// ---------------- Export muscle evolution CSV ----------------
function exportMuscleEvolutionCSV(userId) {
    const user = state.users[userId];
    if (!user) return alert('Usu√°rio n√£o encontrado');
    const rows = [['date','weight','bodyFat','muscleMass','muscleSize','waterWeight','bmr']];
    (user.bodyMetrics || []).forEach(m => {
        rows.push([m.date, m.weight, m.bodyFat, m.muscleMass, m.muscleSize, m.waterWeight, m.bmr]);
    });
    const csv = rows.map(r => r.map(v => typeof v === 'string' && v.includes(',') ? `"${v}"` : v).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `${userId}_muscle_evolution_${new Date().toISOString().split('T')[0]}.csv`; a.click(); URL.revokeObjectURL(url);
}

// ---------------- Render ----------------
function render() {
    const app = document.getElementById('app');
    const currentUser = state.users[state.activeUser] || Object.values(state.users)[0];
    if (!currentUser) { app.innerHTML = '<div class="p-8 text-white">Carregando...</div>'; return; }

    const workoutHistory = currentUser.workoutHistory || [];
    const mealHistory = currentUser.mealHistory || [];
    const bodyMetrics = currentUser.bodyMetrics || [];
    const latestMetrics = bodyMetrics[bodyMetrics.length - 1] || { weight: 0, bodyFat: 0, muscleMass: 0, bmi: 0, bmr: 0, waterPercent: 0, waterWeight: 0, muscleSize: 0 };
    const workoutProgram = workoutPrograms[currentUser.gender] || {};
    const today = new Date().toISOString().split('T')[0];
    const todaysMeals = mealHistory.filter(m => m.date === today);
    const totals = todaysMeals.reduce((acc, log) => { const nut = getMealNutritionByName(log.meal); acc.kcal += nut.kcal; acc.prot += nut.prot; acc.fat += nut.fat; return acc; }, { kcal: 0, prot: 0, fat: 0 });

    app.innerHTML = `
        <!-- Header -->
        <header class="bg-black/40 backdrop-blur-lg border-b border-purple-500/30 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                            üí™ Fitness Tracker Pro
                        </h1>
                        <p class="text-purple-300 text-sm mt-1">Baseado em evid√™ncias cient√≠ficas 2020‚Äì2025</p>
                    </div>
                    <div class="flex gap-2 items-center">
                        ${Object.keys(state.users).map(id => `
                            <div class="flex items-center gap-2">
                                <button onclick="handleUserChange('${id}')" class="px-4 py-2 rounded-lg font-semibold transition-all ${state.activeUser===id? (state.users[id].gender==='female' ? 'bg-pink-500 text-white' : 'bg-blue-500 text-white') : 'bg-slate-700 text-slate-300'}">
                                    ${state.users[id].gender==='female' ? 'üë©' : 'üë®'} ${state.users[id].name}
                                </button>
                                <button title="Deletar perfil" onclick="handleDeleteProfile('${id}')" class="text-red-400 hover:text-red-300 px-2">‚ùå</button>
                            </div>
                        `).join('')}
                        <button onclick="handleAddProfile()" class="px-4 py-2 rounded-lg font-semibold bg-green-600 hover:bg-green-500">‚ûï Novo Perfil</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex flex-wrap gap-3">
                ${['dashboard','treino','nutricao','alimentacao','evolucao','comparacao','ciencia'].map(tab => `
                    <button onclick="handleTabChange('${tab}')" class="px-6 py-3 rounded-xl font-semibold transition-all ${state.activeTab===tab ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'bg-slate-800/50 text-slate-300'}">
                        ${tab==='dashboard'?'üìä':tab==='treino'?'üèãÔ∏è':tab==='nutricao'?'üçé':tab==='alimentacao'?'üç≤':tab==='evolucao'?'üìà':tab==='comparacao'?'‚öñÔ∏è':'üî¨'} ${tab.charAt(0).toUpperCase()+tab.slice(1)}
                    </button>
                `).join('')}
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 pb-12">
            ${state.activeTab === 'dashboard' ? renderDashboard(currentUser, workoutHistory, latestMetrics) : ''}
            ${state.activeTab === 'treino' ? renderTreino(workoutProgram, currentUser) : ''}
            ${state.activeTab === 'nutricao' ? renderNutricao(currentUser) : ''}
            ${state.activeTab === 'alimentacao' ? renderAlimentacao(mealHistory, currentUser, totals) : ''}
            ${state.activeTab === 'evolucao' ? renderEvolucao(bodyMetrics, currentUser) : ''}
            ${state.activeTab === 'comparacao' ? renderComparacao() : ''}
            ${state.activeTab === 'ciencia' ? renderCiencia() : ''}
        </main>

        <!-- Footer -->
        <footer class="bg-black/60 backdrop-blur-lg border-t border-purple-500/30 py-8 mt-12">
            <div class="max-w-7xl mx-auto px-4 text-center">
                <p class="text-slate-400">Desenvolvido com base em evid√™ncias cient√≠ficas recentes (2020-2025)</p>
            </div>
        </footer>
    `;

    // attach chart if on evolu√ß√£o
    if (state.activeTab === 'evolucao') {
        renderMuscleEvolutionChart(bodyMetrics, currentUser.id);
    }

    const metricsForm = document.getElementById('metricsForm');
    if (metricsForm) metricsForm.addEventListener('submit', handleAddMetrics);
    const partnerForm = document.getElementById('partnerForm');
    if (partnerForm) partnerForm.addEventListener('submit', handleUpdatePartner);
}

// ---------------- Render components (Evolu√ß√£o chart already included) ----------------
function renderDashboard(currentUser, workoutHistory, latestMetrics) {
    const nutritionNotes = buildReferenceNotesForNutrition();
    return `
        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <div class="md:col-span-2 bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl p-6 text-white shadow-xl">
                    <p class="text-blue-200 text-sm mb-2">PESO ATUAL</p>
                    <p class="text-4xl font-bold">${latestMetrics.weight} kg</p>
                    <p class="text-blue-200 text-xs mt-2">Meta: ${currentUser.goals.weight}kg</p>
                </div>
                <div class="bg-gradient-to-br from-red-600 to-red-800 rounded-2xl p-6 text-white shadow-xl">
                    <p class="text-red-200 text-sm mb-2">GORDURA</p>
                    <p class="text-4xl font-bold">${latestMetrics.bodyFat}%</p>
                </div>
                <div class="bg-gradient-to-br from-green-600 to-green-800 rounded-2xl p-6 text-white shadow-xl">
                    <p class="text-green-200 text-sm mb-2">MASSA MUSCULAR</p>
                    <p class="text-4xl font-bold">${latestMetrics.muscleMass} kg</p>
                </div>
                <div class="bg-gradient-to-br from-yellow-600 to-amber-700 rounded-2xl p-6 text-white shadow-xl">
                    <p class="text-yellow-200 text-sm mb-2">METABOLISMO BASAL</p>
                    <p class="text-2xl font-bold">${latestMetrics.bmr || '-' } kcal</p>
                </div>
                <div class="bg-gradient-to-br from-cyan-600 to-sky-700 rounded-2xl p-6 text-white shadow-xl">
                    <p class="text-cyan-200 text-sm mb-2">√ÅGUA CORPORAL</p>
                    <p class="text-2xl font-bold">${latestMetrics.waterWeight || 0} kg (${latestMetrics.waterPercent || 0}%)</p>
                </div>
            </div>

            <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700">
                <h3 class="text-2xl font-bold mb-3">Notas cient√≠ficas</h3>
                <p class="text-slate-300 text-sm">${nutritionNotes || 'Sem refer√™ncias de nutri√ß√£o importadas.'}</p>
            </div>
        </div>
    `;
}

function renderTreino(workoutProgram, currentUser) {
    return `
        <div class="space-y-6">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-6 text-white shadow-2xl">
                <h2 class="text-3xl font-bold mb-2">üèãÔ∏è Programa ${currentUser.gender === 'male' ? 'ABC Masculino' : 'ABC Feminino'}</h2>
                <p class="text-purple-200">${currentUser.gender === 'male' ? 'Foco em for√ßa e hipertrofia - 3x/semana' : 'Maior volume inferior - 3x/semana'}</p>
            </div>

            ${Object.entries(workoutProgram).map(([name, workout]) => `
                <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold">${name}</h3>
                            <p class="text-slate-300 text-sm mt-1">${workout.duration} ‚Ä¢ ${workout.volume}</p>
                            <div class="text-slate-400 text-sm mt-2">${buildReferenceNotesForWorkout(name)}</div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="handleLogWorkout('${name.replace(/'/g, "\\'")}')" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-bold">Registrar</button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderNutricao(currentUser) {
    const notes = buildReferenceNotesForNutrition();
    const nutrition = currentUser.gender === 'male' ? { target: 2000, protein: '140-160g', carbs: '220-250g', fats: '55-65g', surplus: 400 } : { target: 1700, protein: '95-105g', carbs: '180-200g', fats: '50-60g', surplus: 300 };
    return `
        <div class="space-y-6">
            <div class="bg-gradient-to-r from-green-600 to-emerald-600 rounded-2xl p-6 text-white shadow-2xl">
                <h2 class="text-3xl font-bold mb-4">üçé Plano Nutricional Personalizado</h2>
                <p class="text-slate-300 text-sm mb-2">${notes || 'Sem refer√™ncias de nutri√ß√£o importadas.'}</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white/20 rounded-xl p-4"> <p class="text-green-200 text-sm">Meta Cal√≥rica</p><p class="text-3xl font-bold">${nutrition.target}</p></div>
                    <div class="bg-white/20 rounded-xl p-4"> <p class="text-green-200 text-sm">Prote√≠na</p><p class="text-2xl font-bold">${nutrition.protein}</p></div>
                    <div class="bg-white/20 rounded-xl p-4"> <p class="text-green-200 text-sm">Super√°vit</p><p class="text-3xl font-bold">+${nutrition.surplus}</p></div>
                </div>
            </div>
        </div>
    `;
}

function renderAlimentacao(mealHistory, currentUser, totals) {
    return `
        <div class="space-y-6">
            <div class="bg-gradient-to-r from-orange-600 to-yellow-600 rounded-2xl p-6 text-white shadow-2xl">
                <div class="flex justify-between items-center">
                    <div><h2 class="text-3xl font-bold mb-2">üç≤ Alimenta√ß√£o - Liv Up</h2><p class="text-orange-200">Registre suas marmitas consumidas do dia</p></div>
                    <div class="text-right"><p class="text-orange-100 text-sm">Totais hoje</p><p class="font-bold text-xl">${totals.kcal} kcal ‚Ä¢ ${totals.prot} g prote√≠na</p></div>
                </div>
            </div>

            <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700">
                <h3 class="text-2xl font-bold mb-4">üìã Marmitas Dispon√≠veis</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${livUpMarmitas.map(meal => `
                        <div class="bg-slate-700/50 p-4 rounded-xl flex justify-between items-center">
                            <div><p class="text-white font-semibold">${meal.name}</p><p class="text-slate-400 text-sm">${meal.category}${meal.kcal ? ' - '+meal.kcal+' kcal' : ''}</p></div>
                            <button onclick="handleLogMeal('${meal.name.replace(/'/g, "\\'")}')" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-bold">Registrar</button>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700">
                <h3 class="text-2xl font-bold mb-4">üìÖ Hist√≥rico de Refei√ß√µes</h3>
                ${mealHistory.length === 0 ? `<p class="text-slate-400">Nenhuma refei√ß√£o registrada.</p>` : `
                    <div class="space-y-3">
                        ${mealHistory.slice(0, 50).map(log => {
                            const nut = getMealNutritionByName(log.meal);
                            return `
                                <div class="bg-slate-700/50 p-4 rounded-xl border-l-4 border-orange-500 flex justify-between items-center">
                                    <div>
                                        <p class="text-white font-semibold">${log.meal}</p>
                                        <p class="text-slate-400 text-sm">${log.date} - ${log.time} ‚Ä¢ ${nut.kcal} kcal ‚Ä¢ ${nut.prot} g prot</p>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <button onclick="handleDeleteMeal(${log.id})" class="text-red-400 hover:text-red-300">‚ùå</button>
                                        <span class="bg-green-500/20 text-green-400 px-3 py-1 rounded-full text-sm">‚úÖ</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}
            </div>
        </div>
    `;
}

function renderEvolucao(bodyMetrics, currentUser) {
    return `
        <div class="space-y-6">
            <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700">
                <h2 class="text-2xl font-bold text-white mb-4">üìà Adicionar Novas Medidas</h2>
                <form id="metricsForm" class="grid grid-cols-2 md:grid-cols-8 gap-3">
                    <input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}" class="px-3 py-2 bg-slate-700 rounded-xl text-white" />
                    <input type="number" name="weight" step="0.1" placeholder="Peso (kg)" required class="px-3 py-2 bg-slate-700 rounded-xl text-white" />
                    <input type="number" name="bodyFat" step="0.1" placeholder="Gordura (%)" required class="px-3 py-2 bg-slate-700 rounded-xl text-white" />
                    <input type="number" name="muscleMass" step="0.1" placeholder="Massa muscular (kg)" required class="px-3 py-2 bg-slate-700 rounded-xl text-white" />
                    <input type="number" name="visceralFat" placeholder="G.Visceral" required class="px-3 py-2 bg-slate-700 rounded-xl text-white" />
                    <input type="number" name="waterPercent" step="0.1" placeholder="√Ågua (%)" class="px-3 py-2 bg-slate-700 rounded-xl text-white" />
                    <input type="number" name="muscleSize" step="0.1" placeholder="Tamanho m√∫sculo (cm)" class="px-3 py-2 bg-slate-700 rounded-xl text-white" />
                    <button type="submit" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-xl font-bold">‚ûï Adicionar</button>
                </form>
            </div>

            <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700">
                <h3 class="text-xl font-bold text-white mb-4">üìä Hist√≥rico de Medidas & Evolu√ß√£o Muscular</h3>
                <div class="mb-4 flex gap-2 items-center">
                    <canvas id="muscleChart" height="150"></canvas>
                    <div>
                        <button onclick="exportMuscleEvolutionCSV(state.activeUser)" class="bg-blue-600 px-3 py-2 rounded-lg font-bold">Exportar evolu√ß√£o (CSV)</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead><tr class="border-b border-slate-700"><th>Data</th><th>Peso</th><th>Gordura</th><th>Massa</th><th>IMC</th><th>√Ågua</th><th>BMR</th><th>Tamanho</th><th>A√ß√µes</th></tr></thead>
                        <tbody>
                            ${bodyMetrics.slice().reverse().map(m => `
                                <tr class="border-b border-slate-700/50">
                                    <td class="py-2 px-3">${m.date}</td>
                                    <td class="py-2 px-3 text-center">${m.weight}kg</td>
                                    <td class="py-2 px-3 text-center">${m.bodyFat}%</td>
                                    <td class="py-2 px-3 text-center">${m.muscleMass}kg</td>
                                    <td class="py-2 px-3 text-center">${m.bmi}</td>
                                    <td class="py-2 px-3 text-center">${m.waterWeight || 0}kg / ${m.waterPercent || 0}%</td>
                                    <td class="py-2 px-3 text-center">${m.bmr || '-'} kcal</td>
                                    <td class="py-2 px-3 text-center">${m.muscleSize || '-'} cm</td>
                                    <td class="py-2 px-3 text-center"><button onclick="handleDeleteMetric('${m.id}')" class="text-red-400">‚ùå</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function renderComparacao() {
    const comps = state.comparisons || [];
    return `
        <div class="space-y-6">
            <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 rounded-2xl p-6 text-white">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-bold">‚öñÔ∏è Compara√ß√£o</h2>
                    <button onclick="handleNewComparison()" class="bg-green-600 px-4 py-2 rounded-lg">‚ûï Nova Compara√ß√£o</button>
                </div>
            </div>
            <div class="grid gap-4">
                ${comps.length===0?'<p class="text-slate-400">Nenhuma compara√ß√£o.</p>':comps.map(c=>`
                    <div class="bg-slate-800/50 p-4 rounded-xl border">
                        <div class="flex justify-between">
                            <div>
                                <p class="font-bold text-white">${c.title}</p>
                                <p class="text-slate-400 text-sm">Criado ${new Date(c.createdAt).toLocaleString()}</p>
                            </div>
                            <button onclick="handleDeleteComparison('${c.id}')" class="text-red-400">‚ùå</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function renderCiencia() {
    const refs = state.references || [];
    const filtered = refs.filter(r => r.year >= 2020 && r.year <= 2025);
    return `
        <div class="space-y-6">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-6 text-white">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold">üî¨ Estudos Cient√≠ficos (2020 ‚Äî nov/2025)</h2>
                        <p class="text-slate-300">Importe estudos e veja sugest√µes integradas a treino e nutri√ß√£o.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="importScientificStudiesSeed()" class="bg-green-600 px-4 py-2 rounded-lg">‚§ì Importar estudos</button>
                        <button onclick="exportReferencesJSON()" class="bg-blue-600 px-4 py-2 rounded-lg">‚¨áÔ∏è Exportar</button>
                        <button onclick="clearReferences()" class="bg-red-600 px-4 py-2 rounded-lg">üóëÔ∏è Limpar</button>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800/50 p-6 rounded-2xl border">
                <h3 class="text-2xl font-bold mb-4">üìö Refer√™ncias (${filtered.length})</h3>
                ${filtered.length===0 ? '<p class="text-slate-400">Nenhuma refer√™ncia. Use importar.</p>' : filtered.map(ref => `
                    <div class="bg-slate-700/50 p-4 rounded-xl mb-3 border-l-4 border-purple-500">
                        <p class="font-bold text-white">${ref.title}</p>
                        <p class="text-slate-300 text-sm">${ref.authors} ‚Äî ${ref.year} ‚Ä¢ ${ref.journal}</p>
                        <p class="text-slate-400 text-sm mt-2">${ref.summary}</p>
                        <p class="mt-2"><a href="${ref.link}" target="_blank" class="text-blue-300 underline">Abrir</a></p>
                        <div class="mt-2 flex gap-2">
                            <button onclick="navigator.clipboard.writeText('${ref.link}').then(()=>alert('Link copiado'))" class="bg-white text-black px-3 py-1 rounded-lg font-semibold">Copiar link</button>
                            <button onclick="if(confirm('Remover esta refer√™ncia?')) { state.references = state.references.filter(r => r.id !== '${ref.id}'); saveAllToDB(); render(); }" class="text-red-400 hover:text-red-300">‚ùå Remover</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

// ---------------- Muscle evolution chart ----------------
function renderMuscleEvolutionChart(bodyMetrics, userId) {
    const canvas = document.getElementById('muscleChart');
    if (!canvas) return;
    const metrics = (bodyMetrics || []).slice().sort((a,b)=> new Date(a.date) - new Date(b.date));
    const labels = metrics.map(m => m.date);
    const muscleMassData = metrics.map(m => m.muscleMass || null);
    const muscleSizeData = metrics.map(m => m.muscleSize || null);

    const datasets = [];
    if (muscleMassData.some(v => v !== null)) datasets.push({ label: 'Massa Muscular (kg)', data: muscleMassData, borderColor: '#34D399', backgroundColor: '#34D39933', tension: 0.2, yAxisID: 'y' });
    if (muscleSizeData.some(v => v !== null)) datasets.push({ label: 'Tamanho M√∫sculo (cm)', data: muscleSizeData, borderColor: '#60A5FA', backgroundColor: '#60A5FA33', tension: 0.2, yAxisID: 'y2' });

    const config = {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: {
                y: { beginAtZero: false, title: { display: true, text: 'kg' } },
                y2: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'cm' } }
            }
        }
    };

    if (muscleChart) { muscleChart.destroy(); muscleChart = null; }
    muscleChart = new Chart(canvas, config);
}

// ---------------- Safety and init ----------------
window.addEventListener('beforeunload', () => { try { saveAllToDB(); } catch (e) {} });

(async function initApp() {
    await loadAllFromDB();
    if (!state.users.pedro) state.users.pedro = initialUsers.pedro;
    if (!state.users.valentina) state.users.valentina = initialUsers.valentina;
    await saveAllToDB();
    render();
})();
</script>
</body>
</html>

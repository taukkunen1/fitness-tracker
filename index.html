<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fitness Tracker Pro â€” Full (verbose)</title>
  
  <!-- ===== SECURITY HEADERS 2025 ===== -->
  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'none';">
  
  <!-- X-Frame-Options: Prevent clickjacking -->
  <meta http-equiv="X-Frame-Options" content="DENY">
  
  <!-- X-Content-Type-Options: Prevent MIME type sniffing -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  
  <!-- Referrer Policy: Control referer information -->
  <meta name="referrer" content="no-referrer">
  
  <!-- Permissions Policy: Restrict browser features -->
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=(), payment=()">
  
  <!-- ===== PROTEÃ‡Ã•ES DE CÃ“DIGO - 2025 ===== -->
  <!-- Desabilitar clique direito -->
  <script>
    document.addEventListener('contextmenu', e => e.preventDefault());
  </script>
  
  <!-- Desabilitar atalhos de teclado para DevTools -->
  <script>
    document.addEventListener('keydown', function(e) {
      // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U, Ctrl+S
      if (e.keyCode === 123 || 
          (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) ||
          (e.ctrlKey && e.keyCode === 85) ||
          (e.ctrlKey && e.keyCode === 83)) {
        e.preventDefault();
        return false;
      }
    });
  </script>
  
  <!-- ProteÃ§Ã£o contra seleÃ§Ã£o de texto e cÃ³pia -->
  <style>
    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    
    /* Permitir seleÃ§Ã£o apenas em inputs/textareas para funcionalidade */
    input, textarea, [contenteditable="true"] {
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      user-select: text !important;
    }
  </style>
  
  <!-- Detectar abertura de DevTools -->
  <script>
    (function() {
      var devtools = {isOpen: false, orientation: null};
      var threshold = 160;
      var emitEvent = function(isOpen, orientation) {
        window.dispatchEvent(new CustomEvent('devtoolschange', {
          detail: {isOpen: isOpen, orientation: orientation}
        }));
      };
      
      setInterval(function() {
        var widthThreshold = window.outerWidth - window.innerWidth > threshold;
        var heightThreshold = window.outerHeight - window.innerHeight > threshold;
        var orientation = widthThreshold ? 'vertical' : 'horizontal';
        
        if (!(heightThreshold && widthThreshold) &&
            ((window.Firebug && window.Firebug.chrome && window.Firebug.chrome.isInitialized) || 
             widthThreshold || heightThreshold)) {
          if (!devtools.isOpen || devtools.orientation !== orientation) {
            emitEvent(true, orientation);
            console.clear();
          }
          devtools.isOpen = true;
          devtools.orientation = orientation;
        } else {
          if (devtools.isOpen) {
            emitEvent(false, null);
          }
          devtools.isOpen = false;
          devtools.orientation = null;
        }
      }, 500);
      
      window.addEventListener('devtoolschange', function(e) {
        if (e.detail.isOpen) {
          console.clear();
          document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;font-size:2rem;color:red;">Acesso nÃ£o autorizado detectado</div>';
        }
      });
    })();
  </script>
  
  <!-- Copyright e aviso de proteÃ§Ã£o -->
  <meta name="copyright" content="Â© 2025 Fitness Tracker Pro. Todos os direitos reservados." />
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* Pequeno ajuste para tabelas e canvas em mobile */
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 6px 8px; }
    
    /* Notification animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(20px); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    
    .animate-fade-out {
      animation: fadeOut 0.3s ease-in;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-screen" oncopy="return false" oncut="return false" onpaste="return false">
  <!--
    Fitness Tracker Pro - VersÃ£o completa e verbosa (2025-11)
    Objetivos desta versÃ£o:
    - Restaurar/Manter todas as informaÃ§Ãµes antigas (marmitas, templates, treinos, etc.)
    - Nunca excluir dados permanentemente sem confirmaÃ§Ã£o explÃ­cita do usuÃ¡rio;
      operaÃ§Ãµes de "exclusÃ£o" movem o item para um store 'archive' ou marcam como 'deleted' (soft delete).
    - Banco de dados robusto local: IndexedDB com stores: users, comparisons, references, archive, settings
    - Fallback para localStorage e migraÃ§Ã£o automatizada de chaves legadas (ft_users, ft_references, ft_custom_programs, etc.)
    - Templates detalhados de treino (Full-body, PPL, Upper/Lower/Full) com exercÃ­cios, sets, reps, tempo e notas.
    - GrÃ¡fico de evoluÃ§Ã£o muscular com massa (kg) e tamanho (cm) e opÃ§Ã£o de export CSV.
    - Import/Export de backups JSON e funÃ§Ãµes para sincronizaÃ§Ã£o remota futura (placeholder).
    - ComentÃ¡rios abundantes para transparÃªncia e fÃ¡cil ediÃ§Ã£o.
  -->

  <div id="app"></div>

<script>
/* ======================================================================
   CONFIGURAÃ‡Ã•ES GLOBAIS E DESCRIÃ‡ÃƒO DO DB
   ======================================================================

   - IndexedDB: 'fitness-tracker-db' versÃ£o 3 (versÃ£o incrementada para garantir migraÃ§Ã£o se necessÃ¡rio)
     Object stores:
       * users         - keyPath: id
       * comparisons   - keyPath: id
       * references    - keyPath: id
       * archive       - keyPath: id  (para guardar itens removidos, histÃ³rico, backups rÃ¡pidos)
       * settings      - keyPath: key (para armazenar flags, lastSync, etc.)

   - Fallback localStorage keys:
       ft_users, ft_comparisons, ft_references, ft_custom_programs, ft_settings

   - PolÃ­tica de exclusÃ£o: por padrÃ£o, NÃƒO remover do arquivo nem do DB. Ao "deletar" itens,
     movemos para STORE 'archive' e marcamos um campo deletedAt + deletedBy (soft-delete).
     Apenas com confirmaÃ§Ã£o explÃ­cita do usuÃ¡rio e seleÃ§Ã£o de "Excluir permanentemente (archive->delete)"
     removeremos de archive.

   - MigraÃ§Ã£o: se encontrar dados legados em localStorage, vamos migrar cuidadosamente para IndexedDB
     (sem sobrescrever dados existentes) e manter as chaves legadas como backup.

   ====================================================================== */

const DB_NAME = 'fitness-tracker-db';
const DB_VERSION = 5; // bumped for admin features (tasks, suggestions)
const STORE_USERS = 'users';
const STORE_COMPARISONS = 'comparisons';
const STORE_REFERENCES = 'references';
const STORE_ARCHIVE = 'archive';
const STORE_SETTINGS = 'settings';
const STORE_ACCOUNTS = 'accounts'; // New store for authentication
const STORE_TASKS = 'tasks'; // Admin task management
const STORE_SUGGESTIONS = 'suggestions'; // User suggestions and feedback

// ----------------------------- IndexedDB helpers -----------------------------
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_USERS)) db.createObjectStore(STORE_USERS, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_COMPARISONS)) db.createObjectStore(STORE_COMPARISONS, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_REFERENCES)) db.createObjectStore(STORE_REFERENCES, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_ARCHIVE)) db.createObjectStore(STORE_ARCHIVE, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_SETTINGS)) db.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
      if (!db.objectStoreNames.contains(STORE_ACCOUNTS)) {
        const accountStore = db.createObjectStore(STORE_ACCOUNTS, { keyPath: 'username' });
        accountStore.createIndex('email', 'email', { unique: true });
      }
      if (!db.objectStoreNames.contains(STORE_TASKS)) {
        db.createObjectStore(STORE_TASKS, { keyPath: 'id' });
      }
      if (!db.objectStoreNames.contains(STORE_SUGGESTIONS)) {
        db.createObjectStore(STORE_SUGGESTIONS, { keyPath: 'id' });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function dbPut(storeName, value) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      const store = tx.objectStore(storeName);
      const request = store.put(value);
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  } catch (err) {
    console.error('DB put failed', err);
    throw err;
  }
}

async function dbGetAll(storeName) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const store = tx.objectStore(storeName);
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  } catch (err) {
    console.error('DB getAll failed', err);
    return [];
  }
}

async function dbGet(storeName, key) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const store = tx.objectStore(storeName);
      const req = store.get(key);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  } catch (err) {
    console.error('DB get failed', err);
    return null;
  }
}

async function dbDelete(storeName, key) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      const store = tx.objectStore(storeName);
      const req = store.delete(key);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  } catch (err) {
    console.error('DB delete failed', err);
    throw err;
  }
}

// ----------------------------- localStorage fallback -----------------------------
function saveLS(key, data) {
  try { localStorage.setItem(key, JSON.stringify(data)); } catch (err) { console.warn('localStorage save failed', err); }
}
function loadLS(key) {
  try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : null; } catch (err) { return null; }
}

// ============================= AUTHENTICATION & SECURITY SYSTEM (2025) =============================
/* 
  Sistema de autenticaÃ§Ã£o e seguranÃ§a implementado para proteÃ§Ã£o contra ataques modernos:
  - Login e registro seguros
  - Hash de senha com PBKDF2 (Web Crypto API)
  - ProteÃ§Ã£o contra brute force
  - Rate limiting
  - CSRF token protection
  - XSS protection com sanitizaÃ§Ã£o
  - Session management segura
  - Auditoria de eventos de seguranÃ§a
*/

// Security configuration
const SECURITY_CONFIG = {
  PASSWORD_MIN_LENGTH: 8,
  PASSWORD_REQUIRE_UPPERCASE: true,
  PASSWORD_REQUIRE_LOWERCASE: true,
  PASSWORD_REQUIRE_NUMBER: true,
  PASSWORD_REQUIRE_SPECIAL: true,
  MAX_LOGIN_ATTEMPTS: 5,
  LOCKOUT_DURATION_MS: 15 * 60 * 1000, // 15 minutes
  SESSION_TIMEOUT_MS: 24 * 60 * 60 * 1000, // 24 hours
  PBKDF2_ITERATIONS: 100000,
  RATE_LIMIT_WINDOW_MS: 60 * 1000, // 1 minute
  MAX_REQUESTS_PER_WINDOW: 10
};

// Authentication state
let authState = {
  isAuthenticated: false,
  currentAccount: null,
  sessionToken: null,
  csrfToken: null,
  loginAttempts: {},
  rateLimitTracking: {}
};

// ----------------------------- Crypto utilities -----------------------------
async function hashPassword(password, salt) {
  const encoder = new TextEncoder();
  // Encode password and salt separately for better security
  const passwordBuffer = encoder.encode(password);
  const saltBuffer = encoder.encode(salt);
  
  // Combine password and salt buffers
  const combined = new Uint8Array(passwordBuffer.length + saltBuffer.length);
  combined.set(passwordBuffer, 0);
  combined.set(saltBuffer, passwordBuffer.length);
  
  const key = await crypto.subtle.importKey(
    'raw',
    combined,
    { name: 'PBKDF2' },
    false,
    ['deriveBits']
  );
  const derivedBits = await crypto.subtle.deriveBits(
    {
      name: 'PBKDF2',
      salt: encoder.encode(salt),
      iterations: SECURITY_CONFIG.PBKDF2_ITERATIONS,
      hash: 'SHA-256'
    },
    key,
    256
  );
  return Array.from(new Uint8Array(derivedBits))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('');
}

function generateSalt() {
  const array = new Uint8Array(16);
  crypto.getRandomValues(array);
  return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
}

function generateToken() {
  const array = new Uint8Array(32);
  crypto.getRandomValues(array);
  return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
}

// ----------------------------- Password validation -----------------------------
function validatePassword(password) {
  const errors = [];
  
  // Check minimum length
  if (password.length < SECURITY_CONFIG.PASSWORD_MIN_LENGTH) {
    errors.push(`Senha deve ter pelo menos ${SECURITY_CONFIG.PASSWORD_MIN_LENGTH} caracteres`);
  }
  
  // Check maximum length to prevent DoS attacks
  if (password.length > 128) {
    errors.push('Senha muito longa (mÃ¡ximo 128 caracteres)');
  }
  
  if (SECURITY_CONFIG.PASSWORD_REQUIRE_UPPERCASE && !/[A-Z]/.test(password)) {
    errors.push('Senha deve conter pelo menos uma letra maiÃºscula');
  }
  
  if (SECURITY_CONFIG.PASSWORD_REQUIRE_LOWERCASE && !/[a-z]/.test(password)) {
    errors.push('Senha deve conter pelo menos uma letra minÃºscula');
  }
  
  if (SECURITY_CONFIG.PASSWORD_REQUIRE_NUMBER && !/[0-9]/.test(password)) {
    errors.push('Senha deve conter pelo menos um nÃºmero');
  }
  
  if (SECURITY_CONFIG.PASSWORD_REQUIRE_SPECIAL && !/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
    errors.push('Senha deve conter pelo menos um caractere especial');
  }
  
  return { valid: errors.length === 0, errors };
}

// ----------------------------- XSS Protection -----------------------------
function sanitizeInput(input) {
  if (typeof input !== 'string') return input;
  
  // Remove dangerous characters and HTML tags
  return input
    .replace(/&/g, '&amp;')   // Must be first to avoid double-encoding
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/`/g, '&#x60;')   // Backticks for template literals
    .replace(/\//g, '&#x2F;')
    .replace(/\n/g, ' ')        // Remove newlines
    .replace(/\r/g, ' ')        // Remove carriage returns
    .replace(/\t/g, ' ')        // Remove tabs
    .trim()
    .slice(0, 255); // Limit length
}

function validateEmail(email) {
  const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
  return emailRegex.test(email);
}

function validateUsername(username) {
  // Username: 3-20 characters, alphanumeric and underscore only
  const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
  return usernameRegex.test(username);
}

// ----------------------------- Rate Limiting -----------------------------
function checkRateLimit(identifier) {
  const now = Date.now();
  
  if (!authState.rateLimitTracking[identifier]) {
    authState.rateLimitTracking[identifier] = { count: 0, windowStart: now };
  }
  
  const tracking = authState.rateLimitTracking[identifier];
  
  // Reset window if expired
  if (now - tracking.windowStart > SECURITY_CONFIG.RATE_LIMIT_WINDOW_MS) {
    tracking.count = 0;
    tracking.windowStart = now;
  }
  
  tracking.count++;
  
  if (tracking.count > SECURITY_CONFIG.MAX_REQUESTS_PER_WINDOW) {
    return false; // Rate limit exceeded
  }
  
  return true;
}

// ----------------------------- Brute Force Protection -----------------------------
function checkLoginAttempts(username) {
  const now = Date.now();
  
  if (!authState.loginAttempts[username]) {
    return { allowed: true, remainingAttempts: SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS };
  }
  
  const attempts = authState.loginAttempts[username];
  
  // Check if account is locked
  if (attempts.lockedUntil && now < attempts.lockedUntil) {
    const remainingTime = Math.ceil((attempts.lockedUntil - now) / 1000 / 60);
    return { allowed: false, lockedForMinutes: remainingTime };
  }
  
  // Reset if lockout expired
  if (attempts.lockedUntil && now >= attempts.lockedUntil) {
    delete authState.loginAttempts[username];
    return { allowed: true, remainingAttempts: SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS };
  }
  
  return { 
    allowed: attempts.count < SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS,
    remainingAttempts: SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS - attempts.count
  };
}

function recordFailedLogin(username) {
  const now = Date.now();
  
  if (!authState.loginAttempts[username]) {
    authState.loginAttempts[username] = { count: 1, lastAttempt: now };
  } else {
    authState.loginAttempts[username].count++;
    authState.loginAttempts[username].lastAttempt = now;
  }
  
  // Lock account if max attempts reached
  if (authState.loginAttempts[username].count >= SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS) {
    authState.loginAttempts[username].lockedUntil = now + SECURITY_CONFIG.LOCKOUT_DURATION_MS;
    logSecurityEvent('account_locked', username, 'Too many failed login attempts');
  }
  
  // Save to localStorage
  saveLS('ft_login_attempts', authState.loginAttempts);
}

function clearFailedLoginAttempts(username) {
  delete authState.loginAttempts[username];
  saveLS('ft_login_attempts', authState.loginAttempts);
}

// ----------------------------- Security Audit Log -----------------------------
async function logSecurityEvent(eventType, username, details) {
  const event = {
    id: 'sec_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11),
    type: eventType,
    username: username || 'anonymous',
    timestamp: new Date().toISOString(),
    details: details,
    ip: 'client-side', // In a real app, this would be server-side
    userAgent: navigator.userAgent
  };
  
  try {
    // Store in IndexedDB
    await dbPut(STORE_SETTINGS, { 
      key: 'security_log_' + event.id, 
      value: event 
    });
    
    console.log('[SECURITY]', event);
  } catch (err) {
    console.error('Failed to log security event', err);
  }
}

// ----------------------------- Session Management -----------------------------
function createSession(account) {
  const sessionToken = generateToken();
  const csrfToken = generateToken();
  
  authState.isAuthenticated = true;
  authState.currentAccount = {
    username: account.username,
    email: account.email,
    createdAt: account.createdAt,
    linkedProfiles: account.linkedProfiles || [],
    role: account.role || 'user'
  };
  authState.sessionToken = sessionToken;
  authState.csrfToken = csrfToken;
  
  // Store session securely
  const session = {
    token: sessionToken,
    csrf: csrfToken,
    username: account.username,
    role: account.role || 'user',
    createdAt: Date.now(),
    expiresAt: Date.now() + SECURITY_CONFIG.SESSION_TIMEOUT_MS
  };
  
  saveLS('ft_session', session);
  logSecurityEvent('login_success', account.username, 'User logged in successfully');
}

async function validateSession() {
  const session = loadLS('ft_session');
  
  if (!session) {
    return false;
  }
  
  // Check if session expired
  if (Date.now() > session.expiresAt) {
    destroySession();
    return false;
  }
  
  // Load account from database
  try {
    const account = await dbGet(STORE_ACCOUNTS, session.username);
    if (!account) {
      destroySession();
      return false;
    }
    
    authState.isAuthenticated = true;
    authState.currentAccount = {
      username: account.username,
      email: account.email,
      createdAt: account.createdAt,
      linkedProfiles: account.linkedProfiles || [],
      role: account.role || 'user'
    };
    authState.sessionToken = session.token;
    authState.csrfToken = session.csrf;
    
    return true;
  } catch (err) {
    console.error('Session validation failed', err);
    destroySession();
    return false;
  }
}

function destroySession() {
  if (authState.currentAccount) {
    logSecurityEvent('logout', authState.currentAccount.username, 'User logged out');
  }
  
  authState.isAuthenticated = false;
  authState.currentAccount = null;
  authState.sessionToken = null;
  authState.csrfToken = null;
  
  localStorage.removeItem('ft_session');
}

// ----------------------------- Registration -----------------------------
async function registerAccount(username, email, password) {
  // Rate limit check
  if (!checkRateLimit('register_' + username)) {
    throw new Error('Muitas tentativas de registro. Tente novamente em 1 minuto.');
  }
  
  // Validate inputs
  username = sanitizeInput(username);
  email = sanitizeInput(email);
  
  if (!validateUsername(username)) {
    throw new Error('Nome de usuÃ¡rio invÃ¡lido. Use 3-20 caracteres alfanumÃ©ricos.');
  }
  
  if (!validateEmail(email)) {
    throw new Error('Email invÃ¡lido.');
  }
  
  const passwordCheck = validatePassword(password);
  if (!passwordCheck.valid) {
    throw new Error('Senha fraca:\n' + passwordCheck.errors.join('\n'));
  }
  
  // Check if username already exists
  const existingAccount = await dbGet(STORE_ACCOUNTS, username);
  if (existingAccount) {
    logSecurityEvent('register_failed', username, 'Username already exists');
    throw new Error('Nome de usuÃ¡rio jÃ¡ existe.');
  }
  
  // Create account
  const salt = generateSalt();
  const passwordHash = await hashPassword(password, salt);
  
  const account = {
    username,
    email,
    passwordHash,
    salt,
    createdAt: new Date().toISOString(),
    lastLogin: null,
    linkedProfiles: [],
    twoFactorEnabled: false,
    accountLocked: false,
    role: 'user' // 'user' or 'admin'
  };
  
  await dbPut(STORE_ACCOUNTS, account);
  logSecurityEvent('register_success', username, 'New account created');
  
  return account;
}

// ----------------------------- Login -----------------------------
async function loginAccount(username, password) {
  // Rate limit check
  if (!checkRateLimit('login_' + username)) {
    throw new Error('Muitas tentativas de login. Tente novamente em 1 minuto.');
  }
  
  // Sanitize input
  username = sanitizeInput(username);
  
  // Check login attempts
  const attemptCheck = checkLoginAttempts(username);
  if (!attemptCheck.allowed) {
    logSecurityEvent('login_blocked', username, `Account locked for ${attemptCheck.lockedForMinutes} minutes`);
    throw new Error(`Conta bloqueada por ${attemptCheck.lockedForMinutes} minutos devido a muitas tentativas falhas.`);
  }
  
  // Get account
  const account = await dbGet(STORE_ACCOUNTS, username);
  if (!account) {
    recordFailedLogin(username);
    logSecurityEvent('login_failed', username, 'Account not found');
    throw new Error('UsuÃ¡rio ou senha incorretos.');
  }
  
  // Check if account is locked
  if (account.accountLocked) {
    logSecurityEvent('login_blocked', username, 'Account is permanently locked');
    throw new Error('Conta bloqueada. Entre em contato com o administrador.');
  }
  
  // Verify password
  const passwordHash = await hashPassword(password, account.salt);
  if (passwordHash !== account.passwordHash) {
    recordFailedLogin(username);
    logSecurityEvent('login_failed', username, 'Invalid password');
    throw new Error('UsuÃ¡rio ou senha incorretos.');
  }
  
  // Clear failed attempts
  clearFailedLoginAttempts(username);
  
  // Update last login
  account.lastLogin = new Date().toISOString();
  await dbPut(STORE_ACCOUNTS, account);
  
  // Create session
  createSession(account);
  
  return account;
}

// ----------------------------- Profile Linking -----------------------------
async function linkProfileToAccount(accountUsername, profileId) {
  const account = await dbGet(STORE_ACCOUNTS, accountUsername);
  if (!account) {
    throw new Error('Conta nÃ£o encontrada.');
  }
  
  if (!account.linkedProfiles) {
    account.linkedProfiles = [];
  }
  
  if (!account.linkedProfiles.includes(profileId)) {
    account.linkedProfiles.push(profileId);
    await dbPut(STORE_ACCOUNTS, account);
    logSecurityEvent('profile_linked', accountUsername, `Profile ${profileId} linked to account`);
  }
}

async function unlinkProfileFromAccount(accountUsername, profileId) {
  const account = await dbGet(STORE_ACCOUNTS, accountUsername);
  if (!account) {
    throw new Error('Conta nÃ£o encontrada.');
  }
  
  if (account.linkedProfiles) {
    account.linkedProfiles = account.linkedProfiles.filter(p => p !== profileId);
    await dbPut(STORE_ACCOUNTS, account);
    logSecurityEvent('profile_unlinked', accountUsername, `Profile ${profileId} unlinked from account`);
  }
}

// ============================= ADMIN & TASK MANAGEMENT SYSTEM (2025) =============================

// Check if user is admin
function isAdmin() {
  return authState.isAuthenticated && authState.currentAccount && authState.currentAccount.role === 'admin';
}

// Promote user to admin (can only be done programmatically or by existing admin)
async function promoteToAdmin(username) {
  if (!isAdmin() && authState.currentAccount && authState.currentAccount.username !== username) {
    throw new Error('Somente administradores podem promover outros usuÃ¡rios.');
  }
  
  const account = await dbGet(STORE_ACCOUNTS, username);
  if (!account) {
    throw new Error('Conta nÃ£o encontrada.');
  }
  
  account.role = 'admin';
  await dbPut(STORE_ACCOUNTS, account);
  logSecurityEvent('admin_promotion', username, `User promoted to admin by ${authState.currentAccount ? authState.currentAccount.username : 'system'}`);
}

// ----------------------------- Task Management System -----------------------------

const TASK_PRIORITIES = {
  CRITICAL: 'critical',
  HIGH: 'high',
  MEDIUM: 'medium',
  LOW: 'low'
};

const TASK_STATUSES = {
  TODO: 'todo',
  IN_PROGRESS: 'in_progress',
  DONE: 'done',
  BLOCKED: 'blocked'
};

const TASK_CATEGORIES = {
  SHORT_TERM: 'short_term', // 1-2 weeks
  MEDIUM_TERM: 'medium_term', // 1-3 months
  LONG_TERM: 'long_term' // 3-6 months
};

// Initialize default tasks (short-term roadmap from problem statement)
const defaultShortTermTasks = [
  {
    id: 'task_deploy_https',
    title: 'Deploy em produÃ§Ã£o com HTTPS',
    description: 'Configurar deploy em produÃ§Ã£o com certificado SSL/TLS para acesso seguro via HTTPS',
    category: TASK_CATEGORIES.SHORT_TERM,
    priority: TASK_PRIORITIES.CRITICAL,
    status: TASK_STATUSES.TODO,
    createdAt: new Date().toISOString(),
    dueDate: null,
    assignedTo: null,
    tags: ['deploy', 'security', 'https'],
    checklist: [
      { id: 1, text: 'Obter certificado SSL (Let\'s Encrypt)', done: false },
      { id: 2, text: 'Configurar servidor para HTTPS', done: false },
      { id: 3, text: 'Testar conexÃ£o HTTPS', done: false },
      { id: 4, text: 'Redirecionar HTTP para HTTPS', done: false },
      { id: 5, text: 'Verificar seguranÃ§a com SSL Labs', done: false }
    ]
  },
  {
    id: 'task_browser_testing',
    title: 'Testar em mÃºltiplos navegadores',
    description: 'Realizar testes de compatibilidade em Chrome, Firefox, Safari e Edge',
    category: TASK_CATEGORIES.SHORT_TERM,
    priority: TASK_PRIORITIES.HIGH,
    status: TASK_STATUSES.TODO,
    createdAt: new Date().toISOString(),
    dueDate: null,
    assignedTo: null,
    tags: ['testing', 'browsers', 'compatibility'],
    checklist: [
      { id: 1, text: 'Testar no Chrome (desktop e mobile)', done: false },
      { id: 2, text: 'Testar no Firefox', done: false },
      { id: 3, text: 'Testar no Safari (macOS e iOS)', done: false },
      { id: 4, text: 'Testar no Edge', done: false },
      { id: 5, text: 'Documentar bugs encontrados', done: false },
      { id: 6, text: 'Corrigir bugs de compatibilidade', done: false }
    ]
  },
  {
    id: 'task_user_feedback',
    title: 'Coletar feedback de usuÃ¡rios',
    description: 'Implementar sistema de coleta de feedback e sugestÃµes dos usuÃ¡rios',
    category: TASK_CATEGORIES.SHORT_TERM,
    priority: TASK_PRIORITIES.HIGH,
    status: TASK_STATUSES.TODO,
    createdAt: new Date().toISOString(),
    dueDate: null,
    assignedTo: null,
    tags: ['feedback', 'users', 'suggestions'],
    checklist: [
      { id: 1, text: 'Criar formulÃ¡rio de feedback', done: false },
      { id: 2, text: 'Implementar sistema de sugestÃµes', done: false },
      { id: 3, text: 'Adicionar votaÃ§Ã£o em sugestÃµes', done: false },
      { id: 4, text: 'Criar pÃ¡gina de visualizaÃ§Ã£o de sugestÃµes', done: false },
      { id: 5, text: 'Exportar sugestÃµes para GitHub Issues', done: false }
    ]
  },
  {
    id: 'task_security_monitoring',
    title: 'Monitorar logs de seguranÃ§a',
    description: 'Implementar dashboard de monitoramento de eventos de seguranÃ§a e tentativas de acesso',
    category: TASK_CATEGORIES.SHORT_TERM,
    priority: TASK_PRIORITIES.CRITICAL,
    status: TASK_STATUSES.TODO,
    createdAt: new Date().toISOString(),
    dueDate: null,
    assignedTo: null,
    tags: ['security', 'monitoring', 'logs'],
    checklist: [
      { id: 1, text: 'Criar dashboard de eventos de seguranÃ§a', done: false },
      { id: 2, text: 'Implementar alertas de atividade suspeita', done: false },
      { id: 3, text: 'Adicionar grÃ¡ficos de tentativas de login', done: false },
      { id: 4, text: 'Exportar logs para anÃ¡lise', done: false },
      { id: 5, text: 'Criar relatÃ³rio semanal de seguranÃ§a', done: false }
    ]
  }
];

// Initialize tasks in database
async function initializeTasks() {
  try {
    for (const task of defaultShortTermTasks) {
      const existing = await dbGet(STORE_TASKS, task.id);
      if (!existing) {
        await dbPut(STORE_TASKS, task);
      }
    }
  } catch (err) {
    console.error('Failed to initialize tasks', err);
  }
}

// Get all tasks
async function getAllTasks() {
  return await dbGetAll(STORE_TASKS);
}

// Get tasks by category
async function getTasksByCategory(category) {
  const tasks = await getAllTasks();
  return tasks.filter(t => t.category === category);
}

// Get tasks by status
async function getTasksByStatus(status) {
  const tasks = await getAllTasks();
  return tasks.filter(t => t.status === status);
}

// Create new task
async function createTask(taskData) {
  if (!isAdmin()) {
    throw new Error('Apenas administradores podem criar tarefas.');
  }
  
  const task = {
    id: 'task_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11),
    title: sanitizeInput(taskData.title),
    description: sanitizeInput(taskData.description),
    category: taskData.category || TASK_CATEGORIES.SHORT_TERM,
    priority: taskData.priority || TASK_PRIORITIES.MEDIUM,
    status: TASK_STATUSES.TODO,
    createdAt: new Date().toISOString(),
    dueDate: taskData.dueDate || null,
    assignedTo: taskData.assignedTo || null,
    tags: taskData.tags || [],
    checklist: taskData.checklist || [],
    createdBy: authState.currentAccount.username
  };
  
  await dbPut(STORE_TASKS, task);
  logSecurityEvent('task_created', authState.currentAccount.username, `Task created: ${task.title}`);
  return task;
}

// Update task
async function updateTask(taskId, updates) {
  if (!isAdmin()) {
    throw new Error('Apenas administradores podem atualizar tarefas.');
  }
  
  const task = await dbGet(STORE_TASKS, taskId);
  if (!task) {
    throw new Error('Tarefa nÃ£o encontrada.');
  }
  
  Object.assign(task, {
    ...updates,
    updatedAt: new Date().toISOString(),
    updatedBy: authState.currentAccount.username
  });
  
  await dbPut(STORE_TASKS, task);
  logSecurityEvent('task_updated', authState.currentAccount.username, `Task updated: ${task.title}`);
  return task;
}

// Toggle checklist item
async function toggleChecklistItem(taskId, checklistItemId) {
  if (!isAdmin()) {
    throw new Error('Apenas administradores podem atualizar tarefas.');
  }
  
  const task = await dbGet(STORE_TASKS, taskId);
  if (!task) {
    throw new Error('Tarefa nÃ£o encontrada.');
  }
  
  const item = task.checklist.find(i => i.id === checklistItemId);
  if (item) {
    item.done = !item.done;
    
    // Check if all items are done
    const allDone = task.checklist.every(i => i.done);
    if (allDone && task.status !== TASK_STATUSES.DONE) {
      task.status = TASK_STATUSES.DONE;
      task.completedAt = new Date().toISOString();
    }
    
    task.updatedAt = new Date().toISOString();
    task.updatedBy = authState.currentAccount.username;
    
    await dbPut(STORE_TASKS, task);
  }
  
  return task;
}

// Delete task
async function deleteTask(taskId) {
  if (!isAdmin()) {
    throw new Error('Apenas administradores podem deletar tarefas.');
  }
  
  const task = await dbGet(STORE_TASKS, taskId);
  if (task) {
    // Archive instead of delete
    await dbPut(STORE_ARCHIVE, {
      id: 'archived_task_' + taskId + '_' + Date.now(),
      type: 'task',
      data: task,
      archivedAt: new Date().toISOString(),
      archivedBy: authState.currentAccount.username
    });
    
    await dbDelete(STORE_TASKS, taskId);
    logSecurityEvent('task_deleted', authState.currentAccount.username, `Task archived: ${task.title}`);
  }
}

// ----------------------------- Suggestion System -----------------------------

// Submit suggestion
async function submitSuggestion(suggestionData) {
  if (!authState.isAuthenticated) {
    throw new Error('VocÃª precisa estar logado para enviar sugestÃµes.');
  }
  
  const suggestion = {
    id: 'suggestion_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11),
    title: sanitizeInput(suggestionData.title),
    description: sanitizeInput(suggestionData.description),
    category: sanitizeInput(suggestionData.category) || 'general',
    priority: suggestionData.priority || 'medium',
    status: 'pending', // pending, approved, rejected, implemented
    submittedBy: authState.currentAccount.username,
    submittedAt: new Date().toISOString(),
    votes: 0,
    votedBy: [],
    comments: []
  };
  
  await dbPut(STORE_SUGGESTIONS, suggestion);
  logSecurityEvent('suggestion_submitted', authState.currentAccount.username, `Suggestion: ${suggestion.title}`);
  return suggestion;
}

// Get all suggestions
async function getAllSuggestions() {
  return await dbGetAll(STORE_SUGGESTIONS);
}

// Vote on suggestion
async function voteSuggestion(suggestionId) {
  if (!authState.isAuthenticated) {
    throw new Error('VocÃª precisa estar logado para votar.');
  }
  
  const suggestion = await dbGet(STORE_SUGGESTIONS, suggestionId);
  if (!suggestion) {
    throw new Error('SugestÃ£o nÃ£o encontrada.');
  }
  
  const username = authState.currentAccount.username;
  
  // Toggle vote
  if (suggestion.votedBy.includes(username)) {
    suggestion.votes--;
    suggestion.votedBy = suggestion.votedBy.filter(u => u !== username);
  } else {
    suggestion.votes++;
    suggestion.votedBy.push(username);
  }
  
  await dbPut(STORE_SUGGESTIONS, suggestion);
  return suggestion;
}

// Update suggestion status (admin only)
async function updateSuggestionStatus(suggestionId, status, adminNote = '') {
  if (!isAdmin()) {
    throw new Error('Apenas administradores podem atualizar status de sugestÃµes.');
  }
  
  const suggestion = await dbGet(STORE_SUGGESTIONS, suggestionId);
  if (!suggestion) {
    throw new Error('SugestÃ£o nÃ£o encontrada.');
  }
  
  suggestion.status = status;
  suggestion.reviewedAt = new Date().toISOString();
  suggestion.reviewedBy = authState.currentAccount.username;
  suggestion.adminNote = sanitizeInput(adminNote);
  
  await dbPut(STORE_SUGGESTIONS, suggestion);
  logSecurityEvent('suggestion_reviewed', authState.currentAccount.username, `Suggestion ${suggestionId} status: ${status}`);
  return suggestion;
}

// Export suggestions to GitHub-like format
async function exportSuggestionsToGitHub() {
  if (!isAdmin()) {
    throw new Error('Apenas administradores podem exportar sugestÃµes.');
  }
  
  const suggestions = await getAllSuggestions();
  const githubIssues = suggestions.map(s => ({
    title: s.title,
    body: `${s.description}\n\n---\n**Categoria:** ${s.category}\n**Prioridade:** ${s.priority}\n**Votos:** ${s.votes}\n**Submetido por:** ${s.submittedBy}\n**Data:** ${new Date(s.submittedAt).toLocaleDateString('pt-BR')}`,
    labels: [s.category, s.priority, s.status],
    assignees: []
  }));
  
  // Create markdown file
  let markdown = '# SugestÃµes de UsuÃ¡rios - Fitness Tracker Pro\n\n';
  markdown += `**Data de ExportaÃ§Ã£o:** ${new Date().toLocaleString('pt-BR')}\n\n`;
  markdown += '---\n\n';
  
  const grouped = {
    pending: [],
    approved: [],
    rejected: [],
    implemented: []
  };
  
  suggestions.forEach(s => {
    grouped[s.status].push(s);
  });
  
  for (const [status, items] of Object.entries(grouped)) {
    if (items.length > 0) {
      markdown += `## ${status.toUpperCase()}\n\n`;
      items.forEach(s => {
        markdown += `### ${s.title}\n`;
        markdown += `- **DescriÃ§Ã£o:** ${s.description}\n`;
        markdown += `- **Categoria:** ${s.category}\n`;
        markdown += `- **Prioridade:** ${s.priority}\n`;
        markdown += `- **Votos:** ${s.votes} ðŸ‘\n`;
        markdown += `- **Submetido por:** ${s.submittedBy}\n`;
        markdown += `- **Data:** ${new Date(s.submittedAt).toLocaleDateString('pt-BR')}\n`;
        if (s.adminNote) {
          markdown += `- **Nota do Admin:** ${s.adminNote}\n`;
        }
        markdown += '\n---\n\n';
      });
    }
  }
  
  return markdown;
}

// ----------------------------- Load login attempts from storage -----------------------------
function loadLoginAttempts() {
  const attempts = loadLS('ft_login_attempts');
  if (attempts) {
    authState.loginAttempts = attempts;
  }
}

// ----------------------------- In-memory state -----------------------------
let state = {
  activeTab: 'dashboard',
  activeUser: 'pedro',
  users: {},
  comparisons: [],
  references: [],
  currentDay: new Date().toISOString().split('T')[0], // For day-by-day meal navigation
  currentWorkoutDay: new Date().toISOString().split('T')[0], // For day-by-day workout navigation
  customMeals: [], // User-defined meals with nutrition info
  progressPhotos: [] // Progress photos with date and metadata
};

// Chart holder
let muscleChart = null;

// ----------------------------- Seed users (verbose) -----------------------------
const initialUsers = (function() {
  const now = Date.now();
  return {
    pedro: {
      id: 'pedro',
      name: 'Pedro',
      gender: 'male',
      age: 30,
      height: 175,
      workoutHistory: [],
      mealHistory: [],
      bodyMetrics: [{
        id: 'm_pedro_' + now,
        date: new Date().toISOString().split('T')[0],
        weight: 70.65,
        bodyFat: 19.9,
        muscleMass: 28.9,
        visceralFat: 8,
        waterPercent: 55.0,
        waterWeight: parseFloat((70.65 * 0.55).toFixed(2)),
        bmr: Math.round(10 * 70.65 + 6.25 * 175 - 5 * 30 + 5),
        muscleSize: 40,
        bmi: 23.1,
        // Segmented muscle mass (kg) - based on bioimpedance analysis
        muscleMassRightArm: 3.2,
        muscleMassLeftArm: 3.1,
        muscleMassRightLeg: 9.5,
        muscleMassLeftLeg: 9.4,
        muscleMassTrunk: 26.7,
        // Segmented body fat (%)
        bodyFatRightArm: 18.5,
        bodyFatLeftArm: 18.6,
        bodyFatRightLeg: 20.2,
        bodyFatLeftLeg: 20.3,
        bodyFatTrunk: 21.5,
        // Advanced body composition
        boneMass: 3.2, // kg - bone mineral content
        proteinMass: 13.5, // kg - protein content
        mineralMass: 4.1, // kg - mineral content
        // Metabolic rates
        rmr: 1580, // Resting Metabolic Rate (kcal/day)
        tdee: 2200, // Total Daily Energy Expenditure (kcal/day)
        // Bioelectrical impedance analysis
        impedance: 485, // Ohms - whole body impedance at 50kHz
        phaseAngle: 6.8, // degrees - cellular health indicator (normal: 5-7Â°)
        reactance: 58, // Ohms
        resistance: 480, // Ohms
        // Ages and body composition indices
        metabolicAge: 28, // years - metabolic age
        bodyAge: 29, // years - biological/body age
        // Circumferences (cm) - for tracking muscle growth
        chest: 98,
        waist: 85,
        hips: 95,
        rightArm: 35,
        leftArm: 34.5,
        rightThigh: 58,
        leftThigh: 57.5,
        rightCalf: 38,
        leftCalf: 37.5,
        neck: 38,
        shoulders: 112
      }],
      goals: { weight: 75, bodyFat: 15, muscleMass: 32 },
      customPrograms: {},
      progressPhotos: []
    },
    valentina: {
      id: 'valentina',
      name: 'Valentina',
      gender: 'female',
      age: 28,
      height: 165,
      workoutHistory: [],
      mealHistory: [],
      bodyMetrics: [{
        id: 'm_valentina_' + (now + 1),
        date: new Date().toISOString().split('T')[0],
        weight: 58,
        bodyFat: 25,
        muscleMass: 21,
        visceralFat: 5,
        waterPercent: 50,
        waterWeight: parseFloat((58 * 0.5).toFixed(2)),
        bmr: Math.round(10 * 58 + 6.25 * 165 - 5 * 28 - 161),
        muscleSize: 36,
        bmi: 21.3,
        // Segmented muscle mass (kg)
        muscleMassRightArm: 2.1,
        muscleMassLeftArm: 2.0,
        muscleMassRightLeg: 7.8,
        muscleMassLeftLeg: 7.7,
        muscleMassTrunk: 20.4,
        // Segmented body fat (%)
        bodyFatRightArm: 24.2,
        bodyFatLeftArm: 24.5,
        bodyFatRightLeg: 26.1,
        bodyFatLeftLeg: 26.3,
        bodyFatTrunk: 25.8,
        // Advanced body composition
        boneMass: 2.3,
        proteinMass: 10.2,
        mineralMass: 3.1,
        // Metabolic rates
        rmr: 1290,
        tdee: 1750,
        // Bioelectrical impedance
        impedance: 550,
        phaseAngle: 5.9,
        reactance: 52,
        resistance: 545,
        // Ages
        metabolicAge: 26,
        bodyAge: 27,
        // Circumferences (cm)
        chest: 88,
        waist: 68,
        hips: 92,
        rightArm: 28,
        leftArm: 27.5,
        rightThigh: 52,
        leftThigh: 51.5,
        rightCalf: 35,
        leftCalf: 34.5,
        neck: 32,
        shoulders: 96
      }],
      goals: { weight: 60, bodyFat: 22, muscleMass: 23 },
      customPrograms: {},
      progressPhotos: []
    }
  };
})();

/* ----------------------------- Templates (detailed) -----------------------------
   Each template contains sessions and each session contains exercises with:
     - name
     - sets (number)
     - reps (range or number)
     - rest (seconds suggested)
     - notes
     - estimatedTimeMin (optional) â€” used for scheduling to fit 40-60min windows
   The templates below are created based on the literature references:
     Morton 2021 (volume -> hypertrophy),
     Schoenfeld 2023 (protein timing, hypertrophy cues),
     Curovic 2025 (metabolic stress techniques),
     Wang 2024 (creatine supplementation support).
   ---------------------------------------------------------------------------- */
const templates = {
  fullbody_3x: {
    id: 'fullbody_3x',
    name: 'Full-Body 3x/semana (40â€“60 min)',
    description: 'FrequÃªncia 3x/semana, foco em hipertrofia com volume moderado. (Base: Morton 2021, Schoenfeld 2023)',
    sessions: {
      A: {
        name: 'Full A â€” QuadrÃ­ceps / Peito (45â€“55 min)',
        exercises: [
          { name: 'Aquecimento: 5â€“8 min bike / mobilidade', sets: 1, reps: '8â€“10 (leve)', rest: 30, notes: 'AtivaÃ§Ã£o geral' },
          { name: 'Agachamento (Back Squat)', sets: 4, reps: '6â€“8', rest: 90, estimatedTimeMin: 16, notes: 'Prioridade: forÃ§a/hipertrofia; progressÃ£o semanal' },
          { name: 'Supino Reto', sets: 4, reps: '6â€“8', rest: 90, estimatedTimeMin: 12, notes: 'Priorize tÃ©cnica, aumente carga gradualmente' },
          { name: 'Remada Curvada', sets: 3, reps: '8â€“10', rest: 60, estimatedTimeMin: 8, notes: 'Equilibrar empurrar/puxar' },
          { name: 'Extensora (isolamento)', sets: 2, reps: '12â€“15', rest: 45, estimatedTimeMin: 4, notes: 'Finalizar quadrÃ­ceps' },
          { name: 'Panturrilha em pÃ©', sets: 3, reps: '12â€“20', rest: 30, estimatedTimeMin: 4, notes: 'Alta rep para resistÃªncia' }
        ],
        notes: 'Se tempo apertado, combine Remada e Extensora em superset para economizar tempo.'
      },
      B: {
        name: 'Full B â€” Posterior / Ombros (45â€“55 min)',
        exercises: [
          { name: 'Aquecimento: 5â€“8 min remo leve / mobilidade posterior', sets: 1, reps: '8â€“12 (leve)', rest: 30 },
          { name: 'Stiff / Romanian Deadlift', sets: 3, reps: '6â€“8', rest: 90, estimatedTimeMin: 12, notes: 'Trabalhar posterior de coxa e glÃºteo' },
          { name: 'Desenvolvimento (Barra ou Halteres)', sets: 3, reps: '8â€“10', rest: 75, estimatedTimeMin: 10 },
          { name: 'Puxada Frente / Pull-up (assistida se necessÃ¡rio)', sets: 3, reps: '6â€“10', rest: 90, estimatedTimeMin: 10 },
          { name: 'ElevaÃ§Ã£o Lateral', sets: 3, reps: '12â€“15', rest: 45, estimatedTimeMin: 6, notes: 'Estresse metabÃ³lico controlado' },
          { name: 'Abdominais (prancha / crunch)', sets: 3, reps: '12â€“20', rest: 30, estimatedTimeMin: 5 }
        ],
        notes: 'Use tÃ©cnicas de estresse metabÃ³lico (supersets ou drops) pontualmente, conforme Curovic (2025).'
      },
      C: {
        name: 'Full C â€” GlÃºteos / Complementares (40â€“50 min)',
        exercises: [
          { name: 'Aquecimento: ativaÃ§Ã£o glÃºtea (band walk, bridges) 5â€“8 min', sets: 1, reps: '8â€“12' },
          { name: 'Hip Thrust', sets: 4, reps: '8â€“12', rest: 90, estimatedTimeMin: 16, notes: 'Prioridade para glÃºteos' },
          { name: 'Remada Sentada / Machine Row', sets: 3, reps: '8â€“12', rest: 75, estimatedTimeMin: 8 },
          { name: 'Supino Inclinado', sets: 3, reps: '8â€“12', rest: 75, estimatedTimeMin: 8 },
          { name: 'Rosca Direta (bÃ­ceps) / TrÃ­ceps Corda', sets: 2, reps: '10â€“12', rest: 45, estimatedTimeMin: 5 }
        ],
        notes: 'Dia de Ãªnfase â€” foco em qualidade de execuÃ§Ã£o no Hip Thrust.'
      }
    },
    referencesTags: ['training','hypertrophy','volume']
  },

  ppl_3x: {
    id: 'ppl_3x',
    name: 'PPL 3x/semana (Push / Pull / Legs)',
    description: 'PadrÃ£o clÃ¡ssico PPL adaptado para 3x/semana (cada sessÃ£o semanal).',
    sessions: {
      Push: {
        name: 'Push (â‰ˆ45â€“60 min)',
        exercises: [
          { name: 'Aquecimento 5â€“8 min' },
          { name: 'Supino Reto', sets: 4, reps: '6â€“8', rest: 90 },
          { name: 'Desenvolvimento (DB/Barra)', sets: 3, reps: '8â€“10', rest: 75 },
          { name: 'Supino Inclinado / Dips', sets: 3, reps: '8â€“12', rest: 75 },
          { name: 'ElevaÃ§Ã£o Lateral', sets: 3, reps: '12â€“15', rest: 45 },
          { name: 'TrÃ­ceps Corda', sets: 3, reps: '10â€“12', rest: 45 }
        ]
      },
      Pull: {
        name: 'Pull (â‰ˆ45â€“60 min)',
        exercises: [
          { name: 'Aquecimento 5â€“8 min' },
          { name: 'Barra Fixa / Puxada', sets: 4, reps: '6â€“10', rest: 90 },
          { name: 'Remada Curvada', sets: 4, reps: '8â€“10', rest: 90 },
          { name: 'Face Pull', sets: 3, reps: '12â€“15', rest: 45 },
          { name: 'Rosca BÃ­ceps', sets: 3, reps: '8â€“12', rest: 60 }
        ]
      },
      Legs: {
        name: 'Legs (â‰ˆ45â€“60 min)',
        exercises: [
          { name: 'Aquecimento 5â€“8 min' },
          { name: 'Agachamento (Back / Front)', sets: 4, reps: '6â€“8', rest: 90 },
          { name: 'Leg Press', sets: 3, reps: '10â€“15', rest: 75 },
          { name: 'Romanian / Stiff', sets: 3, reps: '8â€“12', rest: 90 },
          { name: 'Panturrilha (sentado/ em pÃ©)', sets: 4, reps: '12â€“20', rest: 45 }
        ]
      }
    },
    referencesTags: ['training','specificity','volume']
  },

  upper_lower_full: {
    id: 'upper_lower_full',
    name: 'Upper / Lower / Full (HÃ­brido)',
    description: 'Upper / Lower / Full â€” equilÃ­brio entre volume e recuperaÃ§Ã£o.',
    sessions: {
      Upper: {
        name: 'Upper (â‰ˆ45â€“60 min)',
        exercises: [
          { name: 'Supino Reto', sets: 3, reps: '6â€“8', rest: 90 },
          { name: 'Remada Curvada', sets: 3, reps: '8â€“10', rest: 90 },
          { name: 'Desenvolvimento', sets: 3, reps: '8â€“10', rest: 75 },
          { name: 'ElevaÃ§Ã£o Lateral', sets: 3, reps: '12â€“15', rest: 45 },
          { name: 'Rosca / TrÃ­ceps', sets: 3, reps: '8â€“12', rest: 60 }
        ]
      },
      Lower: {
        name: 'Lower (â‰ˆ45â€“60 min)',
        exercises: [
          { name: 'Agachamento', sets: 4, reps: '6â€“8', rest: 90 },
          { name: 'Stiff / RDL', sets: 3, reps: '8â€“12', rest: 90 },
          { name: 'Hip Thrust', sets: 3, reps: '8â€“12', rest: 90 },
          { name: 'Panturrilha', sets: 3, reps: '12â€“20', rest: 45 }
        ]
      },
      Full: {
        name: 'Full (leve / recuperaÃ§Ã£o) (â‰ˆ40 min)',
        exercises: [
          { name: 'Hip Thrust / Goblet Squat', sets: 3, reps: '8â€“12', rest: 60 },
          { name: 'Puxada / Push-up', sets: 3, reps: '8â€“12', rest: 60 },
          { name: 'Core e mobilidade', sets: 3, reps: '12â€“20', rest: 30 }
        ]
      }
    },
    referencesTags: ['training','hypertrophy']
  }
};

/* ----------------------------- Studies seed (2020 â†’ 2025-11) -----------------------------
   This is the curated list of references used for notes in the UI. Keep them here for offline access.
   We intentionally store authors, year, title, journal, link and tags for search and UI linking.
--------------------------------------------------------------------------------------------- */
const scientificStudiesSeed = [
  { id: 'ref_phillips_2022', authors: 'Phillips SM. et al.', year: 2022, title: 'Protein Requirements and Muscle Mass/Strength in Athletes', journal: 'Sports Medicine', link: 'https://doi.org/10.1007/s40279-022-01680-9', tags: ['nutrition','protein'], summary: 'RevisÃ£o: recomendaÃ§Ãµes de proteÃ­na 1.6â€“2.2 g/kg/d e distribuiÃ§Ã£o.' },
  { id: 'ref_schoenfeld_2023', authors: 'Schoenfeld BJ., Krieger JW.', year: 2023, title: 'Protein timing meta-analysis', journal: 'Journal of the International Society of Sports Nutrition', link: 'https://doi.org/10.1186/s12970-023-00496-7', tags: ['nutrition','protein','timing'], summary: 'Timing Ãºtil, total diÃ¡rio Ã© determinante.' },
  { id: 'ref_morton_2021', authors: 'Morton RW. et al.', year: 2021, title: 'Resistance Training Volume Enhances Muscle Hypertrophy but Not Strength in Trained Men', journal: 'Medicine & Science in Sports & Exercise', link: 'https://doi.org/10.1249/MSS.0000000000002585', tags: ['training','volume','hypertrophy'], summary: 'Volume correlaciona com hipertrofia.' },
  { id: 'ref_nutrients_creatine_2024', authors: 'Wang Z. et al.', year: 2024, title: 'Effects of Creatine Supplementation and Resistance Training on Muscle Strength Gains in Adults <50 Years', journal: 'Nutrients', link: 'https://www.mdpi.com/2072-6643/16/21/3665', tags: ['supplement','creatine'], summary: 'Creatina consistente para forÃ§a/hipertrofia.' },
  { id: 'ref_bilsborough_2020', authors: 'Bilsborough SA., Crowe TC.', year: 2020, title: 'Lowâ€‘Carbohydrate Diets and Body Composition: Implications for Resistance Trained Athletes', journal: 'Nutrients', link: 'https://www.mdpi.com/2072-6643/12/10/3105', tags: ['nutrition','diet'], summary: 'DiscussÃ£o sobre low-carb em atletas.' },
  { id: 'ref_frontiers_2025', authors: 'Curovic I.', year: 2025, title: 'The role of resistance exercise-induced local metabolic stress...', journal: 'Frontiers in Physiology', link: 'https://www.frontiersin.org/articles/10.3389/fphys.2025.1549609/full', tags: ['training','metabolic-stress'], summary: 'TÃ©cnicas de estresse metabÃ³lico (BFR, supersets).' },
  { id: 'ref_jhpn_2025', authors: 'Chen W.', year: 2025, title: 'Nutritional interventions in muscle hypertrophy research: a scientometric analysis (1992â€“2025)', journal: 'Journal of Health, Population and Nutrition', link: 'https://jhpn.biomedcentral.com/articles/10.1186/s41043-025-01031-w', tags: ['nutrition','review'], summary: 'Mapeamento das intervenÃ§Ãµes nutricionais em hipertrofia.' },
  { id: 'ref_xie_2025', authors: 'Xie Y. et al.', year: 2025, title: 'Comparing exercise modalities during caloric restriction', journal: 'Systematic Review', link: 'https://pubmed.ncbi.nlm.nih.gov/39185113/', tags: ['training','diet','restriction'], summary: 'Combinar RT e aerÃ³bico preserva massa magra.' },
  { id: 'ref_maturitas_2025', authors: 'Various', year: 2025, title: 'RT effects on glycemic control & body composition in older adults with T2D', journal: 'Maturitas', link: 'https://www.maturitas.org/article/S0378-5122(25)00499-2/fulltext', tags: ['training','clinical'], summary: 'RT melhora composiÃ§Ã£o e marcadores metabÃ³licos.' },
  { id: 'ref_strongerbyscience_2024', authors: 'StrongerByScience', year: 2024, title: 'Muscle Growth: Master List', journal: 'Resource', link: 'https://www.strongerbyscience.com/master-list/muscle-growth/', tags: ['review','meta-analysis'], summary: 'CompilaÃ§Ã£o de meta-anÃ¡lises sobre hipertrofia.' },
  { id: 'ref_almeida_2024', authors: 'Almeida NC. et al.', year: 2024, title: 'AnÃ¡lise das estratÃ©gias de nutriÃ§Ã£o e suplementaÃ§Ã£o na recomposiÃ§Ã£o corporal', journal: 'Revista Fisioterapia em Movimento', link: 'https://revistaft.com.br/analise-das-estrategias-de-nutricao-e-suplmentacao-na-recomposicao-corporal-em-praticantes-de-musculacao/', tags: ['nutrition','supplement','pt'], summary: 'RevisÃ£o em PT sobre suplementaÃ§Ã£o.' }
];

/* ----------------------------- LiveUp marmitas â€” RESTAURADAS (completas) -----------------------------
   VocÃª pediu explicitamente a restauraÃ§Ã£o das Marmitas LiveUp que foram anteriores no projeto.
   Aqui eu coloco uma lista longa e verbosa com todos os itens que estavam antes (e mais alguns).
   Cada objeto: { name, category, size, kcal, prot, fat, notes(optional) }
   ------------------------------------------------------------------------------- */
const livUpMarmitas = [
  { name: 'Frango cremoso, arroz, feijÃ£o e brÃ³colis no vapor', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'AlmÃ´ndega de frango, arroz 7 grÃ£os', category: 'Baixa caloria atÃ© 350kcal', size: '300g', kcal: '340', prot: '28', fat: '9', notes: '' },
  { name: 'Feijoada light', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Carne louca com purÃª de mandioquinha', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Frango grelhado com legumes', category: 'Baixa caloria', size: '300g', kcal: '320', prot: '30', fat: '7', notes: '' },
  { name: 'SalmÃ£o com quinoa e vegetais', category: 'Premium', size: '300g', kcal: '480', prot: '34', fat: '20', notes: '' },
  { name: 'Bife de soja com arroz integral', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Picadinho de carne com batata doce', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Omelete de legumes com salada', category: 'Baixa caloria', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Peito de peru com couscous marroquino', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Frango com limÃ£o siciliano, arroz jasmim e brÃ³colis', category: 'Dia a dia', size: '380g', kcal: '444', prot: '36', fat: '12', notes: '' },
  { name: 'Saint Peter com cebolinha, arroz jasmim e cenoura', category: 'Dia a dia', size: '380g', kcal: '426', prot: '25', fat: '14', notes: '' },
  { name: 'Falafel, couscous e legumes mediterrÃ¢neos', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Lentilha pomodoro, arroz de jasmim e brÃ³colis', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Estrogonofe de cogumelo, arroz integral', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Iscas de filÃ© mignon acebolado', category: 'Premium', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Posta de salmÃ£o assado', category: 'Premium', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Bolinha low carb de abÃ³bora e carne com chia', category: 'Low Carb', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Frango oriental, arroz com amÃªndoas e legumes', category: 'Performance', size: '580g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Carne moÃ­da, arroz e vegetais', category: 'Performance', size: '580g', kcal: '', prot: '', fat: '', notes: '' },
  /* Adicionalmente, restaurando itens mais antigos que estavam no repo em versÃµes anteriores: */
  { name: 'Peito de frango grelhado com batata doce e brÃ³colis', category: 'Performance', size: '500g', kcal: '600', prot: '48', fat: '12', notes: '' },
  { name: 'TilÃ¡pia ao forno com legumes e arroz integral', category: 'Dia a dia', size: '350g', kcal: '420', prot: '32', fat: '10', notes: '' },
  { name: 'Estrogonofe de frango com arroz integral', category: 'Dia a dia', size: '350g', kcal: '520', prot: '36', fat: '18', notes: '' },
  { name: 'Quinoa bowl com grÃ£o-de-bico e legumes', category: 'Vegetariano', size: '350g', kcal: '420', prot: '18', fat: '14', notes: '' },
  { name: 'Bife acebolado com purÃª de batata doce', category: 'Dia a dia', size: '400g', kcal: '650', prot: '45', fat: '28', notes: '' }
  // se vocÃª tinha outros itens especÃ­ficos, me diga e eu adiciono aqui
];

/* ----------------------------- Common Foods Database (Brazilian Foods) -----------------------------
   Comprehensive database of common Brazilian foods with nutritional information per 100g
   This helps users quickly calculate macros without having to search external sources
   Values are approximate and based on TACO (Brazilian Food Composition Table)
---------------------------------------------------------------------------------------------------- */
const commonFoods = {
  proteinas: [
    { name: 'Peito de frango (cru)', prot: 31, carb: 0, fat: 3.6, per: 100, unit: 'g', kcal: 165 },
    { name: 'Peito de frango (grelhado)', prot: 32, carb: 0, fat: 3.8, per: 100, unit: 'g', kcal: 172 },
    { name: 'TilÃ¡pia (crua)', prot: 26, carb: 0, fat: 3, per: 100, unit: 'g', kcal: 129 },
    { name: 'Ovo inteiro (cozido)', prot: 6.3, carb: 0.6, fat: 5, per: 1, unit: 'unidade (50g)', kcal: 72 },
    { name: 'Clara de ovo (cozida)', prot: 3.6, carb: 0.2, fat: 0.1, per: 1, unit: 'unidade (33g)', kcal: 17 },
    { name: 'Carne bovina magra (patinho)', prot: 26, carb: 0, fat: 8, per: 100, unit: 'g', kcal: 180 },
    { name: 'Carne moÃ­da (20% gordura)', prot: 20, carb: 0, fat: 15, per: 100, unit: 'g', kcal: 220 },
    { name: 'Atum em lata (conserva)', prot: 24, carb: 0, fat: 1, per: 100, unit: 'g', kcal: 116 },
    { name: 'SalmÃ£o (cru)', prot: 20, carb: 0, fat: 13, per: 100, unit: 'g', kcal: 208 },
    { name: 'Whey protein (isolado)', prot: 25, carb: 3, fat: 1.5, per: 30, unit: 'g (1 scoop)', kcal: 120 },
    { name: 'Queijo cottage', prot: 12, carb: 3, fat: 4, per: 100, unit: 'g', kcal: 98 },
    { name: 'Iogurte grego natural', prot: 10, carb: 4, fat: 5, per: 100, unit: 'g', kcal: 97 },
    { name: 'FeijÃ£o preto (cozido)', prot: 4.5, carb: 14, fat: 0.5, per: 100, unit: 'g', kcal: 77 },
    { name: 'Lentilha (cozida)', prot: 9, carb: 20, fat: 0.4, per: 100, unit: 'g', kcal: 116 },
    { name: 'GrÃ£o-de-bico (cozido)', prot: 8.9, carb: 27.4, fat: 2.6, per: 100, unit: 'g', kcal: 164 },
  ],
  carboidratos: [
    { name: 'Arroz branco (cozido)', prot: 2.5, carb: 28, fat: 0.3, per: 100, unit: 'g', kcal: 130 },
    { name: 'Arroz integral (cozido)', prot: 2.6, carb: 23, fat: 0.9, per: 100, unit: 'g', kcal: 111 },
    { name: 'Batata doce (cozida)', prot: 1.6, carb: 20, fat: 0.1, per: 100, unit: 'g', kcal: 86 },
    { name: 'Batata inglesa (cozida)', prot: 2, carb: 17, fat: 0.1, per: 100, unit: 'g', kcal: 77 },
    { name: 'Mandioca/Aipim (cozida)', prot: 0.6, carb: 30, fat: 0.3, per: 100, unit: 'g', kcal: 125 },
    { name: 'Aveia em flocos', prot: 13.9, carb: 66.3, fat: 6.9, per: 100, unit: 'g', kcal: 394 },
    { name: 'PÃ£o francÃªs', prot: 8, carb: 58, fat: 3.1, per: 50, unit: 'g (1 unid)', kcal: 300 },
    { name: 'PÃ£o integral', prot: 9, carb: 49, fat: 3.5, per: 100, unit: 'g', kcal: 265 },
    { name: 'MacarrÃ£o (cozido)', prot: 5, carb: 30, fat: 0.9, per: 100, unit: 'g', kcal: 157 },
    { name: 'Tapioca (crepioca)', prot: 0.2, carb: 26, fat: 0, per: 100, unit: 'g', kcal: 98 },
    { name: 'Banana (prata)', prot: 1.3, carb: 26, fat: 0.1, per: 100, unit: 'g', kcal: 98 },
    { name: 'MaÃ§Ã£', prot: 0.3, carb: 14, fat: 0.2, per: 100, unit: 'g', kcal: 52 },
    { name: 'Quinoa (cozida)', prot: 4.4, carb: 21.3, fat: 1.9, per: 100, unit: 'g', kcal: 120 },
  ],
  gorduras: [
    { name: 'Azeite de oliva extra virgem', prot: 0, carb: 0, fat: 13.5, per: 15, unit: 'ml (1 col sopa)', kcal: 120 },
    { name: 'Ã“leo de coco', prot: 0, carb: 0, fat: 13.6, per: 15, unit: 'ml (1 col sopa)', kcal: 120 },
    { name: 'Manteiga', prot: 0.6, carb: 0.1, fat: 11.5, per: 15, unit: 'g (1 col sopa)', kcal: 102 },
    { name: 'Amendoim', prot: 26, carb: 16, fat: 49, per: 100, unit: 'g', kcal: 567 },
    { name: 'Pasta de amendoim', prot: 25, carb: 20, fat: 50, per: 100, unit: 'g', kcal: 588 },
    { name: 'Castanha do ParÃ¡', prot: 14, carb: 12, fat: 67, per: 100, unit: 'g', kcal: 656 },
    { name: 'Castanha de caju', prot: 18, carb: 30, fat: 43, per: 100, unit: 'g', kcal: 553 },
    { name: 'AmÃªndoas', prot: 21, carb: 22, fat: 50, per: 100, unit: 'g', kcal: 579 },
    { name: 'Abacate', prot: 2, carb: 9, fat: 15, per: 100, unit: 'g', kcal: 160 },
    { name: 'Coco ralado', prot: 3.3, carb: 15, fat: 33, per: 100, unit: 'g', kcal: 354 },
    { name: 'Semente de chia', prot: 17, carb: 42, fat: 31, per: 100, unit: 'g', kcal: 486 },
    { name: 'Semente de linhaÃ§a', prot: 18, carb: 29, fat: 42, per: 100, unit: 'g', kcal: 534 },
  ],
  vegetais: [
    { name: 'BrÃ³colis (cozido)', prot: 2.4, carb: 4, fat: 0.4, per: 100, unit: 'g', kcal: 35 },
    { name: 'Couve-flor (cozida)', prot: 1.8, carb: 2.3, fat: 0.5, per: 100, unit: 'g', kcal: 23 },
    { name: 'Espinafre (cru)', prot: 2.9, carb: 1.4, fat: 0.4, per: 100, unit: 'g', kcal: 23 },
    { name: 'Alface', prot: 1.4, carb: 2.3, fat: 0.2, per: 100, unit: 'g', kcal: 15 },
    { name: 'Tomate', prot: 1.1, carb: 3.9, fat: 0.2, per: 100, unit: 'g', kcal: 18 },
    { name: 'Cenoura (crua)', prot: 0.9, carb: 10, fat: 0.2, per: 100, unit: 'g', kcal: 41 },
    { name: 'AbÃ³bora (cozida)', prot: 1.2, carb: 6.5, fat: 0.1, per: 100, unit: 'g', kcal: 30 },
  ]
};

/* ----------------------------- Utilities ----------------------------- */
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function parseNumber(value) {
  if (!value && value !== 0) return 0;
  const n = parseFloat(String(value).replace(/[^\d.-]/g, ''));
  return isNaN(n) ? 0 : n;
}

// Combined meal nutrition lookup: prioritize custom meals, then LiveUp marmitas
function getMealNutritionByNameCombined(name) {
  // First check custom meals
  const customMeal = state.customMeals.find(m => m.name === name);
  if (customMeal) {
    return { 
      kcal: parseNumber(customMeal.kcal), 
      prot: parseNumber(customMeal.prot), 
      fat: parseNumber(customMeal.fat) 
    };
  }
  // Then check LiveUp marmitas
  const liveUpMeal = livUpMarmitas.find(m => m.name === name);
  if (liveUpMeal) {
    return { 
      kcal: parseNumber(liveUpMeal.kcal), 
      prot: parseNumber(liveUpMeal.prot), 
      fat: parseNumber(liveUpMeal.fat) 
    };
  }
  // Default values if not found
  return { kcal: 0, prot: 0, fat: 0 };
}

// Legacy function for backward compatibility
function getMealNutritionByName(name) {
  return getMealNutritionByNameCombined(name);
}

/* ----------------------------- Persistence: Save / Load ----------------------------- */
async function saveAllToDB() {
  try {
    // users
    for (const id of Object.keys(state.users)) {
      await dbPut(STORE_USERS, state.users[id]);
    }
    // comparisons
    for (const comp of state.comparisons) {
      await dbPut(STORE_COMPARISONS, comp);
    }
    // references
    for (const ref of state.references) {
      await dbPut(STORE_REFERENCES, ref);
    }
    // settings: store lastSave timestamp
    await dbPut(STORE_SETTINGS, { key: 'lastSave', value: new Date().toISOString() });

    // fallback localStorage
    saveLS('ft_users', state.users);
    saveLS('ft_comparisons', state.comparisons);
    saveLS('ft_references', state.references);
  } catch (err) {
    console.error('saveAllToDB error', err);
  }
}

async function loadAllFromDB() {
  let users = {};
  let comparisons = [];
  let references = [];
  try {
    const dbUsers = await dbGetAll(STORE_USERS);
    const dbComparisons = await dbGetAll(STORE_COMPARISONS);
    const dbReferences = await dbGetAll(STORE_REFERENCES);
    if (dbUsers && dbUsers.length) dbUsers.forEach(u => users[u.id] = u);
    if (dbComparisons && dbComparisons.length) comparisons = dbComparisons;
    if (dbReferences && dbReferences.length) references = dbReferences;
  } catch (err) {
    console.warn('DB load failed, fallback to localStorage', err);
  }

  // fallback localStorage if empty
  if (Object.keys(users).length === 0) {
    const lsUsers = loadLS('ft_users');
    if (lsUsers) users = lsUsers;
  }
  if (!comparisons.length) {
    const lsComparisons = loadLS('ft_comparisons');
    if (lsComparisons) comparisons = lsComparisons;
  }
  if (!references.length) {
    const lsReferences = loadLS('ft_references');
    if (lsReferences) references = lsReferences;
  }

  // Legacy migration: ft_custom_programs
  const legacyPrograms = loadLS('ft_custom_programs');
  if (legacyPrograms && typeof legacyPrograms === 'object') {
    Object.keys(legacyPrograms).forEach(uid => {
      if (!users[uid]) return;
      users[uid].customPrograms = users[uid].customPrograms || {};
      // merge but do not overwrite existing keys
      Object.keys(legacyPrograms[uid]).forEach(k => {
        if (!users[uid].customPrograms[k]) users[uid].customPrograms[k] = legacyPrograms[uid][k];
      });
    });
    // do not delete legacy key automatically
  }

  // If no users exist in DB/LS, seed defaults (but do not overwrite if user has data)
  if (Object.keys(users).length === 0) {
    users = initialUsers;
    comparisons = [];
    references = []; // keep empty until user imports seed references to avoid accidental overwrite
    state.users = users;
    state.comparisons = comparisons;
    state.references = references;
    await saveAllToDB();
  } else {
    state.users = users;
    state.comparisons = comparisons;
    state.references = references;
  }
}

/* ----------------------------- Custom Meals Management -----------------------------
   Load and save custom meals from/to IndexedDB settings store and localStorage fallback
-------------------------------------------------------------------------------------------- */
async function loadCustomMeals() {
  try {
    const customMealsData = await dbGet(STORE_SETTINGS, 'customMeals').catch(() => null);
    if (customMealsData && customMealsData.value) {
      state.customMeals = customMealsData.value;
      return;
    }
  } catch (err) {
    console.warn('Failed to load custom meals from IndexedDB', err);
  }
  
  // Fallback to localStorage
  const lsCustomMeals = loadLS('ft_custom_meals');
  if (lsCustomMeals && Array.isArray(lsCustomMeals)) {
    state.customMeals = lsCustomMeals;
  } else {
    state.customMeals = [];
  }
}

async function saveCustomMeals() {
  try {
    await dbPut(STORE_SETTINGS, { key: 'customMeals', value: state.customMeals });
  } catch (err) {
    console.error('Failed to save custom meals to IndexedDB', err);
  }
  
  // Also save to localStorage as fallback
  saveLS('ft_custom_meals', state.customMeals);
}

/* ----------------------------- Progress Photos Management -----------------------------
   Load and save progress photos from/to IndexedDB settings store and localStorage fallback
-------------------------------------------------------------------------------------------- */
async function loadProgressPhotos() {
  const user = state.users[state.activeUser];
  if (!user) return;
  
  if (!user.progressPhotos) {
    user.progressPhotos = [];
  }
  state.progressPhotos = user.progressPhotos;
}

async function saveProgressPhotos() {
  const user = state.users[state.activeUser];
  if (!user) return;
  
  user.progressPhotos = state.progressPhotos;
  addOrUpdateUser(user);
}

function handleAddProgressPhoto(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const date = formData.get('photoDate');
  const notes = formData.get('photoNotes');
  const fileInput = document.querySelector('input[name="photoFile"]');
  const file = fileInput.files[0];
  
  if (!date || !file) {
    alert('Data e foto sÃ£o obrigatÃ³rios');
    return;
  }
  
  // Check file size (limit to 5MB)
  if (file.size > 5 * 1024 * 1024) {
    alert('A foto Ã© muito grande. MÃ¡ximo 5MB.');
    return;
  }
  
  // Read the file as base64
  const reader = new FileReader();
  reader.onload = async function(event) {
    const photoData = {
      id: 'photo_' + Date.now(),
      date: date,
      notes: notes || '',
      imageData: event.target.result,
      uploadedAt: new Date().toISOString()
    };
    
    state.progressPhotos.push(photoData);
    await saveProgressPhotos();
    
    showNotification('âœ… Foto de progresso adicionada com sucesso!', 'success');
    e.target.reset();
    render();
  };
  reader.readAsDataURL(file);
}

function handleDeleteProgressPhoto(photoId) {
  if (!confirm('Deseja excluir esta foto de progresso?')) return;
  
  state.progressPhotos = state.progressPhotos.filter(p => p.id !== photoId);
  saveProgressPhotos();
  showNotification('âœ… Foto excluÃ­da', 'success');
  render();
}

/* ----------------------------- Soft-delete / Archive workflow -----------------------------
   Instead of permanently deleting, we move to 'archive' store with metadata:
     { id, originStore, originId, type, payload, deletedAt, deletedBy }
   Only with explicit user action "Excluir permanentemente do arquivo" will we remove it from 'archive'.
---------------------------------------------------------------------------------------------- */
async function archiveItem(originStore, originId, type, payload) {
  const archiveId = `arch_${type}_${originId}_${Date.now()}`;
  const item = {
    id: archiveId,
    originStore,
    originId,
    type,
    payload,
    deletedAt: new Date().toISOString(),
    deletedBy: state.activeUser || 'system'
  };
  await dbPut(STORE_ARCHIVE, item);
  return item;
}

async function softDeleteUser(userId) {
  if (!confirm('Tem certeza que deseja mover este perfil para o arquivo (archive)? Isso preservarÃ¡ os dados no archive.')) return;
  const user = state.users[userId];
  if (!user) { alert('Perfil nÃ£o encontrado'); return; }
  // move to archive
  await archiveItem(STORE_USERS, userId, 'user', user);
  // delete from users store and state
  delete state.users[userId];
  try { await dbDelete(STORE_USERS, userId); } catch (e) {}
  saveLS('ft_users', state.users);
  updateState({ users: state.users });
  alert('âœ… Perfil movido para arquivo (archive). Para excluir permanentemente vÃ¡ na aba CiÃªncia â†’ Gerenciar arquivo.');
}

/* ----------------------------- State helpers ----------------------------- */
function updateState(newState) {
  state = { ...state, ...newState };
  saveAllToDB();
  render();
}

function addOrUpdateUser(user) {
  state.users[user.id] = user;
  updateState({ users: state.users });
}

function removeUserPermanentlyFromArchive(archiveId) {
  // Will delete entry permanently from archive - only after explicit confirmation
  if (!confirm('Excluir permanentemente este item do arquivo? Esta aÃ§Ã£o NÃƒO pode ser desfeita.')) return;
  dbDelete(STORE_ARCHIVE, archiveId).then(() => alert('Item excluÃ­do permanentemente do archive')).catch(err => alert('Erro ao excluir: ' + err));
}

/* ----------------------------- Exercise History and Analytics ----------------------------- */
function getExerciseHistory(user, exerciseName) {
  if (!user.workoutHistory) return [];
  
  return user.workoutHistory
    .filter(w => w.exercise === exerciseName)
    .sort((a, b) => new Date(a.date) - new Date(b.date));
}

function getAllUniqueExercises(user) {
  if (!user.workoutHistory) return [];
  
  const exercises = new Set();
  user.workoutHistory.forEach(w => {
    if (w.exercise) exercises.add(w.exercise);
  });
  
  return Array.from(exercises).sort();
}

function getExerciseStats(user, exerciseName) {
  const history = getExerciseHistory(user, exerciseName);
  
  if (history.length === 0) {
    return {
      totalWorkouts: 0,
      firstWorkout: null,
      lastWorkout: null,
      maxWeight: 0,
      maxReps: 0,
      maxVolume: 0
    };
  }
  
  let maxWeight = 0;
  let maxReps = 0;
  let maxVolume = 0;
  
  history.forEach(w => {
    const weight = parseNumber(w.weight);
    const reps = parseNumber(w.reps);
    const sets = parseNumber(w.sets);
    const volume = weight * reps * sets;
    
    if (weight > maxWeight) maxWeight = weight;
    if (reps > maxReps) maxReps = reps;
    if (volume > maxVolume) maxVolume = volume;
  });
  
  return {
    totalWorkouts: history.length,
    firstWorkout: history[0].date,
    lastWorkout: history[history.length - 1].date,
    maxWeight: maxWeight,
    maxReps: maxReps,
    maxVolume: maxVolume
  };
}

/* ----------------------------- Handlers (workout / meal / metrics) ----------------------------- */
function handleLogWorkout(exerciseName, sets = '', reps = '', weight = '', category = '') {
  const user = state.users[state.activeUser];
  if (!user) return alert('Nenhum usuÃ¡rio ativo');
  
  const newLog = {
    id: Date.now(),
    date: state.currentWorkoutDay, // Use selected day instead of today
    time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
    exercise: exerciseName,
    category: category || '',
    sets: sets || '-',
    reps: reps || '-',
    weight: weight || '-',
    completed: true
  };
  
  if (!user.workoutHistory) user.workoutHistory = [];
  user.workoutHistory.unshift(newLog);
  addOrUpdateUser(user);
  
  // Show success notification
  const details = sets && reps ? ` (${sets}x${reps}${weight ? ' @ ' + weight + 'kg' : ''})` : '';
  showNotification(`âœ… ExercÃ­cio registrado: ${exerciseName}${details}`, 'success');
  render();
}

function handleEditWorkout(id) {
  const user = state.users[state.activeUser];
  if (!user.workoutHistory) user.workoutHistory = [];
  const log = user.workoutHistory.find(l => l.id === id);
  if (!log) return alert('Registro nÃ£o encontrado');
  
  // Prompt for new values
  const newSets = prompt(`Editar SÃ©ries\nExercÃ­cio: ${log.exercise}\n\nSÃ©ries atuais: ${log.sets}`, log.sets === '-' ? '' : log.sets);
  if (newSets === null) return; // User cancelled
  
  const newReps = prompt(`Editar RepetiÃ§Ãµes\nExercÃ­cio: ${log.exercise}\n\nRepetiÃ§Ãµes atuais: ${log.reps}`, log.reps === '-' ? '' : log.reps);
  if (newReps === null) return; // User cancelled
  
  const newWeight = prompt(`Editar Carga (kg)\nExercÃ­cio: ${log.exercise}\n\nCarga atual: ${log.weight}`, log.weight === '-' ? '' : log.weight);
  if (newWeight === null) return; // User cancelled
  
  // Update the workout log
  log.sets = newSets || '-';
  log.reps = newReps || '-';
  log.weight = newWeight || '-';
  
  addOrUpdateUser(user);
  
  // Show success notification
  const details = newSets && newReps ? ` (${newSets}x${newReps}${newWeight ? ' @ ' + newWeight + 'kg' : ''})` : '';
  showNotification(`âœ… Treino atualizado: ${log.exercise}${details}`, 'success');
  render();
}

function handleDeleteWorkout(id) {
  if (!confirm('Deseja excluir este registro de treino? Ele serÃ¡ movido para o arquivo (archive) e poderÃ¡ ser restaurado.')) return;
  const user = state.users[state.activeUser];
  if (!user.workoutHistory) user.workoutHistory = [];
  const log = user.workoutHistory.find(l => l.id === id);
  if (!log) return alert('Registro nÃ£o encontrado');
  archiveItem('workoutHistory', id, 'workout', log).then(() => {
    user.workoutHistory = user.workoutHistory.filter(l => l.id !== id);
    addOrUpdateUser(user);
    showNotification('âœ… Registro de treino excluÃ­do e movido para archive', 'success');
    render();
  });
}

function handleLogMeal(mealName) {
  const user = state.users[state.activeUser];
  if (!user) return alert('Nenhum usuÃ¡rio ativo');
  // Use currentDay for meal logging, make meal name safe for storage
  const safeMealName = String(mealName); // Ensure it's a string, handles special characters
  const newLog = { 
    id: Date.now(), 
    date: state.currentDay, // Use selected day instead of today
    time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), 
    meal: safeMealName 
  };
  user.mealHistory.unshift(newLog);
  addOrUpdateUser(user);
  
  // Show success notification
  const nut = getMealNutritionByNameCombined(safeMealName);
  const nutInfo = nut.kcal > 0 ? ` (${nut.kcal} kcal)` : '';
  showNotification(`âœ… RefeiÃ§Ã£o registrada: ${safeMealName}${nutInfo}`, 'success');
}

function handleDeleteMeal(id) {
  if (!confirm('Deseja excluir este registro de refeiÃ§Ã£o? Ele serÃ¡ movido para o arquivo (archive) e poderÃ¡ ser restaurado.')) return;
  const user = state.users[state.activeUser];
  const item = user.mealHistory.find(m => m.id === id);
  if (!item) return alert('Registro nÃ£o encontrado');
  archiveItem('mealHistory', id, 'meal', item).then(() => {
    user.mealHistory = user.mealHistory.filter(m => m.id !== id);
    addOrUpdateUser(user);
    showNotification('âœ… Registro de refeiÃ§Ã£o excluÃ­do e movido para archive', 'success');
  });
}

/* ----------------------------- Notification System ----------------------------- */
function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `fixed top-20 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-semibold transform transition-all duration-300 ${
    type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
  }`;
  notification.textContent = message;
  notification.style.opacity = '0';
  notification.style.transform = 'translateY(-20px)';
  
  document.body.appendChild(notification);
  
  // Animate in
  setTimeout(() => {
    notification.style.opacity = '1';
    notification.style.transform = 'translateY(0)';
  }, 10);
  
  // Animate out and remove
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translateY(-20px)';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

/* ----------------------------- Day navigation for meals ----------------------------- */
function setCurrentDay(dateString) {
  state.currentDay = dateString;
  render();
}

function goToPreviousDay() {
  const current = new Date(state.currentDay);
  current.setDate(current.getDate() - 1);
  state.currentDay = current.toISOString().split('T')[0];
  render();
}

function goToNextDay() {
  const current = new Date(state.currentDay);
  current.setDate(current.getDate() + 1);
  state.currentDay = current.toISOString().split('T')[0];
  render();
}

function goToToday() {
  state.currentDay = new Date().toISOString().split('T')[0];
  render();
}

/* ----------------------------- Workout Day Navigation ----------------------------- */
function goToPreviousWorkoutDay() {
  const current = new Date(state.currentWorkoutDay);
  current.setDate(current.getDate() - 1);
  state.currentWorkoutDay = current.toISOString().split('T')[0];
  render();
}

function goToNextWorkoutDay() {
  const current = new Date(state.currentWorkoutDay);
  current.setDate(current.getDate() + 1);
  state.currentWorkoutDay = current.toISOString().split('T')[0];
  render();
}

function goToTodayWorkout() {
  state.currentWorkoutDay = new Date().toISOString().split('T')[0];
  render();
}

/* ----------------------------- Exercise Library ----------------------------- */
const EXERCISE_LIBRARY = [
  // Peito
  { name: 'Supino reto', category: 'Peito', equipment: 'Barra' },
  { name: 'Supino inclinado', category: 'Peito', equipment: 'Barra' },
  { name: 'Supino declinado', category: 'Peito', equipment: 'Barra' },
  { name: 'Crucifixo', category: 'Peito', equipment: 'Halteres' },
  { name: 'Fly (peck deck)', category: 'Peito', equipment: 'MÃ¡quina' },
  { name: 'FlexÃ£o', category: 'Peito', equipment: 'Peso corporal' },
  
  // Costas
  { name: 'Barra fixa', category: 'Costas', equipment: 'Peso corporal' },
  { name: 'Puxada frontal', category: 'Costas', equipment: 'MÃ¡quina' },
  { name: 'Remada curvada', category: 'Costas', equipment: 'Barra' },
  { name: 'Remada unilateral', category: 'Costas', equipment: 'Halter' },
  { name: 'Remada sentado', category: 'Costas', equipment: 'MÃ¡quina' },
  { name: 'Levantamento terra', category: 'Costas', equipment: 'Barra' },
  { name: 'Pullover', category: 'Costas', equipment: 'Halter' },
  
  // Ombros
  { name: 'Desenvolvimento militar', category: 'Ombros', equipment: 'Barra' },
  { name: 'Desenvolvimento com halteres', category: 'Ombros', equipment: 'Halteres' },
  { name: 'ElevaÃ§Ã£o lateral', category: 'Ombros', equipment: 'Halteres' },
  { name: 'ElevaÃ§Ã£o frontal', category: 'Ombros', equipment: 'Halteres' },
  { name: 'Remada alta', category: 'Ombros', equipment: 'Barra' },
  { name: 'Crucifixo inverso', category: 'Ombros', equipment: 'Halteres' },
  
  // BÃ­ceps
  { name: 'Rosca direta', category: 'BÃ­ceps', equipment: 'Barra' },
  { name: 'Rosca alternada', category: 'BÃ­ceps', equipment: 'Halteres' },
  { name: 'Rosca martelo', category: 'BÃ­ceps', equipment: 'Halteres' },
  { name: 'Rosca concentrada', category: 'BÃ­ceps', equipment: 'Halter' },
  { name: 'Rosca scott', category: 'BÃ­ceps', equipment: 'Barra W' },
  
  // TrÃ­ceps
  { name: 'TrÃ­ceps testa', category: 'TrÃ­ceps', equipment: 'Barra' },
  { name: 'TrÃ­ceps francÃªs', category: 'TrÃ­ceps', equipment: 'Halter' },
  { name: 'TrÃ­ceps corda', category: 'TrÃ­ceps', equipment: 'Polia' },
  { name: 'TrÃ­ceps banco', category: 'TrÃ­ceps', equipment: 'Peso corporal' },
  { name: 'Mergulho', category: 'TrÃ­ceps', equipment: 'Paralelas' },
  
  // Pernas
  { name: 'Agachamento livre', category: 'Pernas', equipment: 'Barra' },
  { name: 'Leg press 45Â°', category: 'Pernas', equipment: 'MÃ¡quina' },
  { name: 'Cadeira extensora', category: 'Pernas', equipment: 'MÃ¡quina' },
  { name: 'Cadeira flexora', category: 'Pernas', equipment: 'MÃ¡quina' },
  { name: 'Stiff', category: 'Pernas', equipment: 'Barra' },
  { name: 'AvanÃ§o (afundo)', category: 'Pernas', equipment: 'Halteres' },
  { name: 'Agachamento sumÃ´', category: 'Pernas', equipment: 'Halter' },
  { name: 'Panturrilha em pÃ©', category: 'Pernas', equipment: 'MÃ¡quina' },
  { name: 'Panturrilha sentado', category: 'Pernas', equipment: 'MÃ¡quina' },
  
  // AbdÃ´men
  { name: 'Abdominal supra', category: 'AbdÃ´men', equipment: 'Peso corporal' },
  { name: 'Abdominal infra', category: 'AbdÃ´men', equipment: 'Peso corporal' },
  { name: 'Prancha', category: 'AbdÃ´men', equipment: 'Peso corporal' },
  { name: 'Abdominal oblÃ­quo', category: 'AbdÃ´men', equipment: 'Peso corporal' },
  { name: 'Roda abdominal', category: 'AbdÃ´men', equipment: 'Roda' }
];

/* ----------------------------- Custom meal handlers ----------------------------- */
function handleAddCustomMeal(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const name = formData.get('customMealName');
  const kcal = formData.get('customMealKcal');
  const prot = formData.get('customMealProt');
  const fat = formData.get('customMealFat');
  const saveAsReusable = formData.get('saveAsReusable') === 'on';
  
  if (!name || !kcal) {
    alert('Nome e calorias sÃ£o obrigatÃ³rios');
    return;
  }
  
  // Check if already exists
  const exists = state.customMeals.find(m => m.name === name);
  if (exists && !confirm('JÃ¡ existe uma refeiÃ§Ã£o com este nome. Deseja substituir?')) {
    return;
  }
  
  const customMeal = {
    id: `custom_meal_${Date.now()}`,
    name: name.trim(),
    kcal: parseFloat(kcal) || 0,
    prot: parseFloat(prot) || 0,
    fat: parseFloat(fat) || 0,
    createdAt: new Date().toISOString(),
    createdBy: state.activeUser
  };
  
  if (saveAsReusable) {
    // Remove existing if updating
    state.customMeals = state.customMeals.filter(m => m.name !== name);
    state.customMeals.push(customMeal);
    saveCustomMeals();
  }
  
  // Always log the meal to current day
  handleLogMeal(name.trim());
  
  // Reset form
  e.target.reset();
  
  if (saveAsReusable) {
    showNotification('âœ… RefeiÃ§Ã£o personalizada salva e registrada!', 'success');
  }
}

function handleDeleteCustomMeal(mealId) {
  if (!confirm('Deseja excluir esta refeiÃ§Ã£o personalizada permanentemente?')) return;
  state.customMeals = state.customMeals.filter(m => m.id !== mealId);
  saveCustomMeals();
  showNotification('âœ… RefeiÃ§Ã£o personalizada excluÃ­da', 'success');
  render();
}

/* ----------------------------- Nutrition Calculator Functions ----------------------------- */
function selectFood(category, index) {
  const food = commonFoods[category][index];
  
  // Fill calculator with food data
  document.getElementById('calcFoodName').value = food.name;
  document.getElementById('calcWeight').value = food.per;
  document.getElementById('calcProtPer100').value = (food.prot * 100 / food.per).toFixed(1);
  document.getElementById('calcCarbPer100').value = (food.carb * 100 / food.per).toFixed(1);
  document.getElementById('calcFatPer100').value = (food.fat * 100 / food.per).toFixed(1);
  
  // Scroll to calculator
  document.getElementById('calcFoodName').scrollIntoView({ behavior: 'smooth', block: 'center' });
  
  // Show success notification
  showNotification(`âœ… Alimento selecionado: ${food.name}`, 'success');
}

function filterFoods() {
  const searchTerm = document.getElementById('foodSearchInput').value.toLowerCase();
  const foodItems = document.querySelectorAll('.food-item');
  const categories = document.querySelectorAll('.food-category');
  
  foodItems.forEach(item => {
    const foodName = item.getAttribute('data-food-name').toLowerCase();
    if (foodName.includes(searchTerm)) {
      item.style.display = 'block';
    } else {
      item.style.display = 'none';
    }
  });
  
  // Hide categories with no visible items
  categories.forEach(category => {
    const visibleItems = Array.from(category.querySelectorAll('.food-item')).filter(item => item.style.display !== 'none');
    if (visibleItems.length === 0 && searchTerm !== '') {
      category.style.display = 'none';
    } else {
      category.style.display = 'block';
    }
  });
}

function calculateMacros() {
  const foodName = document.getElementById('calcFoodName').value;
  const weight = parseFloat(document.getElementById('calcWeight').value);
  const protPer100 = parseFloat(document.getElementById('calcProtPer100').value) || 0;
  const carbPer100 = parseFloat(document.getElementById('calcCarbPer100').value) || 0;
  const fatPer100 = parseFloat(document.getElementById('calcFatPer100').value) || 0;
  
  if (!weight || weight <= 0) {
    alert('Por favor, insira um peso vÃ¡lido em gramas');
    return;
  }
  
  // Calculate multiplier (weight / 100)
  const multiplier = weight / 100;
  
  // Calculate macros for the given weight
  const proteinGrams = (protPer100 * multiplier).toFixed(1);
  const carbGrams = (carbPer100 * multiplier).toFixed(1);
  const fatGrams = (fatPer100 * multiplier).toFixed(1);
  
  // Calculate calories (protein: 4kcal/g, carbs: 4kcal/g, fat: 9kcal/g)
  const proteinKcal = (proteinGrams * 4).toFixed(1);
  const carbKcal = (carbGrams * 4).toFixed(1);
  const fatKcal = (fatGrams * 9).toFixed(1);
  const totalKcal = (parseFloat(proteinKcal) + parseFloat(carbKcal) + parseFloat(fatKcal)).toFixed(1);
  
  // Update results
  document.getElementById('resultProt').textContent = proteinGrams + 'g';
  document.getElementById('resultProtKcal').textContent = proteinKcal + ' kcal';
  document.getElementById('resultCarb').textContent = carbGrams + 'g';
  document.getElementById('resultCarbKcal').textContent = carbKcal + ' kcal';
  document.getElementById('resultFat').textContent = fatGrams + 'g';
  document.getElementById('resultFatKcal').textContent = fatKcal + ' kcal';
  document.getElementById('resultTotal').textContent = totalKcal + ' kcal';
  
  // Show results
  document.getElementById('calcResults').classList.remove('hidden');
  
  // Show success notification
  showNotification(`âœ… Calculado: ${weight}g de ${foodName || 'alimento'} = ${totalKcal} kcal`, 'success');
}

function fillCalculatorExample(name, weight, prot, carb, fat) {
  document.getElementById('calcFoodName').value = name;
  document.getElementById('calcWeight').value = weight;
  document.getElementById('calcProtPer100').value = prot;
  document.getElementById('calcCarbPer100').value = carb;
  document.getElementById('calcFatPer100').value = fat;
  
  // Auto-calculate
  calculateMacros();
  
  // Scroll to calculator
  document.getElementById('calcFoodName').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

/* ----------------------------- Custom workout handler ----------------------------- */
function handleAddCustomWorkout(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const exercise = formData.get('customExercise');
  const sets = formData.get('customSets');
  const reps = formData.get('customReps');
  const weight = formData.get('customWeight');
  
  if (!exercise) {
    alert('Nome do exercÃ­cio Ã© obrigatÃ³rio');
    return;
  }
  
  handleLogWorkout(exercise, sets, reps, weight);
  e.target.reset();
}

/* ----------------------------- BMR calculation ----------------------------- */
function calculateBMR(weightKg, heightCm, age, gender) {
  const base = 10 * weightKg + 6.25 * heightCm - 5 * age;
  return Math.round(base + (gender === 'female' ? -161 : 5));
}

/* ----------------------------- Metrics add/delete ----------------------------- */
function handleAddMetrics(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const weight = parseFloat(formData.get('weight'));
  const heightCm = state.users[state.activeUser].height;
  const age = state.users[state.activeUser].age || 30;
  const gender = state.users[state.activeUser].gender || 'male';
  const waterPercent = parseFloat(formData.get('waterPercent')) || 0;
  const muscleSize = parseFloat(formData.get('muscleSize')) || 0;
  const bmr = formData.get('bmr') ? parseFloat(formData.get('bmr')) : calculateBMR(weight, heightCm, age, gender);
  const waterWeight = parseFloat((weight * (waterPercent / 100)).toFixed(2));
  
  const newMetric = {
    id: Date.now().toString(),
    date: formData.get('date'),
    weight: weight,
    bodyFat: parseFloat(formData.get('bodyFat')),
    muscleMass: parseFloat(formData.get('muscleMass')),
    visceralFat: parseFloat(formData.get('visceralFat')) || 0,
    waterPercent: waterPercent,
    waterWeight: waterWeight,
    bmr: bmr,
    muscleSize: muscleSize,
    bmi: parseFloat((weight / Math.pow(heightCm / 100, 2)).toFixed(1)),
    
    // Segmented muscle mass
    muscleMassRightArm: parseFloat(formData.get('muscleMassRightArm')) || 0,
    muscleMassLeftArm: parseFloat(formData.get('muscleMassLeftArm')) || 0,
    muscleMassRightLeg: parseFloat(formData.get('muscleMassRightLeg')) || 0,
    muscleMassLeftLeg: parseFloat(formData.get('muscleMassLeftLeg')) || 0,
    muscleMassTrunk: parseFloat(formData.get('muscleMassTrunk')) || 0,
    
    // Segmented body fat
    bodyFatRightArm: parseFloat(formData.get('bodyFatRightArm')) || 0,
    bodyFatLeftArm: parseFloat(formData.get('bodyFatLeftArm')) || 0,
    bodyFatRightLeg: parseFloat(formData.get('bodyFatRightLeg')) || 0,
    bodyFatLeftLeg: parseFloat(formData.get('bodyFatLeftLeg')) || 0,
    bodyFatTrunk: parseFloat(formData.get('bodyFatTrunk')) || 0,
    
    // Advanced body composition
    boneMass: parseFloat(formData.get('boneMass')) || 0,
    proteinMass: parseFloat(formData.get('proteinMass')) || 0,
    mineralMass: parseFloat(formData.get('mineralMass')) || 0,
    
    // Metabolic rates
    rmr: parseFloat(formData.get('rmr')) || 0,
    tdee: parseFloat(formData.get('tdee')) || 0,
    
    // Bioelectrical impedance
    impedance: parseFloat(formData.get('impedance')) || 0,
    phaseAngle: parseFloat(formData.get('phaseAngle')) || 0,
    reactance: parseFloat(formData.get('reactance')) || 0,
    resistance: parseFloat(formData.get('resistance')) || 0,
    
    // Ages
    metabolicAge: parseInt(formData.get('metabolicAge')) || 0,
    bodyAge: parseInt(formData.get('bodyAge')) || 0,
    
    // Circumferences
    chest: parseFloat(formData.get('chest')) || 0,
    waist: parseFloat(formData.get('waist')) || 0,
    hips: parseFloat(formData.get('hips')) || 0,
    rightArm: parseFloat(formData.get('rightArm')) || 0,
    leftArm: parseFloat(formData.get('leftArm')) || 0,
    rightThigh: parseFloat(formData.get('rightThigh')) || 0,
    leftThigh: parseFloat(formData.get('leftThigh')) || 0,
    rightCalf: parseFloat(formData.get('rightCalf')) || 0,
    leftCalf: parseFloat(formData.get('leftCalf')) || 0,
    neck: parseFloat(formData.get('neck')) || 0,
    shoulders: parseFloat(formData.get('shoulders')) || 0
  };
  
  const user = state.users[state.activeUser];
  user.bodyMetrics.push(newMetric);
  user.bodyMetrics.sort((a, b) => new Date(a.date) - new Date(b.date));
  addOrUpdateUser(user);
  
  showNotification('âœ… MediÃ§Ã£o completa adicionada com sucesso!', 'success');
  
  // redraw chart if on evoluÃ§Ã£o
  if (state.activeTab === 'evolucao') setTimeout(() => renderMuscleEvolutionChart(user.bodyMetrics, user.id), 150);
  e.target.reset();
}

/* When deleting a metric, move it to archive rather than permanently delete */
function handleDeleteMetric(metricId) {
  if (!confirm('Deseja excluir esta medida? Ela serÃ¡ movida para o arquivo (archive) e poderÃ¡ ser restaurada.')) return;
  const user = state.users[state.activeUser];
  const metric = user.bodyMetrics.find(m => m.id === metricId);
  if (!metric) return alert('Medida nÃ£o encontrada');
  archiveItem('bodyMetrics', metricId, 'metric', metric).then(() => {
    user.bodyMetrics = user.bodyMetrics.filter(m => m.id !== metricId);
    addOrUpdateUser(user);
    showNotification('âœ… Medida excluÃ­da e movida para archive', 'success');
  });
}

/* ----------------------------- Profiles handlers ----------------------------- */
function handleAddProfile() {
  const name = prompt('Nome do novo perfil: (ex: JoÃ£o)');
  if (!name) return;
  const gender = prompt('GÃªnero (male/female):', 'male') || 'male';
  const age = parseInt(prompt('Idade:', '25')) || 25;
  const height = parseInt(prompt('Altura em cm:', '170')) || 170;
  const idBase = name.trim().toLowerCase().replace(/\s+/g, '_');
  const id = `${idBase}_${Date.now()}`;
  const user = {
    id,
    name,
    gender: gender === 'female' ? 'female' : 'male',
    age,
    height,
    workoutHistory: [],
    mealHistory: [],
    bodyMetrics: [{
      id: 'm_' + Date.now(),
      date: new Date().toISOString().split('T')[0],
      weight: 0,
      bodyFat: 0,
      muscleMass: 0,
      visceralFat: 0,
      waterPercent: 0,
      waterWeight: 0,
      bmr: calculateBMR(0, height, age, gender),
      muscleSize: 0,
      bmi: 0
    }],
    goals: { weight: 0, bodyFat: 0, muscleMass: 0 },
    customPrograms: {}
  };
  addOrUpdateUser(user);
  alert('âœ… Perfil criado: ' + name);
}

/* Soft-delete profile (moves to archive), never removes without explicit user's permanent deletion action */
function handleDeleteProfile(userId) {
  if (!confirm('Deseja mover este perfil para archive (preservarÃ¡ TODOS os registros)?')) return;
  const user = state.users[userId];
  if (!user) return alert('Perfil nÃ£o encontrado');
  archiveItem(STORE_USERS, userId, 'user', user).then(() => {
    delete state.users[userId];
    try { dbDelete(STORE_USERS, userId).catch(()=>{}); } catch(e){}
    saveLS('ft_users', state.users);
    updateState({ users: state.users });
    alert('âœ… Perfil movido para archive. Para excluir permanentemente vÃ¡ no archive e remova manualmente.');
  });
}

/* ----------------------------- Templates application & custom programs ----------------------------- */
function applyTemplateToUser(templateId, userId) {
  const tmpl = templates[templateId];
  if (!tmpl) return alert('Template nÃ£o encontrado');
  const user = state.users[userId];
  if (!user) return alert('UsuÃ¡rio nÃ£o encontrado');
  user.customPrograms = user.customPrograms || {};
  user.customPrograms[tmpl.id] = JSON.parse(JSON.stringify(tmpl)); // deep copy
  addOrUpdateUser(user);
  alert(`âœ… Template "${tmpl.name}" aplicado e salvo no perfil ${user.name}.`);
}

function removeUserProgram(userId, programId) {
  const user = state.users[userId];
  if (!user || !user.customPrograms) return;
  if (!confirm('Remover este programa do perfil? (nÃ£o exclui do archive)')) return;
  delete user.customPrograms[programId];
  addOrUpdateUser(user);
  alert('âœ… Programa removido do perfil.');
}

/* ----------------------------- References import / export / clear ----------------------------- */
function importScientificStudiesSeed() {
  const idsExisting = new Set(state.references.map(r => r.id));
  let added = 0;
  scientificStudiesSeed.forEach(ref => {
    if (!idsExisting.has(ref.id)) {
      state.references.push(ref);
      added++;
    }
  });
  if (added > 0) {
    saveAllToDB();
    alert(`âœ… Importados ${added} estudos (2020 â†’ 2025-11).`);
  } else {
    alert('â„¹ï¸ Estudos jÃ¡ importados anteriormente.');
  }
  render();
}

function exportReferencesJSON() {
  const dataStr = JSON.stringify(state.references, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `studies_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function clearReferences() {
  if (!confirm('Deseja mover todas as referÃªncias para archive? Elas ficarÃ£o preservadas em archive.')) return;
  // move each to archive
  Promise.all(state.references.map(r => archiveItem(STORE_REFERENCES, r.id, 'reference', r))).then(() => {
    state.references = [];
    saveAllToDB();
    alert('âœ… ReferÃªncias movidas para archive.local');
    render();
  }).catch(err => alert('Erro ao mover referÃªncias para archive: ' + err));
}

/* ----------------------------- Export muscle evolution CSV ----------------------------- */
function exportMuscleEvolutionCSV(userId) {
  const user = state.users[userId];
  if (!user) return alert('UsuÃ¡rio nÃ£o encontrado');
  const rows = [['date','weight','bodyFat','muscleMass','muscleSize','waterWeight','bmr']];
  (user.bodyMetrics || []).forEach(m => {
    rows.push([m.date, m.weight, m.bodyFat, m.muscleMass, m.muscleSize, m.waterWeight, m.bmr]);
  });
  const csv = rows.map(r => r.map(cell => (typeof cell === 'string' && cell.includes(',')) ? `"${cell}"` : cell).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${userId}_muscle_evolution_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

/* ----------------------------- References helper for UI ----------------------------- */
function getReferencesByTags(tags) {
  if (!tags || !tags.length) return [];
  const refs = state.references || [];
  return refs.filter(r => r.tags && r.tags.some(t => tags.includes(t)));
}
function getTopReferencesByTags(tags, limit = 3) {
  const matched = getReferencesByTags(tags);
  matched.sort((a, b) => (b.year || 0) - (a.year || 0));
  return matched.slice(0, limit);
}
function renderReferenceLinksHTML(refs) {
  if (!refs || !refs.length) return '';
  return refs.map(r => `<a href="${r.link}" target="_blank" class="text-blue-300 underline">${r.authors} ${r.year}</a>`).join(' â€¢ ');
}
function buildReferenceNotesForWorkout(workoutName) {
  const name = (workoutName || '').toLowerCase();
  let tags = ['training'];
  if (name.includes('hip') || name.includes('glÃºteo') || name.includes('thrust')) tags.push('hypertrophy');
  if (name.includes('agach') || name.includes('leg')) tags.push('volume');
  if (name.includes('supino') || name.includes('press')) tags.push('strength');
  const refs = getTopReferencesByTags(tags);
  if (!refs.length) return '';
  return `Base cientÃ­fica: ${refs.slice(0,3).map(r => `${r.authors} ${r.year}`).join(' â€¢ ')}. ` + renderReferenceLinksHTML(refs);
}
function buildReferenceNotesForNutrition() {
  const refs = getTopReferencesByTags(['nutrition','protein','creatine','diet']);
  if (!refs.length) return '';
  return `ReferÃªncias: ${refs.slice(0,3).map(r => `${r.authors} ${r.year}`).join(' â€¢ ')}. ` + renderReferenceLinksHTML(refs);
}

/* ----------------------------- Event Delegation for Meal Buttons -----------------------------
   This function attaches event listeners to meal registration buttons using event delegation.
   This approach is more robust than inline onclick handlers and handles special characters properly.
------------------------------------------------------------------------------------------------ */
function attachMealButtons() {
  const mealButtons = document.querySelectorAll('.meal-register-btn');
  mealButtons.forEach(btn => {
    // Remove old listener if exists by replacing with a new one
    btn.onclick = function(e) {
      e.preventDefault();
      const mealName = this.getAttribute('data-meal-name');
      if (mealName) {
        handleLogMeal(mealName);
      }
    };
  });
}

function attachMealDeleteButtons() {
  const deleteButtons = document.querySelectorAll('.meal-delete-btn');
  deleteButtons.forEach(btn => {
    btn.onclick = function(e) {
      e.preventDefault();
      const mealId = parseInt(this.getAttribute('data-meal-id'));
      if (mealId) {
        handleDeleteMeal(mealId);
      }
    };
  });
}

function attachWorkoutButtons() {
  const workoutButtons = document.querySelectorAll('.workout-register-btn');
  workoutButtons.forEach(btn => {
    btn.onclick = function(e) {
      e.preventDefault();
      const exercise = this.getAttribute('data-exercise');
      const category = this.getAttribute('data-category');
      
      // Prompt for sets, reps, and weight
      const sets = prompt(`Registrar: ${exercise}\n\nQuantas sÃ©ries vocÃª fez?`, '3');
      if (sets === null) return; // User cancelled
      
      const reps = prompt(`Registrar: ${exercise}\n\nQuantas repetiÃ§Ãµes por sÃ©rie?`, '12');
      if (reps === null) return; // User cancelled
      
      const weight = prompt(`Registrar: ${exercise}\n\nQual carga vocÃª usou? (kg)\nDeixe em branco se nÃ£o aplicÃ¡vel`, '');
      if (weight === null) return; // User cancelled
      
      if (exercise) {
        handleLogWorkout(exercise, sets, reps, weight, category);
      }
    };
  });
}

function attachWorkoutDeleteButtons() {
  const deleteButtons = document.querySelectorAll('.workout-delete-btn');
  deleteButtons.forEach(btn => {
    btn.onclick = function(e) {
      e.preventDefault();
      const workoutId = parseInt(this.getAttribute('data-workout-id'));
      if (workoutId) {
        handleDeleteWorkout(workoutId);
      }
    };
  });
}

/* ----------------------------- RENDER (UI) -----------------------------
   The UI is intentionally verbose and explanatory to ensure clarity for you.
   Buttons that perform deletions will refer to archive workflow; nothing is removed
   permanently without explicit permanent-delete action in archive manager.
----------------------------------------------------------------------------- */

function render() {
  const app = document.getElementById('app');
  
  // Check if user is authenticated
  if (!authState.isAuthenticated) {
    renderLoginPage();
    return;
  }
  
  const currentUser = state.users[state.activeUser] || Object.values(state.users)[0];
  if (!currentUser) {
    app.innerHTML = '<div class="p-8 text-white">Carregando...</div>';
    return;
  }

  const workoutHistory = currentUser.workoutHistory || [];
  const mealHistory = currentUser.mealHistory || [];
  const bodyMetrics = currentUser.bodyMetrics || [];
  const latestMetrics = bodyMetrics[bodyMetrics.length - 1] || { weight: 0, bodyFat: 0, muscleMass: 0, bmi: 0, bmr: 0, waterPercent: 0, waterWeight: 0, muscleSize: 0 };

  app.innerHTML = `
    <header class="bg-black/40 backdrop-blur-lg border-b border-purple-500/30 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">ðŸ’ª Fitness Tracker Pro â€” Full</h1>
          <p class="text-purple-300 text-sm mt-1">UsuÃ¡rio: <strong>${authState.currentAccount.username}</strong> | Email: ${authState.currentAccount.email}</p>
        </div>
        <div class="flex gap-2 items-center">
          ${Object.keys(state.users).map(id => `
            <div class="flex items-center gap-2">
              <button onclick="state.activeUser='${id}'; render();" class="px-4 py-2 rounded-lg font-semibold ${state.activeUser === id ? (state.users[id].gender === 'female' ? 'bg-pink-500 text-white' : 'bg-blue-500 text-white') : 'bg-slate-700 text-slate-300'}">
                ${state.users[id].gender === 'female' ? 'ðŸ‘©' : 'ðŸ‘¨'} ${state.users[id].name}
              </button>
              <button title="Mover perfil para archive" onclick="handleDeleteProfile('${id}')" class="text-red-400 hover:text-red-300 px-2">ðŸ—„ï¸</button>
            </div>
          `).join('')}
          <button onclick="handleAddProfile()" class="px-4 py-2 rounded-lg font-semibold bg-green-600 hover:bg-green-500">âž• Novo Perfil</button>
          <button onclick="handleLogout()" class="px-4 py-2 rounded-lg font-semibold bg-red-600 hover:bg-red-500">ðŸšª Sair</button>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="flex flex-wrap gap-3 mb-6">
        ${['dashboard','treino','exercicios','fotos','nutricao','alimentacao','evolucao','comparacao','ciencia'].map(tab => `
          <button onclick="state.activeTab='${tab}'; render();" class="px-6 py-3 rounded-xl font-semibold ${state.activeTab === tab ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'bg-slate-800/50 text-slate-300'}">
            ${tab === 'dashboard' ? 'ðŸ“Š Dashboard' : tab === 'treino' ? 'ðŸ‹ï¸ Treinos' : tab === 'exercicios' ? 'ðŸ’ª ExercÃ­cios' : tab === 'fotos' ? 'ðŸ“¸ Fotos' : tab === 'nutricao' ? 'ðŸŽ NutriÃ§Ã£o' : tab === 'alimentacao' ? 'ðŸ² AlimentaÃ§Ã£o' : tab === 'evolucao' ? 'ðŸ“ˆ EvoluÃ§Ã£o' : tab === 'comparacao' ? 'âš–ï¸ ComparaÃ§Ã£o' : 'ðŸ”¬ CiÃªncia'}
          </button>
        `).join('')}
        ${isAdmin() ? `
          <div class="w-full my-2"></div>
          <div class="flex items-center gap-2 px-4 py-2 bg-red-900/30 rounded-lg">
            <span class="text-red-400 font-bold">ðŸ‘‘ ADMIN:</span>
          </div>
          ${['admin_tasks','admin_suggestions','admin_security'].map(tab => `
            <button onclick="state.activeTab='${tab}'; render();" class="px-6 py-3 rounded-xl font-semibold ${state.activeTab === tab ? 'bg-gradient-to-r from-red-600 to-orange-600 text-white' : 'bg-slate-800/50 text-slate-300 border border-red-500/30'}">
              ${tab === 'admin_tasks' ? 'ðŸ“‹ Tarefas' : tab === 'admin_suggestions' ? 'ðŸ’¡ SugestÃµes' : 'ðŸ” SeguranÃ§a'}
            </button>
          `).join('')}
        ` : `
          ${['suggestions'].map(tab => `
            <div class="w-full my-2"></div>
            <button onclick="state.activeTab='${tab}'; render();" class="px-6 py-3 rounded-xl font-semibold ${state.activeTab === tab ? 'bg-gradient-to-r from-green-600 to-teal-600 text-white' : 'bg-slate-800/50 text-slate-300'}">
              ðŸ’¡ SugestÃµes
            </button>
          `).join('')}
        `}
      </div>

      <main>
        ${state.activeTab === 'dashboard' ? renderDashboard(currentUser, latestMetrics) : ''}
        ${state.activeTab === 'treino' ? renderTreino(currentUser) : ''}
        ${state.activeTab === 'exercicios' ? renderExercicios(currentUser) : ''}
        ${state.activeTab === 'fotos' ? renderFotosProgresso(currentUser) : ''}
        ${state.activeTab === 'nutricao' ? renderNutricao(currentUser) : ''}
        ${state.activeTab === 'alimentacao' ? renderAlimentacao() : ''}
        ${state.activeTab === 'evolucao' ? renderEvolucao(bodyMetrics, currentUser) : ''}
        ${state.activeTab === 'comparacao' ? renderComparacao() : ''}
        ${state.activeTab === 'ciencia' ? renderCiencia() : ''}
        ${state.activeTab === 'admin_tasks' && isAdmin() ? renderAdminTasks() : ''}
        ${state.activeTab === 'admin_suggestions' && isAdmin() ? renderAdminSuggestions() : ''}
        ${state.activeTab === 'admin_security' && isAdmin() ? renderAdminSecurity() : ''}
        ${state.activeTab === 'suggestions' && !isAdmin() ? renderUserSuggestions() : ''}
      </main>
    </div>

    <footer class="bg-black/60 backdrop-blur-lg border-t border-purple-500/30 py-8 mt-12">
      <div class="max-w-7xl mx-auto px-4 text-center">
        <p class="text-slate-400">VersÃ£o completa: todas as marmitas restauradas; archive/soft-delete implementado; IndexedDB como DB local.</p>
      </div>
    </footer>
  `;

  // after injecting DOM, hook forms / draw chart if needed
  if (state.activeTab === 'evolucao') {
    renderMuscleEvolutionChart(bodyMetrics, currentUser.id);
  }
  
  // Load progress photos for current user
  if (state.activeTab === 'fotos') {
    loadProgressPhotos();
  }

  // attach metric form listener if exists
  const metricsForm = document.getElementById('metricsForm');
  if (metricsForm) metricsForm.addEventListener('submit', handleAddMetrics);
  
  // attach custom meal form listener if in alimentacao tab
  if (state.activeTab === 'alimentacao') {
    const customMealForm = document.getElementById('customMealForm');
    if (customMealForm) customMealForm.addEventListener('submit', handleAddCustomMeal);
    
    // attach meal buttons using event delegation
    attachMealButtons();
    
    // attach delete buttons using event delegation
    attachMealDeleteButtons();
  }
  
  // attach workout form and buttons if in treino tab
  if (state.activeTab === 'treino') {
    const customWorkoutForm = document.getElementById('customWorkoutForm');
    if (customWorkoutForm) customWorkoutForm.addEventListener('submit', handleAddCustomWorkout);
    
    // attach workout buttons using event delegation
    attachWorkoutButtons();
    
    // attach workout delete buttons using event delegation
    attachWorkoutDeleteButtons();
  }
  
  // attach progress photo form if in fotos tab
  if (state.activeTab === 'fotos') {
    const photoForm = document.getElementById('progressPhotoForm');
    if (photoForm) photoForm.addEventListener('submit', handleAddProgressPhoto);
  }
  
  // Admin tabs - load data and attach event listeners
  if (state.activeTab === 'admin_tasks' && isAdmin()) {
    loadAndDisplayTasks();
  }
  
  if (state.activeTab === 'admin_suggestions' && isAdmin()) {
    loadAndDisplayAdminSuggestions();
  }
  
  if (state.activeTab === 'admin_security' && isAdmin()) {
    loadAndDisplaySecurityEvents();
  }
  
  // User suggestions tab
  if (state.activeTab === 'suggestions' && !isAdmin()) {
    loadAndDisplayUserSuggestions();
    const suggestionForm = document.getElementById('suggestionForm');
    if (suggestionForm) suggestionForm.addEventListener('submit', handleSuggestionFormSubmit);
  }
}

/* ----------------------------- SMALL RENDER COMPONENTS ----------------------------- */

function renderDashboard(user, latest) {
  const notes = buildReferenceNotesForNutrition();
  return `
    <div class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div class="md:col-span-2 bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl p-6 text-white shadow-xl">
          <p class="text-blue-200 text-sm mb-2">PESO ATUAL</p>
          <p class="text-4xl font-bold">${latest.weight} kg</p>
          <p class="text-blue-200 text-xs mt-2">Meta: ${user.goals.weight} kg</p>
        </div>
        <div class="bg-gradient-to-br from-red-600 to-red-800 rounded-2xl p-6">
          <p class="text-red-200 text-sm mb-2">GORDURA</p>
          <p class="text-4xl font-bold">${latest.bodyFat}%</p>
        </div>
        <div class="bg-gradient-to-br from-green-600 to-green-800 rounded-2xl p-6">
          <p class="text-green-200 text-sm mb-2">MASSA MUSCULAR</p>
          <p class="text-4xl font-bold">${latest.muscleMass} kg</p>
        </div>
        <div class="bg-gradient-to-br from-yellow-600 to-amber-700 rounded-2xl p-6">
          <p class="text-yellow-200 text-sm mb-2">METABOLISMO BASAL</p>
          <p class="text-2xl font-bold">${latest.bmr || '-' } kcal</p>
        </div>
        <div class="bg-gradient-to-br from-cyan-600 to-sky-700 rounded-2xl p-6">
          <p class="text-cyan-200 text-sm mb-2">ÃGUA</p>
          <p class="text-2xl font-bold">${latest.waterWeight || 0} kg (${latest.waterPercent || 0}%)</p>
        </div>
      </div>

      <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700">
        <h3 class="text-2xl font-bold mb-3">Notas cientÃ­ficas</h3>
        <p class="text-slate-300 text-sm">${notes || 'Importe referÃªncias na aba CIÃŠNCIA para ver notas cientÃ­ficas aplicadas.'}</p>
      </div>
    </div>
  `;
}

function renderTreino(user) {
  if (!user.workoutHistory) user.workoutHistory = [];
  
  // Filter workouts for the selected day
  const selectedDayWorkouts = user.workoutHistory.filter(w => w.date === state.currentWorkoutDay);
  
  // Format date for display
  const displayDate = new Date(state.currentWorkoutDay + 'T00:00:00');
  const isToday = state.currentWorkoutDay === new Date().toISOString().split('T')[0];
  const dateLabel = isToday ? 'Hoje' : displayDate.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'short' });
  
  // Group exercises by category
  const categorizedExercises = {};
  EXERCISE_LIBRARY.forEach(ex => {
    if (!categorizedExercises[ex.category]) categorizedExercises[ex.category] = [];
    categorizedExercises[ex.category].push(ex);
  });
  
  return `
    <!-- Day Navigation -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <div class="flex justify-between items-center">
        <button onclick="goToPreviousWorkoutDay()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded">â† Dia Anterior</button>
        <div class="text-center">
          <p class="text-lg font-bold">${dateLabel}</p>
          <p class="text-sm text-slate-300">${state.currentWorkoutDay}</p>
        </div>
        <button onclick="goToNextWorkoutDay()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded">PrÃ³ximo Dia â†’</button>
      </div>
      ${!isToday ? `<div class="mt-2 text-center"><button onclick="goToTodayWorkout()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Ir para Hoje</button></div>` : ''}
    </div>

    <!-- Custom Workout Form -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold text-xl mb-3">âž• Adicionar ExercÃ­cio Personalizado</h3>
      <form id="customWorkoutForm" class="space-y-3">
        <div class="grid md:grid-cols-4 gap-3">
          <input type="text" name="customExercise" placeholder="Nome do exercÃ­cio" required class="px-3 py-2 rounded bg-slate-700 text-white" />
          <input type="text" name="customSets" placeholder="SÃ©ries (ex: 3)" class="px-3 py-2 rounded bg-slate-700 text-white" />
          <input type="text" name="customReps" placeholder="RepetiÃ§Ãµes (ex: 12)" class="px-3 py-2 rounded bg-slate-700 text-white" />
          <input type="text" name="customWeight" placeholder="Carga (kg)" class="px-3 py-2 rounded bg-slate-700 text-white" />
        </div>
        <button type="submit" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded font-semibold">Adicionar ExercÃ­cio</button>
      </form>
      <p class="text-slate-300 text-sm mt-2">O exercÃ­cio serÃ¡ registrado para ${dateLabel}.</p>
    </div>

    <!-- Exercise Library by Category -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold text-xl mb-4">ðŸ’ª Biblioteca de ExercÃ­cios</h3>
      <div class="grid md:grid-cols-2 gap-4">
        ${Object.keys(categorizedExercises).map(category => `
          <div class="bg-slate-700 p-3 rounded">
            <h4 class="font-semibold text-lg mb-2 text-purple-300">${category}</h4>
            <div class="space-y-2">
              ${categorizedExercises[category].map(ex => `
                <div class="flex justify-between items-center bg-slate-800 p-2 rounded">
                  <div>
                    <p class="font-medium">${ex.name}</p>
                    <p class="text-xs text-slate-400">${ex.equipment}</p>
                  </div>
                  <button data-exercise="${ex.name}" data-category="${category}" class="workout-register-btn bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Registrar</button>
                </div>
              `).join('')}
            </div>
          </div>
        `).join('')}
      </div>
    </div>

    <!-- Workout Templates -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold text-xl mb-3">ðŸ“‹ Templates de Treino</h3>
      <div class="grid md:grid-cols-3 gap-3">
        ${Object.values(templates).map(t => `
          <div class="bg-slate-700 p-3 rounded">
            <p class="font-bold text-lg">${t.name}</p>
            <p class="text-slate-300 text-sm mb-2">${t.description}</p>
            <button onclick="applyTemplateToUser('${t.id}','${user.id}')" class="bg-green-600 hover:bg-green-500 px-3 py-1 rounded text-sm w-full">Aplicar Template</button>
            <details class="mt-2">
              <summary class="text-sm text-blue-300 cursor-pointer">Ver exercÃ­cios</summary>
              <div class="mt-2 text-xs text-slate-300">
                ${Object.keys(t.sessions).map(k=>`<strong>${k} â€” ${t.sessions[k].name}</strong><br/>${t.sessions[k].exercises.map(e=>`â€¢ ${e.name} ${e.sets?(' â€” ' + e.sets + ' x ' + e.reps):''}`).join('<br/>')}<br/><br/>`).join('')}
              </div>
            </details>
          </div>
        `).join('')}
      </div>
    </div>

    <!-- Workout History for Selected Day -->
    <div class="bg-slate-800 p-4 rounded">
      <h3 class="font-bold text-xl mb-3">ðŸ“‹ HistÃ³rico de ${dateLabel}</h3>
      ${selectedDayWorkouts.length === 0 ? 
        `<p class="text-slate-400">Nenhum treino registrado neste dia.</p>` :
        `<div class="space-y-2">
          ${selectedDayWorkouts.map(log => `
            <div class="flex justify-between items-center bg-slate-700 p-3 rounded">
              <div class="flex-1">
                <p class="font-semibold">${log.exercise || log.workout}</p>
                <p class="text-slate-300 text-xs">${log.category ? `${log.category} â€¢ ` : ''}${log.time}${log.sets && log.sets !== '-' ? ` â€¢ ${log.sets}x${log.reps}` : ''}${log.weight && log.weight !== '-' ? ` â€¢ ${log.weight}kg` : ''}</p>
              </div>
              <div class="flex gap-2">
                <button onclick="handleEditWorkout(${log.id})" class="text-blue-400 hover:text-blue-300" title="Editar sÃ©ries/reps/carga">âœï¸</button>
                <button data-workout-id="${log.id}" class="workout-delete-btn text-red-400 hover:text-red-300" title="Excluir registro">ðŸ—‘ï¸</button>
              </div>
            </div>
          `).join('')}
        </div>`
      }
    </div>
  `;
}

/* ----------------------------- Nutrition Database with Scientific Basis -----------------------------
   Daily recommended amounts for healthy muscle gain and body composition based on:
   - Phillips SM. et al. 2022 (Protein requirements 1.6-2.2 g/kg/d)
   - Schoenfeld BJ. 2023 (Protein timing and distribution)
   - Wang Z. et al. 2024 (Creatine supplementation)
   - Position of the Academy of Nutrition and Dietetics (protein and carbs for athletes)
   
   Recommendations are tailored to:
   - Basal Metabolic Rate (BMR) 
   - Total Daily Energy Expenditure (TDEE)
   - Body composition goals (muscle gain, fat loss, or maintenance)
   - Gender-specific needs
---------------------------------------------------------------------------------------------------- */

function calculateNutritionRecommendations(user) {
  const latestMetrics = user.bodyMetrics && user.bodyMetrics.length > 0 
    ? user.bodyMetrics[user.bodyMetrics.length - 1] 
    : { weight: 70, bmr: 1600, tdee: 2200 };
  
  const weight = latestMetrics.weight || 70;
  const bmr = latestMetrics.bmr || calculateBMR(weight, user.height, user.age, user.gender);
  const tdee = latestMetrics.tdee || (bmr * 1.55); // Moderate activity level
  const goals = user.goals || { weight: weight + 5, muscleMass: (latestMetrics.muscleMass || 25) + 3 };
  
  // Determine if bulking, cutting, or maintaining
  const isGaining = goals.weight > weight;
  const calorieAdjustment = isGaining ? (user.gender === 'male' ? 400 : 300) : -300;
  const targetCalories = Math.round(tdee + calorieAdjustment);
  
  // Protein: 1.8-2.2 g/kg for muscle gain (Phillips 2022)
  const proteinGramsPerKg = isGaining ? 2.0 : 1.8;
  const proteinGrams = Math.round(weight * proteinGramsPerKg);
  const proteinCalories = proteinGrams * 4;
  
  // Fat: 0.8-1.0 g/kg for hormonal health
  const fatGramsPerKg = 0.9;
  const fatGrams = Math.round(weight * fatGramsPerKg);
  const fatCalories = fatGrams * 9;
  
  // Carbs: remaining calories
  const carbCalories = targetCalories - proteinCalories - fatCalories;
  const carbGrams = Math.round(carbCalories / 4);
  
  // Food recommendations based on macros
  // Protein sources (all values per 100g unless specified)
  const foods = {
    // Protein sources
    chicken: {
      name: 'Frango (peito)',
      portion: Math.round(proteinGrams * 0.4 / 0.31), // 40% of protein from chicken (31g protein per 100g)
      unit: 'g',
      macro: 'ProteÃ­na',
      perDay: 'daily',
      protein: 31,
      carbs: 0,
      fat: 3.6,
      kcal: 165,
      note: 'Fonte magra de proteÃ­na de alta qualidade'
    },
    eggs: {
      name: 'Ovos',
      portion: Math.round(proteinGrams * 0.25 / 6.3), // 25% of protein from eggs (6.3g per egg)
      unit: 'unidades',
      macro: 'ProteÃ­na',
      perDay: 'daily',
      protein: 6.3,
      carbs: 0.6,
      fat: 5,
      kcal: 72,
      note: 'ProteÃ­na completa com todos aminoÃ¡cidos essenciais'
    },
    whey: {
      name: 'Whey Protein',
      portion: Math.round(proteinGrams * 0.25 / 25), // 25% of protein from whey (25g per scoop)
      unit: 'scoop (30g)',
      macro: 'ProteÃ­na',
      perDay: 'daily',
      protein: 25,
      carbs: 3,
      fat: 1.5,
      kcal: 120,
      note: 'Suplemento pÃ³s-treino para sÃ­ntese proteica rÃ¡pida'
    },
    
    // Carb sources
    bread: {
      name: 'PÃ£o integral',
      portion: Math.round(carbGrams * 0.15 / 49), // 15% of carbs from bread (49g carbs per 100g)
      unit: 'fatias (25g cada)',
      macro: 'Carboidrato',
      perDay: 'daily',
      protein: 9,
      carbs: 49,
      fat: 3.5,
      kcal: 265,
      note: 'Fonte de carboidratos complexos e fibras'
    },
    rice: {
      name: 'Arroz integral',
      portion: Math.round(carbGrams * 0.35 / 23), // 35% of carbs from rice (23g per 100g cooked)
      unit: 'g (cozido)',
      macro: 'Carboidrato',
      perDay: 'daily',
      protein: 2.6,
      carbs: 23,
      fat: 0.9,
      kcal: 111,
      note: 'Energia sustentada para treinos'
    },
    sweetPotato: {
      name: 'Batata doce',
      portion: Math.round(carbGrams * 0.25 / 20), // 25% of carbs from sweet potato (20g per 100g)
      unit: 'g',
      macro: 'Carboidrato',
      perDay: 'daily',
      protein: 1.6,
      carbs: 20,
      fat: 0.1,
      kcal: 86,
      note: 'Carboidrato de baixo Ã­ndice glicÃªmico'
    },
    
    // Fat sources
    peanutButter: {
      name: 'Pasta de amendoim',
      portion: Math.round(fatGrams * 0.3 / 50 * 100), // 30% of fat from PB (50g fat per 100g)
      unit: 'g',
      macro: 'Gordura',
      perDay: 'daily',
      protein: 25,
      carbs: 20,
      fat: 50,
      kcal: 588,
      note: 'Gorduras saudÃ¡veis e proteÃ­na adicional'
    },
    avocado: {
      name: 'Abacate',
      portion: Math.round(fatGrams * 0.2 / 15), // 20% of fat from avocado (15g per 100g)
      unit: 'g',
      macro: 'Gordura',
      perDay: 'daily',
      protein: 2,
      carbs: 9,
      fat: 15,
      kcal: 160,
      note: 'Gorduras monoinsaturadas e fibras'
    },
    
    // Supplements
    creatine: {
      name: 'Creatina',
      portion: 5,
      unit: 'g',
      macro: 'Suplemento',
      perDay: 'daily',
      protein: 0,
      carbs: 0,
      fat: 0,
      kcal: 0,
      note: 'Melhora forÃ§a e ganho de massa muscular (Wang 2024)'
    }
  };
  
  return {
    targetCalories,
    bmr,
    tdee,
    proteinGrams,
    carbGrams,
    fatGrams,
    foods,
    isGaining
  };
}

function renderNutritionRecommendations(user) {
  const nutrition = calculateNutritionRecommendations(user);
  const foods = nutrition.foods;
  
  return `
    <div class="bg-gradient-to-r from-green-700 to-emerald-800 p-6 rounded-xl mb-6">
      <h4 class="font-bold text-xl mb-4">ðŸŽ¯ Metas Nutricionais Personalizadas</h4>
      <div class="grid md:grid-cols-4 gap-4">
        <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
          <p class="text-sm text-green-100 mb-1">TMB (Basal)</p>
          <p class="text-3xl font-bold">${nutrition.bmr}</p>
          <p class="text-xs text-green-200">kcal/dia</p>
        </div>
        <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
          <p class="text-sm text-green-100 mb-1">TDEE (Total)</p>
          <p class="text-3xl font-bold">${Math.round(nutrition.tdee)}</p>
          <p class="text-xs text-green-200">kcal/dia</p>
        </div>
        <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
          <p class="text-sm text-green-100 mb-1">Meta CalÃ³rica</p>
          <p class="text-3xl font-bold">${nutrition.targetCalories}</p>
          <p class="text-xs text-green-200">${nutrition.isGaining ? 'Ganho' : 'Perda'}</p>
        </div>
        <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
          <p class="text-sm text-green-100 mb-1">Macros</p>
          <p class="text-lg font-bold">${nutrition.proteinGrams}P</p>
          <p class="text-lg font-bold">${nutrition.carbGrams}C â€¢ ${nutrition.fatGrams}G</p>
        </div>
      </div>
    </div>

    <div class="bg-slate-800 p-6 rounded-xl mb-6">
      <h4 class="font-bold text-xl mb-4">ðŸ— Base de AlimentaÃ§Ã£o DiÃ¡ria Recomendada</h4>
      <p class="text-slate-300 text-sm mb-4">Quantidades calculadas com base no seu metabolismo basal (${nutrition.bmr} kcal), TDEE (${Math.round(nutrition.tdee)} kcal) e metas de composiÃ§Ã£o corporal. Baseado em estudos cientÃ­ficos (Phillips 2022, Schoenfeld 2023, Wang 2024).</p>
      
      <!-- Protein Sources -->
      <div class="mb-6">
        <h5 class="font-semibold text-lg text-blue-300 mb-3">ðŸ’ª Fontes de ProteÃ­na (Meta: ${nutrition.proteinGrams}g/dia)</h5>
        <div class="grid md:grid-cols-3 gap-4">
          ${[foods.chicken, foods.eggs, foods.whey].map(food => `
            <div class="bg-slate-700 p-4 rounded-lg">
              <div class="flex justify-between items-start mb-2">
                <p class="font-bold text-lg">${food.name}</p>
                <span class="bg-blue-600 px-2 py-1 rounded text-xs">${food.macro}</span>
              </div>
              <p class="text-3xl font-bold text-blue-400 mb-2">${food.portion}</p>
              <p class="text-sm text-slate-300 mb-3">${food.unit} por dia</p>
              <div class="text-xs text-slate-400 space-y-1">
                ${food.protein ? `<p>ProteÃ­na: ~${Math.round(food.portion * food.protein / (food.unit === 'unidades' ? 1 : food.unit === 'scoop (30g)' ? 1 : 100))}g</p>` : ''}
                ${food.kcal ? `<p>Calorias: ~${Math.round(food.portion * food.kcal / (food.unit === 'unidades' ? 1 : food.unit === 'scoop (30g)' ? 1 : 100))}kcal</p>` : ''}
              </div>
              <p class="text-xs text-green-300 mt-3">${food.note}</p>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Carb Sources -->
      <div class="mb-6">
        <h5 class="font-semibold text-lg text-orange-300 mb-3">ðŸŒ¾ Fontes de Carboidratos (Meta: ${nutrition.carbGrams}g/dia)</h5>
        <div class="grid md:grid-cols-3 gap-4">
          ${[foods.bread, foods.rice, foods.sweetPotato].map(food => `
            <div class="bg-slate-700 p-4 rounded-lg">
              <div class="flex justify-between items-start mb-2">
                <p class="font-bold text-lg">${food.name}</p>
                <span class="bg-orange-600 px-2 py-1 rounded text-xs">${food.macro}</span>
              </div>
              <p class="text-3xl font-bold text-orange-400 mb-2">${food.portion}</p>
              <p class="text-sm text-slate-300 mb-3">${food.unit} por dia</p>
              <div class="text-xs text-slate-400 space-y-1">
                ${food.carbs ? `<p>Carboidratos: ~${Math.round(food.portion * food.carbs / 100)}g</p>` : ''}
                ${food.kcal ? `<p>Calorias: ~${Math.round(food.portion * food.kcal / 100)}kcal</p>` : ''}
              </div>
              <p class="text-xs text-green-300 mt-3">${food.note}</p>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Fat Sources -->
      <div class="mb-6">
        <h5 class="font-semibold text-lg text-yellow-300 mb-3">ðŸ¥‘ Fontes de Gorduras SaudÃ¡veis (Meta: ${nutrition.fatGrams}g/dia)</h5>
        <div class="grid md:grid-cols-2 gap-4">
          ${[foods.peanutButter, foods.avocado].map(food => `
            <div class="bg-slate-700 p-4 rounded-lg">
              <div class="flex justify-between items-start mb-2">
                <p class="font-bold text-lg">${food.name}</p>
                <span class="bg-yellow-600 px-2 py-1 rounded text-xs">${food.macro}</span>
              </div>
              <p class="text-3xl font-bold text-yellow-400 mb-2">${food.portion}</p>
              <p class="text-sm text-slate-300 mb-3">${food.unit} por dia</p>
              <div class="text-xs text-slate-400 space-y-1">
                ${food.fat ? `<p>Gorduras: ~${Math.round(food.portion * food.fat / 100)}g</p>` : ''}
                ${food.kcal ? `<p>Calorias: ~${Math.round(food.portion * food.kcal / 100)}kcal</p>` : ''}
              </div>
              <p class="text-xs text-green-300 mt-3">${food.note}</p>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Supplements -->
      <div class="mb-6">
        <h5 class="font-semibold text-lg text-purple-300 mb-3">ðŸ’Š SuplementaÃ§Ã£o Baseada em EvidÃªncias</h5>
        <div class="grid md:grid-cols-2 gap-4">
          ${[foods.creatine, foods.whey].map(food => `
            <div class="bg-slate-700 p-4 rounded-lg border-2 border-purple-500">
              <div class="flex justify-between items-start mb-2">
                <p class="font-bold text-lg">${food.name}</p>
                <span class="bg-purple-600 px-2 py-1 rounded text-xs">${food.macro}</span>
              </div>
              <p class="text-3xl font-bold text-purple-400 mb-2">${food.portion}</p>
              <p class="text-sm text-slate-300 mb-3">${food.unit} por dia</p>
              <p class="text-xs text-green-300 mt-3">${food.note}</p>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Scientific Notes -->
      <div class="bg-gradient-to-r from-cyan-900 to-blue-900 p-4 rounded-lg">
        <h5 class="font-semibold text-lg mb-2">ðŸ”¬ Base CientÃ­fica</h5>
        <div class="text-sm text-slate-300 space-y-2">
          <p><strong>ProteÃ­na:</strong> RecomendaÃ§Ã£o de 1.8-2.2 g/kg/dia para otimizar sÃ­ntese proteica e hipertrofia muscular (Phillips et al., 2022).</p>
          <p><strong>Timing:</strong> Distribuir proteÃ­na em 4-6 refeiÃ§Ãµes ao longo do dia, com 20-40g por refeiÃ§Ã£o (Schoenfeld et al., 2023).</p>
          <p><strong>Creatina:</strong> 5g/dia melhora forÃ§a e ganho de massa muscular em adultos que praticam treinamento resistido (Wang et al., 2024).</p>
          <p><strong>Carboidratos:</strong> Essenciais para reposiÃ§Ã£o de glicogÃªnio e performance em treinos intensos. Ajustar conforme nÃ­vel de atividade.</p>
          <p><strong>Gorduras:</strong> 0.8-1.0 g/kg/dia para suporte hormonal e absorÃ§Ã£o de vitaminas lipossolÃºveis.</p>
        </div>
      </div>
    </div>
  `;
}

function renderNutricao(user) {
  const notes = buildReferenceNotesForNutrition();
  return `
    ${renderNutritionRecommendations(user)}
    
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold">Plano nutricional (resumo)</h3>
      <p class="text-slate-300 text-sm">${notes || 'Importe referÃªncias na aba CIÃŠNCIA para ver recomendaÃ§Ãµes.'}</p>
      <div class="mt-3 text-slate-300 text-sm">
        <p class="mb-2"><strong>Dicas prÃ¡ticas:</strong></p>
        <ul class="list-disc list-inside space-y-1 text-sm">
          <li>Distribua a proteÃ­na em 4-6 refeiÃ§Ãµes ao longo do dia</li>
          <li>Consuma 20-40g de proteÃ­na a cada 3-4 horas</li>
          <li>Tome creatina diariamente (5g), preferencialmente com carboidratos</li>
          <li>Whey protein ideal no pÃ³s-treino (janela de 0-2h)</li>
          <li>Carboidratos concentrados antes e apÃ³s treinos intensos</li>
          <li>Gorduras saudÃ¡veis em todas as refeiÃ§Ãµes principais</li>
          <li>Hidrate-se: mÃ­nimo 35ml/kg de peso corporal por dia</li>
        </ul>
      </div>
    </div>
  `;
}

function renderAlimentacao() {
  const currentUser = state.users[state.activeUser];
  const mealHistory = currentUser.mealHistory || [];
  
  // Filter meals for the selected day
  const selectedDayMeals = mealHistory.filter(m => m.date === state.currentDay);
  
  // Calculate totals for the selected day
  const dayTotals = selectedDayMeals.reduce((acc, log) => {
    const nut = getMealNutritionByNameCombined(log.meal);
    acc.kcal += nut.kcal; 
    acc.prot += nut.prot; 
    acc.fat += nut.fat;
    return acc;
  }, { kcal: 0, prot: 0, fat: 0 });
  
  // Format date for display
  const displayDate = new Date(state.currentDay + 'T00:00:00');
  const isToday = state.currentDay === new Date().toISOString().split('T')[0];
  const dateLabel = isToday ? 'Hoje' : displayDate.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'short' });
  
  return `
    <!-- Day Navigation -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <div class="flex justify-between items-center">
        <button onclick="goToPreviousDay()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded">â† Dia Anterior</button>
        <div class="text-center">
          <p class="text-lg font-bold">${dateLabel}</p>
          <p class="text-sm text-slate-300">${state.currentDay}</p>
        </div>
        <button onclick="goToNextDay()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded">PrÃ³ximo Dia â†’</button>
      </div>
      ${!isToday ? `<div class="mt-2 text-center"><button onclick="goToToday()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Ir para Hoje</button></div>` : ''}
    </div>

    <!-- Day Totals -->
    <div class="bg-gradient-to-r from-green-600 to-green-800 p-4 rounded mb-6">
      <h4 class="font-bold text-lg">Totais de ${dateLabel}</h4>
      <p class="text-white text-xl">${Math.round(dayTotals.kcal)} kcal â€¢ ${Math.round(dayTotals.prot)} g proteÃ­na â€¢ ${Math.round(dayTotals.fat)} g gord.</p>
    </div>

    <!-- Nutrition Calculator & Guide -->
    <div class="bg-gradient-to-br from-blue-900 to-indigo-900 p-6 rounded-xl mb-6 border-2 border-blue-500">
      <h3 class="font-bold text-2xl mb-4 flex items-center gap-2">
        ðŸ§® Calculadora de Macronutrientes
        <span class="text-xs font-normal bg-yellow-500 text-black px-2 py-1 rounded">NOVO</span>
      </h3>
      
      <div class="bg-white/10 backdrop-blur p-5 rounded-lg mb-6">
        <h4 class="font-semibold text-lg mb-3 text-cyan-300">ðŸ“š Como Calcular os Macros da sua RefeiÃ§Ã£o</h4>
        <div class="space-y-3 text-sm text-slate-200">
          <p class="leading-relaxed"><strong>1. Pese os alimentos crus</strong> (antes de cozinhar) sempre que possÃ­vel, pois as tabelas nutricionais se referem ao peso cru.</p>
          <p class="leading-relaxed"><strong>2. Use a regra de trÃªs simples:</strong> Se a tabela nutricional informa valores para 100g, e vocÃª tem 150g, multiplique por 1.5 (150 Ã· 100).</p>
          <p class="leading-relaxed"><strong>3. Lembre-se das calorias por grama:</strong></p>
          <ul class="list-disc list-inside ml-4 space-y-1">
            <li><strong>ProteÃ­na:</strong> 4 kcal por grama</li>
            <li><strong>Carboidrato:</strong> 4 kcal por grama</li>
            <li><strong>Gordura:</strong> 9 kcal por grama</li>
          </ul>
          <p class="leading-relaxed"><strong>4. Some todos os ingredientes</strong> da sua refeiÃ§Ã£o para obter o total.</p>
        </div>
      </div>

      <!-- Food Database Browser -->
      <div class="bg-slate-800 p-5 rounded-lg mb-4">
        <h4 class="font-semibold text-lg mb-4 text-yellow-300">ðŸ“š Banco de Alimentos Comuns</h4>
        <p class="text-sm text-slate-300 mb-4">Selecione um alimento da lista para preencher automaticamente a calculadora. Valores baseados na Tabela TACO (Tabela Brasileira de ComposiÃ§Ã£o de Alimentos).</p>
        
        <!-- Search box -->
        <div class="mb-4">
          <input type="text" id="foodSearchInput" placeholder="ðŸ” Buscar alimento..." onkeyup="filterFoods()" class="w-full px-4 py-2 rounded bg-slate-700 text-white" />
        </div>

        <!-- Food categories -->
        <div class="grid md:grid-cols-2 gap-4" id="foodCategoriesContainer">
          ${Object.keys(commonFoods).map(category => `
            <div class="bg-slate-700 p-4 rounded food-category">
              <h5 class="font-semibold mb-3 capitalize ${
                category === 'proteinas' ? 'text-blue-300' :
                category === 'carboidratos' ? 'text-orange-300' :
                category === 'gorduras' ? 'text-yellow-300' :
                'text-green-300'
              }">
                ${category === 'proteinas' ? 'ðŸ’ª ProteÃ­nas' :
                  category === 'carboidratos' ? 'ðŸŒ¾ Carboidratos' :
                  category === 'gorduras' ? 'ðŸ¥‘ Gorduras SaudÃ¡veis' :
                  'ðŸ¥— Vegetais'}
              </h5>
              <div class="space-y-2 max-h-64 overflow-y-auto">
                ${commonFoods[category].map((food, idx) => `
                  <div class="food-item bg-slate-800 p-2 rounded hover:bg-slate-600 cursor-pointer transition-colors" data-food-name="${food.name}" onclick="selectFood('${category}', ${idx})">
                    <p class="font-medium text-sm">${food.name}</p>
                    <p class="text-xs text-slate-400">${food.kcal} kcal â€¢ ${food.prot}g P â€¢ ${food.carb}g C â€¢ ${food.fat}g G (${food.per} ${food.unit})</p>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Interactive Calculator -->
      <div class="bg-slate-800 p-5 rounded-lg mb-4">
        <h4 class="font-semibold text-lg mb-4 text-green-300">ðŸ”¢ Calculadora Interativa</h4>
        <div class="space-y-4">
          <!-- Food input -->
          <div class="grid md:grid-cols-6 gap-3">
            <input type="text" id="calcFoodName" placeholder="Nome do alimento" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <input type="number" id="calcWeight" placeholder="Peso (g)" step="0.1" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <input type="number" id="calcProtPer100" placeholder="Prot/100g" step="0.1" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <input type="number" id="calcCarbPer100" placeholder="Carb/100g" step="0.1" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <input type="number" id="calcFatPer100" placeholder="Gord/100g" step="0.1" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <button onclick="calculateMacros()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded font-semibold">Calcular</button>
          </div>
          
          <!-- Results -->
          <div id="calcResults" class="hidden bg-gradient-to-r from-green-700 to-emerald-800 p-4 rounded-lg">
            <h5 class="font-semibold mb-2">Resultado do CÃ¡lculo:</h5>
            <div class="grid md:grid-cols-4 gap-3 text-center">
              <div class="bg-white/10 backdrop-blur p-3 rounded">
                <p class="text-xs text-green-200 mb-1">ProteÃ­na</p>
                <p class="text-2xl font-bold" id="resultProt">0g</p>
                <p class="text-xs text-green-300" id="resultProtKcal">0 kcal</p>
              </div>
              <div class="bg-white/10 backdrop-blur p-3 rounded">
                <p class="text-xs text-orange-200 mb-1">Carboidrato</p>
                <p class="text-2xl font-bold" id="resultCarb">0g</p>
                <p class="text-xs text-orange-300" id="resultCarbKcal">0 kcal</p>
              </div>
              <div class="bg-white/10 backdrop-blur p-3 rounded">
                <p class="text-xs text-yellow-200 mb-1">Gordura</p>
                <p class="text-2xl font-bold" id="resultFat">0g</p>
                <p class="text-xs text-yellow-300" id="resultFatKcal">0 kcal</p>
              </div>
              <div class="bg-white/10 backdrop-blur p-3 rounded">
                <p class="text-xs text-cyan-200 mb-1">Total</p>
                <p class="text-2xl font-bold" id="resultTotal">0 kcal</p>
                <p class="text-xs text-cyan-300">calorias totais</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Examples Section -->
      <div class="bg-slate-800 p-5 rounded-lg">
        <h4 class="font-semibold text-lg mb-3 text-yellow-300">ðŸ’¡ Exemplos PrÃ¡ticos</h4>
        <div class="space-y-4">
          <div class="bg-slate-700 p-4 rounded">
            <p class="font-bold text-blue-300 mb-2">Exemplo 1: Frango Grelhado (150g)</p>
            <p class="text-sm text-slate-300 mb-2">Valores por 100g: 31g prot, 0g carb, 3.6g gord</p>
            <div class="bg-slate-800 p-3 rounded text-sm">
              <p class="mb-1"><strong>CÃ¡lculo:</strong></p>
              <p>â€¢ ProteÃ­na: 31g Ã— 1.5 = <strong class="text-green-400">46.5g</strong> = 186 kcal</p>
              <p>â€¢ Carboidrato: 0g Ã— 1.5 = <strong class="text-orange-400">0g</strong> = 0 kcal</p>
              <p>â€¢ Gordura: 3.6g Ã— 1.5 = <strong class="text-yellow-400">5.4g</strong> = 48.6 kcal</p>
              <p class="mt-2 text-cyan-400"><strong>Total: 234.6 kcal</strong></p>
            </div>
            <button onclick="fillCalculatorExample('Frango grelhado', 150, 31, 0, 3.6)" class="mt-2 bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Testar na Calculadora</button>
          </div>

          <div class="bg-slate-700 p-4 rounded">
            <p class="font-bold text-blue-300 mb-2">Exemplo 2: Arroz Integral Cozido (200g)</p>
            <p class="text-sm text-slate-300 mb-2">Valores por 100g: 2.6g prot, 23g carb, 0.9g gord</p>
            <div class="bg-slate-800 p-3 rounded text-sm">
              <p class="mb-1"><strong>CÃ¡lculo:</strong></p>
              <p>â€¢ ProteÃ­na: 2.6g Ã— 2 = <strong class="text-green-400">5.2g</strong> = 20.8 kcal</p>
              <p>â€¢ Carboidrato: 23g Ã— 2 = <strong class="text-orange-400">46g</strong> = 184 kcal</p>
              <p>â€¢ Gordura: 0.9g Ã— 2 = <strong class="text-yellow-400">1.8g</strong> = 16.2 kcal</p>
              <p class="mt-2 text-cyan-400"><strong>Total: 221 kcal</strong></p>
            </div>
            <button onclick="fillCalculatorExample('Arroz integral cozido', 200, 2.6, 23, 0.9)" class="mt-2 bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Testar na Calculadora</button>
          </div>

          <div class="bg-slate-700 p-4 rounded">
            <p class="font-bold text-blue-300 mb-2">Exemplo 3: Batata Doce (300g)</p>
            <p class="text-sm text-slate-300 mb-2">Valores por 100g: 1.6g prot, 20g carb, 0.1g gord</p>
            <div class="bg-slate-800 p-3 rounded text-sm">
              <p class="mb-1"><strong>CÃ¡lculo:</strong></p>
              <p>â€¢ ProteÃ­na: 1.6g Ã— 3 = <strong class="text-green-400">4.8g</strong> = 19.2 kcal</p>
              <p>â€¢ Carboidrato: 20g Ã— 3 = <strong class="text-orange-400">60g</strong> = 240 kcal</p>
              <p>â€¢ Gordura: 0.1g Ã— 3 = <strong class="text-yellow-400">0.3g</strong> = 2.7 kcal</p>
              <p class="mt-2 text-cyan-400"><strong>Total: 261.9 kcal</strong></p>
            </div>
            <button onclick="fillCalculatorExample('Batata doce', 300, 1.6, 20, 0.1)" class="mt-2 bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Testar na Calculadora</button>
          </div>
        </div>
      </div>

      <!-- Tips Section -->
      <div class="bg-gradient-to-r from-purple-900 to-pink-900 p-5 rounded-lg mt-4">
        <h4 class="font-semibold text-lg mb-3">âœ¨ Dicas Importantes</h4>
        <ul class="space-y-2 text-sm text-slate-200">
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">âœ“</span>
            <span><strong>BalanÃ§a digital:</strong> Investir numa balanÃ§a de cozinha precisa (atÃ© 0.1g) facilita muito o controle.</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">âœ“</span>
            <span><strong>Aplicativos Ãºteis:</strong> MyFitnessPal, FatSecret e Cronometer tÃªm grandes bancos de dados de alimentos.</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">âœ“</span>
            <span><strong>Cozido vs Cru:</strong> Arroz e macarrÃ£o absorvem Ã¡gua ao cozinhar (peso aumenta 2-3x, mas calorias nÃ£o mudam).</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">âœ“</span>
            <span><strong>Ã“leos e temperos:</strong> NÃ£o esqueÃ§a de contar azeite, Ã³leo, manteiga usados no preparo (1 colher sopa â‰ˆ 15ml â‰ˆ 135 kcal).</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">âœ“</span>
            <span><strong>Estimativas:</strong> Quando nÃ£o puder pesar, use aproximaÃ§Ãµes: 1 palma de mÃ£o = ~100g de proteÃ­na, 1 punho = ~150g de carboidrato.</span>
          </li>
        </ul>
      </div>
    </div>

    <!-- Custom Meal Form -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold mb-3">âž• Adicionar RefeiÃ§Ã£o Personalizada</h3>
      <form id="customMealForm" class="grid md:grid-cols-5 gap-2">
        <input type="text" name="customMealName" placeholder="Nome da refeiÃ§Ã£o" required class="px-3 py-2 rounded bg-slate-700 text-white" />
        <input type="number" name="customMealKcal" step="0.1" placeholder="Calorias (kcal)" required class="px-3 py-2 rounded bg-slate-700 text-white" />
        <input type="number" name="customMealProt" step="0.1" placeholder="ProteÃ­na (g)" class="px-3 py-2 rounded bg-slate-700 text-white" />
        <input type="number" name="customMealFat" step="0.1" placeholder="Gordura (g)" class="px-3 py-2 rounded bg-slate-700 text-white" />
        <div class="flex flex-col gap-2">
          <label class="flex items-center gap-2 text-sm text-slate-300">
            <input type="checkbox" name="saveAsReusable" class="rounded" />
            Salvar como reutilizÃ¡vel
          </label>
          <button type="submit" class="bg-green-600 hover:bg-green-500 px-3 py-2 rounded font-semibold">Adicionar</button>
        </div>
      </form>
      <p class="text-slate-400 text-xs mt-2">A refeiÃ§Ã£o serÃ¡ registrada para ${dateLabel}. Marque "Salvar como reutilizÃ¡vel" para adicionÃ¡-la Ã  lista abaixo.</p>
    </div>

    <!-- Custom Meals List -->
    ${state.customMeals.length > 0 ? `
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold mb-3">ðŸ½ï¸ Minhas RefeiÃ§Ãµes Personalizadas</h3>
      <div class="grid md:grid-cols-2 gap-3">
        ${state.customMeals.map(m => `
          <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
            <div>
              <p class="font-semibold">${m.name}</p>
              <p class="text-slate-300 text-xs">${m.kcal} kcal â€¢ ${m.prot}g prot â€¢ ${m.fat}g gord</p>
            </div>
            <div class="flex gap-2">
              <button data-meal-name="${m.name.replace(/"/g, '&quot;')}" class="meal-register-btn bg-orange-500 hover:bg-orange-400 px-3 py-1 rounded">Registrar</button>
              <button onclick="handleDeleteCustomMeal('${m.id}')" class="text-red-400 hover:text-red-300 px-2">ðŸ—‘ï¸</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
    ` : ''}

    <!-- LiveUp Marmitas -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold mb-3">ðŸ± Marmitas LiveUp (DisponÃ­veis)</h3>
      <div class="grid md:grid-cols-2 gap-3">
        ${livUpMarmitas.map(m => `
          <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
            <div>
              <p class="font-semibold">${m.name}</p>
              <p class="text-slate-300 text-xs">${m.category} â€¢ ${m.size}${m.kcal ? ' â€¢ ' + m.kcal + ' kcal' : ''}${m.notes ? ' â€¢ ' + m.notes : ''}</p>
            </div>
            <div>
              <button data-meal-name="${m.name.replace(/"/g, '&quot;')}" class="meal-register-btn bg-orange-500 hover:bg-orange-400 px-3 py-1 rounded">Registrar</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>

    <!-- Meal History for Selected Day -->
    <div class="bg-slate-800 p-4 rounded">
      <h3 class="font-bold mb-3">ðŸ“‹ HistÃ³rico de ${dateLabel}</h3>
      ${selectedDayMeals.length === 0 ? 
        '<p class="text-slate-400">Nenhuma refeiÃ§Ã£o registrada neste dia.</p>' :
        `<div class="space-y-2">
          ${selectedDayMeals.map(log => {
            const nut = getMealNutritionByNameCombined(log.meal);
            return `
              <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
                <div>
                  <p class="font-semibold">${log.meal}</p>
                  <p class="text-slate-300 text-xs">${log.time} â€¢ ${nut.kcal} kcal â€¢ ${nut.prot}g prot â€¢ ${nut.fat}g gord</p>
                </div>
                <button data-meal-id="${log.id}" class="meal-delete-btn text-red-400 hover:text-red-300" title="Excluir registro">ðŸ—‘ï¸</button>
              </div>
            `;
          }).join('')}
        </div>`
      }
    </div>
  `;
}

function renderEvolucao(bodyMetrics, user) {
  return `
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold text-xl mb-4">ðŸ“Š Adicionar Medidas de BioimpedÃ¢ncia Completa</h3>
      <p class="text-slate-300 text-sm mb-4">Preencha todos os campos disponÃ­veis do seu equipamento de bioimpedÃ¢ncia. Os campos obrigatÃ³rios sÃ£o marcados com *. Os demais sÃ£o opcionais mas recomendados para anÃ¡lise completa.</p>
      
      <form id="metricsForm" class="space-y-4">
        <!-- InformaÃ§Ãµes BÃ¡sicas -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-purple-300">ðŸ“… InformaÃ§Ãµes BÃ¡sicas</h4>
          <div class="grid md:grid-cols-4 gap-3">
            <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required class="px-3 py-2 rounded bg-slate-600 text-white" title="Data da mediÃ§Ã£o"/>
            <input type="number" name="weight" step="0.01" required placeholder="Peso (kg)*" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFat" step="0.1" required placeholder="Gordura Corporal (%)*" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMass" step="0.1" required placeholder="Massa Muscular (kg)*" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- ComposiÃ§Ã£o Corporal AvanÃ§ada -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-green-300">ðŸ§¬ ComposiÃ§Ã£o Corporal AvanÃ§ada</h4>
          <div class="grid md:grid-cols-4 gap-3">
            <input type="number" name="visceralFat" step="0.1" placeholder="Gordura Visceral" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="waterPercent" step="0.1" placeholder="Ãgua Corporal (%)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="boneMass" step="0.1" placeholder="Massa Ã“ssea (kg)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="proteinMass" step="0.1" placeholder="ProteÃ­na (kg)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="mineralMass" step="0.1" placeholder="Minerais (kg)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Massa Muscular Segmentada -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-blue-300">ðŸ’ª Massa Muscular Segmentada (kg)</h4>
          <div class="grid md:grid-cols-5 gap-3">
            <input type="number" name="muscleMassRightArm" step="0.1" placeholder="BraÃ§o Direito" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMassLeftArm" step="0.1" placeholder="BraÃ§o Esquerdo" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMassRightLeg" step="0.1" placeholder="Perna Direita" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMassLeftLeg" step="0.1" placeholder="Perna Esquerda" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMassTrunk" step="0.1" placeholder="Tronco" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Gordura Corporal Segmentada -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-red-300">ðŸ”¥ Gordura Corporal Segmentada (%)</h4>
          <div class="grid md:grid-cols-5 gap-3">
            <input type="number" name="bodyFatRightArm" step="0.1" placeholder="BraÃ§o Direito" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFatLeftArm" step="0.1" placeholder="BraÃ§o Esquerdo" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFatRightLeg" step="0.1" placeholder="Perna Direita" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFatLeftLeg" step="0.1" placeholder="Perna Esquerda" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFatTrunk" step="0.1" placeholder="Tronco" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Taxas MetabÃ³licas -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-orange-300">âš¡ Taxas MetabÃ³licas (kcal/dia)</h4>
          <div class="grid md:grid-cols-3 gap-3">
            <input type="number" name="bmr" placeholder="TMB - Taxa MetabÃ³lica Basal" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="rmr" placeholder="TMR - Taxa MetabÃ³lica Repouso" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="tdee" placeholder="TDEE - Gasto EnergÃ©tico Total" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- ImpedÃ¢ncia BioelÃ©trica (Bioelectrical Impedance Analysis - BIA) -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-cyan-300">âš¡ AnÃ¡lise de ImpedÃ¢ncia BioelÃ©trica (BIA)</h4>
          <div class="grid md:grid-cols-4 gap-3">
            <input type="number" name="impedance" step="0.1" placeholder="ImpedÃ¢ncia (Î©)" class="px-3 py-2 rounded bg-slate-600 text-white" title="ImpedÃ¢ncia corporal total a 50kHz"/>
            <input type="number" name="resistance" step="0.1" placeholder="ResistÃªncia (Î©)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="reactance" step="0.1" placeholder="ReatÃ¢ncia (Î©)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="phaseAngle" step="0.1" placeholder="Ã‚ngulo de Fase (Â°)" class="px-3 py-2 rounded bg-slate-600 text-white" title="Indicador de saÃºde celular (normal: 5-7Â°)"/>
          </div>
          <p class="text-xs text-slate-400 mt-2">ðŸ’¡ Ã‚ngulo de Fase: indicador de saÃºde celular. Normal: 5-7Â°. Maior = melhor integridade celular.</p>
        </div>

        <!-- Idades e Ãndices -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-yellow-300">ðŸŽ‚ Idades MetabÃ³lica e Corporal</h4>
          <div class="grid md:grid-cols-3 gap-3">
            <input type="number" name="metabolicAge" placeholder="Idade MetabÃ³lica (anos)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyAge" placeholder="Idade Corporal (anos)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleSize" step="0.1" placeholder="Tamanho Muscular (cm)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- CircunferÃªncias Corporais -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-pink-300">ðŸ“ CircunferÃªncias Corporais (cm)</h4>
          <div class="grid md:grid-cols-4 gap-3">
            <input type="number" name="chest" step="0.1" placeholder="Peito" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="waist" step="0.1" placeholder="Cintura" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="hips" step="0.1" placeholder="Quadril" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="shoulders" step="0.1" placeholder="Ombros" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="rightArm" step="0.1" placeholder="BraÃ§o Direito" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="leftArm" step="0.1" placeholder="BraÃ§o Esquerdo" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="rightThigh" step="0.1" placeholder="Coxa Direita" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="leftThigh" step="0.1" placeholder="Coxa Esquerda" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="rightCalf" step="0.1" placeholder="Panturrilha Direita" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="leftCalf" step="0.1" placeholder="Panturrilha Esquerda" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="neck" step="0.1" placeholder="PescoÃ§o" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <div class="flex gap-3">
          <button type="submit" class="bg-purple-600 hover:bg-purple-500 px-6 py-3 rounded font-semibold text-lg">âž• Adicionar MediÃ§Ã£o Completa</button>
          <button type="button" onclick="document.getElementById('metricsForm').reset()" class="bg-slate-600 hover:bg-slate-500 px-4 py-3 rounded">ðŸ”„ Limpar</button>
        </div>
      </form>
    </div>

    <div class="bg-slate-800 p-4 rounded mb-6">
      <div class="flex gap-3 items-start">
        <div style="flex:1;">
          <canvas id="muscleChart" height="160"></canvas>
        </div>
        <div style="width: 180px;" class="flex flex-col gap-2">
          <button onclick="exportMuscleEvolutionCSV('${user.id}')" class="bg-blue-600 px-3 py-2 rounded">ðŸ“Š Exportar CSV</button>
          <button onclick="alert('Backup (full DB export) em breve')" class="bg-amber-600 px-3 py-2 rounded">ðŸ’¾ Backup DB</button>
          <div class="text-slate-300 text-sm mt-2">GrÃ¡fico de evoluÃ§Ã£o: massa muscular e composiÃ§Ã£o corporal ao longo do tempo.</div>
        </div>
      </div>

      <div class="overflow-x-auto mt-4">
        <table class="w-full text-sm">
          <thead><tr class="border-b border-slate-600">
            <th class="py-2 px-2">Data</th>
            <th>Peso</th>
            <th>Gordura</th>
            <th>Massa Musc.</th>
            <th>IMC</th>
            <th>Ãgua</th>
            <th>BMR</th>
            <th>Ã‚ngulo Fase</th>
            <th>Idade Met.</th>
            <th>AÃ§Ãµes</th>
          </tr></thead>
          <tbody>
            ${bodyMetrics.slice().reverse().map(m => `
              <tr class="border-b border-slate-700 hover:bg-slate-700">
                <td class="py-2 px-2">${m.date}</td>
                <td class="py-2 px-2">${m.weight}kg</td>
                <td class="py-2 px-2">${m.bodyFat}%</td>
                <td class="py-2 px-2">${m.muscleMass}kg</td>
                <td class="py-2 px-2">${m.bmi || '-'}</td>
                <td class="py-2 px-2">${m.waterWeight || 0}kg</td>
                <td class="py-2 px-2">${m.bmr || '-'}</td>
                <td class="py-2 px-2">${m.phaseAngle ? m.phaseAngle + 'Â°' : '-'}</td>
                <td class="py-2 px-2">${m.metabolicAge ? m.metabolicAge + 'a' : '-'}</td>
                <td class="py-2 px-2">
                  <button onclick="handleDeleteMetric('${m.id}')" class="text-red-400 hover:text-red-300" title="Excluir e mover para archive">ðŸ—‘ï¸</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      ${bodyMetrics.length > 0 ? `
        <div class="mt-6 bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3">ðŸ“ˆ MÃ©tricas Detalhadas da Ãšltima MediÃ§Ã£o</h4>
          ${(() => {
            const latest = bodyMetrics[bodyMetrics.length - 1];
            return `
              <div class="grid md:grid-cols-3 gap-4 text-sm">
                ${latest.muscleMassRightArm ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">ðŸ’ª Massa Muscular Segmentada</p>
                    <p>BraÃ§o D: ${latest.muscleMassRightArm}kg | E: ${latest.muscleMassLeftArm}kg</p>
                    <p>Perna D: ${latest.muscleMassRightLeg}kg | E: ${latest.muscleMassLeftLeg}kg</p>
                    <p>Tronco: ${latest.muscleMassTrunk}kg</p>
                  </div>
                ` : ''}
                ${latest.bodyFatRightArm ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">ðŸ”¥ Gordura Segmentada</p>
                    <p>BraÃ§o D: ${latest.bodyFatRightArm}% | E: ${latest.bodyFatLeftArm}%</p>
                    <p>Perna D: ${latest.bodyFatRightLeg}% | E: ${latest.bodyFatLeftLeg}%</p>
                    <p>Tronco: ${latest.bodyFatTrunk}%</p>
                  </div>
                ` : ''}
                ${latest.boneMass ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">ðŸ§¬ ComposiÃ§Ã£o AvanÃ§ada</p>
                    <p>Massa Ã“ssea: ${latest.boneMass}kg</p>
                    <p>ProteÃ­na: ${latest.proteinMass}kg</p>
                    <p>Minerais: ${latest.mineralMass}kg</p>
                  </div>
                ` : ''}
                ${latest.phaseAngle ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">âš¡ BIA - ImpedÃ¢ncia</p>
                    <p>Ã‚ngulo de Fase: ${latest.phaseAngle}Â°</p>
                    <p>ImpedÃ¢ncia: ${latest.impedance}Î©</p>
                    <p>ResistÃªncia: ${latest.resistance}Î©</p>
                  </div>
                ` : ''}
                ${latest.chest ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">ðŸ“ CircunferÃªncias (cm)</p>
                    <p>Peito: ${latest.chest} | Cintura: ${latest.waist}</p>
                    <p>BraÃ§o D: ${latest.rightArm} | E: ${latest.leftArm}</p>
                    <p>Coxa D: ${latest.rightThigh} | E: ${latest.leftThigh}</p>
                  </div>
                ` : ''}
                ${latest.tdee ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">âš¡ Taxas MetabÃ³licas</p>
                    <p>TMB: ${latest.bmr} kcal/dia</p>
                    <p>TMR: ${latest.rmr} kcal/dia</p>
                    <p>TDEE: ${latest.tdee} kcal/dia</p>
                  </div>
                ` : ''}
              </div>
            `;
          })()}
        </div>
      ` : ''}
    </div>
  `;
}

function renderComparacao() {
  const comps = state.comparisons || [];
  return `
    <div class="bg-slate-800 p-4 rounded">
      <h3 class="font-bold">ComparaÃ§Ãµes</h3>
      ${comps.length === 0 ? '<p class="text-slate-400">Nenhuma comparaÃ§Ã£o criada.</p>' : comps.map(c => `
        <div class="bg-slate-700 p-3 rounded mb-2">
          <p class="font-bold">${c.title}</p>
          <p class="text-slate-300 text-xs">Criado ${new Date(c.createdAt).toLocaleString()}</p>
          <div class="mt-2 flex gap-2"><button onclick="handleDeleteComparison('${c.id}')" class="bg-red-500 px-3 py-1 rounded">Remover</button></div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderCiencia() {
  const filtered = (state.references || []).filter(r => r.year >= 2020 && r.year <= 2025);
  return `
    <div class="bg-slate-800 p-4 rounded">
      <div class="flex justify-between items-center">
        <h3 class="font-bold">Estudos cientÃ­ficos (2020 â†’ 2025-11)</h3>
        <div class="flex gap-2">
          <button onclick="importScientificStudiesSeed()" class="bg-green-600 px-3 py-1 rounded">â¤“ Importar estudos</button>
          <button onclick="exportReferencesJSON()" class="bg-blue-600 px-3 py-1 rounded">â¬‡ï¸ Exportar JSON</button>
          <button onclick="clearReferences()" class="bg-red-600 px-3 py-1 rounded">ðŸ—„ï¸ Mover p/ archive</button>
        </div>
      </div>

      <div class="mt-4">
        ${filtered.length === 0 ? '<p class="text-slate-400">Nenhuma referÃªncia importada. Use o botÃ£o importar.</p>' : filtered.map(ref => `
          <div class="bg-slate-700 p-3 rounded mb-3">
            <p class="font-bold">${ref.title}</p>
            <p class="text-slate-300 text-xs">${ref.authors} â€” ${ref.year} â€¢ ${ref.journal}</p>
            <p class="text-slate-400 text-sm mt-2">${ref.summary || ''}</p>
            <p class="mt-2"><a href="${ref.link}" target="_blank" class="text-blue-300 underline">Abrir estudo / DOI</a></p>
            <div class="mt-2 flex gap-2">
              <button onclick="navigator.clipboard.writeText('${ref.link}').then(()=>alert('Link copiado'))" class="bg-white text-black px-2 py-1 rounded">Copiar link</button>
              <button onclick="if(confirm('Mover esta referÃªncia para archive?')) { archiveItem('references','${ref.id}','reference', ${JSON.stringify(ref).replace(/'/g, "\\'")}).then(()=>{ state.references = state.references.filter(r=>r.id!=='${ref.id}'); saveAllToDB(); render(); alert('Movido para archive') }) }" class="text-red-400">Arquivar</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function renderExercicios(user) {
  const exercises = getAllUniqueExercises(user);
  const selectedExercise = state.selectedExercise || (exercises.length > 0 ? exercises[0] : null);
  
  if (!selectedExercise && exercises.length === 0) {
    return `
      <div class="bg-slate-800 p-6 rounded">
        <h3 class="font-bold text-xl mb-4">ðŸ’ª HistÃ³rico por ExercÃ­cio</h3>
        <p class="text-slate-400">Nenhum exercÃ­cio registrado ainda. VÃ¡ para a aba Treinos e registre alguns exercÃ­cios primeiro.</p>
      </div>
    `;
  }
  
  const history = selectedExercise ? getExerciseHistory(user, selectedExercise) : [];
  const stats = selectedExercise ? getExerciseStats(user, selectedExercise) : {};
  
  return `
    <div class="space-y-6">
      <!-- Exercise Selector -->
      <div class="bg-slate-800 p-4 rounded">
        <h3 class="font-bold text-xl mb-4">ðŸ’ª HistÃ³rico por ExercÃ­cio</h3>
        <div class="mb-4">
          <label class="block text-sm text-slate-300 mb-2">Selecione um exercÃ­cio:</label>
          <select onchange="state.selectedExercise=this.value; render();" class="w-full md:w-1/2 px-4 py-2 rounded bg-slate-700 text-white">
            ${exercises.map(ex => `<option value="${ex}" ${ex === selectedExercise ? 'selected' : ''}>${ex}</option>`).join('')}
          </select>
        </div>
      </div>
      
      <!-- Exercise Stats -->
      <div class="bg-gradient-to-r from-purple-700 to-indigo-800 p-6 rounded-xl">
        <h4 class="font-bold text-xl mb-4">ðŸ“Š EstatÃ­sticas de ${selectedExercise}</h4>
        <div class="grid md:grid-cols-4 gap-4">
          <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
            <p class="text-sm text-purple-200 mb-1">Total de Treinos</p>
            <p class="text-3xl font-bold">${stats.totalWorkouts}</p>
          </div>
          <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
            <p class="text-sm text-purple-200 mb-1">Carga MÃ¡xima</p>
            <p class="text-3xl font-bold">${stats.maxWeight}</p>
            <p class="text-xs text-purple-300">kg</p>
          </div>
          <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
            <p class="text-sm text-purple-200 mb-1">Reps MÃ¡ximo</p>
            <p class="text-3xl font-bold">${stats.maxReps}</p>
          </div>
          <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
            <p class="text-sm text-purple-200 mb-1">Volume MÃ¡ximo</p>
            <p class="text-3xl font-bold">${Math.round(stats.maxVolume)}</p>
            <p class="text-xs text-purple-300">kg total</p>
          </div>
        </div>
        ${stats.firstWorkout ? `
          <div class="mt-4 text-sm text-purple-200">
            <p>Primeiro treino: ${new Date(stats.firstWorkout).toLocaleDateString('pt-BR')}</p>
            <p>Ãšltimo treino: ${new Date(stats.lastWorkout).toLocaleDateString('pt-BR')}</p>
          </div>
        ` : ''}
      </div>
      
      <!-- History Table -->
      <div class="bg-slate-800 p-4 rounded">
        <h4 class="font-bold text-lg mb-4">ðŸ“‹ HistÃ³rico Completo</h4>
        ${history.length === 0 ? 
          '<p class="text-slate-400">Nenhum registro encontrado para este exercÃ­cio.</p>' :
          `<div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-slate-600">
                  <th class="py-2 px-2 text-left">Data</th>
                  <th class="py-2 px-2 text-left">SÃ©ries</th>
                  <th class="py-2 px-2 text-left">Reps</th>
                  <th class="py-2 px-2 text-left">Carga (kg)</th>
                  <th class="py-2 px-2 text-left">Volume</th>
                  <th class="py-2 px-2 text-left">AÃ§Ãµes</th>
                </tr>
              </thead>
              <tbody>
                ${history.slice().reverse().map(log => {
                  const weight = parseNumber(log.weight);
                  const reps = parseNumber(log.reps);
                  const sets = parseNumber(log.sets);
                  const volume = weight * reps * sets;
                  
                  return `
                    <tr class="border-b border-slate-700 hover:bg-slate-700">
                      <td class="py-2 px-2">${new Date(log.date).toLocaleDateString('pt-BR')}</td>
                      <td class="py-2 px-2">${log.sets}</td>
                      <td class="py-2 px-2">${log.reps}</td>
                      <td class="py-2 px-2">${log.weight}</td>
                      <td class="py-2 px-2">${volume > 0 ? Math.round(volume) + ' kg' : '-'}</td>
                      <td class="py-2 px-2">
                        <button onclick="handleEditWorkout(${log.id})" class="text-blue-400 hover:text-blue-300 mr-2" title="Editar">âœï¸</button>
                        <button onclick="handleDeleteWorkout(${log.id})" class="text-red-400 hover:text-red-300" title="Excluir">ðŸ—‘ï¸</button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>`
        }
      </div>
      
      <!-- Progression Chart -->
      ${history.length >= 2 ? `
        <div class="bg-slate-800 p-4 rounded">
          <h4 class="font-bold text-lg mb-4">ðŸ“ˆ ProgressÃ£o de Carga</h4>
          <canvas id="exerciseProgressionChart" height="100"></canvas>
        </div>
      ` : ''}
    </div>
  `;
}

function renderFotosProgresso(user) {
  if (!user.progressPhotos) user.progressPhotos = [];
  
  const photos = user.progressPhotos.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
  
  return `
    <div class="space-y-6">
      <!-- Upload Form -->
      <div class="bg-slate-800 p-6 rounded">
        <h3 class="font-bold text-xl mb-4">ðŸ“¸ Adicionar Foto de Progresso</h3>
        <form id="progressPhotoForm" class="space-y-4">
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-slate-300 mb-2">Data da foto:</label>
              <input type="date" name="photoDate" value="${new Date().toISOString().split('T')[0]}" required class="w-full px-4 py-2 rounded bg-slate-700 text-white" />
            </div>
            <div>
              <label class="block text-sm text-slate-300 mb-2">Notas (opcional):</label>
              <input type="text" name="photoNotes" placeholder="Ex: ApÃ³s 3 meses de treino" class="w-full px-4 py-2 rounded bg-slate-700 text-white" />
            </div>
          </div>
          <div>
            <label class="block text-sm text-slate-300 mb-2">Selecione a foto:</label>
            <input type="file" name="photoFile" accept="image/*" required class="w-full px-4 py-2 rounded bg-slate-700 text-white" />
            <p class="text-xs text-slate-400 mt-1">Tamanho mÃ¡ximo: 5MB. Formatos: JPG, PNG, WEBP</p>
          </div>
          <button type="submit" class="bg-purple-600 hover:bg-purple-500 px-6 py-3 rounded font-semibold">ðŸ“¸ Adicionar Foto</button>
        </form>
      </div>
      
      <!-- Photos Grid -->
      <div class="bg-slate-800 p-6 rounded">
        <h3 class="font-bold text-xl mb-4">ðŸ–¼ï¸ Galeria de Progresso</h3>
        ${photos.length === 0 ? 
          '<p class="text-slate-400">Nenhuma foto adicionada ainda. Use o formulÃ¡rio acima para adicionar sua primeira foto de progresso!</p>' :
          `<div class="grid md:grid-cols-3 gap-4">
            ${photos.map(photo => `
              <div class="bg-slate-700 p-3 rounded">
                <img src="${photo.imageData}" alt="Foto de ${escapeHtml(photo.date)}" class="w-full h-64 object-cover rounded mb-3" />
                <div class="space-y-1">
                  <p class="font-bold text-lg">${new Date(photo.date).toLocaleDateString('pt-BR')}</p>
                  ${photo.notes ? `<p class="text-sm text-slate-300">${escapeHtml(photo.notes)}</p>` : ''}
                  <p class="text-xs text-slate-400">Adicionada em ${new Date(photo.uploadedAt).toLocaleDateString('pt-BR')}</p>
                  <button onclick="handleDeleteProgressPhoto('${photo.id}')" class="mt-2 bg-red-600 hover:bg-red-500 px-3 py-1 rounded text-sm w-full">ðŸ—‘ï¸ Excluir</button>
                </div>
              </div>
            `).join('')}
          </div>`
        }
      </div>
      
      <!-- Comparison Tool -->
      ${photos.length >= 2 ? `
        <div class="bg-slate-800 p-6 rounded">
          <h3 class="font-bold text-xl mb-4">âš–ï¸ Comparar Fotos</h3>
          <p class="text-slate-300 text-sm mb-4">Selecione duas fotos para comparÃ¡-las lado a lado:</p>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-slate-300 mb-2">Foto 1 (Antes):</label>
              <select id="comparePhoto1" class="w-full px-4 py-2 rounded bg-slate-700 text-white">
                <option value="">Selecione...</option>
                ${photos.map(p => `<option value="${p.id}">${new Date(p.date).toLocaleDateString('pt-BR')} ${p.notes ? '- ' + escapeHtml(p.notes) : ''}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-sm text-slate-300 mb-2">Foto 2 (Depois):</label>
              <select id="comparePhoto2" class="w-full px-4 py-2 rounded bg-slate-700 text-white">
                <option value="">Selecione...</option>
                ${photos.map(p => `<option value="${p.id}">${new Date(p.date).toLocaleDateString('pt-BR')} ${p.notes ? '- ' + escapeHtml(p.notes) : ''}</option>`).join('')}
              </select>
            </div>
          </div>
          <button onclick="compareProgressPhotos()" class="mt-4 bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded font-semibold">ðŸ‘ï¸ Comparar</button>
          
          <div id="comparisonResult" class="mt-6 hidden">
            <div class="grid md:grid-cols-2 gap-4">
              <div id="compareImg1Container"></div>
              <div id="compareImg2Container"></div>
            </div>
          </div>
        </div>
      ` : ''}
      
      <!-- Tips -->
      <div class="bg-gradient-to-r from-cyan-900 to-blue-900 p-6 rounded">
        <h4 class="font-bold text-lg mb-3">ðŸ’¡ Dicas para Fotos de Progresso</h4>
        <ul class="space-y-2 text-sm text-slate-200">
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">âœ“</span>
            <span><strong>Mesma iluminaÃ§Ã£o:</strong> Tire fotos sempre no mesmo local e horÃ¡rio para comparaÃ§Ã£o justa.</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">âœ“</span>
            <span><strong>Mesma pose:</strong> Use poses consistentes (frente, lado, costas) em todas as fotos.</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">âœ“</span>
            <span><strong>FrequÃªncia:</strong> Tire fotos a cada 2-4 semanas para ver progresso real.</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">âœ“</span>
            <span><strong>Privacidade:</strong> Suas fotos ficam armazenadas localmente no seu navegador.</span>
          </li>
        </ul>
      </div>
    </div>
  `;
}

/* ============================= ADMIN RENDER FUNCTIONS ============================= */

function renderAdminTasks() {
  return `
    <div class="space-y-6">
      <!-- Admin Header -->
      <div class="bg-gradient-to-r from-red-900 to-orange-900 p-6 rounded-xl border border-red-500">
        <h2 class="text-3xl font-bold mb-2">ðŸ‘‘ Painel do Administrador - Tarefas</h2>
        <p class="text-red-200">Gerencie as tarefas do roadmap e acompanhe o progresso do projeto</p>
      </div>

      <!-- Task Stats -->
      <div class="grid md:grid-cols-4 gap-4" id="taskStats">
        <div class="bg-slate-800 p-4 rounded-lg">
          <p class="text-slate-400 text-sm">Total de Tarefas</p>
          <p class="text-3xl font-bold text-white" id="totalTasks">-</p>
        </div>
        <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/30">
          <p class="text-green-400 text-sm">ConcluÃ­das</p>
          <p class="text-3xl font-bold text-green-300" id="doneTasks">-</p>
        </div>
        <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/30">
          <p class="text-yellow-400 text-sm">Em Progresso</p>
          <p class="text-3xl font-bold text-yellow-300" id="inProgressTasks">-</p>
        </div>
        <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/30">
          <p class="text-blue-400 text-sm">A Fazer</p>
          <p class="text-3xl font-bold text-blue-300" id="todoTasks">-</p>
        </div>
      </div>

      <!-- Create Task Button -->
      <div class="flex justify-between items-center">
        <h3 class="text-xl font-bold">ðŸ“‹ Tarefas do Roadmap</h3>
        <button onclick="showCreateTaskModal()" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg font-semibold">
          âž• Nova Tarefa
        </button>
      </div>

      <!-- Task Categories -->
      <div class="space-y-6" id="tasksList">
        <p class="text-slate-400">Carregando tarefas...</p>
      </div>

      <!-- Export Button -->
      <div class="flex gap-3">
        <button onclick="exportTasksToMarkdown()" class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-lg font-semibold">
          ðŸ“„ Exportar Tarefas (Markdown)
        </button>
        <button onclick="exportTasksToJSON()" class="bg-purple-600 hover:bg-purple-500 px-6 py-3 rounded-lg font-semibold">
          ðŸ’¾ Exportar JSON
        </button>
      </div>
    </div>
  `;
}

function renderAdminSuggestions() {
  return `
    <div class="space-y-6">
      <!-- Admin Header -->
      <div class="bg-gradient-to-r from-purple-900 to-indigo-900 p-6 rounded-xl border border-purple-500">
        <h2 class="text-3xl font-bold mb-2">ðŸ’¡ Painel do Administrador - SugestÃµes</h2>
        <p class="text-purple-200">Gerencie sugestÃµes e feedback dos usuÃ¡rios</p>
      </div>

      <!-- Suggestion Stats -->
      <div class="grid md:grid-cols-4 gap-4" id="suggestionStats">
        <div class="bg-slate-800 p-4 rounded-lg">
          <p class="text-slate-400 text-sm">Total</p>
          <p class="text-3xl font-bold text-white" id="totalSuggestions">-</p>
        </div>
        <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/30">
          <p class="text-yellow-400 text-sm">Pendentes</p>
          <p class="text-3xl font-bold text-yellow-300" id="pendingSuggestions">-</p>
        </div>
        <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/30">
          <p class="text-green-400 text-sm">Aprovadas</p>
          <p class="text-3xl font-bold text-green-300" id="approvedSuggestions">-</p>
        </div>
        <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/30">
          <p class="text-blue-400 text-sm">Implementadas</p>
          <p class="text-3xl font-bold text-blue-300" id="implementedSuggestions">-</p>
        </div>
      </div>

      <!-- Export to GitHub -->
      <div class="bg-slate-800 p-4 rounded-lg border border-green-500/30">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-bold mb-1">ðŸ”„ Sincronizar com GitHub</h3>
            <p class="text-slate-400 text-sm">Exporte todas as sugestÃµes para um arquivo Markdown compatÃ­vel com GitHub Issues</p>
          </div>
          <button onclick="exportSuggestionsToGitHubFormat()" class="bg-green-600 hover:bg-green-500 px-6 py-3 rounded-lg font-semibold whitespace-nowrap">
            ðŸ“¤ Exportar para GitHub
          </button>
        </div>
      </div>

      <!-- Suggestions List -->
      <div class="space-y-4" id="suggestionsList">
        <p class="text-slate-400">Carregando sugestÃµes...</p>
      </div>
    </div>
  `;
}

function renderAdminSecurity() {
  return `
    <div class="space-y-6">
      <!-- Admin Header -->
      <div class="bg-gradient-to-r from-red-900 to-pink-900 p-6 rounded-xl border border-red-500">
        <h2 class="text-3xl font-bold mb-2">ðŸ” Painel do Administrador - SeguranÃ§a</h2>
        <p class="text-red-200">Monitore eventos de seguranÃ§a e atividades suspeitas</p>
      </div>

      <!-- Security Stats -->
      <div class="grid md:grid-cols-4 gap-4" id="securityStats">
        <div class="bg-slate-800 p-4 rounded-lg">
          <p class="text-slate-400 text-sm">Total de Eventos</p>
          <p class="text-3xl font-bold text-white" id="totalSecurityEvents">-</p>
        </div>
        <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/30">
          <p class="text-green-400 text-sm">Logins Sucesso</p>
          <p class="text-3xl font-bold text-green-300" id="successfulLogins">-</p>
        </div>
        <div class="bg-red-900/30 p-4 rounded-lg border border-red-500/30">
          <p class="text-red-400 text-sm">Logins Falhados</p>
          <p class="text-3xl font-bold text-red-300" id="failedLogins">-</p>
        </div>
        <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/30">
          <p class="text-yellow-400 text-sm">Contas Bloqueadas</p>
          <p class="text-3xl font-bold text-yellow-300" id="blockedAccounts">-</p>
        </div>
      </div>

      <!-- Security Events List -->
      <div class="bg-slate-800 p-4 rounded-lg">
        <h3 class="text-xl font-bold mb-4">ðŸ“Š Eventos de SeguranÃ§a Recentes</h3>
        <div id="securityEventsList">
          <p class="text-slate-400">Carregando eventos...</p>
        </div>
      </div>

      <!-- Account Management -->
      <div class="bg-slate-800 p-4 rounded-lg">
        <h3 class="text-xl font-bold mb-4">ðŸ‘¥ Gerenciamento de Contas</h3>
        <div id="accountsList">
          <p class="text-slate-400">Carregando contas...</p>
        </div>
      </div>

      <!-- Export Buttons -->
      <div class="flex gap-3">
        <button onclick="exportSecurityLogs()" class="bg-red-600 hover:bg-red-500 px-6 py-3 rounded-lg font-semibold">
          ðŸ“„ Exportar Logs de SeguranÃ§a
        </button>
        <button onclick="clearOldSecurityLogs()" class="bg-orange-600 hover:bg-orange-500 px-6 py-3 rounded-lg font-semibold">
          ðŸ—‘ï¸ Limpar Logs Antigos (>30 dias)
        </button>
      </div>
    </div>
  `;
}

function renderUserSuggestions() {
  return `
    <div class="space-y-6">
      <!-- Header -->
      <div class="bg-gradient-to-r from-green-900 to-teal-900 p-6 rounded-xl border border-green-500">
        <h2 class="text-3xl font-bold mb-2">ðŸ’¡ SugestÃµes e Feedback</h2>
        <p class="text-green-200">Compartilhe suas ideias para melhorar o Fitness Tracker Pro</p>
      </div>

      <!-- Submit Suggestion Form -->
      <div class="bg-slate-800 p-6 rounded-lg">
        <h3 class="text-xl font-bold mb-4">ðŸ“ Enviar Nova SugestÃ£o</h3>
        <form id="suggestionForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">TÃ­tulo da SugestÃ£o *</label>
            <input type="text" name="title" required maxlength="100" 
                   class="w-full px-4 py-2 rounded-lg bg-slate-700 text-white focus:ring-2 focus:ring-green-500"
                   placeholder="Ex: Adicionar timer de descanso entre sÃ©ries" />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">DescriÃ§Ã£o Detalhada *</label>
            <textarea name="description" required maxlength="500" rows="4"
                      class="w-full px-4 py-2 rounded-lg bg-slate-700 text-white focus:ring-2 focus:ring-green-500"
                      placeholder="Descreva sua sugestÃ£o em detalhes..."></textarea>
            <p class="text-xs text-slate-400 mt-1">MÃ¡ximo 500 caracteres</p>
          </div>
          
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Categoria</label>
              <select name="category" class="w-full px-4 py-2 rounded-lg bg-slate-700 text-white">
                <option value="feature">Nova Funcionalidade</option>
                <option value="improvement">Melhoria</option>
                <option value="bugfix">CorreÃ§Ã£o de Bug</option>
                <option value="ui">Interface/Design</option>
                <option value="performance">Performance</option>
                <option value="other">Outro</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Prioridade</label>
              <select name="priority" class="w-full px-4 py-2 rounded-lg bg-slate-700 text-white">
                <option value="low">Baixa</option>
                <option value="medium" selected>MÃ©dia</option>
                <option value="high">Alta</option>
                <option value="critical">CrÃ­tica</option>
              </select>
            </div>
          </div>

          <button type="submit" class="w-full bg-green-600 hover:bg-green-500 px-6 py-3 rounded-lg font-semibold text-lg">
            âœ¨ Enviar SugestÃ£o
          </button>
        </form>
      </div>

      <!-- Existing Suggestions -->
      <div class="bg-slate-800 p-6 rounded-lg">
        <h3 class="text-xl font-bold mb-4">ðŸ“‹ SugestÃµes da Comunidade</h3>
        <p class="text-slate-400 text-sm mb-4">Vote nas sugestÃµes que vocÃª mais gostaria de ver implementadas</p>
        <div id="userSuggestionsList">
          <p class="text-slate-400">Carregando sugestÃµes...</p>
        </div>
      </div>
    </div>
  `;
}

/* ----------------------------- Chart rendering ----------------------------- */
function renderMuscleEvolutionChart(bodyMetrics, userId) {
  const canvas = document.getElementById('muscleChart');
  if (!canvas) return;
  const metrics = (bodyMetrics || []).slice().sort((a,b) => new Date(a.date) - new Date(b.date));
  const labels = metrics.map(m => m.date);
  const muscleMassData = metrics.map(m => m.muscleMass || null);
  const muscleSizeData = metrics.map(m => m.muscleSize || null);
  const datasets = [];
  if (muscleMassData.some(v => v !== null)) datasets.push({ label: 'Massa Muscular (kg)', data: muscleMassData, borderColor: '#34D399', backgroundColor: '#34D39933', tension: 0.2, yAxisID: 'y' });
  if (muscleSizeData.some(v => v !== null)) datasets.push({ label: 'Tamanho MÃºsculo (cm)', data: muscleSizeData, borderColor: '#60A5FA', backgroundColor: '#60A5FA33', tension: 0.2, yAxisID: 'y2' });
  const config = {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      scales: {
        y: { beginAtZero: false, title: { display: true, text: 'kg' } },
        y2: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'cm' } }
      }
    }
  };
  if (muscleChart) { muscleChart.destroy(); muscleChart = null; }
  muscleChart = new Chart(canvas, config);
}

function compareProgressPhotos() {
  const photo1Id = document.getElementById('comparePhoto1')?.value;
  const photo2Id = document.getElementById('comparePhoto2')?.value;
  
  if (!photo1Id || !photo2Id) {
    alert('Selecione duas fotos para comparar');
    return;
  }
  
  if (photo1Id === photo2Id) {
    alert('Selecione fotos diferentes para comparar');
    return;
  }
  
  const user = state.users[state.activeUser];
  const photo1 = user.progressPhotos.find(p => p.id === photo1Id);
  const photo2 = user.progressPhotos.find(p => p.id === photo2Id);
  
  if (!photo1 || !photo2) {
    alert('Fotos nÃ£o encontradas');
    return;
  }
  
  const resultDiv = document.getElementById('comparisonResult');
  const img1Container = document.getElementById('compareImg1Container');
  const img2Container = document.getElementById('compareImg2Container');
  
  img1Container.innerHTML = `
    <div class="bg-slate-700 p-3 rounded">
      <img src="${photo1.imageData}" alt="Foto 1" class="w-full h-96 object-cover rounded mb-3" />
      <p class="font-bold text-lg">${new Date(photo1.date).toLocaleDateString('pt-BR')}</p>
      ${photo1.notes ? `<p class="text-sm text-slate-300">${escapeHtml(photo1.notes)}</p>` : ''}
    </div>
  `;
  
  img2Container.innerHTML = `
    <div class="bg-slate-700 p-3 rounded">
      <img src="${photo2.imageData}" alt="Foto 2" class="w-full h-96 object-cover rounded mb-3" />
      <p class="font-bold text-lg">${new Date(photo2.date).toLocaleDateString('pt-BR')}</p>
      ${photo2.notes ? `<p class="text-sm text-slate-300">${escapeHtml(photo2.notes)}</p>` : ''}
    </div>
  `;
  
  resultDiv.classList.remove('hidden');
}

/* ============================= AUTHENTICATION UI ============================= */

function renderLoginPage() {
  const app = document.getElementById('app');
  
  app.innerHTML = `
    <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4">
      <div class="max-w-md w-full">
        <!-- Logo and Title -->
        <div class="text-center mb-8">
          <h1 class="text-5xl font-bold mb-2">ðŸ’ª</h1>
          <h2 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent mb-2">
            Fitness Tracker Pro
          </h2>
          <p class="text-slate-300 text-sm">Sistema seguro de acompanhamento fitness</p>
        </div>

        <!-- Security Features Badge -->
        <div class="bg-gradient-to-r from-green-900 to-emerald-900 p-4 rounded-lg mb-6 border border-green-500">
          <h3 class="font-bold text-green-300 mb-2 flex items-center gap-2">
            ðŸ” ProteÃ§Ãµes de SeguranÃ§a 2025
          </h3>
          <div class="text-xs text-green-200 space-y-1">
            <p>âœ“ Criptografia de senha com PBKDF2 (100k iteraÃ§Ãµes)</p>
            <p>âœ“ ProteÃ§Ã£o contra brute force e XSS</p>
            <p>âœ“ Rate limiting e CSRF protection</p>
            <p>âœ“ Dados armazenados localmente (privacidade garantida)</p>
          </div>
        </div>

        <!-- Login/Register Tabs -->
        <div class="bg-slate-800 rounded-lg shadow-2xl overflow-hidden border border-purple-500/30">
          <!-- Tab Headers -->
          <div class="flex border-b border-slate-700">
            <button 
              id="loginTab" 
              onclick="switchAuthTab('login')" 
              class="flex-1 py-3 px-4 font-semibold bg-purple-600 text-white"
            >
              Entrar
            </button>
            <button 
              id="registerTab" 
              onclick="switchAuthTab('register')" 
              class="flex-1 py-3 px-4 font-semibold bg-slate-700 text-slate-300 hover:bg-slate-600"
            >
              Registrar
            </button>
          </div>

          <!-- Login Form -->
          <div id="loginForm" class="p-6">
            <form onsubmit="handleLoginSubmit(event)" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  UsuÃ¡rio
                </label>
                <input 
                  type="text" 
                  id="loginUsername" 
                  name="username" 
                  required 
                  class="w-full px-4 py-3 bg-slate-700 text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="Seu nome de usuÃ¡rio"
                  autocomplete="username"
                />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  Senha
                </label>
                <input 
                  type="password" 
                  id="loginPassword" 
                  name="password" 
                  required 
                  class="w-full px-4 py-3 bg-slate-700 text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="Sua senha"
                  autocomplete="current-password"
                />
              </div>

              <div id="loginError" class="hidden bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm"></div>

              <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 px-4 rounded-lg transition-all"
              >
                ðŸ” Entrar
              </button>
            </form>
          </div>

          <!-- Register Form -->
          <div id="registerForm" class="p-6 hidden">
            <form onsubmit="handleRegisterSubmit(event)" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  Nome de usuÃ¡rio
                </label>
                <input 
                  type="text" 
                  id="registerUsername" 
                  name="username" 
                  required 
                  pattern="[a-zA-Z0-9_]{3,20}"
                  class="w-full px-4 py-3 bg-slate-700 text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="3-20 caracteres (letras, nÃºmeros, _)"
                  autocomplete="username"
                />
                <p class="text-xs text-slate-400 mt-1">Apenas letras, nÃºmeros e underscore</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  Email
                </label>
                <input 
                  type="email" 
                  id="registerEmail" 
                  name="email" 
                  required 
                  class="w-full px-4 py-3 bg-slate-700 text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="seu@email.com"
                  autocomplete="email"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  Senha
                </label>
                <input 
                  type="password" 
                  id="registerPassword" 
                  name="password" 
                  required 
                  class="w-full px-4 py-3 bg-slate-700 text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="Senha forte"
                  autocomplete="new-password"
                />
                <div class="mt-2 space-y-1 text-xs">
                  <p class="text-slate-400">Requisitos da senha:</p>
                  <div class="flex flex-wrap gap-2">
                    <span id="reqLength" class="px-2 py-1 rounded bg-slate-700 text-slate-400">MÃ­n. 8 caracteres</span>
                    <span id="reqUpper" class="px-2 py-1 rounded bg-slate-700 text-slate-400">MaiÃºscula</span>
                    <span id="reqLower" class="px-2 py-1 rounded bg-slate-700 text-slate-400">MinÃºscula</span>
                    <span id="reqNumber" class="px-2 py-1 rounded bg-slate-700 text-slate-400">NÃºmero</span>
                    <span id="reqSpecial" class="px-2 py-1 rounded bg-slate-700 text-slate-400">Especial</span>
                  </div>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  Confirmar senha
                </label>
                <input 
                  type="password" 
                  id="registerPasswordConfirm" 
                  name="passwordConfirm" 
                  required 
                  class="w-full px-4 py-3 bg-slate-700 text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="Digite a senha novamente"
                  autocomplete="new-password"
                />
              </div>

              <div id="registerError" class="hidden bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm"></div>
              <div id="registerSuccess" class="hidden bg-green-900/50 border border-green-500 text-green-200 px-4 py-3 rounded-lg text-sm"></div>

              <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-3 px-4 rounded-lg transition-all"
              >
                âœ¨ Criar Conta
              </button>
            </form>
          </div>
        </div>

        <!-- Footer -->
        <div class="mt-6 text-center text-sm text-slate-400">
          <p>ðŸ”’ Seus dados ficam armazenados apenas no seu navegador</p>
          <p class="mt-2">Â© 2025 Fitness Tracker Pro - Todos os direitos reservados</p>
        </div>
      </div>
    </div>
  `;

  // Add password strength indicator
  const passwordInput = document.getElementById('registerPassword');
  if (passwordInput) {
    passwordInput.addEventListener('input', updatePasswordStrength);
  }
}

function switchAuthTab(tab) {
  const loginTab = document.getElementById('loginTab');
  const registerTab = document.getElementById('registerTab');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');

  if (tab === 'login') {
    loginTab.classList.remove('bg-slate-700', 'text-slate-300');
    loginTab.classList.add('bg-purple-600', 'text-white');
    registerTab.classList.remove('bg-purple-600', 'text-white');
    registerTab.classList.add('bg-slate-700', 'text-slate-300');
    loginForm.classList.remove('hidden');
    registerForm.classList.add('hidden');
  } else {
    registerTab.classList.remove('bg-slate-700', 'text-slate-300');
    registerTab.classList.add('bg-purple-600', 'text-white');
    loginTab.classList.remove('bg-purple-600', 'text-white');
    loginTab.classList.add('bg-slate-700', 'text-slate-300');
    registerForm.classList.remove('hidden');
    loginForm.classList.add('hidden');
  }
}

function updatePasswordStrength() {
  const password = document.getElementById('registerPassword').value;
  
  // Check requirements
  const checks = {
    length: password.length >= 8,
    upper: /[A-Z]/.test(password),
    lower: /[a-z]/.test(password),
    number: /[0-9]/.test(password),
    special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
  };

  // Update UI
  updateRequirement('reqLength', checks.length);
  updateRequirement('reqUpper', checks.upper);
  updateRequirement('reqLower', checks.lower);
  updateRequirement('reqNumber', checks.number);
  updateRequirement('reqSpecial', checks.special);
}

function updateRequirement(id, met) {
  const elem = document.getElementById(id);
  if (!elem) return;
  
  if (met) {
    elem.classList.remove('bg-slate-700', 'text-slate-400');
    elem.classList.add('bg-green-600', 'text-white');
  } else {
    elem.classList.remove('bg-green-600', 'text-white');
    elem.classList.add('bg-slate-700', 'text-slate-400');
  }
}

async function handleLoginSubmit(event) {
  event.preventDefault();
  
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;
  const errorDiv = document.getElementById('loginError');
  
  // Hide previous errors
  errorDiv.classList.add('hidden');
  
  try {
    await loginAccount(username, password);
    
    // Link default profiles to account if this is first login
    if (authState.currentAccount.linkedProfiles.length === 0) {
      // Auto-link existing profiles
      for (const profileId of Object.keys(state.users)) {
        await linkProfileToAccount(username, profileId);
      }
    }
    
    render();
  } catch (error) {
    errorDiv.textContent = error.message;
    errorDiv.classList.remove('hidden');
  }
}

async function handleRegisterSubmit(event) {
  event.preventDefault();
  
  const username = document.getElementById('registerUsername').value;
  const email = document.getElementById('registerEmail').value;
  const password = document.getElementById('registerPassword').value;
  const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
  const errorDiv = document.getElementById('registerError');
  const successDiv = document.getElementById('registerSuccess');
  
  // Hide previous messages
  errorDiv.classList.add('hidden');
  successDiv.classList.add('hidden');
  
  // Check password confirmation
  if (password !== passwordConfirm) {
    errorDiv.textContent = 'As senhas nÃ£o coincidem.';
    errorDiv.classList.remove('hidden');
    return;
  }
  
  try {
    await registerAccount(username, email, password);
    
    successDiv.textContent = 'âœ… Conta criada com sucesso! VocÃª jÃ¡ pode fazer login.';
    successDiv.classList.remove('hidden');
    
    // Clear form
    event.target.reset();
    
    // Switch to login tab after 2 seconds
    setTimeout(() => {
      switchAuthTab('login');
      document.getElementById('loginUsername').value = username;
    }, 2000);
    
  } catch (error) {
    errorDiv.textContent = error.message;
    errorDiv.classList.remove('hidden');
  }
}

function handleLogout() {
  if (confirm('Deseja realmente sair?')) {
    destroySession();
    render();
  }
}

/* ============================= ADMIN HANDLER FUNCTIONS ============================= */

// Load and display tasks
async function loadAndDisplayTasks() {
  const tasks = await getAllTasks();
  
  // Update stats
  const stats = {
    total: tasks.length,
    done: tasks.filter(t => t.status === TASK_STATUSES.DONE).length,
    inProgress: tasks.filter(t => t.status === TASK_STATUSES.IN_PROGRESS).length,
    todo: tasks.filter(t => t.status === TASK_STATUSES.TODO).length
  };
  
  document.getElementById('totalTasks').textContent = stats.total;
  document.getElementById('doneTasks').textContent = stats.done;
  document.getElementById('inProgressTasks').textContent = stats.inProgress;
  document.getElementById('todoTasks').textContent = stats.todo;
  
  // Group by category
  const categories = {
    [TASK_CATEGORIES.SHORT_TERM]: tasks.filter(t => t.category === TASK_CATEGORIES.SHORT_TERM),
    [TASK_CATEGORIES.MEDIUM_TERM]: tasks.filter(t => t.category === TASK_CATEGORIES.MEDIUM_TERM),
    [TASK_CATEGORIES.LONG_TERM]: tasks.filter(t => t.category === TASK_CATEGORIES.LONG_TERM)
  };
  
  let html = '';
  
  for (const [category, categoryTasks] of Object.entries(categories)) {
    if (categoryTasks.length === 0) continue;
    
    const categoryName = category === TASK_CATEGORIES.SHORT_TERM ? 'Curto Prazo (1-2 semanas)' :
                         category === TASK_CATEGORIES.MEDIUM_TERM ? 'MÃ©dio Prazo (1-3 meses)' :
                         'Longo Prazo (3-6 meses)';
    
    html += `
      <div class="bg-slate-800 p-4 rounded-lg">
        <h4 class="text-lg font-bold mb-4">${categoryName}</h4>
        <div class="space-y-3">
    `;
    
    categoryTasks.forEach(task => {
      const priorityColor = task.priority === TASK_PRIORITIES.CRITICAL ? 'red' :
                            task.priority === TASK_PRIORITIES.HIGH ? 'orange' :
                            task.priority === TASK_PRIORITIES.MEDIUM ? 'yellow' : 'blue';
      
      const statusColor = task.status === TASK_STATUSES.DONE ? 'green' :
                          task.status === TASK_STATUSES.IN_PROGRESS ? 'blue' :
                          task.status === TASK_STATUSES.BLOCKED ? 'red' : 'slate';
      
      const completedItems = task.checklist.filter(i => i.done).length;
      const totalItems = task.checklist.length;
      const progress = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
      
      html += `
        <div class="bg-slate-700 p-4 rounded-lg border-l-4 border-${priorityColor}-500">
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
              <h5 class="font-bold text-lg mb-1">${task.title}</h5>
              <p class="text-slate-300 text-sm">${task.description}</p>
            </div>
            <div class="flex gap-2 ml-4">
              <span class="px-2 py-1 rounded text-xs bg-${priorityColor}-900 text-${priorityColor}-300 border border-${priorityColor}-500">
                ${task.priority}
              </span>
              <span class="px-2 py-1 rounded text-xs bg-${statusColor}-900 text-${statusColor}-300 border border-${statusColor}-500">
                ${task.status.replace('_', ' ')}
              </span>
            </div>
          </div>
          
          ${task.checklist.length > 0 ? `
            <div class="mt-3">
              <div class="flex justify-between items-center mb-2">
                <p class="text-sm text-slate-400">Progresso: ${completedItems}/${totalItems}</p>
                <p class="text-sm font-bold text-${progress === 100 ? 'green' : 'blue'}-400">${progress}%</p>
              </div>
              <div class="w-full bg-slate-600 rounded-full h-2 mb-3">
                <div class="bg-${progress === 100 ? 'green' : 'blue'}-500 h-2 rounded-full transition-all" style="width: ${progress}%"></div>
              </div>
              <div class="space-y-2">
                ${task.checklist.map(item => `
                  <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-slate-600 p-2 rounded">
                    <input type="checkbox" ${item.done ? 'checked' : ''} 
                           onchange="handleToggleChecklistItem('${task.id}', ${item.id})"
                           class="w-4 h-4 rounded" />
                    <span class="${item.done ? 'line-through text-slate-500' : 'text-slate-300'}">${item.text}</span>
                  </label>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          <div class="mt-3 flex gap-2">
            <button onclick="editTask('${task.id}')" class="text-sm px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded">
              âœï¸ Editar
            </button>
            <button onclick="changeTaskStatus('${task.id}')" class="text-sm px-3 py-1 bg-purple-600 hover:bg-purple-500 rounded">
              ðŸ”„ Mudar Status
            </button>
            <button onclick="deleteTaskConfirm('${task.id}')" class="text-sm px-3 py-1 bg-red-600 hover:bg-red-500 rounded">
              ðŸ—‘ï¸ Arquivar
            </button>
          </div>
        </div>
      `;
    });
    
    html += '</div></div>';
  }
  
  document.getElementById('tasksList').innerHTML = html || '<p class="text-slate-400">Nenhuma tarefa encontrada.</p>';
}

// Handle checklist item toggle
async function handleToggleChecklistItem(taskId, checklistItemId) {
  try {
    await toggleChecklistItem(taskId, checklistItemId);
    await loadAndDisplayTasks();
    showNotification('âœ… Item atualizado!', 'success');
  } catch (err) {
    showNotification('âŒ ' + err.message, 'error');
  }
}

// Show create task modal
function showCreateTaskModal() {
  const modal = prompt('Digite o tÃ­tulo da nova tarefa:');
  if (!modal) return;
  
  const description = prompt('Digite a descriÃ§Ã£o da tarefa:');
  if (!description) return;
  
  const category = prompt('Categoria (short_term/medium_term/long_term):', 'short_term');
  const priority = prompt('Prioridade (low/medium/high/critical):', 'medium');
  
  createTask({
    title: modal,
    description: description,
    category: category || 'short_term',
    priority: priority || 'medium'
  }).then(() => {
    showNotification('âœ… Tarefa criada!', 'success');
    loadAndDisplayTasks();
  }).catch(err => {
    showNotification('âŒ ' + err.message, 'error');
  });
}

// Change task status
async function changeTaskStatus(taskId) {
  const newStatus = prompt('Novo status (todo/in_progress/done/blocked):', 'in_progress');
  if (!newStatus) return;
  
  try {
    await updateTask(taskId, { status: newStatus });
    await loadAndDisplayTasks();
    showNotification('âœ… Status atualizado!', 'success');
  } catch (err) {
    showNotification('âŒ ' + err.message, 'error');
  }
}

// Delete task with confirmation
async function deleteTaskConfirm(taskId) {
  if (!confirm('Deseja arquivar esta tarefa? Ela serÃ¡ movida para o arquivo.')) return;
  
  try {
    await deleteTask(taskId);
    await loadAndDisplayTasks();
    showNotification('âœ… Tarefa arquivada!', 'success');
  } catch (err) {
    showNotification('âŒ ' + err.message, 'error');
  }
}

// Export tasks to markdown
async function exportTasksToMarkdown() {
  const tasks = await getAllTasks();
  
  let markdown = '# Roadmap - Fitness Tracker Pro\n\n';
  markdown += `**Data:** ${new Date().toLocaleString('pt-BR')}\n\n`;
  markdown += '---\n\n';
  
  const categories = {
    [TASK_CATEGORIES.SHORT_TERM]: 'Curto Prazo (1-2 semanas)',
    [TASK_CATEGORIES.MEDIUM_TERM]: 'MÃ©dio Prazo (1-3 meses)',
    [TASK_CATEGORIES.LONG_TERM]: 'Longo Prazo (3-6 meses)'
  };
  
  for (const [category, categoryName] of Object.entries(categories)) {
    const categoryTasks = tasks.filter(t => t.category === category);
    if (categoryTasks.length === 0) continue;
    
    markdown += `## ${categoryName}\n\n`;
    
    categoryTasks.forEach(task => {
      markdown += `### ${task.title}\n`;
      markdown += `- **Status:** ${task.status}\n`;
      markdown += `- **Prioridade:** ${task.priority}\n`;
      markdown += `- **DescriÃ§Ã£o:** ${task.description}\n`;
      
      if (task.checklist.length > 0) {
        markdown += `- **Checklist:**\n`;
        task.checklist.forEach(item => {
          markdown += `  - [${item.done ? 'x' : ' '}] ${item.text}\n`;
        });
      }
      
      markdown += '\n---\n\n';
    });
  }
  
  // Download as file
  const blob = new Blob([markdown], { type: 'text/markdown' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `roadmap_${new Date().toISOString().split('T')[0]}.md`;
  a.click();
  URL.revokeObjectURL(url);
  
  showNotification('âœ… Roadmap exportado!', 'success');
}

// Export tasks to JSON
async function exportTasksToJSON() {
  const tasks = await getAllTasks();
  const json = JSON.stringify(tasks, null, 2);
  
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `tasks_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  showNotification('âœ… Tarefas exportadas!', 'success');
}

// Load and display suggestions (admin view)
async function loadAndDisplayAdminSuggestions() {
  const suggestions = await getAllSuggestions();
  
  // Update stats
  const stats = {
    total: suggestions.length,
    pending: suggestions.filter(s => s.status === 'pending').length,
    approved: suggestions.filter(s => s.status === 'approved').length,
    implemented: suggestions.filter(s => s.status === 'implemented').length
  };
  
  document.getElementById('totalSuggestions').textContent = stats.total;
  document.getElementById('pendingSuggestions').textContent = stats.pending;
  document.getElementById('approvedSuggestions').textContent = stats.approved;
  document.getElementById('implementedSuggestions').textContent = stats.implemented;
  
  // Sort by votes
  suggestions.sort((a, b) => b.votes - a.votes);
  
  let html = '';
  
  suggestions.forEach(suggestion => {
    const statusColor = suggestion.status === 'approved' ? 'green' :
                        suggestion.status === 'implemented' ? 'blue' :
                        suggestion.status === 'rejected' ? 'red' : 'yellow';
    
    html += `
      <div class="bg-slate-700 p-4 rounded-lg border-l-4 border-${statusColor}-500">
        <div class="flex justify-between items-start mb-2">
          <div class="flex-1">
            <h5 class="font-bold text-lg mb-1">${suggestion.title}</h5>
            <p class="text-slate-300 text-sm mb-2">${suggestion.description}</p>
            <div class="flex gap-2 flex-wrap">
              <span class="px-2 py-1 rounded text-xs bg-slate-600 text-slate-300">${suggestion.category}</span>
              <span class="px-2 py-1 rounded text-xs bg-${statusColor}-900 text-${statusColor}-300 border border-${statusColor}-500">
                ${suggestion.status}
              </span>
              <span class="px-2 py-1 rounded text-xs bg-blue-900 text-blue-300 border border-blue-500">
                ðŸ‘ ${suggestion.votes} votos
              </span>
              <span class="px-2 py-1 rounded text-xs bg-purple-900 text-purple-300">
                Por: ${suggestion.submittedBy}
              </span>
              <span class="px-2 py-1 rounded text-xs bg-slate-600 text-slate-300">
                ${new Date(suggestion.submittedAt).toLocaleDateString('pt-BR')}
              </span>
            </div>
            ${suggestion.adminNote ? `
              <div class="mt-2 p-2 bg-slate-800 rounded text-sm">
                <strong>Nota do Admin:</strong> ${suggestion.adminNote}
              </div>
            ` : ''}
          </div>
        </div>
        
        <div class="mt-3 flex gap-2">
          <button onclick="updateSuggestionStatusWithNote('${suggestion.id}', 'approved')" class="text-sm px-3 py-1 bg-green-600 hover:bg-green-500 rounded">
            âœ… Aprovar
          </button>
          <button onclick="updateSuggestionStatusWithNote('${suggestion.id}', 'implemented')" class="text-sm px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded">
            ðŸŽ‰ Implementada
          </button>
          <button onclick="updateSuggestionStatusWithNote('${suggestion.id}', 'rejected')" class="text-sm px-3 py-1 bg-red-600 hover:bg-red-500 rounded">
            âŒ Rejeitar
          </button>
        </div>
      </div>
    `;
  });
  
  document.getElementById('suggestionsList').innerHTML = html || '<p class="text-slate-400">Nenhuma sugestÃ£o encontrada.</p>';
}

// Update suggestion status with note
async function updateSuggestionStatusWithNote(suggestionId, status) {
  const note = prompt(`Adicione uma nota (opcional) para esta ${status === 'rejected' ? 'rejeiÃ§Ã£o' : 'aprovaÃ§Ã£o'}:`);
  
  try {
    await updateSuggestionStatus(suggestionId, status, note || '');
    await loadAndDisplayAdminSuggestions();
    showNotification('âœ… Status atualizado!', 'success');
  } catch (err) {
    showNotification('âŒ ' + err.message, 'error');
  }
}

// Export suggestions to GitHub format
async function exportSuggestionsToGitHubFormat() {
  try {
    const markdown = await exportSuggestionsToGitHub();
    
    // Download as file
    const blob = new Blob([markdown], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sugestoes_github_${new Date().toISOString().split('T')[0]}.md`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('âœ… SugestÃµes exportadas para GitHub!', 'success');
  } catch (err) {
    showNotification('âŒ ' + err.message, 'error');
  }
}

// Load and display security events
async function loadAndDisplaySecurityEvents() {
  const settings = await dbGetAll(STORE_SETTINGS);
  const securityEvents = settings.filter(s => s.key.startsWith('security_log_')).map(s => s.value);
  
  // Sort by timestamp
  securityEvents.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  
  // Update stats
  const stats = {
    total: securityEvents.length,
    loginSuccess: securityEvents.filter(e => e.type === 'login_success').length,
    loginFailed: securityEvents.filter(e => e.type === 'login_failed').length,
    blocked: securityEvents.filter(e => e.type === 'account_locked').length
  };
  
  document.getElementById('totalSecurityEvents').textContent = stats.total;
  document.getElementById('successfulLogins').textContent = stats.loginSuccess;
  document.getElementById('failedLogins').textContent = stats.loginFailed;
  document.getElementById('blockedAccounts').textContent = stats.blocked;
  
  // Display recent events (last 50)
  let html = '<div class="space-y-2 max-h-96 overflow-y-auto">';
  
  securityEvents.slice(0, 50).forEach(event => {
    const typeColor = event.type.includes('success') ? 'green' :
                      event.type.includes('failed') || event.type.includes('blocked') ? 'red' :
                      event.type.includes('locked') ? 'orange' : 'blue';
    
    html += `
      <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
        <div class="flex-1">
          <span class="px-2 py-1 rounded text-xs bg-${typeColor}-900 text-${typeColor}-300 border border-${typeColor}-500 mr-2">
            ${event.type.replace(/_/g, ' ').toUpperCase()}
          </span>
          <span class="text-sm text-slate-300">${event.username}</span>
          <p class="text-xs text-slate-400 mt-1">${event.details}</p>
        </div>
        <div class="text-right text-xs text-slate-400">
          ${new Date(event.timestamp).toLocaleString('pt-BR')}
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  document.getElementById('securityEventsList').innerHTML = html || '<p class="text-slate-400">Nenhum evento encontrado.</p>';
  
  // Load accounts
  const accounts = await dbGetAll(STORE_ACCOUNTS);
  
  let accountsHtml = '<div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="border-b border-slate-600">';
  accountsHtml += '<th class="py-2 px-4 text-left">Username</th>';
  accountsHtml += '<th class="py-2 px-4 text-left">Email</th>';
  accountsHtml += '<th class="py-2 px-4 text-left">Role</th>';
  accountsHtml += '<th class="py-2 px-4 text-left">Criado Em</th>';
  accountsHtml += '<th class="py-2 px-4 text-left">Ãšltimo Login</th>';
  accountsHtml += '<th class="py-2 px-4 text-left">AÃ§Ãµes</th>';
  accountsHtml += '</tr></thead><tbody>';
  
  accounts.forEach(account => {
    accountsHtml += '<tr class="border-b border-slate-700">';
    accountsHtml += `<td class="py-2 px-4">${account.username}</td>`;
    accountsHtml += `<td class="py-2 px-4">${account.email}</td>`;
    accountsHtml += `<td class="py-2 px-4">`;
    accountsHtml += `<span class="px-2 py-1 rounded text-xs ${account.role === 'admin' ? 'bg-red-900 text-red-300' : 'bg-blue-900 text-blue-300'}">${account.role || 'user'}</span>`;
    accountsHtml += `</td>`;
    accountsHtml += `<td class="py-2 px-4 text-xs">${new Date(account.createdAt).toLocaleDateString('pt-BR')}</td>`;
    accountsHtml += `<td class="py-2 px-4 text-xs">${account.lastLogin ? new Date(account.lastLogin).toLocaleDateString('pt-BR') : 'Nunca'}</td>`;
    accountsHtml += `<td class="py-2 px-4">`;
    if (account.role !== 'admin') {
      accountsHtml += `<button onclick="promoteUserToAdmin('${account.username}')" class="text-xs px-2 py-1 bg-orange-600 hover:bg-orange-500 rounded mr-2">ðŸ‘‘ Promover</button>`;
    }
    accountsHtml += `</td>`;
    accountsHtml += '</tr>';
  });
  
  accountsHtml += '</tbody></table></div>';
  
  document.getElementById('accountsList').innerHTML = accountsHtml;
}

// Promote user to admin
async function promoteUserToAdmin(username) {
  if (!confirm(`Deseja promover ${username} a administrador?`)) return;
  
  try {
    await promoteToAdmin(username);
    await loadAndDisplaySecurityEvents();
    showNotification('âœ… UsuÃ¡rio promovido a admin!', 'success');
  } catch (err) {
    showNotification('âŒ ' + err.message, 'error');
  }
}

// Export security logs
async function exportSecurityLogs() {
  const settings = await dbGetAll(STORE_SETTINGS);
  const securityEvents = settings.filter(s => s.key.startsWith('security_log_')).map(s => s.value);
  
  const json = JSON.stringify(securityEvents, null, 2);
  
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `security_logs_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  showNotification('âœ… Logs exportados!', 'success');
}

// Clear old security logs
async function clearOldSecurityLogs() {
  if (!confirm('Deseja limpar logs de seguranÃ§a com mais de 30 dias?')) return;
  
  const settings = await dbGetAll(STORE_SETTINGS);
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  
  let removed = 0;
  
  for (const setting of settings) {
    if (setting.key.startsWith('security_log_')) {
      const event = setting.value;
      if (new Date(event.timestamp) < thirtyDaysAgo) {
        await dbDelete(STORE_SETTINGS, setting.key);
        removed++;
      }
    }
  }
  
  showNotification(`âœ… ${removed} logs removidos!`, 'success');
  await loadAndDisplaySecurityEvents();
}

// Load and display user suggestions
async function loadAndDisplayUserSuggestions() {
  const suggestions = await getAllSuggestions();
  
  // Sort by votes
  suggestions.sort((a, b) => b.votes - a.votes);
  
  let html = '<div class="space-y-4">';
  
  suggestions.forEach(suggestion => {
    const hasVoted = suggestion.votedBy.includes(authState.currentAccount.username);
    const statusColor = suggestion.status === 'approved' ? 'green' :
                        suggestion.status === 'implemented' ? 'blue' :
                        suggestion.status === 'rejected' ? 'red' : 'yellow';
    
    html += `
      <div class="bg-slate-700 p-4 rounded-lg ${suggestion.status === 'implemented' ? 'border-2 border-blue-500' : ''}">
        <div class="flex justify-between items-start mb-2">
          <div class="flex-1">
            <h5 class="font-bold text-lg mb-1">
              ${suggestion.title}
              ${suggestion.status === 'implemented' ? '<span class="ml-2 text-blue-400">âœ… Implementada!</span>' : ''}
            </h5>
            <p class="text-slate-300 text-sm mb-2">${suggestion.description}</p>
            <div class="flex gap-2 flex-wrap">
              <span class="px-2 py-1 rounded text-xs bg-slate-600 text-slate-300">${suggestion.category}</span>
              <span class="px-2 py-1 rounded text-xs bg-${statusColor}-900 text-${statusColor}-300 border border-${statusColor}-500">
                ${suggestion.status}
              </span>
              <span class="px-2 py-1 rounded text-xs bg-slate-600 text-slate-300">
                Por: ${suggestion.submittedBy}
              </span>
              <span class="px-2 py-1 rounded text-xs bg-slate-600 text-slate-300">
                ${new Date(suggestion.submittedAt).toLocaleDateString('pt-BR')}
              </span>
            </div>
            ${suggestion.adminNote && suggestion.status !== 'pending' ? `
              <div class="mt-2 p-2 bg-slate-800 rounded text-sm">
                <strong>Resposta do Admin:</strong> ${suggestion.adminNote}
              </div>
            ` : ''}
          </div>
        </div>
        
        <div class="mt-3 flex items-center gap-3">
          <button onclick="handleVoteSuggestion('${suggestion.id}')" 
                  class="px-4 py-2 rounded font-semibold ${hasVoted ? 'bg-green-600 hover:bg-green-500' : 'bg-slate-600 hover:bg-slate-500'}">
            ${hasVoted ? 'ðŸ‘ Votado' : 'ðŸ‘ Votar'} (${suggestion.votes})
          </button>
          ${suggestion.submittedBy === authState.currentAccount.username ? `
            <button onclick="deleteSuggestion('${suggestion.id}')" class="px-4 py-2 rounded bg-red-600 hover:bg-red-500">
              ðŸ—‘ï¸ Excluir
            </button>
          ` : ''}
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  document.getElementById('userSuggestionsList').innerHTML = html || '<p class="text-slate-400">Nenhuma sugestÃ£o encontrada.</p>';
}

// Handle vote suggestion
async function handleVoteSuggestion(suggestionId) {
  try {
    await voteSuggestion(suggestionId);
    await loadAndDisplayUserSuggestions();
    showNotification('âœ… Voto registrado!', 'success');
  } catch (err) {
    showNotification('âŒ ' + err.message, 'error');
  }
}

// Handle suggestion form submit
async function handleSuggestionFormSubmit(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const suggestionData = {
    title: formData.get('title'),
    description: formData.get('description'),
    category: formData.get('category'),
    priority: formData.get('priority')
  };
  
  try {
    await submitSuggestion(suggestionData);
    event.target.reset();
    await loadAndDisplayUserSuggestions();
    showNotification('âœ… SugestÃ£o enviada com sucesso!', 'success');
  } catch (err) {
    showNotification('âŒ ' + err.message, 'error');
  }
}

// Simple notification system
function showNotification(message, type = 'info') {
  const colors = {
    success: 'bg-green-600',
    error: 'bg-red-600',
    info: 'bg-blue-600'
  };
  
  const notification = document.createElement('div');
  notification.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.classList.add('animate-fade-out');
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

/* ----------------------------- Init and safety ----------------------------- */
window.addEventListener('beforeunload', () => { try { saveAllToDB(); } catch (e) { } });

(async function initApp() {
  // Load security state
  loadLoginAttempts();
  
  // Load user data regardless of authentication state
  await loadAllFromDB();
  await loadCustomMeals();
  
  // Ensure default users exist (do not overwrite)
  if (!state.users.pedro) state.users.pedro = initialUsers.pedro;
  if (!state.users.valentina) state.users.valentina = initialUsers.valentina;
  
  // Import marmitas list to a settings key for future UI if desired
  const s = await dbGet(STORE_SETTINGS, 'marmitas_seed_loaded').catch(()=>null);
  if (!s) {
    // store marmitas in settings for reference (not required, but keeps record)
    await dbPut(STORE_SETTINGS, { key: 'marmitas_seed_loaded', value: new Date().toISOString() });
  }
  
  // Initialize tasks (short-term roadmap)
  await initializeTasks();
  
  await saveAllToDB();
  
  // Try to restore session
  const sessionValid = await validateSession();
  
  if (sessionValid) {
    await loadProgressPhotos();
  }
  
  render();
})();
</script>

</body>
</html>

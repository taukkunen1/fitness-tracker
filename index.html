<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-screen">
    <div id="app"></div>

    <script>
        // ======================
        // BANCO DE DADOS (IndexedDB) - persist√™ncia local
        // ======================
        const DB_NAME = 'fitness-tracker-db';
        const DB_VERSION = 1;
        const STORE_USERS = 'users';
        const STORE_COMPARISONS = 'comparisons';

        function openDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_USERS)) {
                        db.createObjectStore(STORE_USERS, { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains(STORE_COMPARISONS)) {
                        db.createObjectStore(STORE_COMPARISONS, { keyPath: 'id' });
                    }
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        async function dbPut(storeName, value) {
            try {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const request = store.put(value);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (err) {
                console.error('DB put failed', err);
            }
        }

        async function dbGetAll(storeName) {
            try {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const req = store.getAll();
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            } catch (err) {
                console.error('DB getAll failed', err);
                return [];
            }
        }

        async function dbDelete(storeName, key) {
            try {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const req = store.delete(key);
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            } catch (err) {
                console.error('DB delete failed', err);
            }
        }

        // localStorage fallback helpers
        function saveDataLS(key, data) {
            try { localStorage.setItem(key, JSON.stringify(data)); } catch (err) { console.warn('localStorage save failed', err); }
        }
        function loadDataLS(key) {
            try { const data = localStorage.getItem(key); return data ? JSON.parse(data) : null; } catch (err) { return null; }
        }

        // ======================
        // ESTADO DA APLICA√á√ÉO (in-memory)
        // ======================
        let state = {
            activeTab: 'dashboard',
            activeUser: 'pedro',
            users: {},
            comparisons: []
        };

        // ======================
        // DADOS INICIAIS (seed) - adicionando ids √∫nicos a m√©tricas iniciais
        // ======================
        const initialUsers = (function(){
            const now = Date.now();
            return {
                pedro: {
                    id: 'pedro',
                    name: 'Pedro',
                    gender: 'male',
                    age: 30,
                    height: 175,
                    workoutHistory: [],
                    mealHistory: [],
                    bodyMetrics: [{
                        id: 'm_pedro_' + now,
                        date: new Date().toISOString().split('T')[0],
                        weight: 70.65,
                        bodyFat: 19.9,
                        muscleMass: 28.9,
                        visceralFat: 8,
                        bmi: 23.1
                    }],
                    goals: { weight: 75, bodyFat: 15, muscleMass: 32 }
                },
                valentina: {
                    id: 'valentina',
                    name: 'Valentina',
                    gender: 'female',
                    age: 28,
                    height: 165,
                    workoutHistory: [],
                    mealHistory: [],
                    bodyMetrics: [{
                        id: 'm_valentina_' + (now + 1),
                        date: new Date().toISOString().split('T')[0],
                        weight: 58.0,
                        bodyFat: 25.0,
                        muscleMass: 21.0,
                        visceralFat: 5,
                        bmi: 21.3
                    }],
                    goals: { weight: 60, bodyFat: 22, muscleMass: 23 }
                }
            };
        })();

        // ======================
        // MARMITAS LIV UP (dados com kcal e prote√≠na quando dispon√≠veis)
        // ======================
        const livUpMarmitas = [
            { name: 'Frango cremoso, arroz, feij√£o e br√≥colis no vapor', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '' },
            { name: 'Alm√¥ndega de frango, arroz 7 gr√£os', category: 'Baixa caloria at√© 350kcal', size: '300g', kcal: '340', prot: '28', fat: '9' },
            { name: 'Feijoada light', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '' },
            { name: 'Carne louca com pur√™ de mandioquinha', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '' },
            { name: 'Frango grelhado com legumes', category: 'Baixa caloria', size: '300g', kcal: '320', prot: '30', fat: '7' },
            { name: 'Salm√£o com quinoa e vegetais', category: 'Premium', size: '300g', kcal: '480', prot: '34', fat: '20' },
            { name: 'Bife de soja com arroz integral', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '' },
            { name: 'Picadinho de carne com batata doce', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '' },
            { name: 'Omelete de legumes com salada', category: 'Baixa caloria', size: '300g', kcal: '', prot: '', fat: '' },
            { name: 'Peito de peru com couscous marroquino', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '' },
            { name: 'Frango com lim√£o siciliano, arroz jasmim e br√≥colis', category: 'Dia a dia', size: '380g', kcal: '444', prot: '36', fat: '12' },
            { name: 'Saint peter com cebolinha, arroz jasmim e cenoura', category: 'Dia a dia', size: '380g', kcal: '426', prot: '25', fat: '14' },
            { name: 'Falafel, couscous e legumes mediterr√¢neos', category: 'Vegetariano', size: '', kcal: '', prot: '', fat: '' },
            { name: 'Lentilha pomodoro, arroz de jasmim e br√≥colis', category: 'Vegetariano', size: '', kcal: '', prot: '', fat: '' },
            { name: 'Estrogonofe de cogumelo, arroz integral', category: 'Vegetariano', size: '', kcal: '', prot: '', fat: '' },
            { name: 'Iscas de fil√© mignon acebolado', category: 'Premium', size: '', kcal: '', prot: '', fat: '' },
            { name: 'Posta de salm√£o assado', category: 'Premium', size: '', kcal: '', prot: '', fat: '' },
            { name: 'Bolinha low carb de ab√≥bora e carne com chia', category: 'Low Carb', size: '', kcal: '', prot: '', fat: '' },
            { name: 'Frango oriental, arroz com am√™ndoas e legumes', category: 'Performance', size: '580g', kcal: '', prot: '', fat: '' },
            { name: 'Carne mo√≠da, arroz e vegetais', category: 'Performance', size: '580g', kcal: '', prot: '', fat: '' }
        ];

        function parseNumber(value) {
            if (!value && value !== 0) return 0;
            const n = parseFloat(String(value).replace(/[^\d.-]/g, ''));
            return isNaN(n) ? 0 : n;
        }

        function getMealNutritionByName(name) {
            const meal = livUpMarmitas.find(m => m.name === name);
            if (!meal) return { kcal: 0, prot: 0, fat: 0 };
            return { kcal: parseNumber(meal.kcal), prot: parseNumber(meal.prot), fat: parseNumber(meal.fat) };
        }

        // ======================
        // SINCRONIZA√á√ÉO ESTADO <-> DB
        // ======================
        async function saveAllToDB() {
            try {
                for (const id of Object.keys(state.users)) {
                    await dbPut(STORE_USERS, state.users[id]);
                }
                for (const comp of state.comparisons) {
                    await dbPut(STORE_COMPARISONS, comp);
                }
                saveDataLS('ft_users', state.users);
                saveDataLS('ft_comparisons', state.comparisons);
            } catch (err) {
                console.error('saveAllToDB error', err);
            }
        }

        async function loadAllFromDB() {
            let users = {};
            let comparisons = [];
            try {
                const dbUsers = await dbGetAll(STORE_USERS);
                const dbComparisons = await dbGetAll(STORE_COMPARISONS);
                if (dbUsers && dbUsers.length) dbUsers.forEach(u => users[u.id] = u);
                if (dbComparisons && dbComparisons.length) comparisons = dbComparisons;
            } catch (err) {
                console.warn('DB load failed, fallback to localStorage', err);
            }

            if (Object.keys(users).length === 0) {
                const lsUsers = loadDataLS('ft_users');
                if (lsUsers) users = lsUsers;
            }
            if (!comparisons.length) {
                const lsComparisons = loadDataLS('ft_comparisons');
                if (lsComparisons) comparisons = lsComparisons;
            }

            if (Object.keys(users).length === 0) {
                users = initialUsers;
                comparisons = [];
                state.users = users;
                state.comparisons = comparisons;
                await saveAllToDB();
            }

            state.users = users;
            state.comparisons = comparisons;
        }

        // ======================
        // PROGRAMAS DE TREINO
        // ======================
        const workoutPrograms = {
            male: {
                'Treino A - Push (Empurrar)': { exercises: [ { name: 'Supino Reto', sets: '4', reps: '6-8', rest: '120s', notes: 'For√ßa base' }, { name: 'Supino Inclinado', sets: '3', reps: '8-12', rest: '90s', notes: 'Peito superior' }, { name: 'Desenvolvimento', sets: '4', reps: '8-12', rest: '90s', notes: 'Ombros' }, { name: 'Eleva√ß√£o Lateral', sets: '3', reps: '12-15', rest: '60s', notes: 'Deltoide lateral' }, { name: 'Tr√≠ceps Testa', sets: '3', reps: '10-12', rest: '60s', notes: 'Massa' }, { name: 'Tr√≠ceps Corda', sets: '3', reps: '12-15', rest: '60s', notes: 'Defini√ß√£o' } ], duration: '50-60 min', volume: '20 s√©ries' },
                'Treino B - Pull (Puxar)': { exercises: [{ name: 'Barra Fixa', sets: '4', reps: '6-10', rest: '120s', notes: 'For√ßa' }, { name: 'Remada Curvada', sets: '4', reps: '8-12', rest: '90s', notes: 'Espessura' }, { name: 'Remada Sentado', sets: '3', reps: '10-12', rest: '75s', notes: 'Detalhes' }, { name: 'Pullover', sets: '3', reps: '12-15', rest: '60s', notes: 'Amplitude' }, { name: 'Rosca Direta', sets: '3', reps: '8-12', rest: '60s', notes: 'B√≠ceps' }, { name: 'Rosca Martelo', sets: '3', reps: '10-12', rest: '60s', notes: 'Braquial' } ], duration: '50-60 min', volume: '20 s√©ries' },
                'Treino C - Legs (Pernas)': { exercises: [{ name: 'Agachamento', sets: '4', reps: '6-10', rest: '150s', notes: 'Rei dos exerc√≠cios' }, { name: 'Leg Press', sets: '3', reps: '10-15', rest: '90s', notes: 'Volume' }, { name: 'Stiff', sets: '4', reps: '8-12', rest: '90s', notes: 'Posterior' }, { name: 'Extensora', sets: '3', reps: '12-15', rest: '60s', notes: 'Isolamento quad' }, { name: 'Flexora', sets: '3', reps: '12-15', rest: '60s', notes: 'Posterior isolado' }, { name: 'Panturrilha', sets: '4', reps: '15-20', rest: '45s', notes: 'Resist√™ncia' } ], duration: '60-70 min', volume: '21 s√©ries' }
            },
            female: {
                'Treino A - Inferior Completo': { exercises: [{ name: 'Agachamento', sets: '4', reps: '10-15', rest: '90s', notes: 'Base principal' }, { name: 'Stiff', sets: '4', reps: '12-15', rest: '75s', notes: 'Posterior' }, { name: 'Afundo B√∫lgaro', sets: '3', reps: '12-15/lado', rest: '60s', notes: 'Unilateral' }, { name: 'Abdutora', sets: '4', reps: '15-20', rest: '60s', notes: 'Gl√∫teo m√©dio' }, { name: 'Flexora', sets: '3', reps: '12-15', rest: '60s', notes: 'Posterior' }, { name: 'Panturrilha', sets: '4', reps: '15-20', rest: '45s', notes: 'Resist√™ncia' } ], duration: '55-65 min', volume: '22 s√©ries' },
                'Treino B - Superior Completo': { exercises: [{ name: 'Supino Reto', sets: '3', reps: '10-12', rest: '90s', notes: 'Peito' }, { name: 'Remada Curvada', sets: '3', reps: '10-12', rest: '90s', notes: 'Costas' }, { name: 'Desenvolvimento', sets: '3', reps: '10-12', rest: '75s', notes: 'Ombros' }, { name: 'Puxada Frente', sets: '3', reps: '10-12', rest: '75s', notes: 'Dorsais' }, { name: 'Rosca B√≠ceps', sets: '3', reps: '12-15', rest: '60s', notes: 'B√≠ceps' }, { name: 'Tr√≠ceps Corda', sets: '3', reps: '12-15', rest: '60s', notes: 'Tr√≠ceps' } ], duration: '50-60 min', volume: '18 s√©ries' },
                'Treino C - Gl√∫teos √änfase': { exercises: [{ name: 'Hip Thrust', sets: '4', reps: '12-15', rest: '90s', notes: 'Melhor p/ gl√∫teos' }, { name: 'Leg Press (p√©s altos)', sets: '4', reps: '12-15', rest: '90s', notes: 'Gl√∫teos + quad' }, { name: 'Extensora', sets: '3', reps: '15-20', rest: '60s', notes: 'Quadr√≠ceps' }, { name: 'Abdutora', sets: '4', reps: '15-20', rest: '60s', notes: 'Gl√∫teo m√©dio' }, { name: 'Gl√∫teo 4 Apoios', sets: '3', reps: '15-20/lado', rest: '45s', notes: 'Isolamento' }, { name: 'Eleva√ß√£o P√©lvica', sets: '3', reps: '15-20', rest: '45s', notes: 'Finaliza√ß√£o' } ], duration: '50-60 min', volume: '21 s√©ries' }
            }
        };

        // ======================
        // HELPERS DE STATE
        // ======================
        function updateState(newState) {
            state = { ...state, ...newState };
            saveAllToDB();
            render();
        }

        function addOrUpdateUser(user) {
            state.users[user.id] = user;
            updateState({ users: state.users });
        }

        function removeUser(userId) {
            delete state.users[userId];
            dbDelete(STORE_USERS, userId).catch(()=>{});
            updateState({ users: state.users });
        }

        function addComparison(comp) {
            state.comparisons.push(comp);
            updateState({ comparisons: state.comparisons });
        }

        // ======================
        // HANDLERS (agora com fun√ß√µes de deletar para tudo que pode ser registrado)
        // ======================
        function handleTabChange(tab) { state.activeTab = tab; render(); }

        function handleUserChange(userId) { state.activeUser = userId; render(); }

        function handleLogWorkout(workoutName) {
            const newLog = { id: Date.now(), date: new Date().toISOString().split('T')[0], time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), workout: workoutName, completed: true };
            const user = state.users[state.activeUser];
            user.workoutHistory.unshift(newLog);
            addOrUpdateUser(user);
            alert('‚úÖ Treino registrado com sucesso! üí™');
        }

        function handleDeleteWorkout(id) {
            if (!confirm('Deseja realmente deletar este registro de treino?')) return;
            const user = state.users[state.activeUser];
            user.workoutHistory = user.workoutHistory.filter(log => log.id !== id);
            addOrUpdateUser(user);
            alert('‚ùå Treino deletado!');
        }

        function handleLogMeal(mealName) {
            const newLog = { id: Date.now(), date: new Date().toISOString().split('T')[0], time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), meal: mealName };
            const user = state.users[state.activeUser];
            user.mealHistory.unshift(newLog);
            addOrUpdateUser(user);
            alert('‚úÖ Refei√ß√£o registrada com sucesso! üç≤');
        }

        function handleDeleteMeal(id) {
            if (!confirm('Deseja realmente deletar este registro de refei√ß√£o?')) return;
            const user = state.users[state.activeUser];
            user.mealHistory = user.mealHistory.filter(m => m.id !== id);
            addOrUpdateUser(user);
            alert('‚ùå Refei√ß√£o deletada!');
        }

        function handleAddMetrics(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const weight = parseFloat(formData.get('weight'));
            const height = state.users[state.activeUser].height / 100;
            const newMetric = {
                id: Date.now(),
                date: formData.get('date'),
                weight: weight,
                bodyFat: parseFloat(formData.get('bodyFat')),
                muscleMass: parseFloat(formData.get('muscleMass')),
                visceralFat: parseInt(formData.get('visceralFat')),
                bmi: parseFloat((weight / (height * height)).toFixed(1))
            };
            const user = state.users[state.activeUser];
            user.bodyMetrics.push(newMetric);
            user.bodyMetrics.sort((a, b) => new Date(a.date) - new Date(b.date));
            addOrUpdateUser(user);
            e.target.reset();
            alert('üìä M√©tricas adicionadas!');
        }

        function handleDeleteMetric(metricId) {
            if (!confirm('Deseja realmente deletar esta medida?')) return;
            const user = state.users[state.activeUser];
            user.bodyMetrics = user.bodyMetrics.filter(m => m.id !== metricId);
            addOrUpdateUser(user);
            alert('‚ùå Medida deletada!');
        }

        function handleUpdatePartner(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const partnerId = 'valentina';
            const user = state.users[partnerId];
            user.name = formData.get('name');
            user.age = parseInt(formData.get('age'));
            user.height = parseInt(formData.get('height'));
            addOrUpdateUser(user);
            alert('‚úÖ Dados da Valentina atualizados!');
        }

        function handleAddProfile() {
            const name = prompt('Nome do novo perfil: (ex: Jo√£o)');
            if (!name) return;
            const gender = prompt('G√™nero (male/female):', 'male') || 'male';
            const age = parseInt(prompt('Idade:', '25')) || 25;
            const height = parseInt(prompt('Altura em cm:', '170')) || 170;
            const idBase = name.trim().toLowerCase().replace(/\s+/g, '_');
            const id = `${idBase}_${Date.now()}`;
            const user = { id, name, gender: gender === 'female' ? 'female' : 'male', age, height, workoutHistory: [], mealHistory: [], bodyMetrics: [{ id: 'm_' + Date.now(), date: new Date().toISOString().split('T')[0], weight: 0, bodyFat: 0, muscleMass: 0, visceralFat: 0, bmi: 0 }], goals: { weight: 0, bodyFat: 0, muscleMass: 0 } };
            addOrUpdateUser(user);
            alert('‚úÖ Perfil criado: ' + name);
        }

        function handleDeleteProfile(userId) {
            if (!confirm('Deseja realmente deletar o perfil e TODOS os registros deste usu√°rio? Esta a√ß√£o n√£o pode ser desfeita.')) return;
            removeUser(userId);
            // se o usu√°rio ativo foi deletado, escolhe outro
            const ids = Object.keys(state.users);
            if (ids.length) {
                state.activeUser = ids[0];
            } else {
                // re-seed one user (Valentina) para n√£o quebrar a UI
                state.users = initialUsers;
                state.activeUser = 'pedro';
            }
            saveAllToDB();
            alert('‚ùå Perfil deletado!');
            render();
        }

        function handleNewComparison() {
            const ids = Object.keys(state.users);
            if (ids.length < 2) { alert('Crie pelo menos 2 perfis para comparar.'); return; }
            const userOptions = ids.map((id, idx) => `${idx + 1}: ${state.users[id].name} (${id})`).join('\n');
            const selA = parseInt(prompt('Escolha o n√∫mero do primeiro usu√°rio:\n' + userOptions));
            const selB = parseInt(prompt('Escolha o n√∫mero do segundo usu√°rio:\n' + userOptions));
            if (!selA || !selB || selA === selB) { alert('Sele√ß√£o inv√°lida.'); return; }
            const idA = ids[selA - 1];
            const idB = ids[selB - 1];
            const title = prompt('T√≠tulo da compara√ß√£o (ex: "Semana 1 vs 2")', `Compara√ß√£o ${Date.now()}`) || `Compara√ß√£o ${Date.now()}`;
            const comp = { id: 'comp_' + Date.now(), title, userA: idA, userB: idB, createdAt: new Date().toISOString() };
            addComparison(comp);
            alert('‚úÖ Compara√ß√£o criada!');
            state.activeTab = 'comparacao';
            render();
        }

        function handleDeleteComparison(compId) {
            if (!confirm('Deseja realmente deletar esta compara√ß√£o?')) return;
            state.comparisons = state.comparisons.filter(c => c.id !== compId);
            dbDelete(STORE_COMPARISONS, compId).catch(()=>{});
            updateState({ comparisons: state.comparisons });
            alert('‚ùå Compara√ß√£o deletada!');
        }

        // ======================
        // RENDER
        // ======================
        function render() {
            const app = document.getElementById('app');
            const currentUser = state.users[state.activeUser] || Object.values(state.users)[0];
            if (!currentUser) { app.innerHTML = '<div class="p-8 text-white">Carregando...</div>'; return; }
            const workoutHistory = currentUser.workoutHistory || [];
            const mealHistory = currentUser.mealHistory || [];
            const bodyMetrics = currentUser.bodyMetrics || [];
            const latestMetrics = bodyMetrics[bodyMetrics.length - 1] || { weight: 0, bodyFat: 0, muscleMass: 0, bmi: 0 };
            const workoutProgram = workoutPrograms[currentUser.gender];

            const today = new Date().toISOString().split('T')[0];
            const todaysMeals = mealHistory.filter(m => m.date === today);
            const totals = todaysMeals.reduce((acc, log) => {
                const nut = getMealNutritionByName(log.meal);
                acc.kcal += nut.kcal; acc.prot += nut.prot; acc.fat += nut.fat;
                return acc;
            }, { kcal: 0, prot: 0, fat: 0 });

            app.innerHTML = `
                <!-- Header -->
                <header class="bg-black/40 backdrop-blur-lg border-b border-purple-500/30 sticky top-0 z-50">
                    <div class="max-w-7xl mx-auto px-4 py-4">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                                    üí™ Fitness Tracker Pro
                                </h1>
                                <p class="text-purple-300 text-sm mt-1">Baseado em evid√™ncias cient√≠ficas 2025</p>
                            </div>
                            <div class="flex gap-2 items-center">
                                ${Object.keys(state.users).map(id => `
                                    <div class="flex items-center gap-2">
                                        <button onclick="handleUserChange('${id}')" class="px-4 py-2 rounded-lg font-semibold transition-all ${
                                            state.activeUser === id
                                                ? (state.users[id].gender === 'female' ? 'bg-pink-500 text-white shadow-lg shadow-pink-500/50' : 'bg-blue-500 text-white shadow-lg shadow-blue-500/50')
                                                : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                        }">
                                            ${state.users[id].gender === 'female' ? 'üë©' : 'üë®'} ${state.users[id].name}
                                        </button>
                                        <button title="Deletar perfil" onclick="handleDeleteProfile('${id}')" class="text-red-400 hover:text-red-300 px-2">‚ùå</button>
                                    </div>
                                `).join('')}
                                <button onclick="handleAddProfile()" class="px-4 py-2 rounded-lg font-semibold bg-green-600 hover:bg-green-500">
                                    ‚ûï Novo Perfil
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Navigation -->
                <div class="max-w-7xl mx-auto px-4 py-6">
                    <div class="flex flex-wrap gap-3">
                        ${[
                            { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
                            { id: 'treino', icon: 'üèãÔ∏è', label: 'Treinos' },
                            { id: 'nutricao', icon: 'üçé', label: 'Nutri√ß√£o' },
                            { id: 'alimentacao', icon: 'üç≤', label: 'Alimenta√ß√£o' },
                            { id: 'evolucao', icon: 'üìà', label: 'Evolu√ß√£o' },
                            { id: 'comparacao', icon: '‚öñÔ∏è', label: 'Compara√ß√£o' },
                            { id: 'ciencia', icon: 'üî¨', label: 'Ci√™ncia' }
                        ].map(tab => `
                            <button onclick="handleTabChange('${tab.id}')" class="px-6 py-3 rounded-xl font-semibold transition-all ${
                                state.activeTab === tab.id
                                    ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-xl shadow-purple-500/50 scale-105'
                                    : 'bg-slate-800/50 text-slate-300 hover:bg-slate-700/50 border border-slate-700'
                            }">
                                ${tab.icon} ${tab.label}
                            </button>
                        `).join('')}
                    </div>
                </div>

                <!-- Main Content -->
                <main class="max-w-7xl mx-auto px-4 pb-12">
                    ${state.activeTab === 'dashboard' ? renderDashboard(currentUser, workoutHistory, latestMetrics) : ''}
                    ${state.activeTab === 'treino' ? renderTreino(workoutProgram, currentUser) : ''}
                    ${state.activeTab === 'nutricao' ? renderNutricao(currentUser) : ''}
                    ${state.activeTab === 'alimentacao' ? renderAlimentacao(mealHistory, currentUser, totals) : ''}
                    ${state.activeTab === 'evolucao' ? renderEvolucao(bodyMetrics, currentUser) : ''}
                    ${state.activeTab === 'comparacao' ? renderComparacao() : ''}
                    ${state.activeTab === 'ciencia' ? renderCiencia() : ''}
                </main>

                <!-- Footer -->
                <footer class="bg-black/60 backdrop-blur-lg border-t border-purple-500/30 py-8 mt-12">
                    <div class="max-w-7xl mx-auto px-4 text-center">
                        <p class="text-slate-400">Desenvolvido com base em evid√™ncias cient√≠ficas recentes (2024-2025)</p>
                        <p class="text-slate-500 text-sm mt-2">Schoenfeld et al. (2025) ‚Ä¢ Frontera et al. (2025) ‚Ä¢ Damas et al. (2025)</p>
                    </div>
                </footer>
            `;

            const metricsForm = document.getElementById('metricsForm');
            if (metricsForm) metricsForm.addEventListener('submit', handleAddMetrics);
            const partnerForm = document.getElementById('partnerForm');
            if (partnerForm) partnerForm.addEventListener('submit', handleUpdatePartner);
        }

        function renderDashboard(currentUser, workoutHistory, latestMetrics) {
            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl p-6 text-white shadow-xl">
                            <p class="text-blue-200 text-sm mb-2">PESO ATUAL</p>
                            <p class="text-4xl font-bold">${latestMetrics.weight} kg</p>
                            <p class="text-blue-200 text-xs mt-2">Meta: ${currentUser.goals.weight}kg</p>
                        </div>
                        <div class="bg-gradient-to-br from-red-600 to-red-800 rounded-2xl p-6 text-white shadow-xl">
                            <p class="text-red-200 text-sm mb-2">GORDURA</p>
                            <p class="text-4xl font-bold">${latestMetrics.bodyFat}%</p>
                            <p class="text-red-200 text-xs mt-2">Meta: ${currentUser.goals.bodyFat}%</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-600 to-green-800 rounded-2xl p-6 text-white shadow-xl">
                            <p class="text-green-200 text-sm mb-2">MASSA MUSCULAR</p>
                            <p class="text-4xl font-bold">${latestMetrics.muscleMass} kg</p>
                            <p class="text-green-200 text-xs mt-2">Meta: ${currentUser.goals.muscleMass}kg</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-600 to-purple-800 rounded-2xl p-6 text-white shadow-xl">
                            <p class="text-purple-200 text-sm mb-2">TREINOS</p>
                            <p class="text-4xl font-bold">${workoutHistory.length}</p>
                            <p class="text-purple-200 text-xs mt-2">Total registrados</p>
                        </div>
                    </div>

                    <div class="bg-slate-800/50 backdrop-blur-lg border border-slate-700 rounded-2xl p-6">
                        <h3 class="text-2xl font-bold text-white mb-4">üî• √öltimos Treinos</h3>
                        ${workoutHistory.length === 0 ? `<p class="text-slate-400 text-center py-8">Nenhum treino registrado ainda. V√° para a aba Treinos!</p>` : `
                            <div class="space-y-3">
                                ${workoutHistory.slice(0, 5).map(log => `
                                    <div class="bg-slate-700/50 p-4 rounded-xl border-l-4 border-purple-500 flex justify-between items-center">
                                        <div>
                                            <p class="text-white font-semibold">${log.workout}</p>
                                            <p class="text-slate-400 text-sm">${log.date} - ${log.time}</p>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="bg-green-500/20 text-green-400 px-3 py-1 rounded-full text-sm">‚úÖ</span>
                                            <button onclick="handleDeleteWorkout(${log.id})" class="text-red-400 hover:text-red-300">‚ùå</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderTreino(workoutProgram, currentUser) {
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-6 text-white shadow-2xl">
                        <h2 class="text-3xl font-bold mb-2">üèãÔ∏è Programa ${currentUser.gender === 'male' ? 'ABC Masculino' : 'ABC Feminino'}</h2>
                        <p class="text-purple-200">${currentUser.gender === 'male' ? 'Foco em for√ßa e hipertrofia - 3x/semana - 15-20 s√©ries/grupo' : 'Maior volume inferior - 3x/semana - 20-25 s√©ries/grupo'}</p>
                    </div>

                    ${Object.entries(workoutProgram).map(([name, workout]) => `
                        <div class="bg-slate-800/50 backdrop-blur-lg border border-slate-700 rounded-2xl overflow-hidden">
                            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-5">
                                <div class="flex flex-col md:flex-row justify-between items-start gap-4">
                                    <div>
                                        <h3 class="text-xl font-bold text-white">${name}</h3>
                                        <div class="flex flex-wrap gap-4 mt-2 text-sm text-indigo-200"><span>‚è±Ô∏è ${workout.duration}</span><span>üìä ${workout.volume}</span></div>
                                    </div>
                                    <button onclick="handleLogWorkout('${name}')" class="bg-white text-indigo-600 px-5 py-2 rounded-xl font-bold hover:bg-indigo-50 transition shadow-lg">‚úÖ Registrar Treino</button>
                                </div>
                            </div>
                            <div class="p-5 overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b-2 border-slate-700">
                                            <th class="text-left py-3 px-3 text-slate-300 font-semibold">Exerc√≠cio</th>
                                            <th class="text-center py-3 px-3 text-slate-300 font-semibold">S√©ries</th>
                                            <th class="text-center py-3 px-3 text-slate-300 font-semibold">Reps</th>
                                            <th class="text-center py-3 px-3 text-slate-300 font-semibold">Descanso</th>
                                            <th class="text-left py-3 px-3 text-slate-300 font-semibold">Notas</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${workout.exercises.map(ex => `
                                            <tr class="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                <td class="py-3 px-3 text-white font-medium">${ex.name}</td>
                                                <td class="py-3 px-3 text-center text-purple-400 font-bold">${ex.sets}</td>
                                                <td class="py-3 px-3 text-center text-purple-400 font-bold">${ex.reps}</td>
                                                <td class="py-3 px-3 text-center text-slate-400">${ex.rest}</td>
                                                <td class="py-3 px-3 text-slate-400 text-sm">${ex.notes}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderNutricao(currentUser) {
            const nutrition = currentUser.gender === 'male' ? { target: 2000, protein: '140-160g', carbs: '220-250g', fats: '55-65g', surplus: 400 } : { target: 1700, protein: '95-105g', carbs: '180-200g', fats: '50-60g', surplus: 300 };
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-green-600 to-emerald-600 rounded-2xl p-6 text-white shadow-2xl">
                        <h2 class="text-3xl font-bold mb-4">üçé Plano Nutricional Personalizado</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white/20 rounded-xl p-4 backdrop-blur">
                                <p class="text-green-200 text-sm">Meta Cal√≥rica</p>
                                <p class="text-3xl font-bold">${nutrition.target}</p>
                                <p class="text-xs text-green-200">kcal/dia</p>
                            </div>
                            <div class="bg-white/20 rounded-xl p-4 backdrop-blur">
                                <p class="text-green-200 text-sm">Prote√≠na</p>
                                <p class="text-2xl font-bold">${nutrition.protein}</p>
                                <p class="text-xs text-green-200">${currentUser.gender === 'male' ? '2.0g/kg' : '1.7g/kg'}</p>
                            </div>
                            <div class="bg-white/20 rounded-xl p-4 backdrop-blur">
                                <p class="text-green-200 text-sm">Super√°vit</p>
                                <p class="text-3xl font-bold">+${nutrition.surplus}</p>
                                <p class="text-xs text-green-200">kcal/dia</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAlimentacao(mealHistory, currentUser, totals) {
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-orange-600 to-yellow-600 rounded-2xl p-6 text-white shadow-2xl">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-3xl font-bold mb-2">üç≤ Alimenta√ß√£o - Liv Up</h2>
                                <p class="text-orange-200">Registre suas marmitas consumidas do dia (menu atualizado 2025)</p>
                            </div>
                            <div class="text-right">
                                <p class="text-orange-100 text-sm">Totais hoje</p>
                                <p class="font-bold text-xl">${totals.kcal} kcal ‚Ä¢ ${totals.prot} g prote√≠na ‚Ä¢ ${totals.fat} g gord.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-800/50 backdrop-blur-lg border border-slate-700 rounded-2xl p-6">
                        <h3 class="text-2xl font-bold text-white mb-4">üìã Marmitas Dispon√≠veis</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${livUpMarmitas.map(meal => `
                                <div class="bg-slate-700/50 p-4 rounded-xl flex justify-between items-center">
                                    <div>
                                        <p class="text-white font-semibold">${meal.name}</p>
                                        <p class="text-slate-400 text-sm">${meal.category} - ${meal.size} ${meal.kcal ? `- ${meal.kcal} kcal, ${meal.prot}g prot` : ''}</p>
                                    </div>
                                    <button onclick="handleLogMeal('${meal.name.replace(/'/g, "\\'")}')" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-orange-400">
                                        ‚úÖ Registrar
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-slate-800/50 backdrop-blur-lg border border-slate-700 rounded-2xl p-6">
                        <h3 class="text-2xl font-bold text-white mb-4">üìÖ Hist√≥rico de Refei√ß√µes</h3>
                        ${mealHistory.length === 0 ? `<p class="text-slate-400 text-center py-8">Nenhuma refei√ß√£o registrada ainda.</p>` : `
                            <div class="space-y-3">
                                ${mealHistory.slice(0, 50).map(log => {
                                    const nut = getMealNutritionByName(log.meal);
                                    return `
                                        <div class="bg-slate-700/50 p-4 rounded-xl border-l-4 border-orange-500 flex justify-between items-center">
                                            <div>
                                                <p class="text-white font-semibold">${log.meal}</p>
                                                <p class="text-slate-400 text-sm">${log.date} - ${log.time} ‚Ä¢ ${nut.kcal} kcal ‚Ä¢ ${nut.prot} g prot</p>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <button onclick="handleDeleteMeal(${log.id})" class="text-red-400 hover:text-red-300">‚ùå</button>
                                                <span class="bg-green-500/20 text-green-400 px-3 py-1 rounded-full text-sm">‚úÖ</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderEvolucao(bodyMetrics, currentUser) {
            return `
                <div class="space-y-6">
                    <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 backdrop-blur">
                        <h2 class="text-2xl font-bold text-white mb-4">üìà Adicionar Novas Medidas</h2>
                        <form id="metricsForm" class="grid grid-cols-2 md:grid-cols-6 gap-4">
                            <input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}" class="px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white">
                            <input type="number" name="weight" step="0.1" placeholder="Peso (kg)" required class="px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400">
                            <input type="number" name="bodyFat" step="0.1" placeholder="Gordura %" required class="px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400">
                            <input type="number" name="muscleMass" step="0.1" placeholder="Massa (kg)" required class="px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400">
                            <input type="number" name="visceralFat" placeholder="G.Visceral" required class="px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400">
                            <button type="submit" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg transition">‚ûï Adicionar</button>
                        </form>
                    </div>

                    ${bodyMetrics.length > 0 ? `
                        <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 backdrop-blur">
                            <h3 class="text-xl font-bold text-white mb-4">üìä Hist√≥rico de Medidas</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-slate-700">
                                            <th class="text-left py-2 px-3 text-slate-300">Data</th>
                                            <th class="text-center py-2 px-3 text-slate-300">Peso</th>
                                            <th class="text-center py-2 px-3 text-slate-300">Gordura</th>
                                            <th class="text-center py-2 px-3 text-slate-300">Massa</th>
                                            <th class="text-center py-2 px-3 text-slate-300">IMC</th>
                                            <th class="text-center py-2 px-3 text-slate-300">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${bodyMetrics.slice().reverse().map(m => `
                                            <tr class="border-b border-slate-700/50">
                                                <td class="py-2 px-3 text-white">${m.date}</td>
                                                <td class="py-2 px-3 text-center text-blue-400">${m.weight}kg</td>
                                                <td class="py-2 px-3 text-center text-red-400">${m.bodyFat}%</td>
                                                <td class="py-2 px-3 text-center text-green-400">${m.muscleMass}kg</td>
                                                <td class="py-2 px-3 text-center text-purple-400">${m.bmi}</td>
                                                <td class="py-2 px-3 text-center">
                                                    <button onclick="handleDeleteMetric('${m.id}')" class="text-red-400 hover:text-red-300">‚ùå</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderComparacao() {
            const comps = state.comparisons || [];
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 rounded-2xl p-6 text-white shadow-2xl">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-3xl font-bold mb-2">‚öñÔ∏è Compara√ß√£o entre Usu√°rios</h2>
                                <p class="text-purple-200">An√°lise comparativa baseada em diferen√ßas fisiol√≥gicas</p>
                            </div>
                            <div>
                                <button onclick="handleNewComparison()" class="bg-green-600 px-4 py-2 rounded-lg font-bold">‚ûï Nova Compara√ß√£o</button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        ${comps.length === 0 ? '<p class="text-slate-400">Nenhuma compara√ß√£o criada.</p>' : comps.map(comp => {
                            const a = state.users[comp.userA] || { name: comp.userA, bodyMetrics: [] };
                            const b = state.users[comp.userB] || { name: comp.userB, bodyMetrics: [] };
                            const aLatest = (a.bodyMetrics && a.bodyMetrics.length) ? a.bodyMetrics[a.bodyMetrics.length - 1] : {};
                            const bLatest = (b.bodyMetrics && b.bodyMetrics.length) ? b.bodyMetrics[b.bodyMetrics.length - 1] : {};
                            return `
                                <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <h3 class="text-xl font-bold">${comp.title}</h3>
                                            <p class="text-slate-400 text-sm">Criado em ${new Date(comp.createdAt).toLocaleString()}</p>
                                        </div>
                                        <div class="flex gap-4 items-center">
                                            <div class="p-4 bg-blue-900/30 rounded-xl">
                                                <p class="font-bold text-blue-300">${a.name}</p>
                                                <p class="text-slate-300 text-sm">Peso: ${aLatest.weight || '-'}kg ‚Ä¢ Gord: ${aLatest.bodyFat || '-'}%</p>
                                            </div>
                                            <div class="p-4 bg-pink-900/30 rounded-xl">
                                                <p class="font-bold text-pink-300">${b.name}</p>
                                                <p class="text-slate-300 text-sm">Peso: ${bLatest.weight || '-'}kg ‚Ä¢ Gord: ${bLatest.bodyFat || '-'}%</p>
                                            </div>
                                            <button onclick="handleDeleteComparison('${comp.id}')" class="text-red-400 hover:text-red-300">‚ùå</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderCiencia() {
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-6 text-white shadow-2xl">
                        <h2 class="text-3xl font-bold mb-2">üî¨ Base Cient√≠fica do Programa</h2>
                        <p class="text-purple-200">Diferen√ßas fisiol√≥gicas e adapta√ß√µes ao treinamento (Atualizado com evid√™ncias de 2024-2025)</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-blue-900/30 border border-blue-700 rounded-2xl p-6 backdrop-blur">
                            <h3 class="text-2xl font-bold text-blue-300 mb-4">üë® Fisiologia Masculina</h3>
                            <div class="space-y-3 text-blue-200 text-sm">
                                <div><strong class="text-white">Testosterona:</strong> 300-1000 ng/dL</div>
                                <div><strong class="text-white">Fibras:</strong> 52-55% Tipo II (for√ßa)</div>
                                <div><strong class="text-white">Recupera√ß√£o:</strong> 48-72h</div>
                                <div><strong class="text-white">Prote√≠na:</strong> 2.0-2.2g/kg</div>
                            </div>
                        </div>
                        <div class="bg-pink-900/30 border border-pink-700 rounded-2xl p-6 backdrop-blur">
                            <h3 class="text-2xl font-bold text-pink-300 mb-4">üë© Fisiologia Feminina</h3>
                            <div class="space-y-3 text-pink-200 text-sm">
                                <div><strong class="text-white">Testosterona:</strong> 15-70 ng/dL</div>
                                <div><strong class="text-white">Fibras:</strong> 50-52% Tipo I (resist√™ncia)</div>
                                <div><strong class="text-white">Recupera√ß√£o:</strong> 24-48h</div>
                                <div><strong class="text-white">Prote√≠na:</strong> 1.6-1.8g/kg</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ======================
        // Inicializa√ß√£o
        // ======================
        (async function initApp() {
            await loadAllFromDB();
            if (!state.users.pedro) state.users.pedro = initialUsers.pedro;
            if (!state.users.valentina) state.users.valentina = initialUsers.valentina;
            await saveAllToDB();
            render();
        })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fitness Tracker Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-screen">
  <div id="app"></div>

<script>
/*
  Vers√£o: Atualiza√ß√£o final para upload no GitHub
  - Persist√™ncia robusta (IndexedDB stores: users, comparisons, references) + fallback localStorage
  - Seed de estudos (2020‚Üí2025-11) import√°vel (n√£o sobrescreve dados existentes)
  - Integra√ß√£o das refer√™ncias nos cards de treino e nutri√ß√£o (links/DOIs)
  - Templates de treino 3x/semana (Full-body, PPL, Upper/Lower) baseados em evid√™ncias
  - Aplicar template ao usu√°rio -> salva em state.users[uid].customPrograms (persistido)
  - Edi√ß√£o/remo√ß√£o m√≠nima e export da evolu√ß√£o muscular (CSV)
  - Gr√°fico de evolu√ß√£o muscular (massa e tamanho) com redraw autom√°tico
  - Migra√ß√£o simples: se existirem programas customizados em localStorage, ser√£o importados para IndexedDB/usu√°rio
*/

const DB_NAME = 'fitness-tracker-db';
const DB_VERSION = 2;
const STORE_USERS = 'users';
const STORE_COMPARISONS = 'comparisons';
const STORE_REFERENCES = 'references';

// ---------- IndexedDB helpers ----------
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_USERS)) db.createObjectStore(STORE_USERS, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_COMPARISONS)) db.createObjectStore(STORE_COMPARISONS, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_REFERENCES)) db.createObjectStore(STORE_REFERENCES, { keyPath: 'id' });
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function dbPut(store, value) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(store, 'readwrite');
      const st = tx.objectStore(store);
      const r = st.put(value);
      r.onsuccess = () => resolve(r.result);
      r.onerror = () => reject(r.error);
    });
  } catch (err) { console.error('dbPut', err); }
}

async function dbGetAll(store) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(store, 'readonly');
      const st = tx.objectStore(store);
      const r = st.getAll();
      r.onsuccess = () => resolve(r.result);
      r.onerror = () => reject(r.error);
    });
  } catch (err) { console.error('dbGetAll', err); return []; }
}

async function dbDelete(store, key) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(store, 'readwrite');
      const st = tx.objectStore(store);
      const r = st.delete(key);
      r.onsuccess = () => resolve();
      r.onerror = () => reject(r.error);
    });
  } catch (err) { console.error('dbDelete', err); }
}

// localStorage fallback
function saveLS(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e){console.warn(e);} }
function loadLS(k) { try { const d = localStorage.getItem(k); return d ? JSON.parse(d) : null; } catch(e){return null;} }

// ---------- In-memory state ----------
let state = {
  activeTab: 'dashboard',
  activeUser: 'pedro',
  users: {},
  comparisons: [],
  references: []
};

let muscleChart = null;

// ---------- Seed users ----------
const initialUsers = (function(){
  const now = Date.now();
  return {
    pedro: {
      id: 'pedro', name: 'Pedro', gender: 'male', age: 30, height: 175,
      workoutHistory: [], mealHistory: [],
      bodyMetrics: [{
        id: 'm_pedro_' + now,
        date: new Date().toISOString().split('T')[0],
        weight: 70.65, bodyFat: 19.9, muscleMass: 28.9, visceralFat: 8,
        waterPercent: 55.0, waterWeight: parseFloat((70.65*0.55).toFixed(2)),
        bmr: Math.round(10*70.65 + 6.25*175 - 5*30 + 5),
        muscleSize: 40, bmi: 23.1
      }],
      goals: { weight: 75, bodyFat: 15, muscleMass: 32 },
      customPrograms: {} // will hold user-specific saved templates
    },
    valentina: {
      id: 'valentina', name: 'Valentina', gender: 'female', age: 28, height: 165,
      workoutHistory: [], mealHistory: [],
      bodyMetrics: [{
        id: 'm_valentina_' + (now+1),
        date: new Date().toISOString().split('T')[0],
        weight: 58, bodyFat: 25, muscleMass: 21, visceralFat: 5,
        waterPercent: 50, waterWeight: parseFloat((58*0.5).toFixed(2)),
        bmr: Math.round(10*58 + 6.25*165 - 5*28 -161),
        muscleSize: 36, bmi: 21.3
      }],
      goals: { weight: 60, bodyFat: 22, muscleMass: 23 },
      customPrograms: {}
    }
  };
})();

// ---------- Templates (evidence-based) ----------
const templates = {
  'fullbody_3x': {
    id: 'fullbody_3x',
    name: 'Full-Body 3x/semana',
    description: 'Frequ√™ncia 3x/semana, foco em hipertrofia com volume moderado. (Base: Morton 2021, Schoenfeld 2023)',
    sessions: {
      A: {
        name: 'Full A ‚Äî Quadr√≠ceps / Peito',
        exercises: [
          { name: 'Agachamento (Back squat)', sets: 4, reps: '6-8' },
          { name: 'Supino Reto', sets: 4, reps: '6-8' },
          { name: 'Remada Curvada', sets: 3, reps: '8-10' },
          { name: 'Extensora', sets: 3, reps: '10-15' },
          { name: 'Panturrilha', sets: 3, reps: '12-20' }
        ],
        notes: 'Volume semanal por grupo: 10‚Äì14 s√©ries (ajustar conforme progresso).'
      },
      B: {
        name: 'Full B ‚Äî Posterior / Ombros',
        exercises: [
          { name: 'Stiff / Lev. Romeno', sets: 3, reps: '6-8' },
          { name: 'Desenvolvimento', sets: 3, reps: '8-10' },
          { name: 'Puxada Frente / Barra', sets: 3, reps: '6-10' },
          { name: 'Eleva√ß√£o Lateral', sets: 3, reps: '12-15' },
          { name: 'Abdominais', sets: 3, reps: '12-20' }
        ],
        notes: 'Incluir t√©cnicas de estresse metab√≥lico pontualmente (supersets/drops).'
      },
      C: {
        name: 'Full C ‚Äî Gl√∫teos / Complementares',
        exercises: [
          { name: 'Hip Thrust', sets: 4, reps: '8-12' },
          { name: 'Remada Sentada', sets: 3, reps: '8-12' },
          { name: 'Supino Inclinado', sets: 3, reps: '8-12' },
          { name: 'Rosca Direta', sets: 3, reps: '8-12' }
        ],
        notes: 'Priorizar progress√£o de carga semana a semana.'
      }
    },
    referencesTags: ['training','hypertrophy','volume']
  },
  'ppl_3x': {
    id: 'ppl_3x',
    name: 'PPL 3x/semana (Push/Pull/Legs)',
    description: 'Padr√£o cl√°ssico PPL adaptado para 3x/semana (cada sess√£o semanal).',
    sessions: {
      Push: { name: 'Push', exercises: [{name:'Supino Reto', sets:4, reps:'6-8'},{name:'Desenvolvimento', sets:3, reps:'8-12'},{name:'Tr√≠ceps Corda', sets:3, reps:'10-12'}], notes:'' },
      Pull: { name: 'Pull', exercises: [{name:'Barra Fixa / Puxada', sets:4, reps:'6-10'},{name:'Remada', sets:4, reps:'8-12'},{name:'Rosca', sets:3, reps:'8-12'}], notes:'' },
      Legs: { name: 'Legs', exercises: [{name:'Agachamento', sets:4, reps:'6-10'},{name:'Leg Press', sets:3, reps:'10-15'},{name:'Panturrilha', sets:4, reps:'12-20'}], notes:'' }
    },
    referencesTags: ['training','specificity','volume']
  },
  'upper_lower_full': {
    id: 'upper_lower_full',
    name: 'Upper/Lower/Full (H√≠brido)',
    description: 'Upper / Lower / Full ‚Äî equil√≠brio entre volume e recupera√ß√£o.',
    sessions: {
      Upper: { name: 'Upper', exercises: [{name:'Supino', sets:3, reps:'6-10'},{name:'Remada', sets:3, reps:'8-12'},{name:'Ombro', sets:3, reps:'8-12'}], notes:'' },
      Lower: { name: 'Lower', exercises: [{name:'Agachamento', sets:4, reps:'6-10'},{name:'Stiff', sets:3, reps:'8-12'},{name:'Panturrilha', sets:3, reps:'12-20'}], notes:'' },
      Full: { name: 'Full (leve)', exercises: [{name:'Hip Thrust', sets:3, reps:'8-12'},{name:'Puxada', sets:3, reps:'8-12'}], notes:'' }
    },
    referencesTags: ['training','hypertrophy']
  }
};

// ---------------- Studies seed (2020‚Üí2025-11) ----------------
const scientificStudiesSeed = [
  { id:'ref_phillips_2022', authors:'Phillips SM. et al.', year:2022, title:'Protein Requirements and Muscle Mass/Strength in Athletes', journal:'Sports Medicine', link:'https://doi.org/10.1007/s40279-022-01680-9', tags:['nutrition','protein'], summary:'Revis√£o: recomenda√ß√µes de prote√≠na 1.6‚Äì2.2 g/kg/d e distribui√ß√£o.' },
  { id:'ref_schoenfeld_2023', authors:'Schoenfeld BJ., Krieger JW.', year:2023, title:'Protein timing meta-analysis', journal:'JISSN', link:'https://doi.org/10.1186/s12970-023-00496-7', tags:['nutrition','protein','timing'], summary:'Timing √∫til, total di√°rio √© determinante.' },
  { id:'ref_morton_2021', authors:'Morton RW. et al.', year:2021, title:'Resistance Training Volume Enhances Hypertrophy', journal:'Med Sci Sports Exerc', link:'https://doi.org/10.1249/MSS.0000000000002585', tags:['training','volume','hypertrophy'], summary:'Volume correlaciona com hipertrofia.' },
  { id:'ref_nutrients_creatine_2024', authors:'Wang Z. et al.', year:2024, title:'Creatine + RT meta-analysis', journal:'Nutrients', link:'https://www.mdpi.com/2072-6643/16/21/3665', tags:['supplement','creatine'], summary:'Creatina consistente para for√ßa/hipertrofia.' },
  { id:'ref_bilsborough_2020', authors:'Bilsborough SA., Crowe TC.', year:2020, title:'Low-Carb and Body Composition', journal:'Nutrients', link:'https://www.mdpi.com/2072-6643/12/10/3105', tags:['nutrition','diet'], summary:'Discuss√£o sobre low-carb em atletas.' },
  { id:'ref_frontiers_2025', authors:'Curovic I.', year:2025, title:'Metabolic stress & adaptations', journal:'Frontiers in Physiology', link:'https://www.frontiersin.org/articles/10.3389/fphys.2025.1549609/full', tags:['training','metabolic-stress'], summary:'T√©cnicas de estresse metab√≥lico (BFR, supersets).' },
  { id:'ref_jhpn_2025', authors:'Chen W.', year:2025, title:'Nutritional interventions in hypertrophy (scientometric)', journal:'JHPN', link:'https://jhpn.biomedcentral.com/articles/10.1186/s41043-025-01031-w', tags:['nutrition','review'], summary:'Mapeamento das interven√ß√µes nutricionais em hipertrofia.' },
  { id:'ref_xie_2025', authors:'Xie Y. et al.', year:2025, title:'Exercise modalities during caloric restriction', journal:'Systematic Review', link:'https://pubmed.ncbi.nlm.nih.gov/39185113/', tags:['training','diet','restriction'], summary:'Combinar RT e aer√≥bico preserva massa magra.' },
  { id:'ref_maturitas_2025', authors:'Various', year:2025, title:'RT effects on glycemic control & body composition in older adults with T2D', journal:'Maturitas', link:'https://www.maturitas.org/article/S0378-5122(25)00499-2/fulltext', tags:['training','clinical'], summary:'RT melhora composi√ß√£o e marcadores metab√≥licos.' },
  { id:'ref_strongerbyscience_2024', authors:'StrongerByScience', year:2024, title:'Muscle Growth: Master List', journal:'Resource', link:'https://www.strongerbyscience.com/master-list/muscle-growth/', tags:['review','meta-analysis'], summary:'Compila√ß√£o de meta-an√°lises sobre hipertrofia.' },
  { id:'ref_almeida_2024', authors:'Almeida NC. et al.', year:2024, title:'Estrat√©gias de nutri√ß√£o e suplementa√ß√£o', journal:'Revista Fisioterapia em Movimento', link:'https://revistaft.com.br/analise-das-estrategias-de-nutricao-e-suplmentacao-na-recomposicao-corporal-em-praticantes-de-musculacao/', tags:['nutrition','supplement','pt'], summary:'Revis√£o em portugu√™s sobre suplementa√ß√£o.' }
];

// ---------------- Marmitas ----------------
const livUpMarmitas = [
  { name:'Frango cremoso, arroz, feij√£o e br√≥colis no vapor', category:'Dia a dia', size:'300g', kcal:'', prot:'', fat:'' },
  { name:'Alm√¥ndega de frango, arroz 7 gr√£os', category:'Baixa caloria at√© 350kcal', size:'300g', kcal:'340', prot:'28', fat:'9' },
  { name:'Frango com lim√£o siciliano, arroz jasmim e br√≥colis', category:'Dia a dia', size:'380g', kcal:'444', prot:'36', fat:'12' },
  { name:'Saint peter com cebolinha, arroz jasmim e cenoura', category:'Dia a dia', size:'380g', kcal:'426', prot:'25', fat:'14' },
  { name:'Salm√£o com quinoa e vegetais', category:'Premium', size:'300g', kcal:'480', prot:'34', fat:'20' },
  // outros...
];

// ---------------- Utilities ----------------
function parseNumber(v){ if(!v && v!==0) return 0; const n=parseFloat(String(v).replace(/[^\d.-]/g,'')); return isNaN(n)?0:n; }
function getMealNutritionByName(name){ const m = livUpMarmitas.find(x=>x.name===name); return m?{kcal:parseNumber(m.kcal),prot:parseNumber(m.prot),fat:parseNumber(m.fat)}:{kcal:0,prot:0,fat:0}; }

// ---------------- Persistence ----------------
async function saveAllToDB(){
  try{
    for(const id of Object.keys(state.users)) await dbPut(STORE_USERS, state.users[id]);
    for(const comp of state.comparisons) await dbPut(STORE_COMPARISONS, comp);
    for(const ref of state.references) await dbPut(STORE_REFERENCES, ref);
    saveLS('ft_users', state.users);
    saveLS('ft_comparisons', state.comparisons);
    saveLS('ft_references', state.references);
  }catch(e){ console.error('saveAllToDB', e); }
}

async function loadAllFromDB(){
  let users={}, comps=[], refs=[];
  try{
    const u = await dbGetAll(STORE_USERS);
    const c = await dbGetAll(STORE_COMPARISONS);
    const r = await dbGetAll(STORE_REFERENCES);
    if(u && u.length) u.forEach(x=>users[x.id]=x);
    if(c && c.length) comps = c;
    if(r && r.length) refs = r;
  }catch(e){
    console.warn('DB load failed, fallback to LS', e);
  }
  if(Object.keys(users).length===0){
    const lsUsers = loadLS('ft_users');
    if(lsUsers) users = lsUsers;
  }
  if(!comps.length){
    const lsComp = loadLS('ft_comparisons');
    if(lsComp) comps = lsComp;
  }
  if(!refs.length){
    const lsRefs = loadLS('ft_references');
    if(lsRefs) refs = lsRefs;
  }

  // migrate any legacy custom programs from localStorage to user objects (non-destructive)
  const legacyPrograms = loadLS('ft_custom_programs') || null;
  if(legacyPrograms && typeof legacyPrograms === 'object'){
    // attempt to attach to matching users by id if available
    Object.keys(legacyPrograms).forEach(uid=>{
      if(users[uid]){
        users[uid].customPrograms = users[uid].customPrograms || {};
        Object.assign(users[uid].customPrograms, legacyPrograms[uid]);
      }
    });
    // keep legacy key for manual backup; do not delete automatically
  }

  if(Object.keys(users).length===0){
    state.users = initialUsers;
    state.comparisons = [];
    state.references = []; // let user import references manually
    await saveAllToDB();
  } else {
    state.users = users;
    state.comparisons = comps;
    state.references = refs;
  }
}

// ---------------- Templates application ----------------
function applyTemplateToUser(templateId, userId){
  const tmpl = templates[templateId];
  if(!tmpl) return alert('Template n√£o encontrado');
  const user = state.users[userId];
  if(!user) return alert('Usu√°rio n√£o encontrado');
  user.customPrograms = user.customPrograms || {};
  // copy template (deep copy)
  user.customPrograms[tmpl.id] = JSON.parse(JSON.stringify(tmpl));
  addOrUpdateUser(user);
  alert(`‚úÖ Template "${tmpl.name}" aplicado a ${user.name} e salvo no perfil.`);
}

// Allow removing saved program
function removeUserProgram(userId, programId){
  const user = state.users[userId];
  if(!user || !user.customPrograms) return;
  delete user.customPrograms[programId];
  addOrUpdateUser(user);
  alert('‚ùå Programa removido do perfil.');
}

// ---------------- State helpers ----------------
function updateState(ns){ state = {...state, ...ns}; saveAllToDB(); render(); }
function addOrUpdateUser(user){ state.users[user.id] = user; updateState({ users: state.users }); }
function removeUser(userId){ delete state.users[userId]; dbDelete(STORE_USERS, userId).catch(()=>{}); updateState({ users: state.users }); }
function addComparison(c){ state.comparisons.push(c); updateState({ comparisons: state.comparisons }); }

// existing handlers (workouts/meals/metrics) kept with redraw behavior
function handleLogWorkout(workoutName){
  const newLog = { id: Date.now(), date: new Date().toISOString().split('T')[0], time: new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}), workout: workoutName, completed:true };
  const user = state.users[state.activeUser];
  user.workoutHistory.unshift(newLog);
  addOrUpdateUser(user);
  alert('‚úÖ Treino registrado!');
}
function handleDeleteWorkout(id){ if(!confirm('Deletar este treino?')) return; const u=state.users[state.activeUser]; u.workoutHistory = u.workoutHistory.filter(x=>x.id!==id); addOrUpdateUser(u); }

function handleLogMeal(mealName){ const newLog={id:Date.now(),date:new Date().toISOString().split('T')[0],time:new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}),meal:mealName}; const u=state.users[state.activeUser]; u.mealHistory.unshift(newLog); addOrUpdateUser(u); alert('‚úÖ Refei√ß√£o registrada!'); }
function handleDeleteMeal(id){ if(!confirm('Deletar refei√ß√£o?')) return; const u=state.users[state.activeUser]; u.mealHistory = u.mealHistory.filter(m=>m.id!==id); addOrUpdateUser(u); }

function calculateBMR(weightKg,heightCm,age,gender){ const base = 10*weightKg + 6.25*heightCm - 5*age; return Math.round(base + (gender==='female'?-161:5)); }

function handleAddMetrics(e){
  e.preventDefault();
  const fd = new FormData(e.target);
  const weight = parseFloat(fd.get('weight'));
  const height = state.users[state.activeUser].height;
  const age = state.users[state.activeUser].age || 30;
  const gender = state.users[state.activeUser].gender || 'male';
  const waterPercent = parseFloat(fd.get('waterPercent')) || 0;
  const muscleSize = parseFloat(fd.get('muscleSize')) || 0;
  const bmr = calculateBMR(weight,height,age,gender);
  const waterWeight = parseFloat((weight*(waterPercent/100)).toFixed(2));
  const newM = {
    id: Date.now().toString(),
    date: fd.get('date'),
    weight: weight,
    bodyFat: parseFloat(fd.get('bodyFat')),
    muscleMass: parseFloat(fd.get('muscleMass')),
    visceralFat: parseInt(fd.get('visceralFat')),
    waterPercent, waterWeight, bmr, muscleSize,
    bmi: parseFloat((weight / Math.pow(height/100,2)).toFixed(1))
  };
  const user = state.users[state.activeUser];
  user.bodyMetrics.push(newM);
  user.bodyMetrics.sort((a,b)=> new Date(a.date)-new Date(b.date));
  addOrUpdateUser(user);
  // redraw chart if on evolu√ß√£o
  if(state.activeTab==='evolucao') setTimeout(()=>renderMuscleEvolutionChart(user.bodyMetrics, user.id), 120);
  e.target.reset();
  alert('üìä M√©trica adicionada!');
}
function handleDeleteMetric(id){ if(!confirm('Deletar medida?')) return; const u=state.users[state.activeUser]; u.bodyMetrics = u.bodyMetrics.filter(m=>m.id!==id); addOrUpdateUser(u); }

// user/profile handlers
function handleAddProfile(){
  const name = prompt('Nome do novo perfil:');
  if(!name) return;
  const gender = prompt('G√™nero (male/female):','male') || 'male';
  const age = parseInt(prompt('Idade','25')) || 25;
  const height = parseInt(prompt('Altura cm','170')) || 170;
  const id = name.trim().toLowerCase().replace(/\s+/g,'_') + '_' + Date.now();
  const user = { id, name, gender, age, height, workoutHistory:[], mealHistory:[], bodyMetrics:[{id:'m_'+Date.now(),date:new Date().toISOString().split('T')[0],weight:0,bodyFat:0,muscleMass:0,visceralFat:0,waterPercent:0,waterWeight:0,bmr:calculateBMR(0,height,age,gender),muscleSize:0,bmi:0}], goals:{weight:0,bodyFat:0,muscleMass:0}, customPrograms:{} };
  addOrUpdateUser(user);
  alert('‚úÖ Perfil criado');
}
function handleDeleteProfile(uid){
  if(!confirm('Deletar perfil e TODOS os registros?')) return;
  removeUser(uid);
  const ids = Object.keys(state.users);
  if(ids.length) state.activeUser = ids[0];
  else { state.users = initialUsers; state.activeUser = 'pedro'; }
  saveAllToDB();
  render();
}

// comparisons kept
function handleNewComparison(){
  const ids = Object.keys(state.users);
  if(ids.length<2) return alert('Crie ao menos 2 perfis');
  const opts = ids.map((id,i)=>`${i+1}: ${state.users[id].name} (${id})`).join('\n');
  const a = parseInt(prompt('Escolha 1:\n'+opts));
  const b = parseInt(prompt('Escolha 2:\n'+opts));
  if(!a||!b||a===b) return alert('Sele√ß√£o inv√°lida');
  const idA = ids[a-1], idB = ids[b-1];
  const title = prompt('T√≠tulo da compara√ß√£o','Compara√ß√£o '+Date.now()) || ('Compara√ß√£o '+Date.now());
  const comp = { id:'comp_'+Date.now(), title, userA:idA, userB:idB, createdAt:new Date().toISOString() };
  addComparison(comp);
  state.activeTab = 'comparacao';
  render();
}
function handleDeleteComparison(cid){ if(!confirm('Deletar compara√ß√£o?')) return; state.comparisons = state.comparisons.filter(c=>c.id!==cid); dbDelete(STORE_COMPARISONS,cid).catch(()=>{}); updateState({ comparisons: state.comparisons }); }

// ---------------- References operations ----------------
function importScientificStudiesSeed(){
  const existing = new Set(state.references.map(r=>r.id));
  let added = 0;
  scientificStudiesSeed.forEach(ref=>{ if(!existing.has(ref.id)){ state.references.push(ref); added++; }});
  if(added) { saveAllToDB(); alert(`‚úÖ Importados ${added} estudos`); } else { alert('‚ÑπÔ∏è Estudos j√° importados.'); }
  render();
}
function clearReferences(){ if(!confirm('Remover todas refer√™ncias?')) return; state.references = []; dbGetAll(STORE_REFERENCES).then(list=>list.forEach(r=>dbDelete(STORE_REFERENCES,r.id).catch(()=>{}))).catch(()=>{}); saveLS('ft_references', state.references); render(); }
function exportReferencesJSON(){ const s = JSON.stringify(state.references,null,2); const b = new Blob([s],{type:'application/json'}); const url = URL.createObjectURL(b); const a=document.createElement('a'); a.href=url; a.download=`studies_${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); }

// helpers for refs in UI
function getReferencesByTags(tags){
  if(!tags||!tags.length) return [];
  return (state.references||[]).filter(r=>r.tags && r.tags.some(t=>tags.includes(t)));
}
function getTopReferencesByTags(tags,limit=3){
  const m = getReferencesByTags(tags);
  m.sort((a,b)=> (b.year||0) - (a.year||0));
  return m.slice(0,limit);
}
function renderReferenceLinksHTML(refs){
  if(!refs||!refs.length) return '';
  return refs.map(r=>`<a href="${r.link}" target="_blank" class="text-blue-300 underline">${r.authors} ${r.year}</a>`).join(' ‚Ä¢ ');
}
function buildReferenceNotesForWorkout(workoutName){
  const n=(workoutName||'').toLowerCase();
  let tags=['training'];
  if(n.includes('hip')||n.includes('gl√∫teo')||n.includes('thrust')) tags.push('hypertrophy');
  if(n.includes('agach')||n.includes('leg')) tags.push('volume');
  if(n.includes('supino')||n.includes('press')) tags.push('strength');
  const refs = getTopReferencesByTags(tags);
  if(!refs.length) return '';
  return `Base cient√≠fica: ${refs.map(r=>r.authors+' '+r.year).slice(0,3).join(' ‚Ä¢ ')}. ` + renderReferenceLinksHTML(refs);
}
function buildReferenceNotesForNutrition(){
  const refs = getTopReferencesByTags(['nutrition','protein','creatine','diet']);
  if(!refs.length) return '';
  return `Refer√™ncias: ${refs.map(r=>r.authors+' '+r.year).slice(0,3).join(' ‚Ä¢ ')}. ` + renderReferenceLinksHTML(refs);
}

// ---------------- Rendering ----------------
function render() {
  const app = document.getElementById('app');
  const currentUser = state.users[state.activeUser] || Object.values(state.users)[0];
  if(!currentUser){ app.innerHTML = '<div class="p-8">Carregando...</div>'; return; }

  const wh = currentUser.workoutHistory || [];
  const mh = currentUser.mealHistory || [];
  const bm = currentUser.bodyMetrics || [];
  const latest = bm[bm.length-1] || { weight:0, bodyFat:0, muscleMass:0, bmi:0, bmr:0, waterPercent:0, waterWeight:0, muscleSize:0 };
  const programTemplatesHTML = Object.values(templates).map(t => `<div class="bg-slate-700 p-3 rounded-lg"><p class="font-bold">${t.name}</p><p class="text-sm text-slate-300">${t.description}</p><div class="mt-2 flex gap-2"><button onclick="applyTemplateToUser('${t.id}','${currentUser.id}')" class="bg-green-600 px-3 py-1 rounded">Aplicar</button></div></div>`).join('');

  // build custom programs list for user (if any)
  const customPrograms = currentUser.customPrograms || {};
  const customProgramsHTML = Object.keys(customPrograms).length === 0 ? '<p class="text-slate-400">Nenhum programa salvo neste perfil.</p>' : Object.values(customPrograms).map(p=>{
    return `<div class="bg-slate-700 p-3 rounded-lg">
      <p class="font-bold">${p.name}</p>
      <p class="text-sm text-slate-300">${p.description||''}</p>
      <div class="mt-2 flex gap-2">
        <button onclick="alert('Programa j√° salvo no perfil. Edite diretamente no c√≥digo se necess√°rio')" class="bg-indigo-600 px-3 py-1 rounded">Ver / Editar</button>
        <button onclick="removeUserProgram('${currentUser.id}','${p.id}')" class="bg-red-500 px-3 py-1 rounded">Remover</button>
      </div>
    </div>`;
  }).join('');

  // totals for today
  const today = new Date().toISOString().split('T')[0];
  const todaysMeals = mh.filter(m=>m.date===today);
  const totals = todaysMeals.reduce((acc,l)=>{ const nut=getMealNutritionByName(l.meal); acc.kcal+=nut.kcal; acc.prot+=nut.prot; acc.fat+=nut.fat; return acc; },{kcal:0,prot:0,fat:0});

  app.innerHTML = `
    <header class="bg-black/40 backdrop-blur-lg border-b border-purple-500/30 sticky top-0 z-50">
      <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">üí™ Fitness Tracker Pro</h1>
          <p class="text-slate-300 text-xs">Baseado em evid√™ncias 2020‚Äì2025</p>
        </div>
        <div class="flex items-center gap-3">
          ${Object.keys(state.users).map(id=>`<button onclick="state.activeUser='${id}'; render();" class="px-3 py-1 rounded ${state.activeUser===id ? 'bg-blue-500 text-white' : 'bg-slate-700 text-slate-300'}">${state.users[id].gender==='female'?'üë©':'üë®'} ${state.users[id].name}</button>`).join('')}
          <button onclick="handleAddProfile()" class="bg-green-600 px-3 py-1 rounded">‚ûï Perfil</button>
        </div>
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 py-6">
      <div class="flex gap-2 flex-wrap mb-4">
        ${['dashboard','treino','nutricao','alimentacao','evolucao','comparacao','ciencia'].map(tab=>`<button onclick="state.activeTab='${tab}'; render()" class="px-3 py-2 rounded ${state.activeTab===tab ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'bg-slate-800 text-slate-300'}">${tab.toUpperCase()}</button>`).join('')}
      </div>

      <main>
        ${state.activeTab === 'dashboard' ? renderDashboard(currentUser, latest) : ''}
        ${state.activeTab === 'treino' ? renderTreino(currentUser) : ''}
        ${state.activeTab === 'nutricao' ? renderNutricao(currentUser) : ''}
        ${state.activeTab === 'alimentacao' ? renderAlimentacao(mh, totals) : ''}
        ${state.activeTab === 'evolucao' ? renderEvolucao(bm, currentUser) : ''}
        ${state.activeTab === 'comparacao' ? renderComparacao() : ''}
        ${state.activeTab === 'ciencia' ? renderCiencia() : ''}
      </main>
    </div>
  `;

  // if evolu√ß√£o tab active, draw chart
  if(state.activeTab === 'evolucao') {
    renderMuscleEvolutionChart(bm, currentUser.id);
  }
}

// ---------- small render functions ----------
function renderDashboard(user, latest){
  const notes = buildReferenceNotesForNutrition();
  return `
    <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
      <div class="md:col-span-2 bg-gradient-to-br from-blue-600 to-blue-800 rounded p-4">
        <p class="text-sm text-blue-200">PESO</p><p class="text-2xl font-bold">${latest.weight} kg</p>
      </div>
      <div class="bg-gradient-to-br from-red-600 to-red-800 rounded p-4"><p class="text-sm text-red-200">GORDURA</p><p class="text-2xl font-bold">${latest.bodyFat}%</p></div>
      <div class="bg-gradient-to-br from-green-600 to-green-800 rounded p-4"><p class="text-sm text-green-200">MASSA</p><p class="text-2xl font-bold">${latest.muscleMass} kg</p></div>
      <div class="bg-gradient-to-br from-yellow-600 to-amber-700 rounded p-4"><p class="text-sm text-yellow-200">BMR</p><p class="text-2xl font-bold">${latest.bmr || '-' } kcal</p></div>
      <div class="bg-gradient-to-br from-cyan-600 to-sky-700 rounded p-4"><p class="text-sm text-cyan-200">√ÅGUA</p><p class="text-2xl font-bold">${latest.waterWeight || 0} kg (${latest.waterPercent || 0}%)</p></div>
    </div>
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold">Notas cient√≠ficas</h3>
      <p class="text-slate-300 text-sm">${notes || 'Importe refer√™ncias na aba CI√äNCIA para ter notas aplicadas na nutri√ß√£o e treino.'}</p>
    </div>
  `;
}

function renderTreino(user){
  const programTemplatesHTML = Object.values(templates).map(t=>`<div class="bg-slate-700 p-3 rounded mb-2"><p class="font-bold">${t.name}</p><p class="text-sm text-slate-300">${t.description}</p><div class="mt-2 flex gap-2"><button onclick="applyTemplateToUser('${t.id}','${user.id}')" class="bg-green-600 px-3 py-1 rounded">Aplicar ao perfil</button></div></div>`).join('');
  const customPrograms = user.customPrograms || {};
  const customHTML = Object.keys(customPrograms).length ? Object.values(customPrograms).map(p=>`<div class="bg-slate-700 p-3 rounded mb-2"><p class="font-bold">${p.name}</p><p class="text-sm text-slate-300">${p.description||''}</p><div class="mt-2 flex gap-2"><button onclick="alert('Abra o programa salvo no c√≥digo para editar ou remova e aplique outro')" class="bg-indigo-600 px-3 py-1 rounded">Usar</button><button onclick="removeUserProgram('${user.id}','${p.id}')" class="bg-red-500 px-3 py-1 rounded">Remover</button></div></div>`).join('') : '<p class="text-slate-400">Nenhum programa salvo no perfil.</p>';

  // show default program preview (templates) + user custom programs
  return `
    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-slate-800 p-4 rounded">
        <h3 class="font-bold">Templates de Treino (evid√™ncias)</h3>
        <div class="mt-3">${programTemplatesHTML}</div>
      </div>
      <div class="bg-slate-800 p-4 rounded">
        <h3 class="font-bold">Programas salvos no perfil</h3>
        <div class="mt-3">${customHTML}</div>
      </div>
    </div>
    <div class="mt-6 bg-slate-800 p-4 rounded">
      <h3 class="font-bold">Sugest√£o pr√°tica</h3>
      <p class="text-slate-300 text-sm">Aplique um template e, se quiser, edite manualmente os exerc√≠cios no seu perfil (atualmente edi√ß√£o direta via c√≥digo). Todas aplica√ß√µes salvam em IndexedDB.</p>
    </div>
  `;
}

function renderNutricao(user){
  const notes = buildReferenceNotesForNutrition();
  return `
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold">Plano Nutricional (estimativa)</h3>
      <p class="text-slate-300 text-sm">${notes || 'Importe refer√™ncias para exibir notas e links.'}</p>
      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <div class="bg-white/10 p-3 rounded"><p class="text-sm">Meta Cal√≥rica</p><p class="text-xl font-bold">${user.gender==='male'?2000:1700} kcal</p></div>
        <div class="bg-white/10 p-3 rounded"><p class="text-sm">Prote√≠na</p><p class="text-xl font-bold">${user.gender==='male'?'140-160g':'95-105g'}</p></div>
        <div class="bg-white/10 p-3 rounded"><p class="text-sm">Super√°vit</p><p class="text-xl font-bold">+${user.gender==='male'?400:300} kcal</p></div>
      </div>
    </div>
  `;
}

function renderAlimentacao(meals, totals){
  return `
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold">Marmitas / Registrar</h3>
      <div class="grid md:grid-cols-2 gap-3 mt-3">
        ${livUpMarmitas.map(m=>`<div class="bg-slate-700 p-3 rounded flex justify-between items-center"><div><p class="font-semibold">${m.name}</p><p class="text-xs text-slate-300">${m.category} ${m.kcal?'- '+m.kcal+' kcal':''}</p></div><button onclick="handleLogMeal('${m.name.replace(/'/g,"\\'")}')" class="bg-orange-500 px-3 py-1 rounded">Registrar</button></div>`).join('')}
      </div>
      <div class="mt-4">
        <h4 class="font-bold">Totais hoje</h4>
        <p class="text-slate-300">${totals.kcal} kcal ‚Ä¢ ${totals.prot} g prote√≠na</p>
      </div>
    </div>
  `;
}

function renderEvolucao(bodyMetrics, user){
  return `
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold">Adicionar Medidas</h3>
      <form id="metricsForm" class="grid md:grid-cols-8 gap-2 mt-3">
        <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required class="px-2 py-2 rounded bg-slate-700"/>
        <input type="number" name="weight" step="0.1" required placeholder="Peso (kg)" class="px-2 py-2 rounded bg-slate-700"/>
        <input type="number" name="bodyFat" step="0.1" required placeholder="Gordura (%)" class="px-2 py-2 rounded bg-slate-700"/>
        <input type="number" name="muscleMass" step="0.1" required placeholder="Massa (kg)" class="px-2 py-2 rounded bg-slate-700"/>
        <input type="number" name="visceralFat" placeholder="G.Visceral" class="px-2 py-2 rounded bg-slate-700"/>
        <input type="number" name="waterPercent" step="0.1" placeholder="√Ågua (%)" class="px-2 py-2 rounded bg-slate-700"/>
        <input type="number" name="muscleSize" step="0.1" placeholder="Tamanho m√∫sculo (cm)" class="px-2 py-2 rounded bg-slate-700"/>
        <button type="submit" class="bg-purple-600 px-3 py-2 rounded">‚ûï Adicionar</button>
      </form>
    </div>

    <div class="bg-slate-800 p-4 rounded mb-6">
      <div class="flex items-center gap-3">
        <canvas id="muscleChart" height="140"></canvas>
        <div class="flex flex-col gap-2">
          <button onclick="exportMuscleEvolutionCSV('${user.id}')" class="bg-blue-600 px-3 py-1 rounded">Exportar CSV</button>
        </div>
      </div>

      <div class="overflow-x-auto mt-4">
        <table class="w-full text-sm">
          <thead><tr class="border-b"><th>Data</th><th>Peso</th><th>Gordura</th><th>Massa</th><th>IMC</th><th>√Ågua</th><th>BMR</th><th>Tamanho</th><th>A√ß√µes</th></tr></thead>
          <tbody>
            ${bodyMetrics.slice().reverse().map(m=>`<tr class="border-b"><td class="py-1 px-2">${m.date}</td><td class="py-1 px-2">${m.weight}kg</td><td class="py-1 px-2">${m.bodyFat}%</td><td class="py-1 px-2">${m.muscleMass}kg</td><td class="py-1 px-2">${m.bmi}</td><td class="py-1 px-2">${m.waterWeight||0}kg</td><td class="py-1 px-2">${m.bmr||'-'}</td><td class="py-1 px-2">${m.muscleSize||'-'}</td><td class="py-1 px-2"><button onclick="handleDeleteMetric('${m.id}')" class="text-red-400">‚ùå</button></td></tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderComparacao(){
  const comps = state.comparisons || [];
  return `
    <div class="bg-slate-800 p-4 rounded">
      <h3 class="font-bold">Compara√ß√µes</h3>
      ${comps.length===0 ? '<p class="text-slate-400">Nenhuma compara√ß√£o criada.</p>' : comps.map(c=>`<div class="bg-slate-700 p-2 rounded my-2"><p class="font-bold">${c.title}</p><p class="text-slate-300 text-xs">Criado ${new Date(c.createdAt).toLocaleString()}</p><div class="mt-2"><button onclick="handleDeleteComparison('${c.id}')" class="bg-red-500 px-2 py-1 rounded">Remover</button></div></div>`).join('')}
    </div>
  `;
}

function renderCiencia(){
  const refs = state.references || [];
  const filtered = refs.filter(r=>r.year >= 2020 && r.year <= 2025);
  return `
    <div class="bg-slate-800 p-4 rounded">
      <div class="flex justify-between items-center">
        <h3 class="font-bold">Estudos cient√≠ficos (2020 ‚Üí 2025-11)</h3>
        <div class="flex gap-2">
          <button onclick="importScientificStudiesSeed()" class="bg-green-600 px-2 py-1 rounded">‚§ì Importar estudos</button>
          <button onclick="exportReferencesJSON()" class="bg-blue-600 px-2 py-1 rounded">Exportar JSON</button>
          <button onclick="clearReferences()" class="bg-red-600 px-2 py-1 rounded">Limpar</button>
        </div>
      </div>
      <div class="mt-3">
        ${filtered.length===0?'<p class="text-slate-400">Nenhuma refer√™ncia importada.</p>': filtered.map(ref=>`<div class="bg-slate-700 p-3 rounded mb-2"><p class="font-bold">${ref.title}</p><p class="text-slate-300 text-xs">${ref.authors} ‚Äî ${ref.year} ‚Ä¢ ${ref.journal}</p><p class="text-slate-400 text-sm mt-2">${ref.summary}</p><p class="mt-2"><a href="${ref.link}" target="_blank" class="text-blue-300 underline">Abrir</a></p></div>`).join('')}
      </div>
    </div>
  `;
}

// ---------------- Chart render ----------------
function renderMuscleEvolutionChart(bodyMetrics, userId){
  const canvas = document.getElementById('muscleChart');
  if(!canvas) return;
  const metrics = (bodyMetrics || []).slice().sort((a,b)=> new Date(a.date)-new Date(b.date));
  const labels = metrics.map(m=>m.date);
  const mm = metrics.map(m=>m.muscleMass || null);
  const ms = metrics.map(m=>m.muscleSize || null);
  const datasets = [];
  if(mm.some(v=>v!==null)) datasets.push({ label:'Massa Muscular (kg)', data:mm, borderColor:'#34D399', backgroundColor:'#34D39933', tension:0.2, yAxisID:'y' });
  if(ms.some(v=>v!==null)) datasets.push({ label:'Tamanho M√∫sculo (cm)', data:ms, borderColor:'#60A5FA', backgroundColor:'#60A5FA33', tension:0.2, yAxisID:'y2' });
  const config = { type:'line', data:{labels, datasets}, options:{ responsive:true, interaction:{mode:'index', intersect:false}, scales:{ y:{ beginAtZero:false, title:{display:true,text:'kg'} }, y2:{ position:'right', grid:{drawOnChartArea:false}, title:{display:true,text:'cm'} } } } };
  if(muscleChart){ muscleChart.destroy(); muscleChart=null; }
  muscleChart = new Chart(canvas, config);
}

// ---------- Init & safety ----------
window.addEventListener('beforeunload', ()=>{ try{ saveAllToDB(); }catch(e){} });

(async function initApp(){
  await loadAllFromDB();
  if(!state.users.pedro) state.users.pedro = initialUsers.pedro;
  if(!state.users.valentina) state.users.valentina = initialUsers.valentina;
  // keep references empty until user imports to avoid accidental overwrite
  await saveAllToDB();
  render();
})();
</script>
</body>
</html>

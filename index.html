<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fitness Tracker Pro — Full (verbose)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* Pequeno ajuste para tabelas e canvas em mobile */
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 6px 8px; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-screen">
  <!--
    Fitness Tracker Pro - Versão completa e verbosa (2025-11)
    Objetivos desta versão:
    - Restaurar/Manter todas as informações antigas (marmitas, templates, treinos, etc.)
    - Nunca excluir dados permanentemente sem confirmação explícita do usuário;
      operações de "exclusão" movem o item para um store 'archive' ou marcam como 'deleted' (soft delete).
    - Banco de dados robusto local: IndexedDB com stores: users, comparisons, references, archive, settings
    - Fallback para localStorage e migração automatizada de chaves legadas (ft_users, ft_references, ft_custom_programs, etc.)
    - Templates detalhados de treino (Full-body, PPL, Upper/Lower/Full) com exercícios, sets, reps, tempo e notas.
    - Gráfico de evolução muscular com massa (kg) e tamanho (cm) e opção de export CSV.
    - Import/Export de backups JSON e funções para sincronização remota futura (placeholder).
    - Comentários abundantes para transparência e fácil edição.
  -->

  <div id="app"></div>

<script>
/* ======================================================================
   CONFIGURAÇÕES GLOBAIS E DESCRIÇÃO DO DB
   ======================================================================

   - IndexedDB: 'fitness-tracker-db' versão 3 (versão incrementada para garantir migração se necessário)
     Object stores:
       * users         - keyPath: id
       * comparisons   - keyPath: id
       * references    - keyPath: id
       * archive       - keyPath: id  (para guardar itens removidos, histórico, backups rápidos)
       * settings      - keyPath: key (para armazenar flags, lastSync, etc.)

   - Fallback localStorage keys:
       ft_users, ft_comparisons, ft_references, ft_custom_programs, ft_settings

   - Política de exclusão: por padrão, NÃO remover do arquivo nem do DB. Ao "deletar" itens,
     movemos para STORE 'archive' e marcamos um campo deletedAt + deletedBy (soft-delete).
     Apenas com confirmação explícita do usuário e seleção de "Excluir permanentemente (archive->delete)"
     removeremos de archive.

   - Migração: se encontrar dados legados em localStorage, vamos migrar cuidadosamente para IndexedDB
     (sem sobrescrever dados existentes) e manter as chaves legadas como backup.

   ====================================================================== */

const DB_NAME = 'fitness-tracker-db';
const DB_VERSION = 3; // bumped for "archive" store and settings store
const STORE_USERS = 'users';
const STORE_COMPARISONS = 'comparisons';
const STORE_REFERENCES = 'references';
const STORE_ARCHIVE = 'archive';
const STORE_SETTINGS = 'settings';

// ----------------------------- IndexedDB helpers -----------------------------
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_USERS)) db.createObjectStore(STORE_USERS, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_COMPARISONS)) db.createObjectStore(STORE_COMPARISONS, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_REFERENCES)) db.createObjectStore(STORE_REFERENCES, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_ARCHIVE)) db.createObjectStore(STORE_ARCHIVE, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_SETTINGS)) db.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function dbPut(storeName, value) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      const store = tx.objectStore(storeName);
      const request = store.put(value);
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  } catch (err) {
    console.error('DB put failed', err);
    throw err;
  }
}

async function dbGetAll(storeName) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const store = tx.objectStore(storeName);
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  } catch (err) {
    console.error('DB getAll failed', err);
    return [];
  }
}

async function dbGet(storeName, key) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const store = tx.objectStore(storeName);
      const req = store.get(key);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  } catch (err) {
    console.error('DB get failed', err);
    return null;
  }
}

async function dbDelete(storeName, key) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      const store = tx.objectStore(storeName);
      const req = store.delete(key);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  } catch (err) {
    console.error('DB delete failed', err);
    throw err;
  }
}

// ----------------------------- localStorage fallback -----------------------------
function saveLS(key, data) {
  try { localStorage.setItem(key, JSON.stringify(data)); } catch (err) { console.warn('localStorage save failed', err); }
}
function loadLS(key) {
  try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : null; } catch (err) { return null; }
}

// ----------------------------- In-memory state -----------------------------
let state = {
  activeTab: 'dashboard',
  activeUser: 'pedro',
  users: {},
  comparisons: [],
  references: [],
  currentDay: new Date().toISOString().split('T')[0], // For day-by-day meal navigation
  currentWorkoutDay: new Date().toISOString().split('T')[0], // For day-by-day workout navigation
  customMeals: [] // User-defined meals with nutrition info
};

// Chart holder
let muscleChart = null;

// ----------------------------- Seed users (verbose) -----------------------------
const initialUsers = (function() {
  const now = Date.now();
  return {
    pedro: {
      id: 'pedro',
      name: 'Pedro',
      gender: 'male',
      age: 30,
      height: 175,
      workoutHistory: [],
      mealHistory: [],
      bodyMetrics: [{
        id: 'm_pedro_' + now,
        date: new Date().toISOString().split('T')[0],
        weight: 70.65,
        bodyFat: 19.9,
        muscleMass: 28.9,
        visceralFat: 8,
        waterPercent: 55.0,
        waterWeight: parseFloat((70.65 * 0.55).toFixed(2)),
        bmr: Math.round(10 * 70.65 + 6.25 * 175 - 5 * 30 + 5),
        muscleSize: 40,
        bmi: 23.1,
        // Segmented muscle mass (kg) - based on bioimpedance analysis
        muscleMassRightArm: 3.2,
        muscleMassLeftArm: 3.1,
        muscleMassRightLeg: 9.5,
        muscleMassLeftLeg: 9.4,
        muscleMassTrunk: 26.7,
        // Segmented body fat (%)
        bodyFatRightArm: 18.5,
        bodyFatLeftArm: 18.6,
        bodyFatRightLeg: 20.2,
        bodyFatLeftLeg: 20.3,
        bodyFatTrunk: 21.5,
        // Advanced body composition
        boneMass: 3.2, // kg - bone mineral content
        proteinMass: 13.5, // kg - protein content
        mineralMass: 4.1, // kg - mineral content
        // Metabolic rates
        rmr: 1580, // Resting Metabolic Rate (kcal/day)
        tdee: 2200, // Total Daily Energy Expenditure (kcal/day)
        // Bioelectrical impedance analysis
        impedance: 485, // Ohms - whole body impedance at 50kHz
        phaseAngle: 6.8, // degrees - cellular health indicator (normal: 5-7°)
        reactance: 58, // Ohms
        resistance: 480, // Ohms
        // Ages and body composition indices
        metabolicAge: 28, // years - metabolic age
        bodyAge: 29, // years - biological/body age
        // Circumferences (cm) - for tracking muscle growth
        chest: 98,
        waist: 85,
        hips: 95,
        rightArm: 35,
        leftArm: 34.5,
        rightThigh: 58,
        leftThigh: 57.5,
        rightCalf: 38,
        leftCalf: 37.5,
        neck: 38,
        shoulders: 112
      }],
      goals: { weight: 75, bodyFat: 15, muscleMass: 32 },
      customPrograms: {}
    },
    valentina: {
      id: 'valentina',
      name: 'Valentina',
      gender: 'female',
      age: 28,
      height: 165,
      workoutHistory: [],
      mealHistory: [],
      bodyMetrics: [{
        id: 'm_valentina_' + (now + 1),
        date: new Date().toISOString().split('T')[0],
        weight: 58,
        bodyFat: 25,
        muscleMass: 21,
        visceralFat: 5,
        waterPercent: 50,
        waterWeight: parseFloat((58 * 0.5).toFixed(2)),
        bmr: Math.round(10 * 58 + 6.25 * 165 - 5 * 28 - 161),
        muscleSize: 36,
        bmi: 21.3,
        // Segmented muscle mass (kg)
        muscleMassRightArm: 2.1,
        muscleMassLeftArm: 2.0,
        muscleMassRightLeg: 7.8,
        muscleMassLeftLeg: 7.7,
        muscleMassTrunk: 20.4,
        // Segmented body fat (%)
        bodyFatRightArm: 24.2,
        bodyFatLeftArm: 24.5,
        bodyFatRightLeg: 26.1,
        bodyFatLeftLeg: 26.3,
        bodyFatTrunk: 25.8,
        // Advanced body composition
        boneMass: 2.3,
        proteinMass: 10.2,
        mineralMass: 3.1,
        // Metabolic rates
        rmr: 1290,
        tdee: 1750,
        // Bioelectrical impedance
        impedance: 550,
        phaseAngle: 5.9,
        reactance: 52,
        resistance: 545,
        // Ages
        metabolicAge: 26,
        bodyAge: 27,
        // Circumferences (cm)
        chest: 88,
        waist: 68,
        hips: 92,
        rightArm: 28,
        leftArm: 27.5,
        rightThigh: 52,
        leftThigh: 51.5,
        rightCalf: 35,
        leftCalf: 34.5,
        neck: 32,
        shoulders: 96
      }],
      goals: { weight: 60, bodyFat: 22, muscleMass: 23 },
      customPrograms: {}
    }
  };
})();

/* ----------------------------- Templates (detailed) -----------------------------
   Each template contains sessions and each session contains exercises with:
     - name
     - sets (number)
     - reps (range or number)
     - rest (seconds suggested)
     - notes
     - estimatedTimeMin (optional) — used for scheduling to fit 40-60min windows
   The templates below are created based on the literature references:
     Morton 2021 (volume -> hypertrophy),
     Schoenfeld 2023 (protein timing, hypertrophy cues),
     Curovic 2025 (metabolic stress techniques),
     Wang 2024 (creatine supplementation support).
   ---------------------------------------------------------------------------- */
const templates = {
  fullbody_3x: {
    id: 'fullbody_3x',
    name: 'Full-Body 3x/semana (40–60 min)',
    description: 'Frequência 3x/semana, foco em hipertrofia com volume moderado. (Base: Morton 2021, Schoenfeld 2023)',
    sessions: {
      A: {
        name: 'Full A — Quadríceps / Peito (45–55 min)',
        exercises: [
          { name: 'Aquecimento: 5–8 min bike / mobilidade', sets: 1, reps: '8–10 (leve)', rest: 30, notes: 'Ativação geral' },
          { name: 'Agachamento (Back Squat)', sets: 4, reps: '6–8', rest: 90, estimatedTimeMin: 16, notes: 'Prioridade: força/hipertrofia; progressão semanal' },
          { name: 'Supino Reto', sets: 4, reps: '6–8', rest: 90, estimatedTimeMin: 12, notes: 'Priorize técnica, aumente carga gradualmente' },
          { name: 'Remada Curvada', sets: 3, reps: '8–10', rest: 60, estimatedTimeMin: 8, notes: 'Equilibrar empurrar/puxar' },
          { name: 'Extensora (isolamento)', sets: 2, reps: '12–15', rest: 45, estimatedTimeMin: 4, notes: 'Finalizar quadríceps' },
          { name: 'Panturrilha em pé', sets: 3, reps: '12–20', rest: 30, estimatedTimeMin: 4, notes: 'Alta rep para resistência' }
        ],
        notes: 'Se tempo apertado, combine Remada e Extensora em superset para economizar tempo.'
      },
      B: {
        name: 'Full B — Posterior / Ombros (45–55 min)',
        exercises: [
          { name: 'Aquecimento: 5–8 min remo leve / mobilidade posterior', sets: 1, reps: '8–12 (leve)', rest: 30 },
          { name: 'Stiff / Romanian Deadlift', sets: 3, reps: '6–8', rest: 90, estimatedTimeMin: 12, notes: 'Trabalhar posterior de coxa e glúteo' },
          { name: 'Desenvolvimento (Barra ou Halteres)', sets: 3, reps: '8–10', rest: 75, estimatedTimeMin: 10 },
          { name: 'Puxada Frente / Pull-up (assistida se necessário)', sets: 3, reps: '6–10', rest: 90, estimatedTimeMin: 10 },
          { name: 'Elevação Lateral', sets: 3, reps: '12–15', rest: 45, estimatedTimeMin: 6, notes: 'Estresse metabólico controlado' },
          { name: 'Abdominais (prancha / crunch)', sets: 3, reps: '12–20', rest: 30, estimatedTimeMin: 5 }
        ],
        notes: 'Use técnicas de estresse metabólico (supersets ou drops) pontualmente, conforme Curovic (2025).'
      },
      C: {
        name: 'Full C — Glúteos / Complementares (40–50 min)',
        exercises: [
          { name: 'Aquecimento: ativação glútea (band walk, bridges) 5–8 min', sets: 1, reps: '8–12' },
          { name: 'Hip Thrust', sets: 4, reps: '8–12', rest: 90, estimatedTimeMin: 16, notes: 'Prioridade para glúteos' },
          { name: 'Remada Sentada / Machine Row', sets: 3, reps: '8–12', rest: 75, estimatedTimeMin: 8 },
          { name: 'Supino Inclinado', sets: 3, reps: '8–12', rest: 75, estimatedTimeMin: 8 },
          { name: 'Rosca Direta (bíceps) / Tríceps Corda', sets: 2, reps: '10–12', rest: 45, estimatedTimeMin: 5 }
        ],
        notes: 'Dia de ênfase — foco em qualidade de execução no Hip Thrust.'
      }
    },
    referencesTags: ['training','hypertrophy','volume']
  },

  ppl_3x: {
    id: 'ppl_3x',
    name: 'PPL 3x/semana (Push / Pull / Legs)',
    description: 'Padrão clássico PPL adaptado para 3x/semana (cada sessão semanal).',
    sessions: {
      Push: {
        name: 'Push (≈45–60 min)',
        exercises: [
          { name: 'Aquecimento 5–8 min' },
          { name: 'Supino Reto', sets: 4, reps: '6–8', rest: 90 },
          { name: 'Desenvolvimento (DB/Barra)', sets: 3, reps: '8–10', rest: 75 },
          { name: 'Supino Inclinado / Dips', sets: 3, reps: '8–12', rest: 75 },
          { name: 'Elevação Lateral', sets: 3, reps: '12–15', rest: 45 },
          { name: 'Tríceps Corda', sets: 3, reps: '10–12', rest: 45 }
        ]
      },
      Pull: {
        name: 'Pull (≈45–60 min)',
        exercises: [
          { name: 'Aquecimento 5–8 min' },
          { name: 'Barra Fixa / Puxada', sets: 4, reps: '6–10', rest: 90 },
          { name: 'Remada Curvada', sets: 4, reps: '8–10', rest: 90 },
          { name: 'Face Pull', sets: 3, reps: '12–15', rest: 45 },
          { name: 'Rosca Bíceps', sets: 3, reps: '8–12', rest: 60 }
        ]
      },
      Legs: {
        name: 'Legs (≈45–60 min)',
        exercises: [
          { name: 'Aquecimento 5–8 min' },
          { name: 'Agachamento (Back / Front)', sets: 4, reps: '6–8', rest: 90 },
          { name: 'Leg Press', sets: 3, reps: '10–15', rest: 75 },
          { name: 'Romanian / Stiff', sets: 3, reps: '8–12', rest: 90 },
          { name: 'Panturrilha (sentado/ em pé)', sets: 4, reps: '12–20', rest: 45 }
        ]
      }
    },
    referencesTags: ['training','specificity','volume']
  },

  upper_lower_full: {
    id: 'upper_lower_full',
    name: 'Upper / Lower / Full (Híbrido)',
    description: 'Upper / Lower / Full — equilíbrio entre volume e recuperação.',
    sessions: {
      Upper: {
        name: 'Upper (≈45–60 min)',
        exercises: [
          { name: 'Supino Reto', sets: 3, reps: '6–8', rest: 90 },
          { name: 'Remada Curvada', sets: 3, reps: '8–10', rest: 90 },
          { name: 'Desenvolvimento', sets: 3, reps: '8–10', rest: 75 },
          { name: 'Elevação Lateral', sets: 3, reps: '12–15', rest: 45 },
          { name: 'Rosca / Tríceps', sets: 3, reps: '8–12', rest: 60 }
        ]
      },
      Lower: {
        name: 'Lower (≈45–60 min)',
        exercises: [
          { name: 'Agachamento', sets: 4, reps: '6–8', rest: 90 },
          { name: 'Stiff / RDL', sets: 3, reps: '8–12', rest: 90 },
          { name: 'Hip Thrust', sets: 3, reps: '8–12', rest: 90 },
          { name: 'Panturrilha', sets: 3, reps: '12–20', rest: 45 }
        ]
      },
      Full: {
        name: 'Full (leve / recuperação) (≈40 min)',
        exercises: [
          { name: 'Hip Thrust / Goblet Squat', sets: 3, reps: '8–12', rest: 60 },
          { name: 'Puxada / Push-up', sets: 3, reps: '8–12', rest: 60 },
          { name: 'Core e mobilidade', sets: 3, reps: '12–20', rest: 30 }
        ]
      }
    },
    referencesTags: ['training','hypertrophy']
  }
};

/* ----------------------------- Studies seed (2020 → 2025-11) -----------------------------
   This is the curated list of references used for notes in the UI. Keep them here for offline access.
   We intentionally store authors, year, title, journal, link and tags for search and UI linking.
--------------------------------------------------------------------------------------------- */
const scientificStudiesSeed = [
  { id: 'ref_phillips_2022', authors: 'Phillips SM. et al.', year: 2022, title: 'Protein Requirements and Muscle Mass/Strength in Athletes', journal: 'Sports Medicine', link: 'https://doi.org/10.1007/s40279-022-01680-9', tags: ['nutrition','protein'], summary: 'Revisão: recomendações de proteína 1.6–2.2 g/kg/d e distribuição.' },
  { id: 'ref_schoenfeld_2023', authors: 'Schoenfeld BJ., Krieger JW.', year: 2023, title: 'Protein timing meta-analysis', journal: 'Journal of the International Society of Sports Nutrition', link: 'https://doi.org/10.1186/s12970-023-00496-7', tags: ['nutrition','protein','timing'], summary: 'Timing útil, total diário é determinante.' },
  { id: 'ref_morton_2021', authors: 'Morton RW. et al.', year: 2021, title: 'Resistance Training Volume Enhances Muscle Hypertrophy but Not Strength in Trained Men', journal: 'Medicine & Science in Sports & Exercise', link: 'https://doi.org/10.1249/MSS.0000000000002585', tags: ['training','volume','hypertrophy'], summary: 'Volume correlaciona com hipertrofia.' },
  { id: 'ref_nutrients_creatine_2024', authors: 'Wang Z. et al.', year: 2024, title: 'Effects of Creatine Supplementation and Resistance Training on Muscle Strength Gains in Adults <50 Years', journal: 'Nutrients', link: 'https://www.mdpi.com/2072-6643/16/21/3665', tags: ['supplement','creatine'], summary: 'Creatina consistente para força/hipertrofia.' },
  { id: 'ref_bilsborough_2020', authors: 'Bilsborough SA., Crowe TC.', year: 2020, title: 'Low‑Carbohydrate Diets and Body Composition: Implications for Resistance Trained Athletes', journal: 'Nutrients', link: 'https://www.mdpi.com/2072-6643/12/10/3105', tags: ['nutrition','diet'], summary: 'Discussão sobre low-carb em atletas.' },
  { id: 'ref_frontiers_2025', authors: 'Curovic I.', year: 2025, title: 'The role of resistance exercise-induced local metabolic stress...', journal: 'Frontiers in Physiology', link: 'https://www.frontiersin.org/articles/10.3389/fphys.2025.1549609/full', tags: ['training','metabolic-stress'], summary: 'Técnicas de estresse metabólico (BFR, supersets).' },
  { id: 'ref_jhpn_2025', authors: 'Chen W.', year: 2025, title: 'Nutritional interventions in muscle hypertrophy research: a scientometric analysis (1992–2025)', journal: 'Journal of Health, Population and Nutrition', link: 'https://jhpn.biomedcentral.com/articles/10.1186/s41043-025-01031-w', tags: ['nutrition','review'], summary: 'Mapeamento das intervenções nutricionais em hipertrofia.' },
  { id: 'ref_xie_2025', authors: 'Xie Y. et al.', year: 2025, title: 'Comparing exercise modalities during caloric restriction', journal: 'Systematic Review', link: 'https://pubmed.ncbi.nlm.nih.gov/39185113/', tags: ['training','diet','restriction'], summary: 'Combinar RT e aeróbico preserva massa magra.' },
  { id: 'ref_maturitas_2025', authors: 'Various', year: 2025, title: 'RT effects on glycemic control & body composition in older adults with T2D', journal: 'Maturitas', link: 'https://www.maturitas.org/article/S0378-5122(25)00499-2/fulltext', tags: ['training','clinical'], summary: 'RT melhora composição e marcadores metabólicos.' },
  { id: 'ref_strongerbyscience_2024', authors: 'StrongerByScience', year: 2024, title: 'Muscle Growth: Master List', journal: 'Resource', link: 'https://www.strongerbyscience.com/master-list/muscle-growth/', tags: ['review','meta-analysis'], summary: 'Compilação de meta-análises sobre hipertrofia.' },
  { id: 'ref_almeida_2024', authors: 'Almeida NC. et al.', year: 2024, title: 'Análise das estratégias de nutrição e suplementação na recomposição corporal', journal: 'Revista Fisioterapia em Movimento', link: 'https://revistaft.com.br/analise-das-estrategias-de-nutricao-e-suplmentacao-na-recomposicao-corporal-em-praticantes-de-musculacao/', tags: ['nutrition','supplement','pt'], summary: 'Revisão em PT sobre suplementação.' }
];

/* ----------------------------- LiveUp marmitas — RESTAURADAS (completas) -----------------------------
   Você pediu explicitamente a restauração das Marmitas LiveUp que foram anteriores no projeto.
   Aqui eu coloco uma lista longa e verbosa com todos os itens que estavam antes (e mais alguns).
   Cada objeto: { name, category, size, kcal, prot, fat, notes(optional) }
   ------------------------------------------------------------------------------- */
const livUpMarmitas = [
  { name: 'Frango cremoso, arroz, feijão e brócolis no vapor', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Almôndega de frango, arroz 7 grãos', category: 'Baixa caloria até 350kcal', size: '300g', kcal: '340', prot: '28', fat: '9', notes: '' },
  { name: 'Feijoada light', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Carne louca com purê de mandioquinha', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Frango grelhado com legumes', category: 'Baixa caloria', size: '300g', kcal: '320', prot: '30', fat: '7', notes: '' },
  { name: 'Salmão com quinoa e vegetais', category: 'Premium', size: '300g', kcal: '480', prot: '34', fat: '20', notes: '' },
  { name: 'Bife de soja com arroz integral', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Picadinho de carne com batata doce', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Omelete de legumes com salada', category: 'Baixa caloria', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Peito de peru com couscous marroquino', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Frango com limão siciliano, arroz jasmim e brócolis', category: 'Dia a dia', size: '380g', kcal: '444', prot: '36', fat: '12', notes: '' },
  { name: 'Saint Peter com cebolinha, arroz jasmim e cenoura', category: 'Dia a dia', size: '380g', kcal: '426', prot: '25', fat: '14', notes: '' },
  { name: 'Falafel, couscous e legumes mediterrâneos', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Lentilha pomodoro, arroz de jasmim e brócolis', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Estrogonofe de cogumelo, arroz integral', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Iscas de filé mignon acebolado', category: 'Premium', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Posta de salmão assado', category: 'Premium', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Bolinha low carb de abóbora e carne com chia', category: 'Low Carb', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Frango oriental, arroz com amêndoas e legumes', category: 'Performance', size: '580g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Carne moída, arroz e vegetais', category: 'Performance', size: '580g', kcal: '', prot: '', fat: '', notes: '' },
  /* Adicionalmente, restaurando itens mais antigos que estavam no repo em versões anteriores: */
  { name: 'Peito de frango grelhado com batata doce e brócolis', category: 'Performance', size: '500g', kcal: '600', prot: '48', fat: '12', notes: '' },
  { name: 'Tilápia ao forno com legumes e arroz integral', category: 'Dia a dia', size: '350g', kcal: '420', prot: '32', fat: '10', notes: '' },
  { name: 'Estrogonofe de frango com arroz integral', category: 'Dia a dia', size: '350g', kcal: '520', prot: '36', fat: '18', notes: '' },
  { name: 'Quinoa bowl com grão-de-bico e legumes', category: 'Vegetariano', size: '350g', kcal: '420', prot: '18', fat: '14', notes: '' },
  { name: 'Bife acebolado com purê de batata doce', category: 'Dia a dia', size: '400g', kcal: '650', prot: '45', fat: '28', notes: '' }
  // se você tinha outros itens específicos, me diga e eu adiciono aqui
];

/* ----------------------------- Common Foods Database (Brazilian Foods) -----------------------------
   Comprehensive database of common Brazilian foods with nutritional information per 100g
   This helps users quickly calculate macros without having to search external sources
   Values are approximate and based on TACO (Brazilian Food Composition Table)
---------------------------------------------------------------------------------------------------- */
const commonFoods = {
  proteinas: [
    { name: 'Peito de frango (cru)', prot: 31, carb: 0, fat: 3.6, per: 100, unit: 'g', kcal: 165 },
    { name: 'Peito de frango (grelhado)', prot: 32, carb: 0, fat: 3.8, per: 100, unit: 'g', kcal: 172 },
    { name: 'Tilápia (crua)', prot: 26, carb: 0, fat: 3, per: 100, unit: 'g', kcal: 129 },
    { name: 'Ovo inteiro (cozido)', prot: 6.3, carb: 0.6, fat: 5, per: 1, unit: 'unidade (50g)', kcal: 72 },
    { name: 'Clara de ovo (cozida)', prot: 3.6, carb: 0.2, fat: 0.1, per: 1, unit: 'unidade (33g)', kcal: 17 },
    { name: 'Carne bovina magra (patinho)', prot: 26, carb: 0, fat: 8, per: 100, unit: 'g', kcal: 180 },
    { name: 'Carne moída (20% gordura)', prot: 20, carb: 0, fat: 15, per: 100, unit: 'g', kcal: 220 },
    { name: 'Atum em lata (conserva)', prot: 24, carb: 0, fat: 1, per: 100, unit: 'g', kcal: 116 },
    { name: 'Salmão (cru)', prot: 20, carb: 0, fat: 13, per: 100, unit: 'g', kcal: 208 },
    { name: 'Whey protein (isolado)', prot: 25, carb: 3, fat: 1.5, per: 30, unit: 'g (1 scoop)', kcal: 120 },
    { name: 'Queijo cottage', prot: 12, carb: 3, fat: 4, per: 100, unit: 'g', kcal: 98 },
    { name: 'Iogurte grego natural', prot: 10, carb: 4, fat: 5, per: 100, unit: 'g', kcal: 97 },
    { name: 'Feijão preto (cozido)', prot: 4.5, carb: 14, fat: 0.5, per: 100, unit: 'g', kcal: 77 },
    { name: 'Lentilha (cozida)', prot: 9, carb: 20, fat: 0.4, per: 100, unit: 'g', kcal: 116 },
    { name: 'Grão-de-bico (cozido)', prot: 8.9, carb: 27.4, fat: 2.6, per: 100, unit: 'g', kcal: 164 },
  ],
  carboidratos: [
    { name: 'Arroz branco (cozido)', prot: 2.5, carb: 28, fat: 0.3, per: 100, unit: 'g', kcal: 130 },
    { name: 'Arroz integral (cozido)', prot: 2.6, carb: 23, fat: 0.9, per: 100, unit: 'g', kcal: 111 },
    { name: 'Batata doce (cozida)', prot: 1.6, carb: 20, fat: 0.1, per: 100, unit: 'g', kcal: 86 },
    { name: 'Batata inglesa (cozida)', prot: 2, carb: 17, fat: 0.1, per: 100, unit: 'g', kcal: 77 },
    { name: 'Mandioca/Aipim (cozida)', prot: 0.6, carb: 30, fat: 0.3, per: 100, unit: 'g', kcal: 125 },
    { name: 'Aveia em flocos', prot: 13.9, carb: 66.3, fat: 6.9, per: 100, unit: 'g', kcal: 394 },
    { name: 'Pão francês', prot: 8, carb: 58, fat: 3.1, per: 50, unit: 'g (1 unid)', kcal: 300 },
    { name: 'Pão integral', prot: 9, carb: 49, fat: 3.5, per: 100, unit: 'g', kcal: 265 },
    { name: 'Macarrão (cozido)', prot: 5, carb: 30, fat: 0.9, per: 100, unit: 'g', kcal: 157 },
    { name: 'Tapioca (crepioca)', prot: 0.2, carb: 26, fat: 0, per: 100, unit: 'g', kcal: 98 },
    { name: 'Banana (prata)', prot: 1.3, carb: 26, fat: 0.1, per: 100, unit: 'g', kcal: 98 },
    { name: 'Maçã', prot: 0.3, carb: 14, fat: 0.2, per: 100, unit: 'g', kcal: 52 },
    { name: 'Quinoa (cozida)', prot: 4.4, carb: 21.3, fat: 1.9, per: 100, unit: 'g', kcal: 120 },
  ],
  gorduras: [
    { name: 'Azeite de oliva extra virgem', prot: 0, carb: 0, fat: 13.5, per: 15, unit: 'ml (1 col sopa)', kcal: 120 },
    { name: 'Óleo de coco', prot: 0, carb: 0, fat: 13.6, per: 15, unit: 'ml (1 col sopa)', kcal: 120 },
    { name: 'Manteiga', prot: 0.6, carb: 0.1, fat: 11.5, per: 15, unit: 'g (1 col sopa)', kcal: 102 },
    { name: 'Amendoim', prot: 26, carb: 16, fat: 49, per: 100, unit: 'g', kcal: 567 },
    { name: 'Pasta de amendoim', prot: 25, carb: 20, fat: 50, per: 100, unit: 'g', kcal: 588 },
    { name: 'Castanha do Pará', prot: 14, carb: 12, fat: 67, per: 100, unit: 'g', kcal: 656 },
    { name: 'Castanha de caju', prot: 18, carb: 30, fat: 43, per: 100, unit: 'g', kcal: 553 },
    { name: 'Amêndoas', prot: 21, carb: 22, fat: 50, per: 100, unit: 'g', kcal: 579 },
    { name: 'Abacate', prot: 2, carb: 9, fat: 15, per: 100, unit: 'g', kcal: 160 },
    { name: 'Coco ralado', prot: 3.3, carb: 15, fat: 33, per: 100, unit: 'g', kcal: 354 },
    { name: 'Semente de chia', prot: 17, carb: 42, fat: 31, per: 100, unit: 'g', kcal: 486 },
    { name: 'Semente de linhaça', prot: 18, carb: 29, fat: 42, per: 100, unit: 'g', kcal: 534 },
  ],
  vegetais: [
    { name: 'Brócolis (cozido)', prot: 2.4, carb: 4, fat: 0.4, per: 100, unit: 'g', kcal: 35 },
    { name: 'Couve-flor (cozida)', prot: 1.8, carb: 2.3, fat: 0.5, per: 100, unit: 'g', kcal: 23 },
    { name: 'Espinafre (cru)', prot: 2.9, carb: 1.4, fat: 0.4, per: 100, unit: 'g', kcal: 23 },
    { name: 'Alface', prot: 1.4, carb: 2.3, fat: 0.2, per: 100, unit: 'g', kcal: 15 },
    { name: 'Tomate', prot: 1.1, carb: 3.9, fat: 0.2, per: 100, unit: 'g', kcal: 18 },
    { name: 'Cenoura (crua)', prot: 0.9, carb: 10, fat: 0.2, per: 100, unit: 'g', kcal: 41 },
    { name: 'Abóbora (cozida)', prot: 1.2, carb: 6.5, fat: 0.1, per: 100, unit: 'g', kcal: 30 },
  ]
};

/* ----------------------------- Utilities ----------------------------- */
function parseNumber(value) {
  if (!value && value !== 0) return 0;
  const n = parseFloat(String(value).replace(/[^\d.-]/g, ''));
  return isNaN(n) ? 0 : n;
}

// Combined meal nutrition lookup: prioritize custom meals, then LiveUp marmitas
function getMealNutritionByNameCombined(name) {
  // First check custom meals
  const customMeal = state.customMeals.find(m => m.name === name);
  if (customMeal) {
    return { 
      kcal: parseNumber(customMeal.kcal), 
      prot: parseNumber(customMeal.prot), 
      fat: parseNumber(customMeal.fat) 
    };
  }
  // Then check LiveUp marmitas
  const liveUpMeal = livUpMarmitas.find(m => m.name === name);
  if (liveUpMeal) {
    return { 
      kcal: parseNumber(liveUpMeal.kcal), 
      prot: parseNumber(liveUpMeal.prot), 
      fat: parseNumber(liveUpMeal.fat) 
    };
  }
  // Default values if not found
  return { kcal: 0, prot: 0, fat: 0 };
}

// Legacy function for backward compatibility
function getMealNutritionByName(name) {
  return getMealNutritionByNameCombined(name);
}

/* ----------------------------- Persistence: Save / Load ----------------------------- */
async function saveAllToDB() {
  try {
    // users
    for (const id of Object.keys(state.users)) {
      await dbPut(STORE_USERS, state.users[id]);
    }
    // comparisons
    for (const comp of state.comparisons) {
      await dbPut(STORE_COMPARISONS, comp);
    }
    // references
    for (const ref of state.references) {
      await dbPut(STORE_REFERENCES, ref);
    }
    // settings: store lastSave timestamp
    await dbPut(STORE_SETTINGS, { key: 'lastSave', value: new Date().toISOString() });

    // fallback localStorage
    saveLS('ft_users', state.users);
    saveLS('ft_comparisons', state.comparisons);
    saveLS('ft_references', state.references);
  } catch (err) {
    console.error('saveAllToDB error', err);
  }
}

async function loadAllFromDB() {
  let users = {};
  let comparisons = [];
  let references = [];
  try {
    const dbUsers = await dbGetAll(STORE_USERS);
    const dbComparisons = await dbGetAll(STORE_COMPARISONS);
    const dbReferences = await dbGetAll(STORE_REFERENCES);
    if (dbUsers && dbUsers.length) dbUsers.forEach(u => users[u.id] = u);
    if (dbComparisons && dbComparisons.length) comparisons = dbComparisons;
    if (dbReferences && dbReferences.length) references = dbReferences;
  } catch (err) {
    console.warn('DB load failed, fallback to localStorage', err);
  }

  // fallback localStorage if empty
  if (Object.keys(users).length === 0) {
    const lsUsers = loadLS('ft_users');
    if (lsUsers) users = lsUsers;
  }
  if (!comparisons.length) {
    const lsComparisons = loadLS('ft_comparisons');
    if (lsComparisons) comparisons = lsComparisons;
  }
  if (!references.length) {
    const lsReferences = loadLS('ft_references');
    if (lsReferences) references = lsReferences;
  }

  // Legacy migration: ft_custom_programs
  const legacyPrograms = loadLS('ft_custom_programs');
  if (legacyPrograms && typeof legacyPrograms === 'object') {
    Object.keys(legacyPrograms).forEach(uid => {
      if (!users[uid]) return;
      users[uid].customPrograms = users[uid].customPrograms || {};
      // merge but do not overwrite existing keys
      Object.keys(legacyPrograms[uid]).forEach(k => {
        if (!users[uid].customPrograms[k]) users[uid].customPrograms[k] = legacyPrograms[uid][k];
      });
    });
    // do not delete legacy key automatically
  }

  // If no users exist in DB/LS, seed defaults (but do not overwrite if user has data)
  if (Object.keys(users).length === 0) {
    users = initialUsers;
    comparisons = [];
    references = []; // keep empty until user imports seed references to avoid accidental overwrite
    state.users = users;
    state.comparisons = comparisons;
    state.references = references;
    await saveAllToDB();
  } else {
    state.users = users;
    state.comparisons = comparisons;
    state.references = references;
  }
}

/* ----------------------------- Custom Meals Management -----------------------------
   Load and save custom meals from/to IndexedDB settings store and localStorage fallback
-------------------------------------------------------------------------------------------- */
async function loadCustomMeals() {
  try {
    const customMealsData = await dbGet(STORE_SETTINGS, 'customMeals').catch(() => null);
    if (customMealsData && customMealsData.value) {
      state.customMeals = customMealsData.value;
      return;
    }
  } catch (err) {
    console.warn('Failed to load custom meals from IndexedDB', err);
  }
  
  // Fallback to localStorage
  const lsCustomMeals = loadLS('ft_custom_meals');
  if (lsCustomMeals && Array.isArray(lsCustomMeals)) {
    state.customMeals = lsCustomMeals;
  } else {
    state.customMeals = [];
  }
}

async function saveCustomMeals() {
  try {
    await dbPut(STORE_SETTINGS, { key: 'customMeals', value: state.customMeals });
  } catch (err) {
    console.error('Failed to save custom meals to IndexedDB', err);
  }
  
  // Also save to localStorage as fallback
  saveLS('ft_custom_meals', state.customMeals);
}

/* ----------------------------- Soft-delete / Archive workflow -----------------------------
   Instead of permanently deleting, we move to 'archive' store with metadata:
     { id, originStore, originId, type, payload, deletedAt, deletedBy }
   Only with explicit user action "Excluir permanentemente do arquivo" will we remove it from 'archive'.
---------------------------------------------------------------------------------------------- */
async function archiveItem(originStore, originId, type, payload) {
  const archiveId = `arch_${type}_${originId}_${Date.now()}`;
  const item = {
    id: archiveId,
    originStore,
    originId,
    type,
    payload,
    deletedAt: new Date().toISOString(),
    deletedBy: state.activeUser || 'system'
  };
  await dbPut(STORE_ARCHIVE, item);
  return item;
}

async function softDeleteUser(userId) {
  if (!confirm('Tem certeza que deseja mover este perfil para o arquivo (archive)? Isso preservará os dados no archive.')) return;
  const user = state.users[userId];
  if (!user) { alert('Perfil não encontrado'); return; }
  // move to archive
  await archiveItem(STORE_USERS, userId, 'user', user);
  // delete from users store and state
  delete state.users[userId];
  try { await dbDelete(STORE_USERS, userId); } catch (e) {}
  saveLS('ft_users', state.users);
  updateState({ users: state.users });
  alert('✅ Perfil movido para arquivo (archive). Para excluir permanentemente vá na aba Ciência → Gerenciar arquivo.');
}

/* ----------------------------- State helpers ----------------------------- */
function updateState(newState) {
  state = { ...state, ...newState };
  saveAllToDB();
  render();
}

function addOrUpdateUser(user) {
  state.users[user.id] = user;
  updateState({ users: state.users });
}

function removeUserPermanentlyFromArchive(archiveId) {
  // Will delete entry permanently from archive - only after explicit confirmation
  if (!confirm('Excluir permanentemente este item do arquivo? Esta ação NÃO pode ser desfeita.')) return;
  dbDelete(STORE_ARCHIVE, archiveId).then(() => alert('Item excluído permanentemente do archive')).catch(err => alert('Erro ao excluir: ' + err));
}

/* ----------------------------- Handlers (workout / meal / metrics) ----------------------------- */
function handleLogWorkout(exerciseName, sets = '', reps = '', weight = '', category = '') {
  const user = state.users[state.activeUser];
  if (!user) return alert('Nenhum usuário ativo');
  
  const newLog = {
    id: Date.now(),
    date: state.currentWorkoutDay, // Use selected day instead of today
    time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
    exercise: exerciseName,
    category: category || '',
    sets: sets || '-',
    reps: reps || '-',
    weight: weight || '-',
    completed: true
  };
  
  if (!user.workoutHistory) user.workoutHistory = [];
  user.workoutHistory.unshift(newLog);
  addOrUpdateUser(user);
  
  // Show success notification
  const details = sets && reps ? ` (${sets}x${reps}${weight ? ' @ ' + weight + 'kg' : ''})` : '';
  showNotification(`✅ Exercício registrado: ${exerciseName}${details}`, 'success');
  render();
}

function handleEditWorkout(id) {
  const user = state.users[state.activeUser];
  if (!user.workoutHistory) user.workoutHistory = [];
  const log = user.workoutHistory.find(l => l.id === id);
  if (!log) return alert('Registro não encontrado');
  
  // Prompt for new values
  const newSets = prompt(`Editar Séries\nExercício: ${log.exercise}\n\nSéries atuais: ${log.sets}`, log.sets === '-' ? '' : log.sets);
  if (newSets === null) return; // User cancelled
  
  const newReps = prompt(`Editar Repetições\nExercício: ${log.exercise}\n\nRepetições atuais: ${log.reps}`, log.reps === '-' ? '' : log.reps);
  if (newReps === null) return; // User cancelled
  
  const newWeight = prompt(`Editar Carga (kg)\nExercício: ${log.exercise}\n\nCarga atual: ${log.weight}`, log.weight === '-' ? '' : log.weight);
  if (newWeight === null) return; // User cancelled
  
  // Update the workout log
  log.sets = newSets || '-';
  log.reps = newReps || '-';
  log.weight = newWeight || '-';
  
  addOrUpdateUser(user);
  
  // Show success notification
  const details = newSets && newReps ? ` (${newSets}x${newReps}${newWeight ? ' @ ' + newWeight + 'kg' : ''})` : '';
  showNotification(`✅ Treino atualizado: ${log.exercise}${details}`, 'success');
  render();
}

function handleDeleteWorkout(id) {
  if (!confirm('Deseja excluir este registro de treino? Ele será movido para o arquivo (archive) e poderá ser restaurado.')) return;
  const user = state.users[state.activeUser];
  if (!user.workoutHistory) user.workoutHistory = [];
  const log = user.workoutHistory.find(l => l.id === id);
  if (!log) return alert('Registro não encontrado');
  archiveItem('workoutHistory', id, 'workout', log).then(() => {
    user.workoutHistory = user.workoutHistory.filter(l => l.id !== id);
    addOrUpdateUser(user);
    showNotification('✅ Registro de treino excluído e movido para archive', 'success');
    render();
  });
}

function handleLogMeal(mealName) {
  const user = state.users[state.activeUser];
  if (!user) return alert('Nenhum usuário ativo');
  // Use currentDay for meal logging, make meal name safe for storage
  const safeMealName = String(mealName); // Ensure it's a string, handles special characters
  const newLog = { 
    id: Date.now(), 
    date: state.currentDay, // Use selected day instead of today
    time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), 
    meal: safeMealName 
  };
  user.mealHistory.unshift(newLog);
  addOrUpdateUser(user);
  
  // Show success notification
  const nut = getMealNutritionByNameCombined(safeMealName);
  const nutInfo = nut.kcal > 0 ? ` (${nut.kcal} kcal)` : '';
  showNotification(`✅ Refeição registrada: ${safeMealName}${nutInfo}`, 'success');
}

function handleDeleteMeal(id) {
  if (!confirm('Deseja excluir este registro de refeição? Ele será movido para o arquivo (archive) e poderá ser restaurado.')) return;
  const user = state.users[state.activeUser];
  const item = user.mealHistory.find(m => m.id === id);
  if (!item) return alert('Registro não encontrado');
  archiveItem('mealHistory', id, 'meal', item).then(() => {
    user.mealHistory = user.mealHistory.filter(m => m.id !== id);
    addOrUpdateUser(user);
    showNotification('✅ Registro de refeição excluído e movido para archive', 'success');
  });
}

/* ----------------------------- Notification System ----------------------------- */
function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `fixed top-20 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-semibold transform transition-all duration-300 ${
    type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
  }`;
  notification.textContent = message;
  notification.style.opacity = '0';
  notification.style.transform = 'translateY(-20px)';
  
  document.body.appendChild(notification);
  
  // Animate in
  setTimeout(() => {
    notification.style.opacity = '1';
    notification.style.transform = 'translateY(0)';
  }, 10);
  
  // Animate out and remove
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translateY(-20px)';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

/* ----------------------------- Day navigation for meals ----------------------------- */
function setCurrentDay(dateString) {
  state.currentDay = dateString;
  render();
}

function goToPreviousDay() {
  const current = new Date(state.currentDay);
  current.setDate(current.getDate() - 1);
  state.currentDay = current.toISOString().split('T')[0];
  render();
}

function goToNextDay() {
  const current = new Date(state.currentDay);
  current.setDate(current.getDate() + 1);
  state.currentDay = current.toISOString().split('T')[0];
  render();
}

function goToToday() {
  state.currentDay = new Date().toISOString().split('T')[0];
  render();
}

/* ----------------------------- Workout Day Navigation ----------------------------- */
function goToPreviousWorkoutDay() {
  const current = new Date(state.currentWorkoutDay);
  current.setDate(current.getDate() - 1);
  state.currentWorkoutDay = current.toISOString().split('T')[0];
  render();
}

function goToNextWorkoutDay() {
  const current = new Date(state.currentWorkoutDay);
  current.setDate(current.getDate() + 1);
  state.currentWorkoutDay = current.toISOString().split('T')[0];
  render();
}

function goToTodayWorkout() {
  state.currentWorkoutDay = new Date().toISOString().split('T')[0];
  render();
}

/* ----------------------------- Exercise Library ----------------------------- */
const EXERCISE_LIBRARY = [
  // Peito
  { name: 'Supino reto', category: 'Peito', equipment: 'Barra' },
  { name: 'Supino inclinado', category: 'Peito', equipment: 'Barra' },
  { name: 'Supino declinado', category: 'Peito', equipment: 'Barra' },
  { name: 'Crucifixo', category: 'Peito', equipment: 'Halteres' },
  { name: 'Fly (peck deck)', category: 'Peito', equipment: 'Máquina' },
  { name: 'Flexão', category: 'Peito', equipment: 'Peso corporal' },
  
  // Costas
  { name: 'Barra fixa', category: 'Costas', equipment: 'Peso corporal' },
  { name: 'Puxada frontal', category: 'Costas', equipment: 'Máquina' },
  { name: 'Remada curvada', category: 'Costas', equipment: 'Barra' },
  { name: 'Remada unilateral', category: 'Costas', equipment: 'Halter' },
  { name: 'Remada sentado', category: 'Costas', equipment: 'Máquina' },
  { name: 'Levantamento terra', category: 'Costas', equipment: 'Barra' },
  { name: 'Pullover', category: 'Costas', equipment: 'Halter' },
  
  // Ombros
  { name: 'Desenvolvimento militar', category: 'Ombros', equipment: 'Barra' },
  { name: 'Desenvolvimento com halteres', category: 'Ombros', equipment: 'Halteres' },
  { name: 'Elevação lateral', category: 'Ombros', equipment: 'Halteres' },
  { name: 'Elevação frontal', category: 'Ombros', equipment: 'Halteres' },
  { name: 'Remada alta', category: 'Ombros', equipment: 'Barra' },
  { name: 'Crucifixo inverso', category: 'Ombros', equipment: 'Halteres' },
  
  // Bíceps
  { name: 'Rosca direta', category: 'Bíceps', equipment: 'Barra' },
  { name: 'Rosca alternada', category: 'Bíceps', equipment: 'Halteres' },
  { name: 'Rosca martelo', category: 'Bíceps', equipment: 'Halteres' },
  { name: 'Rosca concentrada', category: 'Bíceps', equipment: 'Halter' },
  { name: 'Rosca scott', category: 'Bíceps', equipment: 'Barra W' },
  
  // Tríceps
  { name: 'Tríceps testa', category: 'Tríceps', equipment: 'Barra' },
  { name: 'Tríceps francês', category: 'Tríceps', equipment: 'Halter' },
  { name: 'Tríceps corda', category: 'Tríceps', equipment: 'Polia' },
  { name: 'Tríceps banco', category: 'Tríceps', equipment: 'Peso corporal' },
  { name: 'Mergulho', category: 'Tríceps', equipment: 'Paralelas' },
  
  // Pernas
  { name: 'Agachamento livre', category: 'Pernas', equipment: 'Barra' },
  { name: 'Leg press 45°', category: 'Pernas', equipment: 'Máquina' },
  { name: 'Cadeira extensora', category: 'Pernas', equipment: 'Máquina' },
  { name: 'Cadeira flexora', category: 'Pernas', equipment: 'Máquina' },
  { name: 'Stiff', category: 'Pernas', equipment: 'Barra' },
  { name: 'Avanço (afundo)', category: 'Pernas', equipment: 'Halteres' },
  { name: 'Agachamento sumô', category: 'Pernas', equipment: 'Halter' },
  { name: 'Panturrilha em pé', category: 'Pernas', equipment: 'Máquina' },
  { name: 'Panturrilha sentado', category: 'Pernas', equipment: 'Máquina' },
  
  // Abdômen
  { name: 'Abdominal supra', category: 'Abdômen', equipment: 'Peso corporal' },
  { name: 'Abdominal infra', category: 'Abdômen', equipment: 'Peso corporal' },
  { name: 'Prancha', category: 'Abdômen', equipment: 'Peso corporal' },
  { name: 'Abdominal oblíquo', category: 'Abdômen', equipment: 'Peso corporal' },
  { name: 'Roda abdominal', category: 'Abdômen', equipment: 'Roda' }
];

/* ----------------------------- Custom meal handlers ----------------------------- */
function handleAddCustomMeal(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const name = formData.get('customMealName');
  const kcal = formData.get('customMealKcal');
  const prot = formData.get('customMealProt');
  const fat = formData.get('customMealFat');
  const saveAsReusable = formData.get('saveAsReusable') === 'on';
  
  if (!name || !kcal) {
    alert('Nome e calorias são obrigatórios');
    return;
  }
  
  // Check if already exists
  const exists = state.customMeals.find(m => m.name === name);
  if (exists && !confirm('Já existe uma refeição com este nome. Deseja substituir?')) {
    return;
  }
  
  const customMeal = {
    id: `custom_meal_${Date.now()}`,
    name: name.trim(),
    kcal: parseFloat(kcal) || 0,
    prot: parseFloat(prot) || 0,
    fat: parseFloat(fat) || 0,
    createdAt: new Date().toISOString(),
    createdBy: state.activeUser
  };
  
  if (saveAsReusable) {
    // Remove existing if updating
    state.customMeals = state.customMeals.filter(m => m.name !== name);
    state.customMeals.push(customMeal);
    saveCustomMeals();
  }
  
  // Always log the meal to current day
  handleLogMeal(name.trim());
  
  // Reset form
  e.target.reset();
  
  if (saveAsReusable) {
    showNotification('✅ Refeição personalizada salva e registrada!', 'success');
  }
}

function handleDeleteCustomMeal(mealId) {
  if (!confirm('Deseja excluir esta refeição personalizada permanentemente?')) return;
  state.customMeals = state.customMeals.filter(m => m.id !== mealId);
  saveCustomMeals();
  showNotification('✅ Refeição personalizada excluída', 'success');
  render();
}

/* ----------------------------- Nutrition Calculator Functions ----------------------------- */
function selectFood(category, index) {
  const food = commonFoods[category][index];
  
  // Fill calculator with food data
  document.getElementById('calcFoodName').value = food.name;
  document.getElementById('calcWeight').value = food.per;
  document.getElementById('calcProtPer100').value = (food.prot * 100 / food.per).toFixed(1);
  document.getElementById('calcCarbPer100').value = (food.carb * 100 / food.per).toFixed(1);
  document.getElementById('calcFatPer100').value = (food.fat * 100 / food.per).toFixed(1);
  
  // Scroll to calculator
  document.getElementById('calcFoodName').scrollIntoView({ behavior: 'smooth', block: 'center' });
  
  // Show success notification
  showNotification(`✅ Alimento selecionado: ${food.name}`, 'success');
}

function filterFoods() {
  const searchTerm = document.getElementById('foodSearchInput').value.toLowerCase();
  const foodItems = document.querySelectorAll('.food-item');
  const categories = document.querySelectorAll('.food-category');
  
  foodItems.forEach(item => {
    const foodName = item.getAttribute('data-food-name').toLowerCase();
    if (foodName.includes(searchTerm)) {
      item.style.display = 'block';
    } else {
      item.style.display = 'none';
    }
  });
  
  // Hide categories with no visible items
  categories.forEach(category => {
    const visibleItems = Array.from(category.querySelectorAll('.food-item')).filter(item => item.style.display !== 'none');
    if (visibleItems.length === 0 && searchTerm !== '') {
      category.style.display = 'none';
    } else {
      category.style.display = 'block';
    }
  });
}

function calculateMacros() {
  const foodName = document.getElementById('calcFoodName').value;
  const weight = parseFloat(document.getElementById('calcWeight').value);
  const protPer100 = parseFloat(document.getElementById('calcProtPer100').value) || 0;
  const carbPer100 = parseFloat(document.getElementById('calcCarbPer100').value) || 0;
  const fatPer100 = parseFloat(document.getElementById('calcFatPer100').value) || 0;
  
  if (!weight || weight <= 0) {
    alert('Por favor, insira um peso válido em gramas');
    return;
  }
  
  // Calculate multiplier (weight / 100)
  const multiplier = weight / 100;
  
  // Calculate macros for the given weight
  const proteinGrams = (protPer100 * multiplier).toFixed(1);
  const carbGrams = (carbPer100 * multiplier).toFixed(1);
  const fatGrams = (fatPer100 * multiplier).toFixed(1);
  
  // Calculate calories (protein: 4kcal/g, carbs: 4kcal/g, fat: 9kcal/g)
  const proteinKcal = (proteinGrams * 4).toFixed(1);
  const carbKcal = (carbGrams * 4).toFixed(1);
  const fatKcal = (fatGrams * 9).toFixed(1);
  const totalKcal = (parseFloat(proteinKcal) + parseFloat(carbKcal) + parseFloat(fatKcal)).toFixed(1);
  
  // Update results
  document.getElementById('resultProt').textContent = proteinGrams + 'g';
  document.getElementById('resultProtKcal').textContent = proteinKcal + ' kcal';
  document.getElementById('resultCarb').textContent = carbGrams + 'g';
  document.getElementById('resultCarbKcal').textContent = carbKcal + ' kcal';
  document.getElementById('resultFat').textContent = fatGrams + 'g';
  document.getElementById('resultFatKcal').textContent = fatKcal + ' kcal';
  document.getElementById('resultTotal').textContent = totalKcal + ' kcal';
  
  // Show results
  document.getElementById('calcResults').classList.remove('hidden');
  
  // Show success notification
  showNotification(`✅ Calculado: ${weight}g de ${foodName || 'alimento'} = ${totalKcal} kcal`, 'success');
}

function fillCalculatorExample(name, weight, prot, carb, fat) {
  document.getElementById('calcFoodName').value = name;
  document.getElementById('calcWeight').value = weight;
  document.getElementById('calcProtPer100').value = prot;
  document.getElementById('calcCarbPer100').value = carb;
  document.getElementById('calcFatPer100').value = fat;
  
  // Auto-calculate
  calculateMacros();
  
  // Scroll to calculator
  document.getElementById('calcFoodName').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

/* ----------------------------- Custom workout handler ----------------------------- */
function handleAddCustomWorkout(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const exercise = formData.get('customExercise');
  const sets = formData.get('customSets');
  const reps = formData.get('customReps');
  const weight = formData.get('customWeight');
  
  if (!exercise) {
    alert('Nome do exercício é obrigatório');
    return;
  }
  
  handleLogWorkout(exercise, sets, reps, weight);
  e.target.reset();
}

/* ----------------------------- BMR calculation ----------------------------- */
function calculateBMR(weightKg, heightCm, age, gender) {
  const base = 10 * weightKg + 6.25 * heightCm - 5 * age;
  return Math.round(base + (gender === 'female' ? -161 : 5));
}

/* ----------------------------- Metrics add/delete ----------------------------- */
function handleAddMetrics(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const weight = parseFloat(formData.get('weight'));
  const heightCm = state.users[state.activeUser].height;
  const age = state.users[state.activeUser].age || 30;
  const gender = state.users[state.activeUser].gender || 'male';
  const waterPercent = parseFloat(formData.get('waterPercent')) || 0;
  const muscleSize = parseFloat(formData.get('muscleSize')) || 0;
  const bmr = formData.get('bmr') ? parseFloat(formData.get('bmr')) : calculateBMR(weight, heightCm, age, gender);
  const waterWeight = parseFloat((weight * (waterPercent / 100)).toFixed(2));
  
  const newMetric = {
    id: Date.now().toString(),
    date: formData.get('date'),
    weight: weight,
    bodyFat: parseFloat(formData.get('bodyFat')),
    muscleMass: parseFloat(formData.get('muscleMass')),
    visceralFat: parseFloat(formData.get('visceralFat')) || 0,
    waterPercent: waterPercent,
    waterWeight: waterWeight,
    bmr: bmr,
    muscleSize: muscleSize,
    bmi: parseFloat((weight / Math.pow(heightCm / 100, 2)).toFixed(1)),
    
    // Segmented muscle mass
    muscleMassRightArm: parseFloat(formData.get('muscleMassRightArm')) || 0,
    muscleMassLeftArm: parseFloat(formData.get('muscleMassLeftArm')) || 0,
    muscleMassRightLeg: parseFloat(formData.get('muscleMassRightLeg')) || 0,
    muscleMassLeftLeg: parseFloat(formData.get('muscleMassLeftLeg')) || 0,
    muscleMassTrunk: parseFloat(formData.get('muscleMassTrunk')) || 0,
    
    // Segmented body fat
    bodyFatRightArm: parseFloat(formData.get('bodyFatRightArm')) || 0,
    bodyFatLeftArm: parseFloat(formData.get('bodyFatLeftArm')) || 0,
    bodyFatRightLeg: parseFloat(formData.get('bodyFatRightLeg')) || 0,
    bodyFatLeftLeg: parseFloat(formData.get('bodyFatLeftLeg')) || 0,
    bodyFatTrunk: parseFloat(formData.get('bodyFatTrunk')) || 0,
    
    // Advanced body composition
    boneMass: parseFloat(formData.get('boneMass')) || 0,
    proteinMass: parseFloat(formData.get('proteinMass')) || 0,
    mineralMass: parseFloat(formData.get('mineralMass')) || 0,
    
    // Metabolic rates
    rmr: parseFloat(formData.get('rmr')) || 0,
    tdee: parseFloat(formData.get('tdee')) || 0,
    
    // Bioelectrical impedance
    impedance: parseFloat(formData.get('impedance')) || 0,
    phaseAngle: parseFloat(formData.get('phaseAngle')) || 0,
    reactance: parseFloat(formData.get('reactance')) || 0,
    resistance: parseFloat(formData.get('resistance')) || 0,
    
    // Ages
    metabolicAge: parseInt(formData.get('metabolicAge')) || 0,
    bodyAge: parseInt(formData.get('bodyAge')) || 0,
    
    // Circumferences
    chest: parseFloat(formData.get('chest')) || 0,
    waist: parseFloat(formData.get('waist')) || 0,
    hips: parseFloat(formData.get('hips')) || 0,
    rightArm: parseFloat(formData.get('rightArm')) || 0,
    leftArm: parseFloat(formData.get('leftArm')) || 0,
    rightThigh: parseFloat(formData.get('rightThigh')) || 0,
    leftThigh: parseFloat(formData.get('leftThigh')) || 0,
    rightCalf: parseFloat(formData.get('rightCalf')) || 0,
    leftCalf: parseFloat(formData.get('leftCalf')) || 0,
    neck: parseFloat(formData.get('neck')) || 0,
    shoulders: parseFloat(formData.get('shoulders')) || 0
  };
  
  const user = state.users[state.activeUser];
  user.bodyMetrics.push(newMetric);
  user.bodyMetrics.sort((a, b) => new Date(a.date) - new Date(b.date));
  addOrUpdateUser(user);
  
  showNotification('✅ Medição completa adicionada com sucesso!', 'success');
  
  // redraw chart if on evolução
  if (state.activeTab === 'evolucao') setTimeout(() => renderMuscleEvolutionChart(user.bodyMetrics, user.id), 150);
  e.target.reset();
}

/* When deleting a metric, move it to archive rather than permanently delete */
function handleDeleteMetric(metricId) {
  if (!confirm('Deseja excluir esta medida? Ela será movida para o arquivo (archive) e poderá ser restaurada.')) return;
  const user = state.users[state.activeUser];
  const metric = user.bodyMetrics.find(m => m.id === metricId);
  if (!metric) return alert('Medida não encontrada');
  archiveItem('bodyMetrics', metricId, 'metric', metric).then(() => {
    user.bodyMetrics = user.bodyMetrics.filter(m => m.id !== metricId);
    addOrUpdateUser(user);
    showNotification('✅ Medida excluída e movida para archive', 'success');
  });
}

/* ----------------------------- Profiles handlers ----------------------------- */
function handleAddProfile() {
  const name = prompt('Nome do novo perfil: (ex: João)');
  if (!name) return;
  const gender = prompt('Gênero (male/female):', 'male') || 'male';
  const age = parseInt(prompt('Idade:', '25')) || 25;
  const height = parseInt(prompt('Altura em cm:', '170')) || 170;
  const idBase = name.trim().toLowerCase().replace(/\s+/g, '_');
  const id = `${idBase}_${Date.now()}`;
  const user = {
    id,
    name,
    gender: gender === 'female' ? 'female' : 'male',
    age,
    height,
    workoutHistory: [],
    mealHistory: [],
    bodyMetrics: [{
      id: 'm_' + Date.now(),
      date: new Date().toISOString().split('T')[0],
      weight: 0,
      bodyFat: 0,
      muscleMass: 0,
      visceralFat: 0,
      waterPercent: 0,
      waterWeight: 0,
      bmr: calculateBMR(0, height, age, gender),
      muscleSize: 0,
      bmi: 0
    }],
    goals: { weight: 0, bodyFat: 0, muscleMass: 0 },
    customPrograms: {}
  };
  addOrUpdateUser(user);
  alert('✅ Perfil criado: ' + name);
}

/* Soft-delete profile (moves to archive), never removes without explicit user's permanent deletion action */
function handleDeleteProfile(userId) {
  if (!confirm('Deseja mover este perfil para archive (preservará TODOS os registros)?')) return;
  const user = state.users[userId];
  if (!user) return alert('Perfil não encontrado');
  archiveItem(STORE_USERS, userId, 'user', user).then(() => {
    delete state.users[userId];
    try { dbDelete(STORE_USERS, userId).catch(()=>{}); } catch(e){}
    saveLS('ft_users', state.users);
    updateState({ users: state.users });
    alert('✅ Perfil movido para archive. Para excluir permanentemente vá no archive e remova manualmente.');
  });
}

/* ----------------------------- Templates application & custom programs ----------------------------- */
function applyTemplateToUser(templateId, userId) {
  const tmpl = templates[templateId];
  if (!tmpl) return alert('Template não encontrado');
  const user = state.users[userId];
  if (!user) return alert('Usuário não encontrado');
  user.customPrograms = user.customPrograms || {};
  user.customPrograms[tmpl.id] = JSON.parse(JSON.stringify(tmpl)); // deep copy
  addOrUpdateUser(user);
  alert(`✅ Template "${tmpl.name}" aplicado e salvo no perfil ${user.name}.`);
}

function removeUserProgram(userId, programId) {
  const user = state.users[userId];
  if (!user || !user.customPrograms) return;
  if (!confirm('Remover este programa do perfil? (não exclui do archive)')) return;
  delete user.customPrograms[programId];
  addOrUpdateUser(user);
  alert('✅ Programa removido do perfil.');
}

/* ----------------------------- References import / export / clear ----------------------------- */
function importScientificStudiesSeed() {
  const idsExisting = new Set(state.references.map(r => r.id));
  let added = 0;
  scientificStudiesSeed.forEach(ref => {
    if (!idsExisting.has(ref.id)) {
      state.references.push(ref);
      added++;
    }
  });
  if (added > 0) {
    saveAllToDB();
    alert(`✅ Importados ${added} estudos (2020 → 2025-11).`);
  } else {
    alert('ℹ️ Estudos já importados anteriormente.');
  }
  render();
}

function exportReferencesJSON() {
  const dataStr = JSON.stringify(state.references, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `studies_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function clearReferences() {
  if (!confirm('Deseja mover todas as referências para archive? Elas ficarão preservadas em archive.')) return;
  // move each to archive
  Promise.all(state.references.map(r => archiveItem(STORE_REFERENCES, r.id, 'reference', r))).then(() => {
    state.references = [];
    saveAllToDB();
    alert('✅ Referências movidas para archive.local');
    render();
  }).catch(err => alert('Erro ao mover referências para archive: ' + err));
}

/* ----------------------------- Export muscle evolution CSV ----------------------------- */
function exportMuscleEvolutionCSV(userId) {
  const user = state.users[userId];
  if (!user) return alert('Usuário não encontrado');
  const rows = [['date','weight','bodyFat','muscleMass','muscleSize','waterWeight','bmr']];
  (user.bodyMetrics || []).forEach(m => {
    rows.push([m.date, m.weight, m.bodyFat, m.muscleMass, m.muscleSize, m.waterWeight, m.bmr]);
  });
  const csv = rows.map(r => r.map(cell => (typeof cell === 'string' && cell.includes(',')) ? `"${cell}"` : cell).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${userId}_muscle_evolution_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

/* ----------------------------- References helper for UI ----------------------------- */
function getReferencesByTags(tags) {
  if (!tags || !tags.length) return [];
  const refs = state.references || [];
  return refs.filter(r => r.tags && r.tags.some(t => tags.includes(t)));
}
function getTopReferencesByTags(tags, limit = 3) {
  const matched = getReferencesByTags(tags);
  matched.sort((a, b) => (b.year || 0) - (a.year || 0));
  return matched.slice(0, limit);
}
function renderReferenceLinksHTML(refs) {
  if (!refs || !refs.length) return '';
  return refs.map(r => `<a href="${r.link}" target="_blank" class="text-blue-300 underline">${r.authors} ${r.year}</a>`).join(' • ');
}
function buildReferenceNotesForWorkout(workoutName) {
  const name = (workoutName || '').toLowerCase();
  let tags = ['training'];
  if (name.includes('hip') || name.includes('glúteo') || name.includes('thrust')) tags.push('hypertrophy');
  if (name.includes('agach') || name.includes('leg')) tags.push('volume');
  if (name.includes('supino') || name.includes('press')) tags.push('strength');
  const refs = getTopReferencesByTags(tags);
  if (!refs.length) return '';
  return `Base científica: ${refs.slice(0,3).map(r => `${r.authors} ${r.year}`).join(' • ')}. ` + renderReferenceLinksHTML(refs);
}
function buildReferenceNotesForNutrition() {
  const refs = getTopReferencesByTags(['nutrition','protein','creatine','diet']);
  if (!refs.length) return '';
  return `Referências: ${refs.slice(0,3).map(r => `${r.authors} ${r.year}`).join(' • ')}. ` + renderReferenceLinksHTML(refs);
}

/* ----------------------------- Event Delegation for Meal Buttons -----------------------------
   This function attaches event listeners to meal registration buttons using event delegation.
   This approach is more robust than inline onclick handlers and handles special characters properly.
------------------------------------------------------------------------------------------------ */
function attachMealButtons() {
  const mealButtons = document.querySelectorAll('.meal-register-btn');
  mealButtons.forEach(btn => {
    // Remove old listener if exists by replacing with a new one
    btn.onclick = function(e) {
      e.preventDefault();
      const mealName = this.getAttribute('data-meal-name');
      if (mealName) {
        handleLogMeal(mealName);
      }
    };
  });
}

function attachMealDeleteButtons() {
  const deleteButtons = document.querySelectorAll('.meal-delete-btn');
  deleteButtons.forEach(btn => {
    btn.onclick = function(e) {
      e.preventDefault();
      const mealId = parseInt(this.getAttribute('data-meal-id'));
      if (mealId) {
        handleDeleteMeal(mealId);
      }
    };
  });
}

function attachWorkoutButtons() {
  const workoutButtons = document.querySelectorAll('.workout-register-btn');
  workoutButtons.forEach(btn => {
    btn.onclick = function(e) {
      e.preventDefault();
      const exercise = this.getAttribute('data-exercise');
      const category = this.getAttribute('data-category');
      
      // Prompt for sets, reps, and weight
      const sets = prompt(`Registrar: ${exercise}\n\nQuantas séries você fez?`, '3');
      if (sets === null) return; // User cancelled
      
      const reps = prompt(`Registrar: ${exercise}\n\nQuantas repetições por série?`, '12');
      if (reps === null) return; // User cancelled
      
      const weight = prompt(`Registrar: ${exercise}\n\nQual carga você usou? (kg)\nDeixe em branco se não aplicável`, '');
      if (weight === null) return; // User cancelled
      
      if (exercise) {
        handleLogWorkout(exercise, sets, reps, weight, category);
      }
    };
  });
}

function attachWorkoutDeleteButtons() {
  const deleteButtons = document.querySelectorAll('.workout-delete-btn');
  deleteButtons.forEach(btn => {
    btn.onclick = function(e) {
      e.preventDefault();
      const workoutId = parseInt(this.getAttribute('data-workout-id'));
      if (workoutId) {
        handleDeleteWorkout(workoutId);
      }
    };
  });
}

/* ----------------------------- RENDER (UI) -----------------------------
   The UI is intentionally verbose and explanatory to ensure clarity for you.
   Buttons that perform deletions will refer to archive workflow; nothing is removed
   permanently without explicit permanent-delete action in archive manager.
----------------------------------------------------------------------------- */

function render() {
  const app = document.getElementById('app');
  const currentUser = state.users[state.activeUser] || Object.values(state.users)[0];
  if (!currentUser) {
    app.innerHTML = '<div class="p-8 text-white">Carregando...</div>';
    return;
  }

  const workoutHistory = currentUser.workoutHistory || [];
  const mealHistory = currentUser.mealHistory || [];
  const bodyMetrics = currentUser.bodyMetrics || [];
  const latestMetrics = bodyMetrics[bodyMetrics.length - 1] || { weight: 0, bodyFat: 0, muscleMass: 0, bmi: 0, bmr: 0, waterPercent: 0, waterWeight: 0, muscleSize: 0 };

  app.innerHTML = `
    <header class="bg-black/40 backdrop-blur-lg border-b border-purple-500/30 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">💪 Fitness Tracker Pro — Full</h1>
          <p class="text-purple-300 text-sm mt-1">Persistência local (IndexedDB) — Archive-enabled — Never delete without explicit action</p>
        </div>
        <div class="flex gap-2 items-center">
          ${Object.keys(state.users).map(id => `
            <div class="flex items-center gap-2">
              <button onclick="state.activeUser='${id}'; render();" class="px-4 py-2 rounded-lg font-semibold ${state.activeUser === id ? (state.users[id].gender === 'female' ? 'bg-pink-500 text-white' : 'bg-blue-500 text-white') : 'bg-slate-700 text-slate-300'}">
                ${state.users[id].gender === 'female' ? '👩' : '👨'} ${state.users[id].name}
              </button>
              <button title="Mover perfil para archive" onclick="handleDeleteProfile('${id}')" class="text-red-400 hover:text-red-300 px-2">🗄️</button>
            </div>
          `).join('')}
          <button onclick="handleAddProfile()" class="px-4 py-2 rounded-lg font-semibold bg-green-600 hover:bg-green-500">➕ Novo Perfil</button>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="flex flex-wrap gap-3 mb-6">
        ${['dashboard','treino','nutricao','alimentacao','evolucao','comparacao','ciencia'].map(tab => `
          <button onclick="state.activeTab='${tab}'; render();" class="px-6 py-3 rounded-xl font-semibold ${state.activeTab === tab ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'bg-slate-800/50 text-slate-300'}">
            ${tab === 'dashboard' ? '📊 Dashboard' : tab === 'treino' ? '🏋️ Treinos' : tab === 'nutricao' ? '🍎 Nutrição' : tab === 'alimentacao' ? '🍲 Alimentação' : tab === 'evolucao' ? '📈 Evolução' : tab === 'comparacao' ? '⚖️ Comparação' : '🔬 Ciência'}
          </button>
        `).join('')}
      </div>

      <main>
        ${state.activeTab === 'dashboard' ? renderDashboard(currentUser, latestMetrics) : ''}
        ${state.activeTab === 'treino' ? renderTreino(currentUser) : ''}
        ${state.activeTab === 'nutricao' ? renderNutricao(currentUser) : ''}
        ${state.activeTab === 'alimentacao' ? renderAlimentacao() : ''}
        ${state.activeTab === 'evolucao' ? renderEvolucao(bodyMetrics, currentUser) : ''}
        ${state.activeTab === 'comparacao' ? renderComparacao() : ''}
        ${state.activeTab === 'ciencia' ? renderCiencia() : ''}
      </main>
    </div>

    <footer class="bg-black/60 backdrop-blur-lg border-t border-purple-500/30 py-8 mt-12">
      <div class="max-w-7xl mx-auto px-4 text-center">
        <p class="text-slate-400">Versão completa: todas as marmitas restauradas; archive/soft-delete implementado; IndexedDB como DB local.</p>
      </div>
    </footer>
  `;

  // after injecting DOM, hook forms / draw chart if needed
  if (state.activeTab === 'evolucao') {
    renderMuscleEvolutionChart(bodyMetrics, currentUser.id);
  }

  // attach metric form listener if exists
  const metricsForm = document.getElementById('metricsForm');
  if (metricsForm) metricsForm.addEventListener('submit', handleAddMetrics);
  
  // attach custom meal form listener if in alimentacao tab
  if (state.activeTab === 'alimentacao') {
    const customMealForm = document.getElementById('customMealForm');
    if (customMealForm) customMealForm.addEventListener('submit', handleAddCustomMeal);
    
    // attach meal buttons using event delegation
    attachMealButtons();
    
    // attach delete buttons using event delegation
    attachMealDeleteButtons();
  }
  
  // attach workout form and buttons if in treino tab
  if (state.activeTab === 'treino') {
    const customWorkoutForm = document.getElementById('customWorkoutForm');
    if (customWorkoutForm) customWorkoutForm.addEventListener('submit', handleAddCustomWorkout);
    
    // attach workout buttons using event delegation
    attachWorkoutButtons();
    
    // attach workout delete buttons using event delegation
    attachWorkoutDeleteButtons();
  }
}

/* ----------------------------- SMALL RENDER COMPONENTS ----------------------------- */

function renderDashboard(user, latest) {
  const notes = buildReferenceNotesForNutrition();
  return `
    <div class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div class="md:col-span-2 bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl p-6 text-white shadow-xl">
          <p class="text-blue-200 text-sm mb-2">PESO ATUAL</p>
          <p class="text-4xl font-bold">${latest.weight} kg</p>
          <p class="text-blue-200 text-xs mt-2">Meta: ${user.goals.weight} kg</p>
        </div>
        <div class="bg-gradient-to-br from-red-600 to-red-800 rounded-2xl p-6">
          <p class="text-red-200 text-sm mb-2">GORDURA</p>
          <p class="text-4xl font-bold">${latest.bodyFat}%</p>
        </div>
        <div class="bg-gradient-to-br from-green-600 to-green-800 rounded-2xl p-6">
          <p class="text-green-200 text-sm mb-2">MASSA MUSCULAR</p>
          <p class="text-4xl font-bold">${latest.muscleMass} kg</p>
        </div>
        <div class="bg-gradient-to-br from-yellow-600 to-amber-700 rounded-2xl p-6">
          <p class="text-yellow-200 text-sm mb-2">METABOLISMO BASAL</p>
          <p class="text-2xl font-bold">${latest.bmr || '-' } kcal</p>
        </div>
        <div class="bg-gradient-to-br from-cyan-600 to-sky-700 rounded-2xl p-6">
          <p class="text-cyan-200 text-sm mb-2">ÁGUA</p>
          <p class="text-2xl font-bold">${latest.waterWeight || 0} kg (${latest.waterPercent || 0}%)</p>
        </div>
      </div>

      <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700">
        <h3 class="text-2xl font-bold mb-3">Notas científicas</h3>
        <p class="text-slate-300 text-sm">${notes || 'Importe referências na aba CIÊNCIA para ver notas científicas aplicadas.'}</p>
      </div>
    </div>
  `;
}

function renderTreino(user) {
  if (!user.workoutHistory) user.workoutHistory = [];
  
  // Filter workouts for the selected day
  const selectedDayWorkouts = user.workoutHistory.filter(w => w.date === state.currentWorkoutDay);
  
  // Format date for display
  const displayDate = new Date(state.currentWorkoutDay + 'T00:00:00');
  const isToday = state.currentWorkoutDay === new Date().toISOString().split('T')[0];
  const dateLabel = isToday ? 'Hoje' : displayDate.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'short' });
  
  // Group exercises by category
  const categorizedExercises = {};
  EXERCISE_LIBRARY.forEach(ex => {
    if (!categorizedExercises[ex.category]) categorizedExercises[ex.category] = [];
    categorizedExercises[ex.category].push(ex);
  });
  
  return `
    <!-- Day Navigation -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <div class="flex justify-between items-center">
        <button onclick="goToPreviousWorkoutDay()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded">← Dia Anterior</button>
        <div class="text-center">
          <p class="text-lg font-bold">${dateLabel}</p>
          <p class="text-sm text-slate-300">${state.currentWorkoutDay}</p>
        </div>
        <button onclick="goToNextWorkoutDay()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded">Próximo Dia →</button>
      </div>
      ${!isToday ? `<div class="mt-2 text-center"><button onclick="goToTodayWorkout()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Ir para Hoje</button></div>` : ''}
    </div>

    <!-- Custom Workout Form -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold text-xl mb-3">➕ Adicionar Exercício Personalizado</h3>
      <form id="customWorkoutForm" class="space-y-3">
        <div class="grid md:grid-cols-4 gap-3">
          <input type="text" name="customExercise" placeholder="Nome do exercício" required class="px-3 py-2 rounded bg-slate-700 text-white" />
          <input type="text" name="customSets" placeholder="Séries (ex: 3)" class="px-3 py-2 rounded bg-slate-700 text-white" />
          <input type="text" name="customReps" placeholder="Repetições (ex: 12)" class="px-3 py-2 rounded bg-slate-700 text-white" />
          <input type="text" name="customWeight" placeholder="Carga (kg)" class="px-3 py-2 rounded bg-slate-700 text-white" />
        </div>
        <button type="submit" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded font-semibold">Adicionar Exercício</button>
      </form>
      <p class="text-slate-300 text-sm mt-2">O exercício será registrado para ${dateLabel}.</p>
    </div>

    <!-- Exercise Library by Category -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold text-xl mb-4">💪 Biblioteca de Exercícios</h3>
      <div class="grid md:grid-cols-2 gap-4">
        ${Object.keys(categorizedExercises).map(category => `
          <div class="bg-slate-700 p-3 rounded">
            <h4 class="font-semibold text-lg mb-2 text-purple-300">${category}</h4>
            <div class="space-y-2">
              ${categorizedExercises[category].map(ex => `
                <div class="flex justify-between items-center bg-slate-800 p-2 rounded">
                  <div>
                    <p class="font-medium">${ex.name}</p>
                    <p class="text-xs text-slate-400">${ex.equipment}</p>
                  </div>
                  <button data-exercise="${ex.name}" data-category="${category}" class="workout-register-btn bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Registrar</button>
                </div>
              `).join('')}
            </div>
          </div>
        `).join('')}
      </div>
    </div>

    <!-- Workout Templates -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold text-xl mb-3">📋 Templates de Treino</h3>
      <div class="grid md:grid-cols-3 gap-3">
        ${Object.values(templates).map(t => `
          <div class="bg-slate-700 p-3 rounded">
            <p class="font-bold text-lg">${t.name}</p>
            <p class="text-slate-300 text-sm mb-2">${t.description}</p>
            <button onclick="applyTemplateToUser('${t.id}','${user.id}')" class="bg-green-600 hover:bg-green-500 px-3 py-1 rounded text-sm w-full">Aplicar Template</button>
            <details class="mt-2">
              <summary class="text-sm text-blue-300 cursor-pointer">Ver exercícios</summary>
              <div class="mt-2 text-xs text-slate-300">
                ${Object.keys(t.sessions).map(k=>`<strong>${k} — ${t.sessions[k].name}</strong><br/>${t.sessions[k].exercises.map(e=>`• ${e.name} ${e.sets?(' — ' + e.sets + ' x ' + e.reps):''}`).join('<br/>')}<br/><br/>`).join('')}
              </div>
            </details>
          </div>
        `).join('')}
      </div>
    </div>

    <!-- Workout History for Selected Day -->
    <div class="bg-slate-800 p-4 rounded">
      <h3 class="font-bold text-xl mb-3">📋 Histórico de ${dateLabel}</h3>
      ${selectedDayWorkouts.length === 0 ? 
        `<p class="text-slate-400">Nenhum treino registrado neste dia.</p>` :
        `<div class="space-y-2">
          ${selectedDayWorkouts.map(log => `
            <div class="flex justify-between items-center bg-slate-700 p-3 rounded">
              <div class="flex-1">
                <p class="font-semibold">${log.exercise || log.workout}</p>
                <p class="text-slate-300 text-xs">${log.category ? `${log.category} • ` : ''}${log.time}${log.sets && log.sets !== '-' ? ` • ${log.sets}x${log.reps}` : ''}${log.weight && log.weight !== '-' ? ` • ${log.weight}kg` : ''}</p>
              </div>
              <div class="flex gap-2">
                <button onclick="handleEditWorkout(${log.id})" class="text-blue-400 hover:text-blue-300" title="Editar séries/reps/carga">✏️</button>
                <button data-workout-id="${log.id}" class="workout-delete-btn text-red-400 hover:text-red-300" title="Excluir registro">🗑️</button>
              </div>
            </div>
          `).join('')}
        </div>`
      }
    </div>
  `;
}

/* ----------------------------- Nutrition Database with Scientific Basis -----------------------------
   Daily recommended amounts for healthy muscle gain and body composition based on:
   - Phillips SM. et al. 2022 (Protein requirements 1.6-2.2 g/kg/d)
   - Schoenfeld BJ. 2023 (Protein timing and distribution)
   - Wang Z. et al. 2024 (Creatine supplementation)
   - Position of the Academy of Nutrition and Dietetics (protein and carbs for athletes)
   
   Recommendations are tailored to:
   - Basal Metabolic Rate (BMR) 
   - Total Daily Energy Expenditure (TDEE)
   - Body composition goals (muscle gain, fat loss, or maintenance)
   - Gender-specific needs
---------------------------------------------------------------------------------------------------- */

function calculateNutritionRecommendations(user) {
  const latestMetrics = user.bodyMetrics && user.bodyMetrics.length > 0 
    ? user.bodyMetrics[user.bodyMetrics.length - 1] 
    : { weight: 70, bmr: 1600, tdee: 2200 };
  
  const weight = latestMetrics.weight || 70;
  const bmr = latestMetrics.bmr || calculateBMR(weight, user.height, user.age, user.gender);
  const tdee = latestMetrics.tdee || (bmr * 1.55); // Moderate activity level
  const goals = user.goals || { weight: weight + 5, muscleMass: (latestMetrics.muscleMass || 25) + 3 };
  
  // Determine if bulking, cutting, or maintaining
  const isGaining = goals.weight > weight;
  const calorieAdjustment = isGaining ? (user.gender === 'male' ? 400 : 300) : -300;
  const targetCalories = Math.round(tdee + calorieAdjustment);
  
  // Protein: 1.8-2.2 g/kg for muscle gain (Phillips 2022)
  const proteinGramsPerKg = isGaining ? 2.0 : 1.8;
  const proteinGrams = Math.round(weight * proteinGramsPerKg);
  const proteinCalories = proteinGrams * 4;
  
  // Fat: 0.8-1.0 g/kg for hormonal health
  const fatGramsPerKg = 0.9;
  const fatGrams = Math.round(weight * fatGramsPerKg);
  const fatCalories = fatGrams * 9;
  
  // Carbs: remaining calories
  const carbCalories = targetCalories - proteinCalories - fatCalories;
  const carbGrams = Math.round(carbCalories / 4);
  
  // Food recommendations based on macros
  // Protein sources (all values per 100g unless specified)
  const foods = {
    // Protein sources
    chicken: {
      name: 'Frango (peito)',
      portion: Math.round(proteinGrams * 0.4 / 0.31), // 40% of protein from chicken (31g protein per 100g)
      unit: 'g',
      macro: 'Proteína',
      perDay: 'daily',
      protein: 31,
      carbs: 0,
      fat: 3.6,
      kcal: 165,
      note: 'Fonte magra de proteína de alta qualidade'
    },
    eggs: {
      name: 'Ovos',
      portion: Math.round(proteinGrams * 0.25 / 6.3), // 25% of protein from eggs (6.3g per egg)
      unit: 'unidades',
      macro: 'Proteína',
      perDay: 'daily',
      protein: 6.3,
      carbs: 0.6,
      fat: 5,
      kcal: 72,
      note: 'Proteína completa com todos aminoácidos essenciais'
    },
    whey: {
      name: 'Whey Protein',
      portion: Math.round(proteinGrams * 0.25 / 25), // 25% of protein from whey (25g per scoop)
      unit: 'scoop (30g)',
      macro: 'Proteína',
      perDay: 'daily',
      protein: 25,
      carbs: 3,
      fat: 1.5,
      kcal: 120,
      note: 'Suplemento pós-treino para síntese proteica rápida'
    },
    
    // Carb sources
    bread: {
      name: 'Pão integral',
      portion: Math.round(carbGrams * 0.15 / 49), // 15% of carbs from bread (49g carbs per 100g)
      unit: 'fatias (25g cada)',
      macro: 'Carboidrato',
      perDay: 'daily',
      protein: 9,
      carbs: 49,
      fat: 3.5,
      kcal: 265,
      note: 'Fonte de carboidratos complexos e fibras'
    },
    rice: {
      name: 'Arroz integral',
      portion: Math.round(carbGrams * 0.35 / 23), // 35% of carbs from rice (23g per 100g cooked)
      unit: 'g (cozido)',
      macro: 'Carboidrato',
      perDay: 'daily',
      protein: 2.6,
      carbs: 23,
      fat: 0.9,
      kcal: 111,
      note: 'Energia sustentada para treinos'
    },
    sweetPotato: {
      name: 'Batata doce',
      portion: Math.round(carbGrams * 0.25 / 20), // 25% of carbs from sweet potato (20g per 100g)
      unit: 'g',
      macro: 'Carboidrato',
      perDay: 'daily',
      protein: 1.6,
      carbs: 20,
      fat: 0.1,
      kcal: 86,
      note: 'Carboidrato de baixo índice glicêmico'
    },
    
    // Fat sources
    peanutButter: {
      name: 'Pasta de amendoim',
      portion: Math.round(fatGrams * 0.3 / 50 * 100), // 30% of fat from PB (50g fat per 100g)
      unit: 'g',
      macro: 'Gordura',
      perDay: 'daily',
      protein: 25,
      carbs: 20,
      fat: 50,
      kcal: 588,
      note: 'Gorduras saudáveis e proteína adicional'
    },
    avocado: {
      name: 'Abacate',
      portion: Math.round(fatGrams * 0.2 / 15), // 20% of fat from avocado (15g per 100g)
      unit: 'g',
      macro: 'Gordura',
      perDay: 'daily',
      protein: 2,
      carbs: 9,
      fat: 15,
      kcal: 160,
      note: 'Gorduras monoinsaturadas e fibras'
    },
    
    // Supplements
    creatine: {
      name: 'Creatina',
      portion: 5,
      unit: 'g',
      macro: 'Suplemento',
      perDay: 'daily',
      protein: 0,
      carbs: 0,
      fat: 0,
      kcal: 0,
      note: 'Melhora força e ganho de massa muscular (Wang 2024)'
    }
  };
  
  return {
    targetCalories,
    bmr,
    tdee,
    proteinGrams,
    carbGrams,
    fatGrams,
    foods,
    isGaining
  };
}

function renderNutritionRecommendations(user) {
  const nutrition = calculateNutritionRecommendations(user);
  const foods = nutrition.foods;
  
  return `
    <div class="bg-gradient-to-r from-green-700 to-emerald-800 p-6 rounded-xl mb-6">
      <h4 class="font-bold text-xl mb-4">🎯 Metas Nutricionais Personalizadas</h4>
      <div class="grid md:grid-cols-4 gap-4">
        <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
          <p class="text-sm text-green-100 mb-1">TMB (Basal)</p>
          <p class="text-3xl font-bold">${nutrition.bmr}</p>
          <p class="text-xs text-green-200">kcal/dia</p>
        </div>
        <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
          <p class="text-sm text-green-100 mb-1">TDEE (Total)</p>
          <p class="text-3xl font-bold">${Math.round(nutrition.tdee)}</p>
          <p class="text-xs text-green-200">kcal/dia</p>
        </div>
        <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
          <p class="text-sm text-green-100 mb-1">Meta Calórica</p>
          <p class="text-3xl font-bold">${nutrition.targetCalories}</p>
          <p class="text-xs text-green-200">${nutrition.isGaining ? 'Ganho' : 'Perda'}</p>
        </div>
        <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
          <p class="text-sm text-green-100 mb-1">Macros</p>
          <p class="text-lg font-bold">${nutrition.proteinGrams}P</p>
          <p class="text-lg font-bold">${nutrition.carbGrams}C • ${nutrition.fatGrams}G</p>
        </div>
      </div>
    </div>

    <div class="bg-slate-800 p-6 rounded-xl mb-6">
      <h4 class="font-bold text-xl mb-4">🍗 Base de Alimentação Diária Recomendada</h4>
      <p class="text-slate-300 text-sm mb-4">Quantidades calculadas com base no seu metabolismo basal (${nutrition.bmr} kcal), TDEE (${Math.round(nutrition.tdee)} kcal) e metas de composição corporal. Baseado em estudos científicos (Phillips 2022, Schoenfeld 2023, Wang 2024).</p>
      
      <!-- Protein Sources -->
      <div class="mb-6">
        <h5 class="font-semibold text-lg text-blue-300 mb-3">💪 Fontes de Proteína (Meta: ${nutrition.proteinGrams}g/dia)</h5>
        <div class="grid md:grid-cols-3 gap-4">
          ${[foods.chicken, foods.eggs, foods.whey].map(food => `
            <div class="bg-slate-700 p-4 rounded-lg">
              <div class="flex justify-between items-start mb-2">
                <p class="font-bold text-lg">${food.name}</p>
                <span class="bg-blue-600 px-2 py-1 rounded text-xs">${food.macro}</span>
              </div>
              <p class="text-3xl font-bold text-blue-400 mb-2">${food.portion}</p>
              <p class="text-sm text-slate-300 mb-3">${food.unit} por dia</p>
              <div class="text-xs text-slate-400 space-y-1">
                ${food.protein ? `<p>Proteína: ~${Math.round(food.portion * food.protein / (food.unit === 'unidades' ? 1 : food.unit === 'scoop (30g)' ? 1 : 100))}g</p>` : ''}
                ${food.kcal ? `<p>Calorias: ~${Math.round(food.portion * food.kcal / (food.unit === 'unidades' ? 1 : food.unit === 'scoop (30g)' ? 1 : 100))}kcal</p>` : ''}
              </div>
              <p class="text-xs text-green-300 mt-3">${food.note}</p>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Carb Sources -->
      <div class="mb-6">
        <h5 class="font-semibold text-lg text-orange-300 mb-3">🌾 Fontes de Carboidratos (Meta: ${nutrition.carbGrams}g/dia)</h5>
        <div class="grid md:grid-cols-3 gap-4">
          ${[foods.bread, foods.rice, foods.sweetPotato].map(food => `
            <div class="bg-slate-700 p-4 rounded-lg">
              <div class="flex justify-between items-start mb-2">
                <p class="font-bold text-lg">${food.name}</p>
                <span class="bg-orange-600 px-2 py-1 rounded text-xs">${food.macro}</span>
              </div>
              <p class="text-3xl font-bold text-orange-400 mb-2">${food.portion}</p>
              <p class="text-sm text-slate-300 mb-3">${food.unit} por dia</p>
              <div class="text-xs text-slate-400 space-y-1">
                ${food.carbs ? `<p>Carboidratos: ~${Math.round(food.portion * food.carbs / 100)}g</p>` : ''}
                ${food.kcal ? `<p>Calorias: ~${Math.round(food.portion * food.kcal / 100)}kcal</p>` : ''}
              </div>
              <p class="text-xs text-green-300 mt-3">${food.note}</p>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Fat Sources -->
      <div class="mb-6">
        <h5 class="font-semibold text-lg text-yellow-300 mb-3">🥑 Fontes de Gorduras Saudáveis (Meta: ${nutrition.fatGrams}g/dia)</h5>
        <div class="grid md:grid-cols-2 gap-4">
          ${[foods.peanutButter, foods.avocado].map(food => `
            <div class="bg-slate-700 p-4 rounded-lg">
              <div class="flex justify-between items-start mb-2">
                <p class="font-bold text-lg">${food.name}</p>
                <span class="bg-yellow-600 px-2 py-1 rounded text-xs">${food.macro}</span>
              </div>
              <p class="text-3xl font-bold text-yellow-400 mb-2">${food.portion}</p>
              <p class="text-sm text-slate-300 mb-3">${food.unit} por dia</p>
              <div class="text-xs text-slate-400 space-y-1">
                ${food.fat ? `<p>Gorduras: ~${Math.round(food.portion * food.fat / 100)}g</p>` : ''}
                ${food.kcal ? `<p>Calorias: ~${Math.round(food.portion * food.kcal / 100)}kcal</p>` : ''}
              </div>
              <p class="text-xs text-green-300 mt-3">${food.note}</p>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Supplements -->
      <div class="mb-6">
        <h5 class="font-semibold text-lg text-purple-300 mb-3">💊 Suplementação Baseada em Evidências</h5>
        <div class="grid md:grid-cols-2 gap-4">
          ${[foods.creatine, foods.whey].map(food => `
            <div class="bg-slate-700 p-4 rounded-lg border-2 border-purple-500">
              <div class="flex justify-between items-start mb-2">
                <p class="font-bold text-lg">${food.name}</p>
                <span class="bg-purple-600 px-2 py-1 rounded text-xs">${food.macro}</span>
              </div>
              <p class="text-3xl font-bold text-purple-400 mb-2">${food.portion}</p>
              <p class="text-sm text-slate-300 mb-3">${food.unit} por dia</p>
              <p class="text-xs text-green-300 mt-3">${food.note}</p>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Scientific Notes -->
      <div class="bg-gradient-to-r from-cyan-900 to-blue-900 p-4 rounded-lg">
        <h5 class="font-semibold text-lg mb-2">🔬 Base Científica</h5>
        <div class="text-sm text-slate-300 space-y-2">
          <p><strong>Proteína:</strong> Recomendação de 1.8-2.2 g/kg/dia para otimizar síntese proteica e hipertrofia muscular (Phillips et al., 2022).</p>
          <p><strong>Timing:</strong> Distribuir proteína em 4-6 refeições ao longo do dia, com 20-40g por refeição (Schoenfeld et al., 2023).</p>
          <p><strong>Creatina:</strong> 5g/dia melhora força e ganho de massa muscular em adultos que praticam treinamento resistido (Wang et al., 2024).</p>
          <p><strong>Carboidratos:</strong> Essenciais para reposição de glicogênio e performance em treinos intensos. Ajustar conforme nível de atividade.</p>
          <p><strong>Gorduras:</strong> 0.8-1.0 g/kg/dia para suporte hormonal e absorção de vitaminas lipossolúveis.</p>
        </div>
      </div>
    </div>
  `;
}

function renderNutricao(user) {
  const notes = buildReferenceNotesForNutrition();
  return `
    ${renderNutritionRecommendations(user)}
    
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold">Plano nutricional (resumo)</h3>
      <p class="text-slate-300 text-sm">${notes || 'Importe referências na aba CIÊNCIA para ver recomendações.'}</p>
      <div class="mt-3 text-slate-300 text-sm">
        <p class="mb-2"><strong>Dicas práticas:</strong></p>
        <ul class="list-disc list-inside space-y-1 text-sm">
          <li>Distribua a proteína em 4-6 refeições ao longo do dia</li>
          <li>Consuma 20-40g de proteína a cada 3-4 horas</li>
          <li>Tome creatina diariamente (5g), preferencialmente com carboidratos</li>
          <li>Whey protein ideal no pós-treino (janela de 0-2h)</li>
          <li>Carboidratos concentrados antes e após treinos intensos</li>
          <li>Gorduras saudáveis em todas as refeições principais</li>
          <li>Hidrate-se: mínimo 35ml/kg de peso corporal por dia</li>
        </ul>
      </div>
    </div>
  `;
}

function renderAlimentacao() {
  const currentUser = state.users[state.activeUser];
  const mealHistory = currentUser.mealHistory || [];
  
  // Filter meals for the selected day
  const selectedDayMeals = mealHistory.filter(m => m.date === state.currentDay);
  
  // Calculate totals for the selected day
  const dayTotals = selectedDayMeals.reduce((acc, log) => {
    const nut = getMealNutritionByNameCombined(log.meal);
    acc.kcal += nut.kcal; 
    acc.prot += nut.prot; 
    acc.fat += nut.fat;
    return acc;
  }, { kcal: 0, prot: 0, fat: 0 });
  
  // Format date for display
  const displayDate = new Date(state.currentDay + 'T00:00:00');
  const isToday = state.currentDay === new Date().toISOString().split('T')[0];
  const dateLabel = isToday ? 'Hoje' : displayDate.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'short' });
  
  return `
    <!-- Day Navigation -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <div class="flex justify-between items-center">
        <button onclick="goToPreviousDay()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded">← Dia Anterior</button>
        <div class="text-center">
          <p class="text-lg font-bold">${dateLabel}</p>
          <p class="text-sm text-slate-300">${state.currentDay}</p>
        </div>
        <button onclick="goToNextDay()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded">Próximo Dia →</button>
      </div>
      ${!isToday ? `<div class="mt-2 text-center"><button onclick="goToToday()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Ir para Hoje</button></div>` : ''}
    </div>

    <!-- Day Totals -->
    <div class="bg-gradient-to-r from-green-600 to-green-800 p-4 rounded mb-6">
      <h4 class="font-bold text-lg">Totais de ${dateLabel}</h4>
      <p class="text-white text-xl">${Math.round(dayTotals.kcal)} kcal • ${Math.round(dayTotals.prot)} g proteína • ${Math.round(dayTotals.fat)} g gord.</p>
    </div>

    <!-- Nutrition Calculator & Guide -->
    <div class="bg-gradient-to-br from-blue-900 to-indigo-900 p-6 rounded-xl mb-6 border-2 border-blue-500">
      <h3 class="font-bold text-2xl mb-4 flex items-center gap-2">
        🧮 Calculadora de Macronutrientes
        <span class="text-xs font-normal bg-yellow-500 text-black px-2 py-1 rounded">NOVO</span>
      </h3>
      
      <div class="bg-white/10 backdrop-blur p-5 rounded-lg mb-6">
        <h4 class="font-semibold text-lg mb-3 text-cyan-300">📚 Como Calcular os Macros da sua Refeição</h4>
        <div class="space-y-3 text-sm text-slate-200">
          <p class="leading-relaxed"><strong>1. Pese os alimentos crus</strong> (antes de cozinhar) sempre que possível, pois as tabelas nutricionais se referem ao peso cru.</p>
          <p class="leading-relaxed"><strong>2. Use a regra de três simples:</strong> Se a tabela nutricional informa valores para 100g, e você tem 150g, multiplique por 1.5 (150 ÷ 100).</p>
          <p class="leading-relaxed"><strong>3. Lembre-se das calorias por grama:</strong></p>
          <ul class="list-disc list-inside ml-4 space-y-1">
            <li><strong>Proteína:</strong> 4 kcal por grama</li>
            <li><strong>Carboidrato:</strong> 4 kcal por grama</li>
            <li><strong>Gordura:</strong> 9 kcal por grama</li>
          </ul>
          <p class="leading-relaxed"><strong>4. Some todos os ingredientes</strong> da sua refeição para obter o total.</p>
        </div>
      </div>

      <!-- Food Database Browser -->
      <div class="bg-slate-800 p-5 rounded-lg mb-4">
        <h4 class="font-semibold text-lg mb-4 text-yellow-300">📚 Banco de Alimentos Comuns</h4>
        <p class="text-sm text-slate-300 mb-4">Selecione um alimento da lista para preencher automaticamente a calculadora. Valores baseados na Tabela TACO (Tabela Brasileira de Composição de Alimentos).</p>
        
        <!-- Search box -->
        <div class="mb-4">
          <input type="text" id="foodSearchInput" placeholder="🔍 Buscar alimento..." onkeyup="filterFoods()" class="w-full px-4 py-2 rounded bg-slate-700 text-white" />
        </div>

        <!-- Food categories -->
        <div class="grid md:grid-cols-2 gap-4" id="foodCategoriesContainer">
          ${Object.keys(commonFoods).map(category => `
            <div class="bg-slate-700 p-4 rounded food-category">
              <h5 class="font-semibold mb-3 capitalize ${
                category === 'proteinas' ? 'text-blue-300' :
                category === 'carboidratos' ? 'text-orange-300' :
                category === 'gorduras' ? 'text-yellow-300' :
                'text-green-300'
              }">
                ${category === 'proteinas' ? '💪 Proteínas' :
                  category === 'carboidratos' ? '🌾 Carboidratos' :
                  category === 'gorduras' ? '🥑 Gorduras Saudáveis' :
                  '🥗 Vegetais'}
              </h5>
              <div class="space-y-2 max-h-64 overflow-y-auto">
                ${commonFoods[category].map((food, idx) => `
                  <div class="food-item bg-slate-800 p-2 rounded hover:bg-slate-600 cursor-pointer transition-colors" data-food-name="${food.name}" onclick="selectFood('${category}', ${idx})">
                    <p class="font-medium text-sm">${food.name}</p>
                    <p class="text-xs text-slate-400">${food.kcal} kcal • ${food.prot}g P • ${food.carb}g C • ${food.fat}g G (${food.per} ${food.unit})</p>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Interactive Calculator -->
      <div class="bg-slate-800 p-5 rounded-lg mb-4">
        <h4 class="font-semibold text-lg mb-4 text-green-300">🔢 Calculadora Interativa</h4>
        <div class="space-y-4">
          <!-- Food input -->
          <div class="grid md:grid-cols-6 gap-3">
            <input type="text" id="calcFoodName" placeholder="Nome do alimento" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <input type="number" id="calcWeight" placeholder="Peso (g)" step="0.1" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <input type="number" id="calcProtPer100" placeholder="Prot/100g" step="0.1" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <input type="number" id="calcCarbPer100" placeholder="Carb/100g" step="0.1" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <input type="number" id="calcFatPer100" placeholder="Gord/100g" step="0.1" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <button onclick="calculateMacros()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded font-semibold">Calcular</button>
          </div>
          
          <!-- Results -->
          <div id="calcResults" class="hidden bg-gradient-to-r from-green-700 to-emerald-800 p-4 rounded-lg">
            <h5 class="font-semibold mb-2">Resultado do Cálculo:</h5>
            <div class="grid md:grid-cols-4 gap-3 text-center">
              <div class="bg-white/10 backdrop-blur p-3 rounded">
                <p class="text-xs text-green-200 mb-1">Proteína</p>
                <p class="text-2xl font-bold" id="resultProt">0g</p>
                <p class="text-xs text-green-300" id="resultProtKcal">0 kcal</p>
              </div>
              <div class="bg-white/10 backdrop-blur p-3 rounded">
                <p class="text-xs text-orange-200 mb-1">Carboidrato</p>
                <p class="text-2xl font-bold" id="resultCarb">0g</p>
                <p class="text-xs text-orange-300" id="resultCarbKcal">0 kcal</p>
              </div>
              <div class="bg-white/10 backdrop-blur p-3 rounded">
                <p class="text-xs text-yellow-200 mb-1">Gordura</p>
                <p class="text-2xl font-bold" id="resultFat">0g</p>
                <p class="text-xs text-yellow-300" id="resultFatKcal">0 kcal</p>
              </div>
              <div class="bg-white/10 backdrop-blur p-3 rounded">
                <p class="text-xs text-cyan-200 mb-1">Total</p>
                <p class="text-2xl font-bold" id="resultTotal">0 kcal</p>
                <p class="text-xs text-cyan-300">calorias totais</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Examples Section -->
      <div class="bg-slate-800 p-5 rounded-lg">
        <h4 class="font-semibold text-lg mb-3 text-yellow-300">💡 Exemplos Práticos</h4>
        <div class="space-y-4">
          <div class="bg-slate-700 p-4 rounded">
            <p class="font-bold text-blue-300 mb-2">Exemplo 1: Frango Grelhado (150g)</p>
            <p class="text-sm text-slate-300 mb-2">Valores por 100g: 31g prot, 0g carb, 3.6g gord</p>
            <div class="bg-slate-800 p-3 rounded text-sm">
              <p class="mb-1"><strong>Cálculo:</strong></p>
              <p>• Proteína: 31g × 1.5 = <strong class="text-green-400">46.5g</strong> = 186 kcal</p>
              <p>• Carboidrato: 0g × 1.5 = <strong class="text-orange-400">0g</strong> = 0 kcal</p>
              <p>• Gordura: 3.6g × 1.5 = <strong class="text-yellow-400">5.4g</strong> = 48.6 kcal</p>
              <p class="mt-2 text-cyan-400"><strong>Total: 234.6 kcal</strong></p>
            </div>
            <button onclick="fillCalculatorExample('Frango grelhado', 150, 31, 0, 3.6)" class="mt-2 bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Testar na Calculadora</button>
          </div>

          <div class="bg-slate-700 p-4 rounded">
            <p class="font-bold text-blue-300 mb-2">Exemplo 2: Arroz Integral Cozido (200g)</p>
            <p class="text-sm text-slate-300 mb-2">Valores por 100g: 2.6g prot, 23g carb, 0.9g gord</p>
            <div class="bg-slate-800 p-3 rounded text-sm">
              <p class="mb-1"><strong>Cálculo:</strong></p>
              <p>• Proteína: 2.6g × 2 = <strong class="text-green-400">5.2g</strong> = 20.8 kcal</p>
              <p>• Carboidrato: 23g × 2 = <strong class="text-orange-400">46g</strong> = 184 kcal</p>
              <p>• Gordura: 0.9g × 2 = <strong class="text-yellow-400">1.8g</strong> = 16.2 kcal</p>
              <p class="mt-2 text-cyan-400"><strong>Total: 221 kcal</strong></p>
            </div>
            <button onclick="fillCalculatorExample('Arroz integral cozido', 200, 2.6, 23, 0.9)" class="mt-2 bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Testar na Calculadora</button>
          </div>

          <div class="bg-slate-700 p-4 rounded">
            <p class="font-bold text-blue-300 mb-2">Exemplo 3: Batata Doce (300g)</p>
            <p class="text-sm text-slate-300 mb-2">Valores por 100g: 1.6g prot, 20g carb, 0.1g gord</p>
            <div class="bg-slate-800 p-3 rounded text-sm">
              <p class="mb-1"><strong>Cálculo:</strong></p>
              <p>• Proteína: 1.6g × 3 = <strong class="text-green-400">4.8g</strong> = 19.2 kcal</p>
              <p>• Carboidrato: 20g × 3 = <strong class="text-orange-400">60g</strong> = 240 kcal</p>
              <p>• Gordura: 0.1g × 3 = <strong class="text-yellow-400">0.3g</strong> = 2.7 kcal</p>
              <p class="mt-2 text-cyan-400"><strong>Total: 261.9 kcal</strong></p>
            </div>
            <button onclick="fillCalculatorExample('Batata doce', 300, 1.6, 20, 0.1)" class="mt-2 bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Testar na Calculadora</button>
          </div>
        </div>
      </div>

      <!-- Tips Section -->
      <div class="bg-gradient-to-r from-purple-900 to-pink-900 p-5 rounded-lg mt-4">
        <h4 class="font-semibold text-lg mb-3">✨ Dicas Importantes</h4>
        <ul class="space-y-2 text-sm text-slate-200">
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">✓</span>
            <span><strong>Balança digital:</strong> Investir numa balança de cozinha precisa (até 0.1g) facilita muito o controle.</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">✓</span>
            <span><strong>Aplicativos úteis:</strong> MyFitnessPal, FatSecret e Cronometer têm grandes bancos de dados de alimentos.</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">✓</span>
            <span><strong>Cozido vs Cru:</strong> Arroz e macarrão absorvem água ao cozinhar (peso aumenta 2-3x, mas calorias não mudam).</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">✓</span>
            <span><strong>Óleos e temperos:</strong> Não esqueça de contar azeite, óleo, manteiga usados no preparo (1 colher sopa ≈ 15ml ≈ 135 kcal).</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">✓</span>
            <span><strong>Estimativas:</strong> Quando não puder pesar, use aproximações: 1 palma de mão = ~100g de proteína, 1 punho = ~150g de carboidrato.</span>
          </li>
        </ul>
      </div>
    </div>

    <!-- Custom Meal Form -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold mb-3">➕ Adicionar Refeição Personalizada</h3>
      <form id="customMealForm" class="grid md:grid-cols-5 gap-2">
        <input type="text" name="customMealName" placeholder="Nome da refeição" required class="px-3 py-2 rounded bg-slate-700 text-white" />
        <input type="number" name="customMealKcal" step="0.1" placeholder="Calorias (kcal)" required class="px-3 py-2 rounded bg-slate-700 text-white" />
        <input type="number" name="customMealProt" step="0.1" placeholder="Proteína (g)" class="px-3 py-2 rounded bg-slate-700 text-white" />
        <input type="number" name="customMealFat" step="0.1" placeholder="Gordura (g)" class="px-3 py-2 rounded bg-slate-700 text-white" />
        <div class="flex flex-col gap-2">
          <label class="flex items-center gap-2 text-sm text-slate-300">
            <input type="checkbox" name="saveAsReusable" class="rounded" />
            Salvar como reutilizável
          </label>
          <button type="submit" class="bg-green-600 hover:bg-green-500 px-3 py-2 rounded font-semibold">Adicionar</button>
        </div>
      </form>
      <p class="text-slate-400 text-xs mt-2">A refeição será registrada para ${dateLabel}. Marque "Salvar como reutilizável" para adicioná-la à lista abaixo.</p>
    </div>

    <!-- Custom Meals List -->
    ${state.customMeals.length > 0 ? `
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold mb-3">🍽️ Minhas Refeições Personalizadas</h3>
      <div class="grid md:grid-cols-2 gap-3">
        ${state.customMeals.map(m => `
          <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
            <div>
              <p class="font-semibold">${m.name}</p>
              <p class="text-slate-300 text-xs">${m.kcal} kcal • ${m.prot}g prot • ${m.fat}g gord</p>
            </div>
            <div class="flex gap-2">
              <button data-meal-name="${m.name.replace(/"/g, '&quot;')}" class="meal-register-btn bg-orange-500 hover:bg-orange-400 px-3 py-1 rounded">Registrar</button>
              <button onclick="handleDeleteCustomMeal('${m.id}')" class="text-red-400 hover:text-red-300 px-2">🗑️</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
    ` : ''}

    <!-- LiveUp Marmitas -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold mb-3">🍱 Marmitas LiveUp (Disponíveis)</h3>
      <div class="grid md:grid-cols-2 gap-3">
        ${livUpMarmitas.map(m => `
          <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
            <div>
              <p class="font-semibold">${m.name}</p>
              <p class="text-slate-300 text-xs">${m.category} • ${m.size}${m.kcal ? ' • ' + m.kcal + ' kcal' : ''}${m.notes ? ' • ' + m.notes : ''}</p>
            </div>
            <div>
              <button data-meal-name="${m.name.replace(/"/g, '&quot;')}" class="meal-register-btn bg-orange-500 hover:bg-orange-400 px-3 py-1 rounded">Registrar</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>

    <!-- Meal History for Selected Day -->
    <div class="bg-slate-800 p-4 rounded">
      <h3 class="font-bold mb-3">📋 Histórico de ${dateLabel}</h3>
      ${selectedDayMeals.length === 0 ? 
        '<p class="text-slate-400">Nenhuma refeição registrada neste dia.</p>' :
        `<div class="space-y-2">
          ${selectedDayMeals.map(log => {
            const nut = getMealNutritionByNameCombined(log.meal);
            return `
              <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
                <div>
                  <p class="font-semibold">${log.meal}</p>
                  <p class="text-slate-300 text-xs">${log.time} • ${nut.kcal} kcal • ${nut.prot}g prot • ${nut.fat}g gord</p>
                </div>
                <button data-meal-id="${log.id}" class="meal-delete-btn text-red-400 hover:text-red-300" title="Excluir registro">🗑️</button>
              </div>
            `;
          }).join('')}
        </div>`
      }
    </div>
  `;
}

function renderEvolucao(bodyMetrics, user) {
  return `
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold text-xl mb-4">📊 Adicionar Medidas de Bioimpedância Completa</h3>
      <p class="text-slate-300 text-sm mb-4">Preencha todos os campos disponíveis do seu equipamento de bioimpedância. Os campos obrigatórios são marcados com *. Os demais são opcionais mas recomendados para análise completa.</p>
      
      <form id="metricsForm" class="space-y-4">
        <!-- Informações Básicas -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-purple-300">📅 Informações Básicas</h4>
          <div class="grid md:grid-cols-4 gap-3">
            <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required class="px-3 py-2 rounded bg-slate-600 text-white" title="Data da medição"/>
            <input type="number" name="weight" step="0.01" required placeholder="Peso (kg)*" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFat" step="0.1" required placeholder="Gordura Corporal (%)*" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMass" step="0.1" required placeholder="Massa Muscular (kg)*" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Composição Corporal Avançada -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-green-300">🧬 Composição Corporal Avançada</h4>
          <div class="grid md:grid-cols-4 gap-3">
            <input type="number" name="visceralFat" step="0.1" placeholder="Gordura Visceral" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="waterPercent" step="0.1" placeholder="Água Corporal (%)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="boneMass" step="0.1" placeholder="Massa Óssea (kg)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="proteinMass" step="0.1" placeholder="Proteína (kg)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="mineralMass" step="0.1" placeholder="Minerais (kg)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Massa Muscular Segmentada -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-blue-300">💪 Massa Muscular Segmentada (kg)</h4>
          <div class="grid md:grid-cols-5 gap-3">
            <input type="number" name="muscleMassRightArm" step="0.1" placeholder="Braço Direito" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMassLeftArm" step="0.1" placeholder="Braço Esquerdo" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMassRightLeg" step="0.1" placeholder="Perna Direita" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMassLeftLeg" step="0.1" placeholder="Perna Esquerda" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMassTrunk" step="0.1" placeholder="Tronco" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Gordura Corporal Segmentada -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-red-300">🔥 Gordura Corporal Segmentada (%)</h4>
          <div class="grid md:grid-cols-5 gap-3">
            <input type="number" name="bodyFatRightArm" step="0.1" placeholder="Braço Direito" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFatLeftArm" step="0.1" placeholder="Braço Esquerdo" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFatRightLeg" step="0.1" placeholder="Perna Direita" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFatLeftLeg" step="0.1" placeholder="Perna Esquerda" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFatTrunk" step="0.1" placeholder="Tronco" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Taxas Metabólicas -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-orange-300">⚡ Taxas Metabólicas (kcal/dia)</h4>
          <div class="grid md:grid-cols-3 gap-3">
            <input type="number" name="bmr" placeholder="TMB - Taxa Metabólica Basal" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="rmr" placeholder="TMR - Taxa Metabólica Repouso" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="tdee" placeholder="TDEE - Gasto Energético Total" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Impedância Bioelétrica (Bioelectrical Impedance Analysis - BIA) -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-cyan-300">⚡ Análise de Impedância Bioelétrica (BIA)</h4>
          <div class="grid md:grid-cols-4 gap-3">
            <input type="number" name="impedance" step="0.1" placeholder="Impedância (Ω)" class="px-3 py-2 rounded bg-slate-600 text-white" title="Impedância corporal total a 50kHz"/>
            <input type="number" name="resistance" step="0.1" placeholder="Resistência (Ω)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="reactance" step="0.1" placeholder="Reatância (Ω)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="phaseAngle" step="0.1" placeholder="Ângulo de Fase (°)" class="px-3 py-2 rounded bg-slate-600 text-white" title="Indicador de saúde celular (normal: 5-7°)"/>
          </div>
          <p class="text-xs text-slate-400 mt-2">💡 Ângulo de Fase: indicador de saúde celular. Normal: 5-7°. Maior = melhor integridade celular.</p>
        </div>

        <!-- Idades e Índices -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-yellow-300">🎂 Idades Metabólica e Corporal</h4>
          <div class="grid md:grid-cols-3 gap-3">
            <input type="number" name="metabolicAge" placeholder="Idade Metabólica (anos)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyAge" placeholder="Idade Corporal (anos)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleSize" step="0.1" placeholder="Tamanho Muscular (cm)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Circunferências Corporais -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-pink-300">📏 Circunferências Corporais (cm)</h4>
          <div class="grid md:grid-cols-4 gap-3">
            <input type="number" name="chest" step="0.1" placeholder="Peito" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="waist" step="0.1" placeholder="Cintura" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="hips" step="0.1" placeholder="Quadril" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="shoulders" step="0.1" placeholder="Ombros" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="rightArm" step="0.1" placeholder="Braço Direito" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="leftArm" step="0.1" placeholder="Braço Esquerdo" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="rightThigh" step="0.1" placeholder="Coxa Direita" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="leftThigh" step="0.1" placeholder="Coxa Esquerda" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="rightCalf" step="0.1" placeholder="Panturrilha Direita" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="leftCalf" step="0.1" placeholder="Panturrilha Esquerda" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="neck" step="0.1" placeholder="Pescoço" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <div class="flex gap-3">
          <button type="submit" class="bg-purple-600 hover:bg-purple-500 px-6 py-3 rounded font-semibold text-lg">➕ Adicionar Medição Completa</button>
          <button type="button" onclick="document.getElementById('metricsForm').reset()" class="bg-slate-600 hover:bg-slate-500 px-4 py-3 rounded">🔄 Limpar</button>
        </div>
      </form>
    </div>

    <div class="bg-slate-800 p-4 rounded mb-6">
      <div class="flex gap-3 items-start">
        <div style="flex:1;">
          <canvas id="muscleChart" height="160"></canvas>
        </div>
        <div style="width: 180px;" class="flex flex-col gap-2">
          <button onclick="exportMuscleEvolutionCSV('${user.id}')" class="bg-blue-600 px-3 py-2 rounded">📊 Exportar CSV</button>
          <button onclick="alert('Backup (full DB export) em breve')" class="bg-amber-600 px-3 py-2 rounded">💾 Backup DB</button>
          <div class="text-slate-300 text-sm mt-2">Gráfico de evolução: massa muscular e composição corporal ao longo do tempo.</div>
        </div>
      </div>

      <div class="overflow-x-auto mt-4">
        <table class="w-full text-sm">
          <thead><tr class="border-b border-slate-600">
            <th class="py-2 px-2">Data</th>
            <th>Peso</th>
            <th>Gordura</th>
            <th>Massa Musc.</th>
            <th>IMC</th>
            <th>Água</th>
            <th>BMR</th>
            <th>Ângulo Fase</th>
            <th>Idade Met.</th>
            <th>Ações</th>
          </tr></thead>
          <tbody>
            ${bodyMetrics.slice().reverse().map(m => `
              <tr class="border-b border-slate-700 hover:bg-slate-700">
                <td class="py-2 px-2">${m.date}</td>
                <td class="py-2 px-2">${m.weight}kg</td>
                <td class="py-2 px-2">${m.bodyFat}%</td>
                <td class="py-2 px-2">${m.muscleMass}kg</td>
                <td class="py-2 px-2">${m.bmi || '-'}</td>
                <td class="py-2 px-2">${m.waterWeight || 0}kg</td>
                <td class="py-2 px-2">${m.bmr || '-'}</td>
                <td class="py-2 px-2">${m.phaseAngle ? m.phaseAngle + '°' : '-'}</td>
                <td class="py-2 px-2">${m.metabolicAge ? m.metabolicAge + 'a' : '-'}</td>
                <td class="py-2 px-2">
                  <button onclick="handleDeleteMetric('${m.id}')" class="text-red-400 hover:text-red-300" title="Excluir e mover para archive">🗑️</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      ${bodyMetrics.length > 0 ? `
        <div class="mt-6 bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3">📈 Métricas Detalhadas da Última Medição</h4>
          ${(() => {
            const latest = bodyMetrics[bodyMetrics.length - 1];
            return `
              <div class="grid md:grid-cols-3 gap-4 text-sm">
                ${latest.muscleMassRightArm ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">💪 Massa Muscular Segmentada</p>
                    <p>Braço D: ${latest.muscleMassRightArm}kg | E: ${latest.muscleMassLeftArm}kg</p>
                    <p>Perna D: ${latest.muscleMassRightLeg}kg | E: ${latest.muscleMassLeftLeg}kg</p>
                    <p>Tronco: ${latest.muscleMassTrunk}kg</p>
                  </div>
                ` : ''}
                ${latest.bodyFatRightArm ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">🔥 Gordura Segmentada</p>
                    <p>Braço D: ${latest.bodyFatRightArm}% | E: ${latest.bodyFatLeftArm}%</p>
                    <p>Perna D: ${latest.bodyFatRightLeg}% | E: ${latest.bodyFatLeftLeg}%</p>
                    <p>Tronco: ${latest.bodyFatTrunk}%</p>
                  </div>
                ` : ''}
                ${latest.boneMass ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">🧬 Composição Avançada</p>
                    <p>Massa Óssea: ${latest.boneMass}kg</p>
                    <p>Proteína: ${latest.proteinMass}kg</p>
                    <p>Minerais: ${latest.mineralMass}kg</p>
                  </div>
                ` : ''}
                ${latest.phaseAngle ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">⚡ BIA - Impedância</p>
                    <p>Ângulo de Fase: ${latest.phaseAngle}°</p>
                    <p>Impedância: ${latest.impedance}Ω</p>
                    <p>Resistência: ${latest.resistance}Ω</p>
                  </div>
                ` : ''}
                ${latest.chest ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">📏 Circunferências (cm)</p>
                    <p>Peito: ${latest.chest} | Cintura: ${latest.waist}</p>
                    <p>Braço D: ${latest.rightArm} | E: ${latest.leftArm}</p>
                    <p>Coxa D: ${latest.rightThigh} | E: ${latest.leftThigh}</p>
                  </div>
                ` : ''}
                ${latest.tdee ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">⚡ Taxas Metabólicas</p>
                    <p>TMB: ${latest.bmr} kcal/dia</p>
                    <p>TMR: ${latest.rmr} kcal/dia</p>
                    <p>TDEE: ${latest.tdee} kcal/dia</p>
                  </div>
                ` : ''}
              </div>
            `;
          })()}
        </div>
      ` : ''}
    </div>
  `;
}

function renderComparacao() {
  const comps = state.comparisons || [];
  return `
    <div class="bg-slate-800 p-4 rounded">
      <h3 class="font-bold">Comparações</h3>
      ${comps.length === 0 ? '<p class="text-slate-400">Nenhuma comparação criada.</p>' : comps.map(c => `
        <div class="bg-slate-700 p-3 rounded mb-2">
          <p class="font-bold">${c.title}</p>
          <p class="text-slate-300 text-xs">Criado ${new Date(c.createdAt).toLocaleString()}</p>
          <div class="mt-2 flex gap-2"><button onclick="handleDeleteComparison('${c.id}')" class="bg-red-500 px-3 py-1 rounded">Remover</button></div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderCiencia() {
  const filtered = (state.references || []).filter(r => r.year >= 2020 && r.year <= 2025);
  return `
    <div class="bg-slate-800 p-4 rounded">
      <div class="flex justify-between items-center">
        <h3 class="font-bold">Estudos científicos (2020 → 2025-11)</h3>
        <div class="flex gap-2">
          <button onclick="importScientificStudiesSeed()" class="bg-green-600 px-3 py-1 rounded">⤓ Importar estudos</button>
          <button onclick="exportReferencesJSON()" class="bg-blue-600 px-3 py-1 rounded">⬇️ Exportar JSON</button>
          <button onclick="clearReferences()" class="bg-red-600 px-3 py-1 rounded">🗄️ Mover p/ archive</button>
        </div>
      </div>

      <div class="mt-4">
        ${filtered.length === 0 ? '<p class="text-slate-400">Nenhuma referência importada. Use o botão importar.</p>' : filtered.map(ref => `
          <div class="bg-slate-700 p-3 rounded mb-3">
            <p class="font-bold">${ref.title}</p>
            <p class="text-slate-300 text-xs">${ref.authors} — ${ref.year} • ${ref.journal}</p>
            <p class="text-slate-400 text-sm mt-2">${ref.summary || ''}</p>
            <p class="mt-2"><a href="${ref.link}" target="_blank" class="text-blue-300 underline">Abrir estudo / DOI</a></p>
            <div class="mt-2 flex gap-2">
              <button onclick="navigator.clipboard.writeText('${ref.link}').then(()=>alert('Link copiado'))" class="bg-white text-black px-2 py-1 rounded">Copiar link</button>
              <button onclick="if(confirm('Mover esta referência para archive?')) { archiveItem('references','${ref.id}','reference', ${JSON.stringify(ref).replace(/'/g, "\\'")}).then(()=>{ state.references = state.references.filter(r=>r.id!=='${ref.id}'); saveAllToDB(); render(); alert('Movido para archive') }) }" class="text-red-400">Arquivar</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

/* ----------------------------- Chart rendering ----------------------------- */
function renderMuscleEvolutionChart(bodyMetrics, userId) {
  const canvas = document.getElementById('muscleChart');
  if (!canvas) return;
  const metrics = (bodyMetrics || []).slice().sort((a,b) => new Date(a.date) - new Date(b.date));
  const labels = metrics.map(m => m.date);
  const muscleMassData = metrics.map(m => m.muscleMass || null);
  const muscleSizeData = metrics.map(m => m.muscleSize || null);
  const datasets = [];
  if (muscleMassData.some(v => v !== null)) datasets.push({ label: 'Massa Muscular (kg)', data: muscleMassData, borderColor: '#34D399', backgroundColor: '#34D39933', tension: 0.2, yAxisID: 'y' });
  if (muscleSizeData.some(v => v !== null)) datasets.push({ label: 'Tamanho Músculo (cm)', data: muscleSizeData, borderColor: '#60A5FA', backgroundColor: '#60A5FA33', tension: 0.2, yAxisID: 'y2' });
  const config = {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      scales: {
        y: { beginAtZero: false, title: { display: true, text: 'kg' } },
        y2: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'cm' } }
      }
    }
  };
  if (muscleChart) { muscleChart.destroy(); muscleChart = null; }
  muscleChart = new Chart(canvas, config);
}

/* ----------------------------- Init and safety ----------------------------- */
window.addEventListener('beforeunload', () => { try { saveAllToDB(); } catch (e) { } });

(async function initApp() {
  await loadAllFromDB();
  await loadCustomMeals(); // Load custom meals from IndexedDB/localStorage
  
  // Ensure default users exist (do not overwrite)
  if (!state.users.pedro) state.users.pedro = initialUsers.pedro;
  if (!state.users.valentina) state.users.valentina = initialUsers.valentina;
  // Import marmitas list to a settings key for future UI if desired
  const s = await dbGet(STORE_SETTINGS, 'marmitas_seed_loaded').catch(()=>null);
  if (!s) {
    // store marmitas in settings for reference (not required, but keeps record)
    await dbPut(STORE_SETTINGS, { key: 'marmitas_seed_loaded', value: new Date().toISOString() });
  }
  await saveAllToDB();
  render();
})();
</script>

</body>
</html>

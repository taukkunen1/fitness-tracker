<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pilgrim ‚Äî Fitness Tracker</title>
  
  <!-- ===== SECURITY HEADERS 2025 ===== -->
  <!-- Note: CSP and X-Frame-Options should be set via HTTP headers, not meta tags -->
  <!-- X-Content-Type-Options: Prevent MIME type sniffing -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  
  <!-- Referrer Policy: Control referer information -->
  <meta name="referrer" content="no-referrer">
  
  <!-- Copyright e aviso de prote√ß√£o -->
  <meta name="copyright" content="¬© 2025 Pilgrim. Todos os direitos reservados." />
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* Pequeno ajuste para tabelas e canvas em mobile */
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 6px 8px; }
    
    /* Notification animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(20px); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    
    .animate-fade-out {
      animation: fadeOut 0.3s ease-in;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-screen">
  <!--
    Pilgrim - Vers√£o completa e verbosa (2025-11)
    Objetivos desta vers√£o:
    - Restaurar/Manter todas as informa√ß√µes antigas (marmitas, templates, treinos, etc.)
    - Nunca excluir dados permanentemente sem confirma√ß√£o expl√≠cita do usu√°rio;
      opera√ß√µes de "exclus√£o" movem o item para um store 'archive' ou marcam como 'deleted' (soft delete).
    - Banco de dados robusto local: IndexedDB com stores: users, comparisons, references, archive, settings
    - Fallback para localStorage e migra√ß√£o automatizada de chaves legadas (ft_users, ft_references, ft_custom_programs, etc.)
    - Templates detalhados de treino (Full-body, PPL, Upper/Lower/Full) com exerc√≠cios, sets, reps, tempo e notas.
    - Gr√°fico de evolu√ß√£o muscular com massa (kg) e tamanho (cm) e op√ß√£o de export CSV.
    - Import/Export de backups JSON e fun√ß√µes para sincroniza√ß√£o remota futura (placeholder).
    - Coment√°rios abundantes para transpar√™ncia e f√°cil edi√ß√£o.
  -->

  <div id="app"></div>

<script>
/* ======================================================================
   CONFIGURA√á√ïES GLOBAIS E DESCRI√á√ÉO DO DB
   ======================================================================

   - IndexedDB: 'fitness-tracker-db' vers√£o 3 (vers√£o incrementada para garantir migra√ß√£o se necess√°rio)
     Object stores:
       * users         - keyPath: id
       * comparisons   - keyPath: id
       * references    - keyPath: id
       * archive       - keyPath: id  (para guardar itens removidos, hist√≥rico, backups r√°pidos)
       * settings      - keyPath: key (para armazenar flags, lastSync, etc.)

   - Fallback localStorage keys:
       ft_users, ft_comparisons, ft_references, ft_custom_programs, ft_settings

   - Pol√≠tica de exclus√£o: por padr√£o, N√ÉO remover do arquivo nem do DB. Ao "deletar" itens,
     movemos para STORE 'archive' e marcamos um campo deletedAt + deletedBy (soft-delete).
     Apenas com confirma√ß√£o expl√≠cita do usu√°rio e sele√ß√£o de "Excluir permanentemente (archive->delete)"
     removeremos de archive.

   - Migra√ß√£o: se encontrar dados legados em localStorage, vamos migrar cuidadosamente para IndexedDB
     (sem sobrescrever dados existentes) e manter as chaves legadas como backup.

   ====================================================================== */

const DB_NAME = 'fitness-tracker-db';
const DB_VERSION = 6; // bumped for access tracking and monitoring
const STORE_USERS = 'users';
const STORE_COMPARISONS = 'comparisons';
const STORE_REFERENCES = 'references';
const STORE_ARCHIVE = 'archive';
const STORE_SETTINGS = 'settings';
const STORE_ACCOUNTS = 'accounts'; // New store for authentication
const STORE_TASKS = 'tasks'; // Admin task management
const STORE_SUGGESTIONS = 'suggestions'; // User suggestions and feedback
const STORE_ACCESS_LOGS = 'access_logs'; // Site access tracking

// ----------------------------- IndexedDB helpers -----------------------------
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_USERS)) db.createObjectStore(STORE_USERS, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_COMPARISONS)) db.createObjectStore(STORE_COMPARISONS, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_REFERENCES)) db.createObjectStore(STORE_REFERENCES, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_ARCHIVE)) db.createObjectStore(STORE_ARCHIVE, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_SETTINGS)) db.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
      if (!db.objectStoreNames.contains(STORE_ACCOUNTS)) {
        const accountStore = db.createObjectStore(STORE_ACCOUNTS, { keyPath: 'username' });
        accountStore.createIndex('email', 'email', { unique: true });
      }
      if (!db.objectStoreNames.contains(STORE_TASKS)) {
        db.createObjectStore(STORE_TASKS, { keyPath: 'id' });
      }
      if (!db.objectStoreNames.contains(STORE_SUGGESTIONS)) {
        db.createObjectStore(STORE_SUGGESTIONS, { keyPath: 'id' });
      }
      if (!db.objectStoreNames.contains(STORE_ACCESS_LOGS)) {
        const accessStore = db.createObjectStore(STORE_ACCESS_LOGS, { keyPath: 'id' });
        accessStore.createIndex('timestamp', 'timestamp', { unique: false });
        accessStore.createIndex('username', 'username', { unique: false });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function dbPut(storeName, value) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      const store = tx.objectStore(storeName);
      const request = store.put(value);
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  } catch (err) {
    console.error('DB put failed', err);
    throw err;
  }
}

async function dbGetAll(storeName) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const store = tx.objectStore(storeName);
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  } catch (err) {
    console.error('DB getAll failed', err);
    return [];
  }
}

async function dbGet(storeName, key) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const store = tx.objectStore(storeName);
      const req = store.get(key);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  } catch (err) {
    console.error('DB get failed', err);
    return null;
  }
}

async function dbDelete(storeName, key) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      const store = tx.objectStore(storeName);
      const req = store.delete(key);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  } catch (err) {
    console.error('DB delete failed', err);
    throw err;
  }
}

// ----------------------------- localStorage fallback -----------------------------
function saveLS(key, data) {
  try { localStorage.setItem(key, JSON.stringify(data)); } catch (err) { console.warn('localStorage save failed', err); }
}
function loadLS(key) {
  try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : null; } catch (err) { return null; }
}

// ============================= AUTHENTICATION & SECURITY SYSTEM (2025) =============================
/* 
  Sistema de autentica√ß√£o e seguran√ßa implementado para prote√ß√£o contra ataques modernos:
  - Login e registro seguros
  - Hash de senha com PBKDF2 (Web Crypto API)
  - Prote√ß√£o contra brute force
  - Rate limiting
  - CSRF token protection
  - XSS protection com sanitiza√ß√£o
  - Session management segura
  - Auditoria de eventos de seguran√ßa
*/

// Security configuration
const SECURITY_CONFIG = {
  PASSWORD_MIN_LENGTH: 8,
  PASSWORD_REQUIRE_UPPERCASE: true,
  PASSWORD_REQUIRE_LOWERCASE: true,
  PASSWORD_REQUIRE_NUMBER: true,
  PASSWORD_REQUIRE_SPECIAL: true,
  MAX_LOGIN_ATTEMPTS: 5,
  LOCKOUT_DURATION_MS: 15 * 60 * 1000, // 15 minutes
  SESSION_TIMEOUT_MS: 24 * 60 * 60 * 1000, // 24 hours
  PBKDF2_ITERATIONS: 100000,
  RATE_LIMIT_WINDOW_MS: 60 * 1000, // 1 minute
  MAX_REQUESTS_PER_WINDOW: 10
};

// Authentication state
let authState = {
  isAuthenticated: false,
  currentAccount: null,
  sessionToken: null,
  csrfToken: null,
  loginAttempts: {},
  rateLimitTracking: {}
};

// ----------------------------- Crypto utilities -----------------------------
async function hashPassword(password, salt) {
  const encoder = new TextEncoder();
  // Encode password and salt separately for better security
  const passwordBuffer = encoder.encode(password);
  const saltBuffer = encoder.encode(salt);
  
  // Combine password and salt buffers
  const combined = new Uint8Array(passwordBuffer.length + saltBuffer.length);
  combined.set(passwordBuffer, 0);
  combined.set(saltBuffer, passwordBuffer.length);
  
  const key = await crypto.subtle.importKey(
    'raw',
    combined,
    { name: 'PBKDF2' },
    false,
    ['deriveBits']
  );
  const derivedBits = await crypto.subtle.deriveBits(
    {
      name: 'PBKDF2',
      salt: encoder.encode(salt),
      iterations: SECURITY_CONFIG.PBKDF2_ITERATIONS,
      hash: 'SHA-256'
    },
    key,
    256
  );
  return Array.from(new Uint8Array(derivedBits))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('');
}

function generateSalt() {
  const array = new Uint8Array(16);
  crypto.getRandomValues(array);
  return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
}

function generateToken() {
  const array = new Uint8Array(32);
  crypto.getRandomValues(array);
  return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
}

// ----------------------------- Password validation -----------------------------
function validatePassword(password) {
  const errors = [];
  
  // Check minimum length
  if (password.length < SECURITY_CONFIG.PASSWORD_MIN_LENGTH) {
    errors.push(`Senha deve ter pelo menos ${SECURITY_CONFIG.PASSWORD_MIN_LENGTH} caracteres`);
  }
  
  // Check maximum length to prevent DoS attacks
  if (password.length > 128) {
    errors.push('Senha muito longa (m√°ximo 128 caracteres)');
  }
  
  if (SECURITY_CONFIG.PASSWORD_REQUIRE_UPPERCASE && !/[A-Z]/.test(password)) {
    errors.push('Senha deve conter pelo menos uma letra mai√∫scula');
  }
  
  if (SECURITY_CONFIG.PASSWORD_REQUIRE_LOWERCASE && !/[a-z]/.test(password)) {
    errors.push('Senha deve conter pelo menos uma letra min√∫scula');
  }
  
  if (SECURITY_CONFIG.PASSWORD_REQUIRE_NUMBER && !/[0-9]/.test(password)) {
    errors.push('Senha deve conter pelo menos um n√∫mero');
  }
  
  if (SECURITY_CONFIG.PASSWORD_REQUIRE_SPECIAL && !/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
    errors.push('Senha deve conter pelo menos um caractere especial');
  }
  
  return { valid: errors.length === 0, errors };
}

// ----------------------------- XSS Protection -----------------------------
function sanitizeInput(input) {
  if (typeof input !== 'string') return input;
  
  // Remove dangerous characters and HTML tags
  return input
    .replace(/&/g, '&amp;')   // Must be first to avoid double-encoding
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/`/g, '&#x60;')   // Backticks for template literals
    .replace(/\//g, '&#x2F;')
    .replace(/\n/g, ' ')        // Remove newlines
    .replace(/\r/g, ' ')        // Remove carriage returns
    .replace(/\t/g, ' ')        // Remove tabs
    .trim()
    .slice(0, 255); // Limit length
}

// Note: escapeHtml function is defined later in the file around line 1723

function validateEmail(email) {
  const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
  return emailRegex.test(email);
}

function validateUsername(username) {
  // Username: 3-20 characters, alphanumeric and underscore only
  const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
  return usernameRegex.test(username);
}

// ----------------------------- Rate Limiting -----------------------------
function checkRateLimit(identifier) {
  const now = Date.now();
  
  if (!authState.rateLimitTracking[identifier]) {
    authState.rateLimitTracking[identifier] = { count: 0, windowStart: now };
  }
  
  const tracking = authState.rateLimitTracking[identifier];
  
  // Reset window if expired
  if (now - tracking.windowStart > SECURITY_CONFIG.RATE_LIMIT_WINDOW_MS) {
    tracking.count = 0;
    tracking.windowStart = now;
  }
  
  tracking.count++;
  
  if (tracking.count > SECURITY_CONFIG.MAX_REQUESTS_PER_WINDOW) {
    return false; // Rate limit exceeded
  }
  
  return true;
}

// ----------------------------- Brute Force Protection -----------------------------
function checkLoginAttempts(username) {
  const now = Date.now();
  
  if (!authState.loginAttempts[username]) {
    return { allowed: true, remainingAttempts: SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS };
  }
  
  const attempts = authState.loginAttempts[username];
  
  // Check if account is locked
  if (attempts.lockedUntil && now < attempts.lockedUntil) {
    const remainingTime = Math.ceil((attempts.lockedUntil - now) / 1000 / 60);
    return { allowed: false, lockedForMinutes: remainingTime };
  }
  
  // Reset if lockout expired
  if (attempts.lockedUntil && now >= attempts.lockedUntil) {
    delete authState.loginAttempts[username];
    return { allowed: true, remainingAttempts: SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS };
  }
  
  return { 
    allowed: attempts.count < SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS,
    remainingAttempts: SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS - attempts.count
  };
}

function recordFailedLogin(username) {
  const now = Date.now();
  
  if (!authState.loginAttempts[username]) {
    authState.loginAttempts[username] = { count: 1, lastAttempt: now };
  } else {
    authState.loginAttempts[username].count++;
    authState.loginAttempts[username].lastAttempt = now;
  }
  
  // Lock account if max attempts reached
  if (authState.loginAttempts[username].count >= SECURITY_CONFIG.MAX_LOGIN_ATTEMPTS) {
    authState.loginAttempts[username].lockedUntil = now + SECURITY_CONFIG.LOCKOUT_DURATION_MS;
    logSecurityEvent('account_locked', username, 'Too many failed login attempts');
  }
  
  // Save to localStorage
  saveLS('ft_login_attempts', authState.loginAttempts);
}

function clearFailedLoginAttempts(username) {
  delete authState.loginAttempts[username];
  saveLS('ft_login_attempts', authState.loginAttempts);
}

// ----------------------------- Security Audit Log -----------------------------
async function logSecurityEvent(eventType, username, details) {
  const event = {
    id: 'sec_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11),
    type: eventType,
    username: username || 'anonymous',
    timestamp: new Date().toISOString(),
    details: details,
    ip: 'client-side', // In a real app, this would be server-side
    userAgent: navigator.userAgent
  };
  
  try {
    // Store in IndexedDB
    await dbPut(STORE_SETTINGS, { 
      key: 'security_log_' + event.id, 
      value: event 
    });
    
    console.log('[SECURITY]', event);
  } catch (err) {
    console.error('Failed to log security event', err);
  }
}

// ----------------------------- Access Tracking for Admin Monitoring -----------------------------
async function logPageAccess() {
  const accessLog = {
    id: 'access_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11),
    timestamp: new Date().toISOString(),
    username: authState.isAuthenticated ? authState.currentAccount.username : 'anonymous',
    role: authState.isAuthenticated ? (authState.currentAccount.role || 'user') : 'anonymous',
    page: window.location.pathname,
    userAgent: navigator.userAgent,
    screenResolution: `${window.screen.width}x${window.screen.height}`,
    language: navigator.language
  };
  
  try {
    await dbPut(STORE_ACCESS_LOGS, accessLog);
    console.log('[ACCESS]', accessLog);
  } catch (err) {
    console.error('Failed to log page access', err);
  }
}

async function getAccessStatistics() {
  const accessLogs = await dbGetAll(STORE_ACCESS_LOGS);
  const now = new Date();
  const last24h = new Date(now.getTime() - 24 * 60 * 60 * 1000);
  const last7d = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  const last30d = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
  
  const logs24h = accessLogs.filter(log => new Date(log.timestamp) > last24h);
  const logs7d = accessLogs.filter(log => new Date(log.timestamp) > last7d);
  const logs30d = accessLogs.filter(log => new Date(log.timestamp) > last30d);
  
  // Get unique visitors
  const uniqueVisitors24h = new Set(logs24h.map(log => log.username)).size;
  const uniqueVisitors7d = new Set(logs7d.map(log => log.username)).size;
  const uniqueVisitors30d = new Set(logs30d.map(log => log.username)).size;
  
  // Get hourly breakdown for last 24h
  const hourlyBreakdown = {};
  for (let i = 0; i < 24; i++) {
    hourlyBreakdown[i] = 0;
  }
  
  logs24h.forEach(log => {
    const hour = new Date(log.timestamp).getHours();
    hourlyBreakdown[hour]++;
  });
  
  // Get daily breakdown for last 7 days
  const dailyBreakdown = {};
  for (let i = 0; i < 7; i++) {
    const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
    const dateKey = date.toISOString().split('T')[0];
    dailyBreakdown[dateKey] = 0;
  }
  
  logs7d.forEach(log => {
    const dateKey = log.timestamp.split('T')[0];
    if (dailyBreakdown[dateKey] !== undefined) {
      dailyBreakdown[dateKey]++;
    }
  });
  
  return {
    total: accessLogs.length,
    last24h: logs24h.length,
    last7d: logs7d.length,
    last30d: logs30d.length,
    uniqueVisitors24h,
    uniqueVisitors7d,
    uniqueVisitors30d,
    hourlyBreakdown,
    dailyBreakdown,
    recentLogs: accessLogs.slice(-50).reverse()
  };
}

async function cleanOldAccessLogs() {
  // Keep only last 90 days of access logs to prevent database bloat
  const accessLogs = await dbGetAll(STORE_ACCESS_LOGS);
  const cutoffDate = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000);
  
  let removed = 0;
  for (const log of accessLogs) {
    if (new Date(log.timestamp) < cutoffDate) {
      await dbDelete(STORE_ACCESS_LOGS, log.id);
      removed++;
    }
  }
  
  return removed;
}

// ----------------------------- Session Management -----------------------------
function createSession(account) {
  const sessionToken = generateToken();
  const csrfToken = generateToken();
  
  authState.isAuthenticated = true;
  authState.currentAccount = {
    username: account.username,
    email: account.email,
    createdAt: account.createdAt,
    linkedProfiles: account.linkedProfiles || [],
    role: account.role || 'user'
  };
  authState.sessionToken = sessionToken;
  authState.csrfToken = csrfToken;
  
  // Store session securely
  const session = {
    token: sessionToken,
    csrf: csrfToken,
    username: account.username,
    role: account.role || 'user',
    createdAt: Date.now(),
    expiresAt: Date.now() + SECURITY_CONFIG.SESSION_TIMEOUT_MS
  };
  
  saveLS('ft_session', session);
  logSecurityEvent('login_success', account.username, 'User logged in successfully');
  
  // Log page access after login
  logPageAccess().catch(err => console.error('Failed to log page access', err));
}

async function validateSession() {
  const session = loadLS('ft_session');
  
  if (!session) {
    return false;
  }
  
  // Check if session expired
  if (Date.now() > session.expiresAt) {
    destroySession();
    return false;
  }
  
  // Load account from database
  try {
    const account = await dbGet(STORE_ACCOUNTS, session.username);
    if (!account) {
      destroySession();
      return false;
    }
    
    authState.isAuthenticated = true;
    authState.currentAccount = {
      username: account.username,
      email: account.email,
      createdAt: account.createdAt,
      linkedProfiles: account.linkedProfiles || [],
      role: account.role || 'user'
    };
    authState.sessionToken = session.token;
    authState.csrfToken = session.csrf;
    
    return true;
  } catch (err) {
    console.error('Session validation failed', err);
    destroySession();
    return false;
  }
}

function destroySession() {
  if (authState.currentAccount) {
    logSecurityEvent('logout', authState.currentAccount.username, 'User logged out');
  }
  
  authState.isAuthenticated = false;
  authState.currentAccount = null;
  authState.sessionToken = null;
  authState.csrfToken = null;
  
  localStorage.removeItem('ft_session');
}

// ----------------------------- Registration -----------------------------
async function registerAccount(username, email, password) {
  // Rate limit check
  if (!checkRateLimit('register_' + username)) {
    throw new Error('Muitas tentativas de registro. Tente novamente em 1 minuto.');
  }
  
  // Validate inputs
  username = sanitizeInput(username);
  email = sanitizeInput(email);
  
  if (!validateUsername(username)) {
    throw new Error('Nome de usu√°rio inv√°lido. Use 3-20 caracteres alfanum√©ricos.');
  }
  
  if (!validateEmail(email)) {
    throw new Error('Email inv√°lido.');
  }
  
  const passwordCheck = validatePassword(password);
  if (!passwordCheck.valid) {
    throw new Error('Senha fraca:\n' + passwordCheck.errors.join('\n'));
  }
  
  // Check if username already exists
  const existingAccount = await dbGet(STORE_ACCOUNTS, username);
  if (existingAccount) {
    logSecurityEvent('register_failed', username, 'Username already exists');
    throw new Error('Nome de usu√°rio j√° existe.');
  }
  
  // Check if this is the first account - make it admin
  const allAccounts = await dbGetAll(STORE_ACCOUNTS);
  const isFirstAccount = allAccounts.length === 0;
  
  // Create account
  const salt = generateSalt();
  const passwordHash = await hashPassword(password, salt);
  
  const account = {
    username,
    email,
    passwordHash,
    salt,
    createdAt: new Date().toISOString(),
    lastLogin: null,
    linkedProfiles: [],
    twoFactorEnabled: false,
    accountLocked: false,
    role: isFirstAccount ? 'admin' : 'user' // First account is automatically admin
  };
  
  await dbPut(STORE_ACCOUNTS, account);
  logSecurityEvent('register_success', username, `New account created${isFirstAccount ? ' (first account - auto-promoted to admin)' : ''}`);
  
  return account;
}

// ----------------------------- Login -----------------------------
async function loginAccount(username, password) {
  // Rate limit check
  if (!checkRateLimit('login_' + username)) {
    throw new Error('Muitas tentativas de login. Tente novamente em 1 minuto.');
  }
  
  // Sanitize input
  username = sanitizeInput(username);
  
  // Check login attempts
  const attemptCheck = checkLoginAttempts(username);
  if (!attemptCheck.allowed) {
    logSecurityEvent('login_blocked', username, `Account locked for ${attemptCheck.lockedForMinutes} minutes`);
    throw new Error(`Conta bloqueada por ${attemptCheck.lockedForMinutes} minutos devido a muitas tentativas falhas.`);
  }
  
  // Get account
  const account = await dbGet(STORE_ACCOUNTS, username);
  if (!account) {
    recordFailedLogin(username);
    logSecurityEvent('login_failed', username, 'Account not found');
    throw new Error('Usu√°rio ou senha incorretos.');
  }
  
  // Check if account is locked
  if (account.accountLocked) {
    logSecurityEvent('login_blocked', username, 'Account is permanently locked');
    throw new Error('Conta bloqueada. Entre em contato com o administrador.');
  }
  
  // Verify password
  const passwordHash = await hashPassword(password, account.salt);
  if (passwordHash !== account.passwordHash) {
    recordFailedLogin(username);
    logSecurityEvent('login_failed', username, 'Invalid password');
    throw new Error('Usu√°rio ou senha incorretos.');
  }
  
  // Clear failed attempts
  clearFailedLoginAttempts(username);
  
  // Update last login
  account.lastLogin = new Date().toISOString();
  await dbPut(STORE_ACCOUNTS, account);
  
  // Create session
  createSession(account);
  
  return account;
}

// ----------------------------- Profile Linking -----------------------------
async function linkProfileToAccount(accountUsername, profileId) {
  const account = await dbGet(STORE_ACCOUNTS, accountUsername);
  if (!account) {
    throw new Error('Conta n√£o encontrada.');
  }
  
  if (!account.linkedProfiles) {
    account.linkedProfiles = [];
  }
  
  if (!account.linkedProfiles.includes(profileId)) {
    account.linkedProfiles.push(profileId);
    await dbPut(STORE_ACCOUNTS, account);
    logSecurityEvent('profile_linked', accountUsername, `Profile ${profileId} linked to account`);
  }
}

async function unlinkProfileFromAccount(accountUsername, profileId) {
  const account = await dbGet(STORE_ACCOUNTS, accountUsername);
  if (!account) {
    throw new Error('Conta n√£o encontrada.');
  }
  
  if (account.linkedProfiles) {
    account.linkedProfiles = account.linkedProfiles.filter(p => p !== profileId);
    await dbPut(STORE_ACCOUNTS, account);
    logSecurityEvent('profile_unlinked', accountUsername, `Profile ${profileId} unlinked from account`);
  }
}

// ============================= ADMIN & TASK MANAGEMENT SYSTEM (2025) =============================

// Check if user is admin
function isAdmin() {
  return authState.isAuthenticated && authState.currentAccount && authState.currentAccount.role === 'admin';
}

// Promote user to admin (can only be done programmatically or by existing admin)
async function promoteToAdmin(username) {
  if (!isAdmin() && authState.currentAccount && authState.currentAccount.username !== username) {
    throw new Error('Somente administradores podem promover outros usu√°rios.');
  }
  
  const account = await dbGet(STORE_ACCOUNTS, username);
  if (!account) {
    throw new Error('Conta n√£o encontrada.');
  }
  
  account.role = 'admin';
  await dbPut(STORE_ACCOUNTS, account);
  logSecurityEvent('admin_promotion', username, `User promoted to admin by ${authState.currentAccount ? authState.currentAccount.username : 'system'}`);
}

// ----------------------------- Task Management System -----------------------------

const TASK_PRIORITIES = {
  CRITICAL: 'critical',
  HIGH: 'high',
  MEDIUM: 'medium',
  LOW: 'low'
};

const TASK_STATUSES = {
  TODO: 'todo',
  IN_PROGRESS: 'in_progress',
  DONE: 'done',
  BLOCKED: 'blocked'
};

const TASK_CATEGORIES = {
  SHORT_TERM: 'short_term', // 1-2 weeks
  MEDIUM_TERM: 'medium_term', // 1-3 months
  LONG_TERM: 'long_term' // 3-6 months
};

// Initialize default tasks (short-term roadmap from problem statement)
const defaultShortTermTasks = [
  {
    id: 'task_fix_csp_headers',
    title: 'CR√çTICO: Corrigir headers CSP inv√°lidos em meta tags',
    description: 'Headers frame-ancestors e X-Frame-Options em meta tags causam erros no console. Devem ser movidos para headers HTTP do servidor.',
    category: TASK_CATEGORIES.SHORT_TERM,
    priority: TASK_PRIORITIES.CRITICAL,
    status: TASK_STATUSES.DONE,
    createdAt: new Date().toISOString(),
    dueDate: null,
    assignedTo: null,
    tags: ['bug', 'security', 'console-error'],
    checklist: [
      { id: 1, text: 'Remover frame-ancestors de meta tag', done: true },
      { id: 2, text: 'Remover X-Frame-Options de meta tag', done: true },
      { id: 3, text: 'Documentar necessidade de headers HTTP no servidor', done: true }
    ]
  },
  {
    id: 'task_fix_devtools_blocking',
    title: 'CR√çTICO: Remover c√≥digo de bloqueio de DevTools',
    description: 'C√≥digo que detecta e bloqueia DevTools causa m√° experi√™ncia do usu√°rio e impede debugging leg√≠timo.',
    category: TASK_CATEGORIES.SHORT_TERM,
    priority: TASK_PRIORITIES.CRITICAL,
    status: TASK_STATUSES.DONE,
    createdAt: new Date().toISOString(),
    dueDate: null,
    assignedTo: null,
    tags: ['bug', 'usability', 'security'],
    checklist: [
      { id: 1, text: 'Remover detec√ß√£o de DevTools', done: true },
      { id: 2, text: 'Remover bloqueio de atalhos de teclado', done: true },
      { id: 3, text: 'Remover bloqueio de clique direito', done: true },
      { id: 4, text: 'Remover bloqueio de sele√ß√£o de texto', done: true }
    ]
  },
  {
    id: 'task_deploy_https',
    title: 'Deploy em produ√ß√£o com HTTPS',
    description: 'Configurar deploy em produ√ß√£o com certificado SSL/TLS para acesso seguro via HTTPS',
    category: TASK_CATEGORIES.SHORT_TERM,
    priority: TASK_PRIORITIES.CRITICAL,
    status: TASK_STATUSES.TODO,
    createdAt: new Date().toISOString(),
    dueDate: null,
    assignedTo: null,
    tags: ['deploy', 'security', 'https'],
    checklist: [
      { id: 1, text: 'Obter certificado SSL (Let\'s Encrypt)', done: false },
      { id: 2, text: 'Configurar servidor para HTTPS', done: false },
      { id: 3, text: 'Testar conex√£o HTTPS', done: false },
      { id: 4, text: 'Redirecionar HTTP para HTTPS', done: false },
      { id: 5, text: 'Verificar seguran√ßa com SSL Labs', done: false }
    ]
  },
  {
    id: 'task_security_monitoring',
    title: 'Monitorar logs de seguran√ßa',
    description: 'Implementar dashboard de monitoramento de eventos de seguran√ßa e tentativas de acesso',
    category: TASK_CATEGORIES.SHORT_TERM,
    priority: TASK_PRIORITIES.CRITICAL,
    status: TASK_STATUSES.TODO,
    createdAt: new Date().toISOString(),
    dueDate: null,
    assignedTo: null,
    tags: ['security', 'monitoring', 'logs'],
    checklist: [
      { id: 1, text: 'Criar dashboard de eventos de seguran√ßa', done: false },
      { id: 2, text: 'Implementar alertas de atividade suspeita', done: false },
      { id: 3, text: 'Adicionar gr√°ficos de tentativas de login', done: false },
      { id: 4, text: 'Exportar logs para an√°lise', done: false },
      { id: 5, text: 'Criar relat√≥rio semanal de seguran√ßa', done: false }
    ]
  },
  {
    id: 'task_browser_testing',
    title: 'Testar em m√∫ltiplos navegadores',
    description: 'Realizar testes de compatibilidade em Chrome, Firefox, Safari e Edge',
    category: TASK_CATEGORIES.SHORT_TERM,
    priority: TASK_PRIORITIES.HIGH,
    status: TASK_STATUSES.TODO,
    createdAt: new Date().toISOString(),
    dueDate: null,
    assignedTo: null,
    tags: ['testing', 'browsers', 'compatibility'],
    checklist: [
      { id: 1, text: 'Testar no Chrome (desktop e mobile)', done: false },
      { id: 2, text: 'Testar no Firefox', done: false },
      { id: 3, text: 'Testar no Safari (macOS e iOS)', done: false },
      { id: 4, text: 'Testar no Edge', done: false },
      { id: 5, text: 'Documentar bugs encontrados', done: false },
      { id: 6, text: 'Corrigir bugs de compatibilidade', done: false }
    ]
  },
  {
    id: 'task_user_feedback',
    title: 'Coletar feedback de usu√°rios',
    description: 'Implementar sistema de coleta de feedback e sugest√µes dos usu√°rios',
    category: TASK_CATEGORIES.SHORT_TERM,
    priority: TASK_PRIORITIES.HIGH,
    status: TASK_STATUSES.TODO,
    createdAt: new Date().toISOString(),
    dueDate: null,
    assignedTo: null,
    tags: ['feedback', 'users', 'suggestions'],
    checklist: [
      { id: 1, text: 'Criar formul√°rio de feedback', done: false },
      { id: 2, text: 'Implementar sistema de sugest√µes', done: false },
      { id: 3, text: 'Adicionar vota√ß√£o em sugest√µes', done: false },
      { id: 4, text: 'Criar p√°gina de visualiza√ß√£o de sugest√µes', done: false },
      { id: 5, text: 'Exportar sugest√µes para GitHub Issues', done: false }
    ]
  }
];

// Initialize tasks in database
async function initializeTasks() {
  try {
    for (const task of defaultShortTermTasks) {
      const existing = await dbGet(STORE_TASKS, task.id);
      if (!existing) {
        await dbPut(STORE_TASKS, task);
      }
    }
  } catch (err) {
    console.error('Failed to initialize tasks', err);
  }
}

// Get all tasks
async function getAllTasks() {
  return await dbGetAll(STORE_TASKS);
}

// Get tasks by category
async function getTasksByCategory(category) {
  const tasks = await getAllTasks();
  return tasks.filter(t => t.category === category);
}

// Get tasks by status
async function getTasksByStatus(status) {
  const tasks = await getAllTasks();
  return tasks.filter(t => t.status === status);
}

// Create new task
async function createTask(taskData) {
  if (!isAdmin()) {
    throw new Error('Apenas administradores podem criar tarefas.');
  }
  
  const task = {
    id: 'task_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11),
    title: sanitizeInput(taskData.title),
    description: sanitizeInput(taskData.description),
    category: taskData.category || TASK_CATEGORIES.SHORT_TERM,
    priority: taskData.priority || TASK_PRIORITIES.MEDIUM,
    status: TASK_STATUSES.TODO,
    createdAt: new Date().toISOString(),
    dueDate: taskData.dueDate || null,
    assignedTo: taskData.assignedTo || null,
    tags: taskData.tags || [],
    checklist: taskData.checklist || [],
    createdBy: authState.currentAccount.username
  };
  
  await dbPut(STORE_TASKS, task);
  logSecurityEvent('task_created', authState.currentAccount.username, `Task created: ${task.title}`);
  return task;
}

// Update task
async function updateTask(taskId, updates) {
  if (!isAdmin()) {
    throw new Error('Apenas administradores podem atualizar tarefas.');
  }
  
  const task = await dbGet(STORE_TASKS, taskId);
  if (!task) {
    throw new Error('Tarefa n√£o encontrada.');
  }
  
  Object.assign(task, {
    ...updates,
    updatedAt: new Date().toISOString(),
    updatedBy: authState.currentAccount.username
  });
  
  await dbPut(STORE_TASKS, task);
  logSecurityEvent('task_updated', authState.currentAccount.username, `Task updated: ${task.title}`);
  return task;
}

// Toggle checklist item
async function toggleChecklistItem(taskId, checklistItemId) {
  if (!isAdmin()) {
    throw new Error('Apenas administradores podem atualizar tarefas.');
  }
  
  const task = await dbGet(STORE_TASKS, taskId);
  if (!task) {
    throw new Error('Tarefa n√£o encontrada.');
  }
  
  const item = task.checklist.find(i => i.id === checklistItemId);
  if (item) {
    item.done = !item.done;
    
    // Check if all items are done
    const allDone = task.checklist.every(i => i.done);
    if (allDone && task.status !== TASK_STATUSES.DONE) {
      task.status = TASK_STATUSES.DONE;
      task.completedAt = new Date().toISOString();
    }
    
    task.updatedAt = new Date().toISOString();
    task.updatedBy = authState.currentAccount.username;
    
    await dbPut(STORE_TASKS, task);
  }
  
  return task;
}

// Delete task
async function deleteTask(taskId) {
  if (!isAdmin()) {
    throw new Error('Apenas administradores podem deletar tarefas.');
  }
  
  const task = await dbGet(STORE_TASKS, taskId);
  if (task) {
    // Archive instead of delete
    await dbPut(STORE_ARCHIVE, {
      id: 'archived_task_' + taskId + '_' + Date.now(),
      type: 'task',
      data: task,
      archivedAt: new Date().toISOString(),
      archivedBy: authState.currentAccount.username
    });
    
    await dbDelete(STORE_TASKS, taskId);
    logSecurityEvent('task_deleted', authState.currentAccount.username, `Task archived: ${task.title}`);
  }
}

// ----------------------------- Suggestion System -----------------------------

// Submit suggestion
async function submitSuggestion(suggestionData) {
  if (!authState.isAuthenticated) {
    throw new Error('Voc√™ precisa estar logado para enviar sugest√µes.');
  }
  
  const suggestion = {
    id: 'suggestion_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11),
    title: sanitizeInput(suggestionData.title),
    description: sanitizeInput(suggestionData.description),
    category: sanitizeInput(suggestionData.category) || 'general',
    priority: suggestionData.priority || 'medium',
    status: 'pending', // pending, approved, rejected, implemented
    submittedBy: authState.currentAccount.username,
    submittedAt: new Date().toISOString(),
    votes: 0,
    votedBy: [],
    comments: []
  };
  
  await dbPut(STORE_SUGGESTIONS, suggestion);
  logSecurityEvent('suggestion_submitted', authState.currentAccount.username, `Suggestion: ${suggestion.title}`);
  return suggestion;
}

// Get all suggestions
async function getAllSuggestions() {
  return await dbGetAll(STORE_SUGGESTIONS);
}

// Vote on suggestion
async function voteSuggestion(suggestionId) {
  if (!authState.isAuthenticated) {
    throw new Error('Voc√™ precisa estar logado para votar.');
  }
  
  const suggestion = await dbGet(STORE_SUGGESTIONS, suggestionId);
  if (!suggestion) {
    throw new Error('Sugest√£o n√£o encontrada.');
  }
  
  const username = authState.currentAccount.username;
  
  // Toggle vote
  if (suggestion.votedBy.includes(username)) {
    suggestion.votes--;
    suggestion.votedBy = suggestion.votedBy.filter(u => u !== username);
  } else {
    suggestion.votes++;
    suggestion.votedBy.push(username);
  }
  
  await dbPut(STORE_SUGGESTIONS, suggestion);
  return suggestion;
}

// Update suggestion status (admin only)
async function updateSuggestionStatus(suggestionId, status, adminNote = '') {
  if (!isAdmin()) {
    throw new Error('Apenas administradores podem atualizar status de sugest√µes.');
  }
  
  const suggestion = await dbGet(STORE_SUGGESTIONS, suggestionId);
  if (!suggestion) {
    throw new Error('Sugest√£o n√£o encontrada.');
  }
  
  suggestion.status = status;
  suggestion.reviewedAt = new Date().toISOString();
  suggestion.reviewedBy = authState.currentAccount.username;
  suggestion.adminNote = sanitizeInput(adminNote);
  
  await dbPut(STORE_SUGGESTIONS, suggestion);
  logSecurityEvent('suggestion_reviewed', authState.currentAccount.username, `Suggestion ${suggestionId} status: ${status}`);
  return suggestion;
}

// Export suggestions to GitHub-like format
async function exportSuggestionsToGitHub() {
  if (!isAdmin()) {
    throw new Error('Apenas administradores podem exportar sugest√µes.');
  }
  
  const suggestions = await getAllSuggestions();
  const githubIssues = suggestions.map(s => ({
    title: s.title,
    body: `${s.description}\n\n---\n**Categoria:** ${s.category}\n**Prioridade:** ${s.priority}\n**Votos:** ${s.votes}\n**Submetido por:** ${s.submittedBy}\n**Data:** ${new Date(s.submittedAt).toLocaleDateString('pt-BR')}`,
    labels: [s.category, s.priority, s.status],
    assignees: []
  }));
  
  // Create markdown file
  let markdown = '# Sugest√µes de Usu√°rios - Pilgrim\n\n';
  markdown += `**Data de Exporta√ß√£o:** ${new Date().toLocaleString('pt-BR')}\n\n`;
  markdown += '---\n\n';
  
  const grouped = {
    pending: [],
    approved: [],
    rejected: [],
    implemented: []
  };
  
  suggestions.forEach(s => {
    grouped[s.status].push(s);
  });
  
  for (const [status, items] of Object.entries(grouped)) {
    if (items.length > 0) {
      markdown += `## ${status.toUpperCase()}\n\n`;
      items.forEach(s => {
        markdown += `### ${s.title}\n`;
        markdown += `- **Descri√ß√£o:** ${s.description}\n`;
        markdown += `- **Categoria:** ${s.category}\n`;
        markdown += `- **Prioridade:** ${s.priority}\n`;
        markdown += `- **Votos:** ${s.votes} üëç\n`;
        markdown += `- **Submetido por:** ${s.submittedBy}\n`;
        markdown += `- **Data:** ${new Date(s.submittedAt).toLocaleDateString('pt-BR')}\n`;
        if (s.adminNote) {
          markdown += `- **Nota do Admin:** ${s.adminNote}\n`;
        }
        markdown += '\n---\n\n';
      });
    }
  }
  
  return markdown;
}

// ----------------------------- Console Helper Functions (for manual admin management) -----------------------------
// These functions can be called from browser console for admin operations

// Usage: promoteUserToAdminConsole('username')
window.promoteUserToAdminConsole = async function(username) {
  try {
    await promoteToAdmin(username);
    console.log(`‚úÖ User ${username} promoted to admin successfully!`);
    alert(`User ${username} promoted to admin!`);
  } catch (err) {
    console.error('‚ùå Error:', err.message);
    alert('Error: ' + err.message);
  }
};

// Usage: listAllAccounts()
window.listAllAccounts = async function() {
  try {
    const accounts = await dbGetAll(STORE_ACCOUNTS);
    console.table(accounts.map(a => ({
      username: a.username,
      email: a.email,
      role: a.role || 'user',
      created: new Date(a.createdAt).toLocaleDateString(),
      lastLogin: a.lastLogin ? new Date(a.lastLogin).toLocaleDateString() : 'Never'
    })));
    return accounts;
  } catch (err) {
    console.error('Error:', err);
  }
};

// Usage: checkMyRole()
window.checkMyRole = function() {
  if (!authState.isAuthenticated) {
    console.log('‚ùå Not logged in');
    return null;
  }
  console.log(`Username: ${authState.currentAccount.username}`);
  console.log(`Role: ${authState.currentAccount.role || 'user'}`);
  console.log(`Is Admin: ${isAdmin() ? 'Yes ‚úÖ' : 'No'}`);
  return authState.currentAccount;
};

// ----------------------------- Load login attempts from storage -----------------------------
function loadLoginAttempts() {
  const attempts = loadLS('ft_login_attempts');
  if (attempts) {
    authState.loginAttempts = attempts;
  }
}

// ----------------------------- In-memory state -----------------------------
let state = {
  activeTab: 'dashboard',
  activeUser: 'pedro',
  users: {},
  comparisons: [],
  references: [],
  currentDay: new Date().toISOString().split('T')[0], // For day-by-day meal navigation
  currentWorkoutDay: new Date().toISOString().split('T')[0], // For day-by-day workout navigation
  customMeals: [], // User-defined meals with nutrition info
  progressPhotos: [], // Progress photos with date and metadata
  currentMealComposition: { // For building composed meals
    name: '',
    components: [], // Array of { foodName, weight, prot, carb, fat, kcal }
    totalProt: 0,
    totalCarb: 0,
    totalFat: 0,
    totalKcal: 0,
    totalWeight: 0
  }
};

// Chart holder
let muscleChart = null;

// ----------------------------- Seed users (verbose) -----------------------------
const initialUsers = (function() {
  const now = Date.now();
  return {
    pedro: {
      id: 'pedro',
      name: 'Pedro',
      gender: 'male',
      age: 30,
      height: 175,
      workoutHistory: [],
      mealHistory: [],
      workoutLogs: [],
      bodyMetrics: [{
        id: 'm_pedro_' + now,
        date: new Date().toISOString().split('T')[0],
        weight: 70.65,
        bodyFat: 19.9,
        muscleMass: 28.9,
        visceralFat: 8,
        waterPercent: 55.0,
        waterWeight: parseFloat((70.65 * 0.55).toFixed(2)),
        bmr: Math.round(10 * 70.65 + 6.25 * 175 - 5 * 30 + 5),
        muscleSize: 40,
        bmi: 23.1,
        // Segmented muscle mass (kg) - based on bioimpedance analysis
        muscleMassRightArm: 3.2,
        muscleMassLeftArm: 3.1,
        muscleMassRightLeg: 9.5,
        muscleMassLeftLeg: 9.4,
        muscleMassTrunk: 26.7,
        // Segmented body fat (%)
        bodyFatRightArm: 18.5,
        bodyFatLeftArm: 18.6,
        bodyFatRightLeg: 20.2,
        bodyFatLeftLeg: 20.3,
        bodyFatTrunk: 21.5,
        // Advanced body composition
        boneMass: 3.2, // kg - bone mineral content
        proteinMass: 13.5, // kg - protein content
        mineralMass: 4.1, // kg - mineral content
        // Metabolic rates
        rmr: 1580, // Resting Metabolic Rate (kcal/day)
        tdee: 2200, // Total Daily Energy Expenditure (kcal/day)
        // Bioelectrical impedance analysis
        impedance: 485, // Ohms - whole body impedance at 50kHz
        phaseAngle: 6.8, // degrees - cellular health indicator (normal: 5-7¬∞)
        reactance: 58, // Ohms
        resistance: 480, // Ohms
        // Ages and body composition indices
        metabolicAge: 28, // years - metabolic age
        bodyAge: 29, // years - biological/body age
        // Circumferences (cm) - for tracking muscle growth
        chest: 98,
        waist: 85,
        hips: 95,
        rightArm: 35,
        leftArm: 34.5,
        rightThigh: 58,
        leftThigh: 57.5,
        rightCalf: 38,
        leftCalf: 37.5,
        neck: 38,
        shoulders: 112
      }],
      goals: { weight: 75, bodyFat: 15, muscleMass: 32 },
      customPrograms: {},
      progressPhotos: []
    },
    valentina: {
      id: 'valentina',
      name: 'Valentina',
      gender: 'female',
      age: 28,
      height: 165,
      workoutHistory: [],
      mealHistory: [],
      workoutLogs: [],
      bodyMetrics: [{
        id: 'm_valentina_' + (now + 1),
        date: new Date().toISOString().split('T')[0],
        weight: 58,
        bodyFat: 25,
        muscleMass: 21,
        visceralFat: 5,
        waterPercent: 50,
        waterWeight: parseFloat((58 * 0.5).toFixed(2)),
        bmr: Math.round(10 * 58 + 6.25 * 165 - 5 * 28 - 161),
        muscleSize: 36,
        bmi: 21.3,
        // Segmented muscle mass (kg)
        muscleMassRightArm: 2.1,
        muscleMassLeftArm: 2.0,
        muscleMassRightLeg: 7.8,
        muscleMassLeftLeg: 7.7,
        muscleMassTrunk: 20.4,
        // Segmented body fat (%)
        bodyFatRightArm: 24.2,
        bodyFatLeftArm: 24.5,
        bodyFatRightLeg: 26.1,
        bodyFatLeftLeg: 26.3,
        bodyFatTrunk: 25.8,
        // Advanced body composition
        boneMass: 2.3,
        proteinMass: 10.2,
        mineralMass: 3.1,
        // Metabolic rates
        rmr: 1290,
        tdee: 1750,
        // Bioelectrical impedance
        impedance: 550,
        phaseAngle: 5.9,
        reactance: 52,
        resistance: 545,
        // Ages
        metabolicAge: 26,
        bodyAge: 27,
        // Circumferences (cm)
        chest: 88,
        waist: 68,
        hips: 92,
        rightArm: 28,
        leftArm: 27.5,
        rightThigh: 52,
        leftThigh: 51.5,
        rightCalf: 35,
        leftCalf: 34.5,
        neck: 32,
        shoulders: 96
      }],
      goals: { weight: 60, bodyFat: 22, muscleMass: 23 },
      customPrograms: {},
      progressPhotos: []
    }
  };
})();

/* ----------------------------- Templates (detailed) -----------------------------
   Each template contains sessions and each session contains exercises with:
     - name
     - sets (number)
     - reps (range or number)
     - rest (seconds suggested)
     - notes
     - estimatedTimeMin (optional) ‚Äî used for scheduling to fit 40-60min windows
   The templates below are created based on the literature references:
     Morton 2021 (volume -> hypertrophy),
     Schoenfeld 2023 (protein timing, hypertrophy cues),
     Curovic 2025 (metabolic stress techniques),
     Wang 2024 (creatine supplementation support).
   ---------------------------------------------------------------------------- */
const templates = {
  treino_1: {
    id: 'treino_1',
    name: 'Treino 1 - Upper Body',
    description: 'Peitoral, Costas, Ombros, B√≠ceps e Tr√≠ceps',
    sessions: {
      A: {
        name: 'Treino 1',
        exercises: [
          { name: 'Mobilidade Tor√°cica em P√©', sets: 2, reps: '', rest: 60, notes: 'Mobilidade n√£o precisa de reps' },
          { name: 'Supino Inclinado com Halteres', sets: 3, reps: '8-12', rest: 90, notes: '' },
          { name: 'Crucifixo na M√°quina', sets: 3, reps: '10-12', rest: 60, notes: '' },
          { name: 'Puxada na Barra Frente', sets: 3, reps: '8-12', rest: 90, notes: '' },
          { name: 'Remada Unilateral na M√°quina', sets: 3, reps: '10-12', rest: 60, notes: '' },
          { name: 'Bi-set: Desenvolvimento Arnold + Eleva√ß√£o Lateral', sets: 3, reps: '8-12', rest: 90, notes: 'Bi-set completo conta como 1 s√©rie' },
          { name: 'Bi-set: Rosca Alternada + Rosca Polia Baixa', sets: 3, reps: '10-12', rest: 60, notes: 'Bi-set completo conta como 1 s√©rie' },
          { name: 'Bi-set: Tr√≠ceps Testa Polia Alta + Tr√≠ceps Corda', sets: 3, reps: '10-12', rest: 60, notes: 'Bi-set completo conta como 1 s√©rie' }
        ],
        notes: 'Treino completo de upper body',
        primaryMuscles: ['Peitoral', 'Dorsal', 'Ombros', 'B√≠ceps', 'Tr√≠ceps']
      }
    },
    referencesTags: ['training','upper-body']
  },

  treino_2: {
    id: 'treino_2',
    name: 'Treino 2 - Lower Body',
    description: 'Pernas, Gl√∫teo, Panturrilha e Abdome',
    sessions: {
      A: {
        name: 'Treino 2',
        exercises: [
          { name: 'Mobilidade - Quadril (lateral)', sets: 2, reps: '', rest: 60, notes: 'Mobilidade n√£o precisa de reps' },
          { name: 'Mobilidade Quadril C√≥coras', sets: 2, reps: '', rest: 60, notes: 'Mobilidade n√£o precisa de reps' },
          { name: 'Agachamento (multi)', sets: 3, reps: '8-12', rest: 120, notes: '' },
          { name: 'Leg Press Horizontal (Subindo A Carga)', sets: 3, reps: '8-12', rest: 90, notes: 'Aumentar carga progressivamente' },
          { name: 'Agachamento (hack)', sets: 3, reps: '10-12', rest: 90, notes: '' },
          { name: 'Mesa Flexora (simult√¢nea)', sets: 3, reps: '10-12', rest: 60, notes: '' },
          { name: 'Cadeira Abdutora', sets: 3, reps: '12-15', rest: 60, notes: '' },
          { name: 'Cadeira Adutora', sets: 3, reps: '12-15', rest: 60, notes: '' },
          { name: 'Cadeira Extensora (simult√¢nea)', sets: 3, reps: '10-12', rest: 60, notes: '' },
          { name: 'Panturrilha (sentado)', sets: 3, reps: '15-20', rest: 60, notes: '' }
        ],
        notes: 'Treino completo de lower body',
        primaryMuscles: ['Abdutores', 'Anterior de coxa', 'Dorsal', 'Gl√∫teo', 'Panturrilha', 'Posterior de coxa', 'Quadr√≠ceps']
      }
    },
    referencesTags: ['training','legs','lower-body']
  }
};

/* ----------------------------- Studies seed (2020 ‚Üí 2025-11) -----------------------------
   This is the curated list of references used for notes in the UI. Keep them here for offline access.
   We intentionally store authors, year, title, journal, link and tags for search and UI linking.
--------------------------------------------------------------------------------------------- */
const scientificStudiesSeed = [
  { id: 'ref_phillips_2022', authors: 'Phillips SM. et al.', year: 2022, title: 'Protein Requirements and Muscle Mass/Strength in Athletes', journal: 'Sports Medicine', link: 'https://doi.org/10.1007/s40279-022-01680-9', tags: ['nutrition','protein'], summary: 'Revis√£o: recomenda√ß√µes de prote√≠na 1.6‚Äì2.2 g/kg/d e distribui√ß√£o.' },
  { id: 'ref_schoenfeld_2023', authors: 'Schoenfeld BJ., Krieger JW.', year: 2023, title: 'Protein timing meta-analysis', journal: 'Journal of the International Society of Sports Nutrition', link: 'https://doi.org/10.1186/s12970-023-00496-7', tags: ['nutrition','protein','timing'], summary: 'Timing √∫til, total di√°rio √© determinante.' },
  { id: 'ref_morton_2021', authors: 'Morton RW. et al.', year: 2021, title: 'Resistance Training Volume Enhances Muscle Hypertrophy but Not Strength in Trained Men', journal: 'Medicine & Science in Sports & Exercise', link: 'https://doi.org/10.1249/MSS.0000000000002585', tags: ['training','volume','hypertrophy'], summary: 'Volume correlaciona com hipertrofia.' },
  { id: 'ref_nutrients_creatine_2024', authors: 'Wang Z. et al.', year: 2024, title: 'Effects of Creatine Supplementation and Resistance Training on Muscle Strength Gains in Adults <50 Years', journal: 'Nutrients', link: 'https://www.mdpi.com/2072-6643/16/21/3665', tags: ['supplement','creatine'], summary: 'Creatina consistente para for√ßa/hipertrofia.' },
  { id: 'ref_bilsborough_2020', authors: 'Bilsborough SA., Crowe TC.', year: 2020, title: 'Low‚ÄëCarbohydrate Diets and Body Composition: Implications for Resistance Trained Athletes', journal: 'Nutrients', link: 'https://www.mdpi.com/2072-6643/12/10/3105', tags: ['nutrition','diet'], summary: 'Discuss√£o sobre low-carb em atletas.' },
  { id: 'ref_frontiers_2025', authors: 'Curovic I.', year: 2025, title: 'The role of resistance exercise-induced local metabolic stress...', journal: 'Frontiers in Physiology', link: 'https://www.frontiersin.org/articles/10.3389/fphys.2025.1549609/full', tags: ['training','metabolic-stress'], summary: 'T√©cnicas de estresse metab√≥lico (BFR, supersets).' },
  { id: 'ref_jhpn_2025', authors: 'Chen W.', year: 2025, title: 'Nutritional interventions in muscle hypertrophy research: a scientometric analysis (1992‚Äì2025)', journal: 'Journal of Health, Population and Nutrition', link: 'https://jhpn.biomedcentral.com/articles/10.1186/s41043-025-01031-w', tags: ['nutrition','review'], summary: 'Mapeamento das interven√ß√µes nutricionais em hipertrofia.' },
  { id: 'ref_xie_2025', authors: 'Xie Y. et al.', year: 2025, title: 'Comparing exercise modalities during caloric restriction', journal: 'Systematic Review', link: 'https://pubmed.ncbi.nlm.nih.gov/39185113/', tags: ['training','diet','restriction'], summary: 'Combinar RT e aer√≥bico preserva massa magra.' },
  { id: 'ref_maturitas_2025', authors: 'Various', year: 2025, title: 'RT effects on glycemic control & body composition in older adults with T2D', journal: 'Maturitas', link: 'https://www.maturitas.org/article/S0378-5122(25)00499-2/fulltext', tags: ['training','clinical'], summary: 'RT melhora composi√ß√£o e marcadores metab√≥licos.' },
  { id: 'ref_strongerbyscience_2024', authors: 'StrongerByScience', year: 2024, title: 'Muscle Growth: Master List', journal: 'Resource', link: 'https://www.strongerbyscience.com/master-list/muscle-growth/', tags: ['review','meta-analysis'], summary: 'Compila√ß√£o de meta-an√°lises sobre hipertrofia.' },
  { id: 'ref_almeida_2024', authors: 'Almeida NC. et al.', year: 2024, title: 'An√°lise das estrat√©gias de nutri√ß√£o e suplementa√ß√£o na recomposi√ß√£o corporal', journal: 'Revista Fisioterapia em Movimento', link: 'https://revistaft.com.br/analise-das-estrategias-de-nutricao-e-suplmentacao-na-recomposicao-corporal-em-praticantes-de-musculacao/', tags: ['nutrition','supplement','pt'], summary: 'Revis√£o em PT sobre suplementa√ß√£o.' }
];

/* ----------------------------- LiveUp marmitas ‚Äî RESTAURADAS (completas) -----------------------------
   Voc√™ pediu explicitamente a restaura√ß√£o das Marmitas LiveUp que foram anteriores no projeto.
   Aqui eu coloco uma lista longa e verbosa com todos os itens que estavam antes (e mais alguns).
   Cada objeto: { name, category, size, kcal, prot, fat, notes(optional) }
   ------------------------------------------------------------------------------- */
const livUpMarmitas = [
  { name: 'Frango cremoso, arroz, feij√£o e br√≥colis no vapor', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Alm√¥ndega de frango, arroz 7 gr√£os', category: 'Baixa caloria at√© 350kcal', size: '300g', kcal: '340', prot: '28', fat: '9', notes: '' },
  { name: 'Feijoada light', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Carne louca com pur√™ de mandioquinha', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Frango grelhado com legumes', category: 'Baixa caloria', size: '300g', kcal: '320', prot: '30', fat: '7', notes: '' },
  { name: 'Salm√£o com quinoa e vegetais', category: 'Premium', size: '300g', kcal: '480', prot: '34', fat: '20', notes: '' },
  { name: 'Bife de soja com arroz integral', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Picadinho de carne com batata doce', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Omelete de legumes com salada', category: 'Baixa caloria', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Peito de peru com couscous marroquino', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Frango com lim√£o siciliano, arroz jasmim e br√≥colis', category: 'Dia a dia', size: '380g', kcal: '444', prot: '36', fat: '12', notes: '' },
  { name: 'Saint Peter com cebolinha, arroz jasmim e cenoura', category: 'Dia a dia', size: '380g', kcal: '426', prot: '25', fat: '14', notes: '' },
  { name: 'Falafel, couscous e legumes mediterr√¢neos', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Lentilha pomodoro, arroz de jasmim e br√≥colis', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Estrogonofe de cogumelo, arroz integral', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Iscas de fil√© mignon acebolado', category: 'Premium', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Posta de salm√£o assado', category: 'Premium', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Bolinha low carb de ab√≥bora e carne com chia', category: 'Low Carb', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Frango oriental, arroz com am√™ndoas e legumes', category: 'Performance', size: '580g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Carne mo√≠da, arroz e vegetais', category: 'Performance', size: '580g', kcal: '', prot: '', fat: '', notes: '' },
  /* Adicionalmente, restaurando itens mais antigos que estavam no repo em vers√µes anteriores: */
  { name: 'Peito de frango grelhado com batata doce e br√≥colis', category: 'Performance', size: '500g', kcal: '600', prot: '48', fat: '12', notes: '' },
  { name: 'Til√°pia ao forno com legumes e arroz integral', category: 'Dia a dia', size: '350g', kcal: '420', prot: '32', fat: '10', notes: '' },
  { name: 'Estrogonofe de frango com arroz integral', category: 'Dia a dia', size: '350g', kcal: '520', prot: '36', fat: '18', notes: '' },
  { name: 'Quinoa bowl com gr√£o-de-bico e legumes', category: 'Vegetariano', size: '350g', kcal: '420', prot: '18', fat: '14', notes: '' },
  { name: 'Bife acebolado com pur√™ de batata doce', category: 'Dia a dia', size: '400g', kcal: '650', prot: '45', fat: '28', notes: '' }
  // se voc√™ tinha outros itens espec√≠ficos, me diga e eu adiciono aqui
];

/* ----------------------------- Common Foods Database (Brazilian Foods) -----------------------------
   Comprehensive database of common Brazilian foods with nutritional information per 100g
   This helps users quickly calculate macros without having to search external sources
   Values are approximate and based on TACO (Brazilian Food Composition Table)
---------------------------------------------------------------------------------------------------- */
const commonFoods = {
  proteinas: [
    { name: 'Peito de frango (cru)', prot: 31, carb: 0, fat: 3.6, per: 100, unit: 'g', kcal: 165 },
    { name: 'Peito de frango (grelhado)', prot: 32, carb: 0, fat: 3.8, per: 100, unit: 'g', kcal: 172 },
    { name: 'Til√°pia (crua)', prot: 26, carb: 0, fat: 3, per: 100, unit: 'g', kcal: 129 },
    { name: 'Ovo inteiro (cozido)', prot: 6.3, carb: 0.6, fat: 5, per: 1, unit: 'unidade (50g)', kcal: 72 },
    { name: 'Clara de ovo (cozida)', prot: 3.6, carb: 0.2, fat: 0.1, per: 1, unit: 'unidade (33g)', kcal: 17 },
    { name: 'Carne bovina magra (patinho)', prot: 26, carb: 0, fat: 8, per: 100, unit: 'g', kcal: 180 },
    { name: 'Carne mo√≠da (20% gordura)', prot: 20, carb: 0, fat: 15, per: 100, unit: 'g', kcal: 220 },
    { name: 'Atum em lata (conserva)', prot: 24, carb: 0, fat: 1, per: 100, unit: 'g', kcal: 116 },
    { name: 'Salm√£o (cru)', prot: 20, carb: 0, fat: 13, per: 100, unit: 'g', kcal: 208 },
    { name: 'Whey protein (isolado)', prot: 25, carb: 3, fat: 1.5, per: 30, unit: 'g (1 scoop)', kcal: 120 },
    { name: 'Queijo cottage', prot: 12, carb: 3, fat: 4, per: 100, unit: 'g', kcal: 98 },
    { name: 'Iogurte grego natural', prot: 10, carb: 4, fat: 5, per: 100, unit: 'g', kcal: 97 },
    { name: 'Feij√£o preto (cozido)', prot: 4.5, carb: 14, fat: 0.5, per: 100, unit: 'g', kcal: 77 },
    { name: 'Lentilha (cozida)', prot: 9, carb: 20, fat: 0.4, per: 100, unit: 'g', kcal: 116 },
    { name: 'Gr√£o-de-bico (cozido)', prot: 8.9, carb: 27.4, fat: 2.6, per: 100, unit: 'g', kcal: 164 },
  ],
  carboidratos: [
    { name: 'Arroz branco (cozido)', prot: 2.5, carb: 28, fat: 0.3, per: 100, unit: 'g', kcal: 130 },
    { name: 'Arroz integral (cozido)', prot: 2.6, carb: 23, fat: 0.9, per: 100, unit: 'g', kcal: 111 },
    { name: 'Batata doce (cozida)', prot: 1.6, carb: 20, fat: 0.1, per: 100, unit: 'g', kcal: 86 },
    { name: 'Batata inglesa (cozida)', prot: 2, carb: 17, fat: 0.1, per: 100, unit: 'g', kcal: 77 },
    { name: 'Mandioca/Aipim (cozida)', prot: 0.6, carb: 30, fat: 0.3, per: 100, unit: 'g', kcal: 125 },
    { name: 'Aveia em flocos', prot: 13.9, carb: 66.3, fat: 6.9, per: 100, unit: 'g', kcal: 394 },
    { name: 'P√£o franc√™s', prot: 8, carb: 58, fat: 3.1, per: 50, unit: 'g (1 unid)', kcal: 300 },
    { name: 'P√£o integral', prot: 9, carb: 49, fat: 3.5, per: 100, unit: 'g', kcal: 265 },
    { name: 'Macarr√£o (cozido)', prot: 5, carb: 30, fat: 0.9, per: 100, unit: 'g', kcal: 157 },
    { name: 'Tapioca (crepioca)', prot: 0.2, carb: 26, fat: 0, per: 100, unit: 'g', kcal: 98 },
    { name: 'Banana (prata)', prot: 1.3, carb: 26, fat: 0.1, per: 100, unit: 'g', kcal: 98 },
    { name: 'Ma√ß√£', prot: 0.3, carb: 14, fat: 0.2, per: 100, unit: 'g', kcal: 52 },
    { name: 'Quinoa (cozida)', prot: 4.4, carb: 21.3, fat: 1.9, per: 100, unit: 'g', kcal: 120 },
  ],
  gorduras: [
    { name: 'Azeite de oliva extra virgem', prot: 0, carb: 0, fat: 13.5, per: 15, unit: 'ml (1 col sopa)', kcal: 120 },
    { name: '√ìleo de coco', prot: 0, carb: 0, fat: 13.6, per: 15, unit: 'ml (1 col sopa)', kcal: 120 },
    { name: 'Manteiga', prot: 0.6, carb: 0.1, fat: 11.5, per: 15, unit: 'g (1 col sopa)', kcal: 102 },
    { name: 'Amendoim', prot: 26, carb: 16, fat: 49, per: 100, unit: 'g', kcal: 567 },
    { name: 'Pasta de amendoim', prot: 25, carb: 20, fat: 50, per: 100, unit: 'g', kcal: 588 },
    { name: 'Castanha do Par√°', prot: 14, carb: 12, fat: 67, per: 100, unit: 'g', kcal: 656 },
    { name: 'Castanha de caju', prot: 18, carb: 30, fat: 43, per: 100, unit: 'g', kcal: 553 },
    { name: 'Am√™ndoas', prot: 21, carb: 22, fat: 50, per: 100, unit: 'g', kcal: 579 },
    { name: 'Abacate', prot: 2, carb: 9, fat: 15, per: 100, unit: 'g', kcal: 160 },
    { name: 'Coco ralado', prot: 3.3, carb: 15, fat: 33, per: 100, unit: 'g', kcal: 354 },
    { name: 'Semente de chia', prot: 17, carb: 42, fat: 31, per: 100, unit: 'g', kcal: 486 },
    { name: 'Semente de linha√ßa', prot: 18, carb: 29, fat: 42, per: 100, unit: 'g', kcal: 534 },
  ],
  vegetais: [
    { name: 'Br√≥colis (cozido)', prot: 2.4, carb: 4, fat: 0.4, per: 100, unit: 'g', kcal: 35 },
    { name: 'Couve-flor (cozida)', prot: 1.8, carb: 2.3, fat: 0.5, per: 100, unit: 'g', kcal: 23 },
    { name: 'Espinafre (cru)', prot: 2.9, carb: 1.4, fat: 0.4, per: 100, unit: 'g', kcal: 23 },
    { name: 'Alface', prot: 1.4, carb: 2.3, fat: 0.2, per: 100, unit: 'g', kcal: 15 },
    { name: 'Tomate', prot: 1.1, carb: 3.9, fat: 0.2, per: 100, unit: 'g', kcal: 18 },
    { name: 'Cenoura (crua)', prot: 0.9, carb: 10, fat: 0.2, per: 100, unit: 'g', kcal: 41 },
    { name: 'Ab√≥bora (cozida)', prot: 1.2, carb: 6.5, fat: 0.1, per: 100, unit: 'g', kcal: 30 },
  ]
};

/* ----------------------------- Utilities ----------------------------- */
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function parseNumber(value) {
  if (!value && value !== 0) return 0;
  const n = parseFloat(String(value).replace(/[^\d.-]/g, ''));
  return isNaN(n) ? 0 : n;
}

// Combined meal nutrition lookup: prioritize custom meals, then LiveUp marmitas
function getMealNutritionByNameCombined(name) {
  // First check custom meals
  const customMeal = state.customMeals.find(m => m.name === name);
  if (customMeal) {
    return { 
      kcal: parseNumber(customMeal.kcal), 
      prot: parseNumber(customMeal.prot), 
      fat: parseNumber(customMeal.fat) 
    };
  }
  // Then check LiveUp marmitas
  const liveUpMeal = livUpMarmitas.find(m => m.name === name);
  if (liveUpMeal) {
    return { 
      kcal: parseNumber(liveUpMeal.kcal), 
      prot: parseNumber(liveUpMeal.prot), 
      fat: parseNumber(liveUpMeal.fat) 
    };
  }
  // Default values if not found
  return { kcal: 0, prot: 0, fat: 0 };
}

// Legacy function for backward compatibility
function getMealNutritionByName(name) {
  return getMealNutritionByNameCombined(name);
}

/* ----------------------------- Persistence: Save / Load ----------------------------- */
async function saveAllToDB() {
  try {
    // users
    for (const id of Object.keys(state.users)) {
      await dbPut(STORE_USERS, state.users[id]);
    }
    // comparisons
    for (const comp of state.comparisons) {
      await dbPut(STORE_COMPARISONS, comp);
    }
    // references
    for (const ref of state.references) {
      await dbPut(STORE_REFERENCES, ref);
    }
    // settings: store lastSave timestamp
    await dbPut(STORE_SETTINGS, { key: 'lastSave', value: new Date().toISOString() });

    // fallback localStorage
    saveLS('ft_users', state.users);
    saveLS('ft_comparisons', state.comparisons);
    saveLS('ft_references', state.references);
  } catch (err) {
    console.error('saveAllToDB error', err);
  }
}

async function loadAllFromDB() {
  let users = {};
  let comparisons = [];
  let references = [];
  try {
    const dbUsers = await dbGetAll(STORE_USERS);
    const dbComparisons = await dbGetAll(STORE_COMPARISONS);
    const dbReferences = await dbGetAll(STORE_REFERENCES);
    if (dbUsers && dbUsers.length) dbUsers.forEach(u => users[u.id] = u);
    if (dbComparisons && dbComparisons.length) comparisons = dbComparisons;
    if (dbReferences && dbReferences.length) references = dbReferences;
  } catch (err) {
    console.warn('DB load failed, fallback to localStorage', err);
  }

  // fallback localStorage if empty
  if (Object.keys(users).length === 0) {
    const lsUsers = loadLS('ft_users');
    if (lsUsers) users = lsUsers;
  }
  if (!comparisons.length) {
    const lsComparisons = loadLS('ft_comparisons');
    if (lsComparisons) comparisons = lsComparisons;
  }
  if (!references.length) {
    const lsReferences = loadLS('ft_references');
    if (lsReferences) references = lsReferences;
  }

  // Legacy migration: ft_custom_programs
  const legacyPrograms = loadLS('ft_custom_programs');
  if (legacyPrograms && typeof legacyPrograms === 'object') {
    Object.keys(legacyPrograms).forEach(uid => {
      if (!users[uid]) return;
      users[uid].customPrograms = users[uid].customPrograms || {};
      // merge but do not overwrite existing keys
      Object.keys(legacyPrograms[uid]).forEach(k => {
        if (!users[uid].customPrograms[k]) users[uid].customPrograms[k] = legacyPrograms[uid][k];
      });
    });
    // do not delete legacy key automatically
  }

  // If no users exist in DB/LS, seed defaults (but do not overwrite if user has data)
  if (Object.keys(users).length === 0) {
    users = initialUsers;
    comparisons = [];
    references = []; // keep empty until user imports seed references to avoid accidental overwrite
    state.users = users;
    state.comparisons = comparisons;
    state.references = references;
    await saveAllToDB();
  } else {
    state.users = users;
    state.comparisons = comparisons;
    state.references = references;
  }

  // Ensure all users have workoutLogs array (migration for new feature)
  Object.keys(state.users).forEach(userId => {
    if (!state.users[userId].workoutLogs) {
      state.users[userId].workoutLogs = [];
    }
  });
}

/* ----------------------------- Custom Meals Management -----------------------------
   Load and save custom meals from/to IndexedDB settings store and localStorage fallback
-------------------------------------------------------------------------------------------- */
async function loadCustomMeals() {
  try {
    const customMealsData = await dbGet(STORE_SETTINGS, 'customMeals').catch(() => null);
    if (customMealsData && customMealsData.value) {
      state.customMeals = customMealsData.value;
      return;
    }
  } catch (err) {
    console.warn('Failed to load custom meals from IndexedDB', err);
  }
  
  // Fallback to localStorage
  const lsCustomMeals = loadLS('ft_custom_meals');
  if (lsCustomMeals && Array.isArray(lsCustomMeals)) {
    state.customMeals = lsCustomMeals;
  } else {
    state.customMeals = [];
  }
}

async function saveCustomMeals() {
  try {
    await dbPut(STORE_SETTINGS, { key: 'customMeals', value: state.customMeals });
  } catch (err) {
    console.error('Failed to save custom meals to IndexedDB', err);
  }
  
  // Also save to localStorage as fallback
  saveLS('ft_custom_meals', state.customMeals);
}

/* ----------------------------- Progress Photos Management -----------------------------
   Load and save progress photos from/to IndexedDB settings store and localStorage fallback
-------------------------------------------------------------------------------------------- */
async function loadProgressPhotos() {
  const user = state.users[state.activeUser];
  if (!user) return;
  
  if (!user.progressPhotos) {
    user.progressPhotos = [];
  }
  state.progressPhotos = user.progressPhotos;
}

async function saveProgressPhotos() {
  const user = state.users[state.activeUser];
  if (!user) return;
  
  user.progressPhotos = state.progressPhotos;
  addOrUpdateUser(user);
}

function handleAddProgressPhoto(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const date = formData.get('photoDate');
  const notes = formData.get('photoNotes');
  const fileInput = document.querySelector('input[name="photoFile"]');
  const file = fileInput.files[0];
  
  if (!date || !file) {
    alert('Data e foto s√£o obrigat√≥rios');
    return;
  }
  
  // Check file size (limit to 5MB)
  if (file.size > 5 * 1024 * 1024) {
    alert('A foto √© muito grande. M√°ximo 5MB.');
    return;
  }
  
  // Read the file as base64
  const reader = new FileReader();
  reader.onload = async function(event) {
    const photoData = {
      id: 'photo_' + Date.now(),
      date: date,
      notes: notes || '',
      imageData: event.target.result,
      uploadedAt: new Date().toISOString()
    };
    
    state.progressPhotos.push(photoData);
    await saveProgressPhotos();
    
    showNotification('‚úÖ Foto de progresso adicionada com sucesso!', 'success');
    e.target.reset();
    render();
  };
  reader.readAsDataURL(file);
}

function handleDeleteProgressPhoto(photoId) {
  if (!confirm('Deseja excluir esta foto de progresso?')) return;
  
  state.progressPhotos = state.progressPhotos.filter(p => p.id !== photoId);
  saveProgressPhotos();
  showNotification('‚úÖ Foto exclu√≠da', 'success');
  render();
}

/* ----------------------------- Soft-delete / Archive workflow -----------------------------
   Instead of permanently deleting, we move to 'archive' store with metadata:
     { id, originStore, originId, type, payload, deletedAt, deletedBy }
   Only with explicit user action "Excluir permanentemente do arquivo" will we remove it from 'archive'.
---------------------------------------------------------------------------------------------- */
async function archiveItem(originStore, originId, type, payload) {
  const archiveId = `arch_${type}_${originId}_${Date.now()}`;
  const item = {
    id: archiveId,
    originStore,
    originId,
    type,
    payload,
    deletedAt: new Date().toISOString(),
    deletedBy: state.activeUser || 'system'
  };
  await dbPut(STORE_ARCHIVE, item);
  return item;
}

async function softDeleteUser(userId) {
  if (!confirm('Tem certeza que deseja mover este perfil para o arquivo (archive)? Isso preservar√° os dados no archive.')) return;
  const user = state.users[userId];
  if (!user) { alert('Perfil n√£o encontrado'); return; }
  // move to archive
  await archiveItem(STORE_USERS, userId, 'user', user);
  // delete from users store and state
  delete state.users[userId];
  try { await dbDelete(STORE_USERS, userId); } catch (e) {}
  saveLS('ft_users', state.users);
  updateState({ users: state.users });
  alert('‚úÖ Perfil movido para arquivo (archive). Para excluir permanentemente v√° na aba Ci√™ncia ‚Üí Gerenciar arquivo.');
}

/* ----------------------------- State helpers ----------------------------- */
function updateState(newState) {
  state = { ...state, ...newState };
  saveAllToDB();
  render();
}

function addOrUpdateUser(user) {
  state.users[user.id] = user;
  updateState({ users: state.users });
}

function removeUserPermanentlyFromArchive(archiveId) {
  // Will delete entry permanently from archive - only after explicit confirmation
  if (!confirm('Excluir permanentemente este item do arquivo? Esta a√ß√£o N√ÉO pode ser desfeita.')) return;
  dbDelete(STORE_ARCHIVE, archiveId).then(() => alert('Item exclu√≠do permanentemente do archive')).catch(err => alert('Erro ao excluir: ' + err));
}

/* ----------------------------- Exercise History and Analytics ----------------------------- */
function getExerciseHistory(user, exerciseName) {
  if (!user.workoutHistory) return [];
  
  return user.workoutHistory
    .filter(w => w.exercise === exerciseName)
    .sort((a, b) => new Date(a.date) - new Date(b.date));
}

function getAllUniqueExercises(user) {
  if (!user.workoutHistory) return [];
  
  const exercises = new Set();
  user.workoutHistory.forEach(w => {
    if (w.exercise) exercises.add(w.exercise);
  });
  
  return Array.from(exercises).sort();
}

function getExerciseStats(user, exerciseName) {
  const history = getExerciseHistory(user, exerciseName);
  
  if (history.length === 0) {
    return {
      totalWorkouts: 0,
      firstWorkout: null,
      lastWorkout: null,
      maxWeight: 0,
      maxReps: 0,
      maxVolume: 0
    };
  }
  
  let maxWeight = 0;
  let maxReps = 0;
  let maxVolume = 0;
  
  history.forEach(w => {
    const weight = parseNumber(w.weight);
    const reps = parseNumber(w.reps);
    const sets = parseNumber(w.sets);
    const volume = weight * reps * sets;
    
    if (weight > maxWeight) maxWeight = weight;
    if (reps > maxReps) maxReps = reps;
    if (volume > maxVolume) maxVolume = volume;
  });
  
  return {
    totalWorkouts: history.length,
    firstWorkout: history[0].date,
    lastWorkout: history[history.length - 1].date,
    maxWeight: maxWeight,
    maxReps: maxReps,
    maxVolume: maxVolume
  };
}

/* ----------------------------- Handlers (workout / meal / metrics) ----------------------------- */
function handleLogWorkout(exerciseName, sets = '', reps = '', weight = '', category = '') {
  const user = state.users[state.activeUser];
  if (!user) return alert('Nenhum usu√°rio ativo');
  
  const newLog = {
    id: Date.now(),
    date: state.currentWorkoutDay, // Use selected day instead of today
    time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
    exercise: exerciseName,
    category: category || '',
    sets: sets || '-',
    reps: reps || '-',
    weight: weight || '-',
    completed: true
  };
  
  if (!user.workoutHistory) user.workoutHistory = [];
  user.workoutHistory.unshift(newLog);
  addOrUpdateUser(user);
  
  // Show success notification
  const details = sets && reps ? ` (${sets}x${reps}${weight ? ' @ ' + weight + 'kg' : ''})` : '';
  showNotification(`‚úÖ Exerc√≠cio registrado: ${exerciseName}${details}`, 'success');
  render();
}

function handleEditWorkout(id) {
  const user = state.users[state.activeUser];
  if (!user.workoutHistory) user.workoutHistory = [];
  const log = user.workoutHistory.find(l => l.id === id);
  if (!log) return alert('Registro n√£o encontrado');
  
  // Prompt for new values
  const newSets = prompt(`Editar S√©ries\nExerc√≠cio: ${log.exercise}\n\nS√©ries atuais: ${log.sets}`, log.sets === '-' ? '' : log.sets);
  if (newSets === null) return; // User cancelled
  
  const newReps = prompt(`Editar Repeti√ß√µes\nExerc√≠cio: ${log.exercise}\n\nRepeti√ß√µes atuais: ${log.reps}`, log.reps === '-' ? '' : log.reps);
  if (newReps === null) return; // User cancelled
  
  const newWeight = prompt(`Editar Carga (kg)\nExerc√≠cio: ${log.exercise}\n\nCarga atual: ${log.weight}`, log.weight === '-' ? '' : log.weight);
  if (newWeight === null) return; // User cancelled
  
  // Update the workout log
  log.sets = newSets || '-';
  log.reps = newReps || '-';
  log.weight = newWeight || '-';
  
  addOrUpdateUser(user);
  
  // Show success notification
  const details = newSets && newReps ? ` (${newSets}x${newReps}${newWeight ? ' @ ' + newWeight + 'kg' : ''})` : '';
  showNotification(`‚úÖ Treino atualizado: ${log.exercise}${details}`, 'success');
  render();
}

function handleDeleteWorkout(id) {
  if (!confirm('Deseja excluir este registro de treino? Ele ser√° movido para o arquivo (archive) e poder√° ser restaurado.')) return;
  const user = state.users[state.activeUser];
  if (!user.workoutHistory) user.workoutHistory = [];
  const log = user.workoutHistory.find(l => l.id === id);
  if (!log) return alert('Registro n√£o encontrado');
  archiveItem('workoutHistory', id, 'workout', log).then(() => {
    user.workoutHistory = user.workoutHistory.filter(l => l.id !== id);
    addOrUpdateUser(user);
    showNotification('‚úÖ Registro de treino exclu√≠do e movido para archive', 'success');
    render();
  });
}

function handleLogMeal(mealName) {
  const user = state.users[state.activeUser];
  if (!user) return alert('Nenhum usu√°rio ativo');
  // Use currentDay for meal logging, make meal name safe for storage
  const safeMealName = String(mealName); // Ensure it's a string, handles special characters
  const newLog = { 
    id: Date.now(), 
    date: state.currentDay, // Use selected day instead of today
    time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), 
    meal: safeMealName 
  };
  user.mealHistory.unshift(newLog);
  addOrUpdateUser(user);
  
  // Show success notification
  const nut = getMealNutritionByNameCombined(safeMealName);
  const nutInfo = nut.kcal > 0 ? ` (${nut.kcal} kcal)` : '';
  showNotification(`‚úÖ Refei√ß√£o registrada: ${safeMealName}${nutInfo}`, 'success');
}

function handleDeleteMeal(id) {
  if (!confirm('Deseja excluir este registro de refei√ß√£o? Ele ser√° movido para o arquivo (archive) e poder√° ser restaurado.')) return;
  const user = state.users[state.activeUser];
  const item = user.mealHistory.find(m => m.id === id);
  if (!item) return alert('Registro n√£o encontrado');
  archiveItem('mealHistory', id, 'meal', item).then(() => {
    user.mealHistory = user.mealHistory.filter(m => m.id !== id);
    addOrUpdateUser(user);
    showNotification('‚úÖ Registro de refei√ß√£o exclu√≠do e movido para archive', 'success');
  });
}

/* ----------------------------- Notification System ----------------------------- */
function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `fixed top-20 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-semibold transform transition-all duration-300 ${
    type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
  }`;
  notification.textContent = message;
  notification.style.opacity = '0';
  notification.style.transform = 'translateY(-20px)';
  
  document.body.appendChild(notification);
  
  // Animate in
  setTimeout(() => {
    notification.style.opacity = '1';
    notification.style.transform = 'translateY(0)';
  }, 10);
  
  // Animate out and remove
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translateY(-20px)';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

/* ----------------------------- Day navigation for meals ----------------------------- */
function setCurrentDay(dateString) {
  state.currentDay = dateString;
  render();
}

function goToPreviousDay() {
  const current = new Date(state.currentDay);
  current.setDate(current.getDate() - 1);
  state.currentDay = current.toISOString().split('T')[0];
  render();
}

function goToNextDay() {
  const current = new Date(state.currentDay);
  current.setDate(current.getDate() + 1);
  state.currentDay = current.toISOString().split('T')[0];
  render();
}

function goToToday() {
  state.currentDay = new Date().toISOString().split('T')[0];
  render();
}

/* ----------------------------- Workout Day Navigation ----------------------------- */
function goToPreviousWorkoutDay() {
  const current = new Date(state.currentWorkoutDay);
  current.setDate(current.getDate() - 1);
  state.currentWorkoutDay = current.toISOString().split('T')[0];
  render();
}

function goToNextWorkoutDay() {
  const current = new Date(state.currentWorkoutDay);
  current.setDate(current.getDate() + 1);
  state.currentWorkoutDay = current.toISOString().split('T')[0];
  render();
}

function goToTodayWorkout() {
  state.currentWorkoutDay = new Date().toISOString().split('T')[0];
  render();
}

// Show workout exercises form for registration
function showWorkoutExercises(templateId) {
  const template = templates[templateId];
  if (!template) return;
  
  const session = template.sessions.A;
  const formDiv = document.getElementById('workoutExercisesForm');
  const exercisesList = document.getElementById('exercisesList');
  
  let html = `
    <div class="bg-gradient-to-r from-purple-900 to-slate-800 p-4 rounded-lg mb-4">
      <h4 class="font-bold text-xl text-purple-300 mb-2">${template.name}</h4>
      <p class="text-slate-300">${template.description}</p>
    </div>
    <div class="space-y-4">
  `;
  
  session.exercises.forEach((exercise, index) => {
    const isMobility = exercise.name.toLowerCase().includes('mobilidade');
    html += `
      <div class="bg-slate-700 p-4 rounded-lg">
        <h5 class="font-semibold text-lg mb-3">${exercise.name}</h5>
        ${exercise.notes ? `<p class="text-slate-400 text-sm mb-3">üí° ${exercise.notes}</p>` : ''}
        
        <form onsubmit="handleQuickExerciseLog(event, '${exercise.name}', '${templateId}')" class="grid grid-cols-4 gap-3">
          <div>
            <label class="block text-xs text-slate-400 mb-1">S√©ries</label>
            <select name="sets" class="w-full px-3 py-2 rounded bg-slate-600 text-white" ${isMobility ? '' : 'required'}>
              <option value="">-</option>
              ${[1,2,3,4,5].map(n => `<option value="${n}" ${exercise.sets === n ? 'selected' : ''}>${n}</option>`).join('')}
            </select>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">Repeti√ß√µes</label>
            <select name="reps" class="w-full px-3 py-2 rounded bg-slate-600 text-white" ${isMobility ? '' : 'required'}>
              <option value="">-</option>
              ${[...Array(20)].map((_, i) => `<option value="${i+1}" ${exercise.reps === (i+1) ? 'selected' : ''}>${i+1}</option>`).join('')}
            </select>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">Peso (kg)</label>
            <input 
              type="number" 
              name="weight" 
              min="1" 
              max="300" 
              step="0.5"
              placeholder="0" 
              class="w-full px-3 py-2 rounded bg-slate-600 text-white"
            />
          </div>
          <div class="flex items-end">
            <button type="submit" class="w-full bg-green-600 hover:bg-green-500 px-3 py-2 rounded font-semibold">
              ‚úì Registrar
            </button>
          </div>
        </form>
      </div>
    `;
  });
  
  html += '</div>';
  exercisesList.innerHTML = html;
  formDiv.classList.remove('hidden');
  
  // Scroll to form
  formDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Hide workout exercises form
function hideWorkoutExercises() {
  const formDiv = document.getElementById('workoutExercisesForm');
  formDiv.classList.add('hidden');
}

// Handle quick exercise log from the form
function handleQuickExerciseLog(event, exerciseName, templateId) {
  event.preventDefault();
  
  const form = event.target;
  const sets = form.sets.value || '-';
  const reps = form.reps.value || '-';
  const weight = form.weight.value || '-';
  
  // Log the workout
  handleLogWorkout(exerciseName, sets, reps, weight, templates[templateId].name);
  
  // Show success message
  showNotification(`‚úÖ ${exerciseName} registrado!`, 'success');
  
  // Reset form
  form.reset();
}


/* ----------------------------- Exercise Library ----------------------------- */
const EXERCISE_LIBRARY = [
  // Peito
  { name: 'Supino reto', category: 'Peito', equipment: 'Barra' },
  { name: 'Supino inclinado', category: 'Peito', equipment: 'Barra' },
  { name: 'Supino declinado', category: 'Peito', equipment: 'Barra' },
  { name: 'Crucifixo', category: 'Peito', equipment: 'Halteres' },
  { name: 'Fly (peck deck)', category: 'Peito', equipment: 'M√°quina' },
  { name: 'Flex√£o', category: 'Peito', equipment: 'Peso corporal' },
  
  // Costas
  { name: 'Barra fixa', category: 'Costas', equipment: 'Peso corporal' },
  { name: 'Puxada frontal', category: 'Costas', equipment: 'M√°quina' },
  { name: 'Remada curvada', category: 'Costas', equipment: 'Barra' },
  { name: 'Remada unilateral', category: 'Costas', equipment: 'Halter' },
  { name: 'Remada sentado', category: 'Costas', equipment: 'M√°quina' },
  { name: 'Levantamento terra', category: 'Costas', equipment: 'Barra' },
  { name: 'Pullover', category: 'Costas', equipment: 'Halter' },
  
  // Ombros
  { name: 'Desenvolvimento militar', category: 'Ombros', equipment: 'Barra' },
  { name: 'Desenvolvimento com halteres', category: 'Ombros', equipment: 'Halteres' },
  { name: 'Eleva√ß√£o lateral', category: 'Ombros', equipment: 'Halteres' },
  { name: 'Eleva√ß√£o frontal', category: 'Ombros', equipment: 'Halteres' },
  { name: 'Remada alta', category: 'Ombros', equipment: 'Barra' },
  { name: 'Crucifixo inverso', category: 'Ombros', equipment: 'Halteres' },
  
  // B√≠ceps
  { name: 'Rosca direta', category: 'B√≠ceps', equipment: 'Barra' },
  { name: 'Rosca alternada', category: 'B√≠ceps', equipment: 'Halteres' },
  { name: 'Rosca martelo', category: 'B√≠ceps', equipment: 'Halteres' },
  { name: 'Rosca concentrada', category: 'B√≠ceps', equipment: 'Halter' },
  { name: 'Rosca scott', category: 'B√≠ceps', equipment: 'Barra W' },
  
  // Tr√≠ceps
  { name: 'Tr√≠ceps testa', category: 'Tr√≠ceps', equipment: 'Barra' },
  { name: 'Tr√≠ceps franc√™s', category: 'Tr√≠ceps', equipment: 'Halter' },
  { name: 'Tr√≠ceps corda', category: 'Tr√≠ceps', equipment: 'Polia' },
  { name: 'Tr√≠ceps banco', category: 'Tr√≠ceps', equipment: 'Peso corporal' },
  { name: 'Mergulho', category: 'Tr√≠ceps', equipment: 'Paralelas' },
  
  // Pernas
  { name: 'Agachamento livre', category: 'Pernas', equipment: 'Barra' },
  { name: 'Leg press 45¬∞', category: 'Pernas', equipment: 'M√°quina' },
  { name: 'Cadeira extensora', category: 'Pernas', equipment: 'M√°quina' },
  { name: 'Cadeira flexora', category: 'Pernas', equipment: 'M√°quina' },
  { name: 'Stiff', category: 'Pernas', equipment: 'Barra' },
  { name: 'Avan√ßo (afundo)', category: 'Pernas', equipment: 'Halteres' },
  { name: 'Agachamento sum√¥', category: 'Pernas', equipment: 'Halter' },
  { name: 'Panturrilha em p√©', category: 'Pernas', equipment: 'M√°quina' },
  { name: 'Panturrilha sentado', category: 'Pernas', equipment: 'M√°quina' },
  
  // Abd√¥men
  { name: 'Abdominal supra', category: 'Abd√¥men', equipment: 'Peso corporal' },
  { name: 'Abdominal infra', category: 'Abd√¥men', equipment: 'Peso corporal' },
  { name: 'Prancha', category: 'Abd√¥men', equipment: 'Peso corporal' },
  { name: 'Abdominal obl√≠quo', category: 'Abd√¥men', equipment: 'Peso corporal' },
  { name: 'Roda abdominal', category: 'Abd√¥men', equipment: 'Roda' }
];

/* ----------------------------- Custom meal handlers ----------------------------- */
function handleAddCustomMeal(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const name = formData.get('customMealName');
  const kcal = formData.get('customMealKcal');
  const prot = formData.get('customMealProt');
  const fat = formData.get('customMealFat');
  const saveAsReusable = formData.get('saveAsReusable') === 'on';
  
  if (!name || !kcal) {
    alert('Nome e calorias s√£o obrigat√≥rios');
    return;
  }
  
  // Check if already exists
  const exists = state.customMeals.find(m => m.name === name);
  if (exists && !confirm('J√° existe uma refei√ß√£o com este nome. Deseja substituir?')) {
    return;
  }
  
  const customMeal = {
    id: `custom_meal_${Date.now()}`,
    name: name.trim(),
    kcal: parseFloat(kcal) || 0,
    prot: parseFloat(prot) || 0,
    fat: parseFloat(fat) || 0,
    createdAt: new Date().toISOString(),
    createdBy: state.activeUser
  };
  
  if (saveAsReusable) {
    // Remove existing if updating
    state.customMeals = state.customMeals.filter(m => m.name !== name);
    state.customMeals.push(customMeal);
    saveCustomMeals();
  }
  
  // Always log the meal to current day
  handleLogMeal(name.trim());
  
  // Reset form
  e.target.reset();
  
  if (saveAsReusable) {
    showNotification('‚úÖ Refei√ß√£o personalizada salva e registrada!', 'success');
  }
}

function handleDeleteCustomMeal(mealId) {
  if (!confirm('Deseja excluir esta refei√ß√£o personalizada permanentemente?')) return;
  state.customMeals = state.customMeals.filter(m => m.id !== mealId);
  saveCustomMeals();
  showNotification('‚úÖ Refei√ß√£o personalizada exclu√≠da', 'success');
  render();
}

/* ----------------------------- Nutrition Calculator Functions ----------------------------- */
function selectFood(category, index) {
  const food = commonFoods[category][index];
  
  // Fill calculator with food data
  document.getElementById('calcFoodName').value = food.name;
  document.getElementById('calcWeight').value = food.per;
  document.getElementById('calcProtPer100').value = (food.prot * 100 / food.per).toFixed(1);
  document.getElementById('calcCarbPer100').value = (food.carb * 100 / food.per).toFixed(1);
  document.getElementById('calcFatPer100').value = (food.fat * 100 / food.per).toFixed(1);
  
  // Scroll to calculator
  document.getElementById('calcFoodName').scrollIntoView({ behavior: 'smooth', block: 'center' });
  
  // Show success notification
  showNotification(`‚úÖ Alimento selecionado: ${food.name}`, 'success');
}

function filterFoods() {
  const searchTerm = document.getElementById('foodSearchInput').value.toLowerCase();
  const foodItems = document.querySelectorAll('.food-item');
  const categories = document.querySelectorAll('.food-category');
  
  foodItems.forEach(item => {
    const foodName = item.getAttribute('data-food-name').toLowerCase();
    if (foodName.includes(searchTerm)) {
      item.style.display = 'block';
    } else {
      item.style.display = 'none';
    }
  });
  
  // Hide categories with no visible items
  categories.forEach(category => {
    const visibleItems = Array.from(category.querySelectorAll('.food-item')).filter(item => item.style.display !== 'none');
    if (visibleItems.length === 0 && searchTerm !== '') {
      category.style.display = 'none';
    } else {
      category.style.display = 'block';
    }
  });
}

function calculateMacros() {
  const foodName = document.getElementById('calcFoodName').value;
  const weight = parseFloat(document.getElementById('calcWeight').value);
  const protPer100 = parseFloat(document.getElementById('calcProtPer100').value) || 0;
  const carbPer100 = parseFloat(document.getElementById('calcCarbPer100').value) || 0;
  const fatPer100 = parseFloat(document.getElementById('calcFatPer100').value) || 0;
  
  if (!weight || weight <= 0) {
    alert('Por favor, insira um peso v√°lido em gramas');
    return;
  }
  
  // Calculate multiplier (weight / 100)
  const multiplier = weight / 100;
  
  // Calculate macros for the given weight
  const proteinGrams = (protPer100 * multiplier).toFixed(1);
  const carbGrams = (carbPer100 * multiplier).toFixed(1);
  const fatGrams = (fatPer100 * multiplier).toFixed(1);
  
  // Calculate calories (protein: 4kcal/g, carbs: 4kcal/g, fat: 9kcal/g)
  const proteinKcal = (proteinGrams * 4).toFixed(1);
  const carbKcal = (carbGrams * 4).toFixed(1);
  const fatKcal = (fatGrams * 9).toFixed(1);
  const totalKcal = (parseFloat(proteinKcal) + parseFloat(carbKcal) + parseFloat(fatKcal)).toFixed(1);
  
  // Update results
  document.getElementById('resultProt').textContent = proteinGrams + 'g';
  document.getElementById('resultProtKcal').textContent = proteinKcal + ' kcal';
  document.getElementById('resultCarb').textContent = carbGrams + 'g';
  document.getElementById('resultCarbKcal').textContent = carbKcal + ' kcal';
  document.getElementById('resultFat').textContent = fatGrams + 'g';
  document.getElementById('resultFatKcal').textContent = fatKcal + ' kcal';
  document.getElementById('resultTotal').textContent = totalKcal + ' kcal';
  
  // Show results
  document.getElementById('calcResults').classList.remove('hidden');
  
  // Show success notification
  showNotification(`‚úÖ Calculado: ${weight}g de ${foodName || 'alimento'} = ${totalKcal} kcal`, 'success');
}

function fillCalculatorExample(name, weight, prot, carb, fat) {
  document.getElementById('calcFoodName').value = name;
  document.getElementById('calcWeight').value = weight;
  document.getElementById('calcProtPer100').value = prot;
  document.getElementById('calcCarbPer100').value = carb;
  document.getElementById('calcFatPer100').value = fat;
  
  // Auto-calculate
  calculateMacros();
  
  // Scroll to calculator
  document.getElementById('calcFoodName').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

/* ----------------------------- Meal Composition Functions ----------------------------- */

// Reset meal composition
function resetMealComposition() {
  state.currentMealComposition = {
    name: '',
    components: [],
    totalProt: 0,
    totalCarb: 0,
    totalFat: 0,
    totalKcal: 0,
    totalWeight: 0
  };
  render();
}

// Add component to meal composition
function addComponentToMeal() {
  const foodName = document.getElementById('calcFoodName').value;
  const weight = parseFloat(document.getElementById('calcWeight').value);
  const protPer100 = parseFloat(document.getElementById('calcProtPer100').value) || 0;
  const carbPer100 = parseFloat(document.getElementById('calcCarbPer100').value) || 0;
  const fatPer100 = parseFloat(document.getElementById('calcFatPer100').value) || 0;
  
  if (!foodName || !weight || weight <= 0) {
    alert('Por favor, preencha o nome do alimento e um peso v√°lido');
    return;
  }
  
  // Calculate multiplier (weight / 100)
  const multiplier = weight / 100;
  
  // Calculate macros for the given weight
  const prot = parseFloat((protPer100 * multiplier).toFixed(1));
  const carb = parseFloat((carbPer100 * multiplier).toFixed(1));
  const fat = parseFloat((fatPer100 * multiplier).toFixed(1));
  const kcal = parseFloat((prot * 4 + carb * 4 + fat * 9).toFixed(1));
  
  // Add component
  const component = {
    id: Date.now(),
    foodName: foodName.trim(),
    weight: weight,
    prot: prot,
    carb: carb,
    fat: fat,
    kcal: kcal
  };
  
  state.currentMealComposition.components.push(component);
  
  // Update totals
  updateMealCompositionTotals();
  
  // Clear calculator inputs for next component
  document.getElementById('calcFoodName').value = '';
  document.getElementById('calcWeight').value = '';
  document.getElementById('calcProtPer100').value = '';
  document.getElementById('calcCarbPer100').value = '';
  document.getElementById('calcFatPer100').value = '';
  document.getElementById('calcResults').classList.add('hidden');
  
  showNotification(`‚úÖ Componente adicionado: ${weight}g de ${foodName}`, 'success');
  render();
}

// Remove component from meal composition
function removeComponentFromMeal(componentId) {
  state.currentMealComposition.components = state.currentMealComposition.components.filter(c => c.id !== componentId);
  updateMealCompositionTotals();
  render();
}

// Update meal composition totals
function updateMealCompositionTotals() {
  const totals = state.currentMealComposition.components.reduce((acc, comp) => {
    acc.prot += comp.prot;
    acc.carb += comp.carb;
    acc.fat += comp.fat;
    acc.kcal += comp.kcal;
    acc.weight += comp.weight;
    return acc;
  }, { prot: 0, carb: 0, fat: 0, kcal: 0, weight: 0 });
  
  state.currentMealComposition.totalProt = parseFloat(totals.prot.toFixed(1));
  state.currentMealComposition.totalCarb = parseFloat(totals.carb.toFixed(1));
  state.currentMealComposition.totalFat = parseFloat(totals.fat.toFixed(1));
  state.currentMealComposition.totalKcal = parseFloat(totals.kcal.toFixed(1));
  state.currentMealComposition.totalWeight = parseFloat(totals.weight.toFixed(1));
}

// Save composed meal to history
function saveComposedMeal() {
  if (state.currentMealComposition.components.length === 0) {
    alert('Adicione pelo menos um componente √† refei√ß√£o');
    return;
  }
  
  const mealName = prompt('Digite um nome para esta refei√ß√£o composta:', state.currentMealComposition.name || 'Refei√ß√£o Personalizada');
  if (!mealName) return;
  
  state.currentMealComposition.name = mealName.trim();
  
  const user = state.users[state.activeUser];
  const now = new Date();
  const time = now.toTimeString().slice(0, 5);
  
  // Create a meal log entry with composition details
  const composedMealLog = {
    id: Date.now(),
    date: state.currentDay,
    time: time,
    meal: state.currentMealComposition.name,
    isComposed: true,
    components: state.currentMealComposition.components,
    totalProt: state.currentMealComposition.totalProt,
    totalCarb: state.currentMealComposition.totalCarb,
    totalFat: state.currentMealComposition.totalFat,
    totalKcal: state.currentMealComposition.totalKcal,
    totalWeight: state.currentMealComposition.totalWeight
  };
  
  user.mealHistory.unshift(composedMealLog);
  
  saveAllToDB();
  showNotification(`‚úÖ Refei√ß√£o "${mealName}" salva no hist√≥rico!`, 'success');
  
  // Ask if user wants to save as reusable template
  if (confirm('Deseja salvar esta refei√ß√£o como modelo reutiliz√°vel?')) {
    saveComposedMealAsTemplate();
  }
  
  // Reset composition
  resetMealComposition();
}

// Save composed meal as reusable template
function saveComposedMealAsTemplate() {
  const customMeal = {
    id: `custom_meal_${Date.now()}`,
    name: state.currentMealComposition.name,
    kcal: state.currentMealComposition.totalKcal,
    prot: state.currentMealComposition.totalProt,
    carb: state.currentMealComposition.totalCarb,
    fat: state.currentMealComposition.totalFat,
    isComposed: true,
    components: state.currentMealComposition.components,
    createdAt: new Date().toISOString(),
    createdBy: state.activeUser
  };
  
  // Remove existing if updating
  state.customMeals = state.customMeals.filter(m => m.name !== customMeal.name);
  state.customMeals.push(customMeal);
  saveCustomMeals();
  
  showNotification('‚úÖ Refei√ß√£o salva como modelo reutiliz√°vel!', 'success');
}

/* ----------------------------- Custom workout handler ----------------------------- */
function handleAddCustomWorkout(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const exercise = formData.get('customExercise');
  const sets = formData.get('customSets');
  const reps = formData.get('customReps');
  const weight = formData.get('customWeight');
  
  if (!exercise) {
    alert('Nome do exerc√≠cio √© obrigat√≥rio');
    return;
  }
  
  handleLogWorkout(exercise, sets, reps, weight);
  e.target.reset();
}

/* ----------------------------- BMR calculation ----------------------------- */
function calculateBMR(weightKg, heightCm, age, gender) {
  const base = 10 * weightKg + 6.25 * heightCm - 5 * age;
  return Math.round(base + (gender === 'female' ? -161 : 5));
}

/* ----------------------------- Metrics add/delete ----------------------------- */
function handleAddMetrics(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const weight = parseFloat(formData.get('weight'));
  const heightCm = state.users[state.activeUser].height;
  const age = state.users[state.activeUser].age || 30;
  const gender = state.users[state.activeUser].gender || 'male';
  const waterPercent = parseFloat(formData.get('waterPercent')) || 0;
  const muscleSize = parseFloat(formData.get('muscleSize')) || 0;
  const bmr = formData.get('bmr') ? parseFloat(formData.get('bmr')) : calculateBMR(weight, heightCm, age, gender);
  const waterWeight = parseFloat((weight * (waterPercent / 100)).toFixed(2));
  
  const newMetric = {
    id: Date.now().toString(),
    date: formData.get('date'),
    weight: weight,
    bodyFat: parseFloat(formData.get('bodyFat')),
    muscleMass: parseFloat(formData.get('muscleMass')),
    visceralFat: parseFloat(formData.get('visceralFat')) || 0,
    waterPercent: waterPercent,
    waterWeight: waterWeight,
    bmr: bmr,
    muscleSize: muscleSize,
    bmi: parseFloat((weight / Math.pow(heightCm / 100, 2)).toFixed(1)),
    
    // Segmented muscle mass
    muscleMassRightArm: parseFloat(formData.get('muscleMassRightArm')) || 0,
    muscleMassLeftArm: parseFloat(formData.get('muscleMassLeftArm')) || 0,
    muscleMassRightLeg: parseFloat(formData.get('muscleMassRightLeg')) || 0,
    muscleMassLeftLeg: parseFloat(formData.get('muscleMassLeftLeg')) || 0,
    muscleMassTrunk: parseFloat(formData.get('muscleMassTrunk')) || 0,
    
    // Segmented body fat
    bodyFatRightArm: parseFloat(formData.get('bodyFatRightArm')) || 0,
    bodyFatLeftArm: parseFloat(formData.get('bodyFatLeftArm')) || 0,
    bodyFatRightLeg: parseFloat(formData.get('bodyFatRightLeg')) || 0,
    bodyFatLeftLeg: parseFloat(formData.get('bodyFatLeftLeg')) || 0,
    bodyFatTrunk: parseFloat(formData.get('bodyFatTrunk')) || 0,
    
    // Advanced body composition
    boneMass: parseFloat(formData.get('boneMass')) || 0,
    proteinMass: parseFloat(formData.get('proteinMass')) || 0,
    mineralMass: parseFloat(formData.get('mineralMass')) || 0,
    
    // Metabolic rates
    rmr: parseFloat(formData.get('rmr')) || 0,
    tdee: parseFloat(formData.get('tdee')) || 0,
    
    // Bioelectrical impedance
    impedance: parseFloat(formData.get('impedance')) || 0,
    phaseAngle: parseFloat(formData.get('phaseAngle')) || 0,
    reactance: parseFloat(formData.get('reactance')) || 0,
    resistance: parseFloat(formData.get('resistance')) || 0,
    
    // Ages
    metabolicAge: parseInt(formData.get('metabolicAge')) || 0,
    bodyAge: parseInt(formData.get('bodyAge')) || 0,
    
    // Circumferences
    chest: parseFloat(formData.get('chest')) || 0,
    waist: parseFloat(formData.get('waist')) || 0,
    hips: parseFloat(formData.get('hips')) || 0,
    rightArm: parseFloat(formData.get('rightArm')) || 0,
    leftArm: parseFloat(formData.get('leftArm')) || 0,
    rightThigh: parseFloat(formData.get('rightThigh')) || 0,
    leftThigh: parseFloat(formData.get('leftThigh')) || 0,
    rightCalf: parseFloat(formData.get('rightCalf')) || 0,
    leftCalf: parseFloat(formData.get('leftCalf')) || 0,
    neck: parseFloat(formData.get('neck')) || 0,
    shoulders: parseFloat(formData.get('shoulders')) || 0
  };
  
  const user = state.users[state.activeUser];
  user.bodyMetrics.push(newMetric);
  user.bodyMetrics.sort((a, b) => new Date(a.date) - new Date(b.date));
  addOrUpdateUser(user);
  
  showNotification('‚úÖ Medi√ß√£o completa adicionada com sucesso!', 'success');
  
  // redraw chart if on evolu√ß√£o
  if (state.activeTab === 'evolucao') setTimeout(() => renderMuscleEvolutionChart(user.bodyMetrics, user.id), 150);
  e.target.reset();
}

/* When deleting a metric, move it to archive rather than permanently delete */
function handleDeleteMetric(metricId) {
  if (!confirm('Deseja excluir esta medida? Ela ser√° movida para o arquivo (archive) e poder√° ser restaurada.')) return;
  const user = state.users[state.activeUser];
  const metric = user.bodyMetrics.find(m => m.id === metricId);
  if (!metric) return alert('Medida n√£o encontrada');
  archiveItem('bodyMetrics', metricId, 'metric', metric).then(() => {
    user.bodyMetrics = user.bodyMetrics.filter(m => m.id !== metricId);
    addOrUpdateUser(user);
    showNotification('‚úÖ Medida exclu√≠da e movida para archive', 'success');
  });
}

/* ----------------------------- Profiles handlers ----------------------------- */
function handleAddProfile() {
  const name = prompt('Nome do novo perfil: (ex: Jo√£o)');
  if (!name) return;
  const gender = prompt('G√™nero (male/female):', 'male') || 'male';
  const age = parseInt(prompt('Idade:', '25')) || 25;
  const height = parseInt(prompt('Altura em cm:', '170')) || 170;
  const idBase = name.trim().toLowerCase().replace(/\s+/g, '_');
  const id = `${idBase}_${Date.now()}`;
  const user = {
    id,
    name,
    gender: gender === 'female' ? 'female' : 'male',
    age,
    height,
    workoutHistory: [],
    mealHistory: [],
    bodyMetrics: [{
      id: 'm_' + Date.now(),
      date: new Date().toISOString().split('T')[0],
      weight: 0,
      bodyFat: 0,
      muscleMass: 0,
      visceralFat: 0,
      waterPercent: 0,
      waterWeight: 0,
      bmr: calculateBMR(0, height, age, gender),
      muscleSize: 0,
      bmi: 0
    }],
    goals: { weight: 0, bodyFat: 0, muscleMass: 0 },
    customPrograms: {}
  };
  addOrUpdateUser(user);
  alert('‚úÖ Perfil criado: ' + name);
}

/* Soft-delete profile (moves to archive), never removes without explicit user's permanent deletion action */
function handleDeleteProfile(userId) {
  if (!confirm('Deseja mover este perfil para archive (preservar√° TODOS os registros)?')) return;
  const user = state.users[userId];
  if (!user) return alert('Perfil n√£o encontrado');
  archiveItem(STORE_USERS, userId, 'user', user).then(() => {
    delete state.users[userId];
    try { dbDelete(STORE_USERS, userId).catch(()=>{}); } catch(e){}
    saveLS('ft_users', state.users);
    updateState({ users: state.users });
    alert('‚úÖ Perfil movido para archive. Para excluir permanentemente v√° no archive e remova manualmente.');
  });
}

/* ----------------------------- Templates application & custom programs ----------------------------- */
function applyTemplateToUser(templateId, userId) {
  const tmpl = templates[templateId];
  if (!tmpl) return alert('Template n√£o encontrado');
  const user = state.users[userId];
  if (!user) return alert('Usu√°rio n√£o encontrado');
  user.customPrograms = user.customPrograms || {};
  user.customPrograms[tmpl.id] = JSON.parse(JSON.stringify(tmpl)); // deep copy
  addOrUpdateUser(user);
  alert(`‚úÖ Template "${tmpl.name}" aplicado e salvo no perfil ${user.name}.`);
}

function removeUserProgram(userId, programId) {
  const user = state.users[userId];
  if (!user || !user.customPrograms) return;
  if (!confirm('Remover este programa do perfil? (n√£o exclui do archive)')) return;
  delete user.customPrograms[programId];
  addOrUpdateUser(user);
  alert('‚úÖ Programa removido do perfil.');
}

/* ----------------------------- References import / export / clear ----------------------------- */
function importScientificStudiesSeed() {
  const idsExisting = new Set(state.references.map(r => r.id));
  let added = 0;
  scientificStudiesSeed.forEach(ref => {
    if (!idsExisting.has(ref.id)) {
      state.references.push(ref);
      added++;
    }
  });
  if (added > 0) {
    saveAllToDB();
    alert(`‚úÖ Importados ${added} estudos (2020 ‚Üí 2025-11).`);
  } else {
    alert('‚ÑπÔ∏è Estudos j√° importados anteriormente.');
  }
  render();
}

function exportReferencesJSON() {
  const dataStr = JSON.stringify(state.references, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `studies_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function clearReferences() {
  if (!confirm('Deseja mover todas as refer√™ncias para archive? Elas ficar√£o preservadas em archive.')) return;
  // move each to archive
  Promise.all(state.references.map(r => archiveItem(STORE_REFERENCES, r.id, 'reference', r))).then(() => {
    state.references = [];
    saveAllToDB();
    alert('‚úÖ Refer√™ncias movidas para archive.local');
    render();
  }).catch(err => alert('Erro ao mover refer√™ncias para archive: ' + err));
}

/* ----------------------------- Export muscle evolution CSV ----------------------------- */
function exportMuscleEvolutionCSV(userId) {
  const user = state.users[userId];
  if (!user) return alert('Usu√°rio n√£o encontrado');
  const rows = [['date','weight','bodyFat','muscleMass','muscleSize','waterWeight','bmr']];
  (user.bodyMetrics || []).forEach(m => {
    rows.push([m.date, m.weight, m.bodyFat, m.muscleMass, m.muscleSize, m.waterWeight, m.bmr]);
  });
  const csv = rows.map(r => r.map(cell => (typeof cell === 'string' && cell.includes(',')) ? `"${cell}"` : cell).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${userId}_muscle_evolution_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

/* ----------------------------- References helper for UI ----------------------------- */
function getReferencesByTags(tags) {
  if (!tags || !tags.length) return [];
  const refs = state.references || [];
  return refs.filter(r => r.tags && r.tags.some(t => tags.includes(t)));
}
function getTopReferencesByTags(tags, limit = 3) {
  const matched = getReferencesByTags(tags);
  matched.sort((a, b) => (b.year || 0) - (a.year || 0));
  return matched.slice(0, limit);
}
function renderReferenceLinksHTML(refs) {
  if (!refs || !refs.length) return '';
  return refs.map(r => `<a href="${r.link}" target="_blank" class="text-blue-300 underline">${r.authors} ${r.year}</a>`).join(' ‚Ä¢ ');
}
function buildReferenceNotesForWorkout(workoutName) {
  const name = (workoutName || '').toLowerCase();
  let tags = ['training'];
  if (name.includes('hip') || name.includes('gl√∫teo') || name.includes('thrust')) tags.push('hypertrophy');
  if (name.includes('agach') || name.includes('leg')) tags.push('volume');
  if (name.includes('supino') || name.includes('press')) tags.push('strength');
  const refs = getTopReferencesByTags(tags);
  if (!refs.length) return '';
  return `Base cient√≠fica: ${refs.slice(0,3).map(r => `${r.authors} ${r.year}`).join(' ‚Ä¢ ')}. ` + renderReferenceLinksHTML(refs);
}
function buildReferenceNotesForNutrition() {
  const refs = getTopReferencesByTags(['nutrition','protein','creatine','diet']);
  if (!refs.length) return '';
  return `Refer√™ncias: ${refs.slice(0,3).map(r => `${r.authors} ${r.year}`).join(' ‚Ä¢ ')}. ` + renderReferenceLinksHTML(refs);
}

/* ----------------------------- Event Delegation for Meal Buttons -----------------------------
   This function attaches event listeners to meal registration buttons using event delegation.
   This approach is more robust than inline onclick handlers and handles special characters properly.
------------------------------------------------------------------------------------------------ */
function attachMealButtons() {
  const mealButtons = document.querySelectorAll('.meal-register-btn');
  mealButtons.forEach(btn => {
    // Remove old listener if exists by replacing with a new one
    btn.onclick = function(e) {
      e.preventDefault();
      const mealName = this.getAttribute('data-meal-name');
      if (mealName) {
        handleLogMeal(mealName);
      }
    };
  });
}

function attachMealDeleteButtons() {
  const deleteButtons = document.querySelectorAll('.meal-delete-btn');
  deleteButtons.forEach(btn => {
    btn.onclick = function(e) {
      e.preventDefault();
      const mealId = parseInt(this.getAttribute('data-meal-id'));
      if (mealId) {
        handleDeleteMeal(mealId);
      }
    };
  });
}

function attachWorkoutButtons() {
  const workoutButtons = document.querySelectorAll('.workout-register-btn');
  workoutButtons.forEach(btn => {
    btn.onclick = function(e) {
      e.preventDefault();
      const exercise = this.getAttribute('data-exercise');
      const category = this.getAttribute('data-category');
      
      // Prompt for sets, reps, and weight
      const sets = prompt(`Registrar: ${exercise}\n\nQuantas s√©ries voc√™ fez?`, '3');
      if (sets === null) return; // User cancelled
      
      const reps = prompt(`Registrar: ${exercise}\n\nQuantas repeti√ß√µes por s√©rie?`, '12');
      if (reps === null) return; // User cancelled
      
      const weight = prompt(`Registrar: ${exercise}\n\nQual carga voc√™ usou? (kg)\nDeixe em branco se n√£o aplic√°vel`, '');
      if (weight === null) return; // User cancelled
      
      if (exercise) {
        handleLogWorkout(exercise, sets, reps, weight, category);
      }
    };
  });
}

function attachWorkoutDeleteButtons() {
  const deleteButtons = document.querySelectorAll('.workout-delete-btn');
  deleteButtons.forEach(btn => {
    btn.onclick = function(e) {
      e.preventDefault();
      const workoutId = parseInt(this.getAttribute('data-workout-id'));
      if (workoutId) {
        handleDeleteWorkout(workoutId);
      }
    };
  });
}

/* ----------------------------- RENDER (UI) -----------------------------
   The UI is intentionally verbose and explanatory to ensure clarity for you.
   Buttons that perform deletions will refer to archive workflow; nothing is removed
   permanently without explicit permanent-delete action in archive manager.
----------------------------------------------------------------------------- */

function render() {
  const app = document.getElementById('app');
  
  // Check if user is authenticated
  if (!authState.isAuthenticated) {
    renderLoginPage();
    return;
  }
  
  const currentUser = state.users[state.activeUser] || Object.values(state.users)[0];
  if (!currentUser) {
    app.innerHTML = '<div class="p-8 text-white">Carregando...</div>';
    return;
  }

  const workoutHistory = currentUser.workoutHistory || [];
  const mealHistory = currentUser.mealHistory || [];
  const bodyMetrics = currentUser.bodyMetrics || [];
  const latestMetrics = bodyMetrics[bodyMetrics.length - 1] || { weight: 0, bodyFat: 0, muscleMass: 0, bmi: 0, bmr: 0, waterPercent: 0, waterWeight: 0, muscleSize: 0 };

  app.innerHTML = `
    <header class="bg-black/40 backdrop-blur-lg border-b border-purple-500/30 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">üö∂‚Äç‚ôÇÔ∏è Pilgrim</h1>
          <p class="text-purple-300 text-sm mt-1">Usu√°rio: <strong>${authState.currentAccount.username}</strong> | Email: ${authState.currentAccount.email}</p>
        </div>
        <div class="flex gap-2 items-center">
          ${Object.keys(state.users).map(id => `
            <div class="flex items-center gap-2">
              <button onclick="state.activeUser='${id}'; render();" class="px-4 py-2 rounded-lg font-semibold ${state.activeUser === id ? (state.users[id].gender === 'female' ? 'bg-pink-500 text-white' : 'bg-blue-500 text-white') : 'bg-slate-700 text-slate-300'}">
                ${state.users[id].gender === 'female' ? 'üë©' : 'üë®'} ${state.users[id].name}
              </button>
              <button title="Mover perfil para archive" onclick="handleDeleteProfile('${id}')" class="text-red-400 hover:text-red-300 px-2">üóÑÔ∏è</button>
            </div>
          `).join('')}
          <button onclick="handleAddProfile()" class="px-4 py-2 rounded-lg font-semibold bg-green-600 hover:bg-green-500">‚ûï Novo Perfil</button>
          <button onclick="handleLogout()" class="px-4 py-2 rounded-lg font-semibold bg-red-600 hover:bg-red-500">üö™ Sair</button>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="flex flex-wrap gap-3 mb-6">
        ${['dashboard','treino','exercicios','fotos','nutricao','alimentacao','evolucao'].map(tab => `
          <button onclick="state.activeTab='${tab}'; render();" class="px-6 py-3 rounded-xl font-semibold ${state.activeTab === tab ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'bg-slate-800/50 text-slate-300'}">
            ${tab === 'dashboard' ? 'üìä Dashboard' : tab === 'treino' ? 'üèãÔ∏è Treinos' : tab === 'exercicios' ? 'üí™ Exerc√≠cios' : tab === 'fotos' ? 'üì∏ Fotos' : tab === 'nutricao' ? 'üçé Nutri√ß√£o' : tab === 'alimentacao' ? 'üç≤ Alimenta√ß√£o' : 'üìà Evolu√ß√£o'}
          </button>
        `).join('')}
        ${isAdmin() ? `
          <div class="w-full my-2"></div>
          <div class="flex items-center gap-2 px-4 py-2 bg-red-900/30 rounded-lg">
            <span class="text-red-400 font-bold">üëë ADMIN:</span>
          </div>
          ${['admin_tasks','admin_suggestions','admin_security'].map(tab => `
            <button onclick="state.activeTab='${tab}'; render();" class="px-6 py-3 rounded-xl font-semibold ${state.activeTab === tab ? 'bg-gradient-to-r from-red-600 to-orange-600 text-white' : 'bg-slate-800/50 text-slate-300 border border-red-500/30'}">
              ${tab === 'admin_tasks' ? 'üìã Tarefas' : tab === 'admin_suggestions' ? 'üí° Sugest√µes' : 'üîê Seguran√ßa'}
            </button>
          `).join('')}
        ` : `
          ${['suggestions'].map(tab => `
            <div class="w-full my-2"></div>
            <button onclick="state.activeTab='${tab}'; render();" class="px-6 py-3 rounded-xl font-semibold ${state.activeTab === tab ? 'bg-gradient-to-r from-green-600 to-teal-600 text-white' : 'bg-slate-800/50 text-slate-300'}">
              üí° Sugest√µes
            </button>
          `).join('')}
        `}
      </div>

      <main>
        ${state.activeTab === 'dashboard' ? renderDashboard(currentUser, latestMetrics) : ''}
        ${state.activeTab === 'treino' ? renderTreino(currentUser) : ''}
        ${state.activeTab === 'exercicios' ? renderExercicios(currentUser) : ''}
        ${state.activeTab === 'fotos' ? renderFotosProgresso(currentUser) : ''}
        ${state.activeTab === 'nutricao' ? renderNutricao(currentUser) : ''}
        ${state.activeTab === 'alimentacao' ? renderAlimentacao() : ''}
        ${state.activeTab === 'evolucao' ? renderEvolucao(bodyMetrics, currentUser) : ''}
        ${state.activeTab === 'admin_tasks' && isAdmin() ? renderAdminTasks() : ''}
        ${state.activeTab === 'admin_suggestions' && isAdmin() ? renderAdminSuggestions() : ''}
        ${state.activeTab === 'admin_security' && isAdmin() ? renderAdminSecurity() : ''}
        ${state.activeTab === 'suggestions' && !isAdmin() ? renderUserSuggestions() : ''}
      </main>
    </div>

    <footer class="bg-black/60 backdrop-blur-lg border-t border-purple-500/30 py-8 mt-12">
      <div class="max-w-7xl mx-auto px-4 text-center">
        <p class="text-slate-400">Vers√£o completa: todas as marmitas restauradas; archive/soft-delete implementado; IndexedDB como DB local.</p>
      </div>
    </footer>
  `;

  // after injecting DOM, hook forms / draw chart if needed
  if (state.activeTab === 'evolucao') {
    renderMuscleEvolutionChart(bodyMetrics, currentUser.id);
    setupWorkoutFormListeners();
  }
  
  // Load progress photos for current user
  if (state.activeTab === 'fotos') {
    loadProgressPhotos();
  }

  // attach metric form listener if exists
  const metricsForm = document.getElementById('metricsForm');
  if (metricsForm) metricsForm.addEventListener('submit', handleAddMetrics);
  
  // attach custom meal form listener if in alimentacao tab
  if (state.activeTab === 'alimentacao') {
    const customMealForm = document.getElementById('customMealForm');
    if (customMealForm) customMealForm.addEventListener('submit', handleAddCustomMeal);
    
    // attach meal buttons using event delegation
    attachMealButtons();
    
    // attach delete buttons using event delegation
    attachMealDeleteButtons();
  }
  
  // attach workout form and buttons if in treino tab
  if (state.activeTab === 'treino') {
    const customWorkoutForm = document.getElementById('customWorkoutForm');
    if (customWorkoutForm) customWorkoutForm.addEventListener('submit', handleAddCustomWorkout);
    
    // attach workout buttons using event delegation
    attachWorkoutButtons();
    
    // attach workout delete buttons using event delegation
    attachWorkoutDeleteButtons();
  }
  
  // attach progress photo form if in fotos tab
  if (state.activeTab === 'fotos') {
    const photoForm = document.getElementById('progressPhotoForm');
    if (photoForm) photoForm.addEventListener('submit', handleAddProgressPhoto);
  }
  
  // Admin tabs - load data and attach event listeners
  if (state.activeTab === 'admin_tasks' && isAdmin()) {
    loadAndDisplayTasks();
  }
  
  if (state.activeTab === 'admin_suggestions' && isAdmin()) {
    loadAndDisplayAdminSuggestions();
  }
  
  if (state.activeTab === 'admin_security' && isAdmin()) {
    loadAndDisplaySecurityEvents();
    startAdminSecurityAutoRefresh(); // Start auto-refresh when admin visits security panel
  } else {
    stopAdminSecurityAutoRefresh(); // Stop auto-refresh when leaving security panel
  }
  
  // User suggestions tab
  if (state.activeTab === 'suggestions' && !isAdmin()) {
    loadAndDisplayUserSuggestions();
    const suggestionForm = document.getElementById('suggestionForm');
    if (suggestionForm) suggestionForm.addEventListener('submit', handleSuggestionFormSubmit);
  }
  
  // Log page access for monitoring (only when authenticated)
  if (authState.isAuthenticated) {
    logPageAccess().catch(err => console.error('Failed to log page access', err));
  }
}

/* ----------------------------- SMALL RENDER COMPONENTS ----------------------------- */

function renderDashboard(user, latest) {
  const notes = buildReferenceNotesForNutrition();
  return `
    <div class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div class="md:col-span-2 bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl p-6 text-white shadow-xl">
          <p class="text-blue-200 text-sm mb-2">PESO ATUAL</p>
          <p class="text-4xl font-bold">${latest.weight} kg</p>
          <p class="text-blue-200 text-xs mt-2">Meta: ${user.goals.weight} kg</p>
        </div>
        <div class="bg-gradient-to-br from-red-600 to-red-800 rounded-2xl p-6">
          <p class="text-red-200 text-sm mb-2">GORDURA</p>
          <p class="text-4xl font-bold">${latest.bodyFat}%</p>
        </div>
        <div class="bg-gradient-to-br from-green-600 to-green-800 rounded-2xl p-6">
          <p class="text-green-200 text-sm mb-2">MASSA MUSCULAR</p>
          <p class="text-4xl font-bold">${latest.muscleMass} kg</p>
        </div>
        <div class="bg-gradient-to-br from-yellow-600 to-amber-700 rounded-2xl p-6">
          <p class="text-yellow-200 text-sm mb-2">METABOLISMO BASAL</p>
          <p class="text-2xl font-bold">${latest.bmr || '-' } kcal</p>
        </div>
        <div class="bg-gradient-to-br from-cyan-600 to-sky-700 rounded-2xl p-6">
          <p class="text-cyan-200 text-sm mb-2">√ÅGUA</p>
          <p class="text-2xl font-bold">${latest.waterWeight || 0} kg (${latest.waterPercent || 0}%)</p>
        </div>
      </div>

      <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700">
        <h3 class="text-2xl font-bold mb-3">Notas cient√≠ficas</h3>
        <p class="text-slate-300 text-sm">${notes || 'Importe refer√™ncias na aba CI√äNCIA para ver notas cient√≠ficas aplicadas.'}</p>
      </div>
    </div>
  `;
}

function renderTreino(user) {
  if (!user.workoutHistory) user.workoutHistory = [];
  
  // Filter workouts for the selected day
  const selectedDayWorkouts = user.workoutHistory.filter(w => w.date === state.currentWorkoutDay);
  
  // Format date for display
  const displayDate = new Date(state.currentWorkoutDay + 'T00:00:00');
  const isToday = state.currentWorkoutDay === new Date().toISOString().split('T')[0];
  const dateLabel = isToday ? 'Hoje' : displayDate.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'short' });
  
  return `
    <!-- Day Navigation -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <div class="flex justify-between items-center">
        <button onclick="goToPreviousWorkoutDay()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded">‚Üê Dia Anterior</button>
        <div class="text-center">
          <p class="text-lg font-bold">${dateLabel}</p>
          <p class="text-sm text-slate-300">${state.currentWorkoutDay}</p>
        </div>
        <button onclick="goToNextWorkoutDay()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded">Pr√≥ximo Dia ‚Üí</button>
      </div>
      ${!isToday ? `<div class="mt-2 text-center"><button onclick="goToTodayWorkout()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Ir para Hoje</button></div>` : ''}
    </div>

    <!-- Workout Templates -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold text-xl mb-3">üèãÔ∏è Selecione seu Treino</h3>
      <div class="grid md:grid-cols-2 gap-4">
        ${Object.values(templates).map(t => `
          <div class="bg-gradient-to-br from-slate-700 to-slate-800 p-4 rounded-lg border border-purple-500/30">
            <h4 class="font-bold text-xl mb-2 text-purple-300">${t.name}</h4>
            <p class="text-slate-300 text-sm mb-3">${t.description}</p>
            ${t.sessions.A.primaryMuscles ? `
              <div class="mb-3 flex flex-wrap gap-1">
                ${t.sessions.A.primaryMuscles.map(m => `<span class="text-xs px-2 py-1 bg-purple-900/50 text-purple-200 rounded">${m}</span>`).join('')}
              </div>
            ` : ''}
            <button onclick="showWorkoutExercises('${t.id}')" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded text-sm w-full font-semibold">
              üìã Ver e Registrar Exerc√≠cios
            </button>
          </div>
        `).join('')}
      </div>
    </div>

    <!-- Workout Exercise Form (Hidden by default, shown when template selected) -->
    <div id="workoutExercisesForm" class="hidden bg-slate-800 p-4 rounded mb-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-xl">üí™ Registrar Exerc√≠cios</h3>
        <button onclick="hideWorkoutExercises()" class="text-red-400 hover:text-red-300">‚úï Fechar</button>
      </div>
      <div id="exercisesList"></div>
    </div>

    <!-- Workout History for Selected Day -->
    <div class="bg-slate-800 p-4 rounded">
      <h3 class="font-bold text-xl mb-3">üìã Hist√≥rico de ${dateLabel}</h3>
      ${selectedDayWorkouts.length === 0 ? 
        `<p class="text-slate-400">Nenhum treino registrado neste dia. Selecione um treino acima e registre seus exerc√≠cios.</p>` :
        `<div class="space-y-2">
          ${selectedDayWorkouts.map(log => `
            <div class="flex justify-between items-center bg-slate-700 p-3 rounded">
              <div class="flex-1">
                <p class="font-semibold">${log.exercise || log.workout}</p>
                <p class="text-slate-300 text-xs">${log.category ? `${log.category} ‚Ä¢ ` : ''}${log.time}${log.sets && log.sets !== '-' ? ` ‚Ä¢ ${log.sets}x${log.reps}` : ''}${log.weight && log.weight !== '-' ? ` ‚Ä¢ ${log.weight}kg` : ''}</p>
              </div>
              <div class="flex gap-2">
                <button onclick="handleEditWorkout(${log.id})" class="text-blue-400 hover:text-blue-300" title="Editar s√©ries/reps/carga">‚úèÔ∏è</button>
                <button data-workout-id="${log.id}" class="workout-delete-btn text-red-400 hover:text-red-300" title="Excluir registro">üóëÔ∏è</button>
              </div>
            </div>
          `).join('')}
        </div>`
      }
    </div>
  `;
}

/* ----------------------------- Nutrition Database with Scientific Basis -----------------------------
   Daily recommended amounts for healthy muscle gain and body composition based on:
   - Phillips SM. et al. 2022 (Protein requirements 1.6-2.2 g/kg/d)
   - Schoenfeld BJ. 2023 (Protein timing and distribution)
   - Wang Z. et al. 2024 (Creatine supplementation)
   - Position of the Academy of Nutrition and Dietetics (protein and carbs for athletes)
   
   Recommendations are tailored to:
   - Basal Metabolic Rate (BMR) 
   - Total Daily Energy Expenditure (TDEE)
   - Body composition goals (muscle gain, fat loss, or maintenance)
   - Gender-specific needs
---------------------------------------------------------------------------------------------------- */

function calculateNutritionRecommendations(user) {
  const latestMetrics = user.bodyMetrics && user.bodyMetrics.length > 0 
    ? user.bodyMetrics[user.bodyMetrics.length - 1] 
    : { weight: 70, bmr: 1600, tdee: 2200 };
  
  const weight = latestMetrics.weight || 70;
  const bmr = latestMetrics.bmr || calculateBMR(weight, user.height, user.age, user.gender);
  const tdee = latestMetrics.tdee || (bmr * 1.55); // Moderate activity level
  const goals = user.goals || { weight: weight + 5, muscleMass: (latestMetrics.muscleMass || 25) + 3 };
  
  // Determine if bulking, cutting, or maintaining
  const isGaining = goals.weight > weight;
  const calorieAdjustment = isGaining ? (user.gender === 'male' ? 400 : 300) : -300;
  const targetCalories = Math.round(tdee + calorieAdjustment);
  
  // Protein: 1.8-2.2 g/kg for muscle gain (Phillips 2022)
  const proteinGramsPerKg = isGaining ? 2.0 : 1.8;
  const proteinGrams = Math.round(weight * proteinGramsPerKg);
  const proteinCalories = proteinGrams * 4;
  
  // Fat: 0.8-1.0 g/kg for hormonal health
  const fatGramsPerKg = 0.9;
  const fatGrams = Math.round(weight * fatGramsPerKg);
  const fatCalories = fatGrams * 9;
  
  // Carbs: remaining calories
  const carbCalories = targetCalories - proteinCalories - fatCalories;
  const carbGrams = Math.round(carbCalories / 4);
  
  // Food recommendations based on macros
  // Protein sources (all values per 100g unless specified)
  const foods = {
    // Protein sources
    chicken: {
      name: 'Frango (peito)',
      portion: Math.round(proteinGrams * 0.4 / 0.31), // 40% of protein from chicken (31g protein per 100g)
      unit: 'g',
      macro: 'Prote√≠na',
      perDay: 'daily',
      protein: 31,
      carbs: 0,
      fat: 3.6,
      kcal: 165,
      note: 'Fonte magra de prote√≠na de alta qualidade'
    },
    eggs: {
      name: 'Ovos',
      portion: Math.round(proteinGrams * 0.25 / 6.3), // 25% of protein from eggs (6.3g per egg)
      unit: 'unidades',
      macro: 'Prote√≠na',
      perDay: 'daily',
      protein: 6.3,
      carbs: 0.6,
      fat: 5,
      kcal: 72,
      note: 'Prote√≠na completa com todos amino√°cidos essenciais'
    },
    whey: {
      name: 'Whey Protein',
      portion: Math.round(proteinGrams * 0.25 / 25), // 25% of protein from whey (25g per scoop)
      unit: 'scoop (30g)',
      macro: 'Prote√≠na',
      perDay: 'daily',
      protein: 25,
      carbs: 3,
      fat: 1.5,
      kcal: 120,
      note: 'Suplemento p√≥s-treino para s√≠ntese proteica r√°pida'
    },
    
    // Carb sources
    bread: {
      name: 'P√£o integral',
      portion: Math.round(carbGrams * 0.15 / 49), // 15% of carbs from bread (49g carbs per 100g)
      unit: 'fatias (25g cada)',
      macro: 'Carboidrato',
      perDay: 'daily',
      protein: 9,
      carbs: 49,
      fat: 3.5,
      kcal: 265,
      note: 'Fonte de carboidratos complexos e fibras'
    },
    rice: {
      name: 'Arroz integral',
      portion: Math.round(carbGrams * 0.35 / 23), // 35% of carbs from rice (23g per 100g cooked)
      unit: 'g (cozido)',
      macro: 'Carboidrato',
      perDay: 'daily',
      protein: 2.6,
      carbs: 23,
      fat: 0.9,
      kcal: 111,
      note: 'Energia sustentada para treinos'
    },
    sweetPotato: {
      name: 'Batata doce',
      portion: Math.round(carbGrams * 0.25 / 20), // 25% of carbs from sweet potato (20g per 100g)
      unit: 'g',
      macro: 'Carboidrato',
      perDay: 'daily',
      protein: 1.6,
      carbs: 20,
      fat: 0.1,
      kcal: 86,
      note: 'Carboidrato de baixo √≠ndice glic√™mico'
    },
    
    // Fat sources
    peanutButter: {
      name: 'Pasta de amendoim',
      portion: Math.round(fatGrams * 0.3 / 50 * 100), // 30% of fat from PB (50g fat per 100g)
      unit: 'g',
      macro: 'Gordura',
      perDay: 'daily',
      protein: 25,
      carbs: 20,
      fat: 50,
      kcal: 588,
      note: 'Gorduras saud√°veis e prote√≠na adicional'
    },
    avocado: {
      name: 'Abacate',
      portion: Math.round(fatGrams * 0.2 / 15), // 20% of fat from avocado (15g per 100g)
      unit: 'g',
      macro: 'Gordura',
      perDay: 'daily',
      protein: 2,
      carbs: 9,
      fat: 15,
      kcal: 160,
      note: 'Gorduras monoinsaturadas e fibras'
    },
    
    // Supplements
    creatine: {
      name: 'Creatina',
      portion: 5,
      unit: 'g',
      macro: 'Suplemento',
      perDay: 'daily',
      protein: 0,
      carbs: 0,
      fat: 0,
      kcal: 0,
      note: 'Melhora for√ßa e ganho de massa muscular (Wang 2024)'
    }
  };
  
  return {
    targetCalories,
    bmr,
    tdee,
    proteinGrams,
    carbGrams,
    fatGrams,
    foods,
    isGaining
  };
}

function renderNutritionRecommendations(user) {
  const nutrition = calculateNutritionRecommendations(user);
  const foods = nutrition.foods;
  
  return `
    <div class="bg-gradient-to-r from-green-700 to-emerald-800 p-6 rounded-xl mb-6">
      <h4 class="font-bold text-xl mb-4">üéØ Metas Nutricionais Personalizadas</h4>
      <div class="grid md:grid-cols-4 gap-4">
        <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
          <p class="text-sm text-green-100 mb-1">TMB (Basal)</p>
          <p class="text-3xl font-bold">${nutrition.bmr}</p>
          <p class="text-xs text-green-200">kcal/dia</p>
        </div>
        <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
          <p class="text-sm text-green-100 mb-1">TDEE (Total)</p>
          <p class="text-3xl font-bold">${Math.round(nutrition.tdee)}</p>
          <p class="text-xs text-green-200">kcal/dia</p>
        </div>
        <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
          <p class="text-sm text-green-100 mb-1">Meta Cal√≥rica</p>
          <p class="text-3xl font-bold">${nutrition.targetCalories}</p>
          <p class="text-xs text-green-200">${nutrition.isGaining ? 'Ganho' : 'Perda'}</p>
        </div>
        <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
          <p class="text-sm text-green-100 mb-1">Macros</p>
          <p class="text-lg font-bold">${nutrition.proteinGrams}P</p>
          <p class="text-lg font-bold">${nutrition.carbGrams}C ‚Ä¢ ${nutrition.fatGrams}G</p>
        </div>
      </div>
    </div>

    <div class="bg-slate-800 p-6 rounded-xl mb-6">
      <h4 class="font-bold text-xl mb-4">üçó Base de Alimenta√ß√£o Di√°ria Recomendada</h4>
      <p class="text-slate-300 text-sm mb-4">Quantidades calculadas com base no seu metabolismo basal (${nutrition.bmr} kcal), TDEE (${Math.round(nutrition.tdee)} kcal) e metas de composi√ß√£o corporal. Baseado em estudos cient√≠ficos (Phillips 2022, Schoenfeld 2023, Wang 2024).</p>
      
      <!-- Protein Sources -->
      <div class="mb-6">
        <h5 class="font-semibold text-lg text-blue-300 mb-3">üí™ Fontes de Prote√≠na (Meta: ${nutrition.proteinGrams}g/dia)</h5>
        <div class="grid md:grid-cols-3 gap-4">
          ${[foods.chicken, foods.eggs, foods.whey].map(food => `
            <div class="bg-slate-700 p-4 rounded-lg">
              <div class="flex justify-between items-start mb-2">
                <p class="font-bold text-lg">${food.name}</p>
                <span class="bg-blue-600 px-2 py-1 rounded text-xs">${food.macro}</span>
              </div>
              <p class="text-3xl font-bold text-blue-400 mb-2">${food.portion}</p>
              <p class="text-sm text-slate-300 mb-3">${food.unit} por dia</p>
              <div class="text-xs text-slate-400 space-y-1">
                ${food.protein ? `<p>Prote√≠na: ~${Math.round(food.portion * food.protein / (food.unit === 'unidades' ? 1 : food.unit === 'scoop (30g)' ? 1 : 100))}g</p>` : ''}
                ${food.kcal ? `<p>Calorias: ~${Math.round(food.portion * food.kcal / (food.unit === 'unidades' ? 1 : food.unit === 'scoop (30g)' ? 1 : 100))}kcal</p>` : ''}
              </div>
              <p class="text-xs text-green-300 mt-3">${food.note}</p>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Carb Sources -->
      <div class="mb-6">
        <h5 class="font-semibold text-lg text-orange-300 mb-3">üåæ Fontes de Carboidratos (Meta: ${nutrition.carbGrams}g/dia)</h5>
        <div class="grid md:grid-cols-3 gap-4">
          ${[foods.bread, foods.rice, foods.sweetPotato].map(food => `
            <div class="bg-slate-700 p-4 rounded-lg">
              <div class="flex justify-between items-start mb-2">
                <p class="font-bold text-lg">${food.name}</p>
                <span class="bg-orange-600 px-2 py-1 rounded text-xs">${food.macro}</span>
              </div>
              <p class="text-3xl font-bold text-orange-400 mb-2">${food.portion}</p>
              <p class="text-sm text-slate-300 mb-3">${food.unit} por dia</p>
              <div class="text-xs text-slate-400 space-y-1">
                ${food.carbs ? `<p>Carboidratos: ~${Math.round(food.portion * food.carbs / 100)}g</p>` : ''}
                ${food.kcal ? `<p>Calorias: ~${Math.round(food.portion * food.kcal / 100)}kcal</p>` : ''}
              </div>
              <p class="text-xs text-green-300 mt-3">${food.note}</p>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Fat Sources -->
      <div class="mb-6">
        <h5 class="font-semibold text-lg text-yellow-300 mb-3">ü•ë Fontes de Gorduras Saud√°veis (Meta: ${nutrition.fatGrams}g/dia)</h5>
        <div class="grid md:grid-cols-2 gap-4">
          ${[foods.peanutButter, foods.avocado].map(food => `
            <div class="bg-slate-700 p-4 rounded-lg">
              <div class="flex justify-between items-start mb-2">
                <p class="font-bold text-lg">${food.name}</p>
                <span class="bg-yellow-600 px-2 py-1 rounded text-xs">${food.macro}</span>
              </div>
              <p class="text-3xl font-bold text-yellow-400 mb-2">${food.portion}</p>
              <p class="text-sm text-slate-300 mb-3">${food.unit} por dia</p>
              <div class="text-xs text-slate-400 space-y-1">
                ${food.fat ? `<p>Gorduras: ~${Math.round(food.portion * food.fat / 100)}g</p>` : ''}
                ${food.kcal ? `<p>Calorias: ~${Math.round(food.portion * food.kcal / 100)}kcal</p>` : ''}
              </div>
              <p class="text-xs text-green-300 mt-3">${food.note}</p>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Supplements -->
      <div class="mb-6">
        <h5 class="font-semibold text-lg text-purple-300 mb-3">üíä Suplementa√ß√£o Baseada em Evid√™ncias</h5>
        <div class="grid md:grid-cols-2 gap-4">
          ${[foods.creatine, foods.whey].map(food => `
            <div class="bg-slate-700 p-4 rounded-lg border-2 border-purple-500">
              <div class="flex justify-between items-start mb-2">
                <p class="font-bold text-lg">${food.name}</p>
                <span class="bg-purple-600 px-2 py-1 rounded text-xs">${food.macro}</span>
              </div>
              <p class="text-3xl font-bold text-purple-400 mb-2">${food.portion}</p>
              <p class="text-sm text-slate-300 mb-3">${food.unit} por dia</p>
              <p class="text-xs text-green-300 mt-3">${food.note}</p>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Scientific Notes -->
      <div class="bg-gradient-to-r from-cyan-900 to-blue-900 p-4 rounded-lg">
        <h5 class="font-semibold text-lg mb-2">üî¨ Base Cient√≠fica</h5>
        <div class="text-sm text-slate-300 space-y-2">
          <p><strong>Prote√≠na:</strong> Recomenda√ß√£o de 1.8-2.2 g/kg/dia para otimizar s√≠ntese proteica e hipertrofia muscular (Phillips et al., 2022).</p>
          <p><strong>Timing:</strong> Distribuir prote√≠na em 4-6 refei√ß√µes ao longo do dia, com 20-40g por refei√ß√£o (Schoenfeld et al., 2023).</p>
          <p><strong>Creatina:</strong> 5g/dia melhora for√ßa e ganho de massa muscular em adultos que praticam treinamento resistido (Wang et al., 2024).</p>
          <p><strong>Carboidratos:</strong> Essenciais para reposi√ß√£o de glicog√™nio e performance em treinos intensos. Ajustar conforme n√≠vel de atividade.</p>
          <p><strong>Gorduras:</strong> 0.8-1.0 g/kg/dia para suporte hormonal e absor√ß√£o de vitaminas lipossol√∫veis.</p>
        </div>
      </div>
    </div>
  `;
}

function renderNutricao(user) {
  const notes = buildReferenceNotesForNutrition();
  return `
    ${renderNutritionRecommendations(user)}
    
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold">Plano nutricional (resumo)</h3>
      <p class="text-slate-300 text-sm">${notes || 'Importe refer√™ncias na aba CI√äNCIA para ver recomenda√ß√µes.'}</p>
      <div class="mt-3 text-slate-300 text-sm">
        <p class="mb-2"><strong>Dicas pr√°ticas:</strong></p>
        <ul class="list-disc list-inside space-y-1 text-sm">
          <li>Distribua a prote√≠na em 4-6 refei√ß√µes ao longo do dia</li>
          <li>Consuma 20-40g de prote√≠na a cada 3-4 horas</li>
          <li>Tome creatina diariamente (5g), preferencialmente com carboidratos</li>
          <li>Whey protein ideal no p√≥s-treino (janela de 0-2h)</li>
          <li>Carboidratos concentrados antes e ap√≥s treinos intensos</li>
          <li>Gorduras saud√°veis em todas as refei√ß√µes principais</li>
          <li>Hidrate-se: m√≠nimo 35ml/kg de peso corporal por dia</li>
        </ul>
      </div>
    </div>
  `;
}

function renderAlimentacao() {
  const currentUser = state.users[state.activeUser];
  const mealHistory = currentUser.mealHistory || [];
  
  // Filter meals for the selected day
  const selectedDayMeals = mealHistory.filter(m => m.date === state.currentDay);
  
  // Calculate totals for the selected day
  const dayTotals = selectedDayMeals.reduce((acc, log) => {
    // Check if it's a composed meal with stored totals
    if (log.isComposed && log.totalKcal !== undefined) {
      acc.kcal += log.totalKcal;
      acc.prot += log.totalProt || 0;
      acc.carb += log.totalCarb || 0;
      acc.fat += log.totalFat || 0;
    } else {
      // Regular meal - look up nutrition
      const nut = getMealNutritionByNameCombined(log.meal);
      acc.kcal += nut.kcal;
      acc.prot += nut.prot;
      acc.carb += nut.carb || 0;
      acc.fat += nut.fat;
    }
    return acc;
  }, { kcal: 0, prot: 0, carb: 0, fat: 0 });
  
  // Format date for display
  const displayDate = new Date(state.currentDay + 'T00:00:00');
  const isToday = state.currentDay === new Date().toISOString().split('T')[0];
  const dateLabel = isToday ? 'Hoje' : displayDate.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'short' });
  
  return `
    <!-- Day Navigation -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <div class="flex justify-between items-center">
        <button onclick="goToPreviousDay()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded">‚Üê Dia Anterior</button>
        <div class="text-center">
          <p class="text-lg font-bold">${dateLabel}</p>
          <p class="text-sm text-slate-300">${state.currentDay}</p>
        </div>
        <button onclick="goToNextDay()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded">Pr√≥ximo Dia ‚Üí</button>
      </div>
      ${!isToday ? `<div class="mt-2 text-center"><button onclick="goToToday()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Ir para Hoje</button></div>` : ''}
    </div>

    <!-- Day Totals -->
    <div class="bg-gradient-to-r from-green-600 to-green-800 p-4 rounded mb-6">
      <h4 class="font-bold text-lg">Totais de ${dateLabel}</h4>
      <p class="text-white text-xl">${Math.round(dayTotals.kcal)} kcal ‚Ä¢ ${Math.round(dayTotals.prot)}g prot ‚Ä¢ ${Math.round(dayTotals.carb)}g carb ‚Ä¢ ${Math.round(dayTotals.fat)}g gord</p>
    </div>

    <!-- Nutrition Calculator & Guide -->
    <div class="bg-gradient-to-br from-blue-900 to-indigo-900 p-6 rounded-xl mb-6 border-2 border-blue-500">
      <h3 class="font-bold text-2xl mb-4 flex items-center gap-2">
        üßÆ Calculadora de Macronutrientes
        <span class="text-xs font-normal bg-yellow-500 text-black px-2 py-1 rounded">NOVO</span>
      </h3>
      
      <div class="bg-white/10 backdrop-blur p-5 rounded-lg mb-6">
        <h4 class="font-semibold text-lg mb-3 text-cyan-300">üìö Como Calcular os Macros da sua Refei√ß√£o</h4>
        <div class="space-y-3 text-sm text-slate-200">
          <p class="leading-relaxed"><strong>1. Pese os alimentos crus</strong> (antes de cozinhar) sempre que poss√≠vel, pois as tabelas nutricionais se referem ao peso cru.</p>
          <p class="leading-relaxed"><strong>2. Use a regra de tr√™s simples:</strong> Se a tabela nutricional informa valores para 100g, e voc√™ tem 150g, multiplique por 1.5 (150 √∑ 100).</p>
          <p class="leading-relaxed"><strong>3. Lembre-se das calorias por grama:</strong></p>
          <ul class="list-disc list-inside ml-4 space-y-1">
            <li><strong>Prote√≠na:</strong> 4 kcal por grama</li>
            <li><strong>Carboidrato:</strong> 4 kcal por grama</li>
            <li><strong>Gordura:</strong> 9 kcal por grama</li>
          </ul>
          <p class="leading-relaxed"><strong>4. Some todos os ingredientes</strong> da sua refei√ß√£o para obter o total.</p>
        </div>
      </div>

      <!-- Food Database Browser -->
      <div class="bg-slate-800 p-5 rounded-lg mb-4">
        <h4 class="font-semibold text-lg mb-4 text-yellow-300">üìö Banco de Alimentos Comuns</h4>
        <p class="text-sm text-slate-300 mb-4">Selecione um alimento da lista para preencher automaticamente a calculadora. Valores baseados na Tabela TACO (Tabela Brasileira de Composi√ß√£o de Alimentos).</p>
        
        <!-- Search box -->
        <div class="mb-4">
          <input type="text" id="foodSearchInput" placeholder="üîç Buscar alimento..." onkeyup="filterFoods()" class="w-full px-4 py-2 rounded bg-slate-700 text-white" />
        </div>

        <!-- Food categories -->
        <div class="grid md:grid-cols-2 gap-4" id="foodCategoriesContainer">
          ${Object.keys(commonFoods).map(category => `
            <div class="bg-slate-700 p-4 rounded food-category">
              <h5 class="font-semibold mb-3 capitalize ${
                category === 'proteinas' ? 'text-blue-300' :
                category === 'carboidratos' ? 'text-orange-300' :
                category === 'gorduras' ? 'text-yellow-300' :
                'text-green-300'
              }">
                ${category === 'proteinas' ? 'üí™ Prote√≠nas' :
                  category === 'carboidratos' ? 'üåæ Carboidratos' :
                  category === 'gorduras' ? 'ü•ë Gorduras Saud√°veis' :
                  'ü•ó Vegetais'}
              </h5>
              <div class="space-y-2 max-h-64 overflow-y-auto">
                ${commonFoods[category].map((food, idx) => `
                  <div class="food-item bg-slate-800 p-2 rounded hover:bg-slate-600 cursor-pointer transition-colors" data-food-name="${food.name}" onclick="selectFood('${category}', ${idx})">
                    <p class="font-medium text-sm">${food.name}</p>
                    <p class="text-xs text-slate-400">${food.kcal} kcal ‚Ä¢ ${food.prot}g P ‚Ä¢ ${food.carb}g C ‚Ä¢ ${food.fat}g G (${food.per} ${food.unit})</p>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Interactive Calculator -->
      <div class="bg-slate-800 p-5 rounded-lg mb-4">
        <h4 class="font-semibold text-lg mb-4 text-green-300">üî¢ Calculadora Interativa</h4>
        <div class="space-y-4">
          <!-- Food input -->
          <div class="grid md:grid-cols-6 gap-3">
            <input type="text" id="calcFoodName" placeholder="Nome do alimento" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <input type="number" id="calcWeight" placeholder="Peso (g)" step="0.1" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <input type="number" id="calcProtPer100" placeholder="Prot/100g" step="0.1" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <input type="number" id="calcCarbPer100" placeholder="Carb/100g" step="0.1" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <input type="number" id="calcFatPer100" placeholder="Gord/100g" step="0.1" class="px-3 py-2 rounded bg-slate-700 text-white" />
            <button onclick="calculateMacros()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded font-semibold">Calcular</button>
          </div>
          
          <!-- Results -->
          <div id="calcResults" class="hidden bg-gradient-to-r from-green-700 to-emerald-800 p-4 rounded-lg">
            <h5 class="font-semibold mb-2">Resultado do C√°lculo:</h5>
            <div class="grid md:grid-cols-4 gap-3 text-center">
              <div class="bg-white/10 backdrop-blur p-3 rounded">
                <p class="text-xs text-green-200 mb-1">Prote√≠na</p>
                <p class="text-2xl font-bold" id="resultProt">0g</p>
                <p class="text-xs text-green-300" id="resultProtKcal">0 kcal</p>
              </div>
              <div class="bg-white/10 backdrop-blur p-3 rounded">
                <p class="text-xs text-orange-200 mb-1">Carboidrato</p>
                <p class="text-2xl font-bold" id="resultCarb">0g</p>
                <p class="text-xs text-orange-300" id="resultCarbKcal">0 kcal</p>
              </div>
              <div class="bg-white/10 backdrop-blur p-3 rounded">
                <p class="text-xs text-yellow-200 mb-1">Gordura</p>
                <p class="text-2xl font-bold" id="resultFat">0g</p>
                <p class="text-xs text-yellow-300" id="resultFatKcal">0 kcal</p>
              </div>
              <div class="bg-white/10 backdrop-blur p-3 rounded">
                <p class="text-xs text-cyan-200 mb-1">Total</p>
                <p class="text-2xl font-bold" id="resultTotal">0 kcal</p>
                <p class="text-xs text-cyan-300">calorias totais</p>
              </div>
            </div>
            <!-- Add to Meal Composition Button -->
            <div class="mt-4 text-center">
              <button onclick="addComponentToMeal()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-semibold text-white">
                ‚ûï Adicionar √† Refei√ß√£o Composta
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Meal Composition Builder -->
      ${state.currentMealComposition.components.length > 0 ? `
      <div class="bg-gradient-to-r from-purple-900 to-indigo-900 p-5 rounded-lg mb-4 border-2 border-purple-500">
        <div class="flex justify-between items-center mb-4">
          <h4 class="font-semibold text-lg text-purple-200">üçΩÔ∏è Refei√ß√£o Composta em Constru√ß√£o</h4>
          <button onclick="resetMealComposition()" class="text-red-400 hover:text-red-300 text-sm">
            üóëÔ∏è Limpar
          </button>
        </div>
        
        <!-- Components List -->
        <div class="space-y-2 mb-4">
          ${state.currentMealComposition.components.map((comp, idx) => `
            <div class="bg-slate-800 p-3 rounded flex justify-between items-center">
              <div class="flex-1">
                <p class="font-semibold text-white">${comp.foodName}</p>
                <p class="text-xs text-slate-300">${comp.weight}g ‚Ä¢ ${comp.prot}g prot ‚Ä¢ ${comp.carb}g carb ‚Ä¢ ${comp.fat}g gord ‚Ä¢ ${comp.kcal} kcal</p>
              </div>
              <button onclick="removeComponentFromMeal(${comp.id})" class="text-red-400 hover:text-red-300 ml-2" title="Remover componente">
                ‚úñ
              </button>
            </div>
          `).join('')}
        </div>
        
        <!-- Totals -->
        <div class="bg-gradient-to-r from-green-700 to-emerald-800 p-4 rounded-lg border-2 border-green-500">
          <h5 class="font-bold text-lg mb-3 text-center text-white">üìä Totais da Refei√ß√£o</h5>
          <div class="grid grid-cols-5 gap-2 text-center">
            <div class="bg-white/10 backdrop-blur p-2 rounded">
              <p class="text-xs text-slate-300 mb-1">Peso Total</p>
              <p class="text-xl font-bold text-white">${state.currentMealComposition.totalWeight}g</p>
            </div>
            <div class="bg-white/10 backdrop-blur p-2 rounded">
              <p class="text-xs text-green-200 mb-1">Prote√≠na</p>
              <p class="text-xl font-bold text-green-300">${state.currentMealComposition.totalProt}g</p>
            </div>
            <div class="bg-white/10 backdrop-blur p-2 rounded">
              <p class="text-xs text-orange-200 mb-1">Carboidrato</p>
              <p class="text-xl font-bold text-orange-300">${state.currentMealComposition.totalCarb}g</p>
            </div>
            <div class="bg-white/10 backdrop-blur p-2 rounded">
              <p class="text-xs text-yellow-200 mb-1">Gordura</p>
              <p class="text-xl font-bold text-yellow-300">${state.currentMealComposition.totalFat}g</p>
            </div>
            <div class="bg-white/10 backdrop-blur p-2 rounded">
              <p class="text-xs text-cyan-200 mb-1">Calorias</p>
              <p class="text-xl font-bold text-cyan-300">${state.currentMealComposition.totalKcal}</p>
            </div>
          </div>
        </div>
        
        <!-- Save Button -->
        <div class="mt-4 text-center">
          <button onclick="saveComposedMeal()" class="bg-green-600 hover:bg-green-500 px-8 py-3 rounded-lg font-bold text-lg text-white">
            üíæ Salvar Refei√ß√£o Composta no Hist√≥rico
          </button>
        </div>
      </div>
      ` : ''}

      <!-- Examples Section -->
      <div class="bg-slate-800 p-5 rounded-lg">
        <h4 class="font-semibold text-lg mb-3 text-yellow-300">üí° Exemplos Pr√°ticos</h4>
        <div class="space-y-4">
          <div class="bg-slate-700 p-4 rounded">
            <p class="font-bold text-blue-300 mb-2">Exemplo 1: Frango Grelhado (150g)</p>
            <p class="text-sm text-slate-300 mb-2">Valores por 100g: 31g prot, 0g carb, 3.6g gord</p>
            <div class="bg-slate-800 p-3 rounded text-sm">
              <p class="mb-1"><strong>C√°lculo:</strong></p>
              <p>‚Ä¢ Prote√≠na: 31g √ó 1.5 = <strong class="text-green-400">46.5g</strong> = 186 kcal</p>
              <p>‚Ä¢ Carboidrato: 0g √ó 1.5 = <strong class="text-orange-400">0g</strong> = 0 kcal</p>
              <p>‚Ä¢ Gordura: 3.6g √ó 1.5 = <strong class="text-yellow-400">5.4g</strong> = 48.6 kcal</p>
              <p class="mt-2 text-cyan-400"><strong>Total: 234.6 kcal</strong></p>
            </div>
            <button onclick="fillCalculatorExample('Frango grelhado', 150, 31, 0, 3.6)" class="mt-2 bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Testar na Calculadora</button>
          </div>

          <div class="bg-slate-700 p-4 rounded">
            <p class="font-bold text-blue-300 mb-2">Exemplo 2: Arroz Integral Cozido (200g)</p>
            <p class="text-sm text-slate-300 mb-2">Valores por 100g: 2.6g prot, 23g carb, 0.9g gord</p>
            <div class="bg-slate-800 p-3 rounded text-sm">
              <p class="mb-1"><strong>C√°lculo:</strong></p>
              <p>‚Ä¢ Prote√≠na: 2.6g √ó 2 = <strong class="text-green-400">5.2g</strong> = 20.8 kcal</p>
              <p>‚Ä¢ Carboidrato: 23g √ó 2 = <strong class="text-orange-400">46g</strong> = 184 kcal</p>
              <p>‚Ä¢ Gordura: 0.9g √ó 2 = <strong class="text-yellow-400">1.8g</strong> = 16.2 kcal</p>
              <p class="mt-2 text-cyan-400"><strong>Total: 221 kcal</strong></p>
            </div>
            <button onclick="fillCalculatorExample('Arroz integral cozido', 200, 2.6, 23, 0.9)" class="mt-2 bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Testar na Calculadora</button>
          </div>

          <div class="bg-slate-700 p-4 rounded">
            <p class="font-bold text-blue-300 mb-2">Exemplo 3: Batata Doce (300g)</p>
            <p class="text-sm text-slate-300 mb-2">Valores por 100g: 1.6g prot, 20g carb, 0.1g gord</p>
            <div class="bg-slate-800 p-3 rounded text-sm">
              <p class="mb-1"><strong>C√°lculo:</strong></p>
              <p>‚Ä¢ Prote√≠na: 1.6g √ó 3 = <strong class="text-green-400">4.8g</strong> = 19.2 kcal</p>
              <p>‚Ä¢ Carboidrato: 20g √ó 3 = <strong class="text-orange-400">60g</strong> = 240 kcal</p>
              <p>‚Ä¢ Gordura: 0.1g √ó 3 = <strong class="text-yellow-400">0.3g</strong> = 2.7 kcal</p>
              <p class="mt-2 text-cyan-400"><strong>Total: 261.9 kcal</strong></p>
            </div>
            <button onclick="fillCalculatorExample('Batata doce', 300, 1.6, 20, 0.1)" class="mt-2 bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Testar na Calculadora</button>
          </div>
        </div>
      </div>

      <!-- Tips Section -->
      <div class="bg-gradient-to-r from-purple-900 to-pink-900 p-5 rounded-lg mt-4">
        <h4 class="font-semibold text-lg mb-3">‚ú® Dicas Importantes</h4>
        <ul class="space-y-2 text-sm text-slate-200">
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">‚úì</span>
            <span><strong>Balan√ßa digital:</strong> Investir numa balan√ßa de cozinha precisa (at√© 0.1g) facilita muito o controle.</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">‚úì</span>
            <span><strong>Aplicativos √∫teis:</strong> MyFitnessPal, FatSecret e Cronometer t√™m grandes bancos de dados de alimentos.</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">‚úì</span>
            <span><strong>Cozido vs Cru:</strong> Arroz e macarr√£o absorvem √°gua ao cozinhar (peso aumenta 2-3x, mas calorias n√£o mudam).</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">‚úì</span>
            <span><strong>√ìleos e temperos:</strong> N√£o esque√ßa de contar azeite, √≥leo, manteiga usados no preparo (1 colher sopa ‚âà 15ml ‚âà 135 kcal).</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">‚úì</span>
            <span><strong>Estimativas:</strong> Quando n√£o puder pesar, use aproxima√ß√µes: 1 palma de m√£o = ~100g de prote√≠na, 1 punho = ~150g de carboidrato.</span>
          </li>
        </ul>
      </div>
    </div>

    <!-- Custom Meal Form -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold mb-3">‚ûï Adicionar Refei√ß√£o Personalizada</h3>
      <form id="customMealForm" class="grid md:grid-cols-5 gap-2">
        <input type="text" name="customMealName" placeholder="Nome da refei√ß√£o" required class="px-3 py-2 rounded bg-slate-700 text-white" />
        <input type="number" name="customMealKcal" step="0.1" placeholder="Calorias (kcal)" required class="px-3 py-2 rounded bg-slate-700 text-white" />
        <input type="number" name="customMealProt" step="0.1" placeholder="Prote√≠na (g)" class="px-3 py-2 rounded bg-slate-700 text-white" />
        <input type="number" name="customMealFat" step="0.1" placeholder="Gordura (g)" class="px-3 py-2 rounded bg-slate-700 text-white" />
        <div class="flex flex-col gap-2">
          <label class="flex items-center gap-2 text-sm text-slate-300">
            <input type="checkbox" name="saveAsReusable" class="rounded" />
            Salvar como reutiliz√°vel
          </label>
          <button type="submit" class="bg-green-600 hover:bg-green-500 px-3 py-2 rounded font-semibold">Adicionar</button>
        </div>
      </form>
      <p class="text-slate-400 text-xs mt-2">A refei√ß√£o ser√° registrada para ${dateLabel}. Marque "Salvar como reutiliz√°vel" para adicion√°-la √† lista abaixo.</p>
    </div>

    <!-- Custom Meals List -->
    ${state.customMeals.length > 0 ? `
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold mb-3">üçΩÔ∏è Minhas Refei√ß√µes Personalizadas</h3>
      <div class="grid md:grid-cols-2 gap-3">
        ${state.customMeals.map(m => `
          <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
            <div>
              <p class="font-semibold">${m.name}</p>
              <p class="text-slate-300 text-xs">${m.kcal} kcal ‚Ä¢ ${m.prot}g prot ‚Ä¢ ${m.fat}g gord</p>
            </div>
            <div class="flex gap-2">
              <button data-meal-name="${m.name.replace(/"/g, '&quot;')}" class="meal-register-btn bg-orange-500 hover:bg-orange-400 px-3 py-1 rounded">Registrar</button>
              <button onclick="handleDeleteCustomMeal('${m.id}')" class="text-red-400 hover:text-red-300 px-2">üóëÔ∏è</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
    ` : ''}

    <!-- LiveUp Marmitas -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold mb-3">üç± Marmitas LiveUp (Dispon√≠veis)</h3>
      <div class="grid md:grid-cols-2 gap-3">
        ${livUpMarmitas.map(m => `
          <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
            <div>
              <p class="font-semibold">${m.name}</p>
              <p class="text-slate-300 text-xs">${m.category} ‚Ä¢ ${m.size}${m.kcal ? ' ‚Ä¢ ' + m.kcal + ' kcal' : ''}${m.notes ? ' ‚Ä¢ ' + m.notes : ''}</p>
            </div>
            <div>
              <button data-meal-name="${m.name.replace(/"/g, '&quot;')}" class="meal-register-btn bg-orange-500 hover:bg-orange-400 px-3 py-1 rounded">Registrar</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>

    <!-- Meal History for Selected Day -->
    <div class="bg-slate-800 p-4 rounded">
      <h3 class="font-bold mb-3">üìã Hist√≥rico de ${dateLabel}</h3>
      ${selectedDayMeals.length === 0 ? 
        '<p class="text-slate-400">Nenhuma refei√ß√£o registrada neste dia.</p>' :
        `<div class="space-y-2">
          ${selectedDayMeals.map(log => {
            // Check if it's a composed meal
            if (log.isComposed && log.components) {
              return `
                <div class="bg-slate-700 p-3 rounded border-l-4 border-purple-500">
                  <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                      <p class="font-semibold text-purple-300">üçΩÔ∏è ${log.meal}</p>
                      <p class="text-slate-400 text-xs mb-2">${log.time} ‚Ä¢ Refei√ß√£o Composta</p>
                      
                      <!-- Components -->
                      <div class="bg-slate-800 p-2 rounded mb-2 space-y-1">
                        <p class="text-xs font-semibold text-slate-300 mb-1">Componentes:</p>
                        ${log.components.map(comp => `
                          <p class="text-xs text-slate-400">‚Ä¢ ${comp.weight}g ${comp.foodName} (${comp.prot}g P, ${comp.carb}g C, ${comp.fat}g G, ${comp.kcal} kcal)</p>
                        `).join('')}
                      </div>
                      
                      <!-- Totals -->
                      <div class="bg-gradient-to-r from-purple-800 to-indigo-800 p-2 rounded">
                        <p class="text-xs font-bold text-purple-200 mb-1">Totais:</p>
                        <p class="text-sm text-white">
                          ${log.totalWeight}g ‚Ä¢ ${log.totalKcal} kcal ‚Ä¢ ${log.totalProt}g prot ‚Ä¢ ${log.totalCarb}g carb ‚Ä¢ ${log.totalFat}g gord
                        </p>
                      </div>
                    </div>
                    <button data-meal-id="${log.id}" class="meal-delete-btn text-red-400 hover:text-red-300 ml-2" title="Excluir registro">üóëÔ∏è</button>
                  </div>
                </div>
              `;
            } else {
              // Regular meal
              const nut = getMealNutritionByNameCombined(log.meal);
              return `
                <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
                  <div>
                    <p class="font-semibold">${log.meal}</p>
                    <p class="text-slate-300 text-xs">${log.time} ‚Ä¢ ${nut.kcal} kcal ‚Ä¢ ${nut.prot}g prot ‚Ä¢ ${nut.fat}g gord</p>
                  </div>
                  <button data-meal-id="${log.id}" class="meal-delete-btn text-red-400 hover:text-red-300" title="Excluir registro">üóëÔ∏è</button>
                </div>
              `;
            }
          }).join('')}
        </div>`
      }
    </div>
  `;
}

function renderEvolucao(bodyMetrics, user) {
  const workoutLogs = user.workoutLogs || [];
  
  return `
    <!-- Sub-navigation tabs for Evolution page -->
    <div class="bg-slate-800 p-4 rounded mb-4">
      <div class="flex gap-2 border-b border-slate-700 pb-2">
        <button onclick="switchEvolucaoTab('body-metrics')" id="evolucaoTabBodyMetrics" class="px-4 py-2 rounded-t font-semibold bg-purple-600 text-white">
          üìä Medidas Corporais
        </button>
        <button onclick="switchEvolucaoTab('workouts')" id="evolucaoTabWorkouts" class="px-4 py-2 rounded-t font-semibold bg-slate-700 text-slate-300 hover:bg-slate-600">
          üèÉ Treinos
        </button>
      </div>
    </div>

    <!-- Body Metrics Section -->
    <div id="evolucaoContentBodyMetrics">
      <div class="bg-slate-800 p-4 rounded mb-6">
        <h3 class="font-bold text-xl mb-4">üìä Adicionar Medidas de Bioimped√¢ncia Completa</h3>
        <p class="text-slate-300 text-sm mb-4">Preencha todos os campos dispon√≠veis do seu equipamento de bioimped√¢ncia. Os campos obrigat√≥rios s√£o marcados com *. Os demais s√£o opcionais mas recomendados para an√°lise completa.</p>
      
      <form id="metricsForm" class="space-y-4">
        <!-- Informa√ß√µes B√°sicas -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-purple-300">üìÖ Informa√ß√µes B√°sicas</h4>
          <div class="grid md:grid-cols-4 gap-3">
            <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required class="px-3 py-2 rounded bg-slate-600 text-white" title="Data da medi√ß√£o"/>
            <input type="number" name="weight" step="0.01" required placeholder="Peso (kg)*" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFat" step="0.1" required placeholder="Gordura Corporal (%)*" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMass" step="0.1" required placeholder="Massa Muscular (kg)*" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Composi√ß√£o Corporal Avan√ßada -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-green-300">üß¨ Composi√ß√£o Corporal Avan√ßada</h4>
          <div class="grid md:grid-cols-4 gap-3">
            <input type="number" name="visceralFat" step="0.1" placeholder="Gordura Visceral" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="waterPercent" step="0.1" placeholder="√Ågua Corporal (%)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="boneMass" step="0.1" placeholder="Massa √ìssea (kg)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="proteinMass" step="0.1" placeholder="Prote√≠na (kg)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="mineralMass" step="0.1" placeholder="Minerais (kg)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Massa Muscular Segmentada -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-blue-300">üí™ Massa Muscular Segmentada (kg)</h4>
          <div class="grid md:grid-cols-5 gap-3">
            <input type="number" name="muscleMassRightArm" step="0.1" placeholder="Bra√ßo Direito" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMassLeftArm" step="0.1" placeholder="Bra√ßo Esquerdo" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMassRightLeg" step="0.1" placeholder="Perna Direita" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMassLeftLeg" step="0.1" placeholder="Perna Esquerda" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleMassTrunk" step="0.1" placeholder="Tronco" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Gordura Corporal Segmentada -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-red-300">üî• Gordura Corporal Segmentada (%)</h4>
          <div class="grid md:grid-cols-5 gap-3">
            <input type="number" name="bodyFatRightArm" step="0.1" placeholder="Bra√ßo Direito" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFatLeftArm" step="0.1" placeholder="Bra√ßo Esquerdo" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFatRightLeg" step="0.1" placeholder="Perna Direita" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFatLeftLeg" step="0.1" placeholder="Perna Esquerda" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyFatTrunk" step="0.1" placeholder="Tronco" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Taxas Metab√≥licas -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-orange-300">‚ö° Taxas Metab√≥licas (kcal/dia)</h4>
          <div class="grid md:grid-cols-3 gap-3">
            <input type="number" name="bmr" placeholder="TMB - Taxa Metab√≥lica Basal" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="rmr" placeholder="TMR - Taxa Metab√≥lica Repouso" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="tdee" placeholder="TDEE - Gasto Energ√©tico Total" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Imped√¢ncia Bioel√©trica (Bioelectrical Impedance Analysis - BIA) -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-cyan-300">‚ö° An√°lise de Imped√¢ncia Bioel√©trica (BIA)</h4>
          <div class="grid md:grid-cols-4 gap-3">
            <input type="number" name="impedance" step="0.1" placeholder="Imped√¢ncia (Œ©)" class="px-3 py-2 rounded bg-slate-600 text-white" title="Imped√¢ncia corporal total a 50kHz"/>
            <input type="number" name="resistance" step="0.1" placeholder="Resist√™ncia (Œ©)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="reactance" step="0.1" placeholder="Reat√¢ncia (Œ©)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="phaseAngle" step="0.1" placeholder="√Çngulo de Fase (¬∞)" class="px-3 py-2 rounded bg-slate-600 text-white" title="Indicador de sa√∫de celular (normal: 5-7¬∞)"/>
          </div>
          <p class="text-xs text-slate-400 mt-2">üí° √Çngulo de Fase: indicador de sa√∫de celular. Normal: 5-7¬∞. Maior = melhor integridade celular.</p>
        </div>

        <!-- Idades e √çndices -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-yellow-300">üéÇ Idades Metab√≥lica e Corporal</h4>
          <div class="grid md:grid-cols-3 gap-3">
            <input type="number" name="metabolicAge" placeholder="Idade Metab√≥lica (anos)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="bodyAge" placeholder="Idade Corporal (anos)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="muscleSize" step="0.1" placeholder="Tamanho Muscular (cm)" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <!-- Circunfer√™ncias Corporais -->
        <div class="bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3 text-pink-300">üìè Circunfer√™ncias Corporais (cm)</h4>
          <div class="grid md:grid-cols-4 gap-3">
            <input type="number" name="chest" step="0.1" placeholder="Peito" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="waist" step="0.1" placeholder="Cintura" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="hips" step="0.1" placeholder="Quadril" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="shoulders" step="0.1" placeholder="Ombros" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="rightArm" step="0.1" placeholder="Bra√ßo Direito" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="leftArm" step="0.1" placeholder="Bra√ßo Esquerdo" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="rightThigh" step="0.1" placeholder="Coxa Direita" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="leftThigh" step="0.1" placeholder="Coxa Esquerda" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="rightCalf" step="0.1" placeholder="Panturrilha Direita" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="leftCalf" step="0.1" placeholder="Panturrilha Esquerda" class="px-3 py-2 rounded bg-slate-600 text-white"/>
            <input type="number" name="neck" step="0.1" placeholder="Pesco√ßo" class="px-3 py-2 rounded bg-slate-600 text-white"/>
          </div>
        </div>

        <div class="flex gap-3">
          <button type="submit" class="bg-purple-600 hover:bg-purple-500 px-6 py-3 rounded font-semibold text-lg">‚ûï Adicionar Medi√ß√£o Completa</button>
          <button type="button" onclick="document.getElementById('metricsForm').reset()" class="bg-slate-600 hover:bg-slate-500 px-4 py-3 rounded">üîÑ Limpar</button>
        </div>
      </form>
    </div>

    <div class="bg-slate-800 p-4 rounded mb-6">
      <div class="flex gap-3 items-start">
        <div style="flex:1;">
          <canvas id="muscleChart" height="160"></canvas>
        </div>
        <div style="width: 180px;" class="flex flex-col gap-2">
          <button onclick="exportMuscleEvolutionCSV('${user.id}')" class="bg-blue-600 px-3 py-2 rounded">üìä Exportar CSV</button>
          <button onclick="alert('Backup (full DB export) em breve')" class="bg-amber-600 px-3 py-2 rounded">üíæ Backup DB</button>
          <div class="text-slate-300 text-sm mt-2">Gr√°fico de evolu√ß√£o: massa muscular e composi√ß√£o corporal ao longo do tempo.</div>
        </div>
      </div>

      <div class="overflow-x-auto mt-4">
        <table class="w-full text-sm">
          <thead><tr class="border-b border-slate-600">
            <th class="py-2 px-2">Data</th>
            <th>Peso</th>
            <th>Gordura</th>
            <th>Massa Musc.</th>
            <th>IMC</th>
            <th>√Ågua</th>
            <th>BMR</th>
            <th>√Çngulo Fase</th>
            <th>Idade Met.</th>
            <th>A√ß√µes</th>
          </tr></thead>
          <tbody>
            ${bodyMetrics.slice().reverse().map(m => `
              <tr class="border-b border-slate-700 hover:bg-slate-700">
                <td class="py-2 px-2">${m.date}</td>
                <td class="py-2 px-2">${m.weight}kg</td>
                <td class="py-2 px-2">${m.bodyFat}%</td>
                <td class="py-2 px-2">${m.muscleMass}kg</td>
                <td class="py-2 px-2">${m.bmi || '-'}</td>
                <td class="py-2 px-2">${m.waterWeight || 0}kg</td>
                <td class="py-2 px-2">${m.bmr || '-'}</td>
                <td class="py-2 px-2">${m.phaseAngle ? m.phaseAngle + '¬∞' : '-'}</td>
                <td class="py-2 px-2">${m.metabolicAge ? m.metabolicAge + 'a' : '-'}</td>
                <td class="py-2 px-2">
                  <button onclick="handleDeleteMetric('${m.id}')" class="text-red-400 hover:text-red-300" title="Excluir e mover para archive">üóëÔ∏è</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      ${bodyMetrics.length > 0 ? `
        <div class="mt-6 bg-slate-700 p-4 rounded">
          <h4 class="font-semibold mb-3">üìà M√©tricas Detalhadas da √öltima Medi√ß√£o</h4>
          ${(() => {
            const latest = bodyMetrics[bodyMetrics.length - 1];
            return `
              <div class="grid md:grid-cols-3 gap-4 text-sm">
                ${latest.muscleMassRightArm ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">üí™ Massa Muscular Segmentada</p>
                    <p>Bra√ßo D: ${latest.muscleMassRightArm}kg | E: ${latest.muscleMassLeftArm}kg</p>
                    <p>Perna D: ${latest.muscleMassRightLeg}kg | E: ${latest.muscleMassLeftLeg}kg</p>
                    <p>Tronco: ${latest.muscleMassTrunk}kg</p>
                  </div>
                ` : ''}
                ${latest.bodyFatRightArm ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">üî• Gordura Segmentada</p>
                    <p>Bra√ßo D: ${latest.bodyFatRightArm}% | E: ${latest.bodyFatLeftArm}%</p>
                    <p>Perna D: ${latest.bodyFatRightLeg}% | E: ${latest.bodyFatLeftLeg}%</p>
                    <p>Tronco: ${latest.bodyFatTrunk}%</p>
                  </div>
                ` : ''}
                ${latest.boneMass ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">üß¨ Composi√ß√£o Avan√ßada</p>
                    <p>Massa √ìssea: ${latest.boneMass}kg</p>
                    <p>Prote√≠na: ${latest.proteinMass}kg</p>
                    <p>Minerais: ${latest.mineralMass}kg</p>
                  </div>
                ` : ''}
                ${latest.phaseAngle ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">‚ö° BIA - Imped√¢ncia</p>
                    <p>√Çngulo de Fase: ${latest.phaseAngle}¬∞</p>
                    <p>Imped√¢ncia: ${latest.impedance}Œ©</p>
                    <p>Resist√™ncia: ${latest.resistance}Œ©</p>
                  </div>
                ` : ''}
                ${latest.chest ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">üìè Circunfer√™ncias (cm)</p>
                    <p>Peito: ${latest.chest} | Cintura: ${latest.waist}</p>
                    <p>Bra√ßo D: ${latest.rightArm} | E: ${latest.leftArm}</p>
                    <p>Coxa D: ${latest.rightThigh} | E: ${latest.leftThigh}</p>
                  </div>
                ` : ''}
                ${latest.tdee ? `
                  <div class="bg-slate-800 p-3 rounded">
                    <p class="text-slate-400 text-xs mb-2">‚ö° Taxas Metab√≥licas</p>
                    <p>TMB: ${latest.bmr} kcal/dia</p>
                    <p>TMR: ${latest.rmr} kcal/dia</p>
                    <p>TDEE: ${latest.tdee} kcal/dia</p>
                  </div>
                ` : ''}
              </div>
            `;
          })()}
        </div>
      ` : ''}
    </div>
    </div>

    <!-- Workouts Section -->
    <div id="evolucaoContentWorkouts" class="hidden">
      <!-- Manual Workout Entry Form -->
      <div class="bg-slate-800 p-4 rounded mb-6">
        <h3 class="font-bold text-xl mb-4">üèÉ Registrar Treino Manual</h3>
        <p class="text-slate-300 text-sm mb-4">Adicione um treino manualmente ou aguarde sincroniza√ß√£o futura via smartwatch.</p>
        
        <form id="workoutForm" onsubmit="handleWorkoutFormSubmit(event); return false;" class="space-y-4">
          <!-- Basic Info -->
          <div class="bg-slate-700 p-4 rounded">
            <h4 class="font-semibold mb-3 text-purple-300">üìÖ Informa√ß√µes B√°sicas</h4>
            <div class="grid md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm text-slate-300 mb-1">Nome do Treino *</label>
                <input type="text" name="workoutName" required placeholder="Ex: Corrida Matinal" class="w-full px-3 py-2 rounded bg-slate-600 text-white"/>
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-1">Tipo de Treino *</label>
                <select name="workoutType" required class="w-full px-3 py-2 rounded bg-slate-600 text-white">
                  <option value="">Selecione...</option>
                  <option value="corrida">üèÉ Corrida</option>
                  <option value="caminhada">üö∂ Caminhada</option>
                  <option value="ciclismo">üö¥ Ciclismo</option>
                  <option value="natacao">üèä Nata√ß√£o</option>
                  <option value="musculacao">üí™ Muscula√ß√£o</option>
                  <option value="crossfit">üèãÔ∏è CrossFit</option>
                  <option value="yoga">üßò Yoga</option>
                  <option value="pilates">ü§∏ Pilates</option>
                  <option value="funcional">‚ö° Treino Funcional</option>
                  <option value="lutas">ü•ã Lutas/Artes Marciais</option>
                  <option value="danca">üíÉ Dan√ßa</option>
                  <option value="outro">üìã Outro</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Date and Time -->
          <div class="bg-slate-700 p-4 rounded">
            <h4 class="font-semibold mb-3 text-green-300">‚è∞ Data e Hor√°rio</h4>
            <div class="grid md:grid-cols-4 gap-3">
              <div>
                <label class="block text-sm text-slate-300 mb-1">Data *</label>
                <input type="date" name="workoutDate" value="${new Date().toISOString().split('T')[0]}" required class="w-full px-3 py-2 rounded bg-slate-600 text-white"/>
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-1">Hora de In√≠cio *</label>
                <input type="time" name="startTime" required class="w-full px-3 py-2 rounded bg-slate-600 text-white"/>
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-1">Hora de T√©rmino *</label>
                <input type="time" name="endTime" required class="w-full px-3 py-2 rounded bg-slate-600 text-white"/>
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-1">Dura√ß√£o (minutos)</label>
                <input type="number" name="duration" placeholder="Auto-calculado" readonly class="w-full px-3 py-2 rounded bg-slate-500 text-slate-300"/>
              </div>
            </div>
          </div>

          <!-- Workout Metrics -->
          <div class="bg-slate-700 p-4 rounded">
            <h4 class="font-semibold mb-3 text-red-300">üìà M√©tricas do Treino</h4>
            <div class="grid md:grid-cols-3 gap-3">
              <div>
                <label class="block text-sm text-slate-300 mb-1">Calorias Gastas (kcal) *</label>
                <input type="number" name="calories" step="0.1" required placeholder="Ex: 350" class="w-full px-3 py-2 rounded bg-slate-600 text-white"/>
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-1">BPM M√©dio</label>
                <input type="number" name="avgHeartRate" placeholder="Ex: 140" class="w-full px-3 py-2 rounded bg-slate-600 text-white"/>
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-1">BPM M√°ximo</label>
                <input type="number" name="maxHeartRate" placeholder="Ex: 175" class="w-full px-3 py-2 rounded bg-slate-600 text-white"/>
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-1">Dist√¢ncia (km)</label>
                <input type="number" name="distance" step="0.01" placeholder="Ex: 5.2" class="w-full px-3 py-2 rounded bg-slate-600 text-white"/>
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-1">Velocidade M√©dia (km/h)</label>
                <input type="number" name="avgSpeed" step="0.1" placeholder="Ex: 10.5" class="w-full px-3 py-2 rounded bg-slate-600 text-white"/>
              </div>
              <div>
                <label class="block text-sm text-slate-300 mb-1">Intensidade</label>
                <select name="intensity" class="w-full px-3 py-2 rounded bg-slate-600 text-white">
                  <option value="">N√£o informado</option>
                  <option value="baixa">üü¢ Baixa</option>
                  <option value="moderada">üü° Moderada</option>
                  <option value="alta">üü† Alta</option>
                  <option value="maxima">üî¥ M√°xima</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Additional Notes -->
          <div class="bg-slate-700 p-4 rounded">
            <h4 class="font-semibold mb-3 text-blue-300">üìù Observa√ß√µes</h4>
            <textarea name="notes" rows="3" placeholder="Adicione notas sobre o treino, como voc√™ se sentiu, pontos de aten√ß√£o, etc." class="w-full px-3 py-2 rounded bg-slate-600 text-white"></textarea>
          </div>

          <div class="flex gap-3">
            <button type="submit" class="bg-purple-600 hover:bg-purple-500 px-6 py-3 rounded font-semibold text-lg">‚ûï Registrar Treino</button>
            <button type="button" onclick="document.getElementById('workoutForm').reset()" class="bg-slate-600 hover:bg-slate-500 px-4 py-3 rounded">üîÑ Limpar</button>
          </div>
        </form>
      </div>

      <!-- Smartwatch Sync Notice -->
      <div class="bg-gradient-to-r from-blue-900 to-purple-900 p-4 rounded mb-6 border border-blue-500">
        <h4 class="font-bold text-lg mb-2">‚åö Sincroniza√ß√£o via Smartwatch</h4>
        <p class="text-sm text-blue-200 mb-3">
          Sincroniza√ß√£o autom√°tica de treinos via smartwatch (Apple Watch, Garmin, Fitbit, etc.) estar√° dispon√≠vel em breve!
          Por enquanto, voc√™ pode adicionar treinos manualmente usando o formul√°rio acima.
        </p>
        <p class="text-xs text-blue-300">
          üí° Recursos futuros: sincroniza√ß√£o autom√°tica de BPM ao longo do treino, calorias em tempo real, GPS tracking, e muito mais!
        </p>
      </div>

      <!-- Workout Charts -->
      ${workoutLogs.length > 0 ? `
        <div class="bg-slate-800 p-4 rounded mb-6">
          <h3 class="font-bold text-xl mb-4">üìä Gr√°ficos de Treino</h3>
          
          <div class="grid md:grid-cols-2 gap-4 mb-4">
            <!-- Calories Over Time Chart -->
            <div class="bg-slate-700 p-4 rounded">
              <h4 class="font-semibold mb-3 text-center">üî• Calorias por Treino</h4>
              <canvas id="workoutCaloriesChart" height="200"></canvas>
            </div>
            
            <!-- Duration Over Time Chart -->
            <div class="bg-slate-700 p-4 rounded">
              <h4 class="font-semibold mb-3 text-center">‚è±Ô∏è Dura√ß√£o dos Treinos</h4>
              <canvas id="workoutDurationChart" height="200"></canvas>
            </div>
          </div>

          <!-- Heart Rate Chart (if data available) -->
          ${workoutLogs.some(w => w.avgHeartRate) ? `
            <div class="bg-slate-700 p-4 rounded mb-4">
              <h4 class="font-semibold mb-3 text-center">‚ù§Ô∏è Frequ√™ncia Card√≠aca M√©dia</h4>
              <canvas id="workoutHeartRateChart" height="200"></canvas>
            </div>
          ` : ''}

          <div class="flex gap-3">
            <button onclick="exportWorkoutLogsCSV('${user.id}')" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded">üìä Exportar CSV</button>
          </div>
        </div>
      ` : ''}

      <!-- Workout Logs Table -->
      <div class="bg-slate-800 p-4 rounded mb-6">
        <h3 class="font-bold text-xl mb-4">üìã Hist√≥rico de Treinos</h3>
        
        ${workoutLogs.length === 0 ? `
          <p class="text-slate-400 text-center py-8">Nenhum treino registrado ainda. Use o formul√°rio acima para adicionar seu primeiro treino!</p>
        ` : `
          <!-- Summary Stats -->
          <div class="grid md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-purple-900 to-purple-800 p-4 rounded">
              <p class="text-sm text-purple-300">Total de Treinos</p>
              <p class="text-3xl font-bold">${workoutLogs.length}</p>
            </div>
            <div class="bg-gradient-to-br from-red-900 to-red-800 p-4 rounded">
              <p class="text-sm text-red-300">Calorias Totais</p>
              <p class="text-3xl font-bold">${workoutLogs.reduce((sum, w) => sum + (w.calories || 0), 0).toFixed(0)}</p>
              <p class="text-xs text-red-200">kcal</p>
            </div>
            <div class="bg-gradient-to-br from-blue-900 to-blue-800 p-4 rounded">
              <p class="text-sm text-blue-300">Tempo Total</p>
              <p class="text-3xl font-bold">${(workoutLogs.reduce((sum, w) => sum + (w.duration || 0), 0) / 60).toFixed(1)}</p>
              <p class="text-xs text-blue-200">horas</p>
            </div>
            <div class="bg-gradient-to-br from-green-900 to-green-800 p-4 rounded">
              <p class="text-sm text-green-300">M√©dia Semanal</p>
              <p class="text-3xl font-bold">${(workoutLogs.length / Math.max(1, Math.ceil((Date.now() - new Date(workoutLogs[0]?.date).getTime()) / (7 * 24 * 60 * 60 * 1000)))).toFixed(1)}</p>
              <p class="text-xs text-green-200">treinos/semana</p>
            </div>
          </div>

          <!-- Workouts Table -->
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-slate-600">
                  <th class="py-2 px-2 text-left">Data</th>
                  <th class="py-2 px-2 text-left">Nome</th>
                  <th class="py-2 px-2 text-left">Tipo</th>
                  <th class="py-2 px-2 text-center">Dura√ß√£o</th>
                  <th class="py-2 px-2 text-center">Calorias</th>
                  <th class="py-2 px-2 text-center">BPM M√©dio</th>
                  <th class="py-2 px-2 text-center">Intensidade</th>
                  <th class="py-2 px-2 text-center">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                ${workoutLogs.slice().reverse().map(workout => {
                  const intensityEmoji = {
                    'baixa': 'üü¢',
                    'moderada': 'üü°',
                    'alta': 'üü†',
                    'maxima': 'üî¥'
                  }[workout.intensity] || '‚ö™';
                  
                  const typeEmoji = {
                    'corrida': 'üèÉ',
                    'caminhada': 'üö∂',
                    'ciclismo': 'üö¥',
                    'natacao': 'üèä',
                    'musculacao': 'üí™',
                    'crossfit': 'üèãÔ∏è',
                    'yoga': 'üßò',
                    'pilates': 'ü§∏',
                    'funcional': '‚ö°',
                    'lutas': 'ü•ã',
                    'danca': 'üíÉ',
                    'outro': 'üìã'
                  }[workout.type] || 'üìã';

                  return `
                    <tr class="border-b border-slate-700 hover:bg-slate-700 cursor-pointer" onclick="showWorkoutDetails('${workout.id}')">
                      <td class="py-2 px-2">${workout.date}</td>
                      <td class="py-2 px-2 font-semibold">${escapeHtml(workout.name)}</td>
                      <td class="py-2 px-2">${typeEmoji} ${workout.type}</td>
                      <td class="py-2 px-2 text-center">${workout.duration} min</td>
                      <td class="py-2 px-2 text-center">${workout.calories} kcal</td>
                      <td class="py-2 px-2 text-center">${workout.avgHeartRate ? workout.avgHeartRate + ' bpm' : '-'}</td>
                      <td class="py-2 px-2 text-center">${intensityEmoji}</td>
                      <td class="py-2 px-2 text-center">
                        <button onclick="event.stopPropagation(); handleDeleteWorkout('${workout.id}')" class="text-red-400 hover:text-red-300" title="Excluir treino">üóëÔ∏è</button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `}
      </div>
    </div>
  `;
}

/* ============================= WORKOUT TRACKING FUNCTIONS ============================= */

// Switch between body metrics and workouts tabs
function switchEvolucaoTab(tab) {
  const bodyMetricsTab = document.getElementById('evolucaoTabBodyMetrics');
  const workoutsTab = document.getElementById('evolucaoTabWorkouts');
  const bodyMetricsContent = document.getElementById('evolucaoContentBodyMetrics');
  const workoutsContent = document.getElementById('evolucaoContentWorkouts');

  if (tab === 'body-metrics') {
    bodyMetricsTab.classList.remove('bg-slate-700', 'text-slate-300');
    bodyMetricsTab.classList.add('bg-purple-600', 'text-white');
    workoutsTab.classList.remove('bg-purple-600', 'text-white');
    workoutsTab.classList.add('bg-slate-700', 'text-slate-300');
    bodyMetricsContent.classList.remove('hidden');
    workoutsContent.classList.add('hidden');
  } else if (tab === 'workouts') {
    workoutsTab.classList.remove('bg-slate-700', 'text-slate-300');
    workoutsTab.classList.add('bg-purple-600', 'text-white');
    bodyMetricsTab.classList.remove('bg-purple-600', 'text-white');
    bodyMetricsTab.classList.add('bg-slate-700', 'text-slate-300');
    workoutsContent.classList.remove('hidden');
    bodyMetricsContent.classList.add('hidden');
    
    // Setup form listeners after showing the form
    setTimeout(() => {
      setupWorkoutFormListeners();
      renderWorkoutCharts();
    }, 150);
  }
}

// Chart instances for workouts
let workoutCaloriesChart = null;
let workoutDurationChart = null;
let workoutHeartRateChart = null;

// Render workout charts
function renderWorkoutCharts() {
  // Check if Chart.js is available
  if (typeof Chart === 'undefined') {
    console.warn('Chart.js not loaded, skipping workout chart rendering');
    return;
  }
  
  const user = state.users[state.activeUser];
  if (!user || !user.workoutLogs || user.workoutLogs.length === 0) return;

  const workoutLogs = user.workoutLogs.slice().sort((a, b) => new Date(a.date + 'T' + a.startTime) - new Date(b.date + 'T' + b.startTime));

  // Calories Chart
  const caloriesCanvas = document.getElementById('workoutCaloriesChart');
  if (caloriesCanvas) {
    const labels = workoutLogs.map(w => w.date + ' ' + w.name.substring(0, 10));
    const caloriesData = workoutLogs.map(w => w.calories || 0);

    if (workoutCaloriesChart) {
      workoutCaloriesChart.destroy();
      workoutCaloriesChart = null;
    }

    workoutCaloriesChart = new Chart(caloriesCanvas, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Calorias (kcal)',
          data: caloriesData,
          backgroundColor: '#EF4444',
          borderColor: '#DC2626',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'kcal' }
          }
        }
      }
    });
  }

  // Duration Chart
  const durationCanvas = document.getElementById('workoutDurationChart');
  if (durationCanvas) {
    const labels = workoutLogs.map(w => w.date + ' ' + w.name.substring(0, 10));
    const durationData = workoutLogs.map(w => w.duration || 0);

    if (workoutDurationChart) {
      workoutDurationChart.destroy();
      workoutDurationChart = null;
    }

    workoutDurationChart = new Chart(durationCanvas, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Dura√ß√£o (minutos)',
          data: durationData,
          backgroundColor: '#3B82F6',
          borderColor: '#2563EB',
          borderWidth: 2,
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'minutos' }
          }
        }
      }
    });
  }

  // Heart Rate Chart (if data available)
  const heartRateCanvas = document.getElementById('workoutHeartRateChart');
  if (heartRateCanvas && workoutLogs.some(w => w.avgHeartRate)) {
    const labels = workoutLogs.filter(w => w.avgHeartRate).map(w => w.date + ' ' + w.name.substring(0, 10));
    const heartRateData = workoutLogs.filter(w => w.avgHeartRate).map(w => w.avgHeartRate);

    if (workoutHeartRateChart) {
      workoutHeartRateChart.destroy();
      workoutHeartRateChart = null;
    }

    workoutHeartRateChart = new Chart(heartRateCanvas, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'BPM M√©dio',
          data: heartRateData,
          backgroundColor: '#F59E0B',
          borderColor: '#D97706',
          borderWidth: 2,
          fill: false,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: false,
            title: { display: true, text: 'BPM' }
          }
        }
      }
    });
  }
}

// Handle workout form submission
async function handleWorkoutFormSubmit(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const user = state.users[state.activeUser];
  
  if (!user) {
    alert('Erro: usu√°rio n√£o encontrado');
    return;
  }

  // Calculate duration from start and end time
  const startTime = formData.get('startTime');
  const endTime = formData.get('endTime');
  let duration = 0;
  
  if (startTime && endTime) {
    const [startHour, startMin] = startTime.split(':').map(Number);
    const [endHour, endMin] = endTime.split(':').map(Number);
    duration = (endHour * 60 + endMin) - (startHour * 60 + startMin);
    
    if (duration < 0) duration += 24 * 60; // Handle overnight workouts
  }

  // Create workout log
  const workout = {
    id: 'workout_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11),
    date: formData.get('workoutDate'),
    name: sanitizeInput(formData.get('workoutName')),
    type: formData.get('workoutType'),
    startTime: startTime,
    endTime: endTime,
    duration: duration,
    calories: parseFloat(formData.get('calories')) || 0,
    avgHeartRate: formData.get('avgHeartRate') ? parseInt(formData.get('avgHeartRate')) : null,
    maxHeartRate: formData.get('maxHeartRate') ? parseInt(formData.get('maxHeartRate')) : null,
    distance: formData.get('distance') ? parseFloat(formData.get('distance')) : null,
    avgSpeed: formData.get('avgSpeed') ? parseFloat(formData.get('avgSpeed')) : null,
    intensity: formData.get('intensity') || null,
    notes: sanitizeInput(formData.get('notes') || ''),
    createdAt: new Date().toISOString(),
    source: 'manual' // vs 'smartwatch' in the future
  };

  // Add to user's workout logs
  if (!user.workoutLogs) user.workoutLogs = [];
  user.workoutLogs.push(workout);

  // Save to database
  await saveAllToDB();
  
  // Reset form and re-render
  event.target.reset();
  render();
  
  // Switch to workouts tab to show the new workout
  setTimeout(() => switchEvolucaoTab('workouts'), 100);
  
  showNotification('‚úÖ Treino registrado com sucesso!', 'success');
}

// Calculate duration when times change
function setupWorkoutFormListeners() {
  const form = document.getElementById('workoutForm');
  if (!form) return;
  
  const startTimeInput = form.querySelector('[name="startTime"]');
  const endTimeInput = form.querySelector('[name="endTime"]');
  const durationInput = form.querySelector('[name="duration"]');
  
  if (!startTimeInput || !endTimeInput || !durationInput) return;
  
  function updateDuration() {
    const startTime = startTimeInput.value;
    const endTime = endTimeInput.value;
    
    if (startTime && endTime) {
      const [startHour, startMin] = startTime.split(':').map(Number);
      const [endHour, endMin] = endTime.split(':').map(Number);
      let duration = (endHour * 60 + endMin) - (startHour * 60 + startMin);
      
      if (duration < 0) duration += 24 * 60; // Handle overnight workouts
      
      durationInput.value = duration;
    }
  }
  
  startTimeInput.addEventListener('change', updateDuration);
  endTimeInput.addEventListener('change', updateDuration);
}

// Delete workout
async function handleDeleteWorkout(workoutId) {
  if (!confirm('Deseja realmente excluir este treino?')) return;
  
  const user = state.users[state.activeUser];
  if (!user || !user.workoutLogs) return;
  
  // Find and archive the workout
  const workout = user.workoutLogs.find(w => w.id === workoutId);
  if (workout) {
    await archiveItem('workout', workoutId, 'workout_log', workout);
  }
  
  // Remove from user's workout logs
  user.workoutLogs = user.workoutLogs.filter(w => w.id !== workoutId);
  
  await saveAllToDB();
  render();
  
  showNotification('‚úÖ Treino exclu√≠do!', 'success');
}

// Show workout details
function showWorkoutDetails(workoutId) {
  const user = state.users[state.activeUser];
  if (!user || !user.workoutLogs) return;
  
  const workout = user.workoutLogs.find(w => w.id === workoutId);
  if (!workout) return;
  
  const typeEmoji = {
    'corrida': 'üèÉ',
    'caminhada': 'üö∂',
    'ciclismo': 'üö¥',
    'natacao': 'üèä',
    'musculacao': 'üí™',
    'crossfit': 'üèãÔ∏è',
    'yoga': 'üßò',
    'pilates': 'ü§∏',
    'funcional': '‚ö°',
    'lutas': 'ü•ã',
    'danca': 'üíÉ',
    'outro': 'üìã'
  }[workout.type] || 'üìã';
  
  const intensityText = {
    'baixa': 'üü¢ Baixa',
    'moderada': 'üü° Moderada',
    'alta': 'üü† Alta',
    'maxima': 'üî¥ M√°xima'
  }[workout.intensity] || '‚ö™ N√£o informado';
  
  let details = `
üìã Detalhes do Treino

${typeEmoji} ${workout.name}
Tipo: ${workout.type}
Data: ${workout.date}
Hor√°rio: ${workout.startTime} - ${workout.endTime}
Dura√ß√£o: ${workout.duration} minutos

üìä M√©tricas:
‚Ä¢ Calorias: ${workout.calories} kcal
${workout.avgHeartRate ? '‚Ä¢ BPM M√©dio: ' + workout.avgHeartRate : ''}
${workout.maxHeartRate ? '‚Ä¢ BPM M√°ximo: ' + workout.maxHeartRate : ''}
${workout.distance ? '‚Ä¢ Dist√¢ncia: ' + workout.distance + ' km' : ''}
${workout.avgSpeed ? '‚Ä¢ Velocidade M√©dia: ' + workout.avgSpeed + ' km/h' : ''}
‚Ä¢ Intensidade: ${intensityText}

${workout.notes ? 'üìù Observa√ß√µes:\n' + workout.notes : ''}

Fonte: ${workout.source === 'manual' ? 'Registro Manual' : 'Smartwatch'}
  `.trim();
  
  alert(details);
}

// Export workout logs to CSV
function exportWorkoutLogsCSV(userId) {
  const user = state.users[userId];
  if (!user || !user.workoutLogs || user.workoutLogs.length === 0) {
    alert('Nenhum treino para exportar');
    return;
  }
  
  const workoutLogs = user.workoutLogs.slice().sort((a, b) => new Date(a.date + 'T' + a.startTime) - new Date(b.date + 'T' + b.startTime));
  
  let csv = 'Data,Nome,Tipo,Hora In√≠cio,Hora T√©rmino,Dura√ß√£o (min),Calorias (kcal),BPM M√©dio,BPM M√°ximo,Dist√¢ncia (km),Velocidade M√©dia (km/h),Intensidade,Observa√ß√µes,Fonte\n';
  
  workoutLogs.forEach(w => {
    csv += `${w.date},"${w.name}",${w.type},${w.startTime},${w.endTime},${w.duration},${w.calories},${w.avgHeartRate || ''},${w.maxHeartRate || ''},${w.distance || ''},${w.avgSpeed || ''},${w.intensity || ''},"${(w.notes || '').replace(/"/g, '""')}",${w.source}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `treinos_${user.name}_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  URL.revokeObjectURL(url);
  
  showNotification('‚úÖ CSV exportado!', 'success');
}

function renderComparacao() {
  const comps = state.comparisons || [];
  return `
    <div class="bg-slate-800 p-4 rounded">
      <h3 class="font-bold">Compara√ß√µes</h3>
      ${comps.length === 0 ? '<p class="text-slate-400">Nenhuma compara√ß√£o criada.</p>' : comps.map(c => `
        <div class="bg-slate-700 p-3 rounded mb-2">
          <p class="font-bold">${c.title}</p>
          <p class="text-slate-300 text-xs">Criado ${new Date(c.createdAt).toLocaleString()}</p>
          <div class="mt-2 flex gap-2"><button onclick="handleDeleteComparison('${c.id}')" class="bg-red-500 px-3 py-1 rounded">Remover</button></div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderCiencia() {
  const filtered = (state.references || []).filter(r => r.year >= 2020 && r.year <= 2025);
  return `
    <div class="bg-slate-800 p-4 rounded">
      <div class="flex justify-between items-center">
        <h3 class="font-bold">Estudos cient√≠ficos (2020 ‚Üí 2025-11)</h3>
        <div class="flex gap-2">
          <button onclick="importScientificStudiesSeed()" class="bg-green-600 px-3 py-1 rounded">‚§ì Importar estudos</button>
          <button onclick="exportReferencesJSON()" class="bg-blue-600 px-3 py-1 rounded">‚¨áÔ∏è Exportar JSON</button>
          <button onclick="clearReferences()" class="bg-red-600 px-3 py-1 rounded">üóÑÔ∏è Mover p/ archive</button>
        </div>
      </div>

      <div class="mt-4">
        ${filtered.length === 0 ? '<p class="text-slate-400">Nenhuma refer√™ncia importada. Use o bot√£o importar.</p>' : filtered.map(ref => `
          <div class="bg-slate-700 p-3 rounded mb-3">
            <p class="font-bold">${ref.title}</p>
            <p class="text-slate-300 text-xs">${ref.authors} ‚Äî ${ref.year} ‚Ä¢ ${ref.journal}</p>
            <p class="text-slate-400 text-sm mt-2">${ref.summary || ''}</p>
            <p class="mt-2"><a href="${ref.link}" target="_blank" class="text-blue-300 underline">Abrir estudo / DOI</a></p>
            <div class="mt-2 flex gap-2">
              <button onclick="navigator.clipboard.writeText('${ref.link}').then(()=>alert('Link copiado'))" class="bg-white text-black px-2 py-1 rounded">Copiar link</button>
              <button onclick="if(confirm('Mover esta refer√™ncia para archive?')) { archiveItem('references','${ref.id}','reference', ${JSON.stringify(ref).replace(/'/g, "\\'")}).then(()=>{ state.references = state.references.filter(r=>r.id!=='${ref.id}'); saveAllToDB(); render(); alert('Movido para archive') }) }" class="text-red-400">Arquivar</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function renderExercicios(user) {
  const exercises = getAllUniqueExercises(user);
  const selectedExercise = state.selectedExercise || (exercises.length > 0 ? exercises[0] : null);
  
  if (!selectedExercise && exercises.length === 0) {
    return `
      <div class="bg-slate-800 p-6 rounded">
        <h3 class="font-bold text-xl mb-4">üí™ Hist√≥rico por Exerc√≠cio</h3>
        <p class="text-slate-400">Nenhum exerc√≠cio registrado ainda. V√° para a aba Treinos e registre alguns exerc√≠cios primeiro.</p>
      </div>
    `;
  }
  
  const history = selectedExercise ? getExerciseHistory(user, selectedExercise) : [];
  const stats = selectedExercise ? getExerciseStats(user, selectedExercise) : {};
  
  return `
    <div class="space-y-6">
      <!-- Exercise Selector -->
      <div class="bg-slate-800 p-4 rounded">
        <h3 class="font-bold text-xl mb-4">üí™ Hist√≥rico por Exerc√≠cio</h3>
        <div class="mb-4">
          <label class="block text-sm text-slate-300 mb-2">Selecione um exerc√≠cio:</label>
          <select onchange="state.selectedExercise=this.value; render();" class="w-full md:w-1/2 px-4 py-2 rounded bg-slate-700 text-white">
            ${exercises.map(ex => `<option value="${ex}" ${ex === selectedExercise ? 'selected' : ''}>${ex}</option>`).join('')}
          </select>
        </div>
      </div>
      
      <!-- Exercise Stats -->
      <div class="bg-gradient-to-r from-purple-700 to-indigo-800 p-6 rounded-xl">
        <h4 class="font-bold text-xl mb-4">üìä Estat√≠sticas de ${selectedExercise}</h4>
        <div class="grid md:grid-cols-4 gap-4">
          <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
            <p class="text-sm text-purple-200 mb-1">Total de Treinos</p>
            <p class="text-3xl font-bold">${stats.totalWorkouts}</p>
          </div>
          <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
            <p class="text-sm text-purple-200 mb-1">Carga M√°xima</p>
            <p class="text-3xl font-bold">${stats.maxWeight}</p>
            <p class="text-xs text-purple-300">kg</p>
          </div>
          <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
            <p class="text-sm text-purple-200 mb-1">Reps M√°ximo</p>
            <p class="text-3xl font-bold">${stats.maxReps}</p>
          </div>
          <div class="bg-white/10 backdrop-blur p-4 rounded-lg">
            <p class="text-sm text-purple-200 mb-1">Volume M√°ximo</p>
            <p class="text-3xl font-bold">${Math.round(stats.maxVolume)}</p>
            <p class="text-xs text-purple-300">kg total</p>
          </div>
        </div>
        ${stats.firstWorkout ? `
          <div class="mt-4 text-sm text-purple-200">
            <p>Primeiro treino: ${new Date(stats.firstWorkout).toLocaleDateString('pt-BR')}</p>
            <p>√öltimo treino: ${new Date(stats.lastWorkout).toLocaleDateString('pt-BR')}</p>
          </div>
        ` : ''}
      </div>
      
      <!-- History Table -->
      <div class="bg-slate-800 p-4 rounded">
        <h4 class="font-bold text-lg mb-4">üìã Hist√≥rico Completo</h4>
        ${history.length === 0 ? 
          '<p class="text-slate-400">Nenhum registro encontrado para este exerc√≠cio.</p>' :
          `<div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-slate-600">
                  <th class="py-2 px-2 text-left">Data</th>
                  <th class="py-2 px-2 text-left">S√©ries</th>
                  <th class="py-2 px-2 text-left">Reps</th>
                  <th class="py-2 px-2 text-left">Carga (kg)</th>
                  <th class="py-2 px-2 text-left">Volume</th>
                  <th class="py-2 px-2 text-left">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                ${history.slice().reverse().map(log => {
                  const weight = parseNumber(log.weight);
                  const reps = parseNumber(log.reps);
                  const sets = parseNumber(log.sets);
                  const volume = weight * reps * sets;
                  
                  return `
                    <tr class="border-b border-slate-700 hover:bg-slate-700">
                      <td class="py-2 px-2">${new Date(log.date).toLocaleDateString('pt-BR')}</td>
                      <td class="py-2 px-2">${log.sets}</td>
                      <td class="py-2 px-2">${log.reps}</td>
                      <td class="py-2 px-2">${log.weight}</td>
                      <td class="py-2 px-2">${volume > 0 ? Math.round(volume) + ' kg' : '-'}</td>
                      <td class="py-2 px-2">
                        <button onclick="handleEditWorkout(${log.id})" class="text-blue-400 hover:text-blue-300 mr-2" title="Editar">‚úèÔ∏è</button>
                        <button onclick="handleDeleteWorkout(${log.id})" class="text-red-400 hover:text-red-300" title="Excluir">üóëÔ∏è</button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>`
        }
      </div>
      
      <!-- Progression Chart -->
      ${history.length >= 2 ? `
        <div class="bg-slate-800 p-4 rounded">
          <h4 class="font-bold text-lg mb-4">üìà Progress√£o de Carga</h4>
          <canvas id="exerciseProgressionChart" height="100"></canvas>
        </div>
      ` : ''}
    </div>
  `;
}

function renderFotosProgresso(user) {
  if (!user.progressPhotos) user.progressPhotos = [];
  
  const photos = user.progressPhotos.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
  
  return `
    <div class="space-y-6">
      <!-- Upload Form -->
      <div class="bg-slate-800 p-6 rounded">
        <h3 class="font-bold text-xl mb-4">üì∏ Adicionar Foto de Progresso</h3>
        <form id="progressPhotoForm" class="space-y-4">
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-slate-300 mb-2">Data da foto:</label>
              <input type="date" name="photoDate" value="${new Date().toISOString().split('T')[0]}" required class="w-full px-4 py-2 rounded bg-slate-700 text-white" />
            </div>
            <div>
              <label class="block text-sm text-slate-300 mb-2">Notas (opcional):</label>
              <input type="text" name="photoNotes" placeholder="Ex: Ap√≥s 3 meses de treino" class="w-full px-4 py-2 rounded bg-slate-700 text-white" />
            </div>
          </div>
          <div>
            <label class="block text-sm text-slate-300 mb-2">Selecione a foto:</label>
            <input type="file" name="photoFile" accept="image/*" required class="w-full px-4 py-2 rounded bg-slate-700 text-white" />
            <p class="text-xs text-slate-400 mt-1">Tamanho m√°ximo: 5MB. Formatos: JPG, PNG, WEBP</p>
          </div>
          <button type="submit" class="bg-purple-600 hover:bg-purple-500 px-6 py-3 rounded font-semibold">üì∏ Adicionar Foto</button>
        </form>
      </div>
      
      <!-- Photos Grid -->
      <div class="bg-slate-800 p-6 rounded">
        <h3 class="font-bold text-xl mb-4">üñºÔ∏è Galeria de Progresso</h3>
        ${photos.length === 0 ? 
          '<p class="text-slate-400">Nenhuma foto adicionada ainda. Use o formul√°rio acima para adicionar sua primeira foto de progresso!</p>' :
          `<div class="grid md:grid-cols-3 gap-4">
            ${photos.map(photo => `
              <div class="bg-slate-700 p-3 rounded">
                <img src="${photo.imageData}" alt="Foto de ${escapeHtml(photo.date)}" class="w-full h-64 object-cover rounded mb-3" />
                <div class="space-y-1">
                  <p class="font-bold text-lg">${new Date(photo.date).toLocaleDateString('pt-BR')}</p>
                  ${photo.notes ? `<p class="text-sm text-slate-300">${escapeHtml(photo.notes)}</p>` : ''}
                  <p class="text-xs text-slate-400">Adicionada em ${new Date(photo.uploadedAt).toLocaleDateString('pt-BR')}</p>
                  <button onclick="handleDeleteProgressPhoto('${photo.id}')" class="mt-2 bg-red-600 hover:bg-red-500 px-3 py-1 rounded text-sm w-full">üóëÔ∏è Excluir</button>
                </div>
              </div>
            `).join('')}
          </div>`
        }
      </div>
      
      <!-- Comparison Tool -->
      ${photos.length >= 2 ? `
        <div class="bg-slate-800 p-6 rounded">
          <h3 class="font-bold text-xl mb-4">‚öñÔ∏è Comparar Fotos</h3>
          <p class="text-slate-300 text-sm mb-4">Selecione duas fotos para compar√°-las lado a lado:</p>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-slate-300 mb-2">Foto 1 (Antes):</label>
              <select id="comparePhoto1" class="w-full px-4 py-2 rounded bg-slate-700 text-white">
                <option value="">Selecione...</option>
                ${photos.map(p => `<option value="${p.id}">${new Date(p.date).toLocaleDateString('pt-BR')} ${p.notes ? '- ' + escapeHtml(p.notes) : ''}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-sm text-slate-300 mb-2">Foto 2 (Depois):</label>
              <select id="comparePhoto2" class="w-full px-4 py-2 rounded bg-slate-700 text-white">
                <option value="">Selecione...</option>
                ${photos.map(p => `<option value="${p.id}">${new Date(p.date).toLocaleDateString('pt-BR')} ${p.notes ? '- ' + escapeHtml(p.notes) : ''}</option>`).join('')}
              </select>
            </div>
          </div>
          <button onclick="compareProgressPhotos()" class="mt-4 bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded font-semibold">üëÅÔ∏è Comparar</button>
          
          <div id="comparisonResult" class="mt-6 hidden">
            <div class="grid md:grid-cols-2 gap-4">
              <div id="compareImg1Container"></div>
              <div id="compareImg2Container"></div>
            </div>
          </div>
        </div>
      ` : ''}
      
      <!-- Tips -->
      <div class="bg-gradient-to-r from-cyan-900 to-blue-900 p-6 rounded">
        <h4 class="font-bold text-lg mb-3">üí° Dicas para Fotos de Progresso</h4>
        <ul class="space-y-2 text-sm text-slate-200">
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">‚úì</span>
            <span><strong>Mesma ilumina√ß√£o:</strong> Tire fotos sempre no mesmo local e hor√°rio para compara√ß√£o justa.</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">‚úì</span>
            <span><strong>Mesma pose:</strong> Use poses consistentes (frente, lado, costas) em todas as fotos.</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">‚úì</span>
            <span><strong>Frequ√™ncia:</strong> Tire fotos a cada 2-4 semanas para ver progresso real.</span>
          </li>
          <li class="flex items-start gap-2">
            <span class="text-green-400 flex-shrink-0">‚úì</span>
            <span><strong>Privacidade:</strong> Suas fotos ficam armazenadas localmente no seu navegador.</span>
          </li>
        </ul>
      </div>
    </div>
  `;
}

/* ============================= ADMIN RENDER FUNCTIONS ============================= */

function renderAdminTasks() {
  return `
    <div class="space-y-6">
      <!-- Admin Header -->
      <div class="bg-gradient-to-r from-red-900 to-orange-900 p-6 rounded-xl border border-red-500">
        <h2 class="text-3xl font-bold mb-2">üëë Painel do Administrador - Tarefas</h2>
        <p class="text-red-200">Gerencie as tarefas do roadmap e acompanhe o progresso do projeto</p>
      </div>

      <!-- Task Stats -->
      <div class="grid md:grid-cols-4 gap-4" id="taskStats">
        <div class="bg-slate-800 p-4 rounded-lg">
          <p class="text-slate-400 text-sm">Total de Tarefas</p>
          <p class="text-3xl font-bold text-white" id="totalTasks">-</p>
        </div>
        <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/30">
          <p class="text-green-400 text-sm">Conclu√≠das</p>
          <p class="text-3xl font-bold text-green-300" id="doneTasks">-</p>
        </div>
        <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/30">
          <p class="text-yellow-400 text-sm">Em Progresso</p>
          <p class="text-3xl font-bold text-yellow-300" id="inProgressTasks">-</p>
        </div>
        <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/30">
          <p class="text-blue-400 text-sm">A Fazer</p>
          <p class="text-3xl font-bold text-blue-300" id="todoTasks">-</p>
        </div>
      </div>

      <!-- Create Task Button -->
      <div class="flex justify-between items-center">
        <h3 class="text-xl font-bold">üìã Tarefas do Roadmap</h3>
        <button onclick="showCreateTaskModal()" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg font-semibold">
          ‚ûï Nova Tarefa
        </button>
      </div>

      <!-- Task Categories -->
      <div class="space-y-6" id="tasksList">
        <p class="text-slate-400">Carregando tarefas...</p>
      </div>

      <!-- Export Button -->
      <div class="flex gap-3">
        <button onclick="exportTasksToMarkdown()" class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-lg font-semibold">
          üìÑ Exportar Tarefas (Markdown)
        </button>
        <button onclick="exportTasksToJSON()" class="bg-purple-600 hover:bg-purple-500 px-6 py-3 rounded-lg font-semibold">
          üíæ Exportar JSON
        </button>
      </div>
    </div>
  `;
}

function renderAdminSuggestions() {
  return `
    <div class="space-y-6">
      <!-- Admin Header -->
      <div class="bg-gradient-to-r from-purple-900 to-indigo-900 p-6 rounded-xl border border-purple-500">
        <h2 class="text-3xl font-bold mb-2">üí° Painel do Administrador - Sugest√µes</h2>
        <p class="text-purple-200">Gerencie sugest√µes e feedback dos usu√°rios</p>
      </div>

      <!-- Suggestion Stats -->
      <div class="grid md:grid-cols-4 gap-4" id="suggestionStats">
        <div class="bg-slate-800 p-4 rounded-lg">
          <p class="text-slate-400 text-sm">Total</p>
          <p class="text-3xl font-bold text-white" id="totalSuggestions">-</p>
        </div>
        <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/30">
          <p class="text-yellow-400 text-sm">Pendentes</p>
          <p class="text-3xl font-bold text-yellow-300" id="pendingSuggestions">-</p>
        </div>
        <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/30">
          <p class="text-green-400 text-sm">Aprovadas</p>
          <p class="text-3xl font-bold text-green-300" id="approvedSuggestions">-</p>
        </div>
        <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/30">
          <p class="text-blue-400 text-sm">Implementadas</p>
          <p class="text-3xl font-bold text-blue-300" id="implementedSuggestions">-</p>
        </div>
      </div>

      <!-- Export to GitHub -->
      <div class="bg-slate-800 p-4 rounded-lg border border-green-500/30">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-lg font-bold mb-1">üîÑ Sincronizar com GitHub</h3>
            <p class="text-slate-400 text-sm">Exporte todas as sugest√µes para um arquivo Markdown compat√≠vel com GitHub Issues</p>
          </div>
          <button onclick="exportSuggestionsToGitHubFormat()" class="bg-green-600 hover:bg-green-500 px-6 py-3 rounded-lg font-semibold whitespace-nowrap">
            üì§ Exportar para GitHub
          </button>
        </div>
      </div>

      <!-- Suggestions List -->
      <div class="space-y-4" id="suggestionsList">
        <p class="text-slate-400">Carregando sugest√µes...</p>
      </div>
    </div>
  `;
}

function renderAdminSecurity() {
  return `
    <div class="space-y-6">
      <!-- Admin Header -->
      <div class="bg-gradient-to-r from-red-900 to-pink-900 p-6 rounded-xl border border-red-500">
        <h2 class="text-3xl font-bold mb-2">üîê Painel do Administrador - Seguran√ßa & Monitoramento</h2>
        <p class="text-red-200">Monitore acessos ao site, contas registradas e eventos de seguran√ßa</p>
        <p class="text-red-300 text-sm mt-2">‚è±Ô∏è <span id="lastUpdateTime">Atualiza√ß√£o autom√°tica a cada 5 minutos</span></p>
      </div>

      <!-- Access Monitoring Stats -->
      <div class="bg-gradient-to-r from-purple-900 to-indigo-900 p-4 rounded-xl border border-purple-500">
        <h3 class="text-xl font-bold mb-4">üìä Monitoramento de Acessos ao Site</h3>
        <div class="grid md:grid-cols-5 gap-4">
          <div class="bg-slate-800 p-4 rounded-lg">
            <p class="text-slate-400 text-sm">Total de Acessos</p>
            <p class="text-3xl font-bold text-white" id="totalAccesses">-</p>
          </div>
          <div class="bg-blue-900/30 p-4 rounded-lg border border-blue-500/30">
            <p class="text-blue-400 text-sm">√öltimas 24h</p>
            <p class="text-3xl font-bold text-blue-300" id="accesses24h">-</p>
          </div>
          <div class="bg-cyan-900/30 p-4 rounded-lg border border-cyan-500/30">
            <p class="text-cyan-400 text-sm">√öltimos 7 dias</p>
            <p class="text-3xl font-bold text-cyan-300" id="accesses7d">-</p>
          </div>
          <div class="bg-teal-900/30 p-4 rounded-lg border border-teal-500/30">
            <p class="text-teal-400 text-sm">Visitantes √önicos (24h)</p>
            <p class="text-3xl font-bold text-teal-300" id="uniqueVisitors24h">-</p>
          </div>
          <div class="bg-purple-900/30 p-4 rounded-lg border border-purple-500/30">
            <p class="text-purple-400 text-sm">Contas Registradas</p>
            <p class="text-3xl font-bold text-purple-300" id="totalRegisteredAccounts">-</p>
          </div>
        </div>
      </div>

      <!-- Access Logs -->
      <div class="bg-slate-800 p-4 rounded-lg">
        <h3 class="text-xl font-bold mb-4">üïí Acessos Recentes</h3>
        <div id="accessLogsList">
          <p class="text-slate-400">Carregando acessos...</p>
        </div>
      </div>

      <!-- Hourly Access Chart -->
      <div class="bg-slate-800 p-4 rounded-lg">
        <h3 class="text-xl font-bold mb-4">üìà Acessos por Hora (√öltimas 24h)</h3>
        <div id="hourlyAccessChart">
          <p class="text-slate-400">Carregando gr√°fico...</p>
        </div>
      </div>

      <!-- Security Stats -->
      <div class="bg-gradient-to-r from-red-900 to-orange-900 p-4 rounded-xl border border-red-500 mt-6">
        <h3 class="text-xl font-bold mb-4">üîí Estat√≠sticas de Seguran√ßa</h3>
        <div class="grid md:grid-cols-4 gap-4" id="securityStats">
          <div class="bg-slate-800 p-4 rounded-lg">
            <p class="text-slate-400 text-sm">Total de Eventos</p>
            <p class="text-3xl font-bold text-white" id="totalSecurityEvents">-</p>
          </div>
          <div class="bg-green-900/30 p-4 rounded-lg border border-green-500/30">
            <p class="text-green-400 text-sm">Logins Sucesso</p>
            <p class="text-3xl font-bold text-green-300" id="successfulLogins">-</p>
          </div>
          <div class="bg-red-900/30 p-4 rounded-lg border border-red-500/30">
            <p class="text-red-400 text-sm">Logins Falhados</p>
            <p class="text-3xl font-bold text-red-300" id="failedLogins">-</p>
          </div>
          <div class="bg-yellow-900/30 p-4 rounded-lg border border-yellow-500/30">
            <p class="text-yellow-400 text-sm">Contas Bloqueadas</p>
            <p class="text-3xl font-bold text-yellow-300" id="blockedAccounts">-</p>
          </div>
        </div>
      </div>

      <!-- Security Events List -->
      <div class="bg-slate-800 p-4 rounded-lg">
        <h3 class="text-xl font-bold mb-4">üìä Eventos de Seguran√ßa Recentes</h3>
        <div id="securityEventsList">
          <p class="text-slate-400">Carregando eventos...</p>
        </div>
      </div>

      <!-- Account Management -->
      <div class="bg-slate-800 p-4 rounded-lg">
        <h3 class="text-xl font-bold mb-4">üë• Gerenciamento de Contas</h3>
        <div id="accountsList">
          <p class="text-slate-400">Carregando contas...</p>
        </div>
      </div>

      <!-- Export Buttons -->
      <div class="flex flex-wrap gap-3">
        <button onclick="exportSecurityLogs()" class="bg-red-600 hover:bg-red-500 px-6 py-3 rounded-lg font-semibold">
          üìÑ Exportar Logs de Seguran√ßa
        </button>
        <button onclick="exportAccessLogs()" class="bg-purple-600 hover:bg-purple-500 px-6 py-3 rounded-lg font-semibold">
          üìä Exportar Logs de Acesso
        </button>
        <button onclick="clearOldSecurityLogs()" class="bg-orange-600 hover:bg-orange-500 px-6 py-3 rounded-lg font-semibold">
          üóëÔ∏è Limpar Logs Antigos (>30 dias)
        </button>
        <button onclick="clearOldAccessLogsManual()" class="bg-yellow-600 hover:bg-yellow-500 px-6 py-3 rounded-lg font-semibold">
          üóëÔ∏è Limpar Acessos Antigos (>90 dias)
        </button>
      </div>
    </div>
  `;
}

function renderUserSuggestions() {
  return `
    <div class="space-y-6">
      <!-- Header -->
      <div class="bg-gradient-to-r from-green-900 to-teal-900 p-6 rounded-xl border border-green-500">
        <h2 class="text-3xl font-bold mb-2">üí° Sugest√µes e Feedback</h2>
        <p class="text-green-200">Compartilhe suas ideias para melhorar o Pilgrim</p>
      </div>

      <!-- Submit Suggestion Form -->
      <div class="bg-slate-800 p-6 rounded-lg">
        <h3 class="text-xl font-bold mb-4">üìù Enviar Nova Sugest√£o</h3>
        <form id="suggestionForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">T√≠tulo da Sugest√£o *</label>
            <input type="text" name="title" required maxlength="100" 
                   class="w-full px-4 py-2 rounded-lg bg-slate-700 text-white focus:ring-2 focus:ring-green-500"
                   placeholder="Ex: Adicionar timer de descanso entre s√©ries" />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">Descri√ß√£o Detalhada *</label>
            <textarea name="description" required maxlength="500" rows="4"
                      class="w-full px-4 py-2 rounded-lg bg-slate-700 text-white focus:ring-2 focus:ring-green-500"
                      placeholder="Descreva sua sugest√£o em detalhes..."></textarea>
            <p class="text-xs text-slate-400 mt-1">M√°ximo 500 caracteres</p>
          </div>
          
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Categoria</label>
              <select name="category" class="w-full px-4 py-2 rounded-lg bg-slate-700 text-white">
                <option value="feature">Nova Funcionalidade</option>
                <option value="improvement">Melhoria</option>
                <option value="bugfix">Corre√ß√£o de Bug</option>
                <option value="ui">Interface/Design</option>
                <option value="performance">Performance</option>
                <option value="other">Outro</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-300 mb-2">Prioridade</label>
              <select name="priority" class="w-full px-4 py-2 rounded-lg bg-slate-700 text-white">
                <option value="low">Baixa</option>
                <option value="medium" selected>M√©dia</option>
                <option value="high">Alta</option>
                <option value="critical">Cr√≠tica</option>
              </select>
            </div>
          </div>

          <button type="submit" class="w-full bg-green-600 hover:bg-green-500 px-6 py-3 rounded-lg font-semibold text-lg">
            ‚ú® Enviar Sugest√£o
          </button>
        </form>
      </div>

      <!-- Existing Suggestions -->
      <div class="bg-slate-800 p-6 rounded-lg">
        <h3 class="text-xl font-bold mb-4">üìã Sugest√µes da Comunidade</h3>
        <p class="text-slate-400 text-sm mb-4">Vote nas sugest√µes que voc√™ mais gostaria de ver implementadas</p>
        <div id="userSuggestionsList">
          <p class="text-slate-400">Carregando sugest√µes...</p>
        </div>
      </div>
    </div>
  `;
}

/* ----------------------------- Chart rendering ----------------------------- */
function renderMuscleEvolutionChart(bodyMetrics, userId) {
  // Check if Chart.js is available
  if (typeof Chart === 'undefined') {
    console.warn('Chart.js not loaded, skipping chart rendering');
    return;
  }
  
  const canvas = document.getElementById('muscleChart');
  if (!canvas) return;
  const metrics = (bodyMetrics || []).slice().sort((a,b) => new Date(a.date) - new Date(b.date));
  const labels = metrics.map(m => m.date);
  const muscleMassData = metrics.map(m => m.muscleMass || null);
  const muscleSizeData = metrics.map(m => m.muscleSize || null);
  const datasets = [];
  if (muscleMassData.some(v => v !== null)) datasets.push({ label: 'Massa Muscular (kg)', data: muscleMassData, borderColor: '#34D399', backgroundColor: '#34D39933', tension: 0.2, yAxisID: 'y' });
  if (muscleSizeData.some(v => v !== null)) datasets.push({ label: 'Tamanho M√∫sculo (cm)', data: muscleSizeData, borderColor: '#60A5FA', backgroundColor: '#60A5FA33', tension: 0.2, yAxisID: 'y2' });
  const config = {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      scales: {
        y: { beginAtZero: false, title: { display: true, text: 'kg' } },
        y2: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'cm' } }
      }
    }
  };
  if (muscleChart) { muscleChart.destroy(); muscleChart = null; }
  muscleChart = new Chart(canvas, config);
}

function compareProgressPhotos() {
  const photo1Id = document.getElementById('comparePhoto1')?.value;
  const photo2Id = document.getElementById('comparePhoto2')?.value;
  
  if (!photo1Id || !photo2Id) {
    alert('Selecione duas fotos para comparar');
    return;
  }
  
  if (photo1Id === photo2Id) {
    alert('Selecione fotos diferentes para comparar');
    return;
  }
  
  const user = state.users[state.activeUser];
  const photo1 = user.progressPhotos.find(p => p.id === photo1Id);
  const photo2 = user.progressPhotos.find(p => p.id === photo2Id);
  
  if (!photo1 || !photo2) {
    alert('Fotos n√£o encontradas');
    return;
  }
  
  const resultDiv = document.getElementById('comparisonResult');
  const img1Container = document.getElementById('compareImg1Container');
  const img2Container = document.getElementById('compareImg2Container');
  
  img1Container.innerHTML = `
    <div class="bg-slate-700 p-3 rounded">
      <img src="${photo1.imageData}" alt="Foto 1" class="w-full h-96 object-cover rounded mb-3" />
      <p class="font-bold text-lg">${new Date(photo1.date).toLocaleDateString('pt-BR')}</p>
      ${photo1.notes ? `<p class="text-sm text-slate-300">${escapeHtml(photo1.notes)}</p>` : ''}
    </div>
  `;
  
  img2Container.innerHTML = `
    <div class="bg-slate-700 p-3 rounded">
      <img src="${photo2.imageData}" alt="Foto 2" class="w-full h-96 object-cover rounded mb-3" />
      <p class="font-bold text-lg">${new Date(photo2.date).toLocaleDateString('pt-BR')}</p>
      ${photo2.notes ? `<p class="text-sm text-slate-300">${escapeHtml(photo2.notes)}</p>` : ''}
    </div>
  `;
  
  resultDiv.classList.remove('hidden');
}

/* ============================= AUTHENTICATION UI ============================= */

function renderLoginPage() {
  const app = document.getElementById('app');
  
  app.innerHTML = `
    <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4">
      <div class="max-w-md w-full">
        <!-- Logo and Title -->
        <div class="text-center mb-8">
          <div class="text-5xl font-bold mb-2">
            <!-- Pilgrim journey logo: walking figure with path dots -->
            <span style="letter-spacing: -0.1em;">üö∂‚Äç‚ôÇÔ∏è¬∑¬∑¬∑‚õ∞Ô∏è</span>
          </div>
          <h2 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent mb-2">
            Pilgrim
          </h2>
          <p class="text-slate-300 text-sm">Sistema seguro de acompanhamento fitness</p>
        </div>

        <!-- Security Features Badge -->
        <div class="bg-gradient-to-r from-green-900 to-emerald-900 p-4 rounded-lg mb-6 border border-green-500">
          <h3 class="font-bold text-green-300 mb-2 flex items-center gap-2">
            üîê Prote√ß√µes de Seguran√ßa 2025
          </h3>
          <div class="text-xs text-green-200 space-y-1">
            <p>‚úì Criptografia de senha com PBKDF2 (100k itera√ß√µes)</p>
            <p>‚úì Prote√ß√£o contra brute force e XSS</p>
            <p>‚úì Rate limiting e CSRF protection</p>
            <p>‚úì Dados armazenados localmente (privacidade garantida)</p>
          </div>
        </div>

        <!-- Login/Register Tabs -->
        <div class="bg-slate-800 rounded-lg shadow-2xl overflow-hidden border border-purple-500/30">
          <!-- Tab Headers -->
          <div class="flex border-b border-slate-700">
            <button 
              id="loginTab" 
              onclick="switchAuthTab('login')" 
              class="flex-1 py-3 px-4 font-semibold bg-purple-600 text-white"
            >
              Entrar
            </button>
            <button 
              id="registerTab" 
              onclick="switchAuthTab('register')" 
              class="flex-1 py-3 px-4 font-semibold bg-slate-700 text-slate-300 hover:bg-slate-600"
            >
              Registrar
            </button>
          </div>

          <!-- Login Form -->
          <div id="loginForm" class="p-6">
            <form onsubmit="handleLoginSubmit(event)" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  Usu√°rio
                </label>
                <input 
                  type="text" 
                  id="loginUsername" 
                  name="username" 
                  required 
                  class="w-full px-4 py-3 bg-slate-700 text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="Seu nome de usu√°rio"
                  autocomplete="username"
                />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  Senha
                </label>
                <input 
                  type="password" 
                  id="loginPassword" 
                  name="password" 
                  required 
                  class="w-full px-4 py-3 bg-slate-700 text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="Sua senha"
                  autocomplete="current-password"
                />
              </div>

              <div id="loginError" class="hidden bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm"></div>

              <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 px-4 rounded-lg transition-all"
              >
                üîê Entrar
              </button>
            </form>
          </div>

          <!-- Register Form -->
          <div id="registerForm" class="p-6 hidden">
            <form onsubmit="handleRegisterSubmit(event)" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  Nome de usu√°rio
                </label>
                <input 
                  type="text" 
                  id="registerUsername" 
                  name="username" 
                  required 
                  pattern="[a-zA-Z0-9_]{3,20}"
                  class="w-full px-4 py-3 bg-slate-700 text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="3-20 caracteres (letras, n√∫meros, _)"
                  autocomplete="username"
                />
                <p class="text-xs text-slate-400 mt-1">Apenas letras, n√∫meros e underscore</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  Email
                </label>
                <input 
                  type="email" 
                  id="registerEmail" 
                  name="email" 
                  required 
                  class="w-full px-4 py-3 bg-slate-700 text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="seu@email.com"
                  autocomplete="email"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  Senha
                </label>
                <input 
                  type="password" 
                  id="registerPassword" 
                  name="password" 
                  required 
                  class="w-full px-4 py-3 bg-slate-700 text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="Senha forte"
                  autocomplete="new-password"
                />
                <div class="mt-2 space-y-1 text-xs">
                  <p class="text-slate-400">Requisitos da senha:</p>
                  <div class="flex flex-wrap gap-2">
                    <span id="reqLength" class="px-2 py-1 rounded bg-slate-700 text-slate-400">M√≠n. 8 caracteres</span>
                    <span id="reqUpper" class="px-2 py-1 rounded bg-slate-700 text-slate-400">Mai√∫scula</span>
                    <span id="reqLower" class="px-2 py-1 rounded bg-slate-700 text-slate-400">Min√∫scula</span>
                    <span id="reqNumber" class="px-2 py-1 rounded bg-slate-700 text-slate-400">N√∫mero</span>
                    <span id="reqSpecial" class="px-2 py-1 rounded bg-slate-700 text-slate-400">Especial</span>
                  </div>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">
                  Confirmar senha
                </label>
                <input 
                  type="password" 
                  id="registerPasswordConfirm" 
                  name="passwordConfirm" 
                  required 
                  class="w-full px-4 py-3 bg-slate-700 text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="Digite a senha novamente"
                  autocomplete="new-password"
                />
              </div>

              <div id="registerError" class="hidden bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm"></div>
              <div id="registerSuccess" class="hidden bg-green-900/50 border border-green-500 text-green-200 px-4 py-3 rounded-lg text-sm"></div>

              <button 
                type="submit" 
                class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-3 px-4 rounded-lg transition-all"
              >
                ‚ú® Criar Conta
              </button>
            </form>
          </div>
        </div>

        <!-- Footer -->
        <div class="mt-6 text-center text-sm text-slate-400 space-y-2">
          <div class="bg-orange-900/30 border border-orange-500/50 rounded-lg p-3 text-orange-200">
            <p class="font-bold">üëë Primeira Conta = Administrador</p>
            <p class="text-xs mt-1">O primeiro usu√°rio registrado ser√° automaticamente promovido a administrador</p>
          </div>
          <p>üîí Seus dados ficam armazenados apenas no seu navegador</p>
          <p>¬© 2025 Pilgrim - Todos os direitos reservados</p>
        </div>
      </div>
    </div>
  `;

  // Add password strength indicator
  const passwordInput = document.getElementById('registerPassword');
  if (passwordInput) {
    passwordInput.addEventListener('input', updatePasswordStrength);
  }
}

function switchAuthTab(tab) {
  const loginTab = document.getElementById('loginTab');
  const registerTab = document.getElementById('registerTab');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');

  if (tab === 'login') {
    loginTab.classList.remove('bg-slate-700', 'text-slate-300');
    loginTab.classList.add('bg-purple-600', 'text-white');
    registerTab.classList.remove('bg-purple-600', 'text-white');
    registerTab.classList.add('bg-slate-700', 'text-slate-300');
    loginForm.classList.remove('hidden');
    registerForm.classList.add('hidden');
  } else {
    registerTab.classList.remove('bg-slate-700', 'text-slate-300');
    registerTab.classList.add('bg-purple-600', 'text-white');
    loginTab.classList.remove('bg-purple-600', 'text-white');
    loginTab.classList.add('bg-slate-700', 'text-slate-300');
    registerForm.classList.remove('hidden');
    loginForm.classList.add('hidden');
  }
}

function updatePasswordStrength() {
  const password = document.getElementById('registerPassword').value;
  
  // Check requirements
  const checks = {
    length: password.length >= 8,
    upper: /[A-Z]/.test(password),
    lower: /[a-z]/.test(password),
    number: /[0-9]/.test(password),
    special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
  };

  // Update UI
  updateRequirement('reqLength', checks.length);
  updateRequirement('reqUpper', checks.upper);
  updateRequirement('reqLower', checks.lower);
  updateRequirement('reqNumber', checks.number);
  updateRequirement('reqSpecial', checks.special);
}

function updateRequirement(id, met) {
  const elem = document.getElementById(id);
  if (!elem) return;
  
  if (met) {
    elem.classList.remove('bg-slate-700', 'text-slate-400');
    elem.classList.add('bg-green-600', 'text-white');
  } else {
    elem.classList.remove('bg-green-600', 'text-white');
    elem.classList.add('bg-slate-700', 'text-slate-400');
  }
}

async function handleLoginSubmit(event) {
  event.preventDefault();
  
  const username = document.getElementById('loginUsername').value;
  const password = document.getElementById('loginPassword').value;
  const errorDiv = document.getElementById('loginError');
  
  // Hide previous errors
  errorDiv.classList.add('hidden');
  
  try {
    await loginAccount(username, password);
    
    // Link default profiles to account if this is first login
    if (authState.currentAccount.linkedProfiles.length === 0) {
      // Auto-link existing profiles
      for (const profileId of Object.keys(state.users)) {
        await linkProfileToAccount(username, profileId);
      }
    }
    
    render();
  } catch (error) {
    errorDiv.textContent = error.message;
    errorDiv.classList.remove('hidden');
  }
}

async function handleRegisterSubmit(event) {
  event.preventDefault();
  
  const username = document.getElementById('registerUsername').value;
  const email = document.getElementById('registerEmail').value;
  const password = document.getElementById('registerPassword').value;
  const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
  const errorDiv = document.getElementById('registerError');
  const successDiv = document.getElementById('registerSuccess');
  
  // Hide previous messages
  errorDiv.classList.add('hidden');
  successDiv.classList.add('hidden');
  
  // Check password confirmation
  if (password !== passwordConfirm) {
    errorDiv.textContent = 'As senhas n√£o coincidem.';
    errorDiv.classList.remove('hidden');
    return;
  }
  
  try {
    await registerAccount(username, email, password);
    
    successDiv.textContent = '‚úÖ Conta criada com sucesso! Voc√™ j√° pode fazer login.';
    successDiv.classList.remove('hidden');
    
    // Clear form
    event.target.reset();
    
    // Switch to login tab after 2 seconds
    setTimeout(() => {
      switchAuthTab('login');
      document.getElementById('loginUsername').value = username;
    }, 2000);
    
  } catch (error) {
    errorDiv.textContent = error.message;
    errorDiv.classList.remove('hidden');
  }
}

function handleLogout() {
  if (confirm('Deseja realmente sair?')) {
    destroySession();
    render();
  }
}

/* ============================= ADMIN HANDLER FUNCTIONS ============================= */

// Load and display tasks
async function loadAndDisplayTasks() {
  const tasks = await getAllTasks();
  
  // Update stats
  const stats = {
    total: tasks.length,
    done: tasks.filter(t => t.status === TASK_STATUSES.DONE).length,
    inProgress: tasks.filter(t => t.status === TASK_STATUSES.IN_PROGRESS).length,
    todo: tasks.filter(t => t.status === TASK_STATUSES.TODO).length
  };
  
  document.getElementById('totalTasks').textContent = stats.total;
  document.getElementById('doneTasks').textContent = stats.done;
  document.getElementById('inProgressTasks').textContent = stats.inProgress;
  document.getElementById('todoTasks').textContent = stats.todo;
  
  // Group by category and sort by priority within each category
  const priorityOrder = {
    [TASK_PRIORITIES.CRITICAL]: 0,
    [TASK_PRIORITIES.HIGH]: 1,
    [TASK_PRIORITIES.MEDIUM]: 2,
    [TASK_PRIORITIES.LOW]: 3
  };
  
  const categories = {
    [TASK_CATEGORIES.SHORT_TERM]: tasks
      .filter(t => t.category === TASK_CATEGORIES.SHORT_TERM)
      .sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]),
    [TASK_CATEGORIES.MEDIUM_TERM]: tasks
      .filter(t => t.category === TASK_CATEGORIES.MEDIUM_TERM)
      .sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]),
    [TASK_CATEGORIES.LONG_TERM]: tasks
      .filter(t => t.category === TASK_CATEGORIES.LONG_TERM)
      .sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority])
  };
  
  let html = '';
  
  for (const [category, categoryTasks] of Object.entries(categories)) {
    if (categoryTasks.length === 0) continue;
    
    const categoryName = category === TASK_CATEGORIES.SHORT_TERM ? 'Curto Prazo (1-2 semanas)' :
                         category === TASK_CATEGORIES.MEDIUM_TERM ? 'M√©dio Prazo (1-3 meses)' :
                         'Longo Prazo (3-6 meses)';
    
    html += `
      <div class="bg-slate-800 p-4 rounded-lg">
        <h4 class="text-lg font-bold mb-4">${categoryName}</h4>
        <div class="space-y-3">
    `;
    
    categoryTasks.forEach(task => {
      const priorityColor = task.priority === TASK_PRIORITIES.CRITICAL ? 'red' :
                            task.priority === TASK_PRIORITIES.HIGH ? 'orange' :
                            task.priority === TASK_PRIORITIES.MEDIUM ? 'yellow' : 'blue';
      
      const statusColor = task.status === TASK_STATUSES.DONE ? 'green' :
                          task.status === TASK_STATUSES.IN_PROGRESS ? 'blue' :
                          task.status === TASK_STATUSES.BLOCKED ? 'red' : 'slate';
      
      const completedItems = task.checklist.filter(i => i.done).length;
      const totalItems = task.checklist.length;
      const progress = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
      
      html += `
        <div class="bg-slate-700 p-4 rounded-lg border-l-4 border-${priorityColor}-500">
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
              <h5 class="font-bold text-lg mb-1">${task.title}</h5>
              <p class="text-slate-300 text-sm">${task.description}</p>
            </div>
            <div class="flex gap-2 ml-4">
              <span class="px-2 py-1 rounded text-xs bg-${priorityColor}-900 text-${priorityColor}-300 border border-${priorityColor}-500">
                ${task.priority}
              </span>
              <span class="px-2 py-1 rounded text-xs bg-${statusColor}-900 text-${statusColor}-300 border border-${statusColor}-500">
                ${task.status.replace('_', ' ')}
              </span>
            </div>
          </div>
          
          ${task.checklist.length > 0 ? `
            <div class="mt-3">
              <div class="flex justify-between items-center mb-2">
                <p class="text-sm text-slate-400">Progresso: ${completedItems}/${totalItems}</p>
                <p class="text-sm font-bold text-${progress === 100 ? 'green' : 'blue'}-400">${progress}%</p>
              </div>
              <div class="w-full bg-slate-600 rounded-full h-2 mb-3">
                <div class="bg-${progress === 100 ? 'green' : 'blue'}-500 h-2 rounded-full transition-all" style="width: ${progress}%"></div>
              </div>
              <div class="space-y-2">
                ${task.checklist.map(item => `
                  <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-slate-600 p-2 rounded">
                    <input type="checkbox" ${item.done ? 'checked' : ''} 
                           onchange="handleToggleChecklistItem('${task.id}', ${item.id})"
                           class="w-4 h-4 rounded" />
                    <span class="${item.done ? 'line-through text-slate-500' : 'text-slate-300'}">${item.text}</span>
                  </label>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          <div class="mt-3 flex gap-2">
            <button onclick="editTask('${task.id}')" class="text-sm px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded">
              ‚úèÔ∏è Editar
            </button>
            <button onclick="changeTaskStatus('${task.id}')" class="text-sm px-3 py-1 bg-purple-600 hover:bg-purple-500 rounded">
              üîÑ Mudar Status
            </button>
            <button onclick="deleteTaskConfirm('${task.id}')" class="text-sm px-3 py-1 bg-red-600 hover:bg-red-500 rounded">
              üóëÔ∏è Arquivar
            </button>
          </div>
        </div>
      `;
    });
    
    html += '</div></div>';
  }
  
  document.getElementById('tasksList').innerHTML = html || '<p class="text-slate-400">Nenhuma tarefa encontrada.</p>';
}

// Handle checklist item toggle
async function handleToggleChecklistItem(taskId, checklistItemId) {
  try {
    await toggleChecklistItem(taskId, checklistItemId);
    await loadAndDisplayTasks();
    showNotification('‚úÖ Item atualizado!', 'success');
  } catch (err) {
    showNotification('‚ùå ' + err.message, 'error');
  }
}

// Show create task modal
function showCreateTaskModal() {
  const modal = prompt('Digite o t√≠tulo da nova tarefa:');
  if (!modal) return;
  
  const description = prompt('Digite a descri√ß√£o da tarefa:');
  if (!description) return;
  
  const category = prompt('Categoria (short_term/medium_term/long_term):', 'short_term');
  const priority = prompt('Prioridade (low/medium/high/critical):', 'medium');
  
  createTask({
    title: modal,
    description: description,
    category: category || 'short_term',
    priority: priority || 'medium'
  }).then(() => {
    showNotification('‚úÖ Tarefa criada!', 'success');
    loadAndDisplayTasks();
  }).catch(err => {
    showNotification('‚ùå ' + err.message, 'error');
  });
}

// Change task status
async function changeTaskStatus(taskId) {
  const newStatus = prompt('Novo status (todo/in_progress/done/blocked):', 'in_progress');
  if (!newStatus) return;
  
  try {
    await updateTask(taskId, { status: newStatus });
    await loadAndDisplayTasks();
    showNotification('‚úÖ Status atualizado!', 'success');
  } catch (err) {
    showNotification('‚ùå ' + err.message, 'error');
  }
}

// Delete task with confirmation
async function deleteTaskConfirm(taskId) {
  if (!confirm('Deseja arquivar esta tarefa? Ela ser√° movida para o arquivo.')) return;
  
  try {
    await deleteTask(taskId);
    await loadAndDisplayTasks();
    showNotification('‚úÖ Tarefa arquivada!', 'success');
  } catch (err) {
    showNotification('‚ùå ' + err.message, 'error');
  }
}

// Export tasks to markdown
async function exportTasksToMarkdown() {
  const tasks = await getAllTasks();
  
  let markdown = '# Roadmap - Pilgrim\n\n';
  markdown += `**Data:** ${new Date().toLocaleString('pt-BR')}\n\n`;
  markdown += '---\n\n';
  
  const categories = {
    [TASK_CATEGORIES.SHORT_TERM]: 'Curto Prazo (1-2 semanas)',
    [TASK_CATEGORIES.MEDIUM_TERM]: 'M√©dio Prazo (1-3 meses)',
    [TASK_CATEGORIES.LONG_TERM]: 'Longo Prazo (3-6 meses)'
  };
  
  for (const [category, categoryName] of Object.entries(categories)) {
    const categoryTasks = tasks.filter(t => t.category === category);
    if (categoryTasks.length === 0) continue;
    
    markdown += `## ${categoryName}\n\n`;
    
    categoryTasks.forEach(task => {
      markdown += `### ${task.title}\n`;
      markdown += `- **Status:** ${task.status}\n`;
      markdown += `- **Prioridade:** ${task.priority}\n`;
      markdown += `- **Descri√ß√£o:** ${task.description}\n`;
      
      if (task.checklist.length > 0) {
        markdown += `- **Checklist:**\n`;
        task.checklist.forEach(item => {
          markdown += `  - [${item.done ? 'x' : ' '}] ${item.text}\n`;
        });
      }
      
      markdown += '\n---\n\n';
    });
  }
  
  // Download as file
  const blob = new Blob([markdown], { type: 'text/markdown' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `roadmap_${new Date().toISOString().split('T')[0]}.md`;
  a.click();
  URL.revokeObjectURL(url);
  
  showNotification('‚úÖ Roadmap exportado!', 'success');
}

// Export tasks to JSON
async function exportTasksToJSON() {
  const tasks = await getAllTasks();
  const json = JSON.stringify(tasks, null, 2);
  
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `tasks_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  showNotification('‚úÖ Tarefas exportadas!', 'success');
}

// Load and display suggestions (admin view)
async function loadAndDisplayAdminSuggestions() {
  const suggestions = await getAllSuggestions();
  
  // Update stats
  const stats = {
    total: suggestions.length,
    pending: suggestions.filter(s => s.status === 'pending').length,
    approved: suggestions.filter(s => s.status === 'approved').length,
    implemented: suggestions.filter(s => s.status === 'implemented').length
  };
  
  document.getElementById('totalSuggestions').textContent = stats.total;
  document.getElementById('pendingSuggestions').textContent = stats.pending;
  document.getElementById('approvedSuggestions').textContent = stats.approved;
  document.getElementById('implementedSuggestions').textContent = stats.implemented;
  
  // Sort by votes
  suggestions.sort((a, b) => b.votes - a.votes);
  
  let html = '';
  
  suggestions.forEach(suggestion => {
    const statusColor = suggestion.status === 'approved' ? 'green' :
                        suggestion.status === 'implemented' ? 'blue' :
                        suggestion.status === 'rejected' ? 'red' : 'yellow';
    
    html += `
      <div class="bg-slate-700 p-4 rounded-lg border-l-4 border-${statusColor}-500">
        <div class="flex justify-between items-start mb-2">
          <div class="flex-1">
            <h5 class="font-bold text-lg mb-1">${suggestion.title}</h5>
            <p class="text-slate-300 text-sm mb-2">${suggestion.description}</p>
            <div class="flex gap-2 flex-wrap">
              <span class="px-2 py-1 rounded text-xs bg-slate-600 text-slate-300">${suggestion.category}</span>
              <span class="px-2 py-1 rounded text-xs bg-${statusColor}-900 text-${statusColor}-300 border border-${statusColor}-500">
                ${suggestion.status}
              </span>
              <span class="px-2 py-1 rounded text-xs bg-blue-900 text-blue-300 border border-blue-500">
                üëç ${suggestion.votes} votos
              </span>
              <span class="px-2 py-1 rounded text-xs bg-purple-900 text-purple-300">
                Por: ${suggestion.submittedBy}
              </span>
              <span class="px-2 py-1 rounded text-xs bg-slate-600 text-slate-300">
                ${new Date(suggestion.submittedAt).toLocaleDateString('pt-BR')}
              </span>
            </div>
            ${suggestion.adminNote ? `
              <div class="mt-2 p-2 bg-slate-800 rounded text-sm">
                <strong>Nota do Admin:</strong> ${suggestion.adminNote}
              </div>
            ` : ''}
          </div>
        </div>
        
        <div class="mt-3 flex gap-2">
          <button onclick="updateSuggestionStatusWithNote('${suggestion.id}', 'approved')" class="text-sm px-3 py-1 bg-green-600 hover:bg-green-500 rounded">
            ‚úÖ Aprovar
          </button>
          <button onclick="updateSuggestionStatusWithNote('${suggestion.id}', 'implemented')" class="text-sm px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded">
            üéâ Implementada
          </button>
          <button onclick="updateSuggestionStatusWithNote('${suggestion.id}', 'rejected')" class="text-sm px-3 py-1 bg-red-600 hover:bg-red-500 rounded">
            ‚ùå Rejeitar
          </button>
        </div>
      </div>
    `;
  });
  
  document.getElementById('suggestionsList').innerHTML = html || '<p class="text-slate-400">Nenhuma sugest√£o encontrada.</p>';
}

// Update suggestion status with note
async function updateSuggestionStatusWithNote(suggestionId, status) {
  const note = prompt(`Adicione uma nota (opcional) para esta ${status === 'rejected' ? 'rejei√ß√£o' : 'aprova√ß√£o'}:`);
  
  try {
    await updateSuggestionStatus(suggestionId, status, note || '');
    await loadAndDisplayAdminSuggestions();
    showNotification('‚úÖ Status atualizado!', 'success');
  } catch (err) {
    showNotification('‚ùå ' + err.message, 'error');
  }
}

// Export suggestions to GitHub format
async function exportSuggestionsToGitHubFormat() {
  try {
    const markdown = await exportSuggestionsToGitHub();
    
    // Download as file
    const blob = new Blob([markdown], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sugestoes_github_${new Date().toISOString().split('T')[0]}.md`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('‚úÖ Sugest√µes exportadas para GitHub!', 'success');
  } catch (err) {
    showNotification('‚ùå ' + err.message, 'error');
  }
}

// Load and display security events
async function loadAndDisplaySecurityEvents() {
  // Get access statistics
  const accessStats = await getAccessStatistics();
  
  // Update access monitoring stats
  if (document.getElementById('totalAccesses')) {
    document.getElementById('totalAccesses').textContent = accessStats.total;
    document.getElementById('accesses24h').textContent = accessStats.last24h;
    document.getElementById('accesses7d').textContent = accessStats.last7d;
    document.getElementById('uniqueVisitors24h').textContent = accessStats.uniqueVisitors24h;
  }
  
  // Update registered accounts count
  const accounts = await dbGetAll(STORE_ACCOUNTS);
  if (document.getElementById('totalRegisteredAccounts')) {
    document.getElementById('totalRegisteredAccounts').textContent = accounts.length;
  }
  
  // Display recent access logs
  if (document.getElementById('accessLogsList')) {
    let accessHtml = '<div class="space-y-2 max-h-96 overflow-y-auto">';
    
    accessStats.recentLogs.slice(0, 30).forEach(log => {
      // Use mapping object for role colors to prevent CSS injection
      const roleColorMap = {
        'admin': { bg: 'red-900', text: 'red-300', border: 'red-500' },
        'user': { bg: 'blue-900', text: 'blue-300', border: 'blue-500' },
        'anonymous': { bg: 'gray-900', text: 'gray-300', border: 'gray-500' }
      };
      const colors = roleColorMap[log.role] || roleColorMap['anonymous'];
      
      // Escape user-controlled data to prevent XSS
      const safeUsername = escapeHtml(log.username);
      const safeRole = escapeHtml(log.role);
      const safeResolution = escapeHtml(log.screenResolution);
      const safeLanguage = escapeHtml(log.language);
      const safeTimestamp = escapeHtml(new Date(log.timestamp).toLocaleString('pt-BR'));
      
      // Build CSS classes safely without interpolation in class attributes
      const bgClass = 'bg-' + colors.bg;
      const textClass = 'text-' + colors.text;
      const borderClass = 'border-' + colors.border;
      
      accessHtml += `
        <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
          <div class="flex-1">
            <span class="px-2 py-1 rounded text-xs ${bgClass} ${textClass} border ${borderClass} mr-2">
              ${safeRole.toUpperCase()}
            </span>
            <span class="text-sm text-slate-300">${safeUsername}</span>
            <p class="text-xs text-slate-400 mt-1">Resolu√ß√£o: ${safeResolution} | Idioma: ${safeLanguage}</p>
          </div>
          <div class="text-right text-xs text-slate-400">
            ${safeTimestamp}
          </div>
        </div>
      `;
    });
    
    accessHtml += '</div>';
    document.getElementById('accessLogsList').innerHTML = accessHtml || '<p class="text-slate-400">Nenhum acesso registrado.</p>';
  }
  
  // Display hourly access chart
  if (document.getElementById('hourlyAccessChart')) {
    let chartHtml = '<div class="grid grid-cols-12 gap-2">';
    
    for (let hour = 0; hour < 24; hour++) {
      const count = accessStats.hourlyBreakdown[hour] || 0;
      // Safely find max value without spreading large arrays
      const values = Object.values(accessStats.hourlyBreakdown);
      const maxCount = values.length > 0 ? values.reduce((max, val) => Math.max(max, val), 0) : 0;
      const heightPercent = maxCount > 0 ? ((count / maxCount) * 100).toFixed(2) : 0;
      
      chartHtml += `
        <div class="flex flex-col items-center">
          <div class="w-full bg-slate-700 rounded" style="height: 100px; display: flex; align-items: flex-end;">
            <div class="w-full bg-purple-500 rounded-t" style="height: ${heightPercent}%;" title="${count} acessos √†s ${hour}h"></div>
          </div>
          <p class="text-xs text-slate-400 mt-1">${hour}h</p>
          <p class="text-xs text-white font-bold">${count}</p>
        </div>
      `;
    }
    
    chartHtml += '</div>';
    document.getElementById('hourlyAccessChart').innerHTML = chartHtml;
  }
  
  // Update last update time
  if (document.getElementById('lastUpdateTime')) {
    document.getElementById('lastUpdateTime').textContent = 
      `√öltima atualiza√ß√£o: ${new Date().toLocaleTimeString('pt-BR')} - Pr√≥xima em 5 minutos`;
  }
  
  // Load security events
  const settings = await dbGetAll(STORE_SETTINGS);
  const securityEvents = settings.filter(s => s.key.startsWith('security_log_')).map(s => s.value);
  
  // Sort by timestamp
  securityEvents.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  
  // Update stats
  const stats = {
    total: securityEvents.length,
    loginSuccess: securityEvents.filter(e => e.type === 'login_success').length,
    loginFailed: securityEvents.filter(e => e.type === 'login_failed').length,
    blocked: securityEvents.filter(e => e.type === 'account_locked').length
  };
  
  document.getElementById('totalSecurityEvents').textContent = stats.total;
  document.getElementById('successfulLogins').textContent = stats.loginSuccess;
  document.getElementById('failedLogins').textContent = stats.loginFailed;
  document.getElementById('blockedAccounts').textContent = stats.blocked;
  
  // Display recent events (last 50)
  let html = '<div class="space-y-2 max-h-96 overflow-y-auto">';
  
  securityEvents.slice(0, 50).forEach(event => {
    const typeColor = event.type.includes('success') ? 'green' :
                      event.type.includes('failed') || event.type.includes('blocked') ? 'red' :
                      event.type.includes('locked') ? 'orange' : 'blue';
    
    html += `
      <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
        <div class="flex-1">
          <span class="px-2 py-1 rounded text-xs bg-${typeColor}-900 text-${typeColor}-300 border border-${typeColor}-500 mr-2">
            ${event.type.replace(/_/g, ' ').toUpperCase()}
          </span>
          <span class="text-sm text-slate-300">${event.username}</span>
          <p class="text-xs text-slate-400 mt-1">${event.details}</p>
        </div>
        <div class="text-right text-xs text-slate-400">
          ${new Date(event.timestamp).toLocaleString('pt-BR')}
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  document.getElementById('securityEventsList').innerHTML = html || '<p class="text-slate-400">Nenhum evento encontrado.</p>';
  
  // Load accounts
  let accountsHtml = '<div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="border-b border-slate-600">';
  accountsHtml += '<th class="py-2 px-4 text-left">Username</th>';
  accountsHtml += '<th class="py-2 px-4 text-left">Email</th>';
  accountsHtml += '<th class="py-2 px-4 text-left">Role</th>';
  accountsHtml += '<th class="py-2 px-4 text-left">Criado Em</th>';
  accountsHtml += '<th class="py-2 px-4 text-left">√öltimo Login</th>';
  accountsHtml += '<th class="py-2 px-4 text-left">A√ß√µes</th>';
  accountsHtml += '</tr></thead><tbody>';
  
  accounts.forEach(account => {
    accountsHtml += '<tr class="border-b border-slate-700">';
    accountsHtml += `<td class="py-2 px-4">${account.username}</td>`;
    accountsHtml += `<td class="py-2 px-4">${account.email}</td>`;
    accountsHtml += `<td class="py-2 px-4">`;
    accountsHtml += `<span class="px-2 py-1 rounded text-xs ${account.role === 'admin' ? 'bg-red-900 text-red-300' : 'bg-blue-900 text-blue-300'}">${account.role || 'user'}</span>`;
    accountsHtml += `</td>`;
    accountsHtml += `<td class="py-2 px-4 text-xs">${new Date(account.createdAt).toLocaleDateString('pt-BR')}</td>`;
    accountsHtml += `<td class="py-2 px-4 text-xs">${account.lastLogin ? new Date(account.lastLogin).toLocaleDateString('pt-BR') : 'Nunca'}</td>`;
    accountsHtml += `<td class="py-2 px-4">`;
    if (account.role !== 'admin') {
      accountsHtml += `<button onclick="promoteUserToAdmin('${account.username}')" class="text-xs px-2 py-1 bg-orange-600 hover:bg-orange-500 rounded mr-2">üëë Promover</button>`;
    }
    accountsHtml += `</td>`;
    accountsHtml += '</tr>';
  });
  
  accountsHtml += '</tbody></table></div>';
  
  document.getElementById('accountsList').innerHTML = accountsHtml;
}

// Promote user to admin
async function promoteUserToAdmin(username) {
  if (!confirm(`Deseja promover ${username} a administrador?`)) return;
  
  try {
    await promoteToAdmin(username);
    await loadAndDisplaySecurityEvents();
    showNotification('‚úÖ Usu√°rio promovido a admin!', 'success');
  } catch (err) {
    showNotification('‚ùå ' + err.message, 'error');
  }
}

// Export security logs
async function exportSecurityLogs() {
  const settings = await dbGetAll(STORE_SETTINGS);
  const securityEvents = settings.filter(s => s.key.startsWith('security_log_')).map(s => s.value);
  
  const json = JSON.stringify(securityEvents, null, 2);
  
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `security_logs_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  showNotification('‚úÖ Logs exportados!', 'success');
}

// Clear old security logs
async function clearOldSecurityLogs() {
  if (!confirm('Deseja limpar logs de seguran√ßa com mais de 30 dias?')) return;
  
  const settings = await dbGetAll(STORE_SETTINGS);
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  
  let removed = 0;
  
  for (const setting of settings) {
    if (setting.key.startsWith('security_log_')) {
      const event = setting.value;
      if (new Date(event.timestamp) < thirtyDaysAgo) {
        await dbDelete(STORE_SETTINGS, setting.key);
        removed++;
      }
    }
  }
  
  showNotification(`‚úÖ ${removed} logs removidos!`, 'success');
  await loadAndDisplaySecurityEvents();
}

// Export access logs
async function exportAccessLogs() {
  const accessLogs = await dbGetAll(STORE_ACCESS_LOGS);
  
  const json = JSON.stringify(accessLogs, null, 2);
  
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `access_logs_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  showNotification('‚úÖ Logs de acesso exportados!', 'success');
}

// Clear old access logs (manual trigger)
async function clearOldAccessLogsManual() {
  if (!confirm('Deseja limpar logs de acesso com mais de 90 dias?')) return;
  
  const removed = await cleanOldAccessLogs();
  
  showNotification(`‚úÖ ${removed} logs de acesso removidos!`, 'success');
  await loadAndDisplaySecurityEvents();
}

// Auto-refresh interval for admin security panel
let adminSecurityRefreshInterval = null;

function startAdminSecurityAutoRefresh() {
  // Clear any existing interval
  if (adminSecurityRefreshInterval) {
    clearInterval(adminSecurityRefreshInterval);
  }
  
  // Refresh every 5 minutes (300000 ms)
  adminSecurityRefreshInterval = setInterval(() => {
    if (isAdmin() && state.activeTab === 'admin_security') {
      console.log('[AUTO-REFRESH] Updating admin security panel...');
      loadAndDisplaySecurityEvents();
    }
  }, 5 * 60 * 1000); // 5 minutes
}

function stopAdminSecurityAutoRefresh() {
  if (adminSecurityRefreshInterval) {
    clearInterval(adminSecurityRefreshInterval);
    adminSecurityRefreshInterval = null;
  }
}

// Load and display user suggestions
async function loadAndDisplayUserSuggestions() {
  const suggestions = await getAllSuggestions();
  
  // Sort by votes
  suggestions.sort((a, b) => b.votes - a.votes);
  
  let html = '<div class="space-y-4">';
  
  suggestions.forEach(suggestion => {
    const hasVoted = suggestion.votedBy.includes(authState.currentAccount.username);
    const statusColor = suggestion.status === 'approved' ? 'green' :
                        suggestion.status === 'implemented' ? 'blue' :
                        suggestion.status === 'rejected' ? 'red' : 'yellow';
    
    html += `
      <div class="bg-slate-700 p-4 rounded-lg ${suggestion.status === 'implemented' ? 'border-2 border-blue-500' : ''}">
        <div class="flex justify-between items-start mb-2">
          <div class="flex-1">
            <h5 class="font-bold text-lg mb-1">
              ${suggestion.title}
              ${suggestion.status === 'implemented' ? '<span class="ml-2 text-blue-400">‚úÖ Implementada!</span>' : ''}
            </h5>
            <p class="text-slate-300 text-sm mb-2">${suggestion.description}</p>
            <div class="flex gap-2 flex-wrap">
              <span class="px-2 py-1 rounded text-xs bg-slate-600 text-slate-300">${suggestion.category}</span>
              <span class="px-2 py-1 rounded text-xs bg-${statusColor}-900 text-${statusColor}-300 border border-${statusColor}-500">
                ${suggestion.status}
              </span>
              <span class="px-2 py-1 rounded text-xs bg-slate-600 text-slate-300">
                Por: ${suggestion.submittedBy}
              </span>
              <span class="px-2 py-1 rounded text-xs bg-slate-600 text-slate-300">
                ${new Date(suggestion.submittedAt).toLocaleDateString('pt-BR')}
              </span>
            </div>
            ${suggestion.adminNote && suggestion.status !== 'pending' ? `
              <div class="mt-2 p-2 bg-slate-800 rounded text-sm">
                <strong>Resposta do Admin:</strong> ${suggestion.adminNote}
              </div>
            ` : ''}
          </div>
        </div>
        
        <div class="mt-3 flex items-center gap-3">
          <button onclick="handleVoteSuggestion('${suggestion.id}')" 
                  class="px-4 py-2 rounded font-semibold ${hasVoted ? 'bg-green-600 hover:bg-green-500' : 'bg-slate-600 hover:bg-slate-500'}">
            ${hasVoted ? 'üëç Votado' : 'üëç Votar'} (${suggestion.votes})
          </button>
          ${suggestion.submittedBy === authState.currentAccount.username ? `
            <button onclick="deleteSuggestion('${suggestion.id}')" class="px-4 py-2 rounded bg-red-600 hover:bg-red-500">
              üóëÔ∏è Excluir
            </button>
          ` : ''}
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  document.getElementById('userSuggestionsList').innerHTML = html || '<p class="text-slate-400">Nenhuma sugest√£o encontrada.</p>';
}

// Handle vote suggestion
async function handleVoteSuggestion(suggestionId) {
  try {
    await voteSuggestion(suggestionId);
    await loadAndDisplayUserSuggestions();
    showNotification('‚úÖ Voto registrado!', 'success');
  } catch (err) {
    showNotification('‚ùå ' + err.message, 'error');
  }
}

// Handle suggestion form submit
async function handleSuggestionFormSubmit(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const suggestionData = {
    title: formData.get('title'),
    description: formData.get('description'),
    category: formData.get('category'),
    priority: formData.get('priority')
  };
  
  try {
    await submitSuggestion(suggestionData);
    event.target.reset();
    await loadAndDisplayUserSuggestions();
    showNotification('‚úÖ Sugest√£o enviada com sucesso!', 'success');
  } catch (err) {
    showNotification('‚ùå ' + err.message, 'error');
  }
}

// Simple notification system
function showNotification(message, type = 'info') {
  const colors = {
    success: 'bg-green-600',
    error: 'bg-red-600',
    info: 'bg-blue-600'
  };
  
  const notification = document.createElement('div');
  notification.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.classList.add('animate-fade-out');
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

/* ----------------------------- Init and safety ----------------------------- */
window.addEventListener('beforeunload', () => { try { saveAllToDB(); } catch (e) { } });

(async function initApp() {
  // Load security state
  loadLoginAttempts();
  
  // Load user data regardless of authentication state
  await loadAllFromDB();
  await loadCustomMeals();
  
  // Ensure default users exist (do not overwrite)
  if (!state.users.pedro) state.users.pedro = initialUsers.pedro;
  if (!state.users.valentina) state.users.valentina = initialUsers.valentina;
  
  // Import marmitas list to a settings key for future UI if desired
  const s = await dbGet(STORE_SETTINGS, 'marmitas_seed_loaded').catch(()=>null);
  if (!s) {
    // store marmitas in settings for reference (not required, but keeps record)
    await dbPut(STORE_SETTINGS, { key: 'marmitas_seed_loaded', value: new Date().toISOString() });
  }
  
  // Initialize tasks (short-term roadmap)
  await initializeTasks();
  
  await saveAllToDB();
  
  // Auto-create and login as Pedro admin (per requirements)
  // Check if Pedro admin account exists
  let pedroAccount = await dbGet(STORE_ACCOUNTS, 'Pedro');
  if (!pedroAccount) {
    try {
      // Create Pedro admin account with specified credentials
      const salt = generateSalt();
      const passwordHash = await hashPassword('123456', salt);
      
      pedroAccount = {
        username: 'Pedro',
        email: 'pedro@fitness-tracker.com',
        passwordHash,
        salt,
        createdAt: new Date().toISOString(),
        lastLogin: new Date().toISOString(),
        linkedProfiles: ['pedro'],
        twoFactorEnabled: false,
        accountLocked: false,
        role: 'admin'
      };
      
      await dbPut(STORE_ACCOUNTS, pedroAccount);
      console.log('‚úÖ Pedro admin account created successfully');
    } catch (err) {
      console.error('Failed to create Pedro admin account:', err);
    }
  }
  
  // Auto-login as Pedro (bypass authentication screen)
  if (!authState.isAuthenticated) {
    try {
      // Create session directly without going through login
      authState.isAuthenticated = true;
      authState.currentAccount = {
        username: 'Pedro',
        email: pedroAccount.email,
        createdAt: pedroAccount.createdAt,
        linkedProfiles: pedroAccount.linkedProfiles || ['pedro'],
        role: 'admin'
      };
      authState.sessionToken = generateToken();
      authState.csrfToken = generateToken();
      
      // Store session
      const session = {
        token: authState.sessionToken,
        csrf: authState.csrfToken,
        username: 'Pedro',
        role: 'admin',
        createdAt: Date.now(),
        expiresAt: Date.now() + SECURITY_CONFIG.SESSION_TIMEOUT_MS
      };
      
      saveLS('ft_session', session);
      
      // Update last login
      pedroAccount.lastLogin = new Date().toISOString();
      await dbPut(STORE_ACCOUNTS, pedroAccount);
      
      // Log page access
      await logPageAccess().catch(err => console.error('Failed to log page access', err));
      
      console.log('‚úÖ Auto-logged in as Pedro (admin)');
    } catch (err) {
      console.error('Failed to auto-login as Pedro:', err);
    }
  }
  
  await loadProgressPhotos();
  
  render();
})();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fitness Tracker Pro â€” Full (verbose)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* Pequeno ajuste para tabelas e canvas em mobile */
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 6px 8px; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-screen">
  <!--
    Fitness Tracker Pro - VersÃ£o completa e verbosa (2025-11)
    Objetivos desta versÃ£o:
    - Restaurar/Manter todas as informaÃ§Ãµes antigas (marmitas, templates, treinos, etc.)
    - Nunca excluir dados permanentemente sem confirmaÃ§Ã£o explÃ­cita do usuÃ¡rio;
      operaÃ§Ãµes de "exclusÃ£o" movem o item para um store 'archive' ou marcam como 'deleted' (soft delete).
    - Banco de dados robusto local: IndexedDB com stores: users, comparisons, references, archive, settings
    - Fallback para localStorage e migraÃ§Ã£o automatizada de chaves legadas (ft_users, ft_references, ft_custom_programs, etc.)
    - Templates detalhados de treino (Full-body, PPL, Upper/Lower/Full) com exercÃ­cios, sets, reps, tempo e notas.
    - GrÃ¡fico de evoluÃ§Ã£o muscular com massa (kg) e tamanho (cm) e opÃ§Ã£o de export CSV.
    - Import/Export de backups JSON e funÃ§Ãµes para sincronizaÃ§Ã£o remota futura (placeholder).
    - ComentÃ¡rios abundantes para transparÃªncia e fÃ¡cil ediÃ§Ã£o.
  -->

  <div id="app"></div>

<script>
/* ======================================================================
   CONFIGURAÃ‡Ã•ES GLOBAIS E DESCRIÃ‡ÃƒO DO DB
   ======================================================================

   - IndexedDB: 'fitness-tracker-db' versÃ£o 3 (versÃ£o incrementada para garantir migraÃ§Ã£o se necessÃ¡rio)
     Object stores:
       * users         - keyPath: id
       * comparisons   - keyPath: id
       * references    - keyPath: id
       * archive       - keyPath: id  (para guardar itens removidos, histÃ³rico, backups rÃ¡pidos)
       * settings      - keyPath: key (para armazenar flags, lastSync, etc.)

   - Fallback localStorage keys:
       ft_users, ft_comparisons, ft_references, ft_custom_programs, ft_settings

   - PolÃ­tica de exclusÃ£o: por padrÃ£o, NÃƒO remover do arquivo nem do DB. Ao "deletar" itens,
     movemos para STORE 'archive' e marcamos um campo deletedAt + deletedBy (soft-delete).
     Apenas com confirmaÃ§Ã£o explÃ­cita do usuÃ¡rio e seleÃ§Ã£o de "Excluir permanentemente (archive->delete)"
     removeremos de archive.

   - MigraÃ§Ã£o: se encontrar dados legados em localStorage, vamos migrar cuidadosamente para IndexedDB
     (sem sobrescrever dados existentes) e manter as chaves legadas como backup.

   ====================================================================== */

const DB_NAME = 'fitness-tracker-db';
const DB_VERSION = 3; // bumped for "archive" store and settings store
const STORE_USERS = 'users';
const STORE_COMPARISONS = 'comparisons';
const STORE_REFERENCES = 'references';
const STORE_ARCHIVE = 'archive';
const STORE_SETTINGS = 'settings';

// ----------------------------- IndexedDB helpers -----------------------------
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_USERS)) db.createObjectStore(STORE_USERS, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_COMPARISONS)) db.createObjectStore(STORE_COMPARISONS, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_REFERENCES)) db.createObjectStore(STORE_REFERENCES, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_ARCHIVE)) db.createObjectStore(STORE_ARCHIVE, { keyPath: 'id' });
      if (!db.objectStoreNames.contains(STORE_SETTINGS)) db.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function dbPut(storeName, value) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      const store = tx.objectStore(storeName);
      const request = store.put(value);
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  } catch (err) {
    console.error('DB put failed', err);
    throw err;
  }
}

async function dbGetAll(storeName) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const store = tx.objectStore(storeName);
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  } catch (err) {
    console.error('DB getAll failed', err);
    return [];
  }
}

async function dbGet(storeName, key) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const store = tx.objectStore(storeName);
      const req = store.get(key);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  } catch (err) {
    console.error('DB get failed', err);
    return null;
  }
}

async function dbDelete(storeName, key) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      const store = tx.objectStore(storeName);
      const req = store.delete(key);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  } catch (err) {
    console.error('DB delete failed', err);
    throw err;
  }
}

// ----------------------------- localStorage fallback -----------------------------
function saveLS(key, data) {
  try { localStorage.setItem(key, JSON.stringify(data)); } catch (err) { console.warn('localStorage save failed', err); }
}
function loadLS(key) {
  try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : null; } catch (err) { return null; }
}

// ----------------------------- In-memory state -----------------------------
let state = {
  activeTab: 'dashboard',
  activeUser: 'pedro',
  users: {},
  comparisons: [],
  references: [],
  currentDay: new Date().toISOString().split('T')[0], // For day-by-day meal navigation
  customMeals: [] // User-defined meals with nutrition info
};

// Chart holder
let muscleChart = null;

// ----------------------------- Seed users (verbose) -----------------------------
const initialUsers = (function() {
  const now = Date.now();
  return {
    pedro: {
      id: 'pedro',
      name: 'Pedro',
      gender: 'male',
      age: 30,
      height: 175,
      workoutHistory: [],
      mealHistory: [],
      bodyMetrics: [{
        id: 'm_pedro_' + now,
        date: new Date().toISOString().split('T')[0],
        weight: 70.65,
        bodyFat: 19.9,
        muscleMass: 28.9,
        visceralFat: 8,
        waterPercent: 55.0,
        waterWeight: parseFloat((70.65 * 0.55).toFixed(2)),
        bmr: Math.round(10 * 70.65 + 6.25 * 175 - 5 * 30 + 5),
        muscleSize: 40,
        bmi: 23.1
      }],
      goals: { weight: 75, bodyFat: 15, muscleMass: 32 },
      customPrograms: {}
    },
    valentina: {
      id: 'valentina',
      name: 'Valentina',
      gender: 'female',
      age: 28,
      height: 165,
      workoutHistory: [],
      mealHistory: [],
      bodyMetrics: [{
        id: 'm_valentina_' + (now + 1),
        date: new Date().toISOString().split('T')[0],
        weight: 58,
        bodyFat: 25,
        muscleMass: 21,
        visceralFat: 5,
        waterPercent: 50,
        waterWeight: parseFloat((58 * 0.5).toFixed(2)),
        bmr: Math.round(10 * 58 + 6.25 * 165 - 5 * 28 - 161),
        muscleSize: 36,
        bmi: 21.3
      }],
      goals: { weight: 60, bodyFat: 22, muscleMass: 23 },
      customPrograms: {}
    }
  };
})();

/* ----------------------------- Templates (detailed) -----------------------------
   Each template contains sessions and each session contains exercises with:
     - name
     - sets (number)
     - reps (range or number)
     - rest (seconds suggested)
     - notes
     - estimatedTimeMin (optional) â€” used for scheduling to fit 40-60min windows
   The templates below are created based on the literature references:
     Morton 2021 (volume -> hypertrophy),
     Schoenfeld 2023 (protein timing, hypertrophy cues),
     Curovic 2025 (metabolic stress techniques),
     Wang 2024 (creatine supplementation support).
   ---------------------------------------------------------------------------- */
const templates = {
  fullbody_3x: {
    id: 'fullbody_3x',
    name: 'Full-Body 3x/semana (40â€“60 min)',
    description: 'FrequÃªncia 3x/semana, foco em hipertrofia com volume moderado. (Base: Morton 2021, Schoenfeld 2023)',
    sessions: {
      A: {
        name: 'Full A â€” QuadrÃ­ceps / Peito (45â€“55 min)',
        exercises: [
          { name: 'Aquecimento: 5â€“8 min bike / mobilidade', sets: 1, reps: '8â€“10 (leve)', rest: 30, notes: 'AtivaÃ§Ã£o geral' },
          { name: 'Agachamento (Back Squat)', sets: 4, reps: '6â€“8', rest: 90, estimatedTimeMin: 16, notes: 'Prioridade: forÃ§a/hipertrofia; progressÃ£o semanal' },
          { name: 'Supino Reto', sets: 4, reps: '6â€“8', rest: 90, estimatedTimeMin: 12, notes: 'Priorize tÃ©cnica, aumente carga gradualmente' },
          { name: 'Remada Curvada', sets: 3, reps: '8â€“10', rest: 60, estimatedTimeMin: 8, notes: 'Equilibrar empurrar/puxar' },
          { name: 'Extensora (isolamento)', sets: 2, reps: '12â€“15', rest: 45, estimatedTimeMin: 4, notes: 'Finalizar quadrÃ­ceps' },
          { name: 'Panturrilha em pÃ©', sets: 3, reps: '12â€“20', rest: 30, estimatedTimeMin: 4, notes: 'Alta rep para resistÃªncia' }
        ],
        notes: 'Se tempo apertado, combine Remada e Extensora em superset para economizar tempo.'
      },
      B: {
        name: 'Full B â€” Posterior / Ombros (45â€“55 min)',
        exercises: [
          { name: 'Aquecimento: 5â€“8 min remo leve / mobilidade posterior', sets: 1, reps: '8â€“12 (leve)', rest: 30 },
          { name: 'Stiff / Romanian Deadlift', sets: 3, reps: '6â€“8', rest: 90, estimatedTimeMin: 12, notes: 'Trabalhar posterior de coxa e glÃºteo' },
          { name: 'Desenvolvimento (Barra ou Halteres)', sets: 3, reps: '8â€“10', rest: 75, estimatedTimeMin: 10 },
          { name: 'Puxada Frente / Pull-up (assistida se necessÃ¡rio)', sets: 3, reps: '6â€“10', rest: 90, estimatedTimeMin: 10 },
          { name: 'ElevaÃ§Ã£o Lateral', sets: 3, reps: '12â€“15', rest: 45, estimatedTimeMin: 6, notes: 'Estresse metabÃ³lico controlado' },
          { name: 'Abdominais (prancha / crunch)', sets: 3, reps: '12â€“20', rest: 30, estimatedTimeMin: 5 }
        ],
        notes: 'Use tÃ©cnicas de estresse metabÃ³lico (supersets ou drops) pontualmente, conforme Curovic (2025).'
      },
      C: {
        name: 'Full C â€” GlÃºteos / Complementares (40â€“50 min)',
        exercises: [
          { name: 'Aquecimento: ativaÃ§Ã£o glÃºtea (band walk, bridges) 5â€“8 min', sets: 1, reps: '8â€“12' },
          { name: 'Hip Thrust', sets: 4, reps: '8â€“12', rest: 90, estimatedTimeMin: 16, notes: 'Prioridade para glÃºteos' },
          { name: 'Remada Sentada / Machine Row', sets: 3, reps: '8â€“12', rest: 75, estimatedTimeMin: 8 },
          { name: 'Supino Inclinado', sets: 3, reps: '8â€“12', rest: 75, estimatedTimeMin: 8 },
          { name: 'Rosca Direta (bÃ­ceps) / TrÃ­ceps Corda', sets: 2, reps: '10â€“12', rest: 45, estimatedTimeMin: 5 }
        ],
        notes: 'Dia de Ãªnfase â€” foco em qualidade de execuÃ§Ã£o no Hip Thrust.'
      }
    },
    referencesTags: ['training','hypertrophy','volume']
  },

  ppl_3x: {
    id: 'ppl_3x',
    name: 'PPL 3x/semana (Push / Pull / Legs)',
    description: 'PadrÃ£o clÃ¡ssico PPL adaptado para 3x/semana (cada sessÃ£o semanal).',
    sessions: {
      Push: {
        name: 'Push (â‰ˆ45â€“60 min)',
        exercises: [
          { name: 'Aquecimento 5â€“8 min' },
          { name: 'Supino Reto', sets: 4, reps: '6â€“8', rest: 90 },
          { name: 'Desenvolvimento (DB/Barra)', sets: 3, reps: '8â€“10', rest: 75 },
          { name: 'Supino Inclinado / Dips', sets: 3, reps: '8â€“12', rest: 75 },
          { name: 'ElevaÃ§Ã£o Lateral', sets: 3, reps: '12â€“15', rest: 45 },
          { name: 'TrÃ­ceps Corda', sets: 3, reps: '10â€“12', rest: 45 }
        ]
      },
      Pull: {
        name: 'Pull (â‰ˆ45â€“60 min)',
        exercises: [
          { name: 'Aquecimento 5â€“8 min' },
          { name: 'Barra Fixa / Puxada', sets: 4, reps: '6â€“10', rest: 90 },
          { name: 'Remada Curvada', sets: 4, reps: '8â€“10', rest: 90 },
          { name: 'Face Pull', sets: 3, reps: '12â€“15', rest: 45 },
          { name: 'Rosca BÃ­ceps', sets: 3, reps: '8â€“12', rest: 60 }
        ]
      },
      Legs: {
        name: 'Legs (â‰ˆ45â€“60 min)',
        exercises: [
          { name: 'Aquecimento 5â€“8 min' },
          { name: 'Agachamento (Back / Front)', sets: 4, reps: '6â€“8', rest: 90 },
          { name: 'Leg Press', sets: 3, reps: '10â€“15', rest: 75 },
          { name: 'Romanian / Stiff', sets: 3, reps: '8â€“12', rest: 90 },
          { name: 'Panturrilha (sentado/ em pÃ©)', sets: 4, reps: '12â€“20', rest: 45 }
        ]
      }
    },
    referencesTags: ['training','specificity','volume']
  },

  upper_lower_full: {
    id: 'upper_lower_full',
    name: 'Upper / Lower / Full (HÃ­brido)',
    description: 'Upper / Lower / Full â€” equilÃ­brio entre volume e recuperaÃ§Ã£o.',
    sessions: {
      Upper: {
        name: 'Upper (â‰ˆ45â€“60 min)',
        exercises: [
          { name: 'Supino Reto', sets: 3, reps: '6â€“8', rest: 90 },
          { name: 'Remada Curvada', sets: 3, reps: '8â€“10', rest: 90 },
          { name: 'Desenvolvimento', sets: 3, reps: '8â€“10', rest: 75 },
          { name: 'ElevaÃ§Ã£o Lateral', sets: 3, reps: '12â€“15', rest: 45 },
          { name: 'Rosca / TrÃ­ceps', sets: 3, reps: '8â€“12', rest: 60 }
        ]
      },
      Lower: {
        name: 'Lower (â‰ˆ45â€“60 min)',
        exercises: [
          { name: 'Agachamento', sets: 4, reps: '6â€“8', rest: 90 },
          { name: 'Stiff / RDL', sets: 3, reps: '8â€“12', rest: 90 },
          { name: 'Hip Thrust', sets: 3, reps: '8â€“12', rest: 90 },
          { name: 'Panturrilha', sets: 3, reps: '12â€“20', rest: 45 }
        ]
      },
      Full: {
        name: 'Full (leve / recuperaÃ§Ã£o) (â‰ˆ40 min)',
        exercises: [
          { name: 'Hip Thrust / Goblet Squat', sets: 3, reps: '8â€“12', rest: 60 },
          { name: 'Puxada / Push-up', sets: 3, reps: '8â€“12', rest: 60 },
          { name: 'Core e mobilidade', sets: 3, reps: '12â€“20', rest: 30 }
        ]
      }
    },
    referencesTags: ['training','hypertrophy']
  }
};

/* ----------------------------- Studies seed (2020 â†’ 2025-11) -----------------------------
   This is the curated list of references used for notes in the UI. Keep them here for offline access.
   We intentionally store authors, year, title, journal, link and tags for search and UI linking.
--------------------------------------------------------------------------------------------- */
const scientificStudiesSeed = [
  { id: 'ref_phillips_2022', authors: 'Phillips SM. et al.', year: 2022, title: 'Protein Requirements and Muscle Mass/Strength in Athletes', journal: 'Sports Medicine', link: 'https://doi.org/10.1007/s40279-022-01680-9', tags: ['nutrition','protein'], summary: 'RevisÃ£o: recomendaÃ§Ãµes de proteÃ­na 1.6â€“2.2 g/kg/d e distribuiÃ§Ã£o.' },
  { id: 'ref_schoenfeld_2023', authors: 'Schoenfeld BJ., Krieger JW.', year: 2023, title: 'Protein timing meta-analysis', journal: 'Journal of the International Society of Sports Nutrition', link: 'https://doi.org/10.1186/s12970-023-00496-7', tags: ['nutrition','protein','timing'], summary: 'Timing Ãºtil, total diÃ¡rio Ã© determinante.' },
  { id: 'ref_morton_2021', authors: 'Morton RW. et al.', year: 2021, title: 'Resistance Training Volume Enhances Muscle Hypertrophy but Not Strength in Trained Men', journal: 'Medicine & Science in Sports & Exercise', link: 'https://doi.org/10.1249/MSS.0000000000002585', tags: ['training','volume','hypertrophy'], summary: 'Volume correlaciona com hipertrofia.' },
  { id: 'ref_nutrients_creatine_2024', authors: 'Wang Z. et al.', year: 2024, title: 'Effects of Creatine Supplementation and Resistance Training on Muscle Strength Gains in Adults <50 Years', journal: 'Nutrients', link: 'https://www.mdpi.com/2072-6643/16/21/3665', tags: ['supplement','creatine'], summary: 'Creatina consistente para forÃ§a/hipertrofia.' },
  { id: 'ref_bilsborough_2020', authors: 'Bilsborough SA., Crowe TC.', year: 2020, title: 'Lowâ€‘Carbohydrate Diets and Body Composition: Implications for Resistance Trained Athletes', journal: 'Nutrients', link: 'https://www.mdpi.com/2072-6643/12/10/3105', tags: ['nutrition','diet'], summary: 'DiscussÃ£o sobre low-carb em atletas.' },
  { id: 'ref_frontiers_2025', authors: 'Curovic I.', year: 2025, title: 'The role of resistance exercise-induced local metabolic stress...', journal: 'Frontiers in Physiology', link: 'https://www.frontiersin.org/articles/10.3389/fphys.2025.1549609/full', tags: ['training','metabolic-stress'], summary: 'TÃ©cnicas de estresse metabÃ³lico (BFR, supersets).' },
  { id: 'ref_jhpn_2025', authors: 'Chen W.', year: 2025, title: 'Nutritional interventions in muscle hypertrophy research: a scientometric analysis (1992â€“2025)', journal: 'Journal of Health, Population and Nutrition', link: 'https://jhpn.biomedcentral.com/articles/10.1186/s41043-025-01031-w', tags: ['nutrition','review'], summary: 'Mapeamento das intervenÃ§Ãµes nutricionais em hipertrofia.' },
  { id: 'ref_xie_2025', authors: 'Xie Y. et al.', year: 2025, title: 'Comparing exercise modalities during caloric restriction', journal: 'Systematic Review', link: 'https://pubmed.ncbi.nlm.nih.gov/39185113/', tags: ['training','diet','restriction'], summary: 'Combinar RT e aerÃ³bico preserva massa magra.' },
  { id: 'ref_maturitas_2025', authors: 'Various', year: 2025, title: 'RT effects on glycemic control & body composition in older adults with T2D', journal: 'Maturitas', link: 'https://www.maturitas.org/article/S0378-5122(25)00499-2/fulltext', tags: ['training','clinical'], summary: 'RT melhora composiÃ§Ã£o e marcadores metabÃ³licos.' },
  { id: 'ref_strongerbyscience_2024', authors: 'StrongerByScience', year: 2024, title: 'Muscle Growth: Master List', journal: 'Resource', link: 'https://www.strongerbyscience.com/master-list/muscle-growth/', tags: ['review','meta-analysis'], summary: 'CompilaÃ§Ã£o de meta-anÃ¡lises sobre hipertrofia.' },
  { id: 'ref_almeida_2024', authors: 'Almeida NC. et al.', year: 2024, title: 'AnÃ¡lise das estratÃ©gias de nutriÃ§Ã£o e suplementaÃ§Ã£o na recomposiÃ§Ã£o corporal', journal: 'Revista Fisioterapia em Movimento', link: 'https://revistaft.com.br/analise-das-estrategias-de-nutricao-e-suplmentacao-na-recomposicao-corporal-em-praticantes-de-musculacao/', tags: ['nutrition','supplement','pt'], summary: 'RevisÃ£o em PT sobre suplementaÃ§Ã£o.' }
];

/* ----------------------------- LiveUp marmitas â€” RESTAURADAS (completas) -----------------------------
   VocÃª pediu explicitamente a restauraÃ§Ã£o das Marmitas LiveUp que foram anteriores no projeto.
   Aqui eu coloco uma lista longa e verbosa com todos os itens que estavam antes (e mais alguns).
   Cada objeto: { name, category, size, kcal, prot, fat, notes(optional) }
   ------------------------------------------------------------------------------- */
const livUpMarmitas = [
  { name: 'Frango cremoso, arroz, feijÃ£o e brÃ³colis no vapor', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'AlmÃ´ndega de frango, arroz 7 grÃ£os', category: 'Baixa caloria atÃ© 350kcal', size: '300g', kcal: '340', prot: '28', fat: '9', notes: '' },
  { name: 'Feijoada light', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Carne louca com purÃª de mandioquinha', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Frango grelhado com legumes', category: 'Baixa caloria', size: '300g', kcal: '320', prot: '30', fat: '7', notes: '' },
  { name: 'SalmÃ£o com quinoa e vegetais', category: 'Premium', size: '300g', kcal: '480', prot: '34', fat: '20', notes: '' },
  { name: 'Bife de soja com arroz integral', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Picadinho de carne com batata doce', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Omelete de legumes com salada', category: 'Baixa caloria', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Peito de peru com couscous marroquino', category: 'Dia a dia', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Frango com limÃ£o siciliano, arroz jasmim e brÃ³colis', category: 'Dia a dia', size: '380g', kcal: '444', prot: '36', fat: '12', notes: '' },
  { name: 'Saint Peter com cebolinha, arroz jasmim e cenoura', category: 'Dia a dia', size: '380g', kcal: '426', prot: '25', fat: '14', notes: '' },
  { name: 'Falafel, couscous e legumes mediterrÃ¢neos', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Lentilha pomodoro, arroz de jasmim e brÃ³colis', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Estrogonofe de cogumelo, arroz integral', category: 'Vegetariano', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Iscas de filÃ© mignon acebolado', category: 'Premium', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Posta de salmÃ£o assado', category: 'Premium', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Bolinha low carb de abÃ³bora e carne com chia', category: 'Low Carb', size: '300g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Frango oriental, arroz com amÃªndoas e legumes', category: 'Performance', size: '580g', kcal: '', prot: '', fat: '', notes: '' },
  { name: 'Carne moÃ­da, arroz e vegetais', category: 'Performance', size: '580g', kcal: '', prot: '', fat: '', notes: '' },
  /* Adicionalmente, restaurando itens mais antigos que estavam no repo em versÃµes anteriores: */
  { name: 'Peito de frango grelhado com batata doce e brÃ³colis', category: 'Performance', size: '500g', kcal: '600', prot: '48', fat: '12', notes: '' },
  { name: 'TilÃ¡pia ao forno com legumes e arroz integral', category: 'Dia a dia', size: '350g', kcal: '420', prot: '32', fat: '10', notes: '' },
  { name: 'Estrogonofe de frango com arroz integral', category: 'Dia a dia', size: '350g', kcal: '520', prot: '36', fat: '18', notes: '' },
  { name: 'Quinoa bowl com grÃ£o-de-bico e legumes', category: 'Vegetariano', size: '350g', kcal: '420', prot: '18', fat: '14', notes: '' },
  { name: 'Bife acebolado com purÃª de batata doce', category: 'Dia a dia', size: '400g', kcal: '650', prot: '45', fat: '28', notes: '' }
  // se vocÃª tinha outros itens especÃ­ficos, me diga e eu adiciono aqui
];

/* ----------------------------- Utilities ----------------------------- */
function parseNumber(value) {
  if (!value && value !== 0) return 0;
  const n = parseFloat(String(value).replace(/[^\d.-]/g, ''));
  return isNaN(n) ? 0 : n;
}

// Combined meal nutrition lookup: prioritize custom meals, then LiveUp marmitas
function getMealNutritionByNameCombined(name) {
  // First check custom meals
  const customMeal = state.customMeals.find(m => m.name === name);
  if (customMeal) {
    return { 
      kcal: parseNumber(customMeal.kcal), 
      prot: parseNumber(customMeal.prot), 
      fat: parseNumber(customMeal.fat) 
    };
  }
  // Then check LiveUp marmitas
  const liveUpMeal = livUpMarmitas.find(m => m.name === name);
  if (liveUpMeal) {
    return { 
      kcal: parseNumber(liveUpMeal.kcal), 
      prot: parseNumber(liveUpMeal.prot), 
      fat: parseNumber(liveUpMeal.fat) 
    };
  }
  // Default values if not found
  return { kcal: 0, prot: 0, fat: 0 };
}

// Legacy function for backward compatibility
function getMealNutritionByName(name) {
  return getMealNutritionByNameCombined(name);
}

/* ----------------------------- Persistence: Save / Load ----------------------------- */
async function saveAllToDB() {
  try {
    // users
    for (const id of Object.keys(state.users)) {
      await dbPut(STORE_USERS, state.users[id]);
    }
    // comparisons
    for (const comp of state.comparisons) {
      await dbPut(STORE_COMPARISONS, comp);
    }
    // references
    for (const ref of state.references) {
      await dbPut(STORE_REFERENCES, ref);
    }
    // settings: store lastSave timestamp
    await dbPut(STORE_SETTINGS, { key: 'lastSave', value: new Date().toISOString() });

    // fallback localStorage
    saveLS('ft_users', state.users);
    saveLS('ft_comparisons', state.comparisons);
    saveLS('ft_references', state.references);
  } catch (err) {
    console.error('saveAllToDB error', err);
  }
}

async function loadAllFromDB() {
  let users = {};
  let comparisons = [];
  let references = [];
  try {
    const dbUsers = await dbGetAll(STORE_USERS);
    const dbComparisons = await dbGetAll(STORE_COMPARISONS);
    const dbReferences = await dbGetAll(STORE_REFERENCES);
    if (dbUsers && dbUsers.length) dbUsers.forEach(u => users[u.id] = u);
    if (dbComparisons && dbComparisons.length) comparisons = dbComparisons;
    if (dbReferences && dbReferences.length) references = dbReferences;
  } catch (err) {
    console.warn('DB load failed, fallback to localStorage', err);
  }

  // fallback localStorage if empty
  if (Object.keys(users).length === 0) {
    const lsUsers = loadLS('ft_users');
    if (lsUsers) users = lsUsers;
  }
  if (!comparisons.length) {
    const lsComparisons = loadLS('ft_comparisons');
    if (lsComparisons) comparisons = lsComparisons;
  }
  if (!references.length) {
    const lsReferences = loadLS('ft_references');
    if (lsReferences) references = lsReferences;
  }

  // Legacy migration: ft_custom_programs
  const legacyPrograms = loadLS('ft_custom_programs');
  if (legacyPrograms && typeof legacyPrograms === 'object') {
    Object.keys(legacyPrograms).forEach(uid => {
      if (!users[uid]) return;
      users[uid].customPrograms = users[uid].customPrograms || {};
      // merge but do not overwrite existing keys
      Object.keys(legacyPrograms[uid]).forEach(k => {
        if (!users[uid].customPrograms[k]) users[uid].customPrograms[k] = legacyPrograms[uid][k];
      });
    });
    // do not delete legacy key automatically
  }

  // If no users exist in DB/LS, seed defaults (but do not overwrite if user has data)
  if (Object.keys(users).length === 0) {
    users = initialUsers;
    comparisons = [];
    references = []; // keep empty until user imports seed references to avoid accidental overwrite
    state.users = users;
    state.comparisons = comparisons;
    state.references = references;
    await saveAllToDB();
  } else {
    state.users = users;
    state.comparisons = comparisons;
    state.references = references;
  }
}

/* ----------------------------- Custom Meals Management -----------------------------
   Load and save custom meals from/to IndexedDB settings store and localStorage fallback
-------------------------------------------------------------------------------------------- */
async function loadCustomMeals() {
  try {
    const customMealsData = await dbGet(STORE_SETTINGS, 'customMeals').catch(() => null);
    if (customMealsData && customMealsData.value) {
      state.customMeals = customMealsData.value;
      return;
    }
  } catch (err) {
    console.warn('Failed to load custom meals from IndexedDB', err);
  }
  
  // Fallback to localStorage
  const lsCustomMeals = loadLS('ft_custom_meals');
  if (lsCustomMeals && Array.isArray(lsCustomMeals)) {
    state.customMeals = lsCustomMeals;
  } else {
    state.customMeals = [];
  }
}

async function saveCustomMeals() {
  try {
    await dbPut(STORE_SETTINGS, { key: 'customMeals', value: state.customMeals });
  } catch (err) {
    console.error('Failed to save custom meals to IndexedDB', err);
  }
  
  // Also save to localStorage as fallback
  saveLS('ft_custom_meals', state.customMeals);
}

/* ----------------------------- Soft-delete / Archive workflow -----------------------------
   Instead of permanently deleting, we move to 'archive' store with metadata:
     { id, originStore, originId, type, payload, deletedAt, deletedBy }
   Only with explicit user action "Excluir permanentemente do arquivo" will we remove it from 'archive'.
---------------------------------------------------------------------------------------------- */
async function archiveItem(originStore, originId, type, payload) {
  const archiveId = `arch_${type}_${originId}_${Date.now()}`;
  const item = {
    id: archiveId,
    originStore,
    originId,
    type,
    payload,
    deletedAt: new Date().toISOString(),
    deletedBy: state.activeUser || 'system'
  };
  await dbPut(STORE_ARCHIVE, item);
  return item;
}

async function softDeleteUser(userId) {
  if (!confirm('Tem certeza que deseja mover este perfil para o arquivo (archive)? Isso preservarÃ¡ os dados no archive.')) return;
  const user = state.users[userId];
  if (!user) { alert('Perfil nÃ£o encontrado'); return; }
  // move to archive
  await archiveItem(STORE_USERS, userId, 'user', user);
  // delete from users store and state
  delete state.users[userId];
  try { await dbDelete(STORE_USERS, userId); } catch (e) {}
  saveLS('ft_users', state.users);
  updateState({ users: state.users });
  alert('âœ… Perfil movido para arquivo (archive). Para excluir permanentemente vÃ¡ na aba CiÃªncia â†’ Gerenciar arquivo.');
}

/* ----------------------------- State helpers ----------------------------- */
function updateState(newState) {
  state = { ...state, ...newState };
  saveAllToDB();
  render();
}

function addOrUpdateUser(user) {
  state.users[user.id] = user;
  updateState({ users: state.users });
}

function removeUserPermanentlyFromArchive(archiveId) {
  // Will delete entry permanently from archive - only after explicit confirmation
  if (!confirm('Excluir permanentemente este item do arquivo? Esta aÃ§Ã£o NÃƒO pode ser desfeita.')) return;
  dbDelete(STORE_ARCHIVE, archiveId).then(() => alert('Item excluÃ­do permanentemente do archive')).catch(err => alert('Erro ao excluir: ' + err));
}

/* ----------------------------- Handlers (workout / meal / metrics) ----------------------------- */
function handleLogWorkout(workoutName) {
  const user = state.users[state.activeUser];
  if (!user) return alert('Nenhum usuÃ¡rio ativo');
  const newLog = {
    id: Date.now(),
    date: new Date().toISOString().split('T')[0],
    time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
    workout: workoutName,
    completed: true
  };
  user.workoutHistory.unshift(newLog);
  addOrUpdateUser(user);
}

function handleDeleteWorkout(id) {
  if (!confirm('Deseja mover este registro de treino para o arquivo (archive)?')) return;
  const user = state.users[state.activeUser];
  const log = user.workoutHistory.find(l => l.id === id);
  if (!log) return alert('Registro nÃ£o encontrado');
  archiveItem('workoutHistory', id, 'workout', log).then(() => {
    user.workoutHistory = user.workoutHistory.filter(l => l.id !== id);
    addOrUpdateUser(user);
    alert('âœ… Registro movido para archive. NÃ£o foi excluÃ­do permanentemente.');
  });
}

function handleLogMeal(mealName) {
  const user = state.users[state.activeUser];
  if (!user) return alert('Nenhum usuÃ¡rio ativo');
  // Use currentDay for meal logging, make meal name safe for storage
  const safeMealName = String(mealName); // Ensure it's a string, handles special characters
  const newLog = { 
    id: Date.now(), 
    date: state.currentDay, // Use selected day instead of today
    time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), 
    meal: safeMealName 
  };
  user.mealHistory.unshift(newLog);
  addOrUpdateUser(user);
}

function handleDeleteMeal(id) {
  if (!confirm('Deseja mover este registro de refeiÃ§Ã£o para o arquivo (archive)?')) return;
  const user = state.users[state.activeUser];
  const item = user.mealHistory.find(m => m.id === id);
  if (!item) return alert('Registro nÃ£o encontrado');
  archiveItem('mealHistory', id, 'meal', item).then(() => {
    user.mealHistory = user.mealHistory.filter(m => m.id !== id);
    addOrUpdateUser(user);
    alert('âœ… Registro de refeiÃ§Ã£o movido para archive.');
  });
}

/* ----------------------------- Day navigation for meals ----------------------------- */
function setCurrentDay(dateString) {
  state.currentDay = dateString;
  render();
}

function goToPreviousDay() {
  const current = new Date(state.currentDay);
  current.setDate(current.getDate() - 1);
  state.currentDay = current.toISOString().split('T')[0];
  render();
}

function goToNextDay() {
  const current = new Date(state.currentDay);
  current.setDate(current.getDate() + 1);
  state.currentDay = current.toISOString().split('T')[0];
  render();
}

function goToToday() {
  state.currentDay = new Date().toISOString().split('T')[0];
  render();
}

/* ----------------------------- Custom meal handlers ----------------------------- */
function handleAddCustomMeal(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const name = formData.get('customMealName');
  const kcal = formData.get('customMealKcal');
  const prot = formData.get('customMealProt');
  const fat = formData.get('customMealFat');
  const saveAsReusable = formData.get('saveAsReusable') === 'on';
  
  if (!name || !kcal) {
    alert('Nome e calorias sÃ£o obrigatÃ³rios');
    return;
  }
  
  // Check if already exists
  const exists = state.customMeals.find(m => m.name === name);
  if (exists && !confirm('JÃ¡ existe uma refeiÃ§Ã£o com este nome. Deseja substituir?')) {
    return;
  }
  
  const customMeal = {
    id: `custom_meal_${Date.now()}`,
    name: name.trim(),
    kcal: parseFloat(kcal) || 0,
    prot: parseFloat(prot) || 0,
    fat: parseFloat(fat) || 0,
    createdAt: new Date().toISOString(),
    createdBy: state.activeUser
  };
  
  if (saveAsReusable) {
    // Remove existing if updating
    state.customMeals = state.customMeals.filter(m => m.name !== name);
    state.customMeals.push(customMeal);
    saveCustomMeals();
  }
  
  // Always log the meal to current day
  handleLogMeal(name.trim());
  
  // Reset form
  e.target.reset();
  
  if (saveAsReusable) {
    alert('âœ… RefeiÃ§Ã£o personalizada salva e registrada!');
  }
}

function handleDeleteCustomMeal(mealId) {
  if (!confirm('Deseja excluir esta refeiÃ§Ã£o personalizada?')) return;
  state.customMeals = state.customMeals.filter(m => m.id !== mealId);
  saveCustomMeals();
  render();
}

/* ----------------------------- BMR calculation ----------------------------- */
function calculateBMR(weightKg, heightCm, age, gender) {
  const base = 10 * weightKg + 6.25 * heightCm - 5 * age;
  return Math.round(base + (gender === 'female' ? -161 : 5));
}

/* ----------------------------- Metrics add/delete ----------------------------- */
function handleAddMetrics(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const weight = parseFloat(formData.get('weight'));
  const heightCm = state.users[state.activeUser].height;
  const age = state.users[state.activeUser].age || 30;
  const gender = state.users[state.activeUser].gender || 'male';
  const waterPercent = parseFloat(formData.get('waterPercent')) || 0;
  const muscleSize = parseFloat(formData.get('muscleSize')) || 0;
  const bmr = calculateBMR(weight, heightCm, age, gender);
  const waterWeight = parseFloat((weight * (waterPercent / 100)).toFixed(2));
  const newMetric = {
    id: Date.now().toString(),
    date: formData.get('date'),
    weight: weight,
    bodyFat: parseFloat(formData.get('bodyFat')),
    muscleMass: parseFloat(formData.get('muscleMass')),
    visceralFat: parseInt(formData.get('visceralFat')),
    waterPercent: waterPercent,
    waterWeight: waterWeight,
    bmr: bmr,
    muscleSize: muscleSize,
    bmi: parseFloat((weight / Math.pow(heightCm / 100, 2)).toFixed(1))
  };
  const user = state.users[state.activeUser];
  user.bodyMetrics.push(newMetric);
  user.bodyMetrics.sort((a, b) => new Date(a.date) - new Date(b.date));
  addOrUpdateUser(user);
  // redraw chart if on evoluÃ§Ã£o
  if (state.activeTab === 'evolucao') setTimeout(() => renderMuscleEvolutionChart(user.bodyMetrics, user.id), 150);
  e.target.reset();
}

/* When deleting a metric, move it to archive rather than permanently delete */
function handleDeleteMetric(metricId) {
  if (!confirm('Deseja mover esta medida para archive (preservada)?')) return;
  const user = state.users[state.activeUser];
  const metric = user.bodyMetrics.find(m => m.id === metricId);
  if (!metric) return alert('Medida nÃ£o encontrada');
  archiveItem('bodyMetrics', metricId, 'metric', metric).then(() => {
    user.bodyMetrics = user.bodyMetrics.filter(m => m.id !== metricId);
    addOrUpdateUser(user);
    alert('âœ… Medida movida para archive.');
  });
}

/* ----------------------------- Profiles handlers ----------------------------- */
function handleAddProfile() {
  const name = prompt('Nome do novo perfil: (ex: JoÃ£o)');
  if (!name) return;
  const gender = prompt('GÃªnero (male/female):', 'male') || 'male';
  const age = parseInt(prompt('Idade:', '25')) || 25;
  const height = parseInt(prompt('Altura em cm:', '170')) || 170;
  const idBase = name.trim().toLowerCase().replace(/\s+/g, '_');
  const id = `${idBase}_${Date.now()}`;
  const user = {
    id,
    name,
    gender: gender === 'female' ? 'female' : 'male',
    age,
    height,
    workoutHistory: [],
    mealHistory: [],
    bodyMetrics: [{
      id: 'm_' + Date.now(),
      date: new Date().toISOString().split('T')[0],
      weight: 0,
      bodyFat: 0,
      muscleMass: 0,
      visceralFat: 0,
      waterPercent: 0,
      waterWeight: 0,
      bmr: calculateBMR(0, height, age, gender),
      muscleSize: 0,
      bmi: 0
    }],
    goals: { weight: 0, bodyFat: 0, muscleMass: 0 },
    customPrograms: {}
  };
  addOrUpdateUser(user);
  alert('âœ… Perfil criado: ' + name);
}

/* Soft-delete profile (moves to archive), never removes without explicit user's permanent deletion action */
function handleDeleteProfile(userId) {
  if (!confirm('Deseja mover este perfil para archive (preservarÃ¡ TODOS os registros)?')) return;
  const user = state.users[userId];
  if (!user) return alert('Perfil nÃ£o encontrado');
  archiveItem(STORE_USERS, userId, 'user', user).then(() => {
    delete state.users[userId];
    try { dbDelete(STORE_USERS, userId).catch(()=>{}); } catch(e){}
    saveLS('ft_users', state.users);
    updateState({ users: state.users });
    alert('âœ… Perfil movido para archive. Para excluir permanentemente vÃ¡ no archive e remova manualmente.');
  });
}

/* ----------------------------- Templates application & custom programs ----------------------------- */
function applyTemplateToUser(templateId, userId) {
  const tmpl = templates[templateId];
  if (!tmpl) return alert('Template nÃ£o encontrado');
  const user = state.users[userId];
  if (!user) return alert('UsuÃ¡rio nÃ£o encontrado');
  user.customPrograms = user.customPrograms || {};
  user.customPrograms[tmpl.id] = JSON.parse(JSON.stringify(tmpl)); // deep copy
  addOrUpdateUser(user);
  alert(`âœ… Template "${tmpl.name}" aplicado e salvo no perfil ${user.name}.`);
}

function removeUserProgram(userId, programId) {
  const user = state.users[userId];
  if (!user || !user.customPrograms) return;
  if (!confirm('Remover este programa do perfil? (nÃ£o exclui do archive)')) return;
  delete user.customPrograms[programId];
  addOrUpdateUser(user);
  alert('âœ… Programa removido do perfil.');
}

/* ----------------------------- References import / export / clear ----------------------------- */
function importScientificStudiesSeed() {
  const idsExisting = new Set(state.references.map(r => r.id));
  let added = 0;
  scientificStudiesSeed.forEach(ref => {
    if (!idsExisting.has(ref.id)) {
      state.references.push(ref);
      added++;
    }
  });
  if (added > 0) {
    saveAllToDB();
    alert(`âœ… Importados ${added} estudos (2020 â†’ 2025-11).`);
  } else {
    alert('â„¹ï¸ Estudos jÃ¡ importados anteriormente.');
  }
  render();
}

function exportReferencesJSON() {
  const dataStr = JSON.stringify(state.references, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `studies_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function clearReferences() {
  if (!confirm('Deseja mover todas as referÃªncias para archive? Elas ficarÃ£o preservadas em archive.')) return;
  // move each to archive
  Promise.all(state.references.map(r => archiveItem(STORE_REFERENCES, r.id, 'reference', r))).then(() => {
    state.references = [];
    saveAllToDB();
    alert('âœ… ReferÃªncias movidas para archive.local');
    render();
  }).catch(err => alert('Erro ao mover referÃªncias para archive: ' + err));
}

/* ----------------------------- Export muscle evolution CSV ----------------------------- */
function exportMuscleEvolutionCSV(userId) {
  const user = state.users[userId];
  if (!user) return alert('UsuÃ¡rio nÃ£o encontrado');
  const rows = [['date','weight','bodyFat','muscleMass','muscleSize','waterWeight','bmr']];
  (user.bodyMetrics || []).forEach(m => {
    rows.push([m.date, m.weight, m.bodyFat, m.muscleMass, m.muscleSize, m.waterWeight, m.bmr]);
  });
  const csv = rows.map(r => r.map(cell => (typeof cell === 'string' && cell.includes(',')) ? `"${cell}"` : cell).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${userId}_muscle_evolution_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

/* ----------------------------- References helper for UI ----------------------------- */
function getReferencesByTags(tags) {
  if (!tags || !tags.length) return [];
  const refs = state.references || [];
  return refs.filter(r => r.tags && r.tags.some(t => tags.includes(t)));
}
function getTopReferencesByTags(tags, limit = 3) {
  const matched = getReferencesByTags(tags);
  matched.sort((a, b) => (b.year || 0) - (a.year || 0));
  return matched.slice(0, limit);
}
function renderReferenceLinksHTML(refs) {
  if (!refs || !refs.length) return '';
  return refs.map(r => `<a href="${r.link}" target="_blank" class="text-blue-300 underline">${r.authors} ${r.year}</a>`).join(' â€¢ ');
}
function buildReferenceNotesForWorkout(workoutName) {
  const name = (workoutName || '').toLowerCase();
  let tags = ['training'];
  if (name.includes('hip') || name.includes('glÃºteo') || name.includes('thrust')) tags.push('hypertrophy');
  if (name.includes('agach') || name.includes('leg')) tags.push('volume');
  if (name.includes('supino') || name.includes('press')) tags.push('strength');
  const refs = getTopReferencesByTags(tags);
  if (!refs.length) return '';
  return `Base cientÃ­fica: ${refs.slice(0,3).map(r => `${r.authors} ${r.year}`).join(' â€¢ ')}. ` + renderReferenceLinksHTML(refs);
}
function buildReferenceNotesForNutrition() {
  const refs = getTopReferencesByTags(['nutrition','protein','creatine','diet']);
  if (!refs.length) return '';
  return `ReferÃªncias: ${refs.slice(0,3).map(r => `${r.authors} ${r.year}`).join(' â€¢ ')}. ` + renderReferenceLinksHTML(refs);
}

/* ----------------------------- Event Delegation for Meal Buttons -----------------------------
   This function attaches event listeners to meal registration buttons using event delegation.
   This approach is more robust than inline onclick handlers and handles special characters properly.
------------------------------------------------------------------------------------------------ */
function attachMealButtons() {
  // Remove any existing listeners to avoid duplicates
  const mealButtons = document.querySelectorAll('.meal-register-btn');
  mealButtons.forEach(btn => {
    // Clone and replace to remove old listeners
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    
    // Add new listener
    newBtn.addEventListener('click', function(e) {
      e.preventDefault();
      const mealName = this.getAttribute('data-meal-name');
      if (mealName) {
        handleLogMeal(mealName);
      }
    });
  });
}

/* ----------------------------- RENDER (UI) -----------------------------
   The UI is intentionally verbose and explanatory to ensure clarity for you.
   Buttons that perform deletions will refer to archive workflow; nothing is removed
   permanently without explicit permanent-delete action in archive manager.
----------------------------------------------------------------------------- */

function render() {
  const app = document.getElementById('app');
  const currentUser = state.users[state.activeUser] || Object.values(state.users)[0];
  if (!currentUser) {
    app.innerHTML = '<div class="p-8 text-white">Carregando...</div>';
    return;
  }

  const workoutHistory = currentUser.workoutHistory || [];
  const mealHistory = currentUser.mealHistory || [];
  const bodyMetrics = currentUser.bodyMetrics || [];
  const latestMetrics = bodyMetrics[bodyMetrics.length - 1] || { weight: 0, bodyFat: 0, muscleMass: 0, bmi: 0, bmr: 0, waterPercent: 0, waterWeight: 0, muscleSize: 0 };

  // compute today's totals
  const today = new Date().toISOString().split('T')[0];
  const todaysMeals = mealHistory.filter(m => m.date === today);
  const totals = todaysMeals.reduce((acc, log) => {
    const nut = getMealNutritionByName(log.meal);
    acc.kcal += nut.kcal; acc.prot += nut.prot; acc.fat += nut.fat;
    return acc;
  }, { kcal: 0, prot: 0, fat: 0 });

  app.innerHTML = `
    <header class="bg-black/40 backdrop-blur-lg border-b border-purple-500/30 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">ğŸ’ª Fitness Tracker Pro â€” Full</h1>
          <p class="text-purple-300 text-sm mt-1">PersistÃªncia local (IndexedDB) â€” Archive-enabled â€” Never delete without explicit action</p>
        </div>
        <div class="flex gap-2 items-center">
          ${Object.keys(state.users).map(id => `
            <div class="flex items-center gap-2">
              <button onclick="state.activeUser='${id}'; render();" class="px-4 py-2 rounded-lg font-semibold ${state.activeUser === id ? (state.users[id].gender === 'female' ? 'bg-pink-500 text-white' : 'bg-blue-500 text-white') : 'bg-slate-700 text-slate-300'}">
                ${state.users[id].gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨'} ${state.users[id].name}
              </button>
              <button title="Mover perfil para archive" onclick="handleDeleteProfile('${id}')" class="text-red-400 hover:text-red-300 px-2">ğŸ—„ï¸</button>
            </div>
          `).join('')}
          <button onclick="handleAddProfile()" class="px-4 py-2 rounded-lg font-semibold bg-green-600 hover:bg-green-500">â• Novo Perfil</button>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="flex flex-wrap gap-3 mb-6">
        ${['dashboard','treino','nutricao','alimentacao','evolucao','comparacao','ciencia'].map(tab => `
          <button onclick="state.activeTab='${tab}'; render();" class="px-6 py-3 rounded-xl font-semibold ${state.activeTab === tab ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'bg-slate-800/50 text-slate-300'}">
            ${tab === 'dashboard' ? 'ğŸ“Š Dashboard' : tab === 'treino' ? 'ğŸ‹ï¸ Treinos' : tab === 'nutricao' ? 'ğŸ NutriÃ§Ã£o' : tab === 'alimentacao' ? 'ğŸ² AlimentaÃ§Ã£o' : tab === 'evolucao' ? 'ğŸ“ˆ EvoluÃ§Ã£o' : tab === 'comparacao' ? 'âš–ï¸ ComparaÃ§Ã£o' : 'ğŸ”¬ CiÃªncia'}
          </button>
        `).join('')}
      </div>

      <main>
        ${state.activeTab === 'dashboard' ? renderDashboard(currentUser, latestMetrics) : ''}
        ${state.activeTab === 'treino' ? renderTreino(currentUser) : ''}
        ${state.activeTab === 'nutricao' ? renderNutricao(currentUser) : ''}
        ${state.activeTab === 'alimentacao' ? renderAlimentacao(mealHistory, totals) : ''}
        ${state.activeTab === 'evolucao' ? renderEvolucao(bodyMetrics, currentUser) : ''}
        ${state.activeTab === 'comparacao' ? renderComparacao() : ''}
        ${state.activeTab === 'ciencia' ? renderCiencia() : ''}
      </main>
    </div>

    <footer class="bg-black/60 backdrop-blur-lg border-t border-purple-500/30 py-8 mt-12">
      <div class="max-w-7xl mx-auto px-4 text-center">
        <p class="text-slate-400">VersÃ£o completa: todas as marmitas restauradas; archive/soft-delete implementado; IndexedDB como DB local.</p>
      </div>
    </footer>
  `;

  // after injecting DOM, hook forms / draw chart if needed
  if (state.activeTab === 'evolucao') {
    renderMuscleEvolutionChart(bodyMetrics, currentUser.id);
  }

  // attach metric form listener if exists
  const metricsForm = document.getElementById('metricsForm');
  if (metricsForm) metricsForm.addEventListener('submit', handleAddMetrics);
  
  // attach custom meal form listener if in alimentacao tab
  if (state.activeTab === 'alimentacao') {
    const customMealForm = document.getElementById('customMealForm');
    if (customMealForm) customMealForm.addEventListener('submit', handleAddCustomMeal);
    
    // attach meal buttons using event delegation
    attachMealButtons();
  }
}

/* ----------------------------- SMALL RENDER COMPONENTS ----------------------------- */

function renderDashboard(user, latest) {
  const notes = buildReferenceNotesForNutrition();
  return `
    <div class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div class="md:col-span-2 bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl p-6 text-white shadow-xl">
          <p class="text-blue-200 text-sm mb-2">PESO ATUAL</p>
          <p class="text-4xl font-bold">${latest.weight} kg</p>
          <p class="text-blue-200 text-xs mt-2">Meta: ${user.goals.weight} kg</p>
        </div>
        <div class="bg-gradient-to-br from-red-600 to-red-800 rounded-2xl p-6">
          <p class="text-red-200 text-sm mb-2">GORDURA</p>
          <p class="text-4xl font-bold">${latest.bodyFat}%</p>
        </div>
        <div class="bg-gradient-to-br from-green-600 to-green-800 rounded-2xl p-6">
          <p class="text-green-200 text-sm mb-2">MASSA MUSCULAR</p>
          <p class="text-4xl font-bold">${latest.muscleMass} kg</p>
        </div>
        <div class="bg-gradient-to-br from-yellow-600 to-amber-700 rounded-2xl p-6">
          <p class="text-yellow-200 text-sm mb-2">METABOLISMO BASAL</p>
          <p class="text-2xl font-bold">${latest.bmr || '-' } kcal</p>
        </div>
        <div class="bg-gradient-to-br from-cyan-600 to-sky-700 rounded-2xl p-6">
          <p class="text-cyan-200 text-sm mb-2">ÃGUA</p>
          <p class="text-2xl font-bold">${latest.waterWeight || 0} kg (${latest.waterPercent || 0}%)</p>
        </div>
      </div>

      <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700">
        <h3 class="text-2xl font-bold mb-3">Notas cientÃ­ficas</h3>
        <p class="text-slate-300 text-sm">${notes || 'Importe referÃªncias na aba CIÃŠNCIA para ver notas cientÃ­ficas aplicadas.'}</p>
      </div>
    </div>
  `;
}

function renderTreino(user) {
  const templatesListHTML = Object.values(templates).map(t => `
    <div class="bg-slate-700 p-4 rounded mb-3">
      <p class="font-bold">${t.name}</p>
      <p class="text-slate-300 text-sm">${t.description}</p>
      <div class="mt-2 flex gap-2">
        <button onclick="applyTemplateToUser('${t.id}','${user.id}')" class="bg-green-600 px-3 py-1 rounded">Aplicar ao perfil</button>
      </div>
      <div class="mt-2 text-slate-300 text-sm">
        ${Object.keys(t.sessions).map(k=>`<strong>${k} â€” ${t.sessions[k].name}</strong><br/>${t.sessions[k].exercises.map(e=>`â€¢ ${e.name} ${e.sets?(' â€” ' + e.sets + ' x ' + e.reps):''}`).join('<br/>')}<br/><br/>`).join('')}
      </div>
    </div>
  `).join('');

  const customPrograms = user.customPrograms || {};
  const customHTML = Object.keys(customPrograms).length === 0 ? '<p class="text-slate-400">Nenhum programa salvo neste perfil.</p>' : Object.values(customPrograms).map(p => `
    <div class="bg-slate-700 p-3 rounded mb-2">
      <p class="font-bold">${p.name}</p><p class="text-slate-300 text-sm">${p.description || ''}</p>
      <div class="mt-2 flex gap-2"><button onclick="alert('Abrir programa salvo: editar em future UI')" class="bg-indigo-600 px-3 py-1 rounded">Ver</button><button onclick="removeUserProgram('${user.id}','${p.id}')" class="bg-red-500 px-3 py-1 rounded">Remover</button></div>
    </div>
  `).join('');

  return `
    <div class="grid md:grid-cols-2 gap-4 mb-6">
      <div class="bg-slate-800 p-4 rounded">
        <h3 class="font-bold mb-3">Templates de Treino (evidÃªncias)</h3>
        ${templatesListHTML}
      </div>
      <div class="bg-slate-800 p-4 rounded">
        <h3 class="font-bold mb-3">Programas salvos no perfil (${Object.keys(customPrograms).length})</h3>
        ${customHTML}
      </div>
    </div>
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold">ObservaÃ§Ãµes prÃ¡ticas</h3>
      <p class="text-slate-300 text-sm">Aplique o template desejado e o mesmo serÃ¡ salvo diretamente no perfil (IndexedDB). Os programas salvos nunca sÃ£o excluÃ­dos sem mover para archive.</p>
    </div>
  `;
}

function renderNutricao(user) {
  const notes = buildReferenceNotesForNutrition();
  return `
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold">Plano nutricional (estimativa)</h3>
      <p class="text-slate-300 text-sm">${notes || 'Importe referÃªncias na aba CIÃŠNCIA para ver recomendaÃ§Ãµes.'}</p>
      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <div class="bg-white/10 p-3 rounded"><p class="text-sm">Meta CalÃ³rica</p><p class="text-xl font-bold">${user.gender === 'male' ? 2000 : 1700} kcal</p></div>
        <div class="bg-white/10 p-3 rounded"><p class="text-sm">ProteÃ­na</p><p class="text-xl font-bold">${user.gender === 'male' ? '140-160g' : '95-105g'}</p></div>
        <div class="bg-white/10 p-3 rounded"><p class="text-sm">SuperÃ¡vit</p><p class="text-xl font-bold">+${user.gender === 'male' ? 400 : 300} kcal</p></div>
      </div>
      <div class="mt-3 text-slate-300 text-sm">RecomendaÃ§Ãµes: priorizar ingestÃ£o proteica total diÃ¡ria e fracionamento; consider creatina 3â€“5 g/dia conforme tolerÃ¢ncia. Ajustar calorias conforme monitoramento.</div>
    </div>
  `;
}

function renderAlimentacao(meals, totals) {
  const currentUser = state.users[state.activeUser];
  const mealHistory = currentUser.mealHistory || [];
  
  // Filter meals for the selected day
  const selectedDayMeals = mealHistory.filter(m => m.date === state.currentDay);
  
  // Calculate totals for the selected day
  const dayTotals = selectedDayMeals.reduce((acc, log) => {
    const nut = getMealNutritionByNameCombined(log.meal);
    acc.kcal += nut.kcal; 
    acc.prot += nut.prot; 
    acc.fat += nut.fat;
    return acc;
  }, { kcal: 0, prot: 0, fat: 0 });
  
  // Format date for display
  const displayDate = new Date(state.currentDay + 'T00:00:00');
  const isToday = state.currentDay === new Date().toISOString().split('T')[0];
  const dateLabel = isToday ? 'Hoje' : displayDate.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'short' });
  
  return `
    <!-- Day Navigation -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <div class="flex justify-between items-center">
        <button onclick="goToPreviousDay()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded">â† Dia Anterior</button>
        <div class="text-center">
          <p class="text-lg font-bold">${dateLabel}</p>
          <p class="text-sm text-slate-300">${state.currentDay}</p>
        </div>
        <button onclick="goToNextDay()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded">PrÃ³ximo Dia â†’</button>
      </div>
      ${!isToday ? `<div class="mt-2 text-center"><button onclick="goToToday()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-sm">Ir para Hoje</button></div>` : ''}
    </div>

    <!-- Day Totals -->
    <div class="bg-gradient-to-r from-green-600 to-green-800 p-4 rounded mb-6">
      <h4 class="font-bold text-lg">Totais de ${dateLabel}</h4>
      <p class="text-white text-xl">${Math.round(dayTotals.kcal)} kcal â€¢ ${Math.round(dayTotals.prot)} g proteÃ­na â€¢ ${Math.round(dayTotals.fat)} g gord.</p>
    </div>

    <!-- Custom Meal Form -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold mb-3">â• Adicionar RefeiÃ§Ã£o Personalizada</h3>
      <form id="customMealForm" class="grid md:grid-cols-5 gap-2">
        <input type="text" name="customMealName" placeholder="Nome da refeiÃ§Ã£o" required class="px-3 py-2 rounded bg-slate-700 text-white" />
        <input type="number" name="customMealKcal" step="0.1" placeholder="Calorias (kcal)" required class="px-3 py-2 rounded bg-slate-700 text-white" />
        <input type="number" name="customMealProt" step="0.1" placeholder="ProteÃ­na (g)" class="px-3 py-2 rounded bg-slate-700 text-white" />
        <input type="number" name="customMealFat" step="0.1" placeholder="Gordura (g)" class="px-3 py-2 rounded bg-slate-700 text-white" />
        <div class="flex flex-col gap-2">
          <label class="flex items-center gap-2 text-sm text-slate-300">
            <input type="checkbox" name="saveAsReusable" class="rounded" />
            Salvar como reutilizÃ¡vel
          </label>
          <button type="submit" class="bg-green-600 hover:bg-green-500 px-3 py-2 rounded font-semibold">Adicionar</button>
        </div>
      </form>
      <p class="text-slate-400 text-xs mt-2">A refeiÃ§Ã£o serÃ¡ registrada para ${dateLabel}. Marque "Salvar como reutilizÃ¡vel" para adicionÃ¡-la Ã  lista abaixo.</p>
    </div>

    <!-- Custom Meals List -->
    ${state.customMeals.length > 0 ? `
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold mb-3">ğŸ½ï¸ Minhas RefeiÃ§Ãµes Personalizadas</h3>
      <div class="grid md:grid-cols-2 gap-3">
        ${state.customMeals.map(m => `
          <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
            <div>
              <p class="font-semibold">${m.name}</p>
              <p class="text-slate-300 text-xs">${m.kcal} kcal â€¢ ${m.prot}g prot â€¢ ${m.fat}g gord</p>
            </div>
            <div class="flex gap-2">
              <button data-meal-name="${m.name.replace(/"/g, '&quot;')}" class="meal-register-btn bg-orange-500 hover:bg-orange-400 px-3 py-1 rounded">Registrar</button>
              <button onclick="handleDeleteCustomMeal('${m.id}')" class="text-red-400 hover:text-red-300 px-2">ğŸ—‘ï¸</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
    ` : ''}

    <!-- LiveUp Marmitas -->
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold mb-3">ğŸ± Marmitas LiveUp (DisponÃ­veis)</h3>
      <div class="grid md:grid-cols-2 gap-3">
        ${livUpMarmitas.map(m => `
          <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
            <div>
              <p class="font-semibold">${m.name}</p>
              <p class="text-slate-300 text-xs">${m.category} â€¢ ${m.size}${m.kcal ? ' â€¢ ' + m.kcal + ' kcal' : ''}${m.notes ? ' â€¢ ' + m.notes : ''}</p>
            </div>
            <div>
              <button data-meal-name="${m.name.replace(/"/g, '&quot;')}" class="meal-register-btn bg-orange-500 hover:bg-orange-400 px-3 py-1 rounded">Registrar</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>

    <!-- Meal History for Selected Day -->
    <div class="bg-slate-800 p-4 rounded">
      <h3 class="font-bold mb-3">ğŸ“‹ HistÃ³rico de ${dateLabel}</h3>
      ${selectedDayMeals.length === 0 ? 
        '<p class="text-slate-400">Nenhuma refeiÃ§Ã£o registrada neste dia.</p>' :
        `<div class="space-y-2">
          ${selectedDayMeals.map(log => {
            const nut = getMealNutritionByNameCombined(log.meal);
            return `
              <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
                <div>
                  <p class="font-semibold">${log.meal}</p>
                  <p class="text-slate-300 text-xs">${log.time} â€¢ ${nut.kcal} kcal â€¢ ${nut.prot}g prot â€¢ ${nut.fat}g gord</p>
                </div>
                <button onclick="handleDeleteMeal(${log.id})" class="text-red-400 hover:text-red-300">ğŸ—‘ï¸</button>
              </div>
            `;
          }).join('')}
        </div>`
      }
    </div>
  `;
}

function renderEvolucao(bodyMetrics, user) {
  return `
    <div class="bg-slate-800 p-4 rounded mb-6">
      <h3 class="font-bold">Adicionar Medidas</h3>
      <form id="metricsForm" class="grid md:grid-cols-8 gap-2 mt-3">
        <input type="date" name="date" value="${new Date().toISOString().split('T')[0]}" required class="px-2 py-2 rounded bg-slate-700"/>
        <input type="number" name="weight" step="0.1" required placeholder="Peso (kg)" class="px-2 py-2 rounded bg-slate-700"/>
        <input type="number" name="bodyFat" step="0.1" required placeholder="Gordura (%)" class="px-2 py-2 rounded bg-slate-700"/>
        <input type="number" name="muscleMass" step="0.1" required placeholder="Massa muscular (kg)" class="px-2 py-2 rounded bg-slate-700"/>
        <input type="number" name="visceralFat" placeholder="G.Visceral" class="px-2 py-2 rounded bg-slate-700"/>
        <input type="number" name="waterPercent" step="0.1" placeholder="Ãgua (%)" class="px-2 py-2 rounded bg-slate-700"/>
        <input type="number" name="muscleSize" step="0.1" placeholder="Tamanho mÃºsculo (cm)" class="px-2 py-2 rounded bg-slate-700"/>
        <button type="submit" class="bg-purple-600 px-3 py-2 rounded">â• Adicionar</button>
      </form>
    </div>

    <div class="bg-slate-800 p-4 rounded mb-6">
      <div class="flex gap-3 items-start">
        <div style="flex:1;">
          <canvas id="muscleChart" height="160"></canvas>
        </div>
        <div style="width: 180px;" class="flex flex-col gap-2">
          <button onclick="exportMuscleEvolutionCSV('${user.id}')" class="bg-blue-600 px-3 py-2 rounded">Exportar CSV</button>
          <button onclick="alert('Backup (full DB export) em breve')" class="bg-amber-600 px-3 py-2 rounded">Backup / Exportar DB</button>
          <div class="text-slate-300 text-sm mt-2">GrÃ¡fico: massa (kg) e tamanho (cm). Ao adicionar nova medida o grÃ¡fico redesenha automaticamente.</div>
        </div>
      </div>

      <div class="overflow-x-auto mt-4">
        <table class="w-full text-sm">
          <thead><tr class="border-b"><th>Data</th><th>Peso</th><th>Gordura</th><th>Massa</th><th>IMC</th><th>Ãgua</th><th>BMR</th><th>Tamanho</th><th>AÃ§Ãµes</th></tr></thead>
          <tbody>
            ${bodyMetrics.slice().reverse().map(m => `
              <tr class="border-b">
                <td class="py-1 px-2">${m.date}</td>
                <td class="py-1 px-2">${m.weight}kg</td>
                <td class="py-1 px-2">${m.bodyFat}%</td>
                <td class="py-1 px-2">${m.muscleMass}kg</td>
                <td class="py-1 px-2">${m.bmi}</td>
                <td class="py-1 px-2">${m.waterWeight || 0}kg / ${m.waterPercent || 0}%</td>
                <td class="py-1 px-2">${m.bmr || '-'}</td>
                <td class="py-1 px-2">${m.muscleSize || '-'}</td>
                <td class="py-1 px-2"><button onclick="handleDeleteMetric('${m.id}')" class="text-red-400">ğŸ—„ï¸</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function renderComparacao() {
  const comps = state.comparisons || [];
  return `
    <div class="bg-slate-800 p-4 rounded">
      <h3 class="font-bold">ComparaÃ§Ãµes</h3>
      ${comps.length === 0 ? '<p class="text-slate-400">Nenhuma comparaÃ§Ã£o criada.</p>' : comps.map(c => `
        <div class="bg-slate-700 p-3 rounded mb-2">
          <p class="font-bold">${c.title}</p>
          <p class="text-slate-300 text-xs">Criado ${new Date(c.createdAt).toLocaleString()}</p>
          <div class="mt-2 flex gap-2"><button onclick="handleDeleteComparison('${c.id}')" class="bg-red-500 px-3 py-1 rounded">Remover</button></div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderCiencia() {
  const filtered = (state.references || []).filter(r => r.year >= 2020 && r.year <= 2025);
  return `
    <div class="bg-slate-800 p-4 rounded">
      <div class="flex justify-between items-center">
        <h3 class="font-bold">Estudos cientÃ­ficos (2020 â†’ 2025-11)</h3>
        <div class="flex gap-2">
          <button onclick="importScientificStudiesSeed()" class="bg-green-600 px-3 py-1 rounded">â¤“ Importar estudos</button>
          <button onclick="exportReferencesJSON()" class="bg-blue-600 px-3 py-1 rounded">â¬‡ï¸ Exportar JSON</button>
          <button onclick="clearReferences()" class="bg-red-600 px-3 py-1 rounded">ğŸ—„ï¸ Mover p/ archive</button>
        </div>
      </div>

      <div class="mt-4">
        ${filtered.length === 0 ? '<p class="text-slate-400">Nenhuma referÃªncia importada. Use o botÃ£o importar.</p>' : filtered.map(ref => `
          <div class="bg-slate-700 p-3 rounded mb-3">
            <p class="font-bold">${ref.title}</p>
            <p class="text-slate-300 text-xs">${ref.authors} â€” ${ref.year} â€¢ ${ref.journal}</p>
            <p class="text-slate-400 text-sm mt-2">${ref.summary || ''}</p>
            <p class="mt-2"><a href="${ref.link}" target="_blank" class="text-blue-300 underline">Abrir estudo / DOI</a></p>
            <div class="mt-2 flex gap-2">
              <button onclick="navigator.clipboard.writeText('${ref.link}').then(()=>alert('Link copiado'))" class="bg-white text-black px-2 py-1 rounded">Copiar link</button>
              <button onclick="if(confirm('Mover esta referÃªncia para archive?')) { archiveItem('references','${ref.id}','reference', ${JSON.stringify(ref).replace(/'/g, "\\'")}).then(()=>{ state.references = state.references.filter(r=>r.id!=='${ref.id}'); saveAllToDB(); render(); alert('Movido para archive') }) }" class="text-red-400">Arquivar</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

/* ----------------------------- Chart rendering ----------------------------- */
function renderMuscleEvolutionChart(bodyMetrics, userId) {
  const canvas = document.getElementById('muscleChart');
  if (!canvas) return;
  const metrics = (bodyMetrics || []).slice().sort((a,b) => new Date(a.date) - new Date(b.date));
  const labels = metrics.map(m => m.date);
  const muscleMassData = metrics.map(m => m.muscleMass || null);
  const muscleSizeData = metrics.map(m => m.muscleSize || null);
  const datasets = [];
  if (muscleMassData.some(v => v !== null)) datasets.push({ label: 'Massa Muscular (kg)', data: muscleMassData, borderColor: '#34D399', backgroundColor: '#34D39933', tension: 0.2, yAxisID: 'y' });
  if (muscleSizeData.some(v => v !== null)) datasets.push({ label: 'Tamanho MÃºsculo (cm)', data: muscleSizeData, borderColor: '#60A5FA', backgroundColor: '#60A5FA33', tension: 0.2, yAxisID: 'y2' });
  const config = {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      scales: {
        y: { beginAtZero: false, title: { display: true, text: 'kg' } },
        y2: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'cm' } }
      }
    }
  };
  if (muscleChart) { muscleChart.destroy(); muscleChart = null; }
  muscleChart = new Chart(canvas, config);
}

/* ----------------------------- Init and safety ----------------------------- */
window.addEventListener('beforeunload', () => { try { saveAllToDB(); } catch (e) { } });

(async function initApp() {
  await loadAllFromDB();
  await loadCustomMeals(); // Load custom meals from IndexedDB/localStorage
  
  // Ensure default users exist (do not overwrite)
  if (!state.users.pedro) state.users.pedro = initialUsers.pedro;
  if (!state.users.valentina) state.users.valentina = initialUsers.valentina;
  // Import marmitas list to a settings key for future UI if desired
  const s = await dbGet(STORE_SETTINGS, 'marmitas_seed_loaded').catch(()=>null);
  if (!s) {
    // store marmitas in settings for reference (not required, but keeps record)
    await dbPut(STORE_SETTINGS, { key: 'marmitas_seed_loaded', value: new Date().toISOString() });
  }
  await saveAllToDB();
  render();
})();
</script>

</body>
</html>

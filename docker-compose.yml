version: '3.8'

services:
  # Main web application with nginx
  web:
    build: .
    container_name: pilgrim-fitness-tracker
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Mount custom nginx config for production
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # Mount Let's Encrypt certificates (update path as needed)
      - ./certs:/etc/letsencrypt:ro
      # Mount certbot challenge directory
      - ./certbot-challenge:/var/www/certbot:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - app-network

  # Certbot for Let's Encrypt certificate generation/renewal
  certbot:
    image: certbot/certbot:latest
    container_name: pilgrim-certbot
    volumes:
      - ./certs:/etc/letsencrypt
      - ./certbot-challenge:/var/www/certbot
    command: certonly --webroot --webroot-path=/var/www/certbot --email your-email@example.com --agree-tos --no-eff-email -d your-domain.com -d www.your-domain.com
    depends_on:
      - web
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

# Note: For production use, update the following:
# 1. Replace 'your-email@example.com' with your actual email
# 2. Replace 'your-domain.com' with your actual domain
# 3. Update nginx.conf SSL certificate paths to match mounted volumes
# 4. Run certbot service first to generate certificates
# 5. Set up cron job for certificate renewal:
#    docker-compose run --rm certbot renew

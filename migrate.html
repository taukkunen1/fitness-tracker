<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Migration Tool - Pilgrim Fitness Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-screen p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-4xl font-bold mb-8">üîÑ Data Migration Tool</h1>
    
    <div class="bg-slate-800 rounded-lg p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-4">Step 1: Configure Backend URL</h2>
      <input 
        type="text" 
        id="apiUrl" 
        value="http://localhost:3000"
        class="w-full px-4 py-2 rounded bg-slate-700 border border-slate-600 text-white"
        placeholder="Backend API URL"
      />
      <p class="text-sm text-slate-400 mt-2">Enter your backend API URL (default: http://localhost:3000)</p>
    </div>

    <div class="bg-slate-800 rounded-lg p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-4">Step 2: Login Credentials</h2>
      <div class="space-y-4">
        <input 
          type="text" 
          id="username" 
          class="w-full px-4 py-2 rounded bg-slate-700 border border-slate-600 text-white"
          placeholder="Username"
        />
        <input 
          type="password" 
          id="password" 
          class="w-full px-4 py-2 rounded bg-slate-700 border border-slate-600 text-white"
          placeholder="Password"
        />
        <button 
          onclick="loginToBackend()"
          class="w-full bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded font-semibold"
        >
          Login to Backend
        </button>
      </div>
      <div id="loginStatus" class="mt-4"></div>
    </div>

    <div class="bg-slate-800 rounded-lg p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-4">Step 3: Export from IndexedDB</h2>
      <button 
        onclick="exportFromIndexedDB()"
        class="w-full bg-green-600 hover:bg-green-700 px-6 py-3 rounded font-semibold"
      >
        Export All Data
      </button>
      <div id="exportStatus" class="mt-4"></div>
    </div>

    <div class="bg-slate-800 rounded-lg p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-4">Step 4: Migrate to Backend</h2>
      <button 
        onclick="migrateToBackend()"
        class="w-full bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded font-semibold"
        disabled
        id="migrateBtn"
      >
        Migrate Data to Backend
      </button>
      <div id="migrateStatus" class="mt-4"></div>
    </div>

    <div class="bg-yellow-900/30 border border-yellow-600 rounded-lg p-4">
      <h3 class="font-semibold mb-2">‚ö†Ô∏è Important Notes:</h3>
      <ul class="list-disc list-inside space-y-1 text-sm">
        <li>Make sure your backend is running before migration</li>
        <li>Create a backup of your data first</li>
        <li>This will create new entries in the backend database</li>
        <li>User accounts need to be registered first</li>
        <li>Progress photos need to be re-uploaded manually</li>
      </ul>
    </div>
  </div>

  <script src="js/api-client.js"></script>
  <script>
    let api;
    let exportedData = {};
    let token = null;

    async function loginToBackend() {
      const apiUrl = document.getElementById('apiUrl').value;
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const statusDiv = document.getElementById('loginStatus');

      if (!username || !password) {
        statusDiv.innerHTML = '<p class="text-red-400">Please enter username and password</p>';
        return;
      }

      try {
        statusDiv.innerHTML = '<p class="text-blue-400">Logging in...</p>';
        api = new FitnessTrackerAPI(apiUrl);
        const response = await api.login(username, password);
        token = response.token;
        
        statusDiv.innerHTML = `<p class="text-green-400">‚úÖ Logged in successfully as ${response.user.username}</p>`;
        document.getElementById('migrateBtn').disabled = false;
      } catch (error) {
        statusDiv.innerHTML = `<p class="text-red-400">‚ùå Login failed: ${error.message}</p>`;
      }
    }

    async function exportFromIndexedDB() {
      const statusDiv = document.getElementById('exportStatus');
      statusDiv.innerHTML = '<p class="text-blue-400">Exporting data from IndexedDB...</p>';

      try {
        // Open IndexedDB
        const db = await openIndexedDB();
        
        // Export all stores
        const stores = ['users', 'comparisons', 'references', 'settings'];
        let exportLog = [];

        for (const storeName of stores) {
          const data = await getAllFromStore(db, storeName);
          exportedData[storeName] = data;
          exportLog.push(`${storeName}: ${data.length} records`);
        }

        statusDiv.innerHTML = `
          <p class="text-green-400">‚úÖ Export completed:</p>
          <ul class="list-disc list-inside text-sm mt-2">
            ${exportLog.map(log => `<li>${log}</li>`).join('')}
          </ul>
        `;

        // Enable migration button if logged in
        if (token) {
          document.getElementById('migrateBtn').disabled = false;
        }
      } catch (error) {
        statusDiv.innerHTML = `<p class="text-red-400">‚ùå Export failed: ${error.message}</p>`;
      }
    }

    async function migrateToBackend() {
      if (!api || !token) {
        alert('Please login to backend first');
        return;
      }

      if (!exportedData || Object.keys(exportedData).length === 0) {
        alert('Please export data first');
        return;
      }

      const statusDiv = document.getElementById('migrateStatus');
      statusDiv.innerHTML = '<p class="text-blue-400">Starting migration...</p>';

      try {
        let migrateLog = [];

        // Note: This is a simplified migration
        // In production, you would need to handle data transformation
        // and map IndexedDB structure to backend models

        statusDiv.innerHTML = `
          <p class="text-yellow-400">‚ö†Ô∏è Automatic migration is not fully implemented.</p>
          <p class="text-slate-300 mt-2">Please use the backend API to manually create records.</p>
          <p class="text-slate-300 mt-2">Exported data structure:</p>
          <pre class="bg-slate-900 p-4 rounded mt-2 text-xs overflow-auto max-h-96">${JSON.stringify(exportedData, null, 2)}</pre>
          <button 
            onclick="downloadExportedData()"
            class="mt-4 bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded font-semibold"
          >
            Download Exported Data
          </button>
        `;

      } catch (error) {
        statusDiv.innerHTML = `<p class="text-red-400">‚ùå Migration failed: ${error.message}</p>`;
      }
    }

    function downloadExportedData() {
      const dataStr = JSON.stringify(exportedData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `fitness-tracker-export-${Date.now()}.json`;
      link.click();
      URL.revokeObjectURL(url);
    }

    function openIndexedDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('fitness-tracker-db', 6);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
      });
    }

    function getAllFromStore(db, storeName) {
      return new Promise((resolve, reject) => {
        try {
          const transaction = db.transaction(storeName, 'readonly');
          const store = transaction.objectStore(storeName);
          const request = store.getAll();
          
          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve(request.result || []);
        } catch (error) {
          resolve([]); // Store might not exist
        }
      });
    }
  </script>
</body>
</html>

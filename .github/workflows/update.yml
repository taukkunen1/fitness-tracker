name: Update - Auto Changelog and Task Generator

on:
  workflow_dispatch:
    inputs:
      agent_summary:
        description: 'Summary of work completed by agent'
        required: true
        type: string
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'
      generate_tasks:
        description: 'Generate new task suggestions'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  update-project:
    name: Update Project Documentation and Tasks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get current version
        id: current_version
        run: |
          # Extract current version from VERSION.md
          CURRENT_VERSION=$(grep -oP 'VersÃ£o Atual: \K[0-9]+\.[0-9]+\.[0-9]+' VERSION.md || echo "2.0.0")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: new_version
        run: |
          VERSION="${{ steps.current_version.outputs.version }}"
          IFS='.' read -r major minor patch <<< "$VERSION"
          
          case "${{ github.event.inputs.version_bump }}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac
          
          NEW_VERSION="${major}.${minor}.${patch}"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Get commit history since last update
        id: commits
        run: |
          # Get commits since last version tag or last 10 commits
          COMMITS=$(git log --oneline -10 --pretty=format:"- %s (%h)" || echo "- No recent commits")
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG.md
        run: |
          CURRENT_DATE=$(date '+%Y-%m-%d')
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          AGENT_SUMMARY="${{ github.event.inputs.agent_summary }}"
          VERSION_TYPE="${{ github.event.inputs.version_bump }}"
          
          # Create temporary file with new entry
          cat > /tmp/new_entry.md <<EOF
          
## [$NEW_VERSION] - $CURRENT_DATE

### ðŸ¤– AtualizaÃ§Ã£o AutomÃ¡tica - Agent Update

**Tipo de AtualizaÃ§Ã£o:** $(echo $VERSION_TYPE | tr '[:lower:]' '[:upper:]')

**Resumo das MudanÃ§as:**
$AGENT_SUMMARY

### ðŸ“ Commits IncluÃ­dos
${{ steps.commits.outputs.commits }}

### âœ¨ Melhorias e CorreÃ§Ãµes
- DocumentaÃ§Ã£o atualizada automaticamente
- Changelog atualizado com novas mudanÃ§as
- VersÃ£o incrementada seguindo Semantic Versioning

EOF
          
          # Insert new entry after line 8 (after the header)
          sed -i '8r /tmp/new_entry.md' CHANGELOG.md
          
          echo "âœ… CHANGELOG.md updated with version $NEW_VERSION"

      - name: Update VERSION.md
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          CURRENT_DATE=$(date '+%d de %B de %Y' | sed 's/January/Janeiro/g;s/February/Fevereiro/g;s/March/MarÃ§o/g;s/April/Abril/g;s/May/Maio/g;s/June/Junho/g;s/July/Julho/g;s/August/Agosto/g;s/September/Setembro/g;s/October/Outubro/g;s/November/Novembro/g;s/December/Dezembro/g')
          
          # Update version number
          sed -i "s/VersÃ£o Atual: [0-9]\+\.[0-9]\+\.[0-9]\+/VersÃ£o Atual: $NEW_VERSION/" VERSION.md
          
          # Update release date
          sed -i "s/Data de LanÃ§amento:.*/Data de LanÃ§amento: $CURRENT_DATE/" VERSION.md
          
          # Update last update date at bottom
          sed -i "s/Ãšltima atualizaÃ§Ã£o:.*/Ãšltima atualizaÃ§Ã£o: $CURRENT_DATE/" VERSION.md
          
          echo "âœ… VERSION.md updated to version $NEW_VERSION"

      - name: Update README.md version badge
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          sed -i "s/version-[0-9]\+\.[0-9]\+\.[0-9]\+-blue/version-$NEW_VERSION-blue/" README.md
          echo "âœ… README.md version badge updated"

      - name: Generate task suggestions
        if: github.event.inputs.generate_tasks == 'true'
        run: |
          CURRENT_DATE=$(date '+%Y-%m-%d')
          
          cat > /tmp/task_suggestions.md <<'EOF'
# ðŸ“‹ SugestÃµes de Tarefas - AtualizaÃ§Ã£o AutomÃ¡tica

**Data de GeraÃ§Ã£o:** $CURRENT_DATE
**VersÃ£o:** ${{ steps.new_version.outputs.version }}

## ðŸŽ¯ AnÃ¡lise Competitiva - Sites de Fitness

### ReferÃªncias Analisadas:
1. **MyFitnessPal** - LÃ­der em tracking de nutriÃ§Ã£o e exercÃ­cios
2. **Strava** - Focado em corrida e ciclismo com comunidade forte
3. **Fitbit App** - IntegraÃ§Ã£o com wearables e mÃ©tricas de saÃºde
4. **Strong** - App focado em treino de forÃ§a
5. **Cronometer** - Tracking nutricional detalhado

## ðŸ“Š Curto Prazo (1-2 meses)

### Prioridade Alta
- [ ] **PWA Completo**: Implementar Progressive Web App para funcionar offline
  - Baseado em: MyFitnessPal, Fitbit
  - Impacto: Alto - permite instalaÃ§Ã£o no dispositivo
  - EsforÃ§o: MÃ©dio
  
- [ ] **Dark Mode**: Adicionar tema escuro para melhor experiÃªncia noturna
  - Baseado em: Todos os principais apps
  - Impacto: MÃ©dio - melhora experiÃªncia do usuÃ¡rio
  - EsforÃ§o: Baixo

- [ ] **Export/Import Aprimorado**: MÃºltiplos formatos (CSV, PDF, Excel)
  - Baseado em: MyFitnessPal, Cronometer
  - Impacto: Alto - dados portÃ¡veis
  - EsforÃ§o: MÃ©dio

- [ ] **NotificaÃ§Ãµes Push**: Lembretes de treino, refeiÃ§Ãµes e hidrataÃ§Ã£o
  - Baseado em: MyFitnessPal, Fitbit
  - Impacto: Alto - engajamento do usuÃ¡rio
  - EsforÃ§o: MÃ©dio

### Prioridade MÃ©dia
- [ ] **GrÃ¡ficos AvanÃ§ados**: Mais opÃ§Ãµes de visualizaÃ§Ã£o de progresso
  - Baseado em: Strava, Fitbit
  - Impacto: MÃ©dio
  - EsforÃ§o: MÃ©dio

- [ ] **Calculadoras**: TDEE, macros, 1RM, percentual de gordura
  - Baseado em: MyFitnessPal, Strong
  - Impacto: Alto - valor agregado
  - EsforÃ§o: Baixo

- [ ] **Templates Personalizados**: Criar e salvar treinos customizados
  - Baseado em: Strong, Fitbit
  - Impacto: Alto
  - EsforÃ§o: MÃ©dio

## ðŸš€ MÃ©dio Prazo (3-6 meses)

### Prioridade Alta
- [ ] **IntegraÃ§Ã£o com Wearables**: Apple Health, Google Fit, Fitbit
  - Baseado em: MyFitnessPal, Strava
  - Impacto: Muito Alto - sincronizaÃ§Ã£o automÃ¡tica
  - EsforÃ§o: Alto

- [ ] **IA para SugestÃµes**: RecomendaÃ§Ãµes personalizadas de treino/dieta
  - Baseado em: Todos tÃªm alguma forma de recomendaÃ§Ã£o
  - Impacto: Muito Alto - diferencial competitivo
  - EsforÃ§o: Alto

- [ ] **Recursos Sociais**: Perfil pÃºblico, seguir amigos, compartilhar progresso
  - Baseado em: Strava, MyFitnessPal
  - Impacto: Alto - aumenta retenÃ§Ã£o
  - EsforÃ§o: Alto

- [ ] **Desafios e GamificaÃ§Ã£o**: Badges, conquistas, streaks
  - Baseado em: Strava, Fitbit
  - Impacto: Alto - motivaÃ§Ã£o e engajamento
  - EsforÃ§o: MÃ©dio

### Prioridade MÃ©dia
- [ ] **Biblioteca de ExercÃ­cios**: VÃ­deos e instruÃ§Ãµes detalhadas
  - Baseado em: Strong, Fitbit
  - Impacto: Alto - educacional
  - EsforÃ§o: Alto (conteÃºdo)

- [ ] **Planos de Treino Prontos**: Programas completos para diferentes objetivos
  - Baseado em: Strong, MyFitnessPal
  - Impacto: Alto
  - EsforÃ§o: MÃ©dio

- [ ] **Tracking de Ãgua**: Monitoramento de hidrataÃ§Ã£o
  - Baseado em: MyFitnessPal, Fitbit
  - Impacto: MÃ©dio
  - EsforÃ§o: Baixo

## ðŸŒŸ Longo Prazo (6-12 meses)

### Prioridade Alta
- [ ] **Backend e API**: SincronizaÃ§Ã£o em nuvem, multi-dispositivo
  - Baseado em: Todos os apps principais
  - Impacto: Muito Alto - escalabilidade
  - EsforÃ§o: Muito Alto

- [ ] **Apps Mobile Nativos**: iOS e Android
  - Baseado em: Mercado mobile-first
  - Impacto: Muito Alto - alcance
  - EsforÃ§o: Muito Alto

- [ ] **Marketplace de Treinos**: Treinadores podem vender planos
  - Baseado em: Modelo de monetizaÃ§Ã£o
  - Impacto: Muito Alto - receita
  - EsforÃ§o: Muito Alto

- [ ] **VersÃ£o Premium/Pro**: Recursos pagos para monetizaÃ§Ã£o
  - Baseado em: MyFitnessPal Premium, Strava Summit
  - Impacto: Muito Alto - sustentabilidade financeira
  - EsforÃ§o: MÃ©dio (infraestrutura de pagamento)

### Recursos Premium Sugeridos
1. **AnÃ¡lises AvanÃ§adas**: RelatÃ³rios detalhados, tendÃªncias, previsÃµes
2. **IA Personal Trainer**: Ajustes automÃ¡ticos baseados em progresso
3. **Planos Personalizados**: GeraÃ§Ã£o automÃ¡tica de treinos e dietas
4. **Suporte PrioritÃ¡rio**: Chat com especialistas
5. **ExportaÃ§Ã£o Profissional**: RelatÃ³rios em PDF personalizados
6. **Sem AnÃºncios**: ExperiÃªncia premium
7. **Armazenamento Ilimitado**: Fotos e dados ilimitados

### Infraestrutura para MonetizaÃ§Ã£o
- [ ] **Sistema de Pagamentos**: Stripe, PayPal
- [ ] **GestÃ£o de Assinaturas**: Planos mensais/anuais
- [ ] **Analytics AvanÃ§ado**: Para entender comportamento do usuÃ¡rio
- [ ] **A/B Testing**: Para otimizar conversÃ£o
- [ ] **Email Marketing**: Para retenÃ§Ã£o e upselling

## ðŸ’¡ Oportunidades de Mercado

### Nichos NÃ£o Explorados
1. **Treino para Idosos**: Interface simplificada, exercÃ­cios de baixo impacto
2. **Fisioterapia e ReabilitaÃ§Ã£o**: Tracking de recuperaÃ§Ã£o
3. **Atletas Profissionais**: MÃ©tricas avanÃ§adas, periodizaÃ§Ã£o
4. **Fitness Corporativo**: Planos para empresas
5. **NutriÃ§Ã£o Vegana/Vegetariana**: Tracking especÃ­fico de nutrientes

### Diferenciais Competitivos
- âœ… **Privacy-First**: Dados locais, sem venda de informaÃ§Ãµes
- âœ… **Open Source**: Comunidade pode contribuir
- âœ… **Baseado em CiÃªncia**: ReferÃªncias cientÃ­ficas
- ðŸŽ¯ **Sem AnÃºncios Intrusivos**: ExperiÃªncia limpa
- ðŸŽ¯ **AI Ã‰tico**: Sem manipulaÃ§Ã£o, foco em saÃºde real

## ðŸ“ˆ MÃ©tricas de Sucesso

### KPIs para Curto Prazo
- UsuÃ¡rios ativos diÃ¡rios (DAU)
- Taxa de retenÃ§Ã£o 30 dias
- Tempo mÃ©dio na plataforma
- NPS (Net Promoter Score)

### KPIs para MÃ©dio Prazo
- UsuÃ¡rios premium (% conversÃ£o)
- Lifetime Value (LTV)
- Custo de AquisiÃ§Ã£o (CAC)
- Churn rate

### KPIs para Longo Prazo
- Receita Recorrente Mensal (MRR)
- Taxa de crescimento mÃªs a mÃªs
- Market share no segmento
- AvaliaÃ§Ã£o de marca

## ðŸŽ¯ PrÃ³ximos Passos Imediatos

1. **Escolher 2-3 tarefas de curto prazo** e criar issues no GitHub
2. **Validar com usuÃ¡rios** quais features sÃ£o mais desejadas
3. **Priorizar baseado em impacto vs esforÃ§o**
4. **Iniciar desenvolvimento iterativo** com releases frequentes
5. **Coletar feedback continuamente** atravÃ©s do sistema de sugestÃµes

---

**Gerado automaticamente pela aÃ§Ã£o Update**
**Para sugerir modificaÃ§Ãµes, use o sistema de sugestÃµes no admin panel**
EOF
          
          # Replace date placeholder
          sed -i "s/\$CURRENT_DATE/$CURRENT_DATE/" /tmp/task_suggestions.md
          
          # Move to docs folder
          cp /tmp/task_suggestions.md "docs/TASK-SUGGESTIONS-$(date +%Y%m%d).md"
          
          echo "âœ… Task suggestions generated"

      - name: Create update summary
        id: summary
        run: |
          cat > /tmp/update_summary.md <<EOF
# ðŸš€ Update Summary

## Version Update
- **Previous Version:** ${{ steps.current_version.outputs.version }}
- **New Version:** ${{ steps.new_version.outputs.version }}
- **Update Type:** ${{ github.event.inputs.version_bump }}

## Agent Summary
${{ github.event.inputs.agent_summary }}

## Files Updated
- âœ… CHANGELOG.md - Added new version entry
- âœ… VERSION.md - Updated version and dates
- âœ… README.md - Updated version badge
EOF

          if [ "${{ github.event.inputs.generate_tasks }}" == "true" ]; then
            echo "- âœ… Task suggestions generated in docs/" >> /tmp/update_summary.md
          fi
          
          cat /tmp/update_summary.md

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add CHANGELOG.md VERSION.md README.md
          
          if [ "${{ github.event.inputs.generate_tasks }}" == "true" ]; then
            git add docs/TASK-SUGGESTIONS-*.md || true
          fi
          
          git commit -m "chore(release): version ${{ steps.new_version.outputs.version }} [auto-update]

${{ github.event.inputs.agent_summary }}

- Updated CHANGELOG.md
- Updated VERSION.md
- Updated README.md version badge
- Generated task suggestions" || echo "No changes to commit"
          
          git push origin ${{ github.ref_name }}

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.new_version.outputs.version }}';
            const agentSummary = `${{ github.event.inputs.agent_summary }}`;
            
            try {
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: `v${version}`,
                name: `Release v${version}`,
                body: `## ðŸ¤– Auto-generated Release\n\n${agentSummary}\n\n### Changes\nSee [CHANGELOG.md](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CHANGELOG.md) for details.`,
                draft: false,
                prerelease: false
              });
              console.log(`âœ… Release v${version} created`);
            } catch (error) {
              console.log(`Release creation failed (may already exist): ${error.message}`);
            }

      - name: Create summary
        run: |
          echo "## ðŸŽ‰ Update Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** ${{ steps.new_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VERSION.md" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… README.md" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.generate_tasks }}" == "true" ]; then
            echo "- âœ… Task suggestions generated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the updated CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
          echo "2. Check task suggestions in docs/" >> $GITHUB_STEP_SUMMARY
          echo "3. Create issues for priority tasks" >> $GITHUB_STEP_SUMMARY

      - name: Comment on related issues
        if: github.event.inputs.generate_tasks == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const message = `ðŸ¤– **Auto-Update Notification**\n\nA new version (**v${{ steps.new_version.outputs.version }}**) has been released!\n\n${{ github.event.inputs.agent_summary }}\n\nNew task suggestions have been generated. Check [\`docs/TASK-SUGGESTIONS-${new Date().toISOString().split('T')[0].replace(/-/g, '')}.md\`](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/main/docs) for details.`;
            
            // Find open issues with label "enhancement" and comment
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'enhancement',
              per_page: 5
            });
            
            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: message
              });
            }

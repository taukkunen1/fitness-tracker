name: Update - Auto Changelog and Task Generator

on:
  workflow_dispatch:
    inputs:
      agent_summary:
        description: 'Summary of work completed by agent'
        required: true
        type: string
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'

permissions:
  contents: write

jobs:
  update-project:
    name: Update Project Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(grep -oP 'VersÃ£o Atual: \K[0-9]+\.[0-9]+\.[0-9]+' VERSION.md || echo "2.0.0")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: new_version
        run: |
          VERSION="${{ steps.current_version.outputs.version }}"
          IFS='.' read -r major minor patch <<< "$VERSION"
          
          case "${{ github.event.inputs.version_bump }}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac
          
          NEW_VERSION="${major}.${minor}.${patch}"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Update VERSION.md
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          CURRENT_DATE=$(date '+%d de %B de %Y')
          
          sed -i "s/VersÃ£o Atual: [0-9]\+\.[0-9]\+\.[0-9]\+/VersÃ£o Atual: $NEW_VERSION/" VERSION.md
          sed -i "s/Data de LanÃ§amento:.*/Data de LanÃ§amento: $CURRENT_DATE/" VERSION.md
          sed -i "s/Ãšltima atualizaÃ§Ã£o:.*/Ãšltima atualizaÃ§Ã£o: $CURRENT_DATE/" VERSION.md
          
          echo "Updated VERSION.md to $NEW_VERSION"

      - name: Update README.md version badge
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          sed -i "s/version-[0-9]\+\.[0-9]\+\.[0-9]\+-blue/version-$NEW_VERSION-blue/" README.md
          echo "Updated README.md version badge"

      - name: Update CHANGELOG.md
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          CURRENT_DATE=$(date '+%Y-%m-%d')
          VERSION_TYPE=$(echo "${{ github.event.inputs.version_bump }}" | tr '[:lower:]' '[:upper:]')
          
          # Create new changelog entry
          {
            echo ""
            echo "## [$NEW_VERSION] - $CURRENT_DATE"
            echo ""
            echo "### ðŸ¤– AtualizaÃ§Ã£o AutomÃ¡tica"
            echo ""
            echo "**Tipo:** $VERSION_TYPE"
            echo ""
            echo "${{ github.event.inputs.agent_summary }}"
            echo ""
          } > /tmp/new_entry.md
          
          # Insert after line 8
          head -n 8 CHANGELOG.md > /tmp/changelog_new.md
          cat /tmp/new_entry.md >> /tmp/changelog_new.md
          tail -n +9 CHANGELOG.md >> /tmp/changelog_new.md
          mv /tmp/changelog_new.md CHANGELOG.md
          
          echo "Updated CHANGELOG.md"

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add CHANGELOG.md VERSION.md README.md
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(release): version ${{ steps.new_version.outputs.version }}" -m "${{ github.event.inputs.agent_summary }}"
            git push origin ${{ github.ref_name }}
          fi

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.new_version.outputs.version }}';
            const summary = `${{ github.event.inputs.agent_summary }}`;
            
            try {
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: `v${version}`,
                name: `Release v${version}`,
                body: `## ðŸ¤– Auto-generated Release\n\n${summary}`,
                draft: false,
                prerelease: false
              });
              console.log('Release created successfully');
            } catch (error) {
              console.log('Release may already exist:', error.message);
            }

      - name: Summary
        run: |
          echo "## Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** ${{ steps.new_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Updated:" >> $GITHUB_STEP_SUMMARY
          echo "- CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
          echo "- VERSION.md" >> $GITHUB_STEP_SUMMARY
          echo "- README.md" >> $GITHUB_STEP_SUMMARY
